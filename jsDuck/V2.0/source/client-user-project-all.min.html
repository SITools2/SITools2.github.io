<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">
var BlobBuilder=BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder||(function(view){&quot;use strict&quot;;var
get_class=function(object){return Object.prototype.toString.call(object).match(/^\[object\s(.*)\]$/)[1];},FakeBlobBuilder=function(){this.data=[];},FakeBlob=function(data,type,encoding){this.data=data;this.size=data.length;this.type=type;this.encoding=encoding;},FBB_proto=FakeBlobBuilder.prototype,FB_proto=FakeBlob.prototype,FileReaderSync=view.FileReaderSync,FileException=function(type){this.code=this[this.name=type];},file_ex_codes=(&quot;NOT_FOUND_ERR SECURITY_ERR ABORT_ERR NOT_READABLE_ERR ENCODING_ERR &quot;
+&quot;NO_MODIFICATION_ALLOWED_ERR INVALID_STATE_ERR SYNTAX_ERR&quot;).split(&quot; &quot;),file_ex_code=file_ex_codes.length,realURL=view.URL||view.webkitURL||view,real_create_object_URL=realURL.createObjectURL,real_revoke_object_URL=realURL.revokeObjectURL,URL=realURL,btoa=view.btoa,atob=view.atob,can_apply_typed_arrays=false,can_apply_typed_arrays_test=function(pass){can_apply_typed_arrays=!pass;},ArrayBuffer=view.ArrayBuffer,Uint8Array=view.Uint8Array;FakeBlobBuilder.fake=FB_proto.fake=true;while(file_ex_code--){FileException.prototype[file_ex_codes[file_ex_code]]=file_ex_code+1;}
try{if(Uint8Array){can_apply_typed_arrays_test.apply(0,new Uint8Array(1));}}catch(ex){}
if(!realURL.createObjectURL){URL=view.URL={};}
URL.createObjectURL=function(blob){var
type=blob.type,data_URI_header;if(type===null){type=&quot;application/octet-stream&quot;;}
if(blob instanceof FakeBlob){data_URI_header=&quot;data:&quot;+type;if(blob.encoding===&quot;base64&quot;){return data_URI_header+&quot;;base64,&quot;+blob.data;}else if(blob.encoding===&quot;URI&quot;){return data_URI_header+&quot;,&quot;+decodeURIComponent(blob.data);}if(btoa){return data_URI_header+&quot;;base64,&quot;+btoa(blob.data);}else{return data_URI_header+&quot;,&quot;+encodeURIComponent(blob.data);}}else if(real_create_object_url){return real_create_object_url.call(realURL,blob);}};URL.revokeObjectURL=function(object_url){if(object_url.substring(0,5)!==&quot;data:&quot;&amp;&amp;real_revoke_object_url){real_revoke_object_url.call(realURL,object_url);}};FBB_proto.append=function(data){var bb=this.data;if(Uint8Array&amp;&amp;data instanceof ArrayBuffer){if(can_apply_typed_arrays){bb.push(String.fromCharCode.apply(String,new Uint8Array(data)));}else{var
str=&quot;&quot;,buf=new Uint8Array(data),i=0,buf_len=buf.length;for(;i&lt;buf_len;i++){str+=String.fromCharCode(buf[i]);}}}else if(get_class(data)===&quot;Blob&quot;||get_class(data)===&quot;File&quot;){if(FileReaderSync){var fr=new FileReaderSync;bb.push(fr.readAsBinaryString(data));}else{throw new FileException(&quot;NOT_READABLE_ERR&quot;);}}else if(data instanceof FakeBlob){if(data.encoding===&quot;base64&quot;&amp;&amp;atob){bb.push(atob(data.data));}else if(data.encoding===&quot;URI&quot;){bb.push(decodeURIComponent(data.data));}else if(data.encoding===&quot;raw&quot;){bb.push(data.data);}}else{if(typeof data!==&quot;string&quot;){data+=&quot;&quot;;}
bb.push(unescape(encodeURIComponent(data)));}};FBB_proto.getBlob=function(type){if(!arguments.length){type=null;}
return new FakeBlob(this.data.join(&quot;&quot;),type,&quot;raw&quot;);};FBB_proto.toString=function(){return&quot;[object BlobBuilder]&quot;;};FB_proto.slice=function(start,end,type){var args=arguments.length;if(args&lt;3){type=null;}
return new FakeBlob(this.data.slice(start,args&gt;1?end:this.data.length),type,this.encoding);};FB_proto.toString=function(){return&quot;[object Blob]&quot;;};return FakeBlobBuilder;}(self));var saveAs=saveAs||(function(view){&quot;use strict&quot;;var
doc=view.document,get_URL=function(){return view.URL||view.webkitURL||view;},URL=view.URL||view.webkitURL||view,save_link=doc.createElementNS(&quot;http://www.w3.org/1999/xhtml&quot;,&quot;a&quot;),can_use_save_link=&quot;download&quot;in save_link,click=function(node){var event=doc.createEvent(&quot;MouseEvents&quot;);event.initMouseEvent(&quot;click&quot;,true,false,view,0,0,0,0,0,false,false,false,false,0,null);return node.dispatchEvent(event);},webkit_req_fs=view.webkitRequestFileSystem,req_fs=view.requestFileSystem||webkit_req_fs||view.mozRequestFileSystem,throw_outside=function(ex){(view.setImmediate||view.setTimeout)(function(){throw ex;},0);},force_saveable_type=&quot;application/octet-stream&quot;,fs_min_size=0,deletion_queue=[],process_deletion_queue=function(){var i=deletion_queue.length;while(i--){var file=deletion_queue[i];if(typeof file===&quot;string&quot;){URL.revokeObjectURL(file);}else{file.remove();}}
deletion_queue.length=0;},dispatch=function(filesaver,event_types,event){event_types=[].concat(event_types);var i=event_types.length;while(i--){var listener=filesaver[&quot;on&quot;+event_types[i]];if(typeof listener===&quot;function&quot;){try{listener.call(filesaver,event||filesaver);}catch(ex){throw_outside(ex);}}}},FileSaver=function(blob,name){var
filesaver=this,type=blob.type,blob_changed=false,object_url,target_view,get_object_url=function(){var object_url=get_URL().createObjectURL(blob);deletion_queue.push(object_url);return object_url;},dispatch_all=function(){dispatch(filesaver,&quot;writestart progress write writeend&quot;.split(&quot; &quot;));},fs_error=function(){if(blob_changed||!object_url){object_url=get_object_url(blob);}
target_view.location.href=object_url;filesaver.readyState=filesaver.DONE;dispatch_all();},abortable=function(func){return function(){if(filesaver.readyState!==filesaver.DONE){return func.apply(this,arguments);}};},create_if_not_found={create:true,exclusive:false},slice;filesaver.readyState=filesaver.INIT;if(!name){name=&quot;download&quot;;}
if(can_use_save_link){object_url=get_object_url(blob);save_link.href=object_url;save_link.download=name;if(click(save_link)){filesaver.readyState=filesaver.DONE;dispatch_all();return;}}
if(view.chrome&amp;&amp;type&amp;&amp;type!==force_saveable_type){slice=blob.slice||blob.webkitSlice;blob=slice.call(blob,0,blob.size,force_saveable_type);blob_changed=true;}
if(webkit_req_fs&amp;&amp;name!==&quot;download&quot;){name+=&quot;.download&quot;;}
if(type===force_saveable_type||webkit_req_fs){target_view=view;}else{target_view=view.open();}
if(!req_fs){fs_error();return;}
fs_min_size+=blob.size;req_fs(view.TEMPORARY,fs_min_size,abortable(function(fs){fs.root.getDirectory(&quot;saved&quot;,create_if_not_found,abortable(function(dir){var save=function(){dir.getFile(name,create_if_not_found,abortable(function(file){file.createWriter(abortable(function(writer){writer.onwriteend=function(event){target_view.location.href=file.toURL();deletion_queue.push(file);filesaver.readyState=filesaver.DONE;dispatch(filesaver,&quot;writeend&quot;,event);};writer.onerror=function(){var error=writer.error;if(error.code!==error.ABORT_ERR){fs_error();}};&quot;writestart progress write abort&quot;.split(&quot; &quot;).forEach(function(event){writer[&quot;on&quot;+event]=filesaver[&quot;on&quot;+event];});writer.write(blob);filesaver.abort=function(){writer.abort();filesaver.readyState=filesaver.DONE;};filesaver.readyState=filesaver.WRITING;}),fs_error);}),fs_error);};dir.getFile(name,{create:false},abortable(function(file){file.remove();save();}),abortable(function(ex){if(ex.code===ex.NOT_FOUND_ERR){save();}else{fs_error();}}));}),fs_error);}),fs_error);},FS_proto=FileSaver.prototype,saveAs=function(blob,name){return new FileSaver(blob,name);};FS_proto.abort=function(){var filesaver=this;filesaver.readyState=filesaver.DONE;dispatch(filesaver,&quot;abort&quot;);};FS_proto.readyState=FS_proto.INIT=0;FS_proto.WRITING=1;FS_proto.DONE=2;FS_proto.error=FS_proto.onwritestart=FS_proto.onprogress=FS_proto.onwrite=FS_proto.onabort=FS_proto.onerror=FS_proto.onwriteend=null;view.addEventListener(&quot;unload&quot;,process_deletion_queue,false);return saveAs;}(self));(function(view){&quot;use strict&quot;;var
Uint8Array=view.Uint8Array,HTMLCanvasElement=view.HTMLCanvasElement,is_base64_regex=/\s*;\s*base64\s*(?:;|$)/i,base64_ranks,decode_base64=function(base64){var
len=base64.length,buffer=new Uint8Array(len/4*3|0),i=0,outptr=0,last=[0,0],state=0,save=0,rank,code,undef;while(len--){code=base64.charCodeAt(i++);rank=base64_ranks[code-43];if(rank!==255&amp;&amp;rank!==undef){last[1]=last[0];last[0]=code;save=(save&lt;&lt;6)|rank;state++;if(state===4){buffer[outptr++]=save&gt;&gt;&gt;16;if(last[1]!==61){buffer[outptr++]=save&gt;&gt;&gt;8;}
if(last[0]!==61){buffer[outptr++]=save;}
state=0;}}}
return buffer.buffer;};if(Uint8Array){base64_ranks=new Uint8Array([62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,0,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51]);}
if(HTMLCanvasElement&amp;&amp;!HTMLCanvasElement.prototype.toBlob){HTMLCanvasElement.prototype.toBlob=function(callback,type){if(!type){type=&quot;image/png&quot;;}if(this.mozGetAsFile){callback(this.mozGetAsFile(&quot;canvas&quot;,type));return;}
var
args=Array.prototype.slice.call(arguments,1),dataURI=this.toDataURL.apply(this,args),header_end=dataURI.indexOf(&quot;,&quot;),data=dataURI.substring(header_end+1),is_base64=is_base64_regex.test(dataURI.substring(0,header_end)),BlobBuilder=view.BlobBuilder||view.WebKitBlobBuilder||view.MozBlobBuilder,bb=new BlobBuilder,blob;if(BlobBuilder.fake){blob=bb.getBlob(type);if(is_base64){blob.encoding=&quot;base64&quot;;}else{blob.encoding=&quot;URI&quot;;}
blob.data=data;blob.size=data.length;}else if(Uint8Array){if(is_base64){bb.append(decode_base64(data));}else{bb.append(decodeURIComponent(data));}
blob=bb.getBlob(type);}
callback(blob);};}}(self));Ext.ns('Ext.ux.form.HtmlEditor');if(!Ext.isObject){Ext.isObject=function(v){return v&amp;&amp;typeof v==&quot;object&quot;;};}
Ext.override(Ext.form.HtmlEditor,{getSelectedText:function(clip){var doc=this.getDoc(),selDocFrag;var txt='',hasHTML=false,selNodes=[],ret,html='';if(this.win.getSelection||doc.getSelection){var sel=this.win.getSelection();if(!sel){sel=doc.getSelection();}
if(clip){selDocFrag=sel.getRangeAt(0).extractContents();}else{selDocFrag=this.win.getSelection().getRangeAt(0).cloneContents();}
Ext.each(selDocFrag.childNodes,function(n){if(n.nodeType!==3){hasHTML=true;}});if(hasHTML){var div=document.createElement('div');div.appendChild(selDocFrag);html=div.innerHTML;txt=this.win.getSelection()+'';}else{html=txt=selDocFrag.textContent;}
ret={textContent:txt,hasHTML:hasHTML,html:html};}else if(doc.selection){this.win.focus();txt=doc.selection.createRange();if(txt.text!==txt.htmlText){hasHTML=true;}
ret={textContent:txt.text,hasHTML:hasHTML,html:txt.htmlText};}else{return{textContent:''};}
return ret;}});Ext.ux.form.HtmlEditor.MidasCommand=Ext.extend(Ext.util.Observable,{init:function(cmp){this.cmp=cmp;this.btns=[];this.cmp.on('render',this.onRender,this);this.cmp.on('initialize',this.onInit,this,{delay:100,single:true});},onInit:function(){Ext.EventManager.on(this.cmp.getDoc(),{'mousedown':this.onEditorEvent,'dblclick':this.onEditorEvent,'click':this.onEditorEvent,'keyup':this.onEditorEvent,buffer:100,scope:this});},onRender:function(){var midasCmdButton,tb=this.cmp.getToolbar(),btn,iconCls;Ext.each(this.midasBtns,function(b){if(Ext.isObject(b)){iconCls=(b.iconCls)?b.iconCls:'x-edit-'+b.cmd;if(b.value){iconCls=iconCls+'-'+b.value.replace(/[&lt;&gt;\/]/g,'');}
midasCmdButton={iconCls:iconCls,handler:function(){this.cmp.relayCmd(b.cmd,b.value);},scope:this,tooltip:b.tooltip||{title:b.title},overflowText:b.overflowText||b.title};}else{midasCmdButton=new Ext.Toolbar.Separator();}
btn=tb.addButton(midasCmdButton);if(b.enableOnSelection){btn.disable();}
this.btns.push(btn);},this);},onEditorEvent:function(){var doc=this.cmp.getDoc();Ext.each(this.btns,function(b,i){if(this.midasBtns[i].enableOnSelection||this.midasBtns[i].disableOnSelection){if(doc.getSelection){if((this.midasBtns[i].enableOnSelection&amp;&amp;doc.getSelection()!=='')||(this.midasBtns[i].disableOnSelection&amp;&amp;doc.getSelection()==='')){b.enable();}else{b.disable();}}else if(doc.selection){if((this.midasBtns[i].enableOnSelection&amp;&amp;doc.selection.createRange().text!=='')||(this.midasBtns[i].disableOnSelection&amp;&amp;doc.selection.createRange().text==='')){b.enable();}else{b.disable();}}}
if(this.midasBtns[i].monitorCmdState){b.toggle(doc.queryCommandState(this.midasBtns[i].cmd));}},this);}});Ext.ux.form.HtmlEditor.Divider=Ext.extend(Ext.util.Observable,{init:function(cmp){this.cmp=cmp;this.cmp.on('render',this.onRender,this);},onRender:function(){this.cmp.getToolbar().addButton([new Ext.Toolbar.Separator()]);}});Ext.ux.form.HtmlEditor.HR=Ext.extend(Ext.util.Observable,{langTitle:'Horizontal Rule',langHelp:'Enter the width of the Rule in percentage&lt;br/&gt; followed by the % sign at the end, or to&lt;br/&gt; set a fixed width ommit the % symbol.',langInsert:'Insert',langCancel:'Cancel',langWidth:'Width',defaultHRWidth:'100%',cmd:'hr',init:function(cmp){this.cmp=cmp;this.cmp.on('render',this.onRender,this);},onRender:function(){var cmp=this.cmp;var btn=this.cmp.getToolbar().addButton({iconCls:'x-edit-hr',handler:function(){if(!this.hrWindow){this.hrWindow=new Ext.Window({title:this.langTitle,width:240,closeAction:'hide',items:[{itemId:'insert-hr',xtype:'form',border:false,plain:true,bodyStyle:'padding: 10px;',labelWidth:60,labelAlign:'right',items:[{xtype:'label',html:this.langHelp+'&lt;br/&gt;&amp;nbsp;'},{xtype:'textfield',maskRe:/[0-9]|%/,regex:/^[1-9][0-9%]{1,3}/,fieldLabel:this.langWidth,name:'hrwidth',width:60,value:this.defaultHRWidth,listeners:{specialkey:function(f,e){if((e.getKey()==e.ENTER||e.getKey()==e.RETURN)&amp;&amp;f.isValid()){this.doInsertHR();}},scope:this}}]}],buttons:[{text:this.langInsert,handler:function(){var frm=this.hrWindow.getComponent('insert-hr').getForm();if(frm.isValid()){this.doInsertHR();}else{frm.findField('hrwidth').getEl().frame();}},scope:this},{text:this.langCancel,handler:function(){this.hrWindow.hide();},scope:this}],listeners:{render:(Ext.isGecko)?this.focusHRLong:this.focusHR,show:this.focusHR,move:this.focusHR,scope:this}});}else{this.hrWindow.getEl().frame();}
this.hrWindow.show();},scope:this,tooltip:{title:this.langInsert+' '+this.langTitle},overflowText:this.langTitle});},focusHRLong:function(w){this.focus(w,600);},focusHR:function(w){this.focus(w,100);},focus:function(win,delay){win.getComponent('insert-hr').getForm().findField('hrwidth').focus(true,delay);},doInsertHR:function(){var frm=this.hrWindow.getComponent('insert-hr').getForm();if(frm.isValid()){var hrwidth=frm.findField('hrwidth').getValue();if(hrwidth){this.insertHR(hrwidth);}else{this.insertHR(this.defaultHRWidth);}
frm.reset();this.hrWindow.hide();}},insertHR:function(w){this.cmp.insertAtCursor('&lt;hr width=&quot;'+w+'&quot;&gt;');}});Ext.ux.form.HtmlEditor.Image=Ext.extend(Ext.util.Observable,{langTitle:'Insert Image',urlSizeVars:['width','height'],basePath:'image.php',init:function(cmp){this.cmp=cmp;this.cmp.on('render',this.onRender,this);this.cmp.on('initialize',this.onInit,this,{single:true});},onEditorMouseUp:function(e){Ext.get(e.getTarget()).select('img').each(function(el){var w=el.getAttribute('width'),h=el.getAttribute('height'),src=el.getAttribute('src')+' ';src=src.replace(new RegExp(this.urlSizeVars[0]+'=[0-9]{1,5}([&amp;| ])'),this.urlSizeVars[0]+'='+w+'$1');src=src.replace(new RegExp(this.urlSizeVars[1]+'=[0-9]{1,5}([&amp;| ])'),this.urlSizeVars[1]+'='+h+'$1');el.set({src:src.replace(/\s+$/,&quot;&quot;)});},this);},onInit:function(){Ext.EventManager.on(this.cmp.getDoc(),{'abort':this.onEditorMouseUp,scope:this});},onRender:function(){var btn=this.cmp.getToolbar().addButton({iconCls:'x-edit-image',scope:this,handler:this.selectImage,tooltip:{title:this.langTitle},overflowText:this.langTitle});},selectImage:function(){function validate(data,config){config.fieldUrl.setValue(data.url);}
var chooser=new ImageExplorer({directoryImageUrl:this.cmp.directoryImageUrl,width:500,height:350,htmlEditor:this.cmp});chooser.show(document);},insertImage:function(img){this.cmp.insertAtCursor('&lt;img src=&quot;'+this.basePath+'?'+this.urlSizeVars[0]+'='+img.Width+'&amp;'+this.urlSizeVars[1]+'='+img.Height+'&amp;id='+img.ID+'&quot; title=&quot;'+img.Name+'&quot; alt=&quot;'+img.Name+'&quot;&gt;');}});Image.insertImage=function(data,config){var htmlEditor=config.htmlEditor;var url=data.url;var indexDatastorageUrl=url.indexOf(config.directoryImageUrl);if(indexDatastorageUrl!==-1){url=&quot;./images&quot;+url.substr(indexDatastorageUrl+config.directoryImageUrl.length,url.length);}
if(data.width&amp;&amp;data.height){htmlEditor.insertAtCursor('&lt;img src=&quot;'+url+'&quot; title=&quot;'+data.text+'&quot; width=&quot;'+data.width+'&quot; height=&quot;'+data.height+'&quot; alt=&quot;'+data.text+'&quot;&gt;');}
else{htmlEditor.insertAtCursor('&lt;img src=&quot;'+url+'&quot; title=&quot;'+data.text+'&quot; alt=&quot;'+data.text+'&quot;&gt;');}};Ext.ux.form.HtmlEditor.RemoveFormat=Ext.extend(Ext.ux.form.HtmlEditor.MidasCommand,{midasBtns:['|',{enableOnSelection:true,cmd:'removeFormat',tooltip:{title:'Remove Formatting'},overflowText:'Remove Formatting'}]});Ext.ux.form.HtmlEditor.IndentOutdent=Ext.extend(Ext.ux.form.HtmlEditor.MidasCommand,{midasBtns:['|',{cmd:'indent',tooltip:{title:'Indent Text'},overflowText:'Indent Text'},{cmd:'outdent',tooltip:{title:'Outdent Text'},overflowText:'Outdent Text'}]});Ext.ux.form.HtmlEditor.SubSuperScript=Ext.extend(Ext.ux.form.HtmlEditor.MidasCommand,{midasBtns:['|',{enableOnSelection:true,cmd:'subscript',tooltip:{title:'Subscript'},overflowText:'Subscript'},{enableOnSelection:true,cmd:'superscript',tooltip:{title:'Superscript'},overflowText:'Superscript'}]});Ext.ux.form.HtmlEditor.RemoveFormat=Ext.extend(Ext.ux.form.HtmlEditor.MidasCommand,{midasBtns:['|',{enableOnSelection:true,cmd:'removeFormat',tooltip:{title:'Remove Formatting'},overflowText:'Remove Formatting'}]});Ext.ux.form.HtmlEditor.FindAndReplace=Ext.extend(Ext.util.Observable,{langTitle:'Find/Replace',langFind:'Find',langReplace:'Replace',langReplaceWith:'Replace with',langClose:'Close',cmd:'findandreplace',init:function(cmp){this.cmp=cmp;this.cmp.on({'render':this.onRender,'editmodechange':this.editModeChange,scope:this});this.lastSelectionStart=-1;},editModeChange:function(t,m){if(this.btn&amp;&amp;m){this.btn.setDisabled(false);}},onRender:function(){this.btn=this.cmp.getToolbar().addButton({iconCls:'x-edit-findandreplace',sourceEditEnabled:true,handler:function(){if(!this.farWindow){this.farWindow=new Ext.Window({title:this.langTitle,closeAction:'hide',width:270,items:[{itemId:'findandreplace',xtype:'form',border:false,plain:true,bodyStyle:'padding: 10px;',labelWidth:80,labelAlign:'right',items:[{xtype:'textfield',allowBlank:false,fieldLabel:this.langFind,name:'find',width:145},{xtype:'textfield',allowBlank:true,fieldLabel:this.langReplaceWith,name:'replace',width:145}]}],buttons:[{text:this.langFind,handler:this.doFind,scope:this},{text:this.langReplace,handler:this.doReplace,scope:this},{text:this.langClose,handler:function(){this.farWindow.hide();},scope:this}]});}else{this.farWindow.getEl().frame();}
this.farWindow.show();},scope:this,tooltip:{title:this.langTitle},overflowText:this.langTitle});},doFind:function(){var frm=this.farWindow.getComponent('findandreplace').getForm();if(!frm.isValid()){return'';}
var findValue=frm.findField('find').getValue();var replaceValue=frm.findField('replace').getValue();if(this.cmp.sourceEditMode){var textarea=this.cmp.el.dom;var startPos=textarea.selectionStart===this.lastSelectionStart?textarea.selectionStart+1:textarea.selectionStart;var txt=textarea.value.substring(startPos);var regexp=new RegExp(findValue);var r=txt.search(regexp);if(r==-1){return;}
this.lastSelectionStart=startPos+r;if(Ext.isGecko){textarea.setSelectionRange(this.lastSelectionStart,this.lastSelectionStart+findValue.length);this.cmp.scrollIntoView(startPos);this.cmp.focus(false,true);}
return;}},doReplace:function(){var frm=this.farWindow.getComponent('findandreplace').getForm();if(!frm.isValid()){return'';}
var findValue=frm.findField('find').getValue();var replaceValue=frm.findField('replace').getValue();if(this.cmp.sourceEditMode){var textarea=this.cmp.el.dom;var startPos=textarea.selectionStart;var endPos=textarea.selectionEnd;if(startPos==0&amp;&amp;endPos==0){Ext.Msg.alert(&quot;Warning&quot;,&quot;No text selection, please select some text&quot;);return;}
var txt=textarea.value;var scrollPosition=textarea.scrollTop;textarea.value=txt.substring(0,startPos)+replaceValue+txt.substring(endPos);textarea.setSelectionRange(startPos,startPos+replaceValue.length);textarea.scrollTop=scrollPosition;this.cmp.focus(false,true);return;}
else{Ext.Msg.alert(&quot;Warning&quot;,&quot;Not in Source Edit mode&quot;);}
return;}});Ext.ux.form.HtmlEditor.Table=Ext.extend(Ext.util.Observable,{langTitle:'Insert Table',langInsert:'Insert',langCancel:'Cancel',langRows:'Rows',langColumns:'Columns',langBorder:'Border',langCellLabel:'Label Cells',cmd:'table',showCellLocationText:true,cellLocationText:'{0}&amp;nbsp;-&amp;nbsp;{1}',tableBorderOptions:[['none','None'],['1px solid #000','Sold Thin'],['2px solid #000','Solid Thick'],['1px dashed #000','Dashed'],['1px dotted #000','Dotted']],init:function(cmp){this.cmp=cmp;this.cmp.on('render',this.onRender,this);},onRender:function(){var btn=this.cmp.getToolbar().addButton({iconCls:'x-edit-table',handler:function(){if(!this.tableWindow){this.tableWindow=new Ext.Window({title:this.langTitle,closeAction:'hide',width:235,items:[{itemId:'insert-table',xtype:'form',border:false,plain:true,bodyStyle:'padding: 10px;',labelWidth:65,labelAlign:'right',items:[{xtype:'numberfield',allowBlank:false,allowDecimals:false,fieldLabel:this.langRows,name:'row',width:60},{xtype:'numberfield',allowBlank:false,allowDecimals:false,fieldLabel:this.langColumns,name:'col',width:60},{xtype:'combo',fieldLabel:this.langBorder,name:'border',forceSelection:true,mode:'local',store:new Ext.data.ArrayStore({autoDestroy:true,fields:['spec','val'],data:this.tableBorderOptions}),triggerAction:'all',value:'none',displayField:'val',valueField:'spec',anchor:'-15'},{xtype:'checkbox',fieldLabel:this.langCellLabel,checked:this.showCellLocationText,listeners:{check:function(){this.showCellLocationText=!this.showCellLocationText;},scope:this}}]}],buttons:[{text:this.langInsert,handler:function(){var frm=this.tableWindow.getComponent('insert-table').getForm();if(frm.isValid()){var border=frm.findField('border').getValue();var rowcol=[frm.findField('row').getValue(),frm.findField('col').getValue()];if(rowcol.length==2&amp;&amp;rowcol[0]&gt;0&amp;&amp;rowcol[1]&gt;0){var colwidth=Math.floor(100/rowcol[0]);var html=&quot;&lt;table style='border-collapse: collapse'&gt;&quot;;var cellText='&amp;nbsp;';if(this.showCellLocationText){cellText=this.cellLocationText;}
for(var row=0;row&lt;rowcol[0];row++){html+=&quot;&lt;tr&gt;&quot;;for(var col=0;col&lt;rowcol[1];col++){html+=&quot;&lt;td width='&quot;+colwidth+&quot;%' style='border: &quot;+border+&quot;;'&gt;&quot;+String.format(cellText,(row+1),String.fromCharCode(col+65))+&quot;&lt;/td&gt;&quot;;}
html+=&quot;&lt;/tr&gt;&quot;;}
html+=&quot;&lt;/table&gt;&quot;;this.cmp.insertAtCursor(html);}
this.tableWindow.hide();}else{if(!frm.findField('row').isValid()){frm.findField('row').getEl().frame();}else if(!frm.findField('col').isValid()){frm.findField('col').getEl().frame();}}},scope:this},{text:this.langCancel,handler:function(){this.tableWindow.hide();},scope:this}]});}else{this.tableWindow.getEl().frame();}
this.tableWindow.show();},scope:this,tooltip:{title:this.langTitle},overflowText:this.langTitle});}});Ext.ux.form.HtmlEditor.Word=Ext.extend(Ext.util.Observable,{langTitle:'Word Paste',langToolTip:'Cleanse text pasted from Word or other Rich Text applications',wordPasteEnabled:true,curLength:0,lastLength:0,lastValue:'',init:function(cmp){this.cmp=cmp;this.cmp.on('render',this.onRender,this);this.cmp.on('initialize',this.onInit,this,{delay:100,single:true});},onInit:function(){Ext.EventManager.on(this.cmp.getDoc(),{'keyup':this.checkIfPaste,scope:this});this.lastValue=this.cmp.getValue();this.curLength=this.lastValue.length;this.lastLength=this.lastValue.length;},checkIfPaste:function(e){var diffAt=0;this.curLength=this.cmp.getValue().length;if(e.V==e.getKey()&amp;&amp;e.ctrlKey&amp;&amp;this.wordPasteEnabled){this.cmp.suspendEvents();diffAt=this.findValueDiffAt(this.cmp.getValue());var parts=[this.cmp.getValue().substr(0,diffAt),this.fixWordPaste(this.cmp.getValue().substr(diffAt,(this.curLength-this.lastLength))),this.cmp.getValue().substr((this.curLength-this.lastLength)+diffAt,this.curLength)];this.cmp.setValue(parts.join(''));this.cmp.resumeEvents();}
this.lastLength=this.cmp.getValue().length;this.lastValue=this.cmp.getValue();},findValueDiffAt:function(val){for(i=0;i&lt;this.curLength;i++){if(this.lastValue[i]!=val[i]){return i;}}},fixWordPaste:function(wordPaste){var removals=[/&amp;nbsp;/ig,/[\r\n]/g,/&lt;(xml|style)[^&gt;]*&gt;.*?&lt;\/\1&gt;/ig,/&lt;\/?(meta|object|span)[^&gt;]*&gt;/ig,/&lt;\/?[A-Z0-9]*:[A-Z]*[^&gt;]*&gt;/ig,/(lang|class|type|href|name|title|id|clear)=\&quot;[^\&quot;]*\&quot;/ig,/style=(\'\'|\&quot;\&quot;)/ig,/&lt;![\[-].*?-*&gt;/g,/MsoNormal/g,/&lt;\\?\?xml[^&gt;]*&gt;/g,/&lt;\/?o:p[^&gt;]*&gt;/g,/&lt;\/?v:[^&gt;]*&gt;/g,/&lt;\/?o:[^&gt;]*&gt;/g,/&lt;\/?st1:[^&gt;]*&gt;/g,/&amp;nbsp;/g,/&lt;\/?SPAN[^&gt;]*&gt;/g,/&lt;\/?FONT[^&gt;]*&gt;/g,/&lt;\/?STRONG[^&gt;]*&gt;/g,/&lt;\/?H1[^&gt;]*&gt;/g,/&lt;\/?H2[^&gt;]*&gt;/g,/&lt;\/?H3[^&gt;]*&gt;/g,/&lt;\/?H4[^&gt;]*&gt;/g,/&lt;\/?H5[^&gt;]*&gt;/g,/&lt;\/?H6[^&gt;]*&gt;/g,/&lt;\/?P[^&gt;]*&gt;&lt;\/P&gt;/g,/&lt;!--(.*)--&gt;/g,/&lt;!--(.*)&gt;/g,/&lt;!(.*)--&gt;/g,/&lt;\\?\?xml[^&gt;]*&gt;/g,/&lt;\/?o:p[^&gt;]*&gt;/g,/&lt;\/?v:[^&gt;]*&gt;/g,/&lt;\/?o:[^&gt;]*&gt;/g,/&lt;\/?st1:[^&gt;]*&gt;/g,/style=\&quot;[^\&quot;]*\&quot;/g,/style=\'[^\&quot;]*\'/g,/lang=\&quot;[^\&quot;]*\&quot;/g,/lang=\'[^\&quot;]*\'/g,/class=\&quot;[^\&quot;]*\&quot;/g,/class=\'[^\&quot;]*\'/g,/type=\&quot;[^\&quot;]*\&quot;/g,/type=\'[^\&quot;]*\'/g,/href=\'#[^\&quot;]*\'/g,/href=\&quot;#[^\&quot;]*\&quot;/g,/name=\&quot;[^\&quot;]*\&quot;/g,/name=\'[^\&quot;]*\'/g,/ clear=\&quot;all\&quot;/g,/id=\&quot;[^\&quot;]*\&quot;/g,/title=\&quot;[^\&quot;]*\&quot;/g,/&lt;span[^&gt;]*&gt;/g,/&lt;\/?span[^&gt;]*&gt;/g,/&lt;title&gt;(.*)&lt;\/title&gt;/g,/class=/g,/&lt;meta[^&gt;]*&gt;/g,/&lt;link[^&gt;]*&gt;/g,/&lt;style&gt;(.*)&lt;\/style&gt;/g,/&lt;w:[^&gt;]*&gt;(.*)&lt;\/w:[^&gt;]*&gt;/g];Ext.each(removals,function(s){wordPaste=wordPaste.replace(s,&quot;&quot;);});wordPaste=wordPaste.replace(/&lt;div[^&gt;]*&gt;/g,&quot;&lt;p&gt;&quot;);wordPaste=wordPaste.replace(/&lt;\/?div[^&gt;]*&gt;/g,&quot;&lt;/p&gt;&quot;);return wordPaste;},onRender:function(){this.cmp.getToolbar().add({iconCls:'x-edit-wordpaste',pressed:true,handler:function(t){t.toggle(!t.pressed);this.wordPasteEnabled=!this.wordPasteEnabled;},scope:this,tooltip:{text:this.langToolTip},overflowText:this.langTitle});}});Ext.ux.form.HtmlEditor.Link=Ext.extend(Ext.util.Observable,{langTitle:'Insert Link',langInsert:'Insert',langCancel:'Cancel',langTarget:'Target',langURL:'URL',langText:'Text',linkTargetOptions:[['_self','Default'],['_blank','New Window'],['_parent','Parent Window'],['_top','Entire Window']],init:function(cmp){cmp.enableLinks=false;this.cmp=cmp;this.cmp.on('render',this.onRender,this);},onRender:function(){var cmp=this.cmp;var btn=this.cmp.getToolbar().addButton({iconCls:'x-edit-createlink',handler:function(){var sel=this.cmp.getSelectedText();if(!this.linkWindow){this.linkWindow=new Ext.Window({title:this.langTitle,closeAction:'hide',width:250,height:160,items:[{xtype:'form',itemId:'insert-link',border:false,plain:true,bodyStyle:'padding: 10px;',labelWidth:40,labelAlign:'right',items:[{xtype:'textfield',fieldLabel:this.langText,name:'text',anchor:'100%',value:''},{xtype:'textfield',fieldLabel:this.langURL,vtype:'url',name:'url',anchor:'100%',value:'http://'},{xtype:'combo',fieldLabel:this.langTarget,name:'target',forceSelection:true,mode:'local',store:new Ext.data.ArrayStore({autoDestroy:true,fields:['spec','val'],data:this.linkTargetOptions}),triggerAction:'all',value:'_self',displayField:'val',valueField:'spec',anchor:'100%'}]}],buttons:[{text:this.langInsert,handler:function(){var frm=this.linkWindow.getComponent('insert-link').getForm();if(frm.isValid()){var afterSpace='',sel=this.cmp.getSelectedText(true),text=frm.findField('text').getValue(),url=frm.findField('url').getValue(),target=frm.findField('target').getValue();if(text.length&amp;&amp;text[text.length-1]==' '){text=text.substr(0,text.length-1);afterSpace=' ';}
if(sel.hasHTML){text=sel.html;}
var html='&lt;a href=&quot;'+url+'&quot; target=&quot;'+target+'&quot;&gt;'+text+'&lt;/a&gt;'+afterSpace;this.cmp.insertAtCursor(html);this.linkWindow.hide();}else{if(!frm.findField('url').isValid()){frm.findField('url').getEl().frame();}else if(!frm.findField('target').isValid()){frm.findField('target').getEl().frame();}}},scope:this},{text:this.langCancel,handler:function(){this.linkWindow.close();},scope:this}],listeners:{show:{fn:function(){var frm=this.linkWindow.getComponent('insert-link').getForm();frm.findField('text').setValue(sel.textContent).setDisabled(sel.hasHTML);frm.findField('url').reset().focus(true,50);},scope:this,defer:350}}});this.linkWindow.show();}else{this.linkWindow.show();this.linkWindow.getEl().frame();}},scope:this,tooltip:this.langTitle});}});Ext.ux.form.HtmlEditor.SpecialCharacters=Ext.extend(Ext.util.Observable,{langTitle:'Insert Special Character',langInsert:'Insert',langCancel:'Cancel',specialChars:[153],charRange:[160,256],chars:[],init:function(cmp){this.cmp=cmp;this.cmp.on('render',this.onRender,this);},onRender:function(){var cmp=this.cmp;var btn=this.cmp.getToolbar().addButton({iconCls:'x-edit-char',handler:function(){if(!this.chars.length){if(this.specialChars.length){Ext.each(this.specialChars,function(c,i){this.chars[i]=['&amp;#'+c+';'];},this);}
for(i=this.charRange[0];i&lt;this.charRange[1];i++){this.chars.push(['&amp;#'+i+';']);}}
var charStore=new Ext.data.ArrayStore({fields:['char'],data:this.chars});this.charWindow=new Ext.Window({title:this.langTitle,width:436,autoHeight:true,layout:'fit',items:[{xtype:'dataview',store:charStore,ref:'charView',autoHeight:true,multiSelect:true,tpl:new Ext.XTemplate('&lt;tpl for=&quot;.&quot;&gt;&lt;div class=&quot;char-item&quot;&gt;{char}&lt;/div&gt;&lt;/tpl&gt;&lt;div class=&quot;x-clear&quot;&gt;&lt;/div&gt;'),overClass:'char-over',itemSelector:'div.char-item',listeners:{dblclick:function(t,i,n,e){this.insertChar(t.getStore().getAt(i).get('char'));this.charWindow.close();},scope:this}}],buttons:[{text:this.langInsert,handler:function(){Ext.each(this.charWindow.charView.getSelectedRecords(),function(rec){var c=rec.get('char');this.insertChar(c);},this);this.charWindow.close();},scope:this},{text:this.langCancel,handler:function(){this.charWindow.close();},scope:this}]});this.charWindow.show();},scope:this,tooltip:{title:this.langTitle},overflowText:this.langTitle});},insertChar:function(c){if(c){this.cmp.insertAtCursor(c);}}});Ext.ux.form.HtmlEditor.UndoRedo=Ext.extend(Ext.ux.form.HtmlEditor.MidasCommand,{midasBtns:['|',{cmd:'undo',tooltip:{title:'Undo'},overflowText:'Undo'},{cmd:'redo',tooltip:{title:'Redo'},overflowText:'Redo'}]});Ext.ux.form.HtmlEditor.HeadingButtons=Ext.extend(Ext.ux.form.HtmlEditor.MidasCommand,{midasBtns:['|',{enableOnSelection:true,cmd:'formatblock',value:'&lt;h1&gt;',tooltip:{title:'1st Heading'},overflowText:'1st Heading'},{enableOnSelection:true,cmd:'formatblock',value:'&lt;h2&gt;',tooltip:{title:'2nd Heading'},overflowText:'2nd Heading'}]});Ext.ux.form.HtmlEditor.HeadingMenu=Ext.extend(Ext.util.Observable,{init:function(cmp){this.cmp=cmp;this.cmp.on('render',this.onRender,this);},onRender:function(){var cmp=this.cmp;var btn=this.cmp.getToolbar().addItem({xtype:'combo',displayField:'display',valueField:'value',name:'headingsize',forceSelection:true,mode:'local',triggerAction:'all',width:65,emptyText:'Heading',store:{xtype:'arraystore',autoDestroy:true,fields:['value','display'],data:[['H1','1st Heading'],['H2','2nd Heading'],['H3','3rd Heading'],['H4','4th Heading'],['H5','5th Heading'],['H6','6th Heading']]},listeners:{'select':function(combo,rec){this.relayCmd('formatblock','&lt;'+rec.get('value')+'&gt;');combo.reset();},scope:cmp}});}});Ext.ux.form.HtmlEditor.plugins=function(){return[new sitools.widget.HtmlEditor.datasetLink(),new Ext.ux.form.HtmlEditor.UndoRedo(),new Ext.ux.form.HtmlEditor.Divider(),new Ext.ux.form.HtmlEditor.Image(),new Ext.ux.form.HtmlEditor.HR(),new Ext.ux.form.HtmlEditor.SpecialCharacters(),new Ext.ux.form.HtmlEditor.HeadingMenu(),new Ext.ux.form.HtmlEditor.IndentOutdent(),new Ext.ux.form.HtmlEditor.SubSuperScript(),new Ext.ux.form.HtmlEditor.RemoveFormat()];};var ImageExplorer=function(config){this.config=config;}
ImageExplorer.prototype={lookup:{},show:function(el,callback){if(!this.win){this.initTemplates();this.store=new Ext.data.JsonStore({proxy:new Ext.data.HttpProxy({method:'GET',url:this.config.directoryImageUrl,headers:{'Accept':'application/json+sitools-directory'}}),idProperty:'text',fields:[{name:'text',mapping:'text'},{name:'lastmod',mapping:'lastmod',type:'date',dateFormat:'timestamp'},{name:'leaf',mapping:'leaf'},{name:'url',mapping:'url'},{name:'size',mapping:'size',type:'float'},{name:'cls',mapping:'cls'}],listeners:{'load':{fn:function(){this.view.select(0);},scope:this,single:true}}});this.store.load();var formatSize=function(data){if(data.size&lt;1024){return data.size+&quot; bytes&quot;;}else{return(Math.round(((data.size*10)/1024))/10)+&quot; KB&quot;;}};var formatData=function(data){data.shortName=data.text.ellipse(15);data.sizeString=formatSize(data);data.dateString=new Date(data.lastmod).format(&quot;d/m/Y g:i a&quot;);this.lookup[data.text]=data;return data;};this.view=new Ext.DataView({tpl:this.thumbTemplate,id:'imageChooserDataViewId',singleSelect:true,overClass:'x-view-over',itemSelector:'div.thumb-wrap',emptyText:'&lt;div style=&quot;padding:10px;&quot;&gt;No images match the specified filter&lt;/div&gt;',store:this.store,listeners:{'dblclick':{fn:function(dv,ind,node,e){this.doCallback(dv,ind,node,e);},scope:this},'loadexception':{fn:this.onLoadException,scope:this},'beforeselect':{fn:function(view){return view.store.getRange().length&gt;0;}}},prepareData:formatData.createDelegate(this)});this.menu=new Ext.menu.Menu({id:'paramMenu',items:[{text:'Initial Size',id:'initialId',checked:true,checkHandler:function(){if(this.checked){this.parentMenu.find('id','customId')[0].setChecked(false);}}},'-',{text:'Customisable Size',id:'customId',checked:false,menu:{items:[{xtype:'spinnerfield',emptyText:'Custom width...',name:'width',listeners:{scope:this,mousedown:function(field,e){var ed=ed;}}},{xtype:'spinnerfield',emptyText:'Custom height...',name:'height',listeners:{scope:this,mousedown:function(field,e){var ed=ed;}}}]},checkHandler:function(){if(this.checked){this.parentMenu.find('id','initialId')[0].setChecked(false);}}}]});this.splitButton=new Ext.Toolbar.SplitButton({id:'ok-btn',text:'OK',scope:this,handler:function(){var node=this.view.getSelectedNodes()[0];var rec=this.view.getStore().getById(node.id);if(this.menu.find('id','initialId')[0].checked){this.doCallback2(this.view,rec);}
else{var subMenu=this.menu.find('id','customId')[0];var width=subMenu.menu.find('name','width')[0].getValue();var height=subMenu.menu.find('name','height')[0].getValue();this.doCallback2(this.view,rec,width,height);}},menu:this.menu});var cfg={title:i18n.get('label.chooseImage'),id:'img-chooser-dlg',layout:'border',minWidth:500,minHeight:450,modal:true,border:false,tbar:['-&gt;',{xtype:'label',text:i18n.get('label.uploadFile')+' :'},{xtype:'button',iconAlign:'right',iconCls:'upload-icon',tooltip:i18n.get('label.uploadFile'),scope:this,handler:function(){var callbackUpload=function(createdNode){var rec=new Ext.data.Record(createdNode);this.add(rec);this.reload();}
var uploadWin=new sitools.user.modules.datastorageUploadFile({urlUpload:this.config.directoryImageUrl+&quot;/&quot;,callback:callbackUpload,scope:this.store}).show();}}],items:[{id:'img-chooser-view',region:'center',autoScroll:true,items:this.view,tbar:[{text:i18n.get('label.filter')},{xtype:'textfield',id:'filter',selectOnFocus:true,width:100,listeners:{'render':{fn:function(){Ext.getCmp('filter').getEl().on('keyup',function(){this.filter();},this,{buffer:500});},scope:this}}},' ','-',{text:i18n.get('label.sortBy')},{id:'sortSelect',xtype:'combo',typeAhead:true,triggerAction:'all',width:100,editable:false,mode:'local',displayField:'desc',valueField:'text',lazyInit:false,value:'text',store:new Ext.data.ArrayStore({fields:['text','desc'],data:[['text','Name'],['size','File Size'],['lastmod','Last Modified']]}),listeners:{'select':{fn:this.sortImages,scope:this}}}]}],buttons:[this.splitButton,{text:'Cancel',handler:function(){this.win.close();},scope:this}],keys:{key:27,handler:function(){this.win.close();},scope:this}};Ext.apply(cfg,this.config);this.win=new Ext.Window(cfg);}
this.reset();this.win.show(el);this.callback=callback;this.animateTarget=el;},initTemplates:function(){this.thumbTemplate=new Ext.XTemplate('&lt;tpl for=&quot;.&quot;&gt;','&lt;tpl if=&quot;this.isImage(url)&quot;&gt;','&lt;div class=&quot;thumb-wrap&quot; id=&quot;{name}&quot;&gt;','&lt;div class=&quot;thumb&quot;&gt;&lt;img src=&quot;{url}&quot; height=&quot;96&quot; width=&quot;96&quot; title=&quot;{name}&quot;&gt;&lt;/div&gt;','&lt;span&gt;{shortName}&lt;/span&gt;&lt;/div&gt;','&lt;/tpl&gt;','&lt;/tpl&gt;',{compiled:true,isLeaf:function(leaf){return leaf;},isImage:function(text){var imageRegex=/\.(png|jpg|jpeg|gif|bmp)$/;if(text.match(imageRegex))
return true;else{return false;}}});this.thumbTemplate.compile();},filter:function(){var filter=Ext.getCmp('filter');this.view.store.filter('text',filter.getValue());this.view.select(0);},sortImages:function(){var v=Ext.getCmp('sortSelect').getValue();this.view.store.sort(v,v=='text'?'asc':'desc');this.view.select(0);},reset:function(){if(this.win.rendered){Ext.getCmp('filter').reset();this.view.getEl().dom.scrollTop=0;}
this.view.store.clearFilter();this.view.select(0);},doCallback:function(dv,ind,node,e){var rec=dv.getStore().getById(node.id);Image.insertImage(rec.data,this.config);this.win.close();},doCallback2:function(dv,rec,width,height){if(width&amp;&amp;height){rec.data.width=width;rec.data.height=height;}
Image.insertImage(rec.data,this.config);this.win.close();},onLoadException:function(v,o){this.view.getEl().update('&lt;div style=&quot;padding:10px;&quot;&gt;Error loading images.&lt;/div&gt;');},isImage:function(text){var imageRegex=/\.(png|jpg|jpeg|gif|bmp)$/;if(text.match(imageRegex))
return true;else{var ind=this.store.find('text',text);this.store.remove(this.store.getAt(ind));return false;}}};String.prototype.ellipse=function(maxLength){if(this.length&gt;maxLength){return this.substr(0,maxLength-3)+'...';}
return this;};Ext.namespace('sitools.widget.HtmlEditor');sitools.widget.HtmlEditor.datasetLink=Ext.extend(Ext.util.Observable,{init:function(cmp){this.cmp=cmp;this.cmp.on('render',this.onRender,this);this.browseField=new Ext.form.TriggerField({name:'datasetLink',fieldLabel:i18n.get('label.selectDatasetLink'),allowBlank:false,labelWidth:100,editable:false,emptyText:i18n.get('label.openDatasetBrowser'),anchor:'100%',forceSelection:true,onTriggerClick:function(){if(!this.disabled){var browser=new sitools.widget.HtmlEditor.datasetBrowser({field:this});new Ext.Window({title:i18n.get('label.selectDatasetLink'),iconCls:'x-edit-datasetLink',layout:'fit',height:300,width:300,autoScroll:true,items:[browser]}).show();}}});var sel;this.datasetLinkWindow=new Ext.Window({title:i18n.get('label.insertDatasetLink'),closeAction:'hide',resizable:false,width:400,height:175,items:[{xtype:'form',itemId:'insert-datasetLink',border:false,plain:true,bodyStyle:'padding: 10px;',labelWidth:100,labelAlign:'right',bbar:new Ext.ux.StatusBar({text:i18n.get('label.ready'),id:'sbWinEditProfile',iconCls:'x-status-valid',hidden:true}),items:[{xtype:'textfield',allowBlank:false,fieldLabel:i18n.get('label.text'),name:'text',anchor:'100%',value:''},this.browseField]}],buttons:[{text:i18n.get('label.insertDatasetLink'),handler:function(){var frm=this.datasetLinkWindow.getComponent('insert-datasetLink').getForm();if(frm.isValid()){text=frm.findField('text').getValue();browseField=frm.findField('datasetLink');var html=String.format(browseField.dataLinkComponent+&quot;{0}&lt;/a&gt;&quot;,text);this.cmp.insertAtCursor(html);this.datasetLinkWindow.close();}else{var sb=Ext.getCmp('sbWinEditProfile');sb.setStatus({text:i18n.get('warning.checkForm'),iconCls:'x-status-error',hidden:false});sb.setVisible(true);return;}},scope:this},{text:i18n.get('label.cancel'),handler:function(){this.datasetLinkWindow.close();},scope:this}]});},onRender:function(){this.btnToolbar=this.cmp.getToolbar().addButton({iconCls:'x-edit-datasetLink',scope:this,handler:this.showDatasetLinkWindow,tooltip:i18n.get('label.insertDatasetLink')});},showDatasetLinkWindow:function(){if(!this.datasetLinkWindow.isDestroyed){this.datasetLinkWindow.show();}
else{this.datasetLinkWindow.destroy();this.init(this.cmp);this.datasetLinkWindow.show();}}});Ext.reg('sitools.widget.HtmlEditor.datasetLink',sitools.widget.HtmlEditor.datasetLink);Ext.namespace('sitools.widget.HtmlEditor');sitools.widget.HtmlEditor.datasetBrowser=function(config){this.datasets=[];this.browseField=config.field;var projectAttachment=projectGlobal.sitoolsAttachementForUsers;var treeUtils=commonTreeUtils;var conn=Ext.Ajax;conn.request({url:projectAttachment+'/datasets?media=json',method:'GET',scriptTag:true,scope:this,success:function(response){if(!showResponse(response,false)){return;}
var config=Ext.decode(response.responseText);var i=0;Ext.each(config.data,function(dataset){if(dataset.authorized!==&quot;false&quot;){this.datasets.push({text:dataset.name,listeners:{scope:this,beforeexpand:function(node){node.removeAll(true);if(dataset.status!=&quot;ACTIVE&quot;){var notify=new Ext.ux.Notification({iconCls:'x-icon-information',title:i18n.get('label.information'),html:i18n.get('warning.wrongStatus'),autoDestroy:true,hideDelay:1000});notify.show(document);return true;}
conn.request({url:dataset.url+'?media=json',scope:this,success:function(response){var dataset=Ext.decode(response.responseText).dataset;commonTreeUtils.addShowData(node,dataset);SitoolsDesk.navProfile.manageDatasetExplorerShowDefinitionAndForms(commonTreeUtils,node,dataset);conn.request({url:dataset.sitoolsAttachementForUsers
+&quot;/opensearch.xml&quot;,scope:this,success:function(response){var xml=response.responseXML;var dq=Ext.DomQuery;var success=dq.selectNode('OpenSearchDescription ',xml);if(success!==undefined){}
return true;}});}});return true;}},children:[{text:&quot;&quot;}]});}else{this.datasets.push({text:dataset.name,leaf:false,icon:loadUrl.get('APP_URL')
+&quot;/common/res/images/icons/cadenas.png&quot;,authorized:false});}
i++;},this);this.fireEvent('datasetLoaded');},failure:function(){Ext.Msg.alert(i18n.get('label.warning'),i18n.get('warning.noProject'));}});this.rootNode=new Ext.tree.AsyncTreeNode({nodeType:'async',text:'dataSets',leaf:false,draggable:false,children:this.datasets,expanded:false,listeners:{scope:this,beforeexpand:function(){this.rootNode.removeAll(true);this.rootNode.appendChild(this.datasets);return true;}}});sitools.widget.HtmlEditor.datasetBrowser.superclass.constructor.call(this,Ext.apply({expanded:true,useArrows:true,autoScroll:true,animate:true,loader:new Ext.tree.TreeLoader(),root:this.rootNode,rootVisible:true,layout:'fit',listeners:{beforeload:function(node){return node.isRoot||Ext.isDefined(node.attributes.children);},datasetLoaded:function(){this.getRootNode().expand();}},bbar:[{xtype:'button',text:i18n.get('label.select'),scope:this,handler:this.onValidate}]}));};Ext.extend(sitools.widget.HtmlEditor.datasetBrowser,Ext.tree.TreePanel,{_getSettings:function(){return{preferencesPath:&quot;/modules&quot;,preferencesFileName:this.id};},onValidate:function(){var selNode=this.selModel.getSelectedNode();if(selNode.isLeaf()&amp;&amp;selNode.attributes.type!=&quot;defi&quot;){var urlLink,displayValue;urlLink=selNode.attributes.dataUrl;displayValue=selNode.attributes.winTitle;this.browseField.setValue(displayValue);if(selNode.attributes.type==&quot;data&quot;){this.browseField.dataLinkComponent=String.format(&quot;&lt;a href='#' onclick='parent.sitools.user.component.dataviews.dataviewUtils.showDetailsData(\&quot;\&quot;,\&quot;\&quot;,\&quot;{0}\&quot;); return false;'&gt;&quot;,urlLink);}
else if(selNode.attributes.type==&quot;form&quot;){this.browseField.dataLinkComponent=String.format(&quot;&lt;a href='#' onclick='parent.SitoolsDesk.showFormFromEditor(\&quot;{0}\\/forms\&quot;); return false;'&gt;&quot;,urlLink);}
this.ownerCt.close();}
else{Ext.Msg.alert(i18n.get('label.info'),i18n.get('label.selectNode'));}}});Ext.reg('sitools.widget.HtmlEditor.datasetBrowser',sitools.widget.HtmlEditor.datasetBrowser);Ext.override(GeoExt.data.FeatureStore,{multiSort:function(sorters,direction){this.hasMultiSort=true;direction=direction||&quot;ASC&quot;;if(this.multiSortInfo&amp;&amp;direction==this.multiSortInfo.direction){direction=direction.toggle(&quot;ASC&quot;,&quot;DESC&quot;);}
this.multiSortInfo={sorters:sorters,direction:direction};if(this.remoteSort){this.load(this.lastOptions);}else{this.applySort();this.fireEvent('datachanged',this);}},getSortState:function(){return this.hasMultiSort?this.multiSortInfo:this.sortInfo;},load:function(options){options=Ext.apply({},options);this.storeOptions(options);if((this.sortInfo||this.multiSortInfo)&amp;&amp;this.remoteSort){var pn=this.paramNames;options.params=Ext.apply({},options.params);this.isInSort=true;var root=pn.sort;if(this.hasMultiSort){options.params[pn.sort]=Ext.encode({&quot;ordersList&quot;:this.multiSortInfo.sorters});}else{options.params[pn.sort]=Ext.encode({&quot;ordersList&quot;:[this.sortInfo]});}}
try{return this.execute('read',null,options);}catch(e){this.handleException(e);return false;}}});Ext.namespace('sitools.env');var userPreferences=null;var userLogin=null;var sql2ext={map:[],load:function(url){var i18nRef=this;Ext.Ajax.request({method:'GET',url:url,success:function(response,opts){ann(response.responseText,&quot;no response is sent&quot;);i18nRef.map=i18nRef.transformsPropertiesToMap(response.responseText);},failure:function(response,opts){alert(&quot;Error! Can't read i18n file with url :&quot;+url);}});},transformsPropertiesToMap:function(text){var array=text.split('\n');var localMap=[];var i;for(i=0;i&lt;array.length;i++){var string=array[i];var indexOfEqualsSign=string.indexOf('=');if(indexOfEqualsSign&gt;=1){var key=string.substring(0,indexOfEqualsSign).replace('\r','');var value=string.substring(indexOfEqualsSign+1).replace('\r','');localMap[key]=value;}}
return localMap;},get:function(entry){return!Ext.isEmpty(this.map[entry])?this.map[entry]:'auto';}};var i18n={map:[],load:function(url,callback,loopOnFailure){var i18nRef=this;Ext.Ajax.request({method:'GET',url:url,loopOnFailure:(Ext.isEmpty(loopOnFailure))?true:loopOnFailure,success:function(response,opts){ann(response.responseText,&quot;no response is sent&quot;);i18nRef.map=i18nRef.transformsPropertiesToMap(response.responseText);if(Ext.isFunction(callback)){callback();}},failure:function(response,opts){if(!opts.loopOnFailure){Ext.Msg.alert(&quot;Error! Can't read i18n file with url :&quot;+url);}else{locale.restoreDefault();url='/sitools/res/i18n/'+locale.getLocale()+'/gui.properties';i18n.load(url,callback,false);}}});},transformsPropertiesToMap:function(text){var array=text.split('\n');var localMap=[];var i;for(i=0;i&lt;array.length;i++){var string=array[i];var indexOfEqualsSign=string.indexOf('=');if(indexOfEqualsSign&gt;=1){var key=string.substring(0,indexOfEqualsSign).replace('\r','');var value=string.substring(indexOfEqualsSign+1).replace('\r','');localMap[key]=value;}}
return localMap;},get:function(entry){return!Ext.isEmpty(this.map[entry])?this.map[entry]:entry;}};var componentManager={loadedComponents:[],load:function(name){}};var data={ret:null,get:function(url,cbk){Ext.Ajax.request({method:'GET',url:url,success:function(response,opts){cbk(Ext.decode(response.responseText));},failure:function(response,opts){Ext.Msg.alert(&quot;Warning&quot;,&quot;Error! Can't get data with url :&quot;+url);}});return this.ret;}};userLogin=Ext.util.Cookies.get('userLogin');var userStorage={set:function(filename,filepath,content,callback){Ext.Ajax.request({url:loadUrl.get('APP_URL')+loadUrl.get('APP_USERSTORAGE_USER_URL').replace('{identifier}',userLogin)+&quot;/files&quot;,method:'POST',scope:this,params:{filepath:filepath,filename:filename},jsonData:content,success:function(ret){var Json=Ext.decode(ret.responseText);if(!Json.success){Ext.Msg.alert(i18n.get('label.warning'),Json.message);return;}else{var notify=new Ext.ux.Notification({iconCls:'x-icon-information',title:i18n.get('label.information'),html:Json.message,autoDestroy:true,hideDelay:1000});notify.show(document);}},failure:function(){Ext.Msg.alert(i18n.get('label.warning'),i18n.get('label.warning.savepreference.error'));return;},callback:function(){if(!Ext.isEmpty(callback)){callback.call();}}});},get:function(fileName,filePath,scope,success,failure,callback){Ext.Ajax.request({url:loadUrl.get('APP_URL')+loadUrl.get('APP_USERSTORAGE_USER_URL').replace('{identifier}',userLogin)+&quot;/files&quot;+filePath+&quot;/&quot;+fileName,method:'GET',scope:scope,success:success,failure:failure,callback:callback});}};var projectGlobal={projectId:null,projectName:null,preferences:null,userRoles:null,isAdmin:false,sitoolsAttachementForUsers:null,modules:null,links:null,callback:Ext.emptyFn,initProject:function(callback){this.callback=callback;this.projectName=this.getProjectName();this.getProjectInfo();},getDataViewsDependencies:function(){Ext.Ajax.request({url:this.sitoolsAttachementForUsers+&quot;/datasetViews&quot;,method:&quot;GET&quot;,scope:this,success:function(ret){var json=Ext.decode(ret.responseText);if(!json.success){Ext.Msg.alert(i18n.get('label.warning'),i18n.get('warning.noProjectName'));return false;}else{var data=json.data;Ext.each(data,function(datasetViewComponent){if(!Ext.isEmpty(datasetViewComponent.dependencies)&amp;&amp;!Ext.isEmpty(datasetViewComponent.dependencies.js)){Ext.each(datasetViewComponent.dependencies.js,function(dependencies){includeJs(dependencies.url);},this);}
if(!Ext.isEmpty(datasetViewComponent.dependencies)&amp;&amp;!Ext.isEmpty(datasetViewComponent.dependencies.css)){Ext.each(datasetViewComponent.dependencies.css,function(dependencies){includeCss(dependencies.url);},this);}});}},callback:function(){this.getFormDependencies();}});},getFormDependencies:function(){Ext.Ajax.request({url:loadUrl.get('APP_URL')+loadUrl.get('APP_FORMCOMPONENTS_URL'),method:&quot;GET&quot;,scope:this,success:function(ret){var json=Ext.decode(ret.responseText);if(!json.success){Ext.Msg.alert(i18n.get('label.warning'),i18n.get('warning.noProjectName'));return false;}else{var data=json.data;Ext.each(data,function(formComponent){includeJs(formComponent.fileUrlUser);});}},callback:function(){this.initLanguages();}});},initLanguages:function(){Ext.Ajax.request({scope:this,method:&quot;GET&quot;,url:loadUrl.get('APP_URL')+'/client-user/tmp/langues.json',success:function(response){var json=Ext.decode(response.responseText);this.languages=json.data;},failure:function(response){Ext.Msg.alert('Status',i18n.get('warning.serverError'));},callback:function(){this.getPreferences(this.callback);}});},getUserRoles:function(cb){if(Ext.isEmpty(userLogin)){cb.call();}
else{Ext.Ajax.request({url:loadUrl.get('APP_URL')+loadUrl.get(&quot;APP_USER_ROLE_URL&quot;),method:&quot;GET&quot;,scope:this,success:function(ret){var json=Ext.decode(ret.responseText);if(!json.success){Ext.Msg.alert(i18n.get('label.warning'),i18n.get('warning.noProjectName'));return false;}else{this.user=json.user;if(Ext.isEmpty(this.user.roles)){return;}
for(var index=0;index&lt;this.user.roles.length;index++){var role=this.user.roles[index];if(role.name===&quot;Administrator&quot;){this.isAdmin=true;}}}},callback:cb});}},getProjectName:function(){if(this.projectName===null){var url=document.location.pathname;var tabUrl=url.split(&quot;/&quot;);var i=0,index;var found=false;while(i&lt;tabUrl.length&amp;&amp;!found){if(tabUrl[i]===&quot;project-index.html&quot;){found=true;index=i;}
i++;}
this.projectName=tabUrl[index-1];if(this.projectName===undefined||this.projectName===&quot;&quot;){Ext.Msg.alert(i18n.get('label.warning'),i18n.get('warning.noProject'));}}
return this.projectName;},getProjectInfo:function(){Ext.Ajax.request({url:loadUrl.get('APP_URL')+loadUrl.get('APP_PORTAL_URL')+'/projects/'+this.projectName,method:&quot;GET&quot;,scope:this,success:function(ret){var data=Ext.decode(ret.responseText);if(!data.success){Ext.Msg.alert(i18n.get('label.warning'),i18n.get('warning.noProjectName'));return false;}else{this.sitoolsAttachementForUsers=data.project.sitoolsAttachementForUsers;this.projectId=data.project.id;this.projectName=data.project.name;this.htmlHeader=data.project.htmlHeader;this.links=data.project.links;this.navigationMode=data.project.navigationMode;}},callback:function(){this.getDataViewsDependencies();},failure:function(){Ext.Msg.alert(i18n.get('label.warning'),i18n.get('warning.noProject'));}});},getPreferences:function(callback){if(!Ext.isEmpty(userLogin)){var filePath=&quot;/&quot;+DEFAULT_PREFERENCES_FOLDER+&quot;/&quot;+projectGlobal.projectName;var fileName=&quot;desktop&quot;;var success=function(ret){try{this.preferences=Ext.decode(ret.responseText);callback.call();}catch(err){callback.call();}};var failure=function(ret){this.getPublicPreferences(callback);};userStorage.get(fileName,filePath,this,success,failure);}else{this.getPublicPreferences(callback);}},getPublicPreferences:function(callback){var AppPublicStorage=loadUrl.get('APP_PUBLIC_STORAGE_URL')+&quot;/files&quot;;Ext.Ajax.request({url:loadUrl.get('APP_URL')+AppPublicStorage+&quot;/&quot;+DEFAULT_PREFERENCES_FOLDER+&quot;/&quot;+this.projectName+&quot;/desktop?media=json&quot;,method:'GET',scope:this,success:function(ret){try{this.preferences=Ext.decode(ret.responseText);}catch(err){this.preferences=null;}},callback:callback});}};var publicStorage={set:function(filename,filepath,content,callback){this.url=loadUrl.get('APP_URL')+loadUrl.get('APP_PUBLIC_STORAGE_URL')+&quot;/files&quot;;Ext.Ajax.request({url:this.url,method:'POST',scope:this,params:{filepath:filepath,filename:filename},jsonData:content,success:function(ret){var Json=Ext.decode(ret.responseText);if(!Json.success){Ext.Msg.alert(i18n.get('label.warning'),Json.message);return;}else{var notify=new Ext.ux.Notification({iconCls:'x-icon-information',title:i18n.get('label.information'),html:Json.message,autoDestroy:true,hideDelay:1000});notify.show(document);}},failure:function(){Ext.Msg.alert(i18n.get('label.warning'),i18n.get('label.warning.savepreference.error'));return;},callback:function(){if(!Ext.isEmpty(callback)){callback.call();}}});},get:function(fileName,filePath,scope,success,failure){Ext.Ajax.request({url:loadUrl.get('APP_URL')+loadUrl.get('APP_PUBLIC_STORAGE_URL')+&quot;/files&quot;+filePath+&quot;/&quot;+fileName,method:'GET',scope:scope,success:success,failure:failure});},remove:function(){this.url=loadUrl.get('APP_URL')+loadUrl.get('APP_PUBLIC_STORAGE_URL')+&quot;/files&quot;+&quot;?recursive=true&quot;;Ext.Ajax.request({url:this.url,method:'DELETE',scope:this,success:function(ret){var notify=new Ext.ux.Notification({iconCls:'x-icon-information',title:i18n.get('label.information'),html:i18n.get(&quot;label.publicUserPrefDeleted&quot;),autoDestroy:true,hideDelay:1000});notify.show(document);},failure:function(ret){if(ret.status===404){var notify=new Ext.ux.Notification({iconCls:'x-icon-information',title:i18n.get('label.information'),html:i18n.get(&quot;label.publicUserPrefDeleted&quot;),autoDestroy:true,hideDelay:1000});notify.show(document);}
else{var notifye=new Ext.ux.Notification({iconCls:'x-icon-error',title:i18n.get('label.error'),html:ret.responseText,autoDestroy:true,hideDelay:1000});notifye.show(document);}}});}};function showResponse(ret,notification){try{var Json=Ext.decode(ret.responseText);if(!Json.success){Ext.Msg.alert(i18n.get('label.warning'),Json.message);return false;}
if(notification){var notify=new Ext.ux.Notification({iconCls:'x-icon-information',title:i18n.get('label.information'),html:Json.message,autoDestroy:true,hideDelay:1000});notify.show(document);}
return true;}catch(err){Ext.Msg.alert(i18n.get('label.warning'),i18n.get('warning.javascriptError')+&quot; : &quot;+err);return false;}};var DEFAULT_NATIVEJSON=false;var DEFAULT_TIMEOUT=30000;var DEFAULT_TIMEBUF=10;var DEFAULT_NBRETRY=0;var SERVER_OK=200;var DEFAULT_WIN_HEIGHT=400;var DEFAULT_WIN_WIDTH=600;var DEFAULT_WINORDER_WIDTH=400;var DEFAULT_ORDER_FOLDER=&quot;dataSelection&quot;;var DEFAULT_PREFERENCES_FOLDER=&quot;preferences&quot;;var DEFAULT_LIVEGRID_BUFFER_SIZE=300;var WARNING_NB_RECORDS_PLOT=10000;var URL_CGU=&quot;/sitools/res/licences/cgu.html&quot;;var COOKIE_DURATION=20;var MULTIDS_TIME_DELAY=2000;var SITOOLS_DEFAULT_PROJECT_IMAGE_URL=&quot;/sitools/res/images/sitools2_logo.png&quot;;var DEFAULT_NEAR_LIMIT_SIZE=100;Ext.BLANK_IMAGE_URL='/sitools/cots/extjs/resources/images/default/s.gif';Ext.USE_NATIVE_JSON=DEFAULT_NATIVEJSON;Ext.Ajax.timeout=DEFAULT_TIMEOUT;var onBeforeRequest=function(conn,options){var date=new Date();if(!Ext.isEmpty(Ext.util.Cookies.get('scheme'))){if(Ext.util.Cookies.get('scheme')==&quot;HTTP_Digest&quot;){var tmp=null;var method=&quot;GET&quot;;if(!Ext.isEmpty(options.method)){method=options.method;}
var url=options.url;if(Ext.isEmpty(options.url)&amp;&amp;!Ext.isEmpty(options.scope)){if(!Ext.isEmpty(options.scope.url)){url=options.scope.url;}}
var A1=Ext.util.Cookies.get(&quot;A1&quot;);var auth=new Digest({usr:Ext.util.Cookies.get(&quot;userLogin&quot;),algorithm:Ext.util.Cookies.get(&quot;algorithm&quot;),realm:Ext.util.Cookies.get(&quot;realm&quot;),url:url,nonce:Ext.util.Cookies.get('nonce'),method:method,mode:&quot;digest&quot;,A1:A1});Ext.apply(Ext.Ajax.defaultHeaders,{Authorization:auth.getDigestAuth()});}
else{if(!Ext.isEmpty(Ext.util.Cookies.get('hashCode'))){Ext.util.Cookies.set('hashCode',Ext.util.Cookies.get('hashCode'),date.add(Date.MINUTE,COOKIE_DURATION));Ext.apply(Ext.Ajax.defaultHeaders,{Authorization:Ext.util.Cookies.get('hashCode')});}}}
if(!Ext.isEmpty(Ext.util.Cookies.get('userLogin'))){Ext.util.Cookies.set('userLogin',Ext.util.Cookies.get('userLogin'),date.add(Date.MINUTE,20));}};Ext.Ajax.on('beforerequest',onBeforeRequest,this);var DEFAULT_LOCALE=&quot;en&quot;;var SITOOLS_DATE_FORMAT='Y-m-d\\TH:i:s.u';var SITOOLS_DEFAULT_IHM_DATE_FORMAT='Y-m-d H:i:s.u';var locale={locale:DEFAULT_LOCALE,isInit:false,getLocale:function(){if(!this.isInit){if(Ext.isEmpty(Ext.util.Cookies.get('language'))){var navigator=window.navigator;this.locale=navigator.language||navigator.browserLanguage||navigator.userLanguage;}
else{this.locale=Ext.util.Cookies.get('language');}
this.isInit=true;}
return this.locale;},setLocale:function(locale){this.locale=locale;},restoreDefault:function(){this.setLocale(DEFAULT_LOCALE);}};var onRequestFeedException=function(proxy,type,action,options,response,args){if((response.status==403)&amp;&amp;!Ext.isEmpty(Ext.util.Cookies.get('hashCode'))){Ext.MessageBox.minWidth=360;Ext.MessageBox.alert(i18n.get('label.session.expired'),response.responseText);}else{Ext.MessageBox.minWidth=360;Ext.MessageBox.alert(i18n.get('label.error'),response.responseText);}
return false;};var desktop;var projectGlobal;var projectId;function alertFailure(response,opts){var txt;if(response.status==SERVER_OK){var ret=Ext.decode(response.responseText).message;txt=i18n.get('msg.error')+': '+ret;}else{txt=i18n.get('warning.serverError')+': '+response.statusText;}
Ext.Msg.alert(i18n.get('label.warning'),txt);}
function extColModelToJsonColModel(ExtColModel){var colModel=[];var columns;if(!Ext.isEmpty(ExtColModel.columns)){columns=ExtColModel.columns;}
else{columns=ExtColModel;}
Ext.each(columns,function(column){colModel.push({columnAlias:column.columnAlias,dataIndex:column.dataIndexSitools,dataIndexSitools:column.dataIndexSitools,header:column.header,filter:column.filter,hidden:column.hidden,id:column.id,previewColumn:column.previewColumn,primaryKey:column.primaryKey,schema:column.schema,sortable:column.sortable,sqlColumnType:column.sqlColumnType,tableAlias:column.tableAlias,tableName:column.tableName,toolTip:column.tooltip,urlColumn:column.urlColumn,width:column.width,columnRenderer:column.columnRenderer,specificColumnType:column.specificColumnType,javaSqlColumnType:column.javaSqlColumnType,format:column.format});});return colModel;}
function extColModelToSrv(ExtColModel){var colModel=[];var columns;if(!Ext.isEmpty(ExtColModel.columns)){columns=ExtColModel.columns;}
else{columns=ExtColModel;}
Ext.each(columns,function(column){if(!column.hidden){colModel.push(column.columnAlias);}});return colModel.join(&quot;, &quot;);}
function extColModelToStorage(ExtColModel){var colModel=[];var columns;if(!Ext.isEmpty(ExtColModel.columns)){columns=ExtColModel.columns;}
else{columns=ExtColModel;}
Ext.each(columns,function(column){if(!column.hidden){colModel.push({columnAlias:column.columnAlias,dataIndex:column.dataIndex,dataIndexSitools:column.dataIndexSitools,editor:column.editor,filter:column.filter,header:column.header,hidden:column.hidden,id:column.id,isColumn:column.isColumn,previewColumn:column.previewColumn,primaryKey:column.primaryKey,schema:column.schema,sortable:column.sortable,sqlColumnType:column.sqlColumnType,tableAlias:column.tableAlias,tableName:column.tableName,toolTip:column.tooltip,urlColumn:column.urlColumn,width:column.width,columnRenderer:column.columnRenderer,specificColumnType:column.specificColumnType,javaSqlColumnType:column.javaSqlColumnType,unit:column.unit,format:column.format});}});return colModel;}
function getDesktop(){if(Ext.isEmpty(this.SitoolsDesk)){return null;}
else{return this.SitoolsDesk.app.desktop;}}
function getApp(){if(Ext.isEmpty(SitoolsDesk)){return null;}
else{return SitoolsDesk.app;}}
Ext.override(Ext.Window,{initEvents:function(){Ext.Window.superclass.initEvents.call(this);if(this.animateTarget){this.setAnimateTarget(this.animateTarget);}
if(this.resizable){this.resizer=new Ext.Resizable(this.el,{minWidth:this.minWidth,minHeight:this.minHeight,handles:this.resizeHandles||'all',pinned:true,resizeElement:this.resizerAction,handleCls:'x-window-handle'});this.resizer.window=this;this.mon(this.resizer,'beforeresize',this.beforeResize,this);}
if(this.draggable){this.header.addClass('x-window-draggable');}
this.mon(this.el,'mousedown',this.toFront,this);var tmp=getDesktop();if(Ext.isEmpty(tmp)){this.manager=Ext.WindowMgr;}
else{this.manager=getDesktop().getManager()||Ext.WindowMgr;}
this.manager.register(this);if(this.maximized){this.maximized=false;this.maximize();}
if(this.closable){var km=this.getKeyMap();km.on(27,this.onEsc,this);km.disable();}}});Ext.override(Ext.grid.GridPanel,{stripeRows:true});Ext.data.Types.DATEASSTRING={convert:function(v,data){return v;},sortType:function(v){return v;},type:&quot;dateAsString&quot;};function includeJs(url){if(Ext.isEmpty(url)){return;}
var head=document.getElementsByTagName('head')[0];var script=document.createElement('script');script.setAttribute('src',url);script.setAttribute('type','text/javascript');head.appendChild(script);}
function includeCss(url){var headID=document.getElementsByTagName(&quot;head&quot;)[0];var newCss=document.createElement('link');newCss.type='text/css';newCss.rel='stylesheet';newCss.href=url;newCss.media='screen';headID.appendChild(newCss);}
Ext.override(Ext.PagingToolbar,{initComponent:function(){var T=Ext.Toolbar;var pagingItems=[this.first=new T.Button({tooltip:this.firstText,overflowText:this.firstText,iconCls:'x-tbar-page-first',disabled:true,handler:this.moveFirst,scope:this}),this.prev=new T.Button({tooltip:this.prevText,overflowText:this.prevText,iconCls:'x-tbar-page-prev',disabled:true,handler:this.movePrevious,scope:this}),'-',this.beforePageText,this.inputItem=new Ext.form.NumberField({cls:'x-tbar-page-number',allowDecimals:false,allowNegative:false,enableKeyEvents:true,selectOnFocus:true,submitValue:false,listeners:{scope:this,keydown:this.onPagingKeyDown,blur:this.onPagingBlur}}),this.afterTextItem=new T.TextItem({text:String.format(this.afterPageText,1)}),'-',this.next=new T.Button({tooltip:this.nextText,overflowText:this.nextText,iconCls:'x-tbar-page-next',disabled:true,handler:this.moveNext,scope:this}),this.last=new T.Button({tooltip:this.lastText,overflowText:this.lastText,iconCls:'x-tbar-page-last',disabled:true,handler:this.moveLast,scope:this}),'-'];var userItems=this.items||this.buttons||[];if(this.prependButtons){this.items=userItems.concat(pagingItems);}else{this.items=pagingItems.concat(userItems);}
delete this.buttons;if(this.displayInfo){this.items.push('-&gt;');this.items.push(this.displayItem=new T.TextItem({}));}
Ext.PagingToolbar.superclass.initComponent.call(this);this.addEvents('change','beforechange');this.on('afterlayout',this.onFirstLayout,this,{single:true});this.cursor=0;this.bindStore(this.store,true);},onFirstLayout:function(){this.refresh=new Ext.Toolbar.Button({tooltip:i18n.get('label.refreshText'),overflowText:i18n.get('label.refreshText'),iconCls:'x-tbar-loading',handler:this.doRefresh,scope:this});this.insert(10,this.refresh);if(this.dsLoaded){this.onLoad.apply(this,this.dsLoaded);}}});function getColumnModel(listeColonnes,dictionnaryMappings,dataviewConfig){var columns=[];if(!Ext.isEmpty(listeColonnes)){Ext.each(listeColonnes,function(item,index,totalItems){var tooltip=&quot;&quot;;if(item.toolTip){tooltip=item.toolTip;}
else{if(Ext.isArray(dictionnaryMappings)&amp;&amp;!Ext.isEmpty(dictionnaryMappings)){var dico=dictionnaryMappings[0];var dicoMapping=dico.mapping||[];dicoMapping.each(function(mapping){if(item.columnAlias==mapping.columnAlias){var concept=mapping.concept||{};if(!Ext.isEmpty(concept.description)){tooltip+=concept.description.replace('&quot;',&quot;''&quot;)+&quot;&lt;br&gt;&quot;;}}});}}
var renderer=sitools.user.component.dataviews.dataviewUtils.getRendererLiveGrid(item,dataviewConfig);var hidden;if(Ext.isEmpty(item.visible)){hidden=item.hidden;}else{hidden=!item.visible;}
if(Ext.isEmpty(item.columnRenderer)||ColumnRendererEnum.NO_CLIENT_ACCESS!=item.columnRenderer.behavior){columns.push(new Ext.grid.Column({columnAlias:item.columnAlias,dataIndexSitools:item.dataIndex,dataIndex:item.columnAlias,header:item.header,width:item.width,sortable:item.sortable,hidden:hidden,tooltip:tooltip,renderer:renderer,schema:item.schema,tableName:item.tableName,tableAlias:item.tableAlias,id:item.id,primaryKey:item.primaryKey,previewColumn:item.previewColumn,filter:item.filter,sqlColumnType:item.sqlColumnType,columnRenderer:item.columnRenderer,specificColumnType:item.specificColumnType,format:item.format}));}},this);}
var cm=new Ext.grid.ColumnModel({columns:columns});return cm;}
Ext.override(Ext.menu.DateMenu,{initComponent:function(){this.on('beforeshow',this.onBeforeShow,this);if(this.strict==(Ext.isIE7&amp;&amp;Ext.isStrict)){this.on('show',this.onShow,this,{single:true,delay:20});}
Ext.apply(this,{plain:true,showSeparator:false,items:this.picker=new Ext.SitoolsDatePicker(Ext.applyIf({internalRender:this.strict||!Ext.isIE,ctCls:'x-menu-date-item',id:this.pickerId},this.initialConfig))});this.picker.purgeListeners();Ext.menu.DateMenu.superclass.initComponent.call(this);this.relayEvents(this.picker,['select']);this.on('show',this.picker.focus,this.picker);this.on('select',this.menuHide,this);if(this.handler){this.on('select',this.handler,this.scope||this);}}});Ext.override(Ext.form.DateField,{showTime:false,onTriggerClick:function(){if(this.disabled){return;}
if(Ext.isEmpty(this.menu)){this.menu=new Ext.menu.DateMenu({hideOnClick:false,showTime:this.showTime,focusOnSelect:false});}
this.onFocus();Ext.apply(this.menu.picker,{minDate:this.minValue,maxDate:this.maxValue,disabledDatesRE:this.disabledDatesRE,disabledDatesText:this.disabledDatesText,disabledDays:this.disabledDays,disabledDaysText:this.disabledDaysText,format:this.format,showToday:this.showToday,minText:String.format(this.minText,this.formatDate(this.minValue)),maxText:String.format(this.maxText,this.formatDate(this.maxValue))});this.menu.picker.setValue(this.getValue()||new Date());this.menu.show(this.el,&quot;tl-bl?&quot;);this.menuEvents('on');}});function viewFileContent(url,title){Ext.Ajax.request({url:url,method:'HEAD',scope:this,success:function(ret){try{var headerFile=ret.getResponseHeader(&quot;Content-Type&quot;).split(&quot;;&quot;)[0].split(&quot;/&quot;)[0];if(headerFile==&quot;text&quot;||ret.getResponseHeader(&quot;Content-Type&quot;).indexOf(&quot;application/json&quot;)&gt;=0){Ext.Ajax.request({url:url,method:'GET',scope:this,success:function(ret){var windowConfig={id:&quot;winPreferenceDetailId&quot;,title:title,iconCls:&quot;version&quot;};var jsObj=sitools.user.component.entete.userProfile.viewTextPanel;var componentCfg={text:ret.responseText,formatJson:(ret.getResponseHeader(&quot;Content-Type&quot;).indexOf(&quot;application/json&quot;)&gt;=0)};SitoolsDesk.addDesktopWindow(windowConfig,componentCfg,jsObj);}});}
else if(headerFile==&quot;image&quot;){sitools.user.component.dataviews.dataviewUtils.showPreview(url,title);}
else{sitools.user.component.dataviews.dataviewUtils.downloadFile(url);}}catch(err){Ext.Msg.alert(i18n.get('label.error'),err);}},failure:function(ret){return null;}});}
Ext.override(Ext.data.XmlReader,{buildExtractors:function(){if(this.ef){return;}
var s=this.meta,Record=this.recordType,f=Record.prototype.fields,fi=f.items,fl=f.length;if(s.totalProperty){this.getTotal=this.createAccessor(s.totalProperty);}
if(s.successProperty){this.getSuccess=this.createAccessor(s.successProperty);}
if(s.messageProperty){this.getMessage=this.createAccessor(s.messageProperty);}
this.getRoot=function(res){return(!Ext.isEmpty(res[this.meta.record]))?res[this.meta.record]:res[this.meta.root];};if(s.idPath||s.idProperty){var g=this.createAccessor(s.idPath||s.idProperty);this.getId=function(rec){var id=g(rec)||rec.id;return(id===undefined||id==='')?null:id;};}else{this.getId=function(){return null;};}
var ef=[];for(var i=0;i&lt;fl;i++){f=fi[i];var map=(f.mapping!==undefined&amp;&amp;f.mapping!==null)?f.mapping:f.name;if(f.createAccessor!==undefined&amp;&amp;f.createAccessor!==null){ef.push(f.createAccessor);}
else{ef.push(this.createAccessor(map));}}
this.ef=ef;}});Ext.override(Ext.layout.BorderLayout.Region,{getCollapsedEl:function(){if(!this.collapsedEl){if(!this.toolTemplate){var tt=new Ext.Template('&lt;span class=&quot;x-panel-collapsed-text&quot;&gt;{title}&lt;/span&gt;','&lt;div class=&quot;x-tool x-tool-{id}&quot;&gt;&amp;#160;&lt;/div&gt;');tt.disableFormats=true;tt.compile();Ext.layout.BorderLayout.Region.prototype.toolTemplate=tt;}
this.collapsedEl=this.targetEl.createChild({cls:&quot;x-layout-collapsed x-layout-collapsed-&quot;+this.position,id:this.panel.id+'-xcollapsed'});this.collapsedEl.enableDisplayMode('block');if(this.collapseMode=='mini'){this.collapsedEl.addClass('x-layout-cmini-'+this.position);this.miniCollapsedEl=this.collapsedEl.createChild({cls:&quot;x-layout-mini x-layout-mini-&quot;+this.position,html:&quot;&amp;#160;&quot;});this.miniCollapsedEl.addClassOnOver('x-layout-mini-over');this.collapsedEl.addClassOnOver(&quot;x-layout-collapsed-over&quot;);this.collapsedEl.on('click',this.onExpandClick,this,{stopEvent:true});}
else{if(this.collapsible!==false&amp;&amp;!this.hideCollapseTool){var t=this.expandToolEl=this.toolTemplate.append(this.collapsedEl.dom,{id:'expand-'+this.position,title:this.panel.collapsedTitle},true);t.addClassOnOver('x-tool-expand-'+this.position+'-over');t.on('click',this.onExpandClick,this,{stopEvent:true});}
if(this.floatable!==false||this.titleCollapse){this.collapsedEl.addClassOnOver(&quot;x-layout-collapsed-over&quot;);this.collapsedEl.on(&quot;click&quot;,this[this.floatable?'collapseClick':'onExpandClick'],this);}}}
return this.collapsedEl;}});Ext.ns(&quot;sitools.user&quot;);sitools.user.clickDatasetIcone=function(url,type,extraCmpConfig){Ext.Ajax.request({method:&quot;GET&quot;,url:url,success:function(ret){var Json=Ext.decode(ret.responseText);if(showResponse(ret)){var dataset=Json.dataset;var componentCfg,javascriptObject;var windowConfig={datasetName:dataset.name,type:type,saveToolbar:true,toolbarItems:[]};switch(type){case&quot;desc&quot;:Ext.apply(windowConfig,{title:i18n.get('label.description')+&quot; : &quot;+dataset.name,id:&quot;desc&quot;+dataset.id,saveToolbar:false,iconCls:&quot;version&quot;});componentCfg={autoScroll:true,html:dataset.descriptionHTML};Ext.applyIf(componentCfg,extraCmpConfig);javascriptObject=Ext.Panel;SitoolsDesk.addDesktopWindow(windowConfig,componentCfg,javascriptObject);break;case&quot;data&quot;:javascriptObject=eval(SitoolsDesk.navProfile.getDatasetOpenMode(dataset));Ext.apply(windowConfig,{winWidth:900,winHeight:400,title:i18n.get('label.dataTitle')+&quot; : &quot;+dataset.name,id:type+dataset.id,iconCls:&quot;dataviews&quot;});componentCfg={dataUrl:dataset.sitoolsAttachementForUsers,datasetId:dataset.Id,datasetCm:dataset.columnModel,datasetName:dataset.name,dictionaryMappings:dataset.dictionaryMappings,datasetViewConfig:dataset.datasetViewConfig,preferencesPath:&quot;/&quot;+dataset.datasetName,preferencesFileName:&quot;datasetOverview&quot;,sitoolsAttachementForUsers:dataset.sitoolsAttachementForUsers};Ext.applyIf(componentCfg,extraCmpConfig);SitoolsDesk.addDesktopWindow(windowConfig,componentCfg,javascriptObject);break;case&quot;forms&quot;:var menuForms=new Ext.menu.Menu();Ext.Ajax.request({method:&quot;GET&quot;,url:dataset.sitoolsAttachementForUsers+&quot;/forms&quot;,success:function(ret){try{var Json=Ext.decode(ret.responseText);if(!Json.success){throw Json.message;}
if(Json.total===0){throw i18n.get('label.noForms');}
javascriptObject=sitools.user.component.forms.mainContainer;if(Json.total==1){var form=Json.data[0];Ext.apply(windowConfig,{title:i18n.get('label.forms')+&quot; : &quot;+dataset.name+&quot;.&quot;+form.name,iconCls:&quot;forms&quot;});Ext.apply(windowConfig,{id:type+dataset.id+form.id});componentCfg={dataUrl:dataset.sitoolsAttachementForUsers,dataset:dataset,formId:form.id,formName:form.name,formParameters:form.parameters,formWidth:form.width,formHeight:form.height,formCss:form.css,preferencesPath:&quot;/&quot;+dataset.name+&quot;/forms&quot;,preferencesFileName:form.name};Ext.applyIf(componentCfg,extraCmpConfig);SitoolsDesk.addDesktopWindow(windowConfig,componentCfg,javascriptObject);}
else{var handler=null;Ext.each(Json.data,function(form){handler=function(form,dataset){Ext.apply(windowConfig,{title:i18n.get('label.forms')+&quot; : &quot;+dataset.name+&quot;.&quot;+form.name,iconCls:&quot;forms&quot;});Ext.apply(windowConfig,{id:type+dataset.id+form.id});componentCfg={dataUrl:dataset.sitoolsAttachementForUsers,formId:form.id,formName:form.name,formParameters:form.parameters,formWidth:form.width,formHeight:form.height,formCss:form.css,dataset:dataset};Ext.applyIf(componentCfg,extraCmpConfig);SitoolsDesk.addDesktopWindow(windowConfig,componentCfg,javascriptObject);};menuForms.addItem({text:form.name,handler:function(){handler(form,dataset);},icon:loadUrl.get('APP_URL')+&quot;/common/res/images/icons/tree_forms.png&quot;});},this);menuForms.showAt(Ext.EventObject.xy);}}
catch(err){var tmp=new Ext.ux.Notification({iconCls:'x-icon-information',title:i18n.get('label.information'),html:i18n.get(err),autoDestroy:true,hideDelay:1000}).show(document);}}});break;case&quot;feeds&quot;:var menuFeeds=new Ext.menu.Menu();Ext.Ajax.request({method:&quot;GET&quot;,url:dataset.sitoolsAttachementForUsers+&quot;/feeds&quot;,success:function(ret){try{var Json=Ext.decode(ret.responseText);if(!Json.success){throw Json.message;}
if(Json.total===0){throw i18n.get('label.noFeeds');}
javascriptObject=sitools.widget.FeedGridFlux;if(Json.total==1){var feed=Json.data[0];Ext.apply(windowConfig,{title:i18n.get('label.feeds')+&quot; : &quot;+dataset.name+&quot;.&quot;+feed.title,id:type+dataset.id+feed.id,iconCls:&quot;feedsModule&quot;});componentCfg={datasetId:dataset.id,urlFeed:dataset.sitoolsAttachementForUsers+&quot;/clientFeeds/&quot;+feed.name,feedType:feed.feedType,datasetName:dataset.name,feedSource:feed.feedSource,autoLoad:true};Ext.applyIf(componentCfg,extraCmpConfig);SitoolsDesk.addDesktopWindow(windowConfig,componentCfg,javascriptObject);}
else{var handler=null;Ext.each(Json.data,function(feed){handler=function(feed,dataset){Ext.apply(windowConfig,{title:i18n.get('label.feeds')+&quot; : &quot;+dataset.name+&quot;.&quot;+feed.title,id:type+dataset.id+feed.id,iconCls:&quot;feedsModule&quot;});componentCfg={datasetId:dataset.id,urlFeed:dataset.sitoolsAttachementForUsers+&quot;/clientFeeds/&quot;+feed.name,feedType:feed.feedType,datasetName:dataset.name,feedSource:feed.feedSource,autoLoad:true};Ext.applyIf(componentCfg,extraCmpConfig);SitoolsDesk.addDesktopWindow(windowConfig,componentCfg,javascriptObject);};menuFeeds.addItem({text:feed.name,handler:function(){handler(feed,dataset);},icon:loadUrl.get('APP_URL')+&quot;/common/res/images/icons/rss.png&quot;});},this);menuFeeds.showAt(Ext.EventObject.xy);}}
catch(err){var tmp=new Ext.ux.Notification({iconCls:'x-icon-information',title:i18n.get('label.information'),html:i18n.get(err),autoDestroy:true,hideDelay:1000}).show(document);}}});break;case&quot;defi&quot;:Ext.apply(windowConfig,{title:i18n.get('label.definitionTitle')+&quot; : &quot;+dataset.name,id:type+dataset.id,iconCls:&quot;semantic&quot;});javascriptObject=sitools.user.component.columnsDefinition;componentCfg={datasetId:dataset.id,datasetCm:dataset.columnModel,datasetName:dataset.name,dictionaryMappings:dataset.dictionaryMappings,preferencesPath:&quot;/&quot;+dataset.name,preferencesFileName:&quot;semantic&quot;};Ext.applyIf(componentCfg,extraCmpConfig);SitoolsDesk.addDesktopWindow(windowConfig,componentCfg,javascriptObject);break;case&quot;openSearch&quot;:Ext.Ajax.request({method:&quot;GET&quot;,url:dataset.sitoolsAttachementForUsers+&quot;/opensearch.xml&quot;,success:function(ret){var xml=ret.responseXML;var dq=Ext.DomQuery;var success=dq.selectNode('OpenSearchDescription ',xml);if(!success){var tmp=new Ext.ux.Notification({iconCls:'x-icon-information',title:i18n.get('label.information'),html:i18n.get(&quot;label.noOpenSearch&quot;),autoDestroy:true,hideDelay:1000}).show(document);return;}
Ext.apply(windowConfig,{title:i18n.get('label.opensearch')+&quot; : &quot;+dataset.name,id:type+dataset.id,iconCls:&quot;openSearch&quot;});javascriptObject=sitools.user.component.datasetOpensearch;componentCfg={datasetId:dataset.id,dataUrl:dataset.sitoolsAttachementForUsers,datasetName:dataset.name,preferencesPath:&quot;/&quot;+dataset.name,preferencesFileName:&quot;openSearch&quot;};Ext.applyIf(componentCfg,extraCmpConfig);SitoolsDesk.addDesktopWindow(windowConfig,componentCfg,javascriptObject);}});break;}}},failure:alertFailure});};Ext.override(Ext.form.Field,{tooltip:null,listeners:{render:function(){Ext.form.Field.superclass.render.apply(this,arguments);if(!Ext.isEmpty(this.tooltip)){var ttConfig={};if(Ext.isString(this.tooltip)){ttConfig={html:this.tooltip,width:200,dismissDelay:5000};}
else if(Ext.isObject(this.tooltip)){ttConfig=this.tooltip;}else{return;}
Ext.apply(ttConfig,{target:this.el});this.tTip=new Ext.ToolTip(ttConfig);}}}});Ext.override(Ext.BoxComponent,{tooltip:null,listeners:{render:function(){Ext.BoxComponent.superclass.render.apply(this,arguments);if(!Ext.isEmpty(this.tooltip)){var ttConfig={};if(Ext.isString(this.tooltip)){ttConfig={html:this.tooltip,width:200,dismissDelay:5000};}
else if(Ext.isObject(this.tooltip)){ttConfig=this.tooltip;}else{return;}
Ext.apply(ttConfig,{target:this.el});this.tTip=new Ext.ToolTip(ttConfig);}}}});Ext.override(Ext.Button,{setTooltip:function(){return;}});function initAppliDesktop(){return;}
var portal;var portalApp={projects:null,languages:null,preferences:null,autoChainAjaxRequest:true,initProjects:function(callback){Ext.Ajax.request({scope:this,url:loadUrl.get('APP_URL')+loadUrl.get('APP_PORTAL_URL')+'/projects?media=json',method:'GET',success:function(response){try{this.projects=Ext.decode(response.responseText).data;if(this.autoChainAjaxRequest){this.initLanguages();}}catch(err){Ext.Msg.alert(i18n.get('label.error'),err);}},failure:function(response){Ext.Msg.alert('Status',i18n.get('warning.serverError'));}});},initLanguages:function(){Ext.Ajax.request({scope:this,method:&quot;GET&quot;,url:loadUrl.get('APP_URL')+'/client-user/tmp/langues.json',success:function(response){this.languages=Ext.decode(response.responseText).data;if(this.autoChainAjaxRequest){this.initPreferences();}},failure:function(response){Ext.Msg.alert('Status',i18n.get('warning.serverError'));}});},initPreferences:function(cb){if(Ext.isEmpty(userLogin)){var projects=this.projects;var languages=this.languages;var preferences=this.preferences;var callback;if(this.autoChainAjaxRequest){callback=function(){portal=new sitools.Portal(projects,languages,preferences);};}
else{callback=cb;}
i18n.load(loadUrl.get('APP_URL')+'/res/i18n/'+locale.getLocale()+'/gui.properties',callback);return;}
var filePath=&quot;/&quot;+DEFAULT_PREFERENCES_FOLDER+'/portal';var success=function(response){this.preferences=Ext.decode(response.responseText);if(!Ext.isEmpty(this.preferences.language)){locale.setLocale(this.preferences.language);}};var failure=function(){return;};var callback=function(){var projects=this.projects;var languages=this.languages;var preferences=this.preferences;i18n.load(loadUrl.get('APP_URL')+'/res/i18n/'+locale.getLocale()+'/gui.properties',function(){portal=new sitools.Portal(projects,languages,preferences);});};userStorage.get(&quot;portal&quot;,filePath,this,success,failure,callback);},initAppliPortal:function(opts,callback){if(!Ext.isEmpty(Ext.util.Cookies.get('userLogin'))){var auth=Ext.util.Cookies.get('hashCode');Ext.Ajax.defaultHeaders={&quot;Authorization&quot;:auth,&quot;Accept&quot;:&quot;application/json&quot;,&quot;X-User-Agent&quot;:&quot;Sitools&quot;};}else{Ext.Ajax.defaultHeaders={&quot;Accept&quot;:&quot;application/json&quot;,&quot;X-User-Agent&quot;:&quot;Sitools&quot;};}
Ext.QuickTips.init();this.callSiteMapResource(opts.siteMapRes,callback);},callSiteMapResource:function(res,cb){var callback;if(this.autoChainAjaxRequest){callback=this.initProjects;}else{callback=cb;}
loadUrl.load(res+'/siteMap',callback,this);}};var ID={PANEL:{MENU:'menuPanelId',TREE:'treePanelId',MAIN:'mainPanelId',HELP:'helpPanelId'},CMP:{TOOLBAR:'toolbarId',MENU:'menuId'},WIN:{LOGIN:'loginWinId',ORDER:'orderWinId'},BOX:{REG:'regBoxId',USER:'userBoxId',GROUP:'groupBoxId',FIREWALL:'firewallBoxId'},PORTLET:{PROJET:'portletProjectId',RECHERCHE:'portletRecherceID',FEEDS:'portletFeedsId'},PORTALTREENAV:{PROJET:'navProjectId',RECHERCHE:'navRechercheId',FEEDS:'navFeedsId'}};var commonTreeUtils={addShowData:function(node,dataset){node.appendChild({id:&quot;nodedata&quot;+dataset.id,text:i18n.get('label.dataTitle'),winTitle:i18n.get('label.dataTitle')+&quot; : &quot;+dataset.name,leaf:true,type:&quot;data&quot;,datasetId:dataset.id,columnModel:dataset.columnModel,datasetName:dataset.name,datasetDescription:dataset.description,dataUrl:dataset.sitoolsAttachementForUsers,dictionaryMappings:dataset.dictionaryMappings,icon:loadUrl.get('APP_URL')+&quot;/common/res/images/icons/tree_datasets.png&quot;,datasetView:dataset.datasetView,datasetViewConfig:dataset.datasetViewConfig,sitoolsAttachementForUsers:dataset.sitoolsAttachementForUsers});},addShowDefinition:function(node,dataset){node.appendChild({text:i18n.get('label.definitionTitle'),winTitle:i18n.get('label.definitionTitle')+&quot; : &quot;+dataset.name,leaf:true,type:&quot;defi&quot;,datasetId:dataset.id,columnModel:dataset.columnModel,datasetName:dataset.name,dictionaryMappings:dataset.dictionaryMappings,icon:loadUrl.get('APP_URL')+&quot;/common/res/images/icons/tree_dictionary.png&quot;});},addOpensearch:function(node,dataset){node.appendChild({text:i18n.get('label.opensearch'),winTitle:i18n.get('label.opensearch')+&quot; : &quot;+dataset.name,leaf:true,type:&quot;openSearch&quot;,datasetId:dataset.id,columnModel:dataset.columnModel,datasetName:dataset.name,dataUrl:dataset.sitoolsAttachementForUsers,icon:loadUrl.get('APP_URL')+&quot;/common/res/images/icons/toolbar_open_search.png&quot;});},addForm:function(node,dataset){node.appendChild({text:i18n.get('label.forms'),leaf:false,children:[{leaf:true}],datasetId:dataset.id,columnModel:dataset.columnModel,datasetName:dataset.name,listeners:{scope:this,beforeexpand:function(node){var conn=new Ext.data.Connection();conn.request({url:dataset.sitoolsAttachementForUsers+'/forms?media=json',success:function(response){node.removeAll(true);var forms=Ext.decode(response.responseText);if(!forms.success){Ext.msg.alert(i18n.get('label.warning'),forms.message);return;}
Ext.each(forms.data,function(form){node.appendChild({leaf:true,winTitle:i18n.get('label.forms')+&quot; : &quot;+dataset.name+&quot;.&quot;+form.name,dataset:dataset,datasetId:dataset.id,columnModel:dataset.columnModel,datasetName:dataset.name,dataUrl:dataset.sitoolsAttachementForUsers,type:&quot;form&quot;,text:form.name,formId:form.id,formName:form.name,formParameters:form.parameters,formWidth:form.width,formHeight:form.height,formCss:form.css,node:this,icon:loadUrl.get('APP_URL')+&quot;/common/res/images/icons/tree_forms.png&quot;,datasetView:dataset.datasetView});});}});}}});},addFeeds:function(node,dataset){node.appendChild({text:i18n.get('label.feeds'),leaf:false,children:[{leaf:true}],datasetId:dataset.id,datasetName:dataset.name,listeners:{scope:this,beforeexpand:function(node){var conn=new Ext.data.Connection();conn.request({url:dataset.sitoolsAttachementForUsers+'/feeds?media=json',success:function(response){node.removeAll(true);var feeds=Ext.decode(response.responseText);if(!feeds.success){Ext.msg.alert(i18n.get('label.warning'),feeds.message);return;}
Ext.each(feeds.data,function(feed){node.appendChild({leaf:true,winTitle:i18n.get('label.feeds')+&quot; : &quot;+dataset.name+&quot;.&quot;+feed.title,type:&quot;feeds&quot;,text:feed.name,datasetId:dataset.id,feedId:feed.name,dataUrl:dataset.sitoolsAttachementForUsers,feedType:feed.feedType,feedSource:feed.feedSource,datasetName:dataset.name,icon:loadUrl.get('APP_URL')+&quot;/common/res/images/icons/rss.png&quot;});});}});}}});},treeAction:function(node){var desktop=getDesktop();var win=desktop.getWindow(&quot;wind&quot;+node.id);if(!win){var componentCfg,javascriptObject;var windowConfig={datasetId:node.attributes.datasetId,title:node.attributes.winTitle,datasetName:node.attributes.datasetName,datasetDescription:node.attributes.datasetDescription,type:node.attributes.type,saveToolbar:true,toolbarItems:[]};if(node.attributes.type===&quot;data&quot;){javascriptObject=eval(SitoolsDesk.navProfile.getDatasetOpenMode(node.attributes));Ext.apply(windowConfig,{winWidth:900,winHeight:400,iconCls:&quot;dataviews&quot;});componentCfg={dataUrl:node.attributes.dataUrl,datasetId:node.attributes.datasetId,datasetCm:node.attributes.columnModel,datasetName:node.attributes.datasetName,dictionaryMappings:node.attributes.dictionaryMappings,datasetViewConfig:node.attributes.datasetViewConfig,preferencesPath:&quot;/&quot;+node.attributes.datasetName,preferencesFileName:&quot;datasetOverview&quot;,sitoolsAttachementForUsers:node.attributes.sitoolsAttachementForUsers};}
if(node.attributes.type===&quot;defi&quot;){javascriptObject=sitools.user.component.columnsDefinition;Ext.apply(windowConfig,{id:node.attributes.type+node.attributes.datasetId,iconCls:&quot;semantic&quot;});componentCfg={datasetId:node.attributes.datasetId,datasetCm:node.attributes.columnModel,datasetName:node.attributes.datasetName,dictionaryMappings:node.attributes.dictionaryMappings,preferencesPath:&quot;/&quot;+node.attributes.datasetName,preferencesFileName:&quot;semantic&quot;};}
if(node.attributes.type===&quot;openSearch&quot;){javascriptObject=sitools.user.component.datasetOpensearch;Ext.apply(windowConfig,{id:node.attributes.type+node.attributes.datasetId,iconCls:&quot;openSearch&quot;});componentCfg={datasetId:node.attributes.datasetId,dataUrl:node.attributes.dataUrl,datasetName:node.attributes.datasetName,preferencesPath:&quot;/&quot;+node.attributes.datasetName,preferencesFileName:&quot;openSearch&quot;};}
if(node.attributes.type===&quot;form&quot;){javascriptObject=sitools.user.component.forms.mainContainer;Ext.apply(windowConfig,{id:node.attributes.type+node.attributes.datasetId+node.attributes.formId,iconCls:&quot;forms&quot;});componentCfg={dataUrl:node.attributes.dataUrl,dataset:node.attributes.dataset,formId:node.attributes.formId,formName:node.attributes.formName,formParameters:node.attributes.formParameters,formWidth:node.attributes.formWidth,formHeight:node.attributes.formHeight,formCss:node.attributes.formCss,preferencesPath:&quot;/&quot;+node.attributes.datasetName+&quot;/forms&quot;,preferencesFileName:node.attributes.formName};}
if(node.attributes.type===&quot;feeds&quot;){javascriptObject=sitools.widget.FeedGridFlux;var url=node.attributes.dataUrl+&quot;/clientFeeds/&quot;+node.attributes.feedId;Ext.apply(windowConfig,{id:node.attributes.type+node.attributes.datasetId+node.attributes.feedId,iconCls:&quot;feedsModule&quot;});componentCfg={datasetId:node.attributes.datasetId,urlFeed:url,feedType:node.attributes.feedType,datasetName:node.attributes.datasetName,feedSource:node.attributes.feedSource,autoLoad:true};}
SitoolsDesk.addDesktopWindow(windowConfig,componentCfg,javascriptObject);}else{win.toFront();}}};Ext.ns('Ext.ux');Ext.ux.FisheyeMenu=Ext.extend(Ext.util.Observable,{items:[],renderTo:document.body,itemWidth:50,vicinity:35,hAlign:'center',vAlign:'bottom',showTitle:true,constructor:function(config){Ext.apply(this,config);Ext.ux.FisheyeMenu.superclass.constructor.call(this);this.addEvents('change');this.init();},init:function(){this.el=Ext.get(this.renderTo);this.initMarkup();this.initEvents();},initMarkup:function(){this.setClass();this.el.addClass(this.wrapCls);this.containerEl=this.el.createChild({tag:'div',cls:'ux-fisheye-menu-container '+this.vAlignCls});var sId=this.el.getAttribute('id')||Ext.id();Ext.each(this.items,function(item){var sTitle=this.showTitle===true?(item.tip||item.text):'';var arr=[{tag:'span',html:item.text},{tag:'img',src:item.imagePath,alt:sTitle}];if(this.vOrient=='top'){arr=arr.reverse();}
this.containerEl.createChild({tag:'a',id:sId+'-'+item.id,cls:'ux-fisheye-menu-item '+this.vAlignCls,href:'#',onClick:&quot;javascript : &quot;+item.fct||&quot;void(0);&quot;,title:sTitle,children:arr});},this);this.menuItems=this.containerEl.select('a.ux-fisheye-menu-item');this.itemCount=this.menuItems.getCount();this.onRender();},initEvents:function(){this.menuItems.on('mouseover',this.onItemHover,this);this.menuItems.on('mouseout',this.onItemOut,this);Ext.getBody().on('mousemove',this.onItemMove,this);Ext.EventManager.on(window,'resize',this.onRender,this);this.containerEl.on('click',function(ev,t){if(t.href.slice(-1)=='#'){ev.preventDefault();}
var index=parseInt(t.id.split('-').pop(),10);this.fireEvent('change',t,index);},this,{delegate:'a'});},setClass:function(){this.vOrient=this.vAlign.toLowerCase();this.wrapCls='menu-wrap-'+this.vOrient;this.vAlignCls='menu-align-'+this.vOrient;},onItemMove:function(ev,t){var p=ev.getXY(),posX,posY,increment=0;switch(this.hAlign.toLowerCase()){case'left':posX=p[0]-this.pos[0];break;case'right':posX=p[0]-this.pos[0]-this.el.getWidth()+this.itemWidth*this.itemCount;break;default:posX=p[0]-this.pos[0]-(this.el.getWidth()-this.itemWidth*this.itemCount)/2-this.itemWidth/2;break;}
posY=Math.pow(p[1]-this.pos[1]-this.el.getHeight()/2,2);this.menuItems.each(function(item,all,index){var d=Math.sqrt(Math.pow(posX-index*this.itemWidth,2)+posY);d-=this.itemWidth/2;d=d&lt;0?0:d;d=d&gt;this.vicinity?this.vicinity:d;d=this.vicinity-d;var extraWidth=this.itemWidth*d/this.vicinity;item.setStyle({left:(this.itemWidth+3)*index+increment+'px',width:this.itemWidth+extraWidth+'px'});increment+=extraWidth;},this);this.setPosContainer(increment);},onItemHover:function(ev,t){var target=Ext.get(t);target=target.is('img')?target.up('a'):target;var itemText=target.child('span');if(itemText){itemText.show();}},onItemOut:function(ev,t){var target=Ext.get(t);target=target.is('img')?target.up('a'):target;var itemText=target.child('span');if(itemText){itemText.hide();}},onRender:function(){this.pos=this.el.getXY();this.setPosContainer(0);this.setPosMenuItems();},doAlignment:function(){var aWrapCls=['menu-wrap-top','menu-wrap-bottom'],aAlignCls=['menu-align-top','menu-align-bottom'];this.setClass();this.el.removeClass(aWrapCls).addClass(this.wrapCls);this.containerEl.removeClass(aAlignCls).addClass(this.vAlignCls);this.menuItems.each(function(item,all,index){var itemText=item.child('span');var itemTextCfg={tag:'span',html:itemText.dom.innerHTML};item.removeClass(aAlignCls).addClass(this.vAlignCls);if(this.vAlign.toLowerCase()=='top'){if(!item.last().is('span')){item.createChild(itemTextCfg);itemText.remove();}}else{if(!item.first().is('span')){item.insertFirst(itemTextCfg);itemText.remove();}}},this);},setAlign:function(cfg){var isChange=false;if(cfg.hAlign){var sHAlign=cfg.hAlign.toLowerCase();if(sHAlign!=this.hAlign.toLowerCase()){this.hAlign=sHAlign;isChange=true;}}
if(cfg.vAlign){var sVAlign=cfg.vAlign.toLowerCase();if(sVAlign!=this.vAlign.toLowerCase()){this.vAlign=sVAlign;isChange=true;}}
if(isChange){this.doAlignment();this.onRender();}},setPosContainer:function(increment){var iLeft;switch(this.hAlign.toLowerCase()){case'left':iLeft=-increment/this.itemCount;break;case'right':iLeft=(this.el.getWidth()-this.itemWidth*this.itemCount)-increment/2;break;default:iLeft=(this.el.getWidth()-this.itemWidth*this.itemCount)/2-increment/2;break;}
this.containerEl.setStyle({left:iLeft+'px',width:this.itemWidth*this.itemCount+increment+'px'});},setPosMenuItems:function(){this.menuItems.each(function(item,all,index){item.setStyle({left:(this.itemWidth+3)*index+'px',width:this.itemWidth+'px'});},this);}});Ext.ux.FisheyeMenuExtention=Ext.extend(Ext.ux.FisheyeMenu,{constructor:function(config){Ext.apply(this,config);Ext.ux.FisheyeMenuExtention.superclass.constructor.call(this);},addItem:function(item){var sId=this.el.getAttribute('id')||Ext.id();var sTitle=this.showTitle===true?(item.tip||item.text):'';var arr=[{tag:'span',html:item.text},{tag:'img',src:item.imagePath,alt:sTitle}];if(this.vOrient=='top'){arr=arr.reverse();}
this.containerEl.createChild({tag:'a',id:sId+'-'+item.id,cls:'ux-fisheye-menu-item '+this.vAlignCls,href:item.url||'#',title:sTitle,target:item.target||'_blank',onClick:&quot;javascript : &quot;+item.fct,children:arr});this.menuItems=this.containerEl.select('a.ux-fisheye-menu-item');this.itemCount=this.menuItems.getCount();this.onRender();this.menuItems.on('mouseover',this.onItemHover,this);this.menuItems.on('mouseout',this.onItemOut,this);},removeItem:function(idModule){var sId='fisheye-menu-bottom-'+idModule;menuItem=Ext.get(sId);if(!menuItem){alert('cannot find the menu item!');}else{menuItem.remove();this.menuItems=this.containerEl.select('a.ux-fisheye-menu-item');this.itemCount=this.menuItems.getCount();this.onRender();}}});Ext.namespace(&quot;Ext.ux&quot;);Ext.ux.StartMenu=Ext.extend(Ext.menu.Menu,{initComponent:function(config){Ext.ux.StartMenu.superclass.initComponent.call(this,config);var tools=this.toolItems;this.toolItems=new Ext.util.MixedCollection();if(tools){this.addTool.apply(this,tools);}},onRender:function(ct,position){Ext.ux.StartMenu.superclass.onRender.call(this,ct,position);var el=this.el.addClass('ux-start-menu');var header=el.createChild({tag:&quot;div&quot;,cls:&quot;x-window-header x-unselectable x-panel-icon &quot;+this.iconCls});this.header=header;var headerText=header.createChild({tag:&quot;span&quot;,cls:&quot;x-window-header-text&quot;});var tl=header.wrap({cls:&quot;ux-start-menu-tl&quot;});var tr=header.wrap({cls:&quot;ux-start-menu-tr&quot;});var tc=header.wrap({cls:&quot;ux-start-menu-tc&quot;});this.menuBWrap=el.createChild({tag:&quot;div&quot;,cls:&quot;x-window-body x-border-layout-ct ux-start-menu-body&quot;});var ml=this.menuBWrap.wrap({cls:&quot;ux-start-menu-ml&quot;});var mc=this.menuBWrap.wrap({cls:&quot;x-window-mc ux-start-menu-bwrap&quot;});this.menuPanel=this.menuBWrap.createChild({tag:&quot;div&quot;,cls:&quot;x-panel x-border-panel ux-start-menu-apps-panel&quot;});this.toolsPanel=this.menuBWrap.createChild({tag:&quot;div&quot;,cls:&quot;x-panel x-border-panel ux-start-menu-tools-panel&quot;});var bwrap=ml.wrap({cls:&quot;x-window-bwrap&quot;});var bc=bwrap.createChild({tag:&quot;div&quot;,cls:&quot;ux-start-menu-bc&quot;});var bl=bc.wrap({cls:&quot;ux-start-menu-bl x-panel-nofooter&quot;});var br=bc.wrap({cls:&quot;ux-start-menu-br&quot;});this.ul.appendTo(this.menuPanel);var toolsUl=this.toolsPanel.createChild({tag:&quot;ul&quot;,cls:&quot;x-menu-list&quot;});this.mon(toolsUl,'click',this.onClick,this);this.mon(toolsUl,'mouseover',this.onMouseOver,this);this.mon(toolsUl,'mouseout',this.onMouseOut,this);if(this.item){this.items.each(function(item){item.parentMenu=this;},this);}
this.toolItems.each(function(item){if(!Ext.isEmpty(item.text)){item.text=i18n.get(item.text);}
var li=document.createElement(&quot;li&quot;);li.className=&quot;x-menu-list-item&quot;;toolsUl.dom.appendChild(li);item.render(li);item.parentMenu=this;},this);this.toolsUl=toolsUl;this.menuBWrap.setStyle('position','relative');this.menuBWrap.setHeight(this.height-28);this.menuPanel.setStyle({padding:'2px',position:'absolute',overflow:'auto'});this.toolsPanel.setStyle({padding:'2px 4px 2px 2px',position:'absolute',overflow:'auto'});this.setTitle(this.title);},findTargetItem:function(e){var t=e.getTarget(&quot;.x-menu-list-item&quot;,this.ul,true);if(t&amp;&amp;t.menuItemId){if(this.items.get(t.menuItemId)){return this.items.get(t.menuItemId);}else{return this.toolItems.get(t.menuItemId);}}},show:function(el,pos,parentMenu){this.parentMenu=parentMenu;if(!this.el){this.render();}
this.fireEvent(&quot;beforeshow&quot;,this);this.showAt(this.el.getAlignToXY(el,pos||this.defaultAlign),parentMenu,false);var tPanelWidth=100;var box=this.menuBWrap.getBox();this.menuPanel.setWidth(box.width-tPanelWidth);this.menuPanel.setHeight(box.height);this.toolsPanel.setWidth(tPanelWidth);this.toolsPanel.setX(box.x+box.width-tPanelWidth);this.toolsPanel.setHeight(box.height);},addTool:function(){var a=arguments,l=a.length,item;for(var i=0;i&lt;l;i++){var el=a[i];if(el.render){item=this.addToolItem(el);}else if(typeof el==&quot;string&quot;){if(el==&quot;separator&quot;||el==&quot;-&quot;){item=this.addToolSeparator();}else{item=this.addText(el);}}else if(el.tagName||el.el){item=this.addElement(el);}else if(typeof el==&quot;object&quot;){item=this.addToolMenuItem(el);}}
return item;},addToolSeparator:function(){return this.addToolItem(new Ext.menu.Separator({itemCls:'ux-toolmenu-sep'}));},addToolItem:function(item){item.text=i18n.get(item.text);this.toolItems.add(item);if(this.ul){var li=document.createElement(&quot;li&quot;);li.className=&quot;x-menu-list-item&quot;;this.ul.dom.appendChild(li);item.render(li,this);this.delayAutoWidth();}
return item;},addToolMenuItem:function(config){if(!(config instanceof Ext.menu.Item)){if(typeof config.checked==&quot;boolean&quot;){config=new Ext.menu.CheckItem(config);}else{config=new Ext.menu.Item(config);}}
return this.addToolItem(config);},setTitle:function(title,iconCls){this.title=title;this.header.child('span').update(title);return this;}});Ext.ns(&quot;sitools.common&quot;);sitools.common._PreviewBox=Ext.extend(Ext.BoxComponent,{inited:false,defaultZIndex:13000,defaultLeft:0,defaultTop:35,hideTop:25,boxWidth:250,cloneWinMaxWidth:220,cloneWinMaxHeight:116,hideDelay:500,showDelay:500,constructor:function(){sitools.common._PreviewBox.superclass.constructor.call(this,{renderTo:document.body,cls:&quot;taskbar-previewbox&quot;,hidden:true});this.inited=false;this.hoverCount=0},createBoxElements:function(){var el=this.getEl(),box;this.boxMl=el.createChild({tag:&quot;div&quot;,cls:&quot;taskbar-previewbox-ml&quot;});this.boxMr=this.boxMl.createChild({tag:&quot;div&quot;,cls:&quot;taskbar-previewbox-mr&quot;});this.boxMc=this.boxMr.createChild({tag:&quot;div&quot;,cls:&quot;taskbar-previewbox-mc&quot;});this.arrow=el.createChild({tag:&quot;div&quot;,cls:&quot;taskbar-previewbox-arrow&quot;});box=this.boxMc;this.desc=box.createChild({tag:&quot;div&quot;,cls:&quot;taskbar-previewbox-desc&quot;});box.createChild({tag:&quot;hr&quot;});this.win=box.createChild({tag:&quot;div&quot;,cls:&quot;taskbar-previewbox-win&quot;});this.inited=true;},showBox:function(boxConfig){if(!this.isEnabled()){return}
this.needShowBox=true;this.hoverCount+=1;this.doShowBox.defer(300,this,[boxConfig,this.hoverCount]);},doShowBox:function(boxConfig,hoverCount){var win,winEl,previewBox,center;if(!boxConfig||!boxConfig.win||!boxConfig.centerX){return;}
if(this.hoverCount!==hoverCount){return;}
if(!this.needShowBox){return;}
if(!this.inited){this.createBoxElements()}
center=Ext.isNumber(boxConfig.centerX)?boxConfig.centerX:this.defaultLeft;win=boxConfig.win;winEl=win.getEl();this.desc.update(boxConfig.win.title);if(this.clonedEl){this.clonedEl.remove()}
this.clonedEl=this.getClonedEl(win);this.clonedEl.show();this.win.appendChild(this.clonedEl);previewBox=this.getEl();var top=Ext.get(&quot;ux-taskbar&quot;).getTop()-previewBox.getHeight()-10;if(this.isVisible()){previewBox.setTop(top);this.show();previewBox.shift({left:center-(this.boxWidth/2),opacity:1,duration:0.3})}else{previewBox.setLeftTop(center-(this.boxWidth/2),top-200);previewBox.setOpacity(0);this.show();top=Ext.get(&quot;ux-taskbar&quot;).getTop()-previewBox.getHeight()-10;previewBox.shift({top:top,opacity:1,duration:0.8});}
this.hoverCount=0;},hideBox:function(a){if(!this.isEnabled()){return}
this.needShowBox=false;(function(){if(this.needShowBox){return}
this.doHideBox(a)}).defer((a===true)?0:300,this);},doHideBox:function(b){var c;var a=function(){if(this.needShowBox){return}
this.hide();};if(this.clonedEl){this.clonedEl.remove()}
this.hoverCount=0;if(b===true){a.call(this);return}
c=this.getEl();var top=Ext.get(&quot;ux-taskbar&quot;).getTop()-c.getHeight()-20;c.shift({top:top,opacity:0,duration:0.2,scope:this,callback:a});},getClonedEl:function(win){var c=0;var h=0;var el=win.getEl();var newHtmlEl=el.dom.cloneNode(true);newHtmlEl.removeAttribute(&quot;id&quot;);var newEl=Ext.get(newHtmlEl);newEl.visibilityCls=&quot;x-hide-display&quot;;newEl._previewMask=newEl.createChild({tag:&quot;div&quot;,cls:&quot;taskbar-previewbox-win-mask&quot;});var size=el.getSize();if(size.height===0&amp;&amp;size.width===0){size=SitoolsDesk.getDesktop().getDesktopEl().getSize();}
var d=this.cloneWinMaxWidth/size.width;c=(this.cloneWinMaxHeight-size.height*d)/2;if((size.height*d)&gt;this.cloneWinMaxHeight){d=this.cloneWinMaxHeight/size.height;c=0;h=(this.cloneWinMaxWidth-size.width*d)/2}
d=Math.min(d,1);newEl.addClass(&quot;taskbar-previewbox-win-transform&quot;);newEl.setStyle(&quot;-webkit-transform&quot;,String.format(&quot;scale({0})&quot;,d));newEl.setStyle(&quot;-moz-transform&quot;,String.format(&quot;scale({0})&quot;,d));newEl.setStyle(&quot;-o-transform&quot;,String.format(&quot;scale({0})&quot;,d));newEl.setStyle(&quot;transform&quot;,String.format(&quot;scale({0})&quot;,d));newEl.setLeftTop(h,c);return newEl;},isEnabled:function(){return true;}});Ext.ux.TaskBar=function(app,enableWarning){this.app=app;this.init(enableWarning);};Ext.extend(Ext.ux.TaskBar,Ext.util.Observable,{init:function(enableWarning){this.staticButtonPanel=new Ext.ux.TaskButtonsPanel({el:'ux-staticbuttons-panel',id:'TaskBarStaticButtons',region:'center',style:'overflow:hidden !important; height: 30px; width: 100% !important;',listeners:{addNewWindow:function(){this.items[0].action=&quot;minimize&quot;;}}});this.tbPanel=new Ext.ux.TaskButtonsPanel({el:'ux-taskbuttons-panel',id:'TaskBarButtons',region:'center',style:'overflow:hidden !important',enableWarning:enableWarning});var container=new Ext.ux.TaskBarContainer({el:'ux-taskbar',layout:'border',items:[this.staticButtonPanel,this.tbPanel]});return this;},addTaskButton:function(win){var btn=this.tbPanel.addButton(win,'ux-taskbuttons-panel');this.setActiveButton(btn);return btn;this.staticButtonPanel.fireEvent(&quot;addNewWindow&quot;);},removeTaskButton:function(btn){this.tbPanel.removeButton(btn);},setActiveButton:function(btn){this.tbPanel.setActiveButton(btn);},getActiveButton:function(){return this.tbPanel.getActiveButton();},getPreviousBtn:function(btn){return this.tbPanel.getPreviousBtn(btn);},getNextBtn:function(btn){return this.tbPanel.getNextBtn(btn);},getAllTaskButtons:function(){return this.tbPanel.items;},setEnableWarning:function(enableWarning){this.tbPanel.enableWarning=enableWarning;}});Ext.ux.TaskBarContainer=Ext.extend(Ext.Container,{initComponent:function(){Ext.ux.TaskBarContainer.superclass.initComponent.call(this);this.el=Ext.get(this.el)||Ext.getBody();this.el.setHeight=Ext.emptyFn;this.el.setWidth=Ext.emptyFn;this.el.setSize=Ext.emptyFn;this.el.setStyle({overflow:'hidden',margin:'0',border:'0 none'});this.el.dom.scroll='no';this.allowDomMove=false;this.autoWidth=true;this.autoHeight=true;Ext.EventManager.onWindowResize(this.fireResize,this);this.renderTo=this.el;this.listeners={maximizeDesktop:this.onMaximizeDesktop}},fireResize:function(w,h){this.onResize(w,h,w,h);this.fireEvent('resize',this,w,h,w,h);},onMaximizeDesktop:function(){console.log('max');}});Ext.ux.TaskButtonsPanel=Ext.extend(Ext.BoxComponent,{activeButton:null,enableScroll:true,scrollIncrement:0,scrollRepeatInterval:400,scrollDuration:.35,animScroll:true,resizeButtons:false,buttonWidth:168,minButtonWidth:118,buttonMargin:2,buttonWidthSet:false,initComponent:function(){Ext.ux.TaskButtonsPanel.superclass.initComponent.call(this);this.on('resize',this.delegateUpdates);this.items=[];this.stripWrap=Ext.get(this.el).createChild({cls:'ux-taskbuttons-strip-wrap',cn:{tag:'ul',cls:'ux-taskbuttons-strip'}});this.stripSpacer=Ext.get(this.el).createChild({cls:'ux-taskbuttons-strip-spacer'});this.strip=new Ext.Element(this.stripWrap.dom.firstChild);this.edge=this.strip.createChild({tag:'li',cls:'ux-taskbuttons-edge'});this.strip.createChild({cls:'x-clear'});if(this.enableWarning){this.warningCt=this.edge.createChild({tag:'div',cls:&quot;ux-taskbar-warningCt&quot;});}},addButton:function(win){var li=this.strip.createChild({tag:'li'},this.edge);var btn=new Ext.ux.TaskBar.TaskButton(win,li);this.items.push(btn);if(!this.buttonWidthSet){this.lastButtonWidth=btn.container.getWidth();}
this.setActiveButton(btn);return btn;},addStaticButton:function(button){var li=this.strip.createChild({tag:'li'},this.edge);button.render(li);this.items.push(button);},removeButton:function(btn){var li=document.getElementById(btn.container.id);Ext.fly(li).ghost('b',{duration:.5,remove:true,callback:function(){btn.destroy();}});var s=[];for(var i=0,len=this.items.length;i&lt;len;i++){if(this.items[i]!=btn){s.push(this.items[i]);}}
this.items=s;this.delegateUpdates();},setActiveButton:function(btn){if(this.activeButton){Ext.fly(this.activeButton.el).removeClass('active-win');}
Ext.fly(btn.el).addClass('active-win');this.activeButton=btn;this.delegateUpdates();},getActiveButton:function(){return this.activeButton;},getNextBtn:function(btn){var result;try{for(var i=0,len=this.items.length;i&lt;len;i++){if(this.items[i]==btn){result=this.items[i+1];}}
return result;}
catch(err){return null;}},getPreviousBtn:function(btn){var result;try{for(var i=0,len=this.items.length;i&lt;len;i++){if(this.items[i]==btn){result=this.items[i-1];}}
return result;}
catch(err){return null;}},delegateUpdates:function(){if(this.resizeButtons&amp;&amp;this.rendered){this.autoSize();}
if(this.enableScroll&amp;&amp;this.rendered){this.autoScroll();}
if(this.enableWarning){if(this.items.length&gt;10){this.removeButton(this.items[0]);}
if(this.items.length==10){this.warningCt.addClass('x-warning');this.warningTT=new Ext.ToolTip({target:this.warningCt,width:200,anchor:&quot;bottom&quot;,cls:&quot;x-form-invalid-tip&quot;,html:i18n.get('label.tooManyPanelsOpened'),dismissDelay:5000});}
else{if(this.warningTT){this.warningTT.destroy();}
this.warningCt.removeClass(&quot;x-warning&quot;);}}},autoSize:function(){var count=this.items.length;var ow=this.el.dom.offsetWidth;var aw=this.el.dom.clientWidth;if(!this.resizeButtons||count&lt;1||!aw){return;}
var each=Math.max(Math.min(Math.floor((aw-4)/count)-this.buttonMargin,this.buttonWidth),this.minButtonWidth);var btns=this.stripWrap.dom.getElementsByTagName('button');this.lastButtonWidth=Ext.get(btns[0].id).findParent('li').offsetWidth;for(var i=0,len=btns.length;i&lt;len;i++){var btn=btns[i];var tw=Ext.get(btns[i].id).findParent('li').offsetWidth;var iw=btn.offsetWidth;btn.style.width=(each-(tw-iw))+'px';}},autoScroll:function(){var count=this.items.length;var ow=this.el.dom.offsetWidth;var tw=this.el.dom.clientWidth;var wrap=this.stripWrap;var cw=wrap.dom.offsetWidth;var pos=this.getScrollPos();var l=this.edge.getOffsetsTo(this.stripWrap)[0]+pos;if(!this.enableScroll||count&lt;1||cw&lt;20){return;}
wrap.setWidth(tw);if(l&lt;=tw){wrap.dom.scrollLeft=0;if(this.scrolling){this.scrolling=false;this.el.removeClass('x-taskbuttons-scrolling');this.scrollLeft.hide();this.scrollRight.hide();}}else{if(!this.scrolling){this.el.addClass('x-taskbuttons-scrolling');}
tw-=wrap.getMargins('lr');wrap.setWidth(tw&gt;20?tw:20);if(!this.scrolling){if(!this.scrollLeft){this.createScrollers();}else{this.scrollLeft.show();this.scrollRight.show();}}
this.scrolling=true;if(pos&gt;(l-tw)){wrap.dom.scrollLeft=l-tw;}else{this.scrollToButton(this.activeButton,true);}
this.updateScrollButtons();}},createScrollers:function(){var h=this.el.dom.offsetHeight;var sl=this.el.insertFirst({cls:'ux-taskbuttons-scroller-left'});sl.setHeight(h);sl.addClassOnOver('ux-taskbuttons-scroller-left-over');this.leftRepeater=new Ext.util.ClickRepeater(sl,{interval:this.scrollRepeatInterval,handler:this.onScrollLeft,scope:this});this.scrollLeft=sl;var sr=this.el.insertFirst({cls:'ux-taskbuttons-scroller-right'});sr.setHeight(h);sr.addClassOnOver('ux-taskbuttons-scroller-right-over');this.rightRepeater=new Ext.util.ClickRepeater(sr,{interval:this.scrollRepeatInterval,handler:this.onScrollRight,scope:this});this.scrollRight=sr;},getScrollWidth:function(){return this.edge.getOffsetsTo(this.stripWrap)[0]+this.getScrollPos();},getScrollPos:function(){return parseInt(this.stripWrap.dom.scrollLeft,10)||0;},getScrollArea:function(){return parseInt(this.stripWrap.dom.clientWidth,10)||0;},getScrollAnim:function(){return{duration:this.scrollDuration,callback:this.updateScrollButtons,scope:this};},getScrollIncrement:function(){return(this.scrollIncrement||this.lastButtonWidth+2);},scrollToButton:function(item,animate){item=item.el.dom.parentNode;if(!item){return;}
var el=item;var pos=this.getScrollPos(),area=this.getScrollArea();var left=Ext.fly(el).getOffsetsTo(this.stripWrap)[0]+pos;var right=left+el.offsetWidth;if(left&lt;pos){this.scrollTo(left,animate);}else if(right&gt;(pos+area)){this.scrollTo(right-area,animate);}},scrollTo:function(pos,animate){this.stripWrap.scrollTo('left',pos,animate?this.getScrollAnim():false);if(!animate){this.updateScrollButtons();}},onScrollRight:function(){var sw=this.getScrollWidth()-this.getScrollArea();var pos=this.getScrollPos();var s=Math.min(sw,pos+this.getScrollIncrement());if(s!=pos){this.scrollTo(s,this.animScroll);}},onScrollLeft:function(){var pos=this.getScrollPos();var s=Math.max(0,pos-this.getScrollIncrement());if(s!=pos){this.scrollTo(s,this.animScroll);}},updateScrollButtons:function(){var pos=this.getScrollPos();this.scrollLeft[pos===0?'addClass':'removeClass']('ux-taskbuttons-scroller-left-disabled');this.scrollRight[pos&gt;=(this.getScrollWidth()-this.getScrollArea())?'addClass':'removeClass']
('ux-taskbuttons-scroller-right-disabled');}});Ext.ux.TaskBar.TaskButton=function(win,el){this.win=win;Ext.ux.TaskBar.TaskButton.superclass.constructor.call(this,{iconCls:win.iconCls,renderTo:el,handler:function(btn){SitoolsDesk.navProfile.taskbar.handleTaskButton.call(this,btn);},template:new Ext.Template('&lt;table cellspacing=&quot;0&quot; class=&quot;x-btn {3}&quot;&gt;&lt;tbody&gt;&lt;tr&gt;','&lt;td class=&quot;ux-taskbutton-center&quot;&gt;&lt;em class=&quot;{5} unselectable=&quot;on&quot;&gt;','&lt;button class=&quot;x-btn-text {2}&quot; type=&quot;{1}&quot; style=&quot;height:28px;&quot;&gt;{0}&lt;/button&gt;','&lt;/em&gt;&lt;/td&gt;',&quot;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&quot;)});};Ext.extend(Ext.ux.TaskBar.TaskButton,Ext.Button,{scale:&quot;medium&quot;,width:50,initButtonEl:function(){Ext.ux.TaskBar.TaskButton.superclass.initButtonEl.apply(this,arguments);this.mon(this.el,&quot;mouseover&quot;,this.onMouseOverHandler,this);this.mon(this.el,&quot;mouseout&quot;,this.onMouseOutHandler,this);},onRender:function(){Ext.ux.TaskBar.TaskButton.superclass.onRender.apply(this,arguments);this.cmenu=new Ext.menu.Menu({items:SitoolsDesk.navProfile.taskbar.getContextMenuItems.call(this)});this.cmenu.on('beforeshow',function(){SitoolsDesk.navProfile.taskbar.beforeShowCtxMenu.call(this);},this);this.el.on('contextmenu',function(e){e.stopEvent();if(!this.cmenu.el){this.cmenu.render();}
var xy=e.getXY();xy[1]-=this.cmenu.el.getHeight();this.cmenu.showAt(xy);},this);},onMouseOverHandler:function(d){if(this.state===&quot;normal&quot;){return;}
var ca=this.container.getAlignToXY(this.container,&quot;?&quot;);var cw=this.container.getWidth();var boxConfig={win:this.win,centerX:ca[0]+(cw/2)};sitools.PreviewBox.showBox(boxConfig);},onMouseOutHandler:function(a){sitools.PreviewBox.hideBox();},closeWin:function(cMenu,e,win){SitoolsDesk.navProfile.taskbar.closeWin.call(this,cMenu,e,win);}});Ext.Desktop=function(app){this.taskbar=new Ext.ux.TaskBar(app,true);this.xTickSize=this.yTickSize=1;var taskbar=this.taskbar;var desktopEl=Ext.get('x-desktop');var bureauEl=Ext.get('bureau');var topEl=Ext.get('toppanel');var taskbarEl=Ext.get('ux-taskbar');var shortcuts=Ext.get('x-shortcuts');var windowsGroup=new Ext.WindowGroup({nbWin:function(){return this.accessList.length;}});var activeWindow;function minimizeWin(win){win.minimized=true;win.hide(win.taskButton.getEl());}
function markActive(win){if(activeWindow&amp;&amp;activeWindow!=win){markInactive(activeWindow);}
taskbar.setActiveButton(win.taskButton);activeWindow=win;Ext.fly(win.taskButton.el).addClass('active-win');win.minimized=false;}
function markInactive(win){if(win==activeWindow){activeWindow=null;Ext.fly(win.taskButton.el).removeClass('active-win');}}
function layout(){var el=Ext.get(&quot;x-main&quot;);var enteteEl=SitoolsDesk.getEnteteEl();var bottom=SitoolsDesk.getBottomEl();try{el.setHeight(Ext.getBody().getHeight()-enteteEl.getHeight()-bottom.getHeight())
desktopEl.setHeight(Ext.get(&quot;x-desktop-taskbar&quot;).getHeight()-taskbarEl.getHeight());}
catch(err){return;}}
function removeWin(win){taskbar.removeTaskButton(win.taskButton);layout();}
Ext.EventManager.onWindowResize(layout);this.layout=layout;this.createWindow=function(config,cls){var win=new(cls||Ext.ux.stateFullWindow)(Ext.applyIf(config||{},{renderTo:desktopEl,constrain:true,constrainHeader:true,draggable:true,manager:windowsGroup,minimizable:true,maximizable:true,listeners:{show:function(win){var size=win.getSize();size.width=size.width-1;win.setSize(size);win.doLayout();}},cfgWindow:config.cfgWindow}));win.dd.xTickSize=this.xTickSize;win.dd.yTickSize=this.yTickSize;win.resizer.widthIncrement=this.xTickSize;win.resizer.heightIncrement=this.yTickSize;win.resizer.constrainTo=desktopEl;win.show();win.setPagePosition(config.xPos,config.yPos);win.taskButton=taskbar.addTaskButton(win);win.cmenu=new Ext.menu.Menu({items:[]});win.on({'activate':{fn:markActive},'beforeshow':{fn:markActive},'deactivate':{fn:markInactive},'minimize':{fn:minimizeWin},'close':{fn:removeWin}});layout();return win;};this.createPanel=function(config,cls){var panel=new(cls||Ext.Panel)(Ext.applyIf(config||{},{renderTo:desktopEl}));panel.taskButton=taskbar.addTaskButton(panel);panel.on({'activate':{fn:markActive},'beforeshow':{fn:markActive},'deactivate':{fn:markInactive}});layout();return panel;};this.getManager=function(){return windowsGroup;};this.getWindow=function(id){return windowsGroup.get(id);};this.getWinWidth=function(){var width=Ext.lib.Dom.getViewWidth();return width&lt;200?200:width;};this.getWinHeight=function(){var height=(Ext.lib.Dom.getViewHeight()-taskbarEl.getHeight());return height&lt;100?100:height;};this.getWinX=function(width){return(Ext.lib.Dom.getViewWidth()-width)/2;};this.getWinY=function(height){return(Ext.lib.Dom.getViewHeight()-taskbarEl.getHeight()-height)/2;};this.setTickSize=function(xTickSize,yTickSize){this.xTickSize=xTickSize;if(arguments.length==1){this.yTickSize=xTickSize;}else{this.yTickSize=yTickSize;}
windowsGroup.each(function(win){win.dd.xTickSize=this.xTickSize;win.dd.yTickSize=this.yTickSize;win.resizer.widthIncrement=this.xTickSize;win.resizer.heightIncrement=this.yTickSize;},this);};this.maximize=function(){SitoolsDesk.getEnteteComp().fireEvent(&quot;maximizeDesktop&quot;);SitoolsDesk.getBottomComp().fireEvent(&quot;maximizeDesktop&quot;);Ext.DomQuery.select(&quot;div[stype=freeDiv]&quot;).each(function(freeDiv){freeDiv.style.height=&quot;0px&quot;;freeDiv.style.width=&quot;0px&quot;;});SitoolsDesk.app.getModulesInDiv().each(function(moduleInDiv){moduleInDiv.fireEvent(&quot;maximizeDesktop&quot;,moduleInDiv);});this.getDesktopAndTaskBarEl().setHeight(Ext.getBody().getHeight()-SitoolsDesk.getEnteteEl().getHeight());this.getDesktopAndTaskBarEl().setWidth(Ext.getBody().getWidth());this.getDesktopEl().setHeight(Ext.getBody().getHeight()-SitoolsDesk.getEnteteEl().getHeight()-taskbarEl.getHeight());this.getDesktopEl().setWidth(Ext.getBody().getWidth());if(SitoolsDesk.getDesktop().activePanel){SitoolsDesk.getDesktop().activePanel.fireEvent(&quot;resizeDesktop&quot;,SitoolsDesk.getDesktop().activePanel);}
this.getManager().each(function(win){if(win.maximized){win.fitContainer();}});SitoolsDesk.getDesktop().taskbar.tbPanel.ownerCt.doLayout()}
this.minimize=function(){SitoolsDesk.getEnteteComp().fireEvent(&quot;minimizeDesktop&quot;);SitoolsDesk.getBottomComp().fireEvent(&quot;minimizeDesktop&quot;);SitoolsDesk.app.getModulesInDiv().each(function(moduleInDiv){moduleInDiv.fireEvent(&quot;minimizeDesktop&quot;,moduleInDiv);});Ext.DomQuery.select(&quot;div[stype=freeDiv]&quot;).each(function(freeDiv){freeDiv.style.height=&quot;&quot;;freeDiv.style.width=&quot;&quot;;});this.getDesktopAndTaskBarEl().dom.style.height=&quot;&quot;;this.getDesktopAndTaskBarEl().dom.style.width=&quot;&quot;;this.getDesktopEl().setWidth(&quot;&quot;);layout();if(SitoolsDesk.getDesktop().activePanel){SitoolsDesk.getDesktop().activePanel.fireEvent(&quot;resizeDesktop&quot;,SitoolsDesk.getDesktop().activePanel);}
this.getManager().each(function(win){if(win.maximized){win.fitContainer();}});SitoolsDesk.getDesktop().taskbar.tbPanel.ownerCt.doLayout()}
this.cascade=function(){var x=0,y=0;windowsGroup.each(function(win){if(win.isVisible()&amp;&amp;!win.maximized){win.setPosition(x,y);x+=20;y+=20;}},this);};this.tile=function(){var availWidth=desktopEl.getWidth(true);var x=this.xTickSize;var y=this.yTickSize;var nextY=y;windowsGroup.each(function(win){if(win.isVisible()&amp;&amp;!win.maximized){var w=win.el.getWidth();if((x&gt;this.xTickSize)&amp;&amp;(x+w&gt;availWidth)){x=this.xTickSize;y=nextY;}
win.setPosition(x,y);x+=w+this.xTickSize;nextY=Math.max(nextY,y+win.el.getHeight()+this.yTickSize);}},this);};this.contextMenu=new Ext.menu.Menu({items:[{text:'Tile',handler:this.tile,scope:this,icon:loadUrl.get('APP_URL')+&quot;/res/images/icons/presentation2.png&quot;},{text:'Cascade',handler:this.cascade,scope:this,icon:loadUrl.get('APP_URL')+&quot;/res/images/icons/presentation1.png&quot;}]});desktopEl.on('contextmenu',function(e){if(e.target.id==&quot;x-desktop&quot;){e.stopEvent();this.contextMenu.showAt(e.getXY());}},this);layout();if(shortcuts){shortcuts.on('click',function(e,t){if(t=e.getTarget('dt',shortcuts)){e.stopEvent();var module=app.getModule(t.id.replace('-shortcut',''));if(module){module.openModule();}}});}
this.getDesktopEl=function(){return Ext.get('x-desktop');}
this.getDesktopAndTaskBarEl=function(){return Ext.get('x-desktop-taskbar');}};Ext.app.App=function(cfg){Ext.apply(this,cfg);this.addEvents({'ready':true,'beforeunload':true});};Ext.extend(Ext.app.App,Ext.util.Observable,{isReady:false,modules:[],modulesInDiv:[],fisheye:null,getStartConfig:function(){},initApp:function(){this.desktop=new Ext.Desktop(this);sitools.PreviewBox=new sitools.common._PreviewBox();this.init();Ext.EventManager.on(window,'beforeunload',this.onUnload,this);this.isReady=true;},getModules:Ext.emptyFn,getModulesInDiv:Ext.emptyFn,init:Ext.emptyFn,initModules:function(ms){this.modules=ms;for(var i=0,len=ms.length;i&lt;len;i++){var m=ms[i];this.launcher.add(m.launcher);m.app=this;}
this.isReady=true;},addModule:function(module){this.launcher.add(module.launcher);this.fisheye.addItem(module.fisheye);module.app=this;},removeModule:function(moduleToRemove){this.launcher.remove(moduleToRemove.id);this.fisheye.removeItem(moduleToRemove.fisheye.id);this.modules.remove(moduleToRemove);},getModule:function(name){var ms=this.modules;if(!Ext.isEmpty(ms)){for(var i=0,len=ms.length;i&lt;len;i++){if(ms[i].id==name||ms[i].appType==name){return ms[i];}}}
return'';},getDesktop:function(){return this.desktop;},getFisheyeMenu:function(){return this.fisheye;},onUnload:function(e){if(this.fireEvent('beforeunload',this)===false){e.stopEvent();}},showSpinner:function(){Ext.getBody().mask(&quot;loading...&quot;,&quot;x-mask-loading&quot;);},hideSpinner:function(){if(Ext.getBody().isMasked()){Ext.getBody().unmask();}}});Ext.app.Module=function(config){Ext.apply(this,config);Ext.app.Module.superclass.constructor.call(this);this.init();};Ext.extend(Ext.app.Module,Ext.util.Observable,{init:Ext.emptyFn});Ext.ns('Ext.ux.grid');Ext.ux.grid.CheckColumn=function(config){Ext.apply(this,config);if(!this.id){this.id=Ext.id();}
this.renderer=this.renderer.createDelegate(this);};Ext.ux.grid.CheckColumn=Ext.extend(Ext.Component,{enabled:true,init:function(grid){this.grid=grid;this.grid.on('render',function(){var view=this.grid.getView();view.mainBody.on('mousedown',this.onMouseDown,this);},this);},onMouseDown:function(e,t){if(Ext.fly(t).hasClass(this.createId())&amp;&amp;Ext.fly(t).hasClass(&quot;x-grid3-check-col-enabled&quot;)){e.stopEvent();var index=this.grid.getView().findRowIndex(t);var record=this.grid.store.getAt(index);record.set(this.dataIndex,!record.data[this.dataIndex]);}},renderer:function(v,p,record){p.css+=' x-grid3-check-col-td';var cmp=Ext.getCmp(this.id);if(cmp.enabled){return String.format('&lt;div id=&quot;{2}&quot; class=&quot;x-grid3-check-col{0} x-grid3-check-col-enabled {1}&quot;&gt;&amp;#160;&lt;/div&gt;',v?'-on':'',cmp.createId(),this.id);}
else{return String.format('&lt;div id=&quot;{2}&quot; class=&quot;x-grid3-check-disabled-col{0} {1}&quot;&gt;&amp;#160;&lt;/div&gt;',v?'-on':'',cmp.createId(),this.id);}},createId:function(){return'x-grid3-cc-'+this.id;},getEnabled:function(){return this.enabled;},setEnabled:function(value){this.enabled=value;}});Ext.preg('checkcolumn',Ext.ux.grid.CheckColumn);Ext.grid.CheckColumn=Ext.ux.grid.CheckColumn;Ext.namespace('sitools.siteMap');var loadUrl={map:[],load:function(url,callback,scope){var siteMapRef=this;siteMapRef.transformsPropertiesToMap(url,callback,scope);},transformsPropertiesToMap:function(url,callback,scope){var store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:url,restful:true}),reader:new Ext.data.XmlReader({record:'url'},[{name:'name',mapping:'name'},{name:'loc',mapping:'loc'}])});var localMap=this.map;store.load({scope:scope,callback:function(r,options,success){var i=0;while(i!=undefined){var rec=r[i];if(rec!=undefined){var url=rec.data.loc;var name=rec.data.name;localMap[name]=url;i++;}else{i=undefined;}}
callback.call(this);}});},get:function(entry){return!Ext.isEmpty(this.map[entry])?this.map[entry]:entry;}};var componentManager={loadedComponents:[],load:function(name){}};var data={ret:null,get:function(url,cbk){Ext.Ajax.request({method:'GET',url:url,success:function(response,opts){cbk(Ext.decode(response.responseText));},failure:function(response,opts){Ext.Msg.alert(&quot;Warning&quot;,&quot;Error! Can't get data with url :&quot;+url);}});return this.ret;}};Ext.applyIf(Array.prototype,{clone:function(){return[].concat(this);}});Ext.ux.sitoolsGridView=Ext.extend(Ext.grid.GridView,{beforeColMenuShow:function(){var cm=this.cm,colCount=cm.getColumnCount();this.colMenu.removeAll();for(var i=0;i&lt;colCount;i++){if(cm.config[i].hideable!==false){this.colMenu.add(new Ext.menu.CheckItem({itemId:'col-'+cm.getColumnId(i),text:cm.getColumnHeader(i),checked:!cm.isHidden(i),hideOnClick:false,disabled:cm.config[i].hideable===false,listeners:{scope:this,checkchange:function(ci,checked){if(checked){var colModel=extColModelToSrv(this.cm);this.grid.getStore().load({params:{colModel:Ext.util.JSON.encode(colModel)}});}}}}));}}},doRender:function(columns,records,store,startRow,colCount,stripe){var templates=this.templates,cellTemplate=templates.cell,rowTemplate=templates.row,last=colCount-1;var tstyle='width:'+this.getTotalWidth()+';';var rowBuffer=[],colBuffer=[],rowParams={tstyle:tstyle},meta={},column,record;for(var j=0,len=records.length;j&lt;len;j++){record=records[j];colBuffer=[];var rowIndex=j+startRow;for(var i=0;i&lt;colCount;i++){column=columns[i];meta.id=column.id;meta.css=i===0?'x-grid3-cell-first ':(i==last?'x-grid3-cell-last ':'');meta.attr=meta.cellAttr='';meta.style=column.style;meta.value=column.renderer.call(column.scope,record.data[column.name],meta,record,rowIndex,i,store);if(Ext.isEmpty(meta.value)){meta.value='&amp;#160;';}
if(this.markDirty&amp;&amp;record.dirty&amp;&amp;Ext.isDefined(record.modified[column.name])){meta.css+=' x-grid3-dirty-cell';}
colBuffer[colBuffer.length]=cellTemplate.apply(meta);}
var alt=[];if(stripe&amp;&amp;((rowIndex+1)%2===0)){alt[0]='x-grid3-row-alt';}
if(record.dirty){alt[1]=' x-grid3-dirty-row';}
rowParams.cols=colCount;if(this.getRowClass){alt[2]=this.getRowClass(record,rowIndex,rowParams,store);}
rowParams.alt=alt.join(' ');rowParams.cells=colBuffer.join('');rowBuffer[rowBuffer.length]=rowTemplate.apply(rowParams);}
if(records.length==0){var alt=[];rowParams.cols=colCount;rowParams.cells=&quot; &quot;;rowBuffer[0]=rowTemplate.apply(rowParams);}
return rowBuffer.join('');},renderRows:function(startRow,endRow){var g=this.grid,cm=g.colModel,ds=g.store,stripe=g.stripeRows;var colCount=cm.getColumnCount();var cs=this.getColumnData();startRow=startRow||0;endRow=!Ext.isDefined(endRow)?ds.getCount()-1:endRow;var rs=ds.getRange(startRow,endRow);return this.doRender(cs,rs,ds,startRow,colCount,stripe);}});var Base64={_keyStr:&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=&quot;,encode:function(input){var output=&quot;&quot;;var chr1,chr2,chr3,enc1,enc2,enc3,enc4;var i=0;input=Base64._utf8_encode(input);while(i&lt;input.length){chr1=input.charCodeAt(i++);chr2=input.charCodeAt(i++);chr3=input.charCodeAt(i++);enc1=chr1&gt;&gt;2;enc2=((chr1&amp;3)&lt;&lt;4)|(chr2&gt;&gt;4);enc3=((chr2&amp;15)&lt;&lt;2)|(chr3&gt;&gt;6);enc4=chr3&amp;63;if(isNaN(chr2)){enc3=enc4=64;}else if(isNaN(chr3)){enc4=64;}
output=output+
this._keyStr.charAt(enc1)+this._keyStr.charAt(enc2)+
this._keyStr.charAt(enc3)+this._keyStr.charAt(enc4);}
return output;},decode:function(input){var output=&quot;&quot;;var chr1,chr2,chr3;var enc1,enc2,enc3,enc4;var i=0;input=input.replace(/[^A-Za-z0-9\+\/\=]/g,&quot;&quot;);while(i&lt;input.length){enc1=this._keyStr.indexOf(input.charAt(i++));enc2=this._keyStr.indexOf(input.charAt(i++));enc3=this._keyStr.indexOf(input.charAt(i++));enc4=this._keyStr.indexOf(input.charAt(i++));chr1=(enc1&lt;&lt;2)|(enc2&gt;&gt;4);chr2=((enc2&amp;15)&lt;&lt;4)|(enc3&gt;&gt;2);chr3=((enc3&amp;3)&lt;&lt;6)|enc4;output=output+String.fromCharCode(chr1);if(enc3!=64){output=output+String.fromCharCode(chr2);}
if(enc4!=64){output=output+String.fromCharCode(chr3);}}
output=Base64._utf8_decode(output);return output;},_utf8_encode:function(string){string=string.replace(/\r\n/g,&quot;\n&quot;);var utftext=&quot;&quot;;for(var n=0;n&lt;string.length;n++){var c=string.charCodeAt(n);if(c&lt;128){utftext+=String.fromCharCode(c);}
else if((c&gt;127)&amp;&amp;(c&lt;2048)){utftext+=String.fromCharCode((c&gt;&gt;6)|192);utftext+=String.fromCharCode((c&amp;63)|128);}
else{utftext+=String.fromCharCode((c&gt;&gt;12)|224);utftext+=String.fromCharCode(((c&gt;&gt;6)&amp;63)|128);utftext+=String.fromCharCode((c&amp;63)|128);}}
return utftext;},_utf8_decode:function(utftext){var string=&quot;&quot;;var i=0;var c=c1=c2=0;while(i&lt;utftext.length){c=utftext.charCodeAt(i);if(c&lt;128){string+=String.fromCharCode(c);i++;}
else if((c&gt;191)&amp;&amp;(c&lt;224)){c2=utftext.charCodeAt(i+1);string+=String.fromCharCode(((c&amp;31)&lt;&lt;6)|(c2&amp;63));i+=2;}
else{c2=utftext.charCodeAt(i+1);c3=utftext.charCodeAt(i+2);string+=String.fromCharCode(((c&amp;15)&lt;&lt;12)|((c2&amp;63)&lt;&lt;6)|(c3&amp;63));i+=3;}}
return string;}};function array(n){for(i=0;i&lt;n;i++)this[i]=0;this.length=n;}
function integer(n){return n%(0xffffffff+1);}
function shr(a,b){a=integer(a);b=integer(b);if(a-0x80000000&gt;=0){a=a%0x80000000;a&gt;&gt;=b;a+=0x40000000&gt;&gt;(b-1);}else
a&gt;&gt;=b;return a;}
function shl1(a){a=a%0x80000000;if(a&amp;0x40000000==0x40000000)
{a-=0x40000000;a*=2;a+=0x80000000;}else
a*=2;return a;}
function shl(a,b){a=integer(a);b=integer(b);for(var i=0;i&lt;b;i++)a=shl1(a);return a;}
function and(a,b){a=integer(a);b=integer(b);var t1=(a-0x80000000);var t2=(b-0x80000000);if(t1&gt;=0)
if(t2&gt;=0)
return((t1&amp;t2)+0x80000000);else
return(t1&amp;b);else
if(t2&gt;=0)
return(a&amp;t2);else
return(a&amp;b);}
function or(a,b){a=integer(a);b=integer(b);var t1=(a-0x80000000);var t2=(b-0x80000000);if(t1&gt;=0)
if(t2&gt;=0)
return((t1|t2)+0x80000000);else
return((t1|b)+0x80000000);else
if(t2&gt;=0)
return((a|t2)+0x80000000);else
return(a|b);}
function xor(a,b){a=integer(a);b=integer(b);var t1=(a-0x80000000);var t2=(b-0x80000000);if(t1&gt;=0)
if(t2&gt;=0)
return(t1^t2);else
return((t1^b)+0x80000000);else
if(t2&gt;=0)
return((a^t2)+0x80000000);else
return(a^b);}
function not(a){a=integer(a);return(0xffffffff-a);}
var state=new array(4);var count=new array(2);count[0]=0;count[1]=0;var buffer=new array(64);var transformBuffer=new array(16);var digestBits=new array(16);var S11=7;var S12=12;var S13=17;var S14=22;var S21=5;var S22=9;var S23=14;var S24=20;var S31=4;var S32=11;var S33=16;var S34=23;var S41=6;var S42=10;var S43=15;var S44=21;function F(x,y,z){return or(and(x,y),and(not(x),z));}
function G(x,y,z){return or(and(x,z),and(y,not(z)));}
function H(x,y,z){return xor(xor(x,y),z);}
function I(x,y,z){return xor(y,or(x,not(z)));}
function rotateLeft(a,n){return or(shl(a,n),(shr(a,(32-n))));}
function FF(a,b,c,d,x,s,ac){a=a+F(b,c,d)+x+ac;a=rotateLeft(a,s);a=a+b;return a;}
function GG(a,b,c,d,x,s,ac){a=a+G(b,c,d)+x+ac;a=rotateLeft(a,s);a=a+b;return a;}
function HH(a,b,c,d,x,s,ac){a=a+H(b,c,d)+x+ac;a=rotateLeft(a,s);a=a+b;return a;}
function II(a,b,c,d,x,s,ac){a=a+I(b,c,d)+x+ac;a=rotateLeft(a,s);a=a+b;return a;}
function transform(buf,offset){var a=0,b=0,c=0,d=0;var x=transformBuffer;a=state[0];b=state[1];c=state[2];d=state[3];for(i=0;i&lt;16;i++){x[i]=and(buf[i*4+offset],0xff);for(j=1;j&lt;4;j++){x[i]+=shl(and(buf[i*4+j+offset],0xff),j*8);}}
a=FF(a,b,c,d,x[0],S11,0xd76aa478);d=FF(d,a,b,c,x[1],S12,0xe8c7b756);c=FF(c,d,a,b,x[2],S13,0x242070db);b=FF(b,c,d,a,x[3],S14,0xc1bdceee);a=FF(a,b,c,d,x[4],S11,0xf57c0faf);d=FF(d,a,b,c,x[5],S12,0x4787c62a);c=FF(c,d,a,b,x[6],S13,0xa8304613);b=FF(b,c,d,a,x[7],S14,0xfd469501);a=FF(a,b,c,d,x[8],S11,0x698098d8);d=FF(d,a,b,c,x[9],S12,0x8b44f7af);c=FF(c,d,a,b,x[10],S13,0xffff5bb1);b=FF(b,c,d,a,x[11],S14,0x895cd7be);a=FF(a,b,c,d,x[12],S11,0x6b901122);d=FF(d,a,b,c,x[13],S12,0xfd987193);c=FF(c,d,a,b,x[14],S13,0xa679438e);b=FF(b,c,d,a,x[15],S14,0x49b40821);a=GG(a,b,c,d,x[1],S21,0xf61e2562);d=GG(d,a,b,c,x[6],S22,0xc040b340);c=GG(c,d,a,b,x[11],S23,0x265e5a51);b=GG(b,c,d,a,x[0],S24,0xe9b6c7aa);a=GG(a,b,c,d,x[5],S21,0xd62f105d);d=GG(d,a,b,c,x[10],S22,0x2441453);c=GG(c,d,a,b,x[15],S23,0xd8a1e681);b=GG(b,c,d,a,x[4],S24,0xe7d3fbc8);a=GG(a,b,c,d,x[9],S21,0x21e1cde6);d=GG(d,a,b,c,x[14],S22,0xc33707d6);c=GG(c,d,a,b,x[3],S23,0xf4d50d87);b=GG(b,c,d,a,x[8],S24,0x455a14ed);a=GG(a,b,c,d,x[13],S21,0xa9e3e905);d=GG(d,a,b,c,x[2],S22,0xfcefa3f8);c=GG(c,d,a,b,x[7],S23,0x676f02d9);b=GG(b,c,d,a,x[12],S24,0x8d2a4c8a);a=HH(a,b,c,d,x[5],S31,0xfffa3942);d=HH(d,a,b,c,x[8],S32,0x8771f681);c=HH(c,d,a,b,x[11],S33,0x6d9d6122);b=HH(b,c,d,a,x[14],S34,0xfde5380c);a=HH(a,b,c,d,x[1],S31,0xa4beea44);d=HH(d,a,b,c,x[4],S32,0x4bdecfa9);c=HH(c,d,a,b,x[7],S33,0xf6bb4b60);b=HH(b,c,d,a,x[10],S34,0xbebfbc70);a=HH(a,b,c,d,x[13],S31,0x289b7ec6);d=HH(d,a,b,c,x[0],S32,0xeaa127fa);c=HH(c,d,a,b,x[3],S33,0xd4ef3085);b=HH(b,c,d,a,x[6],S34,0x4881d05);a=HH(a,b,c,d,x[9],S31,0xd9d4d039);d=HH(d,a,b,c,x[12],S32,0xe6db99e5);c=HH(c,d,a,b,x[15],S33,0x1fa27cf8);b=HH(b,c,d,a,x[2],S34,0xc4ac5665);a=II(a,b,c,d,x[0],S41,0xf4292244);d=II(d,a,b,c,x[7],S42,0x432aff97);c=II(c,d,a,b,x[14],S43,0xab9423a7);b=II(b,c,d,a,x[5],S44,0xfc93a039);a=II(a,b,c,d,x[12],S41,0x655b59c3);d=II(d,a,b,c,x[3],S42,0x8f0ccc92);c=II(c,d,a,b,x[10],S43,0xffeff47d);b=II(b,c,d,a,x[1],S44,0x85845dd1);a=II(a,b,c,d,x[8],S41,0x6fa87e4f);d=II(d,a,b,c,x[15],S42,0xfe2ce6e0);c=II(c,d,a,b,x[6],S43,0xa3014314);b=II(b,c,d,a,x[13],S44,0x4e0811a1);a=II(a,b,c,d,x[4],S41,0xf7537e82);d=II(d,a,b,c,x[11],S42,0xbd3af235);c=II(c,d,a,b,x[2],S43,0x2ad7d2bb);b=II(b,c,d,a,x[9],S44,0xeb86d391);state[0]+=a;state[1]+=b;state[2]+=c;state[3]+=d;}
function init(){count[0]=count[1]=0;state[0]=0x67452301;state[1]=0xefcdab89;state[2]=0x98badcfe;state[3]=0x10325476;for(i=0;i&lt;digestBits.length;i++)
digestBits[i]=0;}
function update(b){var index,i;index=and(shr(count[0],3),0x3f);if(count[0]&lt;0xffffffff-7)
count[0]+=8;else{count[1]++;count[0]-=0xffffffff+1;count[0]+=8;}
buffer[index]=and(b,0xff);if(index&gt;=63){transform(buffer,0);}}
function finish(){var bits=new array(8);var padding;var i=0,index=0,padLen=0;for(i=0;i&lt;4;i++){bits[i]=and(shr(count[0],(i*8)),0xff);}
for(i=0;i&lt;4;i++){bits[i+4]=and(shr(count[1],(i*8)),0xff);}
index=and(shr(count[0],3),0x3f);padLen=(index&lt;56)?(56-index):(120-index);padding=new array(64);padding[0]=0x80;for(i=0;i&lt;padLen;i++)
update(padding[i]);for(i=0;i&lt;8;i++)
update(bits[i]);for(i=0;i&lt;4;i++){for(j=0;j&lt;4;j++){digestBits[i*4+j]=and(shr(state[i],(j*8)),0xff);}}}
function hexa(n){var hexa_h=&quot;0123456789abcdef&quot;;var hexa_c=&quot;&quot;;var hexa_m=n;for(hexa_i=0;hexa_i&lt;8;hexa_i++){hexa_c=hexa_h.charAt(Math.abs(hexa_m)%16)+hexa_c;hexa_m=Math.floor(hexa_m/16);}
return hexa_c;}
var ascii=&quot;01234567890123456789012345678901&quot;+&quot; !\&quot;#$%&amp;'()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;+&quot;[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~&quot;;function MD5(message)
{var l,s,k,ka,kb,kc,kd;init();for(k=0;k&lt;message.length;k++){l=message.charAt(k);update(ascii.lastIndexOf(l));}
finish();ka=kb=kc=kd=0;for(i=0;i&lt;4;i++)ka+=shl(digestBits[15-i],(i*8));for(i=4;i&lt;8;i++)kb+=shl(digestBits[15-i],((i-4)*8));for(i=8;i&lt;12;i++)kc+=shl(digestBits[15-i],((i-8)*8));for(i=12;i&lt;16;i++)kd+=shl(digestBits[15-i],((i-12)*8));s=hexa(kd)+hexa(kc)+hexa(kb)+hexa(ka);return s;}
function Digest(config){this.url=config.url;this.usr=config.usr;this.pwd=config.pwd;this.realm=config.realm;this.algorithm=config.algorithm;this.nonce=config.nonce;this.method=config.method;this.mode=config.mode;this.A1=config.A1;this.getDigestAuth=function(){this.resetHeaders();return this.buildAuthenticationRequest();};this.getA1=function(){this.resetHeaders();return this.digest(this.usr+':'+this.realm+':'+this.pwd);};this.resetHeaders=function(){if(typeof(this.headers)!=&quot;undefined&quot;){delete this.headers;}
this.headers={'uri':this.url,'username':this.usr,'algorithm':this.algorithm,'realm':this.realm,'nonce':this.nonce};};this.digest=function(s){if(typeof(window[this.headers.algorithm])!='function'){if(typeof(window['MD5'])!='function'){alert('Votre navigateur ne supporte pas l\'authentification HTTP Digest !');return false;}else{return MD5(s);}}
return window[this.headers.algorithm](s);};this.buildResponseHash=function(){if(this.headers.salt){auth.secret=auth.secret+':'+auth.headers.salt;delete auth.headers.salt;}
if(this.headers.migrate){auth.secret=this.digest(auth.secret);}
var A1;if(Ext.isEmpty(this.A1)){A1=this.getA1();}
else{A1=this.A1;}
var A2=this.digest(this.method+':'+this.headers.uri);if(this.mode=='digest'){return this.digest(A1+&quot;:&quot;+this.headers.nonce+&quot;:&quot;+A2);}
return null;};this.buildAuthenticationRequest=function(){var request=&quot;Digest&quot;;var comma=' ';for(name in this.headers){request+=comma+name+'=&quot;'+this.headers[name]+'&quot;';comma=',';}
if(typeof(this.headers.algorithm)=='undefined'){return request;}
var r=this.buildResponseHash();if(r){request+=&quot;, response=\&quot;&quot;+r+&quot;\&quot;&quot;;return request;}
return false;};};function ann(obj,message){if(obj===true||obj===false){return;}
if(obj===undefined){cerr('Object is undefined - '+message);ctrace();return;}
if(obj===null){cerr('Object is null - '+message);ctrace();return;}
if(obj===&quot;&quot;){cerr('String seems empty - '+message);ctrace();return;}
if(obj==NaN){cerr('Object equals NaN - '+message);ctrace();return;}}
function assert(condition,message){if(!condition){cerr('Condition is not valid : '+message);ctrace();return;}}
function clog(message){if(isFirebugConsoleIsActive()){console.log(message);}}
function cerr(message){if(isFirebugConsoleIsActive()){console.trace();}}
function ctrace(){if(isFirebugConsoleIsActive()){console.trace();}}
function cdir(obj){if(isFirebugConsoleIsActive()){console.dir(obj);}}
function isFirebugConsoleIsActive(){try{if(console!==null&amp;&amp;console!==undefined)
{return true;}else{return false;}}
catch(e){return false;}}
Ext.ns(&quot;sitools.common.utils&quot;);sitools.common.utils.Date={regToday:new RegExp(&quot;^\{\\$TODAY\} *(\\+ *[0-9]*|\\- *[0-9]*)?$&quot;),timeInterval:Date.DAY,stringWithTodayToDate:function(val){if(Ext.isDate(val)){return val;}
if(!this.regToday.test(val)){return null;}
var regNbJour=new RegExp(&quot;[0-9]+&quot;,&quot;g&quot;);var regOp=new RegExp(&quot;[+]|[-]&quot;);var nbJour=parseFloat(regNbJour.exec(val));var op=regOp.exec(val);var result=new Date();if(Ext.isEmpty(nbJour)&amp;&amp;!Ext.isEmpty(op)){return null;}
if(!Ext.isEmpty(nbJour)&amp;&amp;!Ext.isEmpty(op)){if(op==&quot;-&quot;){nbJour=nbJour*-1;}
result=result.add(this.timeInterval,nbJour);}
return result;},isValidDate:function(d){if(Object.prototype.toString.call(d)!==&quot;[object Date]&quot;)
return false;return!isNaN(d.getTime());}}
function URL(url){if(url.length==0)eval('throw &quot;Invalid URL ['+url+'];');this.url=url;this.port=-1;this.query=(this.url.indexOf('?')&gt;=0)?this.url.substring(this.url.indexOf('?')+1):'';if(this.query.indexOf('#')&gt;=0)this.query=this.query.substring(0,this.query.indexOf('#'));this.protocol='';this.host='';var protocolSepIndex=this.url.indexOf('://');if(protocolSepIndex&gt;=0){this.protocol=this.url.substring(0,protocolSepIndex).toLowerCase();this.host=this.url.substring(protocolSepIndex+3);if(this.host.indexOf('/')&gt;=0)this.host=this.host.substring(0,this.host.indexOf('/'));var atIndex=this.host.indexOf('@');if(atIndex&gt;=0){var credentials=this.host.substring(0,atIndex);var colonIndex=credentials.indexOf(':');if(colonIndex&gt;=0){this.username=credentials.substring(0,colonIndex);this.password=credentials.substring(colonIndex);}else{this.username=credentials;}
this.host=this.host.substring(atIndex+1);}
var portColonIndex=this.host.indexOf(':');if(portColonIndex&gt;=0){this.port=this.host.substring(portColonIndex);this.host=this.host.substring(0,portColonIndex);}
this.file=this.url.substring(protocolSepIndex+3);this.file=this.file.substring(this.file.indexOf('/'));}else{this.file=this.url;}
if(this.file.indexOf('?')&gt;=0)this.file=this.file.substring(0,this.file.indexOf('?'));var refSepIndex=url.indexOf('#');if(refSepIndex&gt;=0){this.file=this.file.substring(0,refSepIndex);this.reference=this.url.substring(this.url.indexOf('#'));}else{this.reference='';}
this.path=this.file;if(this.query.length&gt;0)this.file+='?'+this.query;if(this.reference.length&gt;0)this.file+='#'+this.reference;this.getPort=getPort;this.getQuery=getQuery;this.getProtocol=getProtocol;this.getHost=getHost;this.getUserName=getUserName;this.getPassword=getPassword;this.getFile=getFile;this.getReference=getReference;this.getPath=getPath;this.getArgumentValue=getArgumentValue;this.getArgumentValues=getArgumentValues;this.toString=toString;function getPort(){return this.port;}
function getQuery(){return this.query;}
function getProtocol(){return this.protocol;}
function getHost(){return this.host;}
function getUserName(){return this.username;}
function getPassword(){return this.password;}
function getFile(){return this.file;}
function getReference(){return this.reference;}
function getPath(){return this.path;}
function getArgumentValue(key){var a=this.getArgumentValues();if(a.length&lt;1)return'';for(var i=0;i&lt;a.length;i++){if(a[i][0]==key)return a[i][1];}
return'';}
function getArgumentValues(){var a=new Array();var b=this.query.split('&amp;amp;');var c='';if(b.length&lt;1)return a;for(var i=0;i&lt;b.length;i++){c=b[i].split('=');a[i]=new Array(c[0],((c.length==1)?c[0]:c[1]));}
return a;}
function toString(){return this.url;}}
Ext.ns(&quot;sitools.common.utils&quot;);sitools.common.utils.Utils={arrayProperties2Object:function(array){var result={};Ext.each(array,function(item){if(!Ext.isEmpty(item.name)&amp;&amp;!Ext.isEmpty(item.value)){result[item.name]=item.value;}});return result;},syntaxHighlight:function(json){json=json.replace(/&amp;/g,'&amp;amp;').replace(/&lt;/g,'&amp;lt;').replace(/&gt;/g,'&amp;gt;');return json.replace(/(&quot;(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\&quot;])*&quot;(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,function(match){var cls='number';if(/^&quot;/.test(match)){if(/:$/.test(match)){cls='key';}else{cls='string';}}else if(/true|false/.test(match)){cls='boolean';}else if(/null/.test(match)){cls='null';}
return'&lt;span class=&quot;'+cls+'&quot;&gt;'+match+'&lt;/span&gt;';});}}
sitoolsUtils=sitools.common.utils.Utils;Ext.ux.StatusBar=Ext.extend(Ext.Toolbar,{cls:'x-statusbar',busyIconCls:'x-status-busy',busyText:'Loading...',autoClear:5000,emptyText:'&amp;nbsp;',activeThreadId:0,initComponent:function(){if(this.statusAlign=='right'){this.cls+=' x-status-right';}
Ext.ux.StatusBar.superclass.initComponent.call(this);},afterRender:function(){Ext.ux.StatusBar.superclass.afterRender.call(this);var right=this.statusAlign=='right';this.currIconCls=this.iconCls||this.defaultIconCls;this.statusEl=new Ext.Toolbar.TextItem({cls:'x-status-text '+(this.currIconCls||''),text:this.text||this.defaultText||''});if(right){this.add('-&gt;');this.add(this.statusEl);}else{this.insert(0,this.statusEl);this.insert(1,'-&gt;');}
this.doLayout();},setStatus:function(o){o=o||{};if(typeof o=='string'){o={text:o};}
if(o.text!==undefined){this.setText(o.text);}
if(o.iconCls!==undefined){this.setIcon(o.iconCls);}
if(o.clear){var c=o.clear,wait=this.autoClear,defaults={useDefaults:true,anim:true};if(typeof c=='object'){c=Ext.applyIf(c,defaults);if(c.wait){wait=c.wait;}}else if(typeof c=='number'){wait=c;c=defaults;}else if(typeof c=='boolean'){c=defaults;}
c.threadId=this.activeThreadId;this.clearStatus.defer(wait,this,[c]);}
return this;},clearStatus:function(o){o=o||{};if(o.threadId&amp;&amp;o.threadId!==this.activeThreadId){return this;}
var text=o.useDefaults?this.defaultText:this.emptyText,iconCls=o.useDefaults?(this.defaultIconCls?this.defaultIconCls:''):'';if(o.anim){this.statusEl.el.fadeOut({remove:false,useDisplay:true,scope:this,callback:function(){this.setStatus({text:text,iconCls:iconCls});this.statusEl.el.show();}});}else{this.statusEl.hide();this.setStatus({text:text,iconCls:iconCls});this.statusEl.show();}
return this;},setText:function(text){this.activeThreadId++;this.text=text||'';if(this.rendered){this.statusEl.setText(this.text);}
return this;},getText:function(){return this.text;},setIcon:function(cls){this.activeThreadId++;cls=cls||'';if(this.rendered){if(this.currIconCls){this.statusEl.removeClass(this.currIconCls);this.currIconCls=null;}
if(cls.length&gt;0){this.statusEl.addClass(cls);this.currIconCls=cls;}}else{this.currIconCls=cls;}
return this;},showBusy:function(o){if(typeof o=='string'){o={text:o};}
o=Ext.applyIf(o||{},{text:this.busyText,iconCls:this.busyIconCls});return this.setStatus(o);}});Ext.reg('statusbar',Ext.ux.StatusBar);Ext.namespace('sitools.userProfile');sitools.userProfile.Login=Ext.extend(Ext.Window,{id:'winLogin',layout:'hbox',width:392,height:200,resizable:false,closable:false,modal:true,initComponent:function(){this.title=i18n.get('label.login');this.bbar=new Ext.ux.StatusBar({text:i18n.get('label.ready'),id:'sbWinLogin',iconCls:'x-status-valid',items:[{text:i18n.get('label.passwordLost'),hidden:!this.reset,scope:this,icon:loadUrl.get('APP_URL')+'/common/res/images/icons/wadl.gif',iconAlign:'right',handler:function(){Ext.getCmp('winLogin').close();var reset=new sitools.userProfile.resetPassword({closable:this.closable,url:this.reset,handler:this.handler});reset.show();}}]});this.combo=new Ext.form.ComboBox({typeAhead:true,triggerAction:'all',forceSelection:true,allowBlank:false,lazyRender:true,mode:'local',store:new Ext.data.ArrayStore({id:0,fields:['myId','displayText'],data:[[1,i18n.get('label.userPortal')],[2,i18n.get('label.administration')]]}),valueField:'myId',displayField:'displayText',anchor:'80%',value:1,fieldLabel:i18n.get('label.target'),hideLabel:true});if(this.chooseLocation){this.combo.setVisible(true);this.combo.hideLabel=false;}else{this.combo.setVisible(false);this.setSize(392,160);}
this.items=[{xtype:'form',frame:true,border:false,buttonAlign:'center',id:'frmLogin',width:392,labelWidth:100,padding:&quot;10px 10px 0px 60px&quot;,bodyStyle:&quot;background-image: url(&quot;+loadUrl.get('APP_URL')+&quot;/common/res/images/ux/login-big.gif);&quot;+&quot;background-position: top left;&quot;+&quot;background-repeat: no-repeat;&quot;,items:[{xtype:'textfield',fieldLabel:i18n.get('label.login'),name:'login',id:'logId',allowBlank:false,anchor:'80%'},{xtype:'textfield',fieldLabel:i18n.get('label.password'),name:'password',id:'pwdId',allowBlank:false,inputType:'password',anchor:'80%',listeners:{scope:this,specialkey:function(field,e){if(e.getKey()==e.ENTER){this.getAuth();}}}},this.combo],buttons:[{text:i18n.get('label.login'),handler:this.getAuth,scope:this},{text:i18n.get('label.reset'),handler:function(){Ext.getCmp('frmLogin').getForm().reset();Ext.getCmp('sbWinLogin').setStatus({text:i18n.get('label.ready'),iconCls:'x-status-valid'});}},{text:i18n.get('label.cancel'),hidden:!this.defurl,scope:this,handler:function(){window.location.href=this.defurl;}},{text:i18n.get('label.register'),hidden:!this.register,scope:this,icon:loadUrl.get('APP_URL')+'/common/res/images/icons/refresh.png',handler:function(){Ext.getCmp('winLogin').close();var register=new sitools.userProfile.Register({closable:this.closable,url:this.register,login:this.url,handler:this.handler});register.show();}}]}];sitools.userProfile.Login.superclass.initComponent.call(this);},getAuth:function(){Ext.util.Cookies.set('A1',&quot;&quot;);Ext.util.Cookies.set('userLogin',&quot;&quot;);Ext.util.Cookies.set('scheme',&quot;&quot;);Ext.util.Cookies.set('algorithm',&quot;&quot;);Ext.util.Cookies.set('realm',&quot;&quot;);Ext.util.Cookies.set('nonce',&quot;&quot;);Ext.util.Cookies.set('hashCode',&quot;&quot;);Ext.apply(Ext.Ajax.defaultHeaders,{&quot;Authorization&quot;:&quot;&quot;});Ext.Ajax.request({url:this.url,method:'GET',scope:this,success:function(response,opts){var Json=Ext.decode(response.responseText);var date=new Date();if(!Ext.isEmpty(Json.data)){if(Json.data.scheme=='HTTP_Digest'){var auth=new Digest({usr:Ext.getCmp('logId').getValue(),pwd:Ext.getCmp('pwdId').getValue(),realm:Json.data.realm});var A1=auth.getA1();Ext.util.Cookies.set('A1',A1);Ext.util.Cookies.set('userLogin',auth.usr,date.add(Date.MINUTE,1));Ext.util.Cookies.set('scheme',Json.data.scheme);Ext.util.Cookies.set('algorithm',Json.data.algorithm);Ext.util.Cookies.set('realm',auth.realm);Ext.util.Cookies.set('nonce',Json.data.nonce);}else if(Json.data.scheme==&quot;HTTP_Basic&quot;){var usr=Ext.getCmp('logId').getValue();var pwd=Ext.getCmp('pwdId').getValue();var tok=usr+':'+pwd;var hash=Base64.encode(tok);var auth='Basic '+hash;Ext.util.Cookies.set('userLogin',usr,date.add(Date.MINUTE,1));Ext.util.Cookies.set('scheme',Json.data.scheme);Ext.util.Cookies.set('hashCode',auth,date.add(Date.MINUTE,1));}}
this.login();},failure:alertFailure});},login:function(){if(!Ext.getCmp('frmLogin').getForm().isValid()){Ext.getCmp('sbWinLogin').setStatus({text:i18n.get('warning.checkForm'),iconCls:'x-status-error'});return;}
Ext.getCmp('winLogin').body.mask();Ext.getCmp('sbWinLogin').showBusy();Ext.Ajax.request({url:this.url,method:'GET',scope:this,success:function(response,opts){try{var Json=Ext.decode(response.responseText);if(Json.success){Ext.apply(Ext.Ajax.defaultHeaders,{&quot;Authorization&quot;:Ext.util.Cookies.get('hashCode')});Ext.getCmp('winLogin').close();if(this.chooseLocation){if(this.combo.getValue()==1){window.location.href=loadUrl.get('APP_URL')+'/login-redirect?kwd=/client-user/index.html';}else{Ext.Ajax.request({url:loadUrl.get('APP_URL')+'/login-redirect?kwd=/client-admin',method:&quot;GET&quot;,success:function(response){Ext.Msg.alert('error login.js redirect with authorization');}});}}else{window.location.reload();}}else{Ext.util.Cookies.set('userLogin',&quot;&quot;,new Date().add(Date.MINUTE,COOKIE_DURATION*-1));Ext.util.Cookies.set('scheme',&quot;&quot;,new Date().add(Date.MINUTE,COOKIE_DURATION*-1));Ext.util.Cookies.set('hashCode',&quot;&quot;,new Date().add(Date.MINUTE,COOKIE_DURATION*-1));var txt=i18n.get('warning.serverError')+': '+Json.message;Ext.getCmp('winLogin').body.unmask();Ext.getCmp('sbWinLogin').setStatus({text:txt,iconCls:'x-status-error'});}}catch(err){Ext.Msg.alert(i18n.get('label.error'),err);}},failure:function(response,opts){Ext.util.Cookies.set('userLogin',&quot;&quot;,new Date().add(Date.MINUTE,COOKIE_DURATION*-1));Ext.util.Cookies.set('scheme',&quot;&quot;,new Date().add(Date.MINUTE,COOKIE_DURATION*-1));Ext.util.Cookies.set('hashCode',&quot;&quot;,new Date().add(Date.MINUTE,COOKIE_DURATION*-1));var txt;if(response.status==200){var ret=Ext.decode(response.responseText).error;txt=i18n.get('msg.error')+': '+ret;}else{txt=i18n.get('warning.serverError')+': '+response.statusText;}
Ext.getCmp('winLogin').body.unmask();Ext.getCmp('sbWinLogin').setStatus({text:txt,iconCls:'x-status-error'});}});}});Ext.reg('s-login',sitools.userProfile.Login);Ext.namespace('sitools.userProfile');sitools.userProfile.Register=Ext.extend(Ext.Window,{id:'winRegister',layout:'hbox',width:420,height:490,resizable:false,closable:false,modal:true,initComponent:function(){this.title=i18n.get('label.register');this.captchaUrl=loadUrl.get('APP_URL')+loadUrl.get('APP_INSCRIPTIONS_USER_URL')+'/captcha?width=300&amp;height=50';this.bbar=new Ext.ux.StatusBar({text:i18n.get('label.ready'),id:'sbWinRegister',iconCls:'x-status-valid'});this.captcha=new Ext.BoxComponent({id:'captchaBox',autoEl:{tag:'img',src:this.captchaUrl+'&amp;_dc='+new Date().getTime()},fieldLabel:i18n.get('label.captcha'),height:50,width:300,anchor:'100%'});this.items=[{xtype:'form',border:false,buttonAlign:'center',id:'frmRegister',bodyStyle:'padding:10px 10px 0px 60px; background:url(&quot;'+loadUrl.get('APP_URL')+'/common/res/images/ux/register-big.gif&quot;) no-repeat;',width:400,height:420,labelWidth:120,items:[{xtype:'textfield',fieldLabel:i18n.get('label.login'),name:'identifier',id:'regLogin',allowBlank:false,vtype:'uniquelogin',anchor:'100%'},{xtype:'textfield',fieldLabel:i18n.get('label.firstName'),name:'firstName',id:'regFirstName',allowBlank:false,anchor:'100%'},{xtype:'textfield',fieldLabel:i18n.get('label.lastName'),name:'lastName',id:'regLastName',allowBlank:false,anchor:'100%'},{xtype:'textfield',fieldLabel:i18n.get('label.password'),name:'password',allowBlank:false,inputType:'password',vtype:'passwordlength',id:'pass1',anchor:'100%'},{xtype:'textfield',fieldLabel:i18n.get('label.confirmPassword'),name:'cpassword',submitValue:false,allowBlank:false,inputType:'password',id:'pass2',initialPassField:'pass1',vtype:'password',anchor:'100%'},{xtype:'textfield',fieldLabel:i18n.get('label.email'),id:'regEmail',name:'email',vtype:'uniqueemail',allowBlank:false,validationEvent:'',anchor:'100%'},{xtype:'textfield',name:'organisation',fieldLabel:i18n.get('label.organisation'),anchor:'100%'},{xtype:'textarea',fieldLabel:i18n.get('label.comment'),id:'regComment',name:'comment',validationEvent:'',height:40,anchor:'100%'},this.captcha,{xtype:'button',text:i18n.get('label.captchaReload'),icon:loadUrl.get('APP_URL')+'/common/res/images/icons/refresh.png',x:150,arrowAlign:'right',reloadUrl:this.captchaUrl,handler:function(){Ext.util.Cookies.clear('captcha');var box=Ext.get('captchaBox');box.dom.src=this.reloadUrl+'&amp;_dc='+new Date().getTime();box.slideIn('l');}},{xtype:'textfield',fieldLabel:i18n.get('label.fieldCaptcha'),name:'captcha',id:'captcha',allowBlank:false,anchor:'100%'},{xtype:'checkbox',fieldLabel:String.format(i18n.get('label.acceptCGU'),URL_CGU),id:'acceptCGU',name:'acceptCGU',height:40,anchor:'100%',submitValue:false}],buttons:[{text:i18n.get('label.register'),handler:this.register,scope:this},{text:i18n.get('label.reset'),reloadUrl:this.captchaUrl,handler:function(){Ext.getCmp('frmRegister').getForm().reset();Ext.getCmp('sbWinRegister').setStatus({text:i18n.get('label.ready'),iconCls:'x-status-valid'});Ext.util.Cookies.clear('captcha');var box=Ext.get('captchaBox');box.dom.src=this.reloadUrl+'&amp;_dc='+new Date().getTime();box.slideIn('l');}},{text:i18n.get('label.login'),hidden:!this.register,scope:this,icon:loadUrl.get('APP_URL')+'/common/res/images/icons/refresh.png',handler:function(){Ext.getCmp('winRegister').close();var login=new sitools.userProfile.Login({closable:this.closable,url:this.login,register:this.url,handler:this.handler});login.show();}}]}];sitools.userProfile.Register.superclass.initComponent.call(this);},register:function(){var f=Ext.getCmp('frmRegister').getForm();if(!f.findField('acceptCGU').getValue()){Ext.getCmp('sbWinRegister').setStatus({text:i18n.get('label.mustAcceptCGU'),iconCls:'x-status-error'});;return;}
if(!f.isValid()){Ext.getCmp('sbWinRegister').setStatus({text:i18n.get('warning.checkForm'),iconCls:'x-status-error'});this.reloadCaptcha();return;}
var putObject=new Object();putObject.properties=[];Ext.iterate(f.getValues(),function(key,value){if(key=='organisation'){putObject.properties.push({name:&quot;organisation&quot;,value:value,scope:&quot;Editable&quot;});}else{if(key!='captcha'){putObject[key]=value;}}},this);var cook=Ext.util.Cookies.get('captcha');var capt=f.findField('captcha').getValue();Ext.getCmp('winRegister').body.mask();Ext.getCmp('sbWinRegister').showBusy();Ext.Ajax.request({url:this.url,method:'POST',jsonData:putObject,params:{&quot;captcha.id&quot;:cook,&quot;captcha.key&quot;:capt},scope:this,success:function(response,opts){var json=Ext.decode(response.responseText);if(json.success){new Ext.ux.Notification({iconCls:'x-icon-information',title:i18n.get('label.information'),html:i18n.get('label.registerSent'),autoDestroy:true,hideDelay:1000}).show(document);Ext.getCmp('winRegister').close();}
else{Ext.getCmp('winRegister').body.unmask();Ext.getCmp('sbWinRegister').setStatus({text:json.message,iconCls:'x-status-error'});}
if(this.handler!==null&amp;&amp;this.handler!==undefined){this.handler.call(this.scope||this);}},failure:function(response,opts){var txt;if(response.status==200){var ret=Ext.decode(response.responseText).message;txt=i18n.get('msg.error')+': '+ret;}else if(response.status==403){txt=i18n.get('msg.wrongCaptcha');}else{txt=i18n.get('warning.serverError')+': '+response.statusText;}
Ext.getCmp('winRegister').body.unmask();Ext.getCmp('sbWinRegister').setStatus({text:txt,iconCls:'x-status-error'});this.reloadCaptcha();}});},reloadCaptcha:function(){Ext.util.Cookies.clear('captcha');var box=Ext.get('captchaBox');box.dom.src=this.captchaUrl+'&amp;_dc='+new Date().getTime();box.slideIn('l');var f=Ext.getCmp('frmRegister').getForm();var capt=f.findField('captcha').setValue(&quot;&quot;);}});Ext.reg('s-register',sitools.userProfile.Register);Ext.namespace('sitools.userProfile');sitools.userProfile.resetPassword=Ext.extend(Ext.Window,{id:'winPassword',layout:'hbox',width:420,height:183,resizable:false,modal:true,initComponent:function(){this.title=i18n.get('label.resetPassword');this.bbar=new Ext.ux.StatusBar({text:i18n.get('label.ready'),id:'sbWinPassword',iconCls:'x-status-valid'});this.items=[{xtype:'form',border:false,buttonAlign:'center',id:'frmResetPassword',bodyStyle:'padding:10px 10px 0px 60px; background:url(&quot;'+loadUrl.get('APP_URL')+'/common/res/images/ux/login-big.gif&quot;) no-repeat;',width:400,labelWidth:120,items:[{xtype:'textfield',fieldLabel:i18n.get('label.login'),name:'identifier',id:'regLogin',allowBlank:false,anchor:'100%'},{xtype:'textfield',fieldLabel:i18n.get('label.email'),id:'regEmail',name:'email',vtype:'uniqueemail',allowBlank:false,validationEvent:'',anchor:'100%'},{xtype:'textfield',fieldLabel:i18n.get('label.emailConfirm'),id:'regEmailConfirm',name:'emailConfirm',vtype:'uniqueemail',allowBlank:false,validationEvent:'',anchor:'100%'}],buttons:[{text:i18n.get('label.resetPassword'),handler:this.reset,scope:this},{text:i18n.get('label.reset'),handler:function(){Ext.getCmp('frmResetPassword').getForm().reset();Ext.getCmp('sbWinPassword').setStatus({text:i18n.get('label.ready'),iconCls:'x-status-valid'});}}]}];sitools.userProfile.resetPassword.superclass.initComponent.call(this);},reset:function(){var f=Ext.getCmp('frmResetPassword').getForm();if(f.findField('email').getValue()!=f.findField('emailConfirm').getValue()){Ext.getCmp('sbWinPassword').setStatus({text:i18n.get('warning.checkForm'),iconCls:'x-status-error'});return;}
if(!f.isValid()){Ext.getCmp('sbWinPassword').setStatus({text:i18n.get('warning.checkForm'),iconCls:'x-status-error'});return;}
var putObject=new Object();Ext.iterate(f.getValues(),function(key,value){if(key!='emailConfirm'){putObject[key]=value;}},this);Ext.getCmp('winPassword').body.mask();Ext.getCmp('sbWinPassword').showBusy();Ext.Ajax.request({url:this.url,method:'PUT',jsonData:putObject,scope:this,success:function(response,opts){var json=Ext.decode(response.responseText);if(json.success){Ext.getCmp('winPassword').body.unmask();Ext.getCmp('sbWinPassword').setStatus({text:json.message,iconCls:'x-status-valid'});Ext.getCmp('winPassword').close();var notify=new Ext.ux.Notification({iconCls:'x-icon-information',title:i18n.get('label.information'),html:i18n.get('label.passwordSent')+json.message,autoDestroy:true,hideDelay:1300});notify.show(document);}else{Ext.getCmp('winPassword').body.unmask();Ext.getCmp('sbWinPassword').setStatus({text:json.message,iconCls:'x-status-error'});}
if(this.handler!==null&amp;&amp;this.handler!==undefined){this.handler.call(this.scope||this);}},failure:function(response,opts){var txt;if(response.status==200){var ret=Ext.decode(response.responseText).message;txt=i18n.get('msg.error')+': '+ret;}else{txt=i18n.get('warning.serverError')+': '+response.statusText;}
Ext.getCmp('winPassword').body.unmask();Ext.getCmp('sbWinPassword').setStatus({text:txt,iconCls:'x-status-error'});}});}});Ext.namespace('sitools.userProfile');sitools.userProfile.editProfile=Ext.extend(Ext.Panel,{padding:&quot;10px 10px 0px 60px&quot;,frame:true,layout:&quot;fit&quot;,initComponent:function(){this.bodyStyle=&quot;background-image: url(&quot;+loadUrl.get('APP_URL')+&quot;/common/res/images/ux/login-big.gif);&quot;+&quot;background-position: top left;&quot;+&quot;background-repeat: no-repeat;&quot;;this.bbar=new Ext.ux.StatusBar({text:i18n.get('label.ready'),id:'sbWinEditProfile',iconCls:'x-status-valid'});var storeProperties=new Ext.data.JsonStore({fields:[{name:'name',type:'string'},{name:'value',type:'string'},{name:'scope',type:'string'}],autoLoad:false});var smProperties=new Ext.grid.RowSelectionModel({singleSelect:true});var cmProperties=new Ext.grid.ColumnModel({columns:[{header:i18n.get('headers.name'),dataIndex:'name',editor:new Ext.form.TextField({readOnly:true})},{header:i18n.get('headers.value'),dataIndex:'value',editor:new Ext.form.TextField({allowBlank:false})}],defaults:{sortable:false,width:100}});this.gridProperties=new Ext.grid.EditorGridPanel({title:i18n.get('title.properties'),id:'userGridProperties',height:130,autoScroll:true,clicksToEdit:1,store:storeProperties,cm:cmProperties,sm:smProperties,viewConfig:{forceFit:true,getRowClass:function(row,col){var data=row.data;if(data.scope=='ReadOnly'){return&quot;row-grid-readOnly&quot;;}}},listeners:{beforeedit:function(e){var scope=e.record.data.scope;var name=e.field;if(scope=='ReadOnly'||name=='name'){return false;}}}});this.items=[{xtype:'form',flex:1,border:false,buttonAlign:'center',id:'frmEditProfile',labelWidth:120,items:[{xtype:'textfield',name:'identifier',fieldLabel:i18n.get('label.login'),anchor:'100%',allowBlank:false,readOnly:true,style:{color:'#C0C0C0'},id:&quot;nameField&quot;},{xtype:'textfield',fieldLabel:i18n.get('label.firstName'),name:'firstName',id:'regFirstName',allowBlank:false,anchor:'100%'},{xtype:'textfield',fieldLabel:i18n.get('label.lastName'),name:'lastName',id:'regLastName',allowBlank:false,anchor:'100%'},{xtype:'textfield',fieldLabel:i18n.get('label.password'),anchor:'100%',inputType:'password',name:'secret',value:'',id:&quot;passwordField&quot;,vtype:'passwordlength'},{id:&quot;confirmSecret&quot;,xtype:'textfield',fieldLabel:i18n.get('label.confirmPassword'),anchor:'100%',inputType:'password',initialPassField:'passwordField',vtype:'password',name:'confirmSecret',submitValue:false,value:''},{xtype:'textfield',fieldLabel:i18n.get('label.email'),id:'regEmail',name:'email',vtype:'uniqueemail',allowBlank:false,validationEvent:'',anchor:'100%'},this.gridProperties],buttons:[{text:i18n.get('label.saveEdit'),x:30,handler:this.saveEdit,scope:this}]}];sitools.userProfile.editProfile.superclass.initComponent.call(this);},saveEdit:function(){var f=Ext.getCmp('frmEditProfile').getForm();if(!f.isValid()){Ext.getCmp('sbWinEditProfile').setStatus({text:i18n.get('warning.checkForm'),iconCls:'x-status-error'});return;}
var putObject=f.getValues();putObject.properties=[];this.gridProperties.getStore().each(function(item){putObject.properties.push({name:item.data.name,value:item.data.value,scope:item.data.scope});});this.body.mask();Ext.getCmp('sbWinEditProfile').showBusy();Ext.Ajax.request({url:this.url,method:'PUT',jsonData:putObject,scope:this,success:function(response,opts){var json=Ext.decode(response.responseText);if(json.success){this.ownerCt.close();var notify=new Ext.ux.Notification({iconCls:'x-icon-information',title:i18n.get('label.information'),html:json.message,autoDestroy:true,hideDelay:1000});notify.show(document);}else{Ext.getCmp('winEditProfile').body.unmask();Ext.getCmp('sbWinEditProfile').setStatus({text:json.message,iconCls:'x-status-error'});}
if(this.handler!==null&amp;&amp;this.handler!==undefined){this.handler.call(this.scope||this,putObject);}},failure:function(response,opts){var txt;if(response.status==200){var ret=Ext.decode(response.responseText).message;txt=i18n.get('msg.error')+': '+ret;}else{txt=i18n.get('warning.serverError')+': '+response.statusText;}
Ext.getCmp('winEditProfile').body.unmask();Ext.getCmp('sbWinEditProfile').setStatus({text:txt,iconCls:'x-status-error'});}});},onRender:function(){sitools.userProfile.editProfile.superclass.onRender.apply(this,arguments);if(this.url){Ext.Ajax.request({url:this.url,method:'GET',scope:this,success:function(ret){var f=this.findByType('form')[0].getForm();var data=Ext.decode(ret.responseText);if(data.user!==undefined){f.setValues(data.user);f.findField('secret').setValue('');if(!Ext.isEmpty(data.user.properties)){Ext.each(data.user.properties,function(property){var rec=new Ext.data.Record({name:property.name,value:property.value,scope:property.scope});this.gridProperties.getStore().add(rec);},this);}}},failure:alertFailure});}},showMeInFixedNav:function(me,config){Ext.apply(config.windowSettings,{width:config.windowSettings.winWidth||DEFAULT_WIN_WIDTH,height:config.windowSettings.winHeight||DEFAULT_WIN_HEIGHT});SitoolsDesk.openModalWindow(me,config);},showMeInDesktopNav:function(me,config){Ext.apply(config.windowSettings,{width:config.windowSettings.winWidth||DEFAULT_WIN_WIDTH,height:config.windowSettings.winHeight||DEFAULT_WIN_HEIGHT});SitoolsDesk.openModalWindow(me,config);}});var loginErrLength='Login minimum 4 character !';var loginErrUnique='Login already in use !';var loginSuccess='Login avaliable';var emailErrFormat='Email not valid !';var emailErrUnique='Email already in use !';var emailSuccess='Email valid &amp; avaliable';Ext.apply(Ext.form.VTypes,{uniqueloginMask:/[a-z0-9_\.\-@\+]/i,uniquelogin:function(val){if(val.length&lt;4){Ext.apply(Ext.form.VTypes,{uniqueloginText:loginErrLength});return false;}else{return true;}},uniqueloginText:loginErrUnique,uniqueemailMask:/[a-z0-9_\.\-@\+]/i,uniqueemail:function(val){var uniqueemail=/^(\w+)([\-+.][\w]+)*@(\w[\-\w]*\.){1,5}([A-Za-z]){2,6}$/;if(uniqueemail.test(val)){return true;}else{return false;}},uniqueemailText:emailErrFormat,password:function(val,field){if(field.initialPassField){var pwd=Ext.getCmp(field.initialPassField);return(val==pwd.getValue());}
return true;},passwordText:'Passwords do not match',passwordlength:function(val){if(val.length&lt;6||val.length&gt;40){return false;}else{return true;}},passwordlengthText:'Invalid Password Length. It must be between 6 and 40'});function resetLoginValidator(is_error){Ext.apply(Ext.form.VTypes,{uniquelogin:function(val){if(val.length&lt;4){Ext.apply(Ext.form.VTypes,{uniqueloginText:loginErrLength});return false;}else{return true;}}});}
function resetEmailValidator(value){Ext.apply(Ext.form.VTypes,{uniqueemail:function(val){var uniqueemail=/^(\w+)([\-+.][\w]+)*@(\w[\-\w]*\.){1,5}([A-Za-z]){2,6}$/;if(uniqueemail.test(val)){return true;}else{return false;}
return(value);}});}
Ext.namespace('Ext.ux');Ext.namespace('Ext.ux.Plugin');Ext.ux.Plugin.LiteRemoteComponent=function(config){var defaultType=config.xtype||'panel';var callback=function(res){this.container.add(Ext.ComponentMgr.create(Ext.decode(res.responseText),defaultType)).show();this.container.doLayout();};return{init:function(container){this.container=container;Ext.Ajax.request(Ext.apply(config,{success:callback,scope:this}));}}};Ext.ux.Plugin.RemoteComponent=function(config){var defaultType=config.xtype||'panel';Ext.applyIf(config,{purgeSubscribers:true});this.initialConfig=config;Ext.apply(this,config);this.addEvents({'beforeload':true,'beforecreate':true,'beforeadd':true,'beforecomponshow':true,'beforecontainshow':true,'success':true});Ext.ux.Plugin.RemoteComponent.superclass.constructor.call(this,config);if(config.breakOn){this.on(config.breakOn,function(){return false;});}
var renderComponent=function(JSON){if(this.fireEvent('beforeadd',JSON,this)){var component=this.container.add(JSON);component.fireEvent('bodyResize',this);if(this.fireEvent('beforecomponshow',component,this)){return component;}}}.createDelegate(this);var callback=function(res){var JSON=Ext.decode(res.responseText);if(this.fireEvent('beforecreate',JSON,this)){var component=null;if(JSON instanceof Array){Ext.each(JSON,function(j,i){component=renderComponent(j).show();;});}else{component=renderComponent(JSON).show();}
if(this.fireEvent('beforecontainshow',component,this)){this.container.ownerCt.doLayout();this.fireEvent('success',component,this);}}
if(this.purgeSubscribers){this.purgeListeners();}}.createDelegate(this);this.load=function(){if(this.fireEvent('beforeload',config,this)){if(config.mask){var mask=new Ext.LoadMask(Ext.getDom(config.mask),Ext.apply({msg:'loading components...'},config.maskConfig||{}));mask.show();this.on('success',mask.hide,mask);}
Ext.Ajax.request(Ext.apply(config,{success:callback,scope:this}));}};this.init=function(container){container.on('beforedestroy',function(){this.purgeListeners();},this);this.container=container;if(config.loadOn){if(config.loadOn instanceof Array){Ext.each(config.loadOn,function(l,i,a){var evt=l.event||l.loadOn;var defer=function(){this.load();Ext.each(a,function(lo){(lo.scope||container).un(evt,defer,this);}.createDelegate(this));}.createDelegate(this);(l.scope||container).on(evt,defer,this);}.createDelegate(this));}else{(config.loadOn.scope||container).on((config.loadOn.event||config.loadOn),this.load,this,{single:true});}}else{this.load();}};};Ext.extend(Ext.ux.Plugin.RemoteComponent,Ext.util.Observable);Ext.ns('Ext.ux.form');Ext.ux.form.MultiSelect=Ext.extend(Ext.form.Field,{ddReorder:false,appendOnly:false,width:100,height:100,displayField:0,valueField:1,allowBlank:true,minSelections:0,maxSelections:Number.MAX_VALUE,blankText:Ext.form.TextField.prototype.blankText,minSelectionsText:'Minimum {0} item(s) required',maxSelectionsText:'Maximum {0} item(s) allowed',delimiter:',',defaultAutoCreate:{tag:&quot;div&quot;},initComponent:function(){Ext.ux.form.MultiSelect.superclass.initComponent.call(this);if(Ext.isArray(this.store)){if(Ext.isArray(this.store[0])){this.store=new Ext.data.ArrayStore({fields:['value','text'],data:this.store});this.valueField='value';}else{this.store=new Ext.data.ArrayStore({fields:['text'],data:this.store,expandData:true});this.valueField='text';}
this.displayField='text';}else{this.store=Ext.StoreMgr.lookup(this.store);this.displayField=this.store.displayField;this.valueField=this.store.valueField;}
this.addEvents({'dblclick':true,'click':true,'change':true,'drop':true});},onRender:function(ct,position){Ext.ux.form.MultiSelect.superclass.onRender.call(this,ct,position);var fs=this.fs=new Ext.form.FieldSet({renderTo:this.el,title:this.legend,height:this.height-20,width:this.width,style:&quot;padding:0;&quot;,tbar:this.tbar});fs.body.addClass('ux-mselect');this.view=new Ext.ListView({multiSelect:true,store:this.store,columns:[{header:'Value',width:1,dataIndex:this.displayField}],hideHeaders:true});fs.add(this.view);this.view.on('click',this.onViewClick,this);this.view.on('beforeclick',this.onViewBeforeClick,this);this.view.on('dblclick',this.onViewDblClick,this);this.hiddenName=this.name||Ext.id();var hiddenTag={tag:&quot;input&quot;,type:&quot;hidden&quot;,value:&quot;&quot;,name:this.hiddenName};this.hiddenField=this.el.createChild(hiddenTag);this.hiddenField.dom.disabled=this.hiddenName!=this.name;fs.doLayout();},afterRender:function(){Ext.ux.form.MultiSelect.superclass.afterRender.call(this);if(this.ddReorder&amp;&amp;!this.dragGroup&amp;&amp;!this.dropGroup){this.dragGroup=this.dropGroup='MultiselectDD-'+Ext.id();}
if(this.draggable||this.dragGroup){this.dragZone=new Ext.ux.form.MultiSelect.DragZone(this,{ddGroup:this.dragGroup});}
if(this.droppable||this.dropGroup){this.dropZone=new Ext.ux.form.MultiSelect.DropZone(this,{ddGroup:this.dropGroup});}
if(this.values){this.setValue(this.values);}},onViewClick:function(vw,index,node,e){this.fireEvent('change',this,this.getValue(),this.hiddenField.dom.value);this.hiddenField.dom.value=this.getValue();this.fireEvent('click',this,e);this.validate();},onViewBeforeClick:function(vw,index,node,e){if(this.disabled||this.readOnly){return false;}},onViewDblClick:function(vw,index,node,e){return this.fireEvent('dblclick',vw,index,node,e);},getValue:function(valueField){var returnArray=[];var selectionsArray=this.view.getSelectedIndexes();if(selectionsArray.length==0){return'';}
for(var i=0;i&lt;selectionsArray.length;i++){var returnValue=this.store.getAt(selectionsArray[i]).get((valueField!=null)?valueField:this.valueField);if(Ext.isString(returnValue)){returnValue=returnValue;}
returnArray.push(returnValue);}return returnArray.join(this.delimiter);},setValue:function(values){var index;var selections=[];this.view.clearSelections();this.hiddenField.dom.value='';if(!values||(values=='')){return;}
if(!Ext.isArray(values)){values=values.split(this.delimiter);}
for(var i=0;i&lt;values.length;i++){index=this.view.store.indexOf(this.view.store.query(this.valueField,new RegExp('^'+values[i]+'$',&quot;i&quot;)).itemAt(0));selections.push(index);}
this.view.select(selections);this.hiddenField.dom.value=this.getValue();this.validate();},reset:function(){this.setValue('');},getRawValue:function(valueField){var tmp=this.getValue(valueField);if(tmp.length){tmp=tmp.split(this.delimiter);}
else{tmp=[];}
return tmp;},setRawValue:function(values){setValue(values);},validateValue:function(value){if(value.length&lt;1){if(this.allowBlank){this.clearInvalid();return true;}else{this.markInvalid(this.blankText);return false;}}
if(value.length&lt;this.minSelections){this.markInvalid(String.format(this.minSelectionsText,this.minSelections));return false;}
if(value.length&gt;this.maxSelections){this.markInvalid(String.format(this.maxSelectionsText,this.maxSelections));return false;}
return true;},disable:function(){this.disabled=true;if(!Ext.isEmpty(this.hiddenField)){this.hiddenField.dom.disabled=true;}
if(!Ext.isEmpty(this.fs)){this.fs.disable();}},enable:function(){this.disabled=false;this.hiddenField.dom.disabled=false;this.fs.enable();},destroy:function(){Ext.destroy(this.fs,this.dragZone,this.dropZone);Ext.ux.form.MultiSelect.superclass.destroy.call(this);}});Ext.reg('multiselect',Ext.ux.form.MultiSelect);Ext.ux.Multiselect=Ext.ux.form.MultiSelect;Ext.ux.form.MultiSelect.DragZone=function(ms,config){this.ms=ms;this.view=ms.view;var ddGroup=config.ddGroup||'MultiselectDD';var dd;if(Ext.isArray(ddGroup)){dd=ddGroup.shift();}else{dd=ddGroup;ddGroup=null;}
Ext.ux.form.MultiSelect.DragZone.superclass.constructor.call(this,this.ms.fs.body,{containerScroll:true,ddGroup:dd});this.setDraggable(ddGroup);};Ext.extend(Ext.ux.form.MultiSelect.DragZone,Ext.dd.DragZone,{onInitDrag:function(x,y){var el=Ext.get(this.dragData.ddel.cloneNode(true));this.proxy.update(el.dom);el.setWidth(el.child('em').getWidth());this.onStartDrag(x,y);return true;},collectSelection:function(data){data.repairXY=Ext.fly(this.view.getSelectedNodes()[0]).getXY();var i=0;this.view.store.each(function(rec){if(this.view.isSelected(i)){var n=this.view.getNode(i);var dragNode=n.cloneNode(true);dragNode.id=Ext.id();data.ddel.appendChild(dragNode);data.records.push(this.view.store.getAt(i));data.viewNodes.push(n);}
i++;},this);},onEndDrag:function(data,e){var d=Ext.get(this.dragData.ddel);if(d&amp;&amp;d.hasClass(&quot;multi-proxy&quot;)){d.remove();}},getDragData:function(e){var target=this.view.findItemFromChild(e.getTarget());if(target){if(!this.view.isSelected(target)&amp;&amp;!e.ctrlKey&amp;&amp;!e.shiftKey){this.view.select(target);this.ms.setValue(this.ms.getValue());}
if(this.view.getSelectionCount()==0||e.ctrlKey||e.shiftKey)return false;var dragData={sourceView:this.view,viewNodes:[],records:[]};if(this.view.getSelectionCount()==1){var i=this.view.getSelectedIndexes()[0];var n=this.view.getNode(i);dragData.viewNodes.push(dragData.ddel=n);dragData.records.push(this.view.store.getAt(i));dragData.repairXY=Ext.fly(n).getXY();}else{dragData.ddel=document.createElement('div');dragData.ddel.className='multi-proxy';this.collectSelection(dragData);}
return dragData;}
return false;},getRepairXY:function(e){return this.dragData.repairXY;},setDraggable:function(ddGroup){if(!ddGroup)return;if(Ext.isArray(ddGroup)){Ext.each(ddGroup,this.setDraggable,this);return;}
this.addToGroup(ddGroup);}});Ext.ux.form.MultiSelect.DropZone=function(ms,config){this.ms=ms;this.view=ms.view;var ddGroup=config.ddGroup||'MultiselectDD';var dd;if(Ext.isArray(ddGroup)){dd=ddGroup.shift();}else{dd=ddGroup;ddGroup=null;}
Ext.ux.form.MultiSelect.DropZone.superclass.constructor.call(this,this.ms.fs.body,{containerScroll:true,ddGroup:dd});this.setDroppable(ddGroup);};Ext.extend(Ext.ux.form.MultiSelect.DropZone,Ext.dd.DropZone,{getTargetFromEvent:function(e){var target=e.getTarget();return target;},getDropPoint:function(e,n,dd){if(n==this.ms.fs.body.dom){return&quot;below&quot;;}
var t=Ext.lib.Dom.getY(n),b=t+n.offsetHeight;var c=t+(b-t)/2;var y=Ext.lib.Event.getPageY(e);if(y&lt;=c){return&quot;above&quot;;}else{return&quot;below&quot;;}},isValidDropPoint:function(pt,n,data){if(!data.viewNodes||(data.viewNodes.length!=1)){return true;}
var d=data.viewNodes[0];if(d==n){return false;}
if((pt==&quot;below&quot;)&amp;&amp;(n.nextSibling==d)){return false;}
if((pt==&quot;above&quot;)&amp;&amp;(n.previousSibling==d)){return false;}
return true;},onNodeEnter:function(n,dd,e,data){return false;},onNodeOver:function(n,dd,e,data){var dragElClass=this.dropNotAllowed;var pt=this.getDropPoint(e,n,dd);if(this.isValidDropPoint(pt,n,data)){if(this.ms.appendOnly){return&quot;x-tree-drop-ok-below&quot;;}
if(pt){var targetElClass;if(pt==&quot;above&quot;){dragElClass=n.previousSibling?&quot;x-tree-drop-ok-between&quot;:&quot;x-tree-drop-ok-above&quot;;targetElClass=&quot;x-view-drag-insert-above&quot;;}else{dragElClass=n.nextSibling?&quot;x-tree-drop-ok-between&quot;:&quot;x-tree-drop-ok-below&quot;;targetElClass=&quot;x-view-drag-insert-below&quot;;}
if(this.lastInsertClass!=targetElClass){Ext.fly(n).replaceClass(this.lastInsertClass,targetElClass);this.lastInsertClass=targetElClass;}}}
return dragElClass;},onNodeOut:function(n,dd,e,data){this.removeDropIndicators(n);},onNodeDrop:function(n,dd,e,data){if(this.ms.fireEvent(&quot;drop&quot;,this,n,dd,e,data)===false){return false;}
var pt=this.getDropPoint(e,n,dd);if(n!=this.ms.fs.body.dom)
n=this.view.findItemFromChild(n);if(this.ms.appendOnly){insertAt=this.view.store.getCount();}else{insertAt=n==this.ms.fs.body.dom?this.view.store.getCount()-1:this.view.indexOf(n);if(pt==&quot;below&quot;){insertAt++;}}
var dir=false;if(data.sourceView==this.view){if(pt==&quot;below&quot;){if(data.viewNodes[0]==n){data.viewNodes.shift();}}else{if(data.viewNodes[data.viewNodes.length-1]==n){data.viewNodes.pop();}}
if(!data.viewNodes.length){return false;}
if(insertAt&gt;this.view.store.indexOf(data.records[0])){dir='down';insertAt--;}}
for(var i=0;i&lt;data.records.length;i++){var r=data.records[i];if(data.sourceView){data.sourceView.store.remove(r);}
this.view.store.insert(dir=='down'?insertAt:insertAt++,r);var si=this.view.store.sortInfo;if(si){this.view.store.sort(si.field,si.direction);}}
return true;},removeDropIndicators:function(n){if(n){Ext.fly(n).removeClass([&quot;x-view-drag-insert-above&quot;,&quot;x-view-drag-insert-left&quot;,&quot;x-view-drag-insert-right&quot;,&quot;x-view-drag-insert-below&quot;]);this.lastInsertClass=&quot;_noclass&quot;;}},setDroppable:function(ddGroup){if(!ddGroup)return;if(Ext.isArray(ddGroup)){Ext.each(ddGroup,this.setDroppable,this);return;}
this.addToGroup(ddGroup);}});Ext.ns('Ext.ux');Ext.ux.stateFullWindow=Ext.extend(Ext.Window,{saveSettings:function(componentSettings,forPublicUser){if(Ext.isEmpty(userLogin)){Ext.Msg.alert(i18n.get('label.warning','label.needLogin'));return;}
var position=Ext.encode(this.getPosition(true));var size=Ext.encode(this.getSize());var putObject={};putObject.componentSettings=componentSettings;putObject.windowSettings={};putObject.windowSettings.size=size;putObject.windowSettings.position=position;putObject.windowSettings.specificType=this.specificType;putObject.windowSettings.moduleId=this.getId();putObject.windowSettings.typeWindow=this.typeWindow;putObject.windowSettings.maximized=this.maximized;var baseFilePath=&quot;/&quot;+DEFAULT_PREFERENCES_FOLDER+&quot;/&quot;+projectGlobal.projectName;var filePath=componentSettings.preferencesPath;var fileName=componentSettings.preferencesFileName;if(Ext.isEmpty(filePath)||Ext.isEmpty(fileName)){return;}
filePath=baseFilePath+filePath;if(forPublicUser){publicStorage.set(fileName,filePath,putObject);}
else{userStorage.set(fileName,filePath,putObject);}
return putObject;},maximize:function(){if(!this.maximized){this.expand(false);this.restoreSize=this.getSize();this.restorePos=this.getPosition(true);if(this.maximizable){this.tools.maximize.hide();this.tools.restore.show();}
this.maximized=true;this.el.disableShadow();if(this.dd){this.dd.lock();}
if(this.collapsible){this.tools.toggle.hide();}
this.el.addClass('x-window-maximized');this.container.addClass('x-window-maximized-ct');this.setPosition(0,0);this.fitContainer();this.fireEvent('maximize',this);}
return this;}});Ext.reg('statewindow',Ext.ux.stateFullWindow);Ext.namespace(&quot;Ext.ux&quot;);Ext.ux.NotificationMgr={positions:[]};Ext.ux.Notification=Ext.extend(Ext.Window,{initComponent:function(){Ext.apply(this,{iconCls:this.iconCls||'x-icon-information',cls:'x-notification',width:200,autoHeight:true,plain:false,draggable:false,shadow:false,bodyStyle:'text-align:center'});if(this.autoDestroy){this.task=new Ext.util.DelayedTask(this.hide,this);}else{this.closable=true;}
Ext.ux.Notification.superclass.initComponent.apply(this);},setMessage:function(msg){this.body.update(msg);},setTitle:function(title,iconCls){Ext.ux.Notification.superclass.setTitle.call(this,title,iconCls||this.iconCls);},onDestroy:function(){Ext.ux.NotificationMgr.positions.remove(this.pos);Ext.ux.Notification.superclass.onDestroy.call(this);},cancelHiding:function(){this.addClass('fixed');if(this.autoDestroy){this.task.cancel();}},afterShow:function(){Ext.ux.Notification.superclass.afterShow.call(this);Ext.fly(this.body.dom).on('click',this.cancelHiding,this);if(this.autoDestroy){this.task.delay(this.hideDelay||5000);}},animShow:function(){this.pos=0;while(Ext.ux.NotificationMgr.positions.indexOf(this.pos)&gt;-1)
this.pos++;Ext.ux.NotificationMgr.positions.push(this.pos);this.setSize(200,100);this.el.alignTo(document,&quot;br-br&quot;,[-20,-140-((this.getSize().height+10)*this.pos)]);this.el.slideIn('b',{duration:1,callback:this.afterShow,scope:this});},animHide:function(){this.el.ghost(&quot;b&quot;,{duration:1,remove:false,callback:function(){Ext.ux.NotificationMgr.positions.remove(this.pos);this.destroy();}.createDelegate(this)});},focus:Ext.emptyFn});Ext.ns(&quot;sitools.widget&quot;);sitools.widget.Filter=Ext.extend(Ext.Container,{columnAlias:null,layout:&quot;vbox&quot;,layoutConfig:{align:&quot;left&quot;,pack:&quot;center&quot;},specificType:&quot;filter&quot;,constructor:function(config){Ext.apply(this,config);this.layout='hbox';this.columnAlias=config.columnAlias;this.specificType=&quot;filter&quot;;sitools.widget.Filter.superclass.constructor.call(this);this.init(config);if(config&amp;&amp;config.value){this.setValue(config.value);delete config.value;}},init:Ext.emptyFn,getValue:Ext.emptyFn,setValue:Ext.emptyFn,validateRecord:function(){return true;},_getHeight:Ext.emptyFn,getFilterData:function(){return this.getValue();}});Ext.ns(&quot;sitools.widget&quot;);sitools.widget.DateFilter=Ext.extend(sitools.widget.Filter,{iconCls:'ux-gridfilter-text-icon',emptyText:'Enter Filter Text...',selectOnFocus:true,flex:0.9,style:{&quot;padding-left&quot;:'10px'},height:60,init:function(config){config=config||{};this.inputFrom=new Ext.form.DateField({anchor:&quot;100%&quot;,fieldLabel:&quot;ux-rangemenu-gte&quot;,format:SITOOLS_DEFAULT_IHM_DATE_FORMAT,labelStyle:&quot;height: 10px&quot;,width:150});this.inputTo=new Ext.form.DateField({anchor:&quot;100%&quot;,fieldLabel:&quot;ux-rangemenu-lte&quot;,format:SITOOLS_DEFAULT_IHM_DATE_FORMAT,labelStyle:&quot;height: 10px&quot;,width:150});var formPanel=new Ext.form.FormPanel({items:[this.inputFrom,this.inputTo],labelWidth:21,bodyBorder:false,border:false,layout:'form',layoutConfig:{fieldTpl:new Ext.Template('&lt;div class=&quot;x-form-item {itemCls}&quot; tabIndex=&quot;-1&quot;&gt;','&lt;label for=&quot;{id}&quot; style=&quot;{labelStyle}&quot; class=&quot;x-form-item-label {label}&quot;&gt;&lt;/label&gt;','&lt;div class=&quot;x-form-element&quot; id=&quot;x-form-el-{id}&quot; style=&quot;{elementStyle}&quot;&gt;','&lt;/div&gt;&lt;div class=&quot;{clearCls}&quot;&gt;&lt;/div&gt;','&lt;/div&gt;')}})
this.add(formPanel);},getValue:function(){var result=[];if(!Ext.isEmpty(this.inputFrom.getValue())){result.push({&quot;columnAlias&quot;:this.columnAlias,&quot;data&quot;:{&quot;comparison&quot;:&quot;gte&quot;,&quot;value&quot;:this.inputFrom.getValue().format(SITOOLS_DATE_FORMAT),&quot;type&quot;:&quot;date&quot;}});}
if(!Ext.isEmpty(this.inputTo.getValue())){result.push({&quot;columnAlias&quot;:this.columnAlias,&quot;data&quot;:{&quot;comparison&quot;:&quot;lte&quot;,&quot;value&quot;:this.inputTo.getValue().format(SITOOLS_DATE_FORMAT),&quot;type&quot;:&quot;date&quot;}});}
return result;},getConfig:function(){if(!Ext.isEmpty(this.inputFrom.getValue())||!Ext.isEmpty(this.inputTo.getValue())){return{&quot;columnAlias&quot;:this.columnAlias,&quot;value&quot;:{&quot;from&quot;:this.inputFrom.getValue(),&quot;to&quot;:this.inputTo.getValue()},&quot;type&quot;:&quot;date&quot;};}
else{return null;}},setValue:function(value){this.inputFrom.setValue(value.from);this.inputTo.setValue(value.to);},_getHeight:function(){return this.height;}});Ext.ns(&quot;sitools.widget&quot;);sitools.widget.StringFilter=Ext.extend(sitools.widget.Filter,{iconCls:'ux-gridfilter-text-icon',emptyText:'Enter Filter Text...',selectOnFocus:true,flex:0.9,style:{&quot;padding-left&quot;:'10px'},height:30,init:function(config){config=config||{};this.inputItem=new Ext.form.TextField({anchor:&quot;100%&quot;,fieldLabel:&quot;ux-gridfilter-text-icon&quot;,labelStyle:&quot;height: 10px&quot;,width:150});var formPanel=new Ext.form.FormPanel({items:[this.inputItem],labelWidth:21,bodyBorder:false,border:false,layout:'form',layoutConfig:{fieldTpl:new Ext.Template('&lt;div class=&quot;x-form-item {itemCls}&quot; tabIndex=&quot;-1&quot;&gt;','&lt;label for=&quot;{id}&quot; style=&quot;{labelStyle}&quot; class=&quot;x-form-item-label {label}&quot;&gt;&lt;/label&gt;','&lt;div class=&quot;x-form-element&quot; id=&quot;x-form-el-{id}&quot; style=&quot;{elementStyle}&quot;&gt;','&lt;/div&gt;&lt;div class=&quot;{clearCls}&quot;&gt;&lt;/div&gt;','&lt;/div&gt;')}});this.add(formPanel);},getValue:function(){if(!Ext.isEmpty(this.inputItem.getValue())){return[{&quot;columnAlias&quot;:this.columnAlias,&quot;data&quot;:{&quot;comparison&quot;:&quot;LIKE&quot;,&quot;value&quot;:this.inputItem.getValue(),&quot;type&quot;:&quot;string&quot;}}];}
else{return[];}},getConfig:function(){if(!Ext.isEmpty(this.inputItem.getValue())){return{&quot;columnAlias&quot;:this.columnAlias,&quot;value&quot;:this.inputItem.getValue(),&quot;type&quot;:&quot;string&quot;};}
else{return null;}},setValue:function(value){this.inputItem.setValue(value);},validateRecord:function(record){var val=record.get(this.dataIndex);if(typeof val!='string'){return(this.getValue().length===0);}
return val.toLowerCase().indexOf(this.getValue().toLowerCase())&gt;-1;},_getHeight:function(){return this.height;}});Ext.ns(&quot;sitools.widget&quot;);sitools.widget.NumericFilter=Ext.extend(sitools.widget.Filter,{iconCls:'ux-gridfilter-text-icon',emptyText:'Enter Filter Text...',selectOnFocus:true,flex:0.9,style:{&quot;padding-left&quot;:'10px'},height:60,init:function(config){config=config||{};this.inputFrom=new Ext.form.NumberField({anchor:&quot;100%&quot;,fieldLabel:&quot;ux-rangemenu-gte&quot;,labelStyle:&quot;height: 10px&quot;,width:150});this.inputTo=new Ext.form.NumberField({anchor:&quot;100%&quot;,fieldLabel:&quot;ux-rangemenu-lte&quot;,labelStyle:&quot;height: 10px&quot;,width:150});var formPanel=new Ext.form.FormPanel({items:[this.inputTo,this.inputFrom],labelWidth:21,bodyBorder:false,border:false,layoutConfig:{fieldTpl:new Ext.Template('&lt;div class=&quot;x-form-item {itemCls}&quot; tabIndex=&quot;-1&quot;&gt;','&lt;label for=&quot;{id}&quot; style=&quot;{labelStyle}&quot; class=&quot;x-form-item-label {label}&quot;&gt;&lt;/label&gt;','&lt;div class=&quot;x-form-element&quot; id=&quot;x-form-el-{id}&quot; style=&quot;{elementStyle}&quot;&gt;','&lt;/div&gt;&lt;div class=&quot;{clearCls}&quot;&gt;&lt;/div&gt;','&lt;/div&gt;')}})
this.add(formPanel);},getValue:function(){var result=[];if(!Ext.isEmpty(this.inputFrom.getValue())){result.push({&quot;columnAlias&quot;:this.columnAlias,&quot;data&quot;:{&quot;comparison&quot;:&quot;gte&quot;,&quot;value&quot;:this.inputFrom.getValue(),&quot;type&quot;:&quot;numeric&quot;}});}
if(!Ext.isEmpty(this.inputTo.getValue())){result.push({&quot;columnAlias&quot;:this.columnAlias,&quot;data&quot;:{&quot;comparison&quot;:&quot;lte&quot;,&quot;value&quot;:this.inputTo.getValue(),&quot;type&quot;:&quot;numeric&quot;}});}
return result;},getConfig:function(){if(!Ext.isEmpty(this.inputFrom.getValue())||!Ext.isEmpty(this.inputTo.getValue())){return{&quot;columnAlias&quot;:this.columnAlias,&quot;value&quot;:{&quot;from&quot;:this.inputFrom.getValue(),&quot;to&quot;:this.inputTo.getValue()},&quot;type&quot;:&quot;numeric&quot;};}
else{return null;}},setValue:function(value){this.inputFrom.setValue(value.from);this.inputTo.setValue(value.to);},_getHeight:function(){return this.height;}});Ext.ns(&quot;sitools.widget&quot;);sitools.widget.FiltersCollection=Ext.extend(Ext.util.MixedCollection,{constructor:function(config){sitools.widget.FiltersCollection.superclass.constructor.call(this);this.addAll(config.filters);},getFilterData:function(){var filters=[];this.each(function(filter,index,length){filters.push(filter);});return filters;}});Ext.ns('Ext.ux.grid');Ext.ux.grid.RowExpander=Ext.extend(Ext.util.Observable,{expandOnEnter:true,expandOnDblClick:true,header:'',width:20,sortable:false,fixed:true,hideable:false,menuDisabled:true,dataIndex:'',id:'expander',lazyRender:true,enableCaching:true,constructor:function(config){Ext.apply(this,config);this.addEvents({beforeexpand:true,expand:true,beforecollapse:true,collapse:true});Ext.ux.grid.RowExpander.superclass.constructor.call(this);if(this.tpl){if(typeof this.tpl=='string'){this.tpl=new Ext.Template(this.tpl);}
this.tpl.compile();}
this.state={};this.bodyContent={};},getRowClass:function(record,rowIndex,p,ds){p.cols=p.cols-1;var content=this.bodyContent[record.id];if(!content&amp;&amp;!this.lazyRender){content=this.getBodyContent(record,rowIndex);}
if(content){p.body=content;}
return this.state[record.id]?'x-grid3-row-expanded':'x-grid3-row-collapsed';},init:function(grid){this.grid=grid;var view=grid.getView();view.getRowClass=this.getRowClass.createDelegate(this);view.enableRowBody=true;grid.on('render',this.onRender,this);grid.on('destroy',this.onDestroy,this);},onRender:function(){var grid=this.grid;var mainBody=grid.getView().mainBody;mainBody.on('mousedown',this.onMouseDown,this,{delegate:'.x-grid3-row-expander'});if(this.expandOnEnter){this.keyNav=new Ext.KeyNav(this.grid.getGridEl(),{'enter':this.onEnter,scope:this});}
if(this.expandOnDblClick){grid.on('rowdblclick',this.onRowDblClick,this);}},onDestroy:function(){if(this.keyNav){this.keyNav.disable();delete this.keyNav;}
var mainBody=this.grid.getView().mainBody;if(mainBody){mainBody.un('mousedown',this.onMouseDown,this);}},onRowDblClick:function(grid,rowIdx,e){this.toggleRow(rowIdx);},onEnter:function(e){var g=this.grid;var sm=g.getSelectionModel();var sels=sm.getSelections();for(var i=0,len=sels.length;i&lt;len;i++){var rowIdx=g.getStore().indexOf(sels[i]);this.toggleRow(rowIdx);}},getBodyContent:function(record,index){if(!this.enableCaching){return this.tpl.apply(record.data);}
var content=this.bodyContent[record.id];if(!content){content=this.tpl.apply(record.data);this.bodyContent[record.id]=content;}
return content;},onMouseDown:function(e,t){e.stopEvent();var row=e.getTarget('.x-grid3-row');this.toggleRow(row);},renderer:function(v,p,record){p.cellAttr='rowspan=&quot;2&quot;';return'&lt;div class=&quot;x-grid3-row-expander&quot;&gt;&amp;#160;&lt;/div&gt;';},beforeExpand:function(record,body,rowIndex){if(this.fireEvent('beforeexpand',this,record,body,rowIndex)!==false){if(this.tpl&amp;&amp;this.lazyRender){body.innerHTML=this.getBodyContent(record,rowIndex);}
return true;}else{return false;}},toggleRow:function(row){if(typeof row=='number'){row=this.grid.view.getRow(row);}
this[Ext.fly(row).hasClass('x-grid3-row-collapsed')?'expandRow':'collapseRow'](row);},expandRow:function(row){if(typeof row=='number'){row=this.grid.view.getRow(row);}
var record=this.grid.store.getAt(row.rowIndex);var body=Ext.DomQuery.selectNode('tr:nth(2) div.x-grid3-row-body',row);if(this.beforeExpand(record,body,row.rowIndex)){this.state[record.id]=true;Ext.fly(row).replaceClass('x-grid3-row-collapsed','x-grid3-row-expanded');this.fireEvent('expand',this,record,body,row.rowIndex);}},collapseRow:function(row){if(typeof row=='number'){row=this.grid.view.getRow(row);}
var record=this.grid.store.getAt(row.rowIndex);var body=Ext.fly(row).child('tr:nth(1) div.x-grid3-row-body',true);if(this.fireEvent('beforecollapse',this,record,body,row.rowIndex)!==false){this.state[record.id]=false;Ext.fly(row).replaceClass('x-grid3-row-expanded','x-grid3-row-collapsed');this.fireEvent('collapse',this,record,body,row.rowIndex);}}});Ext.preg('rowexpander',Ext.ux.grid.RowExpander);Ext.grid.RowExpander=Ext.ux.grid.RowExpander;Ext.namespace('sitools.widget');sitools.widget.Box=Ext.extend(Ext.Panel,{width:'98%',frame:true,baseCls:'x-box',cls:'x-box-blue module-root centering',_title:'',constructor:function(cfg){sitools.widget.Box.superclass.constructor.call(this,Ext.apply({_title:cfg.label,_idItem:cfg.idItem},cfg));},initComponent:function(){this.items.unshift({xtype:'component',html:this._title,cls:'subtitle icon-'+this.idItem});sitools.widget.Box.superclass.initComponent.call(this);}});Ext.reg('s-box',sitools.widget.Box);sitools.widget.JsonStore=Ext.extend(Ext.data.JsonStore,{dirty:false,_setDirty:function(value){this.dirty=value;},_getDirty:function(){return this.dirty;},add:function(records){this.dirty=true;sitools.widget.JsonStore.superclass.add.call(this,records);},remove:function(record){this.dirty=true;sitools.widget.JsonStore.superclass.remove.call(this,record);}});sitools.widget.menuButton=Ext.extend(Ext.Button,{constructor:function(config){config=Ext.apply({iconCls:'menu-button'},config);sitools.widget.menuButton.superclass.constructor.call(this,config);}});Ext.reg('s-menuButton',sitools.widget.menuButton);sitools.widget.templateTreeNode=function(attributes){var tpl;if(attributes.tpl===undefined){tpl=new Ext.Template(&quot;&lt;div &gt;{text}&lt;b&gt;{nbRecords} records&lt;/b&gt;&lt;img src='{urlImage}'&gt;&lt;/img&gt;&lt;a style='text-align:right' href='{urlReadme}'&gt;readme&lt;/a&gt;&lt;/div&gt;&quot;);}else{tpl=attributes.tpl;}
attributes.text=tpl.apply(attributes);attributes.leaf=false;var config=Ext.apply({children:[]},attributes);sitools.widget.templateTreeNode.superclass.constructor.call(this,config);};Ext.extend(sitools.widget.templateTreeNode,Ext.tree.AsyncTreeNode,{});Ext.tree.TreePanel.nodeTypes.templateTreeNode=sitools.widget.templateTreeNode;sitools.widget.sortersTool=Ext.extend(Ext.Window,{initComponent:function(){var dataCombo=[[&quot;&quot;,&quot;&quot;]];var columns;if(!Ext.isEmpty(this.columnModel.columns)){var columns=this.columnModel.columns;}
else{columns=this.columnModel;}
Ext.each(columns,function(column){dataCombo.push([column.columnAlias,column.header]);});this.storeCombo=new Ext.data.ArrayStore({fields:[&quot;dataIndex&quot;,&quot;columnHeader&quot;],data:dataCombo});this.f=new Ext.form.FormPanel({padding:5});var sorters=this.store.getSortState(),len;if(!Ext.isEmpty(sorters)){if(Ext.isArray(sorters.sorters)){this.sorters=sorters.sorters;}
else{this.sorters=[sorters];}
len=this.sorters.length;}
else{this.sorter=[];len=3;}
for(var i=0;i&lt;len;i++){var compositeField=this.buildCompositeField(i);this.f.add(compositeField);}
Ext.apply(this,{title:i18n.get(&quot;label.multiSort&quot;),autoScroll:true,width:400,modal:true,items:[this.f],buttons:[{text:i18n.get('label.add'),scope:this,handler:this.onAdd},{text:i18n.get('label.remove'),scope:this,handler:this.onRemove},{text:i18n.get('label.ok'),scope:this,handler:this.onValidate},{text:i18n.get('label.cancel'),scope:this,handler:function(){this.close();}}]});sitools.widget.sortersTool.superclass.initComponent.call(this);},onValidate:function(){var sorters=[];Ext.each(this.f.items.items,function(compositeField){if(!Ext.isEmpty(compositeField.items.items[0].getValue())){sorters.push({field:compositeField.items.items[0].getValue(),direction:compositeField.items.items[1].getValue().getGroupValue()});}},this);if(sorters.length&lt;1){this.close();return;}
else if(sorters.length==1){this.store.sort(sorters[0].field,sorters[0].direction);}
else{this.store.sort(sorters);}
this.close();},buildCompositeField:function(i){var combo=new Ext.form.ComboBox({typeAhead:true,name:&quot;field&quot;+1,triggerAction:'all',lazyRender:true,mode:'local',store:this.storeCombo,valueField:'dataIndex',displayField:'columnHeader',flex:0.6});var direction=new Ext.form.RadioGroup({fieldLabel:i18n.get('label.direction'),flex:0.4,value:'ASC',items:[{boxLabel:'ASC',name:'direction'+i,inputValue:'ASC'},{boxLabel:'DESC',name:'direction'+i,inputValue:'DESC'}]});var compositeField=new Ext.form.CompositeField({labelWidth:100,anchor:'100%',fieldLabel:i18n.get('label.sortingOrder'),items:[combo,direction]});return compositeField;},onAdd:function(){var i=this.f.items.length;var compositeField=this.buildCompositeField(i);this.f.add(compositeField);this.f.doLayout();this.doLayout();},onRemove:function(){var i=this.f.items.length-1;if(i&lt;0){return;}
this.f.remove(this.f.getComponent(i));this.f.doLayout();this.doLayout();},afterRender:function(){sitools.widget.sortersTool.superclass.afterRender.call(this);this.setPosition(this.pos);var i=0;Ext.each(this.sorters,function(sorter){var compositeField=this.f.getComponent(i);compositeField.items.items[0].setValue(sorter.field);compositeField.items.items[1].setValue(sorter.direction);i++;},this);}});Ext.reg('sitools.widget.sortersTool',sitools.widget.sortersTool);sitools.widget.filterTool=Ext.extend(Ext.Window,{paramPrefix:'filter',initComponent:function(){var dataCombo=[[&quot;&quot;,&quot;&quot;]];var columns;if(!Ext.isEmpty(this.columnModel.columns)){var columns=this.columnModel.columns;}
else{columns=this.columnModel;}
Ext.each(columns,function(column){dataCombo.push({columnAlias:column.columnAlias,columnHeader:column.header,columnType:sql2ext.get(column.sqlColumnType)});});this.storeCombo=new Ext.data.JsonStore({fields:[&quot;columnAlias&quot;,&quot;columnHeader&quot;,&quot;columnType&quot;],data:dataCombo});this.f=new Ext.Panel();this.filters=this.store.filtersCfg;var len;if(!Ext.isEmpty(this.filters)){len=this.filters.length;}
else{this.filters=[];len=3;}
for(var i=0;i&lt;len;i++){var compositeField=this.buildCompositeField(i);this.f.add(compositeField);}
Ext.apply(this,{title:i18n.get(&quot;label.filter&quot;),autoScroll:true,width:400,modal:true,items:[this.f],buttons:[{text:i18n.get('label.add'),scope:this,handler:this.onAdd},{text:i18n.get('label.remove'),scope:this,handler:this.onRemove},{text:i18n.get('label.ok'),scope:this,handler:this.onValidate},{text:i18n.get('label.cancel'),scope:this,handler:function(){this.close();}}]});sitools.widget.sortersTool.superclass.initComponent.call(this);},getCompositeField:function(index){return this.f.items.items[index];},onValidate:function(){if(Ext.isEmpty(this.store.filters)){this.store.filters=new sitools.widget.FiltersCollection();}
this.store.filters.clear();var filters=[];var filtersCfg=[];var i=0;var store=this.store;Ext.each(this.f.items.items,function(compositeField){if(!Ext.isEmpty(compositeField.items.items[0].getValue())){var filterCmp=compositeField.findBy(function(cmp){return cmp.specificType==&quot;filter&quot;;});var filterValue;if(!Ext.isEmpty(filterCmp)&amp;&amp;!Ext.isEmpty(filterCmp[0])){var filter=filterCmp[0];filterValue=filter.getValue();Ext.each(filterValue,function(filterValueItem){store.filters.add(i++,filterValueItem);if(!Ext.isEmpty(filterValueItem)){filters.push(filterValueItem);}});if(!Ext.isEmpty(filter.getConfig())){filtersCfg.push(filter.getConfig());}}}},this);this.store.filtersCfg=filtersCfg;var options=this.store.lastOptions||{};options.params=options.params||{};this.cleanParams(options.params);this.store.isNewFilter=true;this.store.load(options);this.close();},cleanParams:function(p){if(this.encode){delete p[this.paramPrefix];}else{var regex,key;regex=new RegExp('^'+this.paramPrefix+'\[[0-9]+\]');for(key in p){if(regex.test(key)){delete p[key];}}}},buildCompositeField:function(i){var combo=new Ext.form.ComboBox({index:i,typeAhead:true,name:&quot;field&quot;+1,triggerAction:'all',lazyRender:true,mode:'local',store:this.storeCombo,valueField:'columnAlias',displayField:'columnHeader',flex:0.4,listeners:{&quot;select&quot;:function(combo,rec,index){if(Ext.isEmpty(rec.data.columnAlias)){return;}
var compositeField=combo.ownerCt;var containerFilter=compositeField.items.items[1];containerFilter.removeAll();switch(rec.data.columnType){case(&quot;numeric&quot;):var filter=new sitools.widget.NumericFilter({columnAlias:rec.data.columnAlias});containerFilter.add(filter);compositeField.setHeight(filter._getHeight());containerFilter.setHeight(filter._getHeight());break;case(&quot;string&quot;):var filter=new sitools.widget.StringFilter({columnAlias:rec.data.columnAlias});containerFilter.add(filter);compositeField.setHeight(filter._getHeight());containerFilter.setHeight(filter._getHeight());break;case(&quot;dateAsString&quot;):var filter=new sitools.widget.DateFilter({columnAlias:rec.data.columnAlias});containerFilter.add(filter);compositeField.setHeight(filter._getHeight());containerFilter.setHeight(filter._getHeight());break;default:var filter=new sitools.widget.StringFilter({columnAlias:rec.data.columnAlias});containerFilter.add(filter);compositeField.setHeight(filter._getHeight());containerFilter.setHeight(filter._getHeight());break;}}}});var filter=new Ext.Container({flex:0.6});var compositeField=new Ext.Container({layout:&quot;hbox&quot;,items:[combo,filter],style:{padding:'5px'}});return compositeField;},onAdd:function(){var i=this.f.items.length;var compositeField=this.buildCompositeField(i);this.f.add(compositeField);this.f.doLayout();this.doLayout();},onRemove:function(){var i=this.f.items.length-1;if(i&lt;0){return;}
this.f.remove(this.f.getComponent(i));this.f.doLayout();this.doLayout();},afterRender:function(){sitools.widget.sortersTool.superclass.afterRender.call(this);this.setPosition(this.pos);var i=0;Ext.each(this.filters,function(filter){var compositeField=this.f.getComponent(i);this.updateFilterUI(compositeField,filter);i++;},this);},updateFilterUI:function(container,filter){var combo=container.items.items[0];var store=combo.getStore();var index=store.find(&quot;columnAlias&quot;,filter.columnAlias);if(index)
var rec=store.getAt(index);combo.setValue(filter.columnAlias);combo.fireEvent('select',combo,rec,index);var filterCmp=container.findBy(function(cmp){return cmp.specificType==&quot;filter&quot;;});filterCmp[0].setValue(filter.value);}});Ext.reg('sitools.widget.sortersTool',sitools.widget.sortersTool);sitools.widget.GridSorterToolbar=Ext.extend(Ext.Toolbar,{initComponent:function(){sitools.widget.GridSorterToolbar.superclass.initComponent.call(this);this.add('-&gt;',new sitools.widget.GridTop({gridId:this.gridId}),new sitools.widget.GridUp({gridId:this.gridId}),new sitools.widget.GridDown({gridId:this.gridId}),new sitools.widget.GridBottom({gridId:this.gridId}));}});Ext.reg('sitools.widget.GridSorterToolbar',sitools.widget.GridSorterToolbar);sitools.widget.ViolationRowExpander=Ext.extend(Ext.ux.grid.RowExpander,{getRowClass:function(record,index,rowParams,store){var cls=sitools.widget.ViolationRowExpander.superclass.getRowClass.call(this,record,index,rowParams,store);var violation=record.get(&quot;violation&quot;);if(!Ext.isEmpty(violation)){if(violation.level==&quot;CRITICAL&quot;){cls+=&quot; red-row&quot;;}else if(violation.level==&quot;WARNING&quot;){cls+=&quot; orange-row&quot;;}}
return cls;}});Ext.reg('sitools.widget.ViolationRowExpander',sitools.widget.ViolationRowExpander);sitools.widget.colorField=Ext.extend(Ext.form.TriggerField,{onTriggerClick:function(e){var cp=new Ext.menu.ColorMenu({scope:this,handler:function(cm,color){this.setValue(&quot;#&quot;+color);this.setFontColor(&quot;#&quot;+color);this.fireEvent(&quot;select&quot;,this,color);}});cp.showAt(e.getXY());},setFontColor:function(color){var h2d=function(d){return parseInt(d,16);};var value=[h2d(color.slice(1,3)),h2d(color.slice(3,5)),h2d(color.slice(5))];var avg=(value[0]+value[1]+value[2])/3;this.el.setStyle({'color':(avg&gt;128)?'#000':'#FFF','background-color':color,'background-image':&quot;none&quot;});},listeners:{afterrender:function(tf){tf.setFontColor(tf.getValue());}}})
sitools.widget.DateFieldWithToday=Ext.extend(Ext.form.DateField,{regToday:new RegExp(&quot;^\{\\$TODAY\}&quot;),invalidTextWithToday:&quot;Impossible to make a date with {0}. A valid example is {$TODAY} + 1&quot;,parseDate:function(value){if(!value||Ext.isDate(value)){return value;}
if(this.regToday.test(value)){return value;}
var v=this.safeParse(value,this.format),af=this.altFormats,afa=this.altFormatsArray;if(!v&amp;&amp;af){afa=afa||af.split(&quot;|&quot;);for(var i=0,len=afa.length;i&lt;len&amp;&amp;!v;i++){v=this.safeParse(value,afa[i]);}}
return v;},getErrors:function(value){var errors=Ext.form.DateField.superclass.getErrors.apply(this,arguments);value=this.formatDate(value||this.processValue(this.getRawValue()));if(value.length&lt;1){return errors;}
var svalue=value;var time=false;if(this.regToday.test(value)){try{value=sitools.common.utils.Date.stringWithTodayToDate(value);if(!sitools.common.utils.Date.isValidDate(value)){throw&quot;&quot;;}}
catch(err){errors.push(String.format(this.invalidTextWithToday,svalue));return errors;}}
else{value=this.parseDate(value);}
if(!value){errors.push(String.format(this.invalidText,svalue,this.format));return errors;}
time=value.getTime();if(this.minValue&amp;&amp;time&lt;this.minValue.clearTime().getTime()){errors.push(String.format(this.minText,this.formatDate(this.minValue)));}
if(this.maxValue&amp;&amp;time&gt;this.maxValue.clearTime().getTime()){errors.push(String.format(this.maxText,this.formatDate(this.maxValue)));}
if(this.disabledDays){var day=value.getDay();for(var i=0;i&lt;this.disabledDays.length;i++){if(day===this.disabledDays[i]){errors.push(this.disabledDaysText);break;}}}
var fvalue=this.formatDate(value);if(this.disabledDatesRE&amp;&amp;this.disabledDatesRE.test(fvalue)){errors.push(String.format(this.disabledDatesText,fvalue));}
return errors;},setValue:function(date){if(this.regToday.test(date)){return Ext.form.DateField.superclass.setValue.call(this,date);}
else{return Ext.form.DateField.superclass.setValue.call(this,this.formatDate(this.parseDate(date)));}}});sitools.widget.rootTreeLoader=Ext.extend(Ext.tree.TreeLoader,{createNode:function(attr){if(Ext.isEmpty(attr.children)){attr.leaf=true;}
return Ext.tree.TreeLoader.prototype.createNode.call(this,attr);},processResponse:function(response,node,callback,scope){var json=response.responseText,children,newNode,i=0,len;try{if(!(children=response.responseData)){children=Ext.decode(json);if(this.root){if(!this.getRoot){this.getRoot=Ext.data.JsonReader.prototype.createAccessor(this.root);}
children=this.getRoot(children);}}
node.beginUpdate();for(len=children.length;i&lt;len;i++){newNode=this.createNode(children[i]);if(newNode){node.appendChild(newNode);}}
node.endUpdate();this.runCallback(callback,scope||node,[node]);}catch(e){this.handleFailure(response);}},setUrl:function(url){this.url=url;}});Ext.ns(&quot;sitools.common.forms&quot;);sitools.common.forms.formParameterToComponent=function(parameter,dataUrl,formId,datasetCm,context){var valuesToSelect=null;this.component=null;var value,values,items,i,component,defaultValues,existsWidgetForParameterCode,selectedValue,minValue,maxValue,disabledDates;var constructor=eval(parameter.jsUserObject);component=new constructor({parameterId:parameter.id,values:Ext.isArray(parameter.values)?parameter.values:[],code:parameter.code,type:parameter.type,label:parameter.label,height:parameter.height,widthBox:parameter.width,valueSelection:parameter.valueSelection,parentParam:parameter.parentParam,dataUrl:dataUrl,autoComplete:parameter.autoComplete,formId:formId,dimensionId:parameter.dimensionId,unit:parameter.unit,css:parameter.css,defaultValues:parameter.defaultValues,extraParams:parameter.extraParams,datasetCm:datasetCm,context:context});return{parameter:parameter,component:component};};Ext.namespace('sitools.common.forms');sitools.common.forms.DatasetContext=function(){this.context=&quot;dataset&quot;;this.getRefUnit=function(scope){var columnAlias=scope.code[0];if(Ext.isEmpty(scope.datasetCm)){return;}
var result;Ext.each(scope.datasetCm,function(column){if(column.columnAlias==columnAlias){result=column.unit;}});return result;};};Ext.namespace('sitools.common.forms');sitools.common.forms.ProjectContext=function(){this.context=&quot;project&quot;;this.getRefUnit=function(scope){return scope.unit;};};Ext.namespace('sitools.common.forms');sitools.common.forms.ComponentFactory=function(context){if(context==&quot;dataset&quot;){return new sitools.common.forms.DatasetContext();}
if(context==&quot;project&quot;){return new sitools.common.forms.ProjectContext();}};Ext.ns('sitools.common.forms');sitools.common.forms.AbstractWithUnit=Ext.extend(Ext.Container,{dimensionId:null,userUnit:null,userDimension:null,initComponent:function(){this.userDimension=this.dimensionId;this.userUnit=this.unit;this.storeUnits=new Ext.data.JsonStore({id:'storeUnitSelect',root:'dimension.units',idProperty:'id',fields:[{name:'unitName',type:'string'},{name:'label',type:'string'}]});sitools.common.forms.AbstractWithUnit.superclass.initComponent.call(this);},loadUnits:function(event){if(!this.unitsLoaded){this.storeUnits.removeAll();Ext.Ajax.request({method:&quot;GET&quot;,url:loadUrl.get('APP_URL')+loadUrl.get('APP_DIMENSIONS_ADMIN_URL')+'/dimension/'+this.dimensionId,scope:this,success:function(ret){var Json=Ext.decode(ret.responseText);if(!Json.success){Ext.Msg.alert(i18n.get('label.warning'),Json.message);return;}
var units=Json.dimension.sitoolsUnits;this.dimensionName=Json.dimension.name;for(var i=0;i&lt;units.length;i++){this.storeUnits.add(new Ext.data.Record(units[i]));}},failure:alertFailure,callback:function(){this.unitsLoaded=true;this.showWinUnits(event);}});}
else{this.showWinUnits(event);}},showWinUnits:function(event){var cmUnits=new Ext.grid.ColumnModel({columns:[{header:i18n.get('headers.name'),dataIndex:'label',width:100}],defaults:{sortable:true,width:100}});var smUnits=new Ext.grid.RowSelectionModel({singleSelect:true});this.gridUnits=new Ext.grid.GridPanel({autoScroll:true,store:this.storeUnits,cm:cmUnits,sm:smUnits,layout:'fit',listeners:{scope:this,rowClick:function(grid,rowIndex){this.onValidateUnits();}}});var winUnit=new Ext.Window({layout:'fit',width:200,title:i18n.get('title.unitList'),modal:true,height:300,items:[this.gridUnits],buttons:[{text:i18n.get('label.ok'),handler:this.onValidateUnits,scope:this},{text:i18n.get('label.cancel'),scope:winUnit,handler:function(){this.ownerCt.ownerCt.close();}}]});winUnit.show();winUnit.setPosition(event.getXY()[0],event.getXY()[1]);},onValidateUnits:function(){var rec=this.gridUnits.getSelectionModel().getSelected();if(Ext.isEmpty(rec)){Ext.Msg.alert(i18n.get('label.error'),i18n.get('label.noSelection'));return;}
this.userUnit=rec.data;this.userDimension=this.dimensionName;var btn=this.getEl().query(&quot;button&quot;)[0];if(!Ext.isEmpty(btn)){this.getEl().query(&quot;button&quot;)[0].update(rec.get('label'));}
this.gridUnits.ownerCt.close();},getUnitComponent:function(){var columnUnit=this.context.getRefUnit(this);if(!Ext.isEmpty(this.dimensionId)){var btn=new Ext.Button({scope:this,text:Ext.isEmpty(columnUnit)?&quot;    &quot;:columnUnit.label,width:90,handler:function(b,e){this.loadUnits(e);}});unit=new Ext.Container({layout:&quot;hbox&quot;,layoutConfig:{pack:&quot;center&quot;,align:&quot;middle&quot;},margins:{top:0,right:0,bottom:0,left:10},width:100,items:[btn]});}
else{if(!Ext.isEmpty(columnUnit)){unit=new Ext.Container({html:columnUnit.label,margins:{top:0,right:0,bottom:0,left:10},flex:1});}
else{unit=null;}}
return unit;}});Ext.namespace('Ext.ux.plugin');Ext.onReady(function(){var CSS=Ext.util.CSS;if(CSS){CSS.getRule('.x-hide-nosize')||CSS.createStyleSheet('.x-hide-nosize{height:0px!important;width:0px!important;border:none!important;zoom:1;}.x-hide-nosize * {height:0px!important;width:0px!important;border:none!important;zoom:1;}');CSS.refreshCache();}});(function(){var El=Ext.Element,A=Ext.lib.Anim,supr=El.prototype;var VISIBILITY=&quot;visibility&quot;,DISPLAY=&quot;display&quot;,HIDDEN=&quot;hidden&quot;,NONE=&quot;none&quot;;var fx={};fx.El={setDisplayed:function(value){var me=this;me.visibilityCls?(me[value!==false?'removeClass':'addClass'](me.visibilityCls)):supr.setDisplayed.call(me,value);return me;},isDisplayed:function(){return!(this.hasClass(this.visibilityCls)||this.isStyle(DISPLAY,NONE));},fixDisplay:function(){var me=this;supr.fixDisplay.call(me);me.visibilityCls&amp;&amp;me.removeClass(me.visibilityCls);},isVisible:function(deep){var vis=this.visible||(!this.isStyle(VISIBILITY,HIDDEN)&amp;&amp;(this.visibilityCls?!this.hasClass(this.visibilityCls):!this.isStyle(DISPLAY,NONE)));if(deep!==true||!vis){return vis;}
var p=this.dom.parentNode,bodyRE=/^body/i;while(p&amp;&amp;!bodyRE.test(p.tagName)){if(!Ext.fly(p,'_isVisible').isVisible()){return false;}
p=p.parentNode;}
return true;},isStyle:supr.isStyle||function(style,val){return this.getStyle(style)==val;}};Ext.override(El.Flyweight,fx.El);Ext.ux.plugin.VisibilityMode=function(opt){Ext.apply(this,opt||{});var CSS=Ext.util.CSS;if(CSS&amp;&amp;!Ext.isIE&amp;&amp;this.fixMaximizedWindow!==false&amp;&amp;!Ext.ux.plugin.VisibilityMode.MaxWinFixed){CSS.updateRule('.x-window-maximized-ct','overflow','');Ext.ux.plugin.VisibilityMode.MaxWinFixed=true;}};Ext.extend(Ext.ux.plugin.VisibilityMode,Object,{bubble:true,fixMaximizedWindow:true,elements:null,visibilityCls:'x-hide-nosize',hideMode:'nosize',ptype:'uxvismode',init:function(c){var hideMode=this.hideMode||c.hideMode,plugin=this,bubble=Ext.Container.prototype.bubble,changeVis=function(){var els=[this.collapseEl,this.actionMode].concat(plugin.elements||[]);Ext.each(els,function(el){plugin.extend(this[el]||el);},this);var cfg={visFixed:true,animCollapse:false,animFloat:false,hideMode:hideMode,defaults:this.defaults||{}};cfg.defaults.hideMode=hideMode;Ext.apply(this,cfg);Ext.apply(this.initialConfig||{},cfg);};c.on('render',function(){if(plugin.bubble!==false&amp;&amp;this.ownerCt){bubble.call(this.ownerCt,function(){this.visFixed||this.on('afterlayout',changeVis,this,{single:true});});}
changeVis.call(this);},c,{single:true});},extend:function(el,visibilityCls){el&amp;&amp;Ext.each([].concat(el),function(e){if(e&amp;&amp;e.dom){if('visibilityCls'in e)return;Ext.apply(e,fx.El);e.visibilityCls=visibilityCls||this.visibilityCls;}},this);return this;}});Ext.preg&amp;&amp;Ext.preg('uxvismode',Ext.ux.plugin.VisibilityMode);Ext.provide&amp;&amp;Ext.provide('uxvismode');})();(function(){var El=Ext.Element,ElFrame,ELD=Ext.lib.Dom,A=Ext.lib.Anim,Evm=Ext.EventManager,E=Ext.lib.Event,DOC=document,emptyFn=function(){},OP=Object.prototype,OPString=OP.toString,HTMLDoc='[object HTMLDocument]';if(!Ext.elCache||parseInt(Ext.version.replace(/\./g,''),10)&lt;311){alert('Ext Release '+Ext.version+' is not supported');}
Ext._documents={};Ext._documents[Ext.id(document,'_doc')]=Ext.elCache;var resolveCache=ELD.resolveDocumentCache=function(el,cacheId){var doc=GETDOC(el),c=Ext.isDocument(doc)?Ext.id(doc):cacheId,cache=Ext._documents[c]||null;return cache||(c?Ext._documents[c]={}:null);},clearCache=ELD.clearDocumentCache=function(cacheId){delete Ext._documents[cacheId];};El.addMethods||(El.addMethods=function(ov){Ext.apply(El.prototype,ov||{});});Ext.removeNode=function(n){var dom=n?n.dom||n:null,el,elc,elCache=resolveCache(dom),parent;if(dom&amp;&amp;(elc=elCache[dom.id])&amp;&amp;(el=elc.el)){if(el.dom){Ext.enableNestedListenerRemoval?Evm.purgeElement(el.dom,true):Evm.removeAll(el.dom);}
delete elCache[dom.id];delete el.dom;delete el._context;el=null;}
if(dom&amp;&amp;!dom.navigator&amp;&amp;!Ext.isDocument(dom)&amp;&amp;dom.tagName!='BODY'){(parent=dom.parentElement||dom.parentNode)&amp;&amp;parent.removeChild(dom);}
dom=parent=null;};var overload=function(pfn,fn){var f=typeof pfn==='function'?pfn:function t(){};var ov=f._ovl;if(!ov){ov={base:f};ov[f.length||0]=f;f=function t(){var o=arguments.callee._ovl;var fn=o[arguments.length]||o.base;return fn&amp;&amp;fn!=arguments.callee?fn.apply(this,arguments):undefined;};}
var fnA=[].concat(fn);for(var i=0,l=fnA.length;i&lt;l;++i){ov[fnA[i].length]=fnA[i];}
f._ovl=ov;var t=null;return f;};Ext.applyIf(Ext,{overload:overload(overload,[function(fn){return overload(null,fn);},function(obj,mname,fn){return obj[mname]=overload(obj[mname],fn);}]),isArray:function(v){return!!v&amp;&amp;OPString.apply(v)=='[object Array]';},isObject:function(obj){return!!obj&amp;&amp;typeof obj=='object';},isDocument:function(el,testOrigin){var elm=el?el.dom||el:null;var test=elm&amp;&amp;((OPString.apply(elm)==HTMLDoc)||(elm&amp;&amp;elm.nodeType==9));if(test&amp;&amp;testOrigin){try{test=!!elm.location;}
catch(e){return false;}}
return test;},isWindow:function(el){var elm=el?el.dom||el:null;return elm?!!elm.navigator||OPString.apply(elm)==&quot;[object Window]&quot;:false;},isIterable:function(v){if(Ext.isArray(v)||v.callee){return true;}
if(/NodeList|HTMLCollection/.test(OPString.call(v))){return true;}
return((typeof v.nextNode!='undefined'||v.item)&amp;&amp;Ext.isNumber(v.length));},isElement:function(obj){return obj&amp;&amp;Ext.type(obj)=='element';},isEvent:function(obj){return OPString.apply(obj)=='[object Event]'||(Ext.isObject(obj)&amp;&amp;!Ext.type(o.constructor)&amp;&amp;(window.event&amp;&amp;obj.clientX&amp;&amp;obj.clientX==window.event.clientX));},isFunction:function(obj){return!!obj&amp;&amp;typeof obj=='function';},isEventSupported:function(evName,testEl){var TAGNAMES={'select':'input','change':'input','submit':'form','reset':'form','load':'img','error':'img','abort':'img'},cache={},onPrefix=/^on/i,getKey=function(type,el){var tEl=Ext.getDom(el);return(tEl?(Ext.isElement(tEl)||Ext.isDocument(tEl)?tEl.nodeName.toLowerCase():el.self?'#window':el||'#object'):el||'div')+':'+type;};return function(evName,testEl){evName=(evName||'').replace(onPrefix,'');var el,isSupported=false;var eventName='on'+evName;var tag=(testEl?testEl:TAGNAMES[evName])||'div';var key=getKey(evName,tag);if(key in cache){return cache[key];}
el=Ext.isString(tag)?DOC.createElement(tag):testEl;isSupported=(!!el&amp;&amp;(eventName in el));isSupported||(isSupported=window.Event&amp;&amp;!!(String(evName).toUpperCase()in window.Event));if(!isSupported&amp;&amp;el){el.setAttribute&amp;&amp;el.setAttribute(eventName,'return;');isSupported=Ext.isFunction(el[eventName]);}
cache[key]=isSupported;el=null;return isSupported;};}()});var assertClass=function(el){return El;return El[(el.tagName||'-').toUpperCase()]||El;};var libFlyweight;function fly(el,doc){if(!libFlyweight){libFlyweight=new Ext.Element.Flyweight();}
libFlyweight.dom=Ext.getDom(el,null,doc);return libFlyweight;}
Ext.apply(Ext,{get:El.get=function(el,doc){if(!el){return null;}
var isDoc=Ext.isDocument(el);Ext.isDocument(doc)||(doc=DOC);var ex,elm,id,cache=resolveCache(doc);if(typeof el==&quot;string&quot;){elm=Ext.getDom(el,null,doc);if(!elm)return null;if(cache[el]&amp;&amp;cache[el].el){ex=cache[el].el;ex.dom=elm;}else{ex=El.addToCache(new(assertClass(elm))(elm,null,doc));}
return ex;}else if(isDoc){if(!Ext.isDocument(el,true)){return false;}
cache=resolveCache(el);if(cache[Ext.id(el)]&amp;&amp;cache[el.id].el){return cache[el.id].el;}
var f=function(){};f.prototype=El.prototype;var docEl=new f();docEl.dom=el;docEl.id=Ext.id(el,'_doc');docEl._isDoc=true;El.addToCache(docEl,null,cache);return docEl;}else if(el instanceof El){if(el.dom){el.id=Ext.id(el.dom);}else{el.dom=el.id?Ext.getDom(el.id,true):null;}
if(el.dom){cache=resolveCache(el);(cache[el.id]||(cache[el.id]={data:{},events:{}})).el=el;}
return el;}else if(el.tagName||Ext.isWindow(el)){cache=resolveCache(el);id=Ext.id(el);if(cache[id]&amp;&amp;(ex=cache[id].el)){ex.dom=el;}else{ex=El.addToCache(new(assertClass(el))(el,null,doc),null,cache);}
return ex;}else if(el.isComposite){return el;}else if(Ext.isArray(el)){return Ext.get(doc,doc).select(el);}
return null;},getDom:function(el,strict,doc){var D=doc||DOC;if(!el||!D){return null;}
if(el.dom){return el.dom;}else{if(Ext.isString(el)){var e=D.getElementById(el);if(e&amp;&amp;Ext.isIE&amp;&amp;strict){if(el==e.getAttribute('id')){return e;}else{return null;}}
return e;}else{return el;}}},getBody:function(doc){var D=ELD.getDocument(doc)||DOC;return Ext.get(D.body||D.documentElement);},getDoc:Ext.overload([Ext.getDoc,function(doc){return Ext.get(doc,doc);}])});El.data=function(el,key,value){el=El.get(el);if(!el){return null;}
var c=resolveCache(el)[el.id].data;if(arguments.length==2){return c[key];}else{return(c[key]=value);}};El.addToCache=function(el,id,cache){id=id||Ext.id(el);var C=cache||resolveCache(el);C[id]={el:el.dom?el:Ext.get(el),data:{},events:{}};var d=C[id].el.dom;(d.getElementById||d.navigator)&amp;&amp;(C[id].skipGC=true);return C[id].el;};El.removeFromCache=function(el,cache){if(el&amp;&amp;el.id){var C=cache||resolveCache(el);delete C[el.id];}};El.ASCLASS=3;El.visibilityCls='x-hide-nosize';var propCache={},camelRe=/(-[a-z])/gi,camelFn=function(m,a){return a.charAt(1).toUpperCase();},opacityRe=/alpha\(opacity=(.*)\)/i,trimRe=/^\s+|\s+$/g,marginRightRe=/marginRight/,propFloat=Ext.isIE?'styleFloat':'cssFloat',view=DOC.defaultView,VISMODE='visibilityMode',ELDISPLAY=El.DISPLAY,ELVISIBILITY=El.VISIBILITY,ELASCLASS=El.ASCLASS,ORIGINALDISPLAY='originalDisplay',PADDING=&quot;padding&quot;,MARGIN=&quot;margin&quot;,BORDER=&quot;border&quot;,LEFT=&quot;-left&quot;,RIGHT=&quot;-right&quot;,TOP=&quot;-top&quot;,BOTTOM=&quot;-bottom&quot;,WIDTH=&quot;-width&quot;,MATH=Math,OPACITY=&quot;opacity&quot;,VISIBILITY=&quot;visibility&quot;,DISPLAY=&quot;display&quot;,OFFSETS=&quot;offsets&quot;,ASCLASS=&quot;asclass&quot;,HIDDEN=&quot;hidden&quot;,NONE=&quot;none&quot;,ISVISIBLE='isVisible',ISCLIPPED='isClipped',OVERFLOW='overflow',OVERFLOWX='overflow-x',OVERFLOWY='overflow-y',ORIGINALCLIP='originalClip',XMASKED=&quot;x-masked&quot;,XMASKEDRELATIVE=&quot;x-masked-relative&quot;,borders={l:BORDER+LEFT+WIDTH,r:BORDER+RIGHT+WIDTH,t:BORDER+TOP+WIDTH,b:BORDER+BOTTOM+WIDTH},paddings={l:PADDING+LEFT,r:PADDING+RIGHT,t:PADDING+TOP,b:PADDING+BOTTOM},margins={l:MARGIN+LEFT,r:MARGIN+RIGHT,t:MARGIN+TOP,b:MARGIN+BOTTOM},data=El.data,GETDOM=Ext.getDom,GET=Ext.get,DH=Ext.DomHelper,propRe=/^(?:scope|delay|buffer|single|stopEvent|preventDefault|stopPropagation|normalized|args|delegate)$/,CSS=Ext.util.CSS,getDisplay=function(dom){var d=data(dom,ORIGINALDISPLAY);if(d===undefined){data(dom,ORIGINALDISPLAY,d='');}
return d;},getVisMode=function(dom){var m=data(dom,VISMODE);if(m===undefined){data(dom,VISMODE,m=El.prototype.visibilityMode);}
return m;};function chkCache(prop){return propCache[prop]||(propCache[prop]=prop=='float'?propFloat:prop.replace(camelRe,camelFn));};El.addMethods({getDocument:function(){return this._context||(this._context=GETDOC(this));},remove:function(cleanse,deep){var dom=this.dom;this.isMasked()&amp;&amp;this.unmask();if(dom){Ext.removeNode(dom);delete this._context;delete this.dom;}},appendChild:function(el,doc){return GET(el,doc||this.getDocument()).appendTo(this);},appendTo:function(el,doc){GETDOM(el,false,doc||this.getDocument()).appendChild(this.dom);return this;},insertBefore:function(el,doc){(el=GETDOM(el,false,doc||this.getDocument())).parentNode.insertBefore(this.dom,el);return this;},insertAfter:function(el,doc){(el=GETDOM(el,false,doc||this.getDocument())).parentNode.insertBefore(this.dom,el.nextSibling);return this;},insertFirst:function(el,returnDom){el=el||{};if(el.nodeType||el.dom||typeof el=='string'){el=GETDOM(el);this.dom.insertBefore(el,this.dom.firstChild);return!returnDom?GET(el):el;}else{return this.createChild(el,this.dom.firstChild,returnDom);}},replace:function(el,doc){el=GET(el,doc||this.getDocument());this.insertBefore(el);el.remove();return this;},replaceWith:function(el,doc){var me=this;if(el.nodeType||el.dom||typeof el=='string'){el=GETDOM(el,false,doc||me.getDocument());me.dom.parentNode.insertBefore(el,me.dom);}else{el=DH.insertBefore(me.dom,el);}
var C=resolveCache(me);Ext.removeNode(me.dom);me.id=Ext.id(me.dom=el);El.addToCache(me.isFlyweight?new(assertClass(me.dom))(me.dom,null,C):me);return me;},insertHtml:function(where,html,returnEl){var el=DH.insertHtml(where,this.dom,html);return returnEl?Ext.get(el,GETDOC(el)):el;},setVisibilityMode:function(visMode){data(this.dom,VISMODE,visMode);return this;},isVisible:function(){return this.visible||Ext.value(data(this.dom,ISVISIBLE),!this.isStyle(VISIBILITY,HIDDEN)&amp;&amp;!this.isStyle(DISPLAY,NONE));},setVisible:function(visible,animate){var me=this,dom=me.dom,isDisplay,isVisibility,isOffsets,isClass;if(typeof animate=='string'){isDisplay=animate==DISPLAY;isVisibility=animate==VISIBILITY;isOffsets=animate==OFFSETS;isClass=animate==ASCLASS;animate=false;}else{var visMode=getVisMode(dom);isDisplay=visMode==ELDISPLAY;isVisibility=visMode==ELVISIBILITY;isClass=visMode==ELASCLASS;}
if(!animate||!me.anim){if(isClass){me[visible?'removeClass':'addClass'](me.visibilityCls||El.visibilityCls);}else if(isDisplay){return me.setDisplayed(visible);}else if(isOffsets){if(!visible){me.hideModeStyles={position:me.getStyle('position'),top:me.getStyle('top'),left:me.getStyle('left')};me.applyStyles({position:'absolute',top:'-10000px',left:'-10000px'});}else{me.applyStyles(me.hideModeStyles||{position:'',top:'',left:''});delete me.hideModeStyles;}}else{me.fixDisplay();if(dom){dom.style.visibility=visible?&quot;visible&quot;:HIDDEN;}}}else{if(visible){me.setOpacity(.01);me.setVisible(true);}
me.anim({opacity:{to:(visible?1:0)}},me.preanim(arguments,1),null,.35,'easeIn',function(){if(!visible){isClass?me.addClass(me.visibilityCls||El.visibilityCls):dom.style[isDisplay?DISPLAY:VISIBILITY]=(isDisplay)?NONE:HIDDEN;me.setOpacity(1);}});}
data(dom,ISVISIBLE,visible);return me;},setDisplayed:function(value){var dom=this.dom,visMode=getVisMode(dom);if(typeof value==&quot;boolean&quot;){if(visMode==El.ASCLASS){return this.setVisible(value,ASCLASS);}
data(this.dom,ISVISIBLE,value);value=value?getDisplay(dom):NONE;}
this.setStyle(DISPLAY,value);return this;},fixDisplay:function(){var me=this;if(me.isStyle(DISPLAY,NONE)){me.setStyle(VISIBILITY,HIDDEN);me.setStyle(DISPLAY,getDisplay(me.dom));if(me.isStyle(DISPLAY,NONE)){me.setStyle(DISPLAY,&quot;block&quot;);}}
data(me.dom,ISVISIBLE)||me.removeClass(me.visibilityCls||El.visibilityCls);},enableDisplayMode:function(display){this.setVisibilityMode(El.DISPLAY);if(!Ext.isEmpty(display)){data(this.dom,ORIGINALDISPLAY,display);}
return this;},scrollIntoView:function(container,hscroll){var d=this.getDocument(),c=Ext.getDom(container,null,d)||Ext.getBody(d).dom,el=this.dom,o=this.getOffsetsTo(c),l=o[0]+c.scrollLeft,t=o[1]+c.scrollTop,b=t+el.offsetHeight,r=l+el.offsetWidth,ch=c.clientHeight,ct=parseInt(c.scrollTop,10),cl=parseInt(c.scrollLeft,10),cb=ct+ch,cr=cl+c.clientWidth;if(el.offsetHeight&gt;ch||t&lt;ct){c.scrollTop=t;}else if(b&gt;cb){c.scrollTop=b-ch;}
c.scrollTop=c.scrollTop;if(hscroll!==false){if(el.offsetWidth&gt;c.clientWidth||l&lt;cl){c.scrollLeft=l;}else if(r&gt;cr){c.scrollLeft=r-c.clientWidth;}
c.scrollLeft=c.scrollLeft;}
return this;},contains:function(el){try{return!el?false:ELD.isAncestor(this.dom,el.dom?el.dom:el);}catch(e){return false;}},getScroll:function(){var d=this.dom,doc=this.getDocument(),body=doc.body,docElement=doc.documentElement,l,t,ret;if(Ext.isDocument(d)||d==body){if(Ext.isIE&amp;&amp;ELD.docIsStrict(doc)){l=docElement.scrollLeft;t=docElement.scrollTop;}else{l=window.pageXOffset;t=window.pageYOffset;}
ret={left:l||(body?body.scrollLeft:0),top:t||(body?body.scrollTop:0)};}else{ret={left:d.scrollLeft,top:d.scrollTop};}
return ret;},getStyle:function(){var getStyle=view&amp;&amp;view.getComputedStyle?function GS(prop){var el=!this._isDoc?this.dom:null,v,cs,out,display,wk=Ext.isWebKit,display;if(!el||!el.style)return null;prop=chkCache(prop);out=(v=el.style[prop])?v:(cs=view.getComputedStyle(el,''))?cs[prop]:null;if(wk){if((marginRightRe.test(prop))&amp;&amp;out!='0px'){display=this.getStyle('display');el.style.display='inline-block';out=view.getComputedStyle(el,'');el.style.display=display;}
if(out=='rgba(0, 0, 0, 0)'){out='transparent';}}
return out;}:function GS(prop){var el=!this._isDoc?this.dom:null,m,cs;if(!el||!el.style)return null;if(prop==OPACITY){if(el.style.filter.match){if(m=el.style.filter.match(opacityRe)){var fv=parseFloat(m[1]);if(!isNaN(fv)){return fv?fv/100:0;}}}
return 1;}
prop=chkCache(prop);return el.style[prop]||((cs=el.currentStyle)?cs[prop]:null);};var GS=null;return getStyle;}(),setStyle:function(prop,value){if(this._isDoc||Ext.isDocument(this.dom))return this;var tmp,style;if(typeof prop!='object'){tmp={};tmp[prop]=value;prop=tmp;}
for(style in prop){value=prop[style];if(style==OPACITY){this.setOpacity(value)}
else{try{this.dom.style[chkCache(style)]=value;}
catch(err){null;}}}
return this;},center:function(centerIn){return this.alignTo(centerIn||this.getDocument(),'c-c');},mask:function(msg,msgCls){var me=this,dom=me.dom,dh=Ext.DomHelper,EXTELMASKMSG=&quot;ext-el-mask-msg&quot;,el,mask;if(me.getStyle(&quot;position&quot;)==&quot;static&quot;){me.addClass(XMASKEDRELATIVE);}
if((el=data(dom,'maskMsg'))){el.remove();}
if((el=data(dom,'mask'))){el.remove();}
mask=dh.append(dom,{cls:&quot;ext-el-mask&quot;},true);data(dom,'mask',mask);me.addClass(XMASKED);mask.setDisplayed(true);if(typeof msg=='string'){var mm=dh.append(dom,{cls:EXTELMASKMSG,cn:{tag:'div'}},true);data(dom,'maskMsg',mm);mm.dom.className=msgCls?EXTELMASKMSG+&quot; &quot;+msgCls:EXTELMASKMSG;mm.dom.firstChild.innerHTML=msg;mm.setDisplayed(true);mm.center(me);}
if(Ext.isIE&amp;&amp;!(Ext.isIE7&amp;&amp;Ext.isStrict)&amp;&amp;me.getStyle('height')=='auto'){mask.setSize(undefined,me.getHeight());}
return mask;},unmask:function(){var me=this,dom=me.dom,mask=data(dom,'mask'),maskMsg=data(dom,'maskMsg');if(mask){if(maskMsg){maskMsg.remove();data(dom,'maskMsg',undefined);}
mask.remove();data(dom,'mask',undefined);}
me.removeClass([XMASKED,XMASKEDRELATIVE]);},isMasked:function(){var m=data(this.dom,'mask');return m&amp;&amp;m.isVisible();},getCenterXY:function(){return this.getAlignToXY(this.getDocument(),'c-c');},getAnchorXY:function(anchor,local,s){anchor=(anchor||&quot;tl&quot;).toLowerCase();s=s||{};var me=this,doc=this.getDocument(),vp=me.dom==doc.body||me.dom==doc,w=s.width||vp?ELD.getViewWidth(false,doc):me.getWidth(),h=s.height||vp?ELD.getViewHeight(false,doc):me.getHeight(),xy,r=Math.round,o=me.getXY(),scroll=me.getScroll(),extraX=vp?scroll.left:!local?o[0]:0,extraY=vp?scroll.top:!local?o[1]:0,hash={c:[r(w*.5),r(h*.5)],t:[r(w*.5),0],l:[0,r(h*.5)],r:[w,r(h*.5)],b:[r(w*.5),h],tl:[0,0],bl:[0,h],br:[w,h],tr:[w,0]};xy=hash[anchor];return[xy[0]+extraX,xy[1]+extraY];},anchorTo:function(el,alignment,offsets,animate,monitorScroll,callback){var me=this,dom=me.dom;function action(){fly(dom).alignTo(el,alignment,offsets,animate);Ext.callback(callback,fly(dom));};Ext.EventManager.onWindowResize(action,me);if(!Ext.isEmpty(monitorScroll)){Ext.EventManager.on(window,'scroll',action,me,{buffer:!isNaN(monitorScroll)?monitorScroll:50});}
action.call(me);return me;},getScroll:function(){var d=this.dom,doc=this.getDocument(),body=doc.body,docElement=doc.documentElement,l,t,ret;if(d==doc||d==body){if(Ext.isIE&amp;&amp;ELD.docIsStrict(doc)){l=docElement.scrollLeft;t=docElement.scrollTop;}else{l=window.pageXOffset;t=window.pageYOffset;}
ret={left:l||(body?body.scrollLeft:0),top:t||(body?body.scrollTop:0)};}else{ret={left:d.scrollLeft,top:d.scrollTop};}
return ret;},getAlignToXY:function(el,p,o){var doc;el=Ext.get(el,doc=this.getDocument());if(!el||!el.dom){throw&quot;Element.getAlignToXY with an element that doesn't exist&quot;;}
o=o||[0,0];p=(p==&quot;?&quot;?&quot;tl-bl?&quot;:(!/-/.test(p)&amp;&amp;p!=&quot;&quot;?&quot;tl-&quot;+p:p||&quot;tl-bl&quot;)).toLowerCase();var me=this,d=me.dom,a1,a2,x,y,w,h,r,dw=ELD.getViewWidth(false,doc)-10,dh=ELD.getViewHeight(false,doc)-10,p1y,p1x,p2y,p2x,swapY,swapX,docElement=doc.documentElement,docBody=doc.body,scrollX=(docElement.scrollLeft||docBody.scrollLeft||0)+5,scrollY=(docElement.scrollTop||docBody.scrollTop||0)+5,c=false,p1=&quot;&quot;,p2=&quot;&quot;,m=p.match(/^([a-z]+)-([a-z]+)(\?)?$/);if(!m){throw&quot;Element.getAlignToXY with an invalid alignment &quot;+p;}
p1=m[1];p2=m[2];c=!!m[3];a1=me.getAnchorXY(p1,true);a2=el.getAnchorXY(p2,false);x=a2[0]-a1[0]+o[0];y=a2[1]-a1[1]+o[1];if(c){w=me.getWidth();h=me.getHeight();r=el.getRegion();p1y=p1.charAt(0);p1x=p1.charAt(p1.length-1);p2y=p2.charAt(0);p2x=p2.charAt(p2.length-1);swapY=((p1y==&quot;t&quot;&amp;&amp;p2y==&quot;b&quot;)||(p1y==&quot;b&quot;&amp;&amp;p2y==&quot;t&quot;));swapX=((p1x==&quot;r&quot;&amp;&amp;p2x==&quot;l&quot;)||(p1x==&quot;l&quot;&amp;&amp;p2x==&quot;r&quot;));if(x+w&gt;dw+scrollX){x=swapX?r.left-w:dw+scrollX-w;}
if(x&lt;scrollX){x=swapX?r.right:scrollX;}
if(y+h&gt;dh+scrollY){y=swapY?r.top-h:dh+scrollY-h;}
if(y&lt;scrollY){y=swapY?r.bottom:scrollY;}}
return[x,y];},adjustForConstraints:function(xy,parent,offsets){return this.getConstrainToXY(parent||this.getDocument(),false,offsets,xy)||xy;},getConstrainToXY:function(el,local,offsets,proposedXY){var os={top:0,left:0,bottom:0,right:0};return function(el,local,offsets,proposedXY){var doc=this.getDocument();el=Ext.get(el,doc);offsets=offsets?Ext.applyIf(offsets,os):os;var vw,vh,vx=0,vy=0;if(el.dom==doc.body||el.dom==doc){vw=ELD.getViewWidth(false,doc);vh=ELD.getViewHeight(false,doc);}else{vw=el.dom.clientWidth;vh=el.dom.clientHeight;if(!local){var vxy=el.getXY();vx=vxy[0];vy=vxy[1];}}
var s=el.getScroll();vx+=offsets.left+s.left;vy+=offsets.top+s.top;vw-=offsets.right;vh-=offsets.bottom;var vr=vx+vw,vb=vy+vh,xy=proposedXY||(!local?this.getXY():[this.getLeft(true),this.getTop(true)]);x=xy[0],y=xy[1],offset=this.getConstrainOffset(),w=this.dom.offsetWidth+offset,h=this.dom.offsetHeight+offset;var moved=false;if((x+w)&gt;vr){x=vr-w;moved=true;}
if((y+h)&gt;vb){y=vb-h;moved=true;}
if(x&lt;vx){x=vx;moved=true;}
if(y&lt;vy){y=vy;moved=true;}
return moved?[x,y]:false;};}(),getConstrainOffset:function(){return 0;},getCenterXY:function(){return this.getAlignToXY(Ext.getBody(this.getDocument()),'c-c');},center:function(centerIn){return this.alignTo(centerIn||Ext.getBody(this.getDocument()),'c-c');},findParent:function(simpleSelector,maxDepth,returnEl){var p=this.dom,D=this.getDocument(),b=D.body,depth=0,stopEl;if(Ext.isGecko&amp;&amp;OPString.call(p)=='[object XULElement]'){return null;}
maxDepth=maxDepth||50;if(isNaN(maxDepth)){stopEl=Ext.getDom(maxDepth,null,D);maxDepth=Number.MAX_VALUE;}
while(p&amp;&amp;p.nodeType==1&amp;&amp;depth&lt;maxDepth&amp;&amp;p!=b&amp;&amp;p!=stopEl){if(Ext.DomQuery.is(p,simpleSelector)){return returnEl?Ext.get(p,D):p;}
depth++;p=p.parentNode;}
return null;},clip:function(){var me=this,dom=me.dom;if(!data(dom,ISCLIPPED)){data(dom,ISCLIPPED,true);data(dom,ORIGINALCLIP,{o:me.getStyle(OVERFLOW),x:me.getStyle(OVERFLOWX),y:me.getStyle(OVERFLOWY)});me.setStyle(OVERFLOW,HIDDEN);me.setStyle(OVERFLOWX,HIDDEN);me.setStyle(OVERFLOWY,HIDDEN);}
return me;},unclip:function(){var me=this,dom=me.dom;if(data(dom,ISCLIPPED)){data(dom,ISCLIPPED,false);var o=data(dom,ORIGINALCLIP);if(o.o){me.setStyle(OVERFLOW,o.o);}
if(o.x){me.setStyle(OVERFLOWX,o.x);}
if(o.y){me.setStyle(OVERFLOWY,o.y);}}
return me;},getViewSize:function(){var doc=this.getDocument(),d=this.dom,isDoc=(d==doc||d==doc.body);if(isDoc){var extdom=Ext.lib.Dom;return{width:extdom.getViewWidth(),height:extdom.getViewHeight()};}else{return{width:d.clientWidth,height:d.clientHeight};}},getStyleSize:function(){var me=this,w,h,doc=this.getDocument(),d=this.dom,isDoc=(d==doc||d==doc.body),s=d.style;if(isDoc){var extdom=Ext.lib.Dom;return{width:extdom.getViewWidth(),height:extdom.getViewHeight()};}
if(s.width&amp;&amp;s.width!='auto'){w=parseFloat(s.width);if(me.isBorderBox()){w-=me.getFrameWidth('lr');}}
if(s.height&amp;&amp;s.height!='auto'){h=parseFloat(s.height);if(me.isBorderBox()){h-=me.getFrameWidth('tb');}}
return{width:w||me.getWidth(true),height:h||me.getHeight(true)};}});Ext.isDefined(El.collectorThreadId)&amp;&amp;clearInterval(El.collectorThreadId);function garbageCollect(){if(!Ext.enableGarbageCollector){clearInterval(El.collectorThreadId);}else{var eid,el,d,o,EC=Ext.elCache;for(eid in EC){o=EC[eid];if(o.skipGC){continue;}
el=o.el;d=el.dom;if(!d||!d.parentNode||(!d.offsetParent&amp;&amp;!DOC.getElementById(eid))){if(Ext.enableListenerCollection){Ext.EventManager.removeAll(d);}
delete EC[eid];}}
if(Ext.isIE){var t={};for(eid in EC){t[eid]=EC[eid];}
Ext.elCache=Ext._documents[Ext.id(document)]=t;t=null;}}}
if(Ext.enableGarbageCollector){El.collectorThreadId=setInterval(garbageCollect,30000);}
Ext.apply(ELD,{getDocument:function(el,accessTest){var dom=null;try{dom=Ext.getDom(el,null,null);}catch(ex){}
var isDoc=Ext.isDocument(dom);if(isDoc){if(accessTest){return Ext.isDocument(dom,accessTest)?dom:null;}
return dom;}
return dom?dom.ownerDocument||dom.document:null;},docIsStrict:function(doc){return(Ext.isDocument(doc)?doc:this.getDocument(doc)).compatMode==&quot;CSS1Compat&quot;;},getViewWidth:Ext.overload([ELD.getViewWidth||function(full){},function(){return this.getViewWidth(false);},function(full,doc){return full?this.getDocumentWidth(doc):this.getViewportWidth(doc);}]),getViewHeight:Ext.overload([ELD.getViewHeight||function(full){},function(){return this.getViewHeight(false);},function(full,doc){return full?this.getDocumentHeight(doc):this.getViewportHeight(doc);}]),getDocumentHeight:Ext.overload([ELD.getDocumentHeight||emptyFn,function(doc){if(doc=this.getDocument(doc)){return Math.max(!this.docIsStrict(doc)?doc.body.scrollHeight:doc.documentElement.scrollHeight,this.getViewportHeight(doc));}
return undefined;}]),getDocumentWidth:Ext.overload([ELD.getDocumentWidth||emptyFn,function(doc){if(doc=this.getDocument(doc)){return Math.max(!this.docIsStrict(doc)?doc.body.scrollWidth:doc.documentElement.scrollWidth,this.getViewportWidth(doc));}
return undefined;}]),getViewportHeight:Ext.overload([ELD.getViewportHeight||emptyFn,function(doc){if(doc=this.getDocument(doc)){if(Ext.isIE){return this.docIsStrict(doc)?doc.documentElement.clientHeight:doc.body.clientHeight;}else{return doc.defaultView.innerHeight;}}
return undefined;}]),getViewportWidth:Ext.overload([ELD.getViewportWidth||emptyFn,function(doc){if(doc=this.getDocument(doc)){return!this.docIsStrict(doc)&amp;&amp;!Ext.isOpera?doc.body.clientWidth:Ext.isIE?doc.documentElement.clientWidth:doc.defaultView.innerWidth;}
return undefined;}]),getXY:Ext.overload([ELD.getXY||emptyFn,function(el,doc){el=Ext.getDom(el,null,doc);var D=this.getDocument(el),bd=D?(D.body||D.documentElement):null;if(!el||!bd||el==bd){return[0,0];}
return this.getXY(el);}])});var GETDOC=ELD.getDocument,flies=El._flyweights;Ext.fly=El.fly=function(el,named,doc){var ret=null;named=named||'_global';if(el=Ext.getDom(el,null,doc)){(ret=flies[named]=(flies[named]||new El.Flyweight())).dom=el;Ext.isDocument(el)&amp;&amp;(ret._isDoc=true);}
return ret;};var flyFn=function(){};flyFn.prototype=El.prototype;El.Flyweight=function(dom){this.dom=dom;};El.Flyweight.prototype=new flyFn();El.Flyweight.prototype.isFlyweight=true;function addListener(el,ename,fn,task,wrap,scope){el=Ext.getDom(el);if(!el){return;}
var id=Ext.id(el),cache=resolveCache(el);cache[id]||El.addToCache(el,id,cache);var es=cache[id].events||{},wfn;wfn=E.on(el,ename,wrap);es[ename]=es[ename]||[];es[ename].push([fn,wrap,scope,wfn,task]);if(el.addEventListener&amp;&amp;ename==&quot;mousewheel&quot;){var args=[&quot;DOMMouseScroll&quot;,wrap,false];el.addEventListener.apply(el,args);Ext.EventManager.addListener(window,'beforeunload',function(){el.removeEventListener.apply(el,args);});}
if(ename==&quot;mousedown&quot;&amp;&amp;DOC==el){Ext.EventManager.stoppedMouseDownEvent.addListener(wrap);}};function createTargeted(h,o){return function(){var args=Ext.toArray(arguments);if(o.target==Ext.EventObject.setEvent(args[0]).target){h.apply(this,args);}};};function createBuffered(h,o,task){return function(e){task.delay(o.buffer,h,null,[new Ext.EventObjectImpl(e)]);};};function createSingle(h,el,ename,fn,scope){return function(e){Ext.EventManager.removeListener(el,ename,fn,scope);h(e);};};function createDelayed(h,o,fn){return function(e){var task=new Ext.util.DelayedTask(h);(fn.tasks||(fn.tasks=[])).push(task);task.delay(o.delay||10,h,null,[new Ext.EventObjectImpl(e)]);};};function listen(element,ename,opt,fn,scope){var o=!Ext.isObject(opt)?{}:opt,el=Ext.getDom(element),task;fn=fn||o.fn;scope=scope||o.scope;if(!el){throw&quot;Error listening for \&quot;&quot;+ename+'\&quot;. Element &quot;'+element+'&quot; doesn\'t exist.';}
function h(e){if(!window.Ext){return;}
e=Ext.EventObject.setEvent(e);var t;if(o.delegate){if(!(t=e.getTarget(o.delegate,el))){return;}}else{t=e.target;}
if(o.stopEvent){e.stopEvent();}
if(o.preventDefault){e.preventDefault();}
if(o.stopPropagation){e.stopPropagation();}
if(o.normalized){e=e.browserEvent;}
fn.call(scope||el,e,t,o);};if(o.target){h=createTargeted(h,o);}
if(o.delay){h=createDelayed(h,o,fn);}
if(o.single){h=createSingle(h,el,ename,fn,scope);}
if(o.buffer){task=new Ext.util.DelayedTask(h);h=createBuffered(h,o,task);}
addListener(el,ename,fn,task,h,scope);return h;};Ext.apply(Evm,{addListener:Evm.on=function(element,eventName,fn,scope,options){if(typeof eventName=='object'){var o=eventName,e,val;for(e in o){val=o[e];if(!propRe.test(e)){if(Ext.isFunction(val)){listen(element,e,o,val,o.scope);}else{listen(element,e,val);}}}}else{listen(element,eventName,options,fn,scope);}},removeListener:Evm.un=function(element,eventName,fn,scope){var el=Ext.getDom(element);el&amp;&amp;Ext.get(el);var elCache=el?resolveCache(el):{},f=el&amp;&amp;((elCache[el.id]||{events:{}}).events)[eventName]||[],wrap,i,l,k,len,fnc;for(i=0,len=f.length;i&lt;len;i++){if(Ext.isArray(fnc=f[i])&amp;&amp;fnc[0]==fn&amp;&amp;(!scope||fnc[2]==scope)){fnc[4]&amp;&amp;fnc[4].cancel();k=fn.tasks&amp;&amp;fn.tasks.length;if(k){while(k--){fn.tasks[k].cancel();}
delete fn.tasks;}
wrap=fnc[1];E.un(el,eventName,E.extAdapter?fnc[3]:wrap);if(wrap&amp;&amp;eventName==&quot;mousewheel&quot;&amp;&amp;el.addEventListener){el.removeEventListener(&quot;DOMMouseScroll&quot;,wrap,false);}
if(wrap&amp;&amp;eventName==&quot;mousedown&quot;&amp;&amp;DOC==el){Ext.EventManager.stoppedMouseDownEvent.removeListener(wrap);}
f.splice(i,1);if(f.length===0){delete elCache[el.id].events[eventName];}
for(k in elCache[el.id].events){return false;}
elCache[el.id].events={};return false;}}},removeAll:function(el){if(!(el=Ext.getDom(el))){return;}
var id=el.id,elCache=resolveCache(el)||{},es=elCache[id]||{},ev=es.events||{},f,i,len,ename,fn,k,wrap;for(ename in ev){if(ev.hasOwnProperty(ename)){f=ev[ename];for(i=0,len=f.length;i&lt;len;i++){fn=f[i];fn[4]&amp;&amp;fn[4].cancel();if(fn[0].tasks&amp;&amp;(k=fn[0].tasks.length)){while(k--){fn[0].tasks[k].cancel();}
delete fn.tasks;}
wrap=fn[1];E.un(el,ename,E.extAdapter?fn[3]:wrap);if(wrap&amp;&amp;el.addEventListener&amp;&amp;ename==&quot;mousewheel&quot;){el.removeEventListener(&quot;DOMMouseScroll&quot;,wrap,false);}
if(wrap&amp;&amp;DOC==el&amp;&amp;ename==&quot;mousedown&quot;){Ext.EventManager.stoppedMouseDownEvent.removeListener(wrap);}}}}
elCache[id]&amp;&amp;(elCache[id].events={});},getListeners:function(el,eventName){el=Ext.getDom(el);if(!el){return;}
var id=(Ext.get(el)||{}).id,elCache=resolveCache(el),es=(elCache[id]||{}).events||{};return es[eventName]||null;},purgeElement:function(el,recurse,eventName){el=Ext.getDom(el);var id=Ext.id(el),elCache=resolveCache(el),es=(elCache[id]||{}).events||{},i,f,len;if(eventName){if(es.hasOwnProperty(eventName)){f=es[eventName];for(i=0,len=f.length;i&lt;len;i++){Evm.removeListener(el,eventName,f[i][0]);}}}else{Evm.removeAll(el);}
if(recurse&amp;&amp;el&amp;&amp;el.childNodes){for(i=0,len=el.childNodes.length;i&lt;len;i++){Evm.purgeElement(el.childNodes[i],recurse,eventName);}}}});E.getListeners=function(el,eventName){return Ext.EventManager.getListeners(el,eventName);};Ext.provide&amp;&amp;Ext.provide('multidom');})();(function(){var El=Ext.Element,ElFrame,ELD=Ext.lib.Dom,EMPTYFN=function(){},OP=Object.prototype,addListener=function(){var handler;if(window.addEventListener){handler=function F(el,eventName,fn,capture){el.addEventListener(eventName,fn,!!capture);};}else if(window.attachEvent){handler=function F(el,eventName,fn,capture){el.attachEvent(&quot;on&quot;+eventName,fn);};}else{handler=function F(){};}
var F=null;return handler;}(),removeListener=function(){var handler;if(window.removeEventListener){handler=function F(el,eventName,fn,capture){el.removeEventListener(eventName,fn,(capture));};}else if(window.detachEvent){handler=function F(el,eventName,fn){el.detachEvent(&quot;on&quot;+eventName,fn);};}else{handler=function F(){};}
var F=null;return handler;}();if(typeof ELD.getDocument!='function'){alert(&quot;MIF 2.1 requires multidom support&quot;);}
if(!Ext.elCache||parseInt(Ext.version.replace(/\./g,''),10)&lt;311){alert('Ext Release '+Ext.version+' is not supported');}
Ext.ns('Ext.ux.ManagedIFrame','Ext.ux.plugin');var MIM,MIF=Ext.ux.ManagedIFrame,MIFC;var frameEvents=['documentloaded','domready','focus','blur','resize','scroll','unload','scroll','exception','message','reset'];var reSynthEvents=new RegExp('^('+frameEvents.join('|')+')','i');Ext.ux.ManagedIFrame.Element=Ext.extend(Ext.Element,{constructor:function(element,forceNew,doc){var d=doc||document,elCache=ELD.resolveDocumentCache(d),dom=Ext.getDom(element,false,d);if(!dom||!(/^(iframe|frame)/i).test(dom.tagName)){return null;}
var id=Ext.id(dom);this.dom=dom;this.id=id;(elCache[id]||(elCache[id]={el:this,events:{},data:{}})).el=this;this.dom.name||(this.dom.name=this.id);if(Ext.isIE){document.frames&amp;&amp;(document.frames[this.dom.name]||(document.frames[this.dom.name]=this.dom));}
this.dom.ownerCt=this;MIM.register(this);if(!this._observable){(this._observable=new Ext.util.Observable()).addEvents('documentloaded','domready','exception','resize','message','blur','focus','unload','scroll','reset');this._observable.addEvents('_docready','_docload');}
var H=Ext.isIE?'onreadystatechange':'onload';this.dom[H]=this.loadHandler.createDelegate(this);this.dom['onerror']=this.loadHandler.createDelegate(this);},destructor:function(){this.dom[Ext.isIE?'onreadystatechange':'onload']=this.dom['onerror']=EMPTYFN;MIM.deRegister(this);this.removeAllListeners();Ext.destroy(this.frameShim,this.DDM);this.hideMask(true);delete this.loadMask;this.reset();this.manager=null;this.dom.ownerCt=null;},cleanse:function(forceReclean,deep){if(this.isCleansed&amp;&amp;forceReclean!==true){return this;}
var d=this.dom,n=d.firstChild,nx;while(d&amp;&amp;n){nx=n.nextSibling;deep&amp;&amp;Ext.fly(n).cleanse(forceReclean,deep);Ext.removeNode(n);n=nx;}
this.isCleansed=true;return this;},src:null,CSS:null,manager:null,disableMessaging:true,domReadyRetries:7500,focusOnLoad:Ext.isIE,eventsFollowFrameLinks:true,remove:function(){this.destructor.apply(this,arguments);ElFrame.superclass.remove.apply(this,arguments);},getDocument:function(){return this.dom?this.dom.ownerDocument:document;},submitAsTarget:function(submitCfg){var opt=submitCfg||{},D=this.getDocument(),form=Ext.getDom(opt.form?opt.form.form||opt.form:null,false,D)||Ext.DomHelper.append(D.body,{tag:'form',cls:'x-hidden x-mif-form',encoding:'multipart/form-data'}),formFly=Ext.fly(form,'_dynaForm'),formState={target:form.target||'',method:form.method||'',encoding:form.encoding||'',enctype:form.enctype||'',action:form.action||''},encoding=opt.encoding||form.encoding,method=opt.method||form.method||'POST';formFly.set({target:this.dom.name,method:method,encoding:encoding,action:opt.url||opt.action||form.action});if(method=='POST'||!!opt.enctype){formFly.set({enctype:opt.enctype||form.enctype||encoding});}
var hiddens,hd,ps;if(opt.params&amp;&amp;(ps=Ext.isFunction(opt.params)?opt.params():opt.params)){hiddens=[];Ext.iterate(ps=typeof ps=='string'?Ext.urlDecode(ps,false):ps,function(n,v){Ext.fly(hd=D.createElement('input')).set({type:'hidden',name:n,value:v});form.appendChild(hd);hiddens.push(hd);});}
opt.callback&amp;&amp;this._observable.addListener('_docready',opt.callback,opt.scope,{single:true});this._frameAction=true;this._targetURI=location.href;this.showMask();(function(){form.submit();hiddens&amp;&amp;Ext.each(hiddens,Ext.removeNode,Ext);if(formFly.hasClass('x-mif-form')){formFly.remove();}else{formFly.set(formState);}
delete El._flyweights['_dynaForm'];formFly=null;this.hideMask(true);}).defer(100,this);return this;},resetUrl:(function(){return Ext.isIE&amp;&amp;Ext.isSecure?Ext.SSL_SECURE_URL:'about:blank';})(),setSrc:function(url,discardUrl,callback,scope){var src=url||this.src||this.resetUrl;var O=this._observable;this._unHook();Ext.isFunction(callback)&amp;&amp;O.addListener('_docload',callback,scope||this,{single:true});this.showMask();(discardUrl!==true)&amp;&amp;(this.src=src);var s=this._targetURI=(Ext.isFunction(src)?src()||'':src);try{this._frameAction=true;this.dom.src=s;this.checkDOM();}catch(ex){O.fireEvent.call(O,'exception',this,ex);}
return this;},setLocation:function(url,discardUrl,callback,scope){var src=url||this.src||this.resetUrl;var O=this._observable;this._unHook();Ext.isFunction(callback)&amp;&amp;O.addListener('_docload',callback,scope||this,{single:true});this.showMask();var s=this._targetURI=(Ext.isFunction(src)?src()||'':src);if(discardUrl!==true){this.src=src;}
try{this._frameAction=true;this.getWindow().location.replace(s);this.checkDOM();}catch(ex){O.fireEvent.call(O,'exception',this,ex);}
return this;},reset:function(src,callback,scope){this._unHook();var loadMaskOff=false,s=src,win=this.getWindow(),O=this._observable;if(this.loadMask){loadMaskOff=this.loadMask.disabled;this.loadMask.disabled=false;}
this.hideMask(true);if(win){this.isReset=true;var cb=callback;O.addListener('_docload',function(frame){if(this.loadMask){this.loadMask.disabled=loadMaskOff;};Ext.isFunction(cb)&amp;&amp;(cb=cb.apply(scope||this,arguments));O.fireEvent(&quot;reset&quot;,this);},this,{single:true});Ext.isFunction(s)&amp;&amp;(s=src());s=this._targetURI=Ext.isEmpty(s,true)?this.resetUrl:s;win.location?(win.location.href=s):O.fireEvent('_docload',this);}
return this;},scriptRE:/(?:&lt;script.*?&gt;)((\n|\r|.)*?)(?:&lt;\/script&gt;)/gi,update:function(content,loadScripts,callback,scope){loadScripts=loadScripts||this.getUpdater().loadScripts||false;content=Ext.DomHelper.markup(content||'');content=loadScripts===true?content:content.replace(this.scriptRE,&quot;&quot;);var doc;if((doc=this.getFrameDocument())&amp;&amp;!!content.length){this._unHook();this.src=null;this.showMask();Ext.isFunction(callback)&amp;&amp;this._observable.addListener('_docload',callback,scope||this,{single:true});this._targetURI=location.href;doc.open();this._frameAction=true;doc.write(content);doc.close();this.checkDOM();}else{this.hideMask(true);Ext.isFunction(callback)&amp;&amp;callback.call(scope,this);}
return this;},execCommand:function(command,userInterface,value,validate){var doc,assert;if((doc=this.getFrameDocument())&amp;&amp;!!command){try{Ext.isIE&amp;&amp;this.getWindow().focus();assert=validate&amp;&amp;Ext.isFunction(doc.queryCommandEnabled)?doc.queryCommandEnabled(command):true;return assert&amp;&amp;doc.execCommand(command,!!userInterface,value);}catch(eex){return false;}}
return false;},setDesignMode:function(active){var doc;(doc=this.getFrameDocument())&amp;&amp;(doc.designMode=(/on|true/i).test(String(active))?'on':'off');},getUpdater:function(){return this.updateManager||(this.updateManager=new MIF.Updater(this));},getHistory:function(){var h=null;try{h=this.getWindow().history;}catch(eh){}
return h;},get:function(el){var doc=this.getFrameDocument();return doc?Ext.get(el,doc):doc=null;},fly:function(el,named){var doc=this.getFrameDocument();return doc?Ext.fly(el,named,doc):null;},getDom:function(el){var d;if(!el||!(d=this.getFrameDocument())){return(d=null);}
return Ext.getDom(el,d);},select:function(selector,unique){var d;return(d=this.getFrameDocument())?Ext.Element.select(selector,unique,d):d=null;},query:function(selector){var d;return(d=this.getFrameDocument())?Ext.DomQuery.select(selector,d):null;},removeNode:Ext.removeNode,_renderHook:function(){this._windowContext=null;this.CSS=this.CSS?this.CSS.destroy():null;this._hooked=false;try{if(this.writeScript('(function(){(window.hostMIF = parent.document.getElementById(&quot;'
+this.id
+'&quot;).ownerCt)._windowContext='
+(Ext.isIE?'window':'{eval:function(s){return new Function(&quot;return (&quot;+s+&quot;)&quot;)();}}')
+';})()')){var w,p=this._frameProxy,D=this.getFrameDocument();if(w=this.getWindow()){p||(p=this._frameProxy=this._eventProxy.createDelegate(this));addListener(w,'focus',p);addListener(w,'blur',p);addListener(w,'resize',p);addListener(w,'unload',p);D&amp;&amp;addListener(Ext.isIE?w:D,'scroll',p);}
D&amp;&amp;(this.CSS=new Ext.ux.ManagedIFrame.CSS(D));}}catch(ex){}
return this.domWritable();},_unHook:function(){if(this._hooked){this._windowContext&amp;&amp;(this._windowContext.hostMIF=null);this._windowContext=null;var w,p=this._frameProxy;if(p&amp;&amp;this.domWritable()&amp;&amp;(w=this.getWindow())){removeListener(w,'focus',p);removeListener(w,'blur',p);removeListener(w,'resize',p);removeListener(w,'unload',p);removeListener(Ext.isIE?w:this.getFrameDocument(),'scroll',p);}}
ELD.clearDocumentCache&amp;&amp;ELD.clearDocumentCache(this.id);this.CSS=this.CSS?this.CSS.destroy():null;this.domFired=this._frameAction=this.domReady=this._hooked=false;},_windowContext:null,getFrameDocument:function(){var win=this.getWindow(),doc=null;try{doc=(Ext.isIE&amp;&amp;win?win.document:null)||this.dom.contentDocument||window.frames[this.dom.name].document||null;}catch(gdEx){ELD.clearDocumentCache&amp;&amp;ELD.clearDocumentCache(this.id);return false;}
doc=(doc&amp;&amp;Ext.isFunction(ELD.getDocument))?ELD.getDocument(doc,true):doc;return doc;},getDoc:function(){var D=this.getFrameDocument();return Ext.get(D,D);},getBody:function(){var d;return(d=this.getFrameDocument())?this.get(d.body||d.documentElement):null;},getDocumentURI:function(){var URI,d;try{URI=this.src&amp;&amp;(d=this.getFrameDocument())?d.location.href:null;}catch(ex){}
return URI||(Ext.isFunction(this.src)?this.src():this.src);},getWindowURI:function(){var URI,w;try{URI=(w=this.getWindow())?w.location.href:null;}catch(ex){}
return URI||(Ext.isFunction(this.src)?this.src():this.src);},getWindow:function(){var dom=this.dom,win=null;try{win=dom.contentWindow||window.frames[dom.name]||null;}catch(gwEx){}
return win;},scrollChildIntoView:function(child,container,hscroll){this.fly(child,'_scrollChildIntoView').scrollIntoView(this.getDom(container)||this.getBody().dom,hscroll);return this;},print:function(){try{var win;if(win=this.getWindow()){Ext.isIE&amp;&amp;win.focus();win.print();}}catch(ex){throw new MIF.Error('printexception',ex.description||ex.message||ex);}
return this;},domWritable:function(){return!!Ext.isDocument(this.getFrameDocument(),true)&amp;&amp;!!this._windowContext;},execScript:function(block,useDOM){try{if(this.domWritable()){if(useDOM){this.writeScript(block);}else{return this._windowContext.eval(block);}}else{throw new MIF.Error('execscript-secure-context');}}catch(ex){this._observable.fireEvent.call(this._observable,'exception',this,ex);return false;}
return true;},writeScript:function(block,attributes){attributes=Ext.apply({},attributes||{},{type:&quot;text/javascript&quot;,text:block});try{var head,script,doc=this.getFrameDocument();if(doc&amp;&amp;typeof doc.getElementsByTagName!='undefined'){if(!(head=doc.getElementsByTagName(&quot;head&quot;)[0])){head=doc.createElement(&quot;head&quot;);doc.getElementsByTagName(&quot;html&quot;)[0].appendChild(head);}
if(head&amp;&amp;(script=doc.createElement(&quot;script&quot;))){for(var attrib in attributes){if(attributes.hasOwnProperty(attrib)&amp;&amp;attrib in script){script[attrib]=attributes[attrib];}}
return!!head.appendChild(script);}}}catch(ex){this._observable.fireEvent.call(this._observable,'exception',this,ex);}finally{script=head=null;}
return false;},loadFunction:function(fn,useDOM,invokeIt){var name=fn.name||fn;var fnSrc=fn.fn||window[fn];name&amp;&amp;fnSrc&amp;&amp;this.execScript(name+'='+fnSrc,useDOM);invokeIt&amp;&amp;this.execScript(name+'()');},loadHandler:function(e,target){var rstatus=(this.dom||{}).readyState||(e||{}).type;if(this.eventsFollowFrameLinks||this._frameAction||this.isReset){switch(rstatus){case'domready':case'DOMFrameContentLoaded':case'domfail':this._onDocReady(rstatus);break;case'load':case'complete':this._onDocLoaded(rstatus);break;case'error':this._observable.fireEvent.apply(this._observable,['exception',this].concat(arguments));break;default:}
this.frameState=rstatus;}},_onDocReady:function(eventName){var w,obv=this._observable,D;if(!this.isReset&amp;&amp;this.focusOnLoad&amp;&amp;(w=this.getWindow())){w.focus();}
obv.fireEvent(&quot;_docready&quot;,this);(D=this.getDoc())&amp;&amp;(D.isReady=true);if(!this.domFired&amp;&amp;(this._hooked=this._renderHook())){this.domFired=true;this.isReset||obv.fireEvent.call(obv,'domready',this);}
this.domReady=true;this.hideMask();},_onDocLoaded:function(eventName){var obv=this._observable,w;this.domReady||this._onDocReady('domready');obv.fireEvent(&quot;_docload&quot;,this);this.isReset||obv.fireEvent(&quot;documentloaded&quot;,this);this.hideMask(true);this._frameAction=this.isReset=false;},checkDOM:function(win){if(Ext.isGecko){return;}
var n=0,frame=this,domReady=false,b,l,d,max=this.domReadyRetries||2500,polling=false,startLocation=(this.getFrameDocument()||{location:{}}).location.href;(function(){d=frame.getFrameDocument()||{location:{}};polling=(d.location.href!==startLocation||d.location.href===frame._targetURI);if(frame.domReady){return;}
domReady=polling&amp;&amp;((b=frame.getBody())&amp;&amp;!!(b.dom.innerHTML||'').length)||false;if(d.location.href&amp;&amp;!domReady&amp;&amp;(++n&lt;max)){setTimeout(arguments.callee,2);return;}
frame.loadHandler({type:domReady?'domready':'domfail'});})();},filterEventOptionsRe:/^(?:scope|delay|buffer|single|stopEvent|preventDefault|stopPropagation|normalized|args|delegate)$/,addListener:function(eventName,fn,scope,options){if(typeof eventName==&quot;object&quot;){var o=eventName;for(var e in o){if(this.filterEventOptionsRe.test(e)){continue;}
if(typeof o[e]==&quot;function&quot;){this.addListener(e,o[e],o.scope,o);}else{this.addListener(e,o[e].fn,o[e].scope,o[e]);}}
return;}
if(reSynthEvents.test(eventName)){var O=this._observable;if(O){O.events[eventName]||(O.addEvents(eventName));O.addListener.call(O,eventName,fn,scope||this,options);}}else{ElFrame.superclass.addListener.call(this,eventName,fn,scope||this,options);}
return this;},removeListener:function(eventName,fn,scope){var O=this._observable;if(reSynthEvents.test(eventName)){O&amp;&amp;O.removeListener.call(O,eventName,fn,scope||this,options);}else{ElFrame.superclass.removeListener.call(this,eventName,fn,scope||this);}
return this;},removeAllListeners:function(){Ext.EventManager.removeAll(this.dom);var O=this._observable;O&amp;&amp;O.purgeListeners.call(this._observable);return this;},showMask:function(msg,msgCls,maskCls){var lmask=this.loadMask;if(lmask&amp;&amp;!lmask.disabled){this.mask(msg||lmask.msg,msgCls||lmask.msgCls,maskCls||lmask.maskCls,lmask.maskEl);}},hideMask:function(forced){var tlm=this.loadMask||{};if(forced||(tlm.hideOnReady&amp;&amp;this.domReady)){this.unmask();}},mask:function(msg,msgCls,maskCls,maskEl){this._mask&amp;&amp;this.unmask();var p=Ext.get(maskEl)||this.parent('.ux-mif-mask-target')||this.parent();if(p.getStyle(&quot;position&quot;)==&quot;static&quot;&amp;&amp;!p.select('iframe,frame,object,embed').elements.length){p.addClass(&quot;x-masked-relative&quot;);}
p.addClass(&quot;x-masked&quot;);this._mask=Ext.DomHelper.append(p,{cls:maskCls||&quot;ux-mif-el-mask&quot;},true);this._mask.setDisplayed(true);this._mask._agent=p;if(typeof msg=='string'){this._maskMsg=Ext.DomHelper.append(p,{cls:msgCls||&quot;ux-mif-el-mask-msg&quot;,style:{visibility:'hidden'},cn:{tag:'div',html:msg}},true);this._maskMsg.setVisibilityMode(Ext.Element.VISIBILITY).center(p).setVisible(true);}
if(Ext.isIE&amp;&amp;!(Ext.isIE7&amp;&amp;Ext.isStrict)&amp;&amp;this.getStyle('height')=='auto'){this._mask.setSize(undefined,this._mask.getHeight());}
return this._mask;},unmask:function(){var a;if(this._mask){(a=this._mask._agent)&amp;&amp;a.removeClass([&quot;x-masked-relative&quot;,&quot;x-masked&quot;]);if(this._maskMsg){this._maskMsg.remove();delete this._maskMsg;}
this._mask.remove();delete this._mask;}},createFrameShim:function(imgUrl,shimCls){this.shimCls=shimCls||this.shimCls||'ux-mif-shim';this.frameShim||(this.frameShim=this.next('.'+this.shimCls)||Ext.DomHelper.append(this.dom.parentNode,{tag:'img',src:imgUrl||Ext.BLANK_IMAGE_URL,cls:this.shimCls,galleryimg:&quot;no&quot;},true));this.frameShim&amp;&amp;(this.frameShim.autoBoxAdjust=false);return this.frameShim;},toggleShim:function(show){var shim=this.frameShim||this.createFrameShim();var cls=this.shimCls+'-on';!show&amp;&amp;shim.removeClass(cls);show&amp;&amp;!shim.hasClass(cls)&amp;&amp;shim.addClass(cls);},load:function(loadCfg){var um;if(um=this.getUpdater()){if(loadCfg&amp;&amp;loadCfg.renderer){um.setRenderer(loadCfg.renderer);delete loadCfg.renderer;}
um.update.apply(um,arguments);}
return this;},_eventProxy:function(e){if(!e)return;e=Ext.EventObject.setEvent(e);var be=e.browserEvent||e,er,args=[e.type,this];if(!be['eventPhase']||(be['eventPhase']==(be['AT_TARGET']||2))){if(e.type=='resize'){var doc=this.getFrameDocument();doc&amp;&amp;(args.push({height:ELD.getDocumentHeight(doc),width:ELD.getDocumentWidth(doc)},{height:ELD.getViewportHeight(doc),width:ELD.getViewportWidth(doc)},{height:ELD.getViewHeight(false,doc),width:ELD.getViewWidth(false,doc)}));}
er=this._observable?this._observable.fireEvent.apply(this._observable,args.concat(Array.prototype.slice.call(arguments,0))):null;(e.type=='unload')&amp;&amp;this._unHook();}
return er;},sendMessage:function(message,tag,origin){},postMessage:function(message,origin){}});ElFrame=Ext.Element.IFRAME=Ext.Element.FRAME=Ext.ux.ManagedIFrame.Element;var fp=ElFrame.prototype;Ext.override(ElFrame,{on:fp.addListener,un:fp.removeListener,getUpdateManager:fp.getUpdater});Ext.ux.ManagedIFrame.ComponentAdapter=function(){};Ext.ux.ManagedIFrame.ComponentAdapter.prototype={version:2.12,defaultSrc:null,unsupportedText:'Inline frames are NOT enabled\/supported by your browser.',hideMode:!Ext.isIE&amp;&amp;!!Ext.ux.plugin.VisibilityMode?'nosize':'display',animCollapse:Ext.isIE,animFloat:Ext.isIE,disableMessaging:true,eventsFollowFrameLinks:true,frameConfig:null,focusOnLoad:Ext.isIE,frameEl:null,useShim:false,autoScroll:true,autoLoad:null,getId:function(){return this.id||(this.id=&quot;mif-comp-&quot;+(++Ext.Component.AUTO_ID));},stateEvents:['documentloaded'],stateful:false,setAutoScroll:function(auto){var scroll=Ext.value(auto,this.autoScroll===true);this.rendered&amp;&amp;this.getFrame()&amp;&amp;this.frameEl.setOverflow((this.autoScroll=scroll)?'auto':'hidden');return this;},getContentTarget:function(){return this.getFrame();},getFrame:function(){if(this.rendered){if(this.frameEl){return this.frameEl;}
var f=this.items&amp;&amp;this.items.first?this.items.first():null;f&amp;&amp;(this.frameEl=f.frameEl);return this.frameEl;}
return null;},getFrameWindow:function(){return this.getFrame()?this.frameEl.getWindow():null;},getFrameDocument:function(){return this.getFrame()?this.frameEl.getFrameDocument():null;},getFrameDoc:function(){return this.getFrame()?this.frameEl.getDoc():null;},getFrameBody:function(){return this.getFrame()?this.frameEl.getBody():null;},resetFrame:function(){this.getFrame()&amp;&amp;this.frameEl.reset.apply(this.frameEl,arguments);return this;},submitAsTarget:function(submitCfg){this.getFrame()&amp;&amp;this.frameEl.submitAsTarget.apply(this.frameEl,arguments);return this;},load:function(loadCfg){if(loadCfg&amp;&amp;this.getFrame()){var args=arguments;this.resetFrame(null,function(){loadCfg.submitAsTarget?this.submitAsTarget.apply(this,args):this.frameEl.load.apply(this.frameEl,args);},this);}
this.autoLoad=loadCfg;return this;},doAutoLoad:function(){this.autoLoad&amp;&amp;this.load(typeof this.autoLoad=='object'?this.autoLoad:{url:this.autoLoad});},getUpdater:function(){return this.getFrame()?this.frameEl.getUpdater():null;},setSrc:function(url,discardUrl,callback,scope){this.getFrame()&amp;&amp;this.frameEl.setSrc.apply(this.frameEl,arguments);return this;},setLocation:function(url,discardUrl,callback,scope){this.getFrame()&amp;&amp;this.frameEl.setLocation.apply(this.frameEl,arguments);return this;},getState:function(){var URI=this.getFrame()?this.frameEl.getDocumentURI()||null:null;var state=this.supr().getState.call(this);state=Ext.apply(state||{},{defaultSrc:Ext.isFunction(URI)?URI():URI,autoLoad:this.autoLoad});return state;},setMIFEvents:function(){this.addEvents('documentloaded','domready','exception','message','blur','focus','scroll','resize','unload','reset');},sendMessage:function(message,tag,origin){},onAdd:function(C){C.relayTarget&amp;&amp;this.suspendEvents(true);},initRef:function(){if(this.ref){var t=this,levels=this.ref.split('/'),l=levels.length,i;for(i=0;i&lt;l;i++){if(t.ownerCt){t=t.ownerCt;}}
this.refName=levels[--i];t[this.refName]||(t[this.refName]=this);this.refOwner=t;}}};Ext.ux.ManagedIFrame.Component=Ext.extend(Ext.BoxComponent,{ctype:&quot;Ext.ux.ManagedIFrame.Component&quot;,initComponent:function(){var C={monitorResize:this.monitorResize||(this.monitorResize=!!this.fitToParent),plugins:(this.plugins||[]).concat(this.hideMode==='nosize'&amp;&amp;Ext.ux.plugin.VisibilityMode?[new Ext.ux.plugin.VisibilityMode({hideMode:'nosize',elements:['bwrap']})]:[])};MIF.Component.superclass.initComponent.call(Ext.apply(this,Ext.apply(this.initialConfig,C)));this.setMIFEvents();},onRender:function(ct,position){var frCfg=this.frameCfg||this.frameConfig||(this.relayTarget?{name:this.relayTarget.id}:{})||{};var frDOM=frCfg.autoCreate||frCfg;frDOM=Ext.apply({tag:'iframe',id:Ext.id()},frDOM);var el=Ext.getDom(this.el);(el&amp;&amp;el.tagName=='iframe')||(this.autoEl=Ext.apply({name:frDOM.id,frameborder:0},frDOM));MIF.Component.superclass.onRender.apply(this,arguments);if(this.unsupportedText){ct.child('noframes')||ct.createChild({tag:'noframes',html:this.unsupportedText||null});}
var frame=this.el;var F;if(F=this.frameEl=(this.el?new MIF.Element(this.el.dom,true):null)){Ext.apply(F,{ownerCt:this.relayTarget||this,disableMessaging:Ext.value(this.disableMessaging,true),focusOnLoad:Ext.value(this.focusOnLoad,Ext.isIE),eventsFollowFrameLinks:Ext.value(this.eventsFollowFrameLinks,true)});F.ownerCt.frameEl=F;F.addClass('ux-mif');if(this.loadMask){var mEl=this.loadMask.maskEl;F.loadMask=Ext.apply({disabled:false,hideOnReady:false,msgCls:'ext-el-mask-msg x-mask-loading',maskCls:'ext-el-mask'},{maskEl:F.ownerCt[String(mEl)]||F.parent('.'+String(mEl))||F.parent('.ux-mif-mask-target')||mEl},Ext.isString(this.loadMask)?{msg:this.loadMask}:this.loadMask);Ext.get(F.loadMask.maskEl)&amp;&amp;Ext.get(F.loadMask.maskEl).addClass('ux-mif-mask-target');}
F._observable&amp;&amp;(this.relayTarget||this).relayEvents(F._observable,frameEvents.concat(this._msgTagHandlers||[]));delete this.contentEl;}},afterRender:function(container){MIF.Component.superclass.afterRender.apply(this,arguments);if(this.fitToParent&amp;&amp;!this.ownerCt){var pos=this.getPosition(),size=(Ext.get(this.fitToParent)||this.getEl().parent()).getViewSize();this.setSize(size.width-pos[0],size.height-pos[1]);}
this.getEl().setOverflow('hidden');this.setAutoScroll();var F;if(F=this.frameEl){var ownerCt=this.ownerCt;while(ownerCt){ownerCt.on('afterlayout',function(container,layout){Ext.each(['north','south','east','west'],function(region){var reg;if((reg=layout[region])&amp;&amp;reg.split&amp;&amp;reg.split.dd&amp;&amp;!reg._splitTrapped){reg.split.dd.endDrag=reg.split.dd.endDrag.createSequence(MIM.hideShims,MIM);reg.split.on('beforeresize',MIM.showShims,MIM);reg._splitTrapped=MIM._splitTrapped=true;}},this);},this,{single:true});ownerCt=ownerCt.ownerCt;}
if(!!this.ownerCt||this.useShim){this.frameShim=F.createFrameShim();}
this.getUpdater().showLoadIndicator=this.showLoadIndicator||false;var resumeEvents=this.relayTarget&amp;&amp;this.ownerCt?this.ownerCt.resumeEvents.createDelegate(this.ownerCt):null;if(this.autoload){this.doAutoLoad();}else if(this.frameMarkup||this.html){F.update(this.frameMarkup||this.html,true,resumeEvents);delete this.html;delete this.frameMarkup;return;}else{if(this.defaultSrc){F.setSrc(this.defaultSrc,false);}else{F.reset(null,resumeEvents);return;}}
resumeEvents&amp;&amp;resumeEvents();}},beforeDestroy:function(){var F;if(F=this.getFrame()){F.remove();this.frameEl=this.frameShim=null;}
this.relayTarget&amp;&amp;(this.relayTarget.frameEl=null);MIF.Component.superclass.beforeDestroy.call(this);}});Ext.override(MIF.Component,MIF.ComponentAdapter.prototype);Ext.reg('mif',MIF.Component);function embed_MIF(config){config||(config={});config.layout='fit';config.items={xtype:'mif',ref:'mifChild',useShim:true,autoScroll:Ext.value(config.autoScroll,this.autoScroll),defaultSrc:Ext.value(config.defaultSrc,this.defaultSrc),frameMarkup:Ext.value(config.html,this.html),loadMask:Ext.value(config.loadMask,this.loadMask),disableMessaging:Ext.value(config.disableMessaging,this.disableMessaging),eventsFollowFrameLinks:Ext.value(config.eventsFollowFrameLinks,this.eventsFollowFrameLinks),focusOnLoad:Ext.value(config.focusOnLoad,this.focusOnLoad),frameConfig:Ext.value(config.frameConfig||config.frameCfg,this.frameConfig),relayTarget:this};delete config.html;this.setMIFEvents();return config;};Ext.ux.ManagedIFrame.Panel=Ext.extend(Ext.Panel,{ctype:'Ext.ux.ManagedIFrame.Panel',bodyCssClass:'ux-mif-mask-target',constructor:function(config){MIF.Panel.superclass.constructor.call(this,embed_MIF.call(this,config));}});Ext.override(MIF.Panel,MIF.ComponentAdapter.prototype);Ext.reg('iframepanel',MIF.Panel);Ext.ux.ManagedIFrame.Portlet=Ext.extend(Ext.ux.ManagedIFrame.Panel,{ctype:&quot;Ext.ux.ManagedIFrame.Portlet&quot;,anchor:'100%',frame:true,collapseEl:'bwrap',collapsible:true,draggable:true,cls:'x-portlet'});Ext.reg('iframeportlet',MIF.Portlet);Ext.ux.ManagedIFrame.Window=Ext.extend(Ext.Window,{ctype:&quot;Ext.ux.ManagedIFrame.Window&quot;,bodyCssClass:'ux-mif-mask-target',constructor:function(config){MIF.Window.superclass.constructor.call(this,embed_MIF.call(this,config));}});Ext.override(MIF.Window,MIF.ComponentAdapter.prototype);Ext.reg('iframewindow',MIF.Window);Ext.ux.ManagedIFrame.Updater=Ext.extend(Ext.Updater,{showLoading:function(){this.showLoadIndicator&amp;&amp;this.el&amp;&amp;this.el.mask(this.indicatorText);},hideLoading:function(){this.showLoadIndicator&amp;&amp;this.el&amp;&amp;this.el.unmask();},updateComplete:function(response){MIF.Updater.superclass.updateComplete.apply(this,arguments);this.hideLoading();},processFailure:function(response){MIF.Updater.superclass.processFailure.apply(this,arguments);this.hideLoading();}});var styleCamelRe=/(-[a-z])/gi;var styleCamelFn=function(m,a){return a.charAt(1).toUpperCase();};Ext.ux.ManagedIFrame.CSS=function(hostDocument){var doc;if(hostDocument){doc=hostDocument;return{rules:null,destroy:function(){return doc=null;},createStyleSheet:function(cssText,id){var ss;if(!doc)return;var head=doc.getElementsByTagName(&quot;head&quot;)[0];var rules=doc.createElement(&quot;style&quot;);rules.setAttribute(&quot;type&quot;,&quot;text/css&quot;);Ext.isString(id)&amp;&amp;rules.setAttribute(&quot;id&quot;,id);if(Ext.isIE){head.appendChild(rules);ss=rules.styleSheet;ss.cssText=cssText;}else{try{rules.appendChild(doc.createTextNode(cssText));}catch(e){rules.cssText=cssText;}
head.appendChild(rules);ss=rules.styleSheet?rules.styleSheet:(rules.sheet||doc.styleSheets[doc.styleSheets.length-1]);}
this.cacheStyleSheet(ss);return ss;},removeStyleSheet:function(id){if(!doc||!id)return;var existing=doc.getElementById(id);if(existing){existing.parentNode.removeChild(existing);}},swapStyleSheet:function(id,url){if(!doc)return;this.removeStyleSheet(id);var ss=doc.createElement(&quot;link&quot;);ss.setAttribute(&quot;rel&quot;,&quot;stylesheet&quot;);ss.setAttribute(&quot;type&quot;,&quot;text/css&quot;);Ext.isString(id)&amp;&amp;ss.setAttribute(&quot;id&quot;,id);ss.setAttribute(&quot;href&quot;,url);doc.getElementsByTagName(&quot;head&quot;)[0].appendChild(ss);},refreshCache:function(){return this.getRules(true);},cacheStyleSheet:function(ss,media){this.rules||(this.rules={});try{Ext.each(ss.cssRules||ss.rules||[],function(rule){this.hashRule(rule,ss,media);},this);Ext.each(ss.imports||[],function(sheet){sheet&amp;&amp;this.cacheStyleSheet(sheet,this.resolveMedia([sheet,sheet.parentStyleSheet]));},this);}catch(e){}},hashRule:function(rule,sheet,mediaOverride){var mediaSelector=mediaOverride||this.resolveMedia(rule);if(rule.cssRules||rule.rules){this.cacheStyleSheet(rule,this.resolveMedia([rule,rule.parentRule]));}
if(rule.styleSheet){this.cacheStyleSheet(rule.styleSheet,this.resolveMedia([rule,rule.ownerRule,rule.parentStyleSheet]));}
rule.selectorText&amp;&amp;Ext.each((mediaSelector||'').split(','),function(media){this.rules[((media?media.trim()+':':'')+rule.selectorText).toLowerCase()]=rule;},this);},resolveMedia:function(rule){var media;Ext.each([].concat(rule),function(r){if(r&amp;&amp;r.media&amp;&amp;r.media.length){media=r.media;return false;}});return media?(Ext.isIE?String(media):media.mediaText):'';},getRules:function(refreshCache){if(!this.rules||refreshCache){this.rules={};if(doc){var ds=doc.styleSheets;for(var i=0,len=ds.length;i&lt;len;i++){try{this.cacheStyleSheet(ds[i]);}catch(e){}}}}
return this.rules;},getRule:function(selector,refreshCache,mediaSelector){var rs=this.getRules(refreshCache);if(Ext.type(mediaSelector)=='string'){mediaSelector=mediaSelector.trim()+':';}else{mediaSelector='';}
if(!Ext.isArray(selector)){return rs[(mediaSelector+selector).toLowerCase()];}
var select;for(var i=0;i&lt;selector.length;i++){select=(mediaSelector+selector[i]).toLowerCase();if(rs[select]){return rs[select];}}
return null;},updateRule:function(selector,property,value,mediaSelector){Ext.each((mediaSelector||'').split(','),function(mediaSelect){if(!Ext.isArray(selector)){var rule=this.getRule(selector,false,mediaSelect);if(rule){rule.style[property.replace(camelRe,camelFn)]=value;return true;}}else{for(var i=0;i&lt;selector.length;i++){if(this.updateRule(selector[i],property,value,mediaSelect)){return true;}}}
return false;},this);}};}};Ext.ux.ManagedIFrame.Manager=function(){var frames={};var implementation={_DOMFrameReadyHandler:function(e){try{var $frame;if($frame=e.target.ownerCt){$frame.loadHandler.call($frame,e);}}catch(rhEx){}},shimCls:'ux-mif-shim',register:function(frame){frame.manager=this;frames[frame.id]=frames[frame.name]={ref:frame};return frame;},deRegister:function(frame){delete frames[frame.id];delete frames[frame.name];},hideShims:function(){var mm=MIF.Manager;mm.shimsApplied&amp;&amp;Ext.select('.'+mm.shimCls,true).removeClass(mm.shimCls+'-on');mm.shimsApplied=false;},showShims:function(){var mm=MIF.Manager;!mm.shimsApplied&amp;&amp;Ext.select('.'+mm.shimCls,true).addClass(mm.shimCls+'-on');mm.shimsApplied=true;},getFrameById:function(id){return typeof id=='string'?(frames[id]?frames[id].ref||null:null):null;},getFrameByName:function(name){return this.getFrameById(name);},getFrameHash:function(frame){return frames[frame.id]||frames[frame.id]||null;},destroy:function(){if(document.addEventListener&amp;&amp;!Ext.isOpera){window.removeEventListener(&quot;DOMFrameContentLoaded&quot;,this._DOMFrameReadyHandler,false);}}};document.addEventListener&amp;&amp;!Ext.isOpera&amp;&amp;window.addEventListener(&quot;DOMFrameContentLoaded&quot;,implementation._DOMFrameReadyHandler,false);Ext.EventManager.on(window,'beforeunload',implementation.destroy,implementation);return implementation;}();MIM=MIF.Manager;MIM.showDragMask=MIM.showShims;MIM.hideDragMask=MIM.hideShims;var winDD=Ext.Window.DD;Ext.override(winDD,{startDrag:winDD.prototype.startDrag.createInterceptor(MIM.showShims),endDrag:winDD.prototype.endDrag.createInterceptor(MIM.hideShims)});Ext.ux.ManagedIFramePanel=MIF.Panel;Ext.ux.ManagedIFramePortlet=MIF.Portlet;Ext.ux.ManagedIframe=function(el,opt){var args=Array.prototype.slice.call(arguments,0),el=Ext.get(args[0]),config=args[0];if(el&amp;&amp;el.dom&amp;&amp;el.dom.tagName=='IFRAME'){config=args[1]||{};}else{config=args[0]||args[1]||{};el=config.autoCreate?Ext.get(Ext.DomHelper.append(config.autoCreate.parent||Ext.getBody(),Ext.apply({tag:'iframe',frameborder:0,cls:'x-mif',src:(Ext.isIE&amp;&amp;Ext.isSecure)?Ext.SSL_SECURE_URL:'about:blank'},config.autoCreate))):null;if(el&amp;&amp;config.unsupportedText){Ext.DomHelper.append(el.dom.parentNode,{tag:'noframes',html:config.unsupportedText});}}
var mif=new MIF.Element(el,true);if(mif){Ext.apply(mif,{disableMessaging:Ext.value(config.disableMessaging,true),focusOnLoad:Ext.value(config.focusOnLoad,Ext.isIE),eventsFollowFrameLinks:Ext.value(config.eventsFollowFrameLinks,true),loadMask:!!config.loadMask?Ext.apply({msg:'Loading..',msgCls:'x-mask-loading',maskEl:null,hideOnReady:false,disabled:false},config.loadMask):false,_windowContext:null});config.listeners&amp;&amp;mif.on(config.listeners);if(!!config.html){mif.update(config.html);}else{!!config.src&amp;&amp;mif.setSrc(config.src);}}
return mif;};Ext.ux.ManagedIFrame.Error=Ext.extend(Ext.Error,{constructor:function(message,arg){this.arg=arg;Ext.Error.call(this,message);},name:'Ext.ux.ManagedIFrame'});Ext.apply(Ext.ux.ManagedIFrame.Error.prototype,{lang:{'documentcontext-remove':'An attempt was made to remove an Element from the wrong document context.','execscript-secure-context':'An attempt was made at script execution within a document context with limited access permissions.','printexception':'An Error was encountered attempting the print the frame contents (document access is likely restricted).'}});Ext.onReady(function(){var CSS=new Ext.ux.ManagedIFrame.CSS(document),rules=[];CSS.getRule('.ux-mif-fill')||(rules.push('.ux-mif-fill{height:100%;width:100%;}'));CSS.getRule('.ux-mif-mask-target')||(rules.push('.ux-mif-mask-target{position:relative;zoom:1;}'));CSS.getRule('.ux-mif-el-mask')||(rules.push('.ux-mif-el-mask {z-index: 100;position: absolute;top:0;left:0;-moz-opacity: 0.5;opacity: .50;*filter: alpha(opacity=50);width: 100%;height: 100%;zoom: 1;} ','.ux-mif-el-mask-msg {z-index: 1;position: absolute;top: 0;left: 0;border:1px solid;background:repeat-x 0 -16px;padding:2px;} ','.ux-mif-el-mask-msg div {padding:5px 10px 5px 10px;border:1px solid;cursor:wait;} '));if(!CSS.getRule('.ux-mif-shim')){rules.push('.ux-mif-shim {z-index:8500;position:absolute;top:0px;left:0px;background:transparent!important;overflow:hidden;display:none;}');rules.push('.ux-mif-shim-on{width:100%;height:100%;display:block;zoom:1;}');rules.push('.ext-ie6 .ux-mif-shim{margin-left:5px;margin-top:3px;}');}
if(!CSS.getRule('.x-hide-nosize')){rules.push('.x-hide-nosize{height:0px!important;width:0px!important;visibility:hidden!important;border:none!important;zoom:1;}.x-hide-nosize * {height:0px!important;width:0px!important;visibility:hidden!important;border:none!important;zoom:1;}');}!!rules.length&amp;&amp;CSS.createStyleSheet(rules.join(' '),'mifCSS');});Ext.provide&amp;&amp;Ext.provide('mif');})();Ext.ns('Ext.ux.tree');Ext.ux.tree.TreeGridSorter=Ext.extend(Ext.tree.TreeSorter,{sortClasses:['sort-asc','sort-desc'],sortAscText:'Sort Ascending',sortDescText:'Sort Descending',constructor:function(tree,config){if(!Ext.isObject(config)){config={property:tree.columns[0].dataIndex||'text',folderSort:true}}
Ext.ux.tree.TreeGridSorter.superclass.constructor.apply(this,arguments);this.tree=tree;tree.on('headerclick',this.onHeaderClick,this);tree.ddAppendOnly=true;var me=this;this.defaultSortFn=function(n1,n2){var desc=me.dir&amp;&amp;me.dir.toLowerCase()=='desc',prop=me.property||'text',sortType=me.sortType,caseSensitive=me.caseSensitive===true,leafAttr=me.leafAttr||'leaf',attr1=n1.attributes,attr2=n2.attributes;if(me.folderSort){if(attr1[leafAttr]&amp;&amp;!attr2[leafAttr]){return 1;}
if(!attr1[leafAttr]&amp;&amp;attr2[leafAttr]){return-1;}}
var prop1=attr1[prop],prop2=attr2[prop],v1=sortType?sortType(prop1):(caseSensitive?prop1:prop1.toUpperCase());v2=sortType?sortType(prop2):(caseSensitive?prop2:prop2.toUpperCase());if(v1&lt;v2){return desc?+1:-1;}else if(v1&gt;v2){return desc?-1:+1;}else{return 0;}};tree.on('afterrender',this.onAfterTreeRender,this,{single:true});tree.on('headermenuclick',this.onHeaderMenuClick,this);},onAfterTreeRender:function(){if(this.tree.hmenu){this.tree.hmenu.insert(0,{itemId:'asc',text:this.sortAscText,cls:'xg-hmenu-sort-asc'},{itemId:'desc',text:this.sortDescText,cls:'xg-hmenu-sort-desc'});}
this.updateSortIcon(0,'asc');},onHeaderMenuClick:function(c,id,index){if(id==='asc'||id==='desc'){this.onHeaderClick(c,null,index);return false;}},onHeaderClick:function(c,el,i){if(c&amp;&amp;!this.tree.headersDisabled){var me=this;me.property=c.dataIndex;me.dir=c.dir=(c.dir==='desc'?'asc':'desc');me.sortType=c.sortType;me.caseSensitive===Ext.isBoolean(c.caseSensitive)?c.caseSensitive:this.caseSensitive;me.sortFn=c.sortFn||this.defaultSortFn;this.tree.root.cascade(function(n){if(!n.isLeaf()){me.updateSort(me.tree,n);}});this.updateSortIcon(i,c.dir);}},updateSortIcon:function(col,dir){var sc=this.sortClasses,hds=this.tree.innerHd.select('td').removeClass(sc);hds.item(col).addClass(sc[dir=='desc'?1:0]);}});Ext.tree.ColumnResizer=Ext.extend(Ext.util.Observable,{minWidth:14,constructor:function(config){Ext.apply(this,config);Ext.tree.ColumnResizer.superclass.constructor.call(this);},init:function(tree){this.tree=tree;tree.on('render',this.initEvents,this);},initEvents:function(tree){tree.mon(tree.innerHd,'mousemove',this.handleHdMove,this);this.tracker=new Ext.dd.DragTracker({onBeforeStart:this.onBeforeStart.createDelegate(this),onStart:this.onStart.createDelegate(this),onDrag:this.onDrag.createDelegate(this),onEnd:this.onEnd.createDelegate(this),tolerance:3,autoStart:300});this.tracker.initEl(tree.innerHd);tree.on('beforedestroy',this.tracker.destroy,this.tracker);},handleHdMove:function(e,t){var hw=5,x=e.getPageX(),hd=e.getTarget('.x-treegrid-hd',3,true);if(hd){var r=hd.getRegion(),ss=hd.dom.style,pn=hd.dom.parentNode;if(x-r.left&lt;=hw&amp;&amp;hd.dom!==pn.firstChild){var ps=hd.dom.previousSibling;while(ps&amp;&amp;Ext.fly(ps).hasClass('x-treegrid-hd-hidden')){ps=ps.previousSibling;}
if(ps){this.activeHd=Ext.get(ps);ss.cursor=Ext.isWebKit?'e-resize':'col-resize';}}else if(r.right-x&lt;=hw){var ns=hd.dom;while(ns&amp;&amp;Ext.fly(ns).hasClass('x-treegrid-hd-hidden')){ns=ns.previousSibling;}
if(ns){this.activeHd=Ext.get(ns);ss.cursor=Ext.isWebKit?'w-resize':'col-resize';}}else{delete this.activeHd;ss.cursor='';}}},onBeforeStart:function(e){this.dragHd=this.activeHd;return!!this.dragHd;},onStart:function(e){this.dragHeadersDisabled=this.tree.headersDisabled;this.tree.headersDisabled=true;this.proxy=this.tree.body.createChild({cls:'x-treegrid-resizer'});this.proxy.setHeight(this.tree.body.getHeight());var x=this.tracker.getXY()[0];this.hdX=this.dragHd.getX();this.hdIndex=this.tree.findHeaderIndex(this.dragHd);this.proxy.setX(this.hdX);this.proxy.setWidth(x-this.hdX);this.maxWidth=this.tree.outerCt.getWidth()-this.tree.innerBody.translatePoints(this.hdX).left;},onDrag:function(e){var cursorX=this.tracker.getXY()[0];this.proxy.setWidth((cursorX-this.hdX).constrain(this.minWidth,this.maxWidth));},onEnd:function(e){var nw=this.proxy.getWidth(),tree=this.tree,disabled=this.dragHeadersDisabled;this.proxy.remove();delete this.dragHd;tree.columns[this.hdIndex].width=nw;tree.updateColumnWidths();setTimeout(function(){tree.headersDisabled=disabled;},100);}});Ext.ux.tree.TreeGridNodeUI=Ext.extend(Ext.tree.TreeNodeUI,{isTreeGridNodeUI:true,renderElements:function(n,a,targetNode,bulkRender){var t=n.getOwnerTree(),cols=t.columns,c=cols[0],i,buf,len;this.indentMarkup=n.parentNode?n.parentNode.ui.getChildIndent():'';buf=['&lt;tbody class=&quot;x-tree-node&quot;&gt;','&lt;tr ext:tree-node-id=&quot;',n.id,'&quot; class=&quot;x-tree-node-el x-tree-node-leaf ',a.cls,'&quot;&gt;','&lt;td class=&quot;x-treegrid-col&quot;&gt;','&lt;span class=&quot;x-tree-node-indent&quot;&gt;',this.indentMarkup,&quot;&lt;/span&gt;&quot;,'&lt;img src=&quot;',this.emptyIcon,'&quot; class=&quot;x-tree-ec-icon x-tree-elbow&quot; /&gt;','&lt;img src=&quot;',a.icon||this.emptyIcon,'&quot; class=&quot;x-tree-node-icon',(a.icon?&quot; x-tree-node-inline-icon&quot;:&quot;&quot;),(a.iconCls?&quot; &quot;+a.iconCls:&quot;&quot;),'&quot; unselectable=&quot;on&quot; /&gt;','&lt;a hidefocus=&quot;on&quot; class=&quot;x-tree-node-anchor&quot; href=&quot;',a.href?a.href:'#','&quot; tabIndex=&quot;1&quot; ',a.hrefTarget?' target=&quot;'+a.hrefTarget+'&quot;':'','&gt;','&lt;span unselectable=&quot;on&quot;&gt;',(c.tpl?c.tpl.apply(a):a[c.dataIndex]||c.text),'&lt;/span&gt;&lt;/a&gt;','&lt;/td&gt;'];for(i=1,len=cols.length;i&lt;len;i++){c=cols[i];buf.push('&lt;td class=&quot;x-treegrid-col ',(c.cls?c.cls:''),'&quot;&gt;','&lt;div unselectable=&quot;on&quot; class=&quot;x-treegrid-text&quot;',(c.align?' style=&quot;text-align: '+c.align+';&quot;':''),'&gt;',(c.tpl?c.tpl.apply(a):a[c.dataIndex]),'&lt;/div&gt;','&lt;/td&gt;');}
buf.push('&lt;/tr&gt;&lt;tr class=&quot;x-tree-node-ct&quot;&gt;&lt;td colspan=&quot;',cols.length,'&quot;&gt;','&lt;table class=&quot;x-treegrid-node-ct-table&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot; style=&quot;table-layout: fixed; display: none; width: ',t.innerCt.getWidth(),'px;&quot;&gt;&lt;colgroup&gt;');for(i=0,len=cols.length;i&lt;len;i++){buf.push('&lt;col style=&quot;width: ',(cols[i].hidden?0:cols[i].width),'px;&quot; /&gt;');}
buf.push('&lt;/colgroup&gt;&lt;/table&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;');if(bulkRender!==true&amp;&amp;n.nextSibling&amp;&amp;n.nextSibling.ui.getEl()){this.wrap=Ext.DomHelper.insertHtml(&quot;beforeBegin&quot;,n.nextSibling.ui.getEl(),buf.join(''));}else{this.wrap=Ext.DomHelper.insertHtml(&quot;beforeEnd&quot;,targetNode,buf.join(''));}
this.elNode=this.wrap.childNodes[0];this.ctNode=this.wrap.childNodes[1].firstChild.firstChild;var cs=this.elNode.firstChild.childNodes;this.indentNode=cs[0];this.ecNode=cs[1];this.iconNode=cs[2];this.anchor=cs[3];this.textNode=cs[3].firstChild;},animExpand:function(cb){this.ctNode.style.display=&quot;&quot;;Ext.ux.tree.TreeGridNodeUI.superclass.animExpand.call(this,cb);}});Ext.ux.tree.TreeGridRootNodeUI=Ext.extend(Ext.tree.TreeNodeUI,{isTreeGridNodeUI:true,render:function(){if(!this.rendered){this.wrap=this.ctNode=this.node.ownerTree.innerCt.dom;this.node.expanded=true;}
if(Ext.isWebKit){var ct=this.ctNode;ct.style.tableLayout=null;(function(){ct.style.tableLayout='fixed';}).defer(1);}},destroy:function(){if(this.elNode){Ext.dd.Registry.unregister(this.elNode.id);}
delete this.node;},collapse:Ext.emptyFn,expand:Ext.emptyFn});Ext.ux.tree.TreeGridLoader=Ext.extend(Ext.tree.TreeLoader,{createNode:function(attr){if(!attr.uiProvider){attr.uiProvider=Ext.ux.tree.TreeGridNodeUI;}
return Ext.tree.TreeLoader.prototype.createNode.call(this,attr);},processResponse:function(response,node,callback,scope){var json=response.responseText,children,newNode,i=0,len;try{if(!(children=response.responseData)){children=Ext.decode(json);if(this.root){if(!this.getRoot){this.getRoot=Ext.data.JsonReader.prototype.createAccessor(this.root);}
children=this.getRoot(children);}}
node.beginUpdate();for(len=children.length;i&lt;len;i++){if(newNode=this.createNode(children[i])){node.appendChild(newNode);}}
node.endUpdate();this.runCallback(callback,scope||node,[node]);}catch(e){this.handleFailure(response);}}});(function(){Ext.override(Ext.list.Column,{init:function(){var types=Ext.data.Types,st=this.sortType;if(this.type){if(Ext.isString(this.type)){this.type=Ext.data.Types[this.type.toUpperCase()]||types.AUTO;}}else{this.type=types.AUTO;}
if(Ext.isString(st)){this.sortType=Ext.data.SortTypes[st];}else if(Ext.isEmpty(st)){this.sortType=this.type.sortType;}}});Ext.tree.Column=Ext.extend(Ext.list.Column,{});Ext.tree.NumberColumn=Ext.extend(Ext.list.NumberColumn,{});Ext.tree.DateColumn=Ext.extend(Ext.list.DateColumn,{});Ext.tree.BooleanColumn=Ext.extend(Ext.list.BooleanColumn,{});Ext.reg('tgcolumn',Ext.tree.Column);Ext.reg('tgnumbercolumn',Ext.tree.NumberColumn);Ext.reg('tgdatecolumn',Ext.tree.DateColumn);Ext.reg('tgbooleancolumn',Ext.tree.BooleanColumn);})();Ext.ux.tree.TreeGrid=Ext.extend(Ext.tree.TreePanel,{rootVisible:false,useArrows:true,lines:false,borderWidth:Ext.isBorderBox?0:2,cls:'x-treegrid',columnResize:true,enableSort:(this.enableSort!=undefined)?true:this.enableSort,reserveScrollOffset:true,enableHdMenu:(this.enableHdMenu!=undefined)?true:this.enableHdMenu,columnsText:'Columns',initComponent:function(){if(!this.root){this.root=new Ext.tree.AsyncTreeNode({text:'Root'});}
var l=this.loader;if(!l){l=new Ext.ux.tree.TreeGridLoader({dataUrl:this.dataUrl,requestMethod:this.requestMethod,store:this.store});}else if(Ext.isObject(l)&amp;&amp;!l.load){l=new Ext.ux.tree.TreeGridLoader(l);}
this.loader=l;Ext.ux.tree.TreeGrid.superclass.initComponent.call(this);this.initColumns();if(this.enableSort){this.treeGridSorter=new Ext.ux.tree.TreeGridSorter(this,this.enableSort);}
if(this.columnResize){this.colResizer=new Ext.tree.ColumnResizer(this.columnResize);this.colResizer.init(this);}
var c=this.columns;if(!this.internalTpl){this.internalTpl=new Ext.XTemplate('&lt;div class=&quot;x-grid3-header&quot;&gt;','&lt;div class=&quot;x-treegrid-header-inner&quot;&gt;','&lt;div class=&quot;x-grid3-header-offset&quot;&gt;','&lt;table style=&quot;table-layout: fixed;&quot; cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;&lt;colgroup&gt;&lt;tpl for=&quot;columns&quot;&gt;&lt;col /&gt;&lt;/tpl&gt;&lt;/colgroup&gt;','&lt;thead&gt;&lt;tr class=&quot;x-grid3-hd-row&quot;&gt;','&lt;tpl for=&quot;columns&quot;&gt;','&lt;td class=&quot;x-grid3-hd x-grid3-cell x-treegrid-hd&quot; style=&quot;text-align: {align};&quot; id=&quot;',this.id,'-xlhd-{#}&quot;&gt;','&lt;div class=&quot;x-grid3-hd-inner x-treegrid-hd-inner&quot; unselectable=&quot;on&quot;&gt;',this.enableHdMenu?'&lt;a class=&quot;x-grid3-hd-btn&quot; href=&quot;#&quot;&gt;&lt;/a&gt;':'','{header}&lt;img class=&quot;x-grid3-sort-icon&quot; src=&quot;',Ext.BLANK_IMAGE_URL,'&quot; /&gt;','&lt;/div&gt;','&lt;/td&gt;&lt;/tpl&gt;','&lt;/tr&gt;&lt;/thead&gt;','&lt;/table&gt;','&lt;/div&gt;&lt;/div&gt;','&lt;/div&gt;','&lt;div class=&quot;x-treegrid-root-node&quot;&gt;','&lt;table class=&quot;x-treegrid-root-table&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot; style=&quot;table-layout: fixed;&quot;&gt;&lt;/table&gt;','&lt;/div&gt;');}
if(!this.colgroupTpl){this.colgroupTpl=new Ext.XTemplate('&lt;colgroup&gt;&lt;tpl for=&quot;columns&quot;&gt;&lt;col style=&quot;width: {width}px&quot;/&gt;&lt;/tpl&gt;&lt;/colgroup&gt;');}},initColumns:function(){var cs=this.columns,len=cs.length,columns=[],i,c;for(i=0;i&lt;len;i++){c=cs[i];if(!c.isColumn){c.xtype=c.xtype?(/^tg/.test(c.xtype)?c.xtype:'tg'+c.xtype):'tgcolumn';c=Ext.create(c);}
c.init(this);columns.push(c);if(this.enableSort!==false&amp;&amp;c.sortable!==false){c.sortable=true;this.enableSort=true;}}
this.columns=columns;},onRender:function(){Ext.tree.TreePanel.superclass.onRender.apply(this,arguments);this.el.addClass('x-treegrid');this.outerCt=this.body.createChild({cls:'x-tree-root-ct x-treegrid-ct '+(this.useArrows?'x-tree-arrows':this.lines?'x-tree-lines':'x-tree-no-lines')});this.internalTpl.overwrite(this.outerCt,{columns:this.columns});this.mainHd=Ext.get(this.outerCt.dom.firstChild);this.innerHd=Ext.get(this.mainHd.dom.firstChild);this.innerBody=Ext.get(this.outerCt.dom.lastChild);this.innerCt=Ext.get(this.innerBody.dom.firstChild);this.colgroupTpl.insertFirst(this.innerCt,{columns:this.columns});if(this.hideHeaders){this.el.child('.x-grid3-header').setDisplayed('none');}
else if(this.enableHdMenu!==false){this.hmenu=new Ext.menu.Menu({id:this.id+'-hctx'});if(this.enableColumnHide!==false){this.colMenu=new Ext.menu.Menu({id:this.id+'-hcols-menu'});this.colMenu.on({scope:this,beforeshow:this.beforeColMenuShow,itemclick:this.handleHdMenuClick});this.hmenu.add({itemId:'columns',hideOnClick:false,text:this.columnsText,menu:this.colMenu,iconCls:'x-cols-icon'});}
this.hmenu.on('itemclick',this.handleHdMenuClick,this);}},setRootNode:function(node){node.attributes.uiProvider=Ext.ux.tree.TreeGridRootNodeUI;node=Ext.ux.tree.TreeGrid.superclass.setRootNode.call(this,node);if(this.innerCt){this.colgroupTpl.insertFirst(this.innerCt,{columns:this.columns});}
return node;},clearInnerCt:function(){if(Ext.isIE){var dom=this.innerCt.dom;while(dom.firstChild){dom.removeChild(dom.firstChild);}}else{Ext.ux.tree.TreeGrid.superclass.clearInnerCt.call(this);}},initEvents:function(){Ext.ux.tree.TreeGrid.superclass.initEvents.apply(this,arguments);this.mon(this.innerBody,'scroll',this.syncScroll,this);this.mon(this.innerHd,'click',this.handleHdDown,this);this.mon(this.mainHd,{scope:this,mouseover:this.handleHdOver,mouseout:this.handleHdOut});},onResize:function(w,h){Ext.ux.tree.TreeGrid.superclass.onResize.apply(this,arguments);var bd=this.innerBody.dom;var hd=this.innerHd.dom;if(!bd){return;}
if(Ext.isNumber(h)){bd.style.height=this.body.getHeight(true)-hd.offsetHeight+'px';}
if(Ext.isNumber(w)){var sw=Ext.num(this.scrollOffset,Ext.getScrollBarWidth());if(this.reserveScrollOffset||((bd.offsetWidth-bd.clientWidth)&gt;10)){this.setScrollOffset(sw);}else{var me=this;setTimeout(function(){me.setScrollOffset(bd.offsetWidth-bd.clientWidth&gt;10?sw:0);},10);}}},updateColumnWidths:function(){var cols=this.columns,colCount=cols.length,groups=this.outerCt.query('colgroup'),groupCount=groups.length,c,g,i,j;for(i=0;i&lt;colCount;i++){c=cols[i];for(j=0;j&lt;groupCount;j++){g=groups[j];g.childNodes[i].style.width=(c.hidden?0:c.width)+'px';}}
for(i=0,groups=this.innerHd.query('td'),len=groups.length;i&lt;len;i++){c=Ext.fly(groups[i]);if(cols[i]&amp;&amp;cols[i].hidden){c.addClass('x-treegrid-hd-hidden');}
else{c.removeClass('x-treegrid-hd-hidden');}}
var tcw=this.getTotalColumnWidth();Ext.fly(this.innerHd.dom.firstChild).setWidth(tcw+(this.scrollOffset||0));this.outerCt.select('table').setWidth(tcw);this.syncHeaderScroll();},getVisibleColumns:function(){var columns=[],cs=this.columns,len=cs.length,i;for(i=0;i&lt;len;i++){if(!cs[i].hidden){columns.push(cs[i]);}}
return columns;},getTotalColumnWidth:function(){var total=0;for(var i=0,cs=this.getVisibleColumns(),len=cs.length;i&lt;len;i++){total+=cs[i].width;}
return total;},setScrollOffset:function(scrollOffset){this.scrollOffset=scrollOffset;this.updateColumnWidths();},handleHdDown:function(e,t){var hd=e.getTarget('.x-treegrid-hd');if(hd&amp;&amp;Ext.fly(t).hasClass('x-grid3-hd-btn')){var ms=this.hmenu.items,cs=this.columns,index=this.findHeaderIndex(hd),c=cs[index],sort=c.sortable;e.stopEvent();Ext.fly(hd).addClass('x-grid3-hd-menu-open');this.hdCtxIndex=index;this.fireEvent('headerbuttonclick',ms,c,hd,index);this.hmenu.on('hide',function(){Ext.fly(hd).removeClass('x-grid3-hd-menu-open');},this,{single:true});this.hmenu.show(t,'tl-bl?');}
else if(hd){var index=this.findHeaderIndex(hd);this.fireEvent('headerclick',this.columns[index],hd,index);}},handleHdOver:function(e,t){var hd=e.getTarget('.x-treegrid-hd');if(hd&amp;&amp;!this.headersDisabled){index=this.findHeaderIndex(hd);this.activeHdRef=t;this.activeHdIndex=index;var el=Ext.get(hd);this.activeHdRegion=el.getRegion();el.addClass('x-grid3-hd-over');this.activeHdBtn=el.child('.x-grid3-hd-btn');if(this.activeHdBtn){this.activeHdBtn.dom.style.height=(hd.firstChild.offsetHeight-1)+'px';}}},handleHdOut:function(e,t){var hd=e.getTarget('.x-treegrid-hd');if(hd&amp;&amp;(!Ext.isIE||!e.within(hd,true))){this.activeHdRef=null;Ext.fly(hd).removeClass('x-grid3-hd-over');hd.style.cursor='';}},findHeaderIndex:function(hd){hd=hd.dom||hd;var cs=hd.parentNode.childNodes;for(var i=0,c;c=cs[i];i++){if(c==hd){return i;}}
return-1;},beforeColMenuShow:function(){var cols=this.columns,colCount=cols.length,i,c;this.colMenu.removeAll();for(i=1;i&lt;colCount;i++){c=cols[i];if(c.hideable!==false){this.colMenu.add(new Ext.menu.CheckItem({itemId:'col-'+i,text:c.header,checked:!c.hidden,hideOnClick:false,disabled:c.hideable===false}));}}},handleHdMenuClick:function(item){var index=this.hdCtxIndex,id=item.getItemId();if(this.fireEvent('headermenuclick',this.columns[index],id,index)!==false){index=id.substr(4);if(index&gt;0&amp;&amp;this.columns[index]){this.setColumnVisible(index,!item.checked);}}
return true;},setColumnVisible:function(index,visible){this.columns[index].hidden=!visible;this.updateColumnWidths();},scrollToTop:function(){this.innerBody.dom.scrollTop=0;this.innerBody.dom.scrollLeft=0;},syncScroll:function(){this.syncHeaderScroll();var mb=this.innerBody.dom;this.fireEvent('bodyscroll',mb.scrollLeft,mb.scrollTop);},syncHeaderScroll:function(){var mb=this.innerBody.dom;this.innerHd.dom.scrollLeft=mb.scrollLeft;this.innerHd.dom.scrollLeft=mb.scrollLeft;},registerNode:function(n){Ext.ux.tree.TreeGrid.superclass.registerNode.call(this,n);if(!n.uiProvider&amp;&amp;!n.isRoot&amp;&amp;!n.ui.isTreeGridNodeUI){n.ui=new Ext.ux.tree.TreeGridNodeUI(n);}}});Ext.reg('treegrid',Ext.ux.tree.TreeGrid);function utils_logout(){Ext.util.Cookies.set('userLogin','');Ext.util.Cookies.set('hashCode','');Ext.Ajax.defaultHeaders.Authorization='';window.location.reload();}
function URL(url){if(url.length==0)eval('throw &quot;Invalid URL ['+url+'];');this.url=url;this.port=-1;this.query=(this.url.indexOf('?')&gt;=0)?this.url.substring(this.url.indexOf('?')+1):'';if(this.query.indexOf('#')&gt;=0)this.query=this.query.substring(0,this.query.indexOf('#'));this.protocol='';this.host='';var protocolSepIndex=this.url.indexOf('://');if(protocolSepIndex&gt;=0){this.protocol=this.url.substring(0,protocolSepIndex).toLowerCase();this.host=this.url.substring(protocolSepIndex+3);if(this.host.indexOf('/')&gt;=0)this.host=this.host.substring(0,this.host.indexOf('/'));var atIndex=this.host.indexOf('@');if(atIndex&gt;=0){var credentials=this.host.substring(0,atIndex);var colonIndex=credentials.indexOf(':');if(colonIndex&gt;=0){this.username=credentials.substring(0,colonIndex);this.password=credentials.substring(colonIndex);}else{this.username=credentials;}
this.host=this.host.substring(atIndex+1);}
var portColonIndex=this.host.indexOf(':');if(portColonIndex&gt;=0){this.port=this.host.substring(portColonIndex);this.host=this.host.substring(0,portColonIndex);}
this.file=this.url.substring(protocolSepIndex+3);this.file=this.file.substring(this.file.indexOf('/'));}else{this.file=this.url;}
if(this.file.indexOf('?')&gt;=0)this.file=this.file.substring(0,this.file.indexOf('?'));var refSepIndex=url.indexOf('#');if(refSepIndex&gt;=0){this.file=this.file.substring(0,refSepIndex);this.reference=this.url.substring(this.url.indexOf('#'));}else{this.reference='';}
this.path=this.file;if(this.query.length&gt;0)this.file+='?'+this.query;if(this.reference.length&gt;0)this.file+='#'+this.reference;this.getPort=getPort;this.getQuery=getQuery;this.getProtocol=getProtocol;this.getHost=getHost;this.getUserName=getUserName;this.getPassword=getPassword;this.getFile=getFile;this.getReference=getReference;this.getPath=getPath;this.getArgumentValue=getArgumentValue;this.getArgumentValues=getArgumentValues;this.toString=toString;function getPort(){return this.port;}
function getQuery(){return this.query;}
function getProtocol(){return this.protocol;}
function getHost(){return this.host;}
function getUserName(){return this.username;}
function getPassword(){return this.password;}
function getFile(){return this.file;}
function getReference(){return this.reference;}
function getPath(){return this.path;}
function getArgumentValue(key){var a=this.getArgumentValues();if(a.length&lt;1)return'';for(var i=0;i&lt;a.length;i++){if(a[i][0]==key)return a[i][1];}
return'';}
function getArgumentValues(){var a=new Array();var b=this.query.split('&amp;amp;');var c='';if(b.length&lt;1)return a;for(var i=0;i&lt;b.length;i++){c=b[i].split('=');a[i]=new Array(c[0],((c.length==1)?c[0]:c[1]));}
return a;}
function toString(){return this.url;}}
Ext.namespace('sitools.widget');sitools.widget.FeedGridFlux=function(config){this.datasetName=config.datasetName;function clickOnRow(self,rowIndex,e){e.stopEvent();var rec=self.store.getAt(rowIndex);if(Ext.isEmpty(rec)){return;}
if(Ext.isEmpty(window)||Ext.isEmpty(window.SitoolsDesk)){var component=new sitools.widget.feedItemDetails({record:rec});var win=new Ext.Window({stateful:false,title:i18n.get('label.viewFeedDetail'),width:400,height:600,shim:false,animCollapse:false,constrainHeader:true,layout:'fit',modal:true});win.add(component);win.show();}else{var componentCfg={record:rec};var jsObj=sitools.widget.feedItemDetails;var windowConfig={id:&quot;viewFeedDetail&quot;,title:i18n.get('label.viewFeedDetail'),saveToolbar:false};SitoolsDesk.addDesktopWindow(windowConfig,componentCfg,jsObj,true);}}
Ext.apply(this);this.layout=&quot;fit&quot;;var gridPanel;if(config.feedSource!==undefined&amp;&amp;config.feedSource===&quot;OPENSEARCH&quot;){gridPanel=new sitools.user.component.openSearchResultFeed(config);}else{config.listeners={rowdblclick:clickOnRow};if(config.feedType!==undefined&amp;&amp;config.feedType===&quot;atom_1.0&quot;){gridPanel=new sitools.widget.atom1FeedReader(config);}else{gridPanel=new sitools.widget.rss2FeedReader(config);}}
this.items=[gridPanel];sitools.widget.FeedGridFlux.superclass.constructor.call(this);};Ext.extend(sitools.widget.FeedGridFlux,Ext.Panel,{componentType:&quot;feeds&quot;,_getSettings:function(){return{objectName:&quot;feedsReader&quot;};},border:false});Ext.reg('appfeedgridflux',sitools.widget.FeedGridFlux);Ext.namespace('sitools.widget');sitools.widget.rss2FeedReader=function(config){Ext.apply(this);this.layout=&quot;fit&quot;;this.storeFeedsRecords=new Ext.data.Store({autoLoad:true,sortInfo:{field:'pubDate',direction:&quot;DESC&quot;},proxy:new Ext.data.HttpProxy({url:config.urlFeed,restful:true,listeners:{scope:this,exception:onRequestFeedException}}),reader:new Ext.data.XmlReader({record:'item'},['title','author',{name:'pubDate',type:'date'},'link','description','content','guid',{name:'imageUrl',mapping:&quot;enclosure@url&quot;},{name:'imageType',mapping:&quot;enclosure@type&quot;}])});var columns=[{id:'image',header:&quot;Image&quot;,dataIndex:'imageUrl',sortable:false,width:120,renderer:this.imageRenderer},{id:'title',header:&quot;Title&quot;,dataIndex:'title',sortable:true,width:460,scope:this,renderer:this.formatTitle},{header:&quot;Author&quot;,dataIndex:'author',width:100,hidden:true,sortable:true},{id:'last',header:&quot;Date&quot;,dataIndex:'pubDate',width:150,renderer:this.formatDate,sortable:true,hidden:true}];sitools.widget.rss2FeedReader.superclass.constructor.call(this,{columns:columns,store:this.storeFeedsRecords,loadMask:{msg:i18n.get(&quot;label.loadingFeed&quot;)},sm:new Ext.grid.RowSelectionModel({singleSelect:true}),autoExpandColumn:'title',hideHeaders:true,viewConfig:{forceFit:true,enableRowBody:true,showPreview:true,getRowClass:this.applyRowClass},listeners:config.listeners});};Ext.extend(sitools.widget.rss2FeedReader,Ext.grid.GridPanel,{loadData:function(){this.loadFeed('http://feeds.feedburner.com/extblog');this.doLayout();},loadFeed:function(url){this.store.baseParams={feed:url};this.store.load();},togglePreview:function(show){this.view.showPreview=show;this.view.refresh();},applyRowClass:function(record,rowIndex,p,ds){if(this.showPreview){var xf=Ext.util.Format;p.body='&lt;p class=sous-titre-flux&gt;'+xf.ellipsis(xf.stripTags(record.data.description),200)+'&lt;/p&gt;';return'x-grid3-row-expanded';}
return'x-grid3-row-collapsed';},formatDate:function(date){if(!date){return'';}
var now=new Date();var d=now.clearTime(true);if(date instanceof Date){var notime=date.clearTime(true).getTime();if(notime==d.getTime()){return'Today '+date.dateFormat('g:i a');}
d=d.add('d',-6);if(d.getTime()&lt;=notime){return date.dateFormat('D g:i a');}
return date.dateFormat('n/j g:i a');}
else{return date;}},formatTitle:function(value,p,record){var link=record.data.link;var xf=Ext.util.Format;var author=(Ext.isEmpty(record.data.author))?&quot;&quot;:record.data.author;var dateFormat=this.formatDate(record.data.pubDate);var res=&quot;&quot;;if(link!==undefined&amp;&amp;link!==&quot;&quot;){res=String.format('&lt;div class=&quot;topic&quot;&gt;&lt;a href=&quot;{0}&quot; title=&quot;{1}&quot; target=&quot;_blank&quot;&gt;&lt;span class=&quot;rss_feed_title&quot;&gt;{2}&lt;/span&gt;&lt;/a&gt;&lt;br/&gt;&lt;span class=&quot;author&quot;&gt;{3}&lt;/span&gt;&lt;/div&gt;',link,value,xf.ellipsis(xf.stripTags(value),30),author);}else{res=String.format('&lt;div class=&quot;topic&quot;&gt;&lt;span class=&quot;rss_feed_title&quot;&gt;{0}&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;author&quot;&gt;{1}&lt;/span&gt;&lt;/div&gt;',xf.ellipsis(xf.stripTags(value),30),author);}
if(dateFormat!=&quot;&quot;&amp;&amp;dateFormat!=null){res+=String.format('&lt;p id=&quot;feeds-date&quot;&gt;{0}&lt;/p&gt;',dateFormat);}
return res;},imageRenderer:function(value,p,record){if(Ext.isEmpty(value)||Ext.isEmpty(record.data.imageType)){return&quot;&quot;;}
if(record.data.imageType.substr(0,5)!=&quot;image&quot;){return&quot;&quot;;}
return String.format('&lt;img src=&quot;{0}&quot; width=&quot;50px&quot;&gt;',value);},sortByDate:function(direction){this.storeFeedsRecords.sort('pubDate',direction);}});Ext.namespace('sitools.widget');sitools.widget.atom1FeedReader=function(config){Ext.apply(this);this.layout=&quot;fit&quot;;this.storeFeedsRecords=new Ext.data.Store({autoLoad:true,sortInfo:{field:'pubDate',direction:&quot;DESC&quot;},proxy:new Ext.data.HttpProxy({url:config.urlFeed,restful:true,listeners:{scope:this,exception:onRequestFeedException}}),reader:new Ext.data.XmlReader({record:'entry'},['title',{name:'author',mapping:&quot;author.name&quot;},{name:'pubDate',mapping:'updated',type:'date'},{name:'link',mapping:&quot;link@href&quot;},{name:'description',mapping:'content'},'content',{name:'imageUrl',createAccessor:function(data,field){var q=Ext.DomQuery;var node=q.selectNode(&quot;link[type^=image]&quot;,data);var result={};if(Ext.isEmpty(node)){return result;}
Ext.each(node.attributes,function(attribute){result[attribute.name]=attribute.value;});return result;}}])});var columns=[{id:'image',header:&quot;Image&quot;,dataIndex:'imageUrl',sortable:false,width:120,renderer:this.imageRenderer},{id:'title',header:&quot;Title&quot;,dataIndex:'title',sortable:true,width:460,scope:this,renderer:this.formatTitle},{header:&quot;Author&quot;,dataIndex:'author',width:100,hidden:true,sortable:true},{id:'last',header:&quot;Date&quot;,dataIndex:'pubDate',width:150,renderer:this.formatDate,sortable:true,hidden:true}];sitools.widget.atom1FeedReader.superclass.constructor.call(this,{columns:columns,store:this.storeFeedsRecords,loadMask:{msg:i18n.get(&quot;label.loadingFeed&quot;)},sm:new Ext.grid.RowSelectionModel({singleSelect:true}),autoExpandColumn:'title',hideHeaders:true,viewConfig:{forceFit:true,enableRowBody:true,showPreview:true,getRowClass:this.applyRowClass},listeners:config.listeners});};Ext.extend(sitools.widget.atom1FeedReader,Ext.grid.GridPanel,{loadFeed:function(url){this.store.baseParams={feed:url};this.store.load();},togglePreview:function(show){this.view.showPreview=show;this.view.refresh();},applyRowClass:function(record,rowIndex,p,ds){if(this.showPreview){var xf=Ext.util.Format;if(record.data.summary!=&quot;&quot;&amp;&amp;record.data.summary!=undefined){p.body='&lt;p class=sous-titre-flux&gt;'+xf.ellipsis(xf.stripTags(record.data.summary),200)+'&lt;/p&gt;';return'x-grid3-row-expanded';}}
return'x-grid3-row-collapsed';},formatDate:function(date){if(!date){return'';}
var now=new Date();var d=now.clearTime(true);if(date instanceof Date){var notime=date.clearTime(true).getTime();if(notime==d.getTime()){return'Today '+date.dateFormat('g:i a');}
d=d.add('d',-6);if(d.getTime()&lt;=notime){return date.dateFormat('D g:i a');}
return date.dateFormat('n/j g:i a');}
else{return date;}},formatTitle:function(value,p,record){var author=(record.data.author.name!==undefined)?record.data.author.name:&quot;&quot;;var link=record.data.link;var xf=Ext.util.Format;var dateFormat=this.formatDate(record.data.updated);var author=(record.data.author.name!==undefined)?record.data.author.name:&quot;&quot;;var authorEmail=(record.data.author.email!==undefined)?record.data.author.email:&quot;&quot;;var res=&quot;&quot;;if(link!==undefined&amp;&amp;link!==&quot;&quot;){res=String.format('&lt;div class=&quot;topic&quot;&gt;&lt;a href=&quot;{0}&quot; title=&quot;{1}&quot; target=&quot;_blank&quot;&gt;&lt;span class=&quot;rss_feed_title&quot;&gt;{2}&lt;/span&gt;&lt;/a&gt;&lt;br/&gt;&lt;span class=&quot;author&quot;&gt;{3}&lt;/span&gt;&lt;/div&gt;',link,value,xf.ellipsis(xf.stripTags(value),30),author);}else{res=String.format('&lt;div class=&quot;topic&quot;&gt;&lt;span class=&quot;rss_feed_title&quot;&gt;{0}&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;author&quot;&gt;{1}&lt;/span&gt;&lt;/div&gt;',xf.ellipsis(xf.stripTags(value),30),author);}
if(dateFormat!=&quot;&quot;&amp;&amp;dateFormat!=undefined){res+=String.format('&lt;p id=&quot;feeds-date&quot;&gt;{0}&lt;/p&gt;',dateFormat);}
return res;},imageRenderer:function(value,p,record){if(Ext.isEmpty(value)||Ext.isEmpty(value.href)){return&quot;&quot;;}
if(value.type.substr(0,5)!=&quot;image&quot;){return&quot;&quot;;}
return String.format('&lt;img src=&quot;{0}&quot; width=&quot;50px&quot;&gt;',value.href);},sortByDate:function(direction){this.storeFeedsRecords.sort('pubDate',direction);}});Ext.namespace('sitools.widget');sitools.widget.feedItemDetails=Ext.extend(Ext.Panel,{initComponent:function(){this.layout=&quot;fit&quot;;var record=this.record;if(!Ext.isEmpty(record)){this.store=new Ext.data.JsonStore({idProperty:'title',fields:[{name:'title'},{name:'pubDate',type:'date',dateFormat:'timestamp'},{name:'published',type:'date',dateFormat:'timestamp'},{name:'author'},{name:'link'},{name:'description'},{name:'imageUrl'},{name:'image'}],listeners:{scope:this,add:function(store,records,ind){if(record.data.imageUrl==undefined&amp;&amp;record.data.image!=undefined){record.data.image=record.data.imageUrl;}
if(records[0].data.pubDate!=&quot;&quot;){records[0].data.pubDate=this.formatDate(records[0].data.pubDate);}}}});this.store.add(record);this.tpl=new Ext.XTemplate('&lt;tpl for=&quot;.&quot;&gt;','&lt;div class=&quot;feed-article&quot;&gt;','&lt;tpl if=&quot;this.isDisplayable(imageUrl)&quot;&gt;','&lt;div class=&quot;feed-img&quot;&gt;','&lt;img src=&quot;{imageUrl}&quot; title=&quot;{title}&quot; width=&quot;70&quot; height=&quot;70&quot;/&gt;','&lt;/div&gt;','&lt;/tpl&gt;','&lt;p class=&quot;feed-title&quot;&gt; {title} &lt;/p&gt;','&lt;tpl if=&quot;this.isDisplayable(pubDate)&quot;&gt;','&lt;div class=&quot;feed-date-detail&quot;&gt;','&lt;b&gt; Date : &lt;/b&gt; {pubDate} ','&lt;/div&gt;','&lt;/tpl&gt;','&lt;tpl if=&quot;this.isDisplayable(author)&quot;&gt;','&lt;div class=&quot;feed-author&quot;&gt;','&lt;b&gt; Author : &lt;/b&gt; {author} ','&lt;/div&gt;','&lt;/tpl&gt;','&lt;div class=&quot;feed-description&quot;&gt;','{description}','&lt;/div&gt;','&lt;div class=&quot;feed-complementary&quot;&gt;','&lt;p style=&quot;padding-bottom: 3px;&quot;&gt; &lt;b&gt; Link : &lt;/b&gt; &lt;a href=&quot;{link}&quot; target=&quot;_blank&quot; title=&quot;{title}&quot;&gt;{link}&lt;/a&gt; &lt;/p&gt;','&lt;tpl if=&quot;this.isDisplayable(imageUrl)&quot;&gt;','&lt;p&gt; &lt;b&gt; Image Url : &lt;/b&gt; &lt;a href=&quot;{imageUrl}&quot; target=&quot;_blank&quot;&gt;{imageUrl}&lt;/a&gt; &lt;/p&gt;','&lt;/tpl&gt;','&lt;/div&gt;','&lt;/div&gt;','&lt;/tpl&gt;',{compiled:true,isDisplayable:function(item){if(item!=&quot;&quot;&amp;&amp;item!=undefined){return true;}
else{return false;}}});this.feedsDataview=new Ext.DataView({id:'detailFeed-view',autoScroll:true,layout:'fit',store:this.store,tpl:this.tpl,cls:'detailFeed-view',emptyText:i18n.get('label.nothingToDisplay')});this.componentType='feedDetails';this.items=[this.feedsDataview];}
sitools.widget.feedItemDetails.superclass.initComponent.call(this);},formatDate:function(date){if(!date){return'';}
var now=new Date();var d=now.clearTime(true);if(date instanceof Date){var notime=date.clearTime(true).getTime();if(notime==d.getTime()){return'Today '+date.dateFormat('g:i a');}
d=d.add('d',-6);if(d.getTime()&lt;=notime){return date.dateFormat('D g:i a');}
return date.dateFormat('n/j g:i a');}
else{return date;}},showMeInFixedNav:function(me,config){Ext.apply(config.windowSettings,{width:config.windowSettings.winWidth||DEFAULT_WIN_WIDTH,height:config.windowSettings.winHeight||DEFAULT_WIN_HEIGHT});SitoolsDesk.openModalWindow(me,config);},showMeInDesktopNav:function(me,config){Ext.apply(config.windowSettings,{width:config.windowSettings.winWidth||DEFAULT_WIN_WIDTH,height:config.windowSettings.winHeight||DEFAULT_WIN_HEIGHT});SitoolsDesk.openModalWindow(me,config);}});function utils_logout(){Ext.util.Cookies.set('userLogin','');Ext.util.Cookies.set('hashCode','');Ext.Ajax.defaultHeaders.Authorization='';window.location.reload();}
Ext.namespace('sitools.user.desktop.navProfile');sitools.user.desktop.navProfile.desktop={context:&quot;desktop&quot;,createComponent:function(config){var desktop=getDesktop();var componentCfg=config.componentCfg;var component=new config.JsObj(componentCfg);var windowSettings=config.windowSettings;if(Ext.isFunction(component.showMeInDesktopNav)){component.showMeInDesktopNav(component,config);return;}
var reloadComp=config.reloadComp;if(Ext.isEmpty(component._getSettings)){component._getSettings=function(){return{};};}
var newwin;var winHeight=windowSettings.winHeight||DEFAULT_WIN_HEIGHT;var winWidth=windowSettings.winWidth||DEFAULT_WIN_WIDTH;var x=windowSettings.x;var y=windowSettings.y;var desktopEl=getDesktop().getDesktopEl();if(x&lt;desktopEl.dom.offsetLeft){x=desktopEl.dom.offsetLeft;}
if(y&lt;desktopEl.dom.offsetTop){y=desktopEl.dom.offsetTop;}
if(x+winWidth&gt;desktopEl.dom.offsetLeft+desktopEl.dom.offsetWidth){winWidth=desktopEl.dom.offsetLeft+desktopEl.dom.offsetLeft-x;}
if(y+winHeight&gt;desktopEl.dom.offsetTop+desktopEl.dom.offsetHeight){winHeight=desktopEl.dom.offsetTop+desktopEl.dom.offsetHeight-y;}
var tbar;if(!Ext.isEmpty(windowSettings.toolbarItems)){tbar=new Ext.Toolbar({xtype:'toolbar',items:windowSettings.toolbarItems});}
var fileName=&quot;&quot;;var title=windowSettings.title;if(windowSettings.type===&quot;form&quot;){fileName=windowSettings.type+componentCfg.formName;}
else if(windowSettings.type===&quot;data&quot;&amp;&amp;Ext.isDefined(component.getWindowTitle)){title=component.getWindowTitle(windowSettings.datasetDescription,windowSettings.datasetName);}
else{fileName=windowSettings.type;}
newwin=desktop.createWindow({id:windowSettings.id,stateful:false,title:title,width:winWidth,iconCls:windowSettings.iconCls,height:winHeight,shim:false,tbar:tbar,animCollapse:false,x:x,y:y,constrainHeader:true,layout:'fit',specificType:'componentWindow',datasetName:windowSettings.datasetName,datasetDescription:windowSettings.datasetDescription,fileName:fileName,component:component,autoscroll:true,typeWindow:windowSettings.type,maximized:windowSettings.maximized,listeners:{render:function(me){me.getEl().fadeIn({duration:.5});}},tools:[{id:&quot;save&quot;,scope:this,qtip:i18n.get('label.saveSettings'),handler:function(event,toolEl,window){if(projectGlobal.isAdmin){var ctxMenu=new Ext.menu.Menu({items:['&lt;b class=&quot;menu-title&quot;&gt;'+i18n.get('label.chooseSave')+'&lt;/b&gt;',{text:i18n.get(&quot;label.myself&quot;),handler:function(){window.saveSettings(window.component._getSettings(),false);}},{text:i18n.get(&quot;label.publicUser&quot;),handler:function(){window.saveSettings(window.component._getSettings(),true);}}]});ctxMenu.showAt(event.getXY());}
else{window.saveSettings(window.component._getSettings());}},hidden:Ext.isEmpty(userLogin)||!windowSettings.saveToolbar}]});var pos,size;pos=windowSettings.position;size=windowSettings.size;if(size!==null){size=Ext.decode(size);newwin.setSize(size);}
else{size=newwin.getSize();size.width=size.width+1;newwin.setSize(size);}
newwin.show();newwin.add(component);if(!Ext.isEmpty(pos)){pos=Ext.decode(pos);newwin.setPosition(pos);}
if(SitoolsDesk.desktopMaximizeMode){SitoolsDesk.getDesktop().minimize();SitoolsDesk.getDesktop().maximize();}
else{SitoolsDesk.getDesktop().maximize();SitoolsDesk.getDesktop().minimize();}
newwin.doLayout();},openModule:function(module){var desktop=getDesktop();var win=desktop.getWindow(module.id);if(!win){win=desktop.createWindow({id:module.id,stateful:false,title:i18n.get(module.title),width:module.defaultWidth,height:module.defaultHeight,iconCls:module.icon,x:module.x,y:module.y,shim:false,animCollapse:false,constrainHeader:true,layout:'fit',specificType:&quot;moduleWindow&quot;,listeners:{render:function(me){me.getEl().fadeIn({duration:.5});}},items:[{id:module.id+&quot;_module&quot;,noBorder:true,layout:'fit',xtype:module.xtype,moduleProperties:module.properties,listProjectModulesConfig:module.listProjectModulesConfig}]});if(!Ext.isEmpty(projectGlobal.preferences)){Ext.each(projectGlobal.preferences.windowSettings,function(preference){if(preference.windowSettings.moduleId==module.id){if(preference.windowSettings.maximized){win.minimize();win.maximize();}
else{var pos=preference.windowSettings.position;var size=preference.windowSettings.size;if(pos!==null&amp;&amp;size!==null){pos=Ext.decode(pos);size=Ext.decode(size);win.setPosition(pos);win.setSize(size);}}}});}}else{desktop.getManager().bringToFront(win);}
win.show();return win;},initNavbar:function(){return;},multiDataset:{getObjectResults:function(){return sitools.user.component.forms.resultsProjectForm;},showDataset:function(grid,rowIndex,colIndex){var rec=grid.getStore().getAt(rowIndex);if(Ext.isEmpty(rec)){return;}
if(rec.get('status')==&quot;REQUEST_ERROR&quot;){return;}
sitools.user.clickDatasetIcone(rec.get(&quot;url&quot;),&quot;data&quot;,{formMultiDsParams:this.formMultiDsParams});}},taskbar:{getContextMenuItems:function(){return[{text:'Restore',handler:function(){if(!this.win.isVisible()){this.win.show();}else{this.win.restore();}},scope:this},{text:'Minimize',handler:this.win.minimize,scope:this.win},{text:'Maximize',handler:this.win.maximize,scope:this.win},'-',{text:'Close',handler:this.closeWin.createDelegate(this,this.win,true),scope:this.win}];},handleTaskButton:function(btn){var win=btn.win;if(win.minimized||win.hidden){win.show();}else if(win==win.manager.getActive()){win.minimize();}else{win.toFront();}},closeWin:function(cMenu,e,win){if(!win.isVisible()){win.show();}else{win.restore();}
win.close();},beforeShowCtxMenu:function(){var items=this.cmenu.items.items;var w=this.win;items[0].setDisabled(w.maximized!==true&amp;&amp;w.hidden!==true);items[1].setDisabled(w.minimized===true);items[2].setDisabled(w.maximized===true||w.hidden===true);},initTaskbar:function(){SitoolsDesk.getDesktop().taskbar.setEnableWarning(false);var showDesktopButton=new Ext.Button({action:&quot;minimize&quot;,handler:function(btn){if(btn.action===&quot;minimize&quot;){SitoolsDesk.minifyAllWindows();btn.action=&quot;maximize&quot;;}
else{SitoolsDesk.openAllWindows();btn.action=&quot;minimize&quot;;}},scale:&quot;medium&quot;,tooltip:{html:i18n.get(&quot;label.showDesktopButton&quot;),anchor:'bottom',trackMouse:false},template:new Ext.Template('&lt;table cellspacing=&quot;0&quot; class=&quot;x-btn {3}&quot;&gt;&lt;tbody&gt;&lt;tr&gt;','&lt;td&gt;&lt;em class=&quot;{5} unselectable=&quot;on&quot;&gt;','&lt;button type=&quot;{1}&quot; id=&quot;btn-showDesk&quot; style=&quot;height:29px; width:18px;&quot;&gt;{0}&lt;/button&gt;','&lt;/em&gt;&lt;/td&gt;','&lt;td&gt;&lt;i&gt;&amp;#160;&lt;/i&gt;&lt;/td&gt;',&quot;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&quot;)});var removeActivePanel=new Ext.Button({scope:this,handler:function(){SitoolsDesk.removeAllWindows();},scale:&quot;medium&quot;,icon:&quot;/sitools/common/res/images/taskbar/black/close-icon.png&quot;,iconCls:'taskbarButtons-icon',tooltip:{html:i18n.get('label.removeActiveModule'),anchor:'bottom',trackMouse:false},template:new Ext.Template('&lt;table cellspacing=&quot;0&quot; class=&quot;x-btn {3}&quot; style=&quot;padding-left: 25px;&quot;&gt;&lt;tbody&gt;&lt;tr&gt;','&lt;td&gt;&lt;i&gt;&amp;#160;&lt;/i&gt;&lt;/td&gt;','&lt;td&gt;&lt;em class=&quot;{5} unselectable=&quot;on&quot;&gt;','&lt;button type=&quot;{1}&quot; style=&quot;height:28px; width:28px; padding-left:12px;&quot;&gt;{0}&lt;/button&gt;','&lt;/em&gt;&lt;/td&gt;','&lt;td&gt;&lt;i&gt;&amp;#160;&lt;/i&gt;&lt;/td&gt;',&quot;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&quot;)});SitoolsDesk.getDesktop().taskbar.staticButtonPanel.addStaticButton(showDesktopButton);SitoolsDesk.getDesktop().taskbar.staticButtonPanel.addStaticButton(removeActivePanel);}},getFormOpenMode:function(){return sitools.user.component.forms.mainContainer;},getDatasetOpenMode:function(dataset){return dataset.datasetView.jsObject;},addSpecificFormParameters:function(componentCfg,dataset){return componentCfg;},manageProjectGraphColumns:function(columnsModel){return columnsModel.push({width:70,header:i18n.get(&quot;label.forms&quot;),tpl:new Ext.XTemplate('{[datasetId=&quot;&quot;]}','&lt;tpl if=&quot;this.exists(datasetId) &amp;&amp; authorized==\'true\'&quot;&gt;{url:this.getIcone}&lt;/tpl&gt;',{exists:function(o){return typeof o!=='undefined'&amp;&amp;o!==null&amp;&amp;o!=='';},getIcone:function(value){return&quot;&lt;a href='#' onClick='sitools.user.clickDatasetIcone(\&quot;&quot;+value
+&quot;\&quot;, \&quot;forms\&quot;); return false;'&gt;&lt;img src='&quot;+loadUrl.get('APP_URL')
+&quot;/common/res/images/icons/form_list_small.png'&gt;&lt;/a&gt;&quot;;},compiled:true,disableFormats:false}),align:'center'});},manageDatasetViewAlbumIconForm:function(value){return&quot;&lt;a href='#' onClick='sitools.user.clickDatasetIcone(\&quot;&quot;+value
+&quot;\&quot;, \&quot;forms\&quot;); return false;'&gt;&lt;img src='&quot;+loadUrl.get('APP_URL')
+&quot;/common/res/images/icons/32x32/form_list_32.png'&gt;&lt;/a&gt;&quot;;},manageDatasetExplorerShowDefinitionAndForms:function(commonTreeUtils,node,dataset){commonTreeUtils.addShowDefinition(node,dataset);commonTreeUtils.addForm(node,dataset);return commonTreeUtils;},getDesktopSettings:function(forPublicUser){var desktopSettings=[];getDesktop().getManager().each(function(window){var componentSettings;if(!Ext.isEmpty(window.specificType)&amp;&amp;(window.specificType==='componentWindow'||window.specificType==='moduleWindow')){if(Ext.isFunction(window.saveSettings)){var component=window.get(0);componentSettings=component._getSettings();desktopSettings.push(window.saveSettings(componentSettings,forPublicUser));}}});return desktopSettings;},loadPreferences:function(scope){Ext.each(projectGlobal.preferences.windowSettings,function(pref){if(Ext.isEmpty(pref.windowSettings.typeWindow)){var moduleId=pref.windowSettings.moduleId;var module=SitoolsDesk.app.getModule(moduleId);if(!Ext.isEmpty(module)&amp;&amp;Ext.isEmpty(module.divIdToDisplay)){var win=module.openModule();var pos=pref.windowSettings.position;var size=pref.windowSettings.size;if(pos!==null&amp;&amp;size!==null){pos=Ext.decode(pos);size=Ext.decode(size);win.setPosition(pos[0],pos[1]);win.setSize(size);}}}
else{var type=pref.windowSettings.typeWindow;var componentCfg,jsObj,windowSettings;if(type===&quot;data&quot;){var datasetUrl=pref.componentSettings.datasetUrl;Ext.Ajax.request({method:&quot;GET&quot;,url:datasetUrl,success:function(ret){var Json=Ext.decode(ret.responseText);if(showResponse(ret)){var dataset=Json.dataset;var componentCfg,javascriptObject;var windowConfig={datasetName:dataset.name,datasetDescription:dataset.description,type:type,saveToolbar:true,toolbarItems:[],iconCls:&quot;dataviews&quot;};javascriptObject=eval(dataset.datasetView.jsObject);Ext.apply(windowConfig,{id:type+dataset.id});if(dataset.description!==&quot;&quot;){windowConfig.title=dataset.description;}
else{windowConfig.title=&quot;Diplay data :&quot;+dataset.name;}
componentCfg={dataUrl:dataset.sitoolsAttachementForUsers,datasetId:dataset.id,datasetCm:dataset.columnModel,datasetName:dataset.name,datasetViewConfig:dataset.datasetViewConfig,dictionaryMappings:dataset.dictionaryMappings,preferencesPath:&quot;/&quot;+dataset.name,preferencesFileName:&quot;datasetView&quot;};SitoolsDesk.addDesktopWindow(windowConfig,componentCfg,javascriptObject);}},failure:alertFailure});}
if(type===&quot;formProject&quot;){jsObj=sitools.user.component.forms.projectForm;componentCfg={formId:pref.componentSettings.formId,formName:pref.componentSettings.formName,formParameters:pref.componentSettings.formParameters,formWidth:pref.componentSettings.formWidth,formHeight:pref.componentSettings.formHeight,formCss:pref.componentSettings.formCss,properties:pref.componentSettings.properties,urlServicePropertiesSearch:pref.componentSettings.urlServicePropertiesSearch,urlServiceDatasetSearch:pref.componentSettings.urlServiceDatasetSearch,preferencesPath:pref.componentSettings.preferencesPath,preferencesFileName:pref.componentSettings.preferencesFileName};windowSettings={type:&quot;formProject&quot;,title:i18n.get('label.forms')+&quot; : &quot;+pref.componentSettings.formName,id:&quot;formProject&quot;+pref.componentSettings.formId,saveToolbar:true,datasetName:pref.componentSettings.formName,winWidth:600,winHeight:600,iconCls:&quot;form&quot;};SitoolsDesk.addDesktopWindow(windowSettings,componentCfg,jsObj);}
if(type===&quot;form&quot;){jsObj=sitools.user.component.forms.mainContainer;componentCfg={dataUrl:pref.componentSettings.dataUrl,dataset:pref.componentSettings.dataset,formId:pref.componentSettings.formId,formName:pref.componentSettings.formName,formParameters:pref.componentSettings.formParameters,formWidth:pref.componentSettings.formWidth,formHeight:pref.componentSettings.formHeight,formCss:pref.componentSettings.formCss,preferencesPath:pref.componentSettings.preferencesPath,preferencesFileName:pref.componentSettings.preferencesFileName};if(projectGlobal.navigationMode==&quot;fixed&quot;){jsObj=sitools.user.component.DatasetOverview;componentCfg.sitoolsAttachementForUsers=dataset.sitoolsAttachementForUsers;}
windowSettings={datasetName:pref.componentSettings.dataset.name,type:&quot;form&quot;,title:i18n.get('label.forms')+&quot; : &quot;+pref.componentSettings.dataset.name+&quot;.&quot;+pref.componentSettings.formName,id:&quot;form&quot;+pref.componentSettings.dataset.id+pref.componentSettings.formId,saveToolbar:true,iconCls:&quot;form&quot;};SitoolsDesk.addDesktopWindow(windowSettings,componentCfg,jsObj);}}},scope);}};Ext.namespace('sitools.user.desktop.navProfile');sitools.user.desktop.navProfile.fixed={context:&quot;fixed&quot;,createComponent:function(config){var component=new config.JsObj(config.componentCfg);var windowSettings=config.windowSettings;if(Ext.isFunction(component.showMeInFixedNav)){component.showMeInFixedNav(component,config);return;}
SitoolsDesk.removeActivePanel();var desktop=getDesktop();var desktopEl=desktop.getDesktopEl();Ext.apply(component,{height:desktopEl.getHeight()});desktop.activePanel=desktop.createPanel({title:windowSettings.title,border:false,layout:'fit',height:desktop.getDesktopEl().getHeight(),width:desktop.getDesktopEl().getWidth(),iconCls:windowSettings.iconCls,renderTo:desktop.getDesktopEl(),noBorder:true,items:[component],listeners:{render:function(me){me.getEl().fadeIn({duration:.5});},resizeDesktop:function(me){me.setSize(desktop.getDesktopEl().getSize());var child=me.items.items[0];if(child&amp;&amp;child.getEl()){child.fireEvent(&quot;resize&quot;,child,me.body.getWidth(),me.body.getHeight(),child.getWidth(),child.getHeight());}},maximizeDesktop:function(me){me.fireEvent(&quot;resize&quot;,me);},minimizeDesktop:function(me){me.fireEvent(&quot;resize&quot;,me);}}});},openModule:function(module){var desktop=getDesktop();SitoolsDesk.removeActivePanel();SitoolsDesk.minifyAllWindows();var panelToOpen=Ext.getCmp(module.id);if(panelToOpen){panelToOpen.setSize(SitoolsDesk.getDesktop().getDesktopEl().getSize());SitoolsDesk.getDesktop().activePanel=panelToOpen;panelToOpen.show();return;}
desktop.activePanel=desktop.createPanel({id:module.id,border:false,title:i18n.get(module.title),cls:&quot;sitools-module-panel&quot;,layout:'fit',specificType:&quot;module&quot;,iconCls:module.icon,height:desktop.getDesktopEl().getHeight(),width:desktop.getDesktopEl().getWidth(),renderTo:desktop.getDesktopEl(),noBorder:true,items:[{noBorder:true,layout:'fit',xtype:module.xtype,moduleProperties:module.properties,listProjectModulesConfig:module.listProjectModulesConfig}],listeners:{render:function(me){me.getEl().fadeIn({duration:.5});},resizeDesktop:function(me){me.setSize(desktop.getDesktopEl().getSize());var child=me.items.items[0];if(child&amp;&amp;child.getEl()){child.fireEvent(&quot;resize&quot;,child,me.body.getWidth(),me.body.getHeight(),child.getWidth(),child.getHeight());}},maximizeDesktop:function(me){me.fireEvent(&quot;resize&quot;,me);},minimizeDesktop:function(me){me.fireEvent(&quot;resize&quot;,me);}}});return desktop.activePanel;},multiDataset:{getObjectResults:function(){return sitools.user.component.forms.overviewResultsProjectForm;},showDataset:function(grid,rowIndex,colIndex){var rec=grid.getStore().getAt(rowIndex);if(Ext.isEmpty(rec)){return;}
if(rec.get('status')==&quot;REQUEST_ERROR&quot;){return;}
Ext.Ajax.request({method:&quot;GET&quot;,url:rec.get('url'),scope:this,success:function(ret){var Json=Ext.decode(ret.responseText);if(showResponse(ret)){var dataset=Json.dataset;var componentCfg,JsObj;JsObj=eval(dataset.datasetView.jsObject);componentCfg={title:dataset.name,closable:true,dataUrl:dataset.sitoolsAttachementForUsers,datasetId:dataset.Id,datasetCm:dataset.columnModel,datasetName:dataset.name,dictionaryMappings:dataset.dictionaryMappings,datasetViewConfig:dataset.datasetViewConfig,sitoolsAttachementForUsers:dataset.sitoolsAttachementForUsers,formMultiDsParams:this.formMultiDsParams};var dataview=new JsObj(componentCfg);this.ownerCt.southPanel.add(dataview);this.ownerCt.southPanel.setVisible(true);this.ownerCt.southPanel.expand();this.ownerCt.southPanel.setActiveTab(this.ownerCt.southPanel.items.length-1);this.ownerCt.doLayout();}},failure:alertFailure});}},taskbar:{getContextMenuItems:function(){return[{text:'Close',handler:this.closeWin.createDelegate(this,this.win,true),scope:this.win}];},handleTaskButton:function(btn,event){var panel=btn.win;SitoolsDesk.removeActivePanel();panel.setSize(SitoolsDesk.getDesktop().getDesktopEl().getSize());SitoolsDesk.getDesktop().activePanel=panel;panel.show();},closeWin:function(cMenu,e,win){var tb=getDesktop().taskbar;if(getDesktop().activePanel==win){SitoolsDesk.removeActivePanel();}
var btn=win.taskButton;var btnToActive=tb.getPreviousBtn(btn)||tb.getNextBtn(btn);if(btnToActive){SitoolsDesk.navProfile.taskbar.handleTaskButton.call(this,btnToActive);}
win.destroy();tb.removeTaskButton(btn);},beforeShowCtxMenu:function(){return true;},initTaskbar:function(){SitoolsDesk.getDesktop().taskbar.setEnableWarning(true);var removeActivePanel=new Ext.Button({scope:this,handler:function(){var btns=SitoolsDesk.getDesktop().taskbar.getAllTaskButtons();if(Ext.isEmpty(btns)){var tmp=new Ext.ux.Notification({iconCls:'x-icon-information',title:i18n.get('label.information'),html:i18n.get(&quot;label.desktopAlreadyEmpty&quot;),autoDestroy:true,hideDelay:1000}).show(document);return;}
Ext.each(btns,function(btn){SitoolsDesk.navProfile.taskbar.closeWin(null,null,btn.win);});},scale:&quot;medium&quot;,icon:&quot;/sitools/common/res/images/taskbar/black/close-icon.png&quot;,iconCls:'taskbarButtons-icon',tooltip:{html:i18n.get('label.removeAllPanels'),anchor:'bottom',trackMouse:false},template:new Ext.Template('&lt;table cellspacing=&quot;0&quot; style=&quot;padding-right:0px;&quot; class=&quot;x-btn {3}&quot;&gt;&lt;tbody&gt;&lt;tr&gt;','&lt;td&gt;&lt;i&gt;&amp;#160;&lt;/i&gt;&lt;/td&gt;','&lt;td&gt;&lt;em class=&quot;{5} unselectable=&quot;on&quot;&gt;','&lt;button type=&quot;{1}&quot; style=&quot;height:28px; width:28px;&quot;&gt;{0}&lt;/button&gt;','&lt;/em&gt;&lt;/td&gt;','&lt;td&gt;&lt;i&gt;&amp;#160;&lt;/i&gt;&lt;/td&gt;',&quot;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&quot;)});var previous=new Ext.Button({scope:this,handler:function(){var tb=SitoolsDesk.getDesktop().taskbar;var activeBtn=tb.getActiveButton();var btnToActive=tb.getPreviousBtn(activeBtn);if(btnToActive){SitoolsDesk.navProfile.taskbar.handleTaskButton.call(this,btnToActive);}},scale:&quot;medium&quot;,icon:&quot;/sitools/common/res/images/taskbar/black/arrow-left-black.png&quot;,iconCls:'taskbarButtons-icon',tooltip:{html:i18n.get('label.previous'),anchor:'bottom',trackMouse:false},template:new Ext.Template('&lt;table cellspacing=&quot;0&quot; style=&quot;padding-right:0px;&quot; class=&quot;x-btn {3}&quot;&gt;&lt;tbody&gt;&lt;tr&gt;','&lt;td&gt;&lt;i&gt;&amp;#160;&lt;/i&gt;&lt;/td&gt;','&lt;td&gt;&lt;em class=&quot;{5} unselectable=&quot;on&quot;&gt;','&lt;button type=&quot;{1}&quot; style=&quot;height:28px; width:28px;&quot;&gt;{0}&lt;/button&gt;','&lt;/em&gt;&lt;/td&gt;','&lt;td&gt;&lt;i&gt;&amp;#160;&lt;/i&gt;&lt;/td&gt;',&quot;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&quot;)});var next=new Ext.Button({scope:this,handler:function(){var tb=SitoolsDesk.getDesktop().taskbar;var activeBtn=tb.getActiveButton();var btnToActive=tb.getNextBtn(activeBtn);if(btnToActive){SitoolsDesk.navProfile.taskbar.handleTaskButton.call(this,btnToActive);}},scale:&quot;medium&quot;,icon:&quot;/sitools/common/res/images/taskbar/black/arrow-right-black.png&quot;,iconCls:'taskbarButtons-icon',tooltip:{html:i18n.get('label.next'),anchor:'bottom',trackMouse:false},template:new Ext.Template('&lt;table cellspacing=&quot;0&quot; style=&quot;padding-right:0px;&quot; class=&quot;x-btn {3}&quot;&gt;&lt;tbody&gt;&lt;tr&gt;','&lt;td&gt;&lt;i&gt;&amp;#160;&lt;/i&gt;&lt;/td&gt;','&lt;td&gt;&lt;em class=&quot;{5} unselectable=&quot;on&quot;&gt;','&lt;button type=&quot;{1}&quot; style=&quot;height:28px; width:28px;&quot;&gt;{0}&lt;/button&gt;','&lt;/em&gt;&lt;/td&gt;','&lt;td&gt;&lt;i&gt;&amp;#160;&lt;/i&gt;&lt;/td&gt;',&quot;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&quot;)});SitoolsDesk.getDesktop().taskbar.staticButtonPanel.addStaticButton(previous);SitoolsDesk.getDesktop().taskbar.staticButtonPanel.addStaticButton(next);SitoolsDesk.getDesktop().taskbar.staticButtonPanel.addStaticButton(removeActivePanel);}},initNavbar:function(){return;},getFormOpenMode:function(){return sitools.user.component.DatasetOverview;},getDatasetOpenMode:function(dataset){return sitools.user.component.DatasetOverview;},addSpecificFormParameters:function(componentCfg,dataset){componentCfg.sitoolsAttachementForUsers=dataset.sitoolsAttachementForUsers;return componentCfg;},manageProjectGraphColumns:function(columnsModel){return columnsModel;},manageDatasetViewAlbumIconForm:function(value){return null;return&quot;&lt;a href='#' onClick='sitools.user.clickDatasetIcone(\&quot;&quot;+value
+&quot;\&quot;, \&quot;forms\&quot;); return false;'&gt;&lt;img src='&quot;+loadUrl.get('APP_URL')
+&quot;/common/res/images/icons/form_list_small.png'&gt;&lt;/a&gt;&quot;;},manageDatasetExplorerShowDefinitionAndForms:function(commonTreeUtils,node,dataset){return;},getDesktopSettings:function(forPublicUser){var desktopSettings=[],activePanel=getDesktop().activePanel;if(activePanel){if(activePanel.specificType==='module'){desktopSettings.push({activeModuleId:activePanel.id});}}
return desktopSettings;},loadPreferences:function(scope){Ext.each(projectGlobal.preferences.windowSettings,function(pref){var module=SitoolsDesk.app.getModule(pref.activeModuleId);if(!Ext.isEmpty(module)&amp;&amp;Ext.isEmpty(module.divIdToDisplay)){module.openModule();}},scope);}};Ext.namespace('Ext.ux',&quot;sitools.user.desktop&quot;);sitools.user.desktop.App=function(){function initModulesDiv(modules){Ext.each(projectGlobal.modulesInDiv,function(module){var contentEl=Ext.get(module.divIdToDisplay);if(Ext.isEmpty(contentEl)){Ext.Msg.alert(i18n.get('label.error'),String.format(i18n.get('label.invalidModuleDivId'),module.name,module.divIdToDisplay));}else{module=new Ext.Panel({id:module.id,border:false,cls:&quot;sitools-module-panel&quot;,layout:'fit',renderTo:module.divIdToDisplay,forceLayout:true,height:contentEl.getHeight(),width:contentEl.getWidth(),listProjectModulesConfig:module.listProjectModulesConfig,items:[{layout:'fit',xtype:module.xtype,moduleProperties:module.properties}],listeners:{resize:function(me){if(module.container){me.setSize(Ext.get(module.container).getSize());}},maximizeDesktop:function(me){me.hide();me.doLayout();},minimizeDesktop:function(me){me.setVisible(true);me.doLayout();}}});SitoolsDesk.app.modulesInDiv.push(module);}});}
function initBottom(){var modules=projectGlobal.modules;var bottom=new sitools.user.component.bottom.Bottom({id:&quot;bottomCompId&quot;});}
function initEntete(){var entete=new sitools.user.component.entete.Entete({renderTo:&quot;x-headers&quot;,id:&quot;headersCompId&quot;,htmlContent:projectGlobal.htmlHeader,modules:projectGlobal.modules,listeners:{resize:function(me){me.setSize(SitoolsDesk.getEnteteEl().getSize());}}});}
function callbackRESTCreateProject(){var modules=[];var isAuthorized=false;Ext.Ajax.request({scope:this,url:projectGlobal.sitoolsAttachementForUsers,method:'GET',success:function(response){var data=Ext.decode(response.responseText);isAuthorized=true;if(data.project.maintenance){desktopReady.call(this);Ext.get('ux-taskbar').mask();var alertWindow=new Ext.Window({title:i18n.get('label.maintenance'),width:600,height:400,autoScroll:true,closable:false,items:[{xtype:'panel',layout:'fit',autoScroll:true,html:data.project.maintenanceText,padding:&quot;5&quot;}],modal:true});alertWindow.show();return;}
projectGlobal.modules=data.project.modules;projectGlobal.modulesInDiv=[];Ext.each(projectGlobal.modules,function(module){if(!Ext.isEmpty(module.divIdToDisplay)){projectGlobal.modulesInDiv.push(module);}},this);SitoolsDesk.modulesACharger=projectGlobal.modules.size();if(SitoolsDesk.modulesACharger===0){Ext.Msg.alert(i18n.get(&quot;label.warning&quot;),i18n.get(&quot;label.noModules&quot;));SitoolsDesk.fireEvent('allJsIncludesDone',this);}
getListOfModulesAndCreateModules(projectGlobal.sitoolsAttachementForUsers,projectGlobal.modules);},failure:function(response){Ext.get('ux-taskbar').mask();Ext.Msg.alert('Status',i18n.get('warning.not.authorized'),function(){window.location=loadUrl.get('APP_URL')
+loadUrl.get('APP_CLIENT_USER_URL');});return;}});}
function fireResize(newW,newH){try{var desktop=SitoolsDesk.getDesktop();if(SitoolsDesk.desktopMaximizeMode){desktop.getDesktopAndTaskBarEl().setHeight(Ext.getBody().getHeight()
-this.getEnteteEl().getHeight());desktop.getDesktopAndTaskBarEl().setWidth(Ext.getBody().getWidth());desktop.getDesktopEl().setHeight(Ext.getBody().getHeight()
-this.getEnteteEl().getHeight()
-desktop.taskbar.tbPanel.getHeight());desktop.getDesktopEl().setWidth(Ext.getBody().getWidth());}
if(!Ext.isEmpty(desktop.activePanel)){desktop.activePanel.fireEvent(&quot;resizeDesktop&quot;,desktop.activePanel);}
SitoolsDesk.getEnteteComp().fireEvent(&quot;resize&quot;,SitoolsDesk.getEnteteComp(),newW,newH);SitoolsDesk.getEnteteComp().fireEvent(&quot;windowResize&quot;,SitoolsDesk.getEnteteComp(),newW,newH);SitoolsDesk.getBottomComp().fireEvent(&quot;resize&quot;,SitoolsDesk.getBottomComp(),newW,newH);SitoolsDesk.getBottomComp().fireEvent(&quot;windowResize&quot;,SitoolsDesk.getBottomComp(),newW,newH);for(var int=0;int&lt;projectGlobal.modulesInDiv.length;int++){var module=projectGlobal.modulesInDiv[int];var panel=Ext.getCmp(module.id);panel.fireEvent(&quot;resize&quot;,panel,newW,newH);}}catch(err){return null;}}
function initNavigationMode(){if(projectGlobal.navigationMode==&quot;desktop&quot;){SitoolsDesk.navProfile=sitools.user.desktop.navProfile.desktop;}else{SitoolsDesk.navProfile=sitools.user.desktop.navProfile.fixed;}}
function _onAllJsIncludesDone(){initNavigationMode();SitoolsDesk.loadPreferences(this);this.fireEvent('modulesLoaded');this.fireEvent('ready');}
function initTaskAndNavBar(){SitoolsDesk.navProfile.taskbar.initTaskbar();SitoolsDesk.navProfile.initNavbar();}
function _onModulesLoaded(){initEntete();initBottom();initTaskAndNavBar();initModulesDiv(projectGlobal.modules);if(projectGlobal.preferences&amp;&amp;projectGlobal.preferences.projectSettings&amp;&amp;projectGlobal.preferences.projectSettings.desktopMaximizeMode){getDesktop().maximize();}}
function initProject(){SitoolsDesk.app.addListener(&quot;allJsIncludesDone&quot;,_onAllJsIncludesDone);SitoolsDesk.app.addListener(&quot;ready&quot;,desktopReady);SitoolsDesk.app.addListener(&quot;modulesLoaded&quot;,_onModulesLoaded);sql2ext.load(loadUrl.get('APP_URL')
+&quot;/client-user/conf/sql2ext.properties&quot;);Ext.EventManager.onWindowResize(fireResize,SitoolsDesk);projectGlobal.initProject(callbackRESTCreateProject);Ext.apply(Ext.QuickTips.getQuickTip(),{maxWidth:200,minWidth:100,showDelay:50,trackMouse:true});}
function deletePublicPref(){publicStorage.remove();}
function _onLogin(){var tmp=new sitools.userProfile.Login({closable:true,url:loadUrl.get('APP_URL')+'/login',register:loadUrl.get('APP_URL')+'/inscriptions/user',reset:loadUrl.get('APP_URL')+'/resetPassword'}).show();}
function _onLogout(){utils_logout();}
function addWinData(windowSettings,componentCfg,JsObj,reloadComp){var desktop=getDesktop();var win=desktop.getWindow(windowSettings.id);if(win){if(reloadComp){win.removeAll();win.add(new JsObj(componentCfg));win.doLayout();}
if(win.minimized){win.show();}
win.toFront();return;}
try{SitoolsDesk.navProfile.createComponent({componentCfg:componentCfg,windowSettings:windowSettings,reloadComp:reloadComp,JsObj:JsObj});}catch(r){Ext.Msg.alert(i18n.get(&quot;label.warning&quot;),i18n.get(&quot;label.nocomponentfound&quot;));throw(r);}}
function desktopReady(){if(Ext.getBody().isMasked()){Ext.getBody().unmask();}
Ext.get(&quot;ux-taskbar&quot;).setVisible(true);SitoolsDesk.getEnteteComp().fireEvent(&quot;desktopReady&quot;,SitoolsDesk.getEnteteComp());document.onkeypress=function(event){if(event.keyCode==event.DOM_VK_F1){event.stopPropagation()
event.preventDefault()}}}
function maskDesktop(){Ext.getBody().mask(i18n.get(&quot;label.loadingSitools&quot;));Ext.get(&quot;ux-taskbar&quot;).hide();}
function createModule(config){function includeCss(url){var headID=document.getElementsByTagName(&quot;head&quot;)[0];var newCss=document.createElement('link');newCss.type='text/css';newCss.rel='stylesheet';newCss.href=url;newCss.media='screen';headID.appendChild(newCss);}
function includeJs(ConfUrls,indexAInclure){if(indexAInclure&lt;ConfUrls.length){var DSLScript=document.createElement(&quot;script&quot;);DSLScript.type=&quot;text/javascript&quot;;DSLScript.onload=includeJs.createDelegate(this,[ConfUrls,indexAInclure+1]);DSLScript.onreadystatechange=includeJs.createDelegate(this,[ConfUrls,indexAInclure+1]);DSLScript.src=ConfUrls[indexAInclure].url;var headID=document.getElementsByTagName('head')[0];headID.appendChild(DSLScript);}else{SitoolsDesk.modulesCharges++;if(SitoolsDesk.modulesCharges===SitoolsDesk.modulesACharger){SitoolsDesk.app.fireEvent('allJsIncludesDone',this);}}}
var module=new Ext.app.Module(Ext.apply(config,{init:function(){if(config.dependencies){if(config.dependencies.css){Ext.each(config.dependencies.css,function(dependenceCss){includeCss(dependenceCss.url);});}
if(config.dependencies.js){includeJs(config.dependencies.js,0);}}else{SitoolsDesk.app.modulesCharges++;}},getWindow:function(){return Ext.getCmp(config.id);},openModule:function(){var desktop=getDesktop();return SitoolsDesk.navProfile.openModule(module);}}));return module;}
function getConfigAndCreateModule(config){Ext.Ajax.request({method:&quot;GET&quot;,url:loadUrl.get('APP_URL')
+loadUrl.get('APP_PROJECTS_MODULES_URL')+&quot;/&quot;+config.id,scope:this,success:function(response){var json=Ext.decode(response.responseText);if(json.success){var configModule=Ext.applyIf(config,json.projectModule||{});var module=createModule(configModule);SitoolsDesk.app.modules.push(module);}else{Ext.Msg.alert(i18n.get('label.error'),String.format(i18n.get('label.undefinedModule'),config.name));SitoolsDesk.modulesCharges++;if(SitoolsDesk.modulesCharges===SitoolsDesk.modulesACharger){SitoolsDesk.app.fireEvent('allJsIncludesDone',this);}}},failure:alertFailure});}
function getListOfModulesAndCreateModules(projectAttachment,configs){Ext.Ajax.request({method:&quot;GET&quot;,url:projectAttachment+&quot;/projectModules&quot;,scope:this,success:function(response){var json=Ext.decode(response.responseText);Ext.each(json.data,function(projectModule){var projectConfig=findProjectModuleConfig(configs,projectModule.id);if(!Ext.isEmpty(projectConfig)){var configModule=Ext.applyIf(projectConfig,projectModule||{});var module=createModule(configModule);SitoolsDesk.app.modules.push(module);}
else{Ext.Msg.alert(i18n.get('label.error'),String.format(i18n.get('label.undefinedModule'),config.name));SitoolsDesk.modulesCharges++;if(SitoolsDesk.modulesCharges===SitoolsDesk.modulesACharger){SitoolsDesk.app.fireEvent('allJsIncludesDone',this);}}},this);},failure:alertFailure});}
function findProjectModuleConfig(configs,id){var configOut;Ext.each(configs,function(conf){if(conf.id==id){configOut=conf;return;}},this);return configOut;}
function createApplication(){return new Ext.app.App({init:function(){Ext.QuickTips.init();Ext.state.Manager.setProvider(new Ext.state.CookieProvider());if(Ext.isIE){Ext.Msg.confirm(i18n.get('label.warning'),i18n.get('label.IEWarning'),function(buttonId){if(buttonId===&quot;yes&quot;){maskDesktop();initProject();}else{window.location.replace(&quot;https://www.google.com/chrome/index.html&quot;);}});}else{maskDesktop();initProject();}},getModules:function(){return this.modules;},getModulesInDiv:function(){return this.modulesInDiv;},findModule:function(moduleId){var result;Ext.each(this.modules.concat(this.modulesInDiv),function(module){if(module.id===moduleId){result=module;}});return result;},saveWindowSettings:function(forPublicUser){var desktopSettings=SitoolsDesk.navProfile.getDesktopSettings();userPreferences={};userPreferences.windowSettings=desktopSettings;var projectSettings={};if(!Ext.isEmpty(SitoolsDesk.getDesktop().activePanel)){projectSettings.activeModuleId=SitoolsDesk.getDesktop().activePanel.id;}
projectSettings.desktopMaximizeMode=SitoolsDesk.desktopMaximizeMode;userPreferences.projectSettings=projectSettings;if(forPublicUser){publicStorage.set(&quot;desktop&quot;,&quot;/&quot;
+DEFAULT_PREFERENCES_FOLDER+&quot;/&quot;
+projectGlobal.projectName,userPreferences);}else{userStorage.set(&quot;desktop&quot;,&quot;/&quot;+DEFAULT_PREFERENCES_FOLDER
+&quot;/&quot;+projectGlobal.projectName,userPreferences);}}});}
function getPortalPreferences(portalPrefCb){if(!Ext.isEmpty(userLogin)){var portalPrefSuccess=function(response){if(Ext.isEmpty(response.responseText)){return;}
try{var json=Ext.decode(response.responseText);if(!Ext.isEmpty(json.language)){this.app.language=json.language;}}catch(err){return;}};var filePath=&quot;/&quot;+DEFAULT_PREFERENCES_FOLDER+'/portal';userStorage.get(&quot;portal&quot;,filePath,this,portalPrefSuccess,Ext.emptyFn,portalPrefCb);}else{portalPrefCb.call(this);}}
return{maxSizeHistory:5,history:[],navProfile:null,activeComponent:null,desktopMaximizeMode:false,modulesCharges:0,modulesACharger:0,app:this.app,addToHistory:function(panel){panel.rendered=false;SitoolsDesk.history.push(panel);},initDesktopApplication:function(){Ext.QuickTips.init();if(!Ext.isEmpty(Ext.util.Cookies.get('userLogin'))){var auth=Ext.util.Cookies.get('hashCode');Ext.Ajax.defaultHeaders={&quot;Authorization&quot;:auth,&quot;Accept&quot;:&quot;application/json&quot;,&quot;X-User-Agent&quot;:&quot;Sitools&quot;};}else{Ext.Ajax.defaultHeaders={&quot;Accept&quot;:&quot;application/json&quot;,&quot;X-User-Agent&quot;:&quot;Sitools&quot;};}
this.app=createApplication();this.app.language=locale.getLocale();var initApplication=function(){SitoolsDesk.app.initApp();};var i18nCb=function(){projectGlobal.getUserRoles(initApplication);};var portalPrefCb=function(){i18n.load('/sitools/res/i18n/'+SitoolsDesk.app.language
+'/gui.properties',i18nCb);};var callbackSiteMap=function(){getPortalPreferences(portalPrefCb);};loadUrl.load('/sitools/client-user/siteMap',callbackSiteMap);},addApplication:function(composant){modulesExistants=SitoolsDesk.app.getModules();if(!modulesExistants){modulesExistants=[];}
var nouveauModule=getConfigAndCreateModule(composant,this);modulesExistants.push(nouveauModule);SitoolsDesk.app.addModule(nouveauModule);},removeApplication:function(idApplication){var moduleToRemove=SitoolsDesk.app.getModule(idApplication);modulesExistants=SitoolsDesk.app.getModules();SitoolsDesk.app.removeModule(moduleToRemove);},loadPreferences:function(scope){if(!Ext.isEmpty(projectGlobal.preferences)){SitoolsDesk.navProfile.loadPreferences(scope);}},addDesktopWindow:function(windowSettings,component,JsObj,reloadComp){if(Ext.isEmpty(windowSettings.saveToolbar)){windowSettings.saveToolbar=false;}
if(Ext.isEmpty(windowSettings.title)){throw(&quot;NoWinTitle&quot;);}
if(Ext.isEmpty(reloadComp)){reloadComp=false;}
if(windowSettings.saveToolbar===false){addWinData(windowSettings,component,JsObj,reloadComp);return;}
var baseFilePath=&quot;/&quot;+DEFAULT_PREFERENCES_FOLDER+&quot;/&quot;
+projectGlobal.projectName;var filePath=component.preferencesPath;var fileName=component.preferencesFileName;if(Ext.isEmpty(filePath)||Ext.isEmpty(fileName)){addWinData(windowSettings,component,JsObj,reloadComp);return;}
filePath=baseFilePath+filePath;var addWinPublic=function(windowSettings,component,JsObj,reloadComp){var successPublic=function(response,opts){try{var json=Ext.decode(response.responseText);Ext.apply(windowSettings,json.windowSettings);Ext.apply(component,{userPreference:json.componentSettings});addWinData(windowSettings,component,JsObj,reloadComp);}catch(err){addWinData(windowSettings,component,JsObj,reloadComp);}};var failurePublic=function(response,opts){addWinData(windowSettings,component,JsObj,reloadComp);};publicStorage.get(fileName,filePath,this,successPublic,failurePublic);};if(Ext.isEmpty(userLogin)){addWinPublic(windowSettings,component,JsObj,reloadComp);}else{var successMethod=function(response,opts){try{var json=Ext.decode(response.responseText);Ext.apply(windowSettings,json.windowSettings);Ext.apply(component,{userPreference:json.componentSettings});addWinData(windowSettings,component,JsObj,reloadComp);}catch(err){addWinPublic(windowSettings,component,JsObj,reloadComp);}};var failureMethod=function(response,opts){addWinPublic(windowSettings,component,JsObj,reloadComp);};userStorage.get(fileName,filePath,this,successMethod,failureMethod);}},getDesktop:function(){return this.app.desktop;},getEnteteEl:function(){return Ext.get('x-headers');},getEnteteComp:function(){return Ext.getCmp(&quot;headersCompId&quot;);},getBottomEl:function(){return Ext.get('x-bottom');},getBottomComp:function(){return Ext.getCmp(&quot;bottomCompId&quot;);},removeActivePanel:function(){if(this.getDesktop().activePanel){var panel=this.getDesktop().activePanel;this.getDesktop().activePanel=null;panel.hide();return;}},removeAllWindows:function(){this.getDesktop().getManager().each(function(win){win.close();});},minifyAllWindows:function(){SitoolsDesk.getDesktop().getManager().each(function(win){if(Ext.isFunction(win.minimize)){win.minimize();}else{win.destroy();}});},openAllWindows:function(){SitoolsDesk.getDesktop().getManager().each(function(win){if(!win.isVisible()&amp;&amp;win.taskButton){win.show();}});},openModalWindow:function(panel,config){var windowConfig=config.windowSettings||{};Ext.apply(windowConfig,{modal:true,layout:'fit'});if(!Ext.isEmpty(windowConfig.toolbarItems)){Ext.apply(windowConfig,{tbar:{items:windowConfig.toolbarItems},listeners:{afterrender:function(me){if(me.getHeight()&gt;Ext.getBody().getHeight()){me.setHeight(Ext.getBody().getHeight());}
if(me.getWidth()&gt;Ext.getBody().getWidth()){me.setWidth(Ext.getBody().getWidth());}
me.doLayout();}}});}
Ext.applyIf(windowConfig,{width:DEFAULT_WIN_WIDTH,height:DEFAULT_WIN_HEIGHT})
var win=new Ext.Window(windowConfig);win.show();win.add(panel);win.setZIndex(12000);win.doLayout();},showHelp:function(b,e){var help=Ext.getCmp(&quot;helpWindow&quot;);if(!Ext.isEmpty(help)){help.show();help.setZIndex(12000);return;}
var componentCfg={};help=new sitools.user.component.help();var config={};config.windowSettings={id:&quot;helpWindow&quot;,title:i18n.get('label.help'),saveToolbar:false,closeAction:'hide'};SitoolsDesk.openModalWindow(help,config);},showFormFromEditor:function(formUrl){Ext.Ajax.request({url:formUrl,method:'GET',success:function(response){try{var json=Ext.decode(response.responseText);if(!json.success){Ext.Msg.alert(i18n.get('label.error'),json.message);return;}
var rec={};rec.data=json.data[0];Ext.Ajax.request({url:rec.data.parentUrl,method:'GET',success:function(response){try{var json2=Ext.decode(response.responseText);var dataset=json2.dataset;var jsObj=SitoolsDesk.navProfile.getFormOpenMode();var componentCfg={dataUrl:rec.data.parentUrl,dataset:dataset,formId:rec.data.id,formName:rec.data.name,formParameters:rec.data.parameters,formWidth:rec.data.width,formHeight:rec.data.height,formCss:rec.data.css,preferencesPath:&quot;/&quot;+dataset.name+&quot;/forms&quot;,preferencesFileName:rec.data.name};SitoolsDesk.navProfile.addSpecificFormParameters(componentCfg,dataset);var windowSettings={datasetName:dataset.name,type:&quot;form&quot;,title:i18n.get('label.forms')+&quot; : &quot;+dataset.name+&quot;.&quot;+rec.data.name,id:&quot;form&quot;+dataset.id+rec.data.id,saveToolbar:true,iconCls:&quot;form&quot;};SitoolsDesk.addDesktopWindow(windowSettings,componentCfg,jsObj);return;}
catch(err){Ext.Msg.alert(i18n.get('label.error'),err);return;}}});}
catch(err){Ext.Msg.alert(i18n.get('label.error'),err);return;}},failure:function(){Ext.Msg.alert(i18n.get('label.error'),i18n.get('label.noActiveDatasetFound'));return;}});}};};Ext.ns(&quot;sitools.user.data&quot;);sitools.user.data.featureReader=Ext.extend(GeoExt.data.FeatureReader,{totalRecords:null,read:function(response){return this.readRecords(response);},readRecords:function(response){var result=sitools.user.data.featureReader.superclass.readRecords.call(this,response.features);return Ext.apply(result,{totalRecords:response.totalResults});}});Ext.ns(&quot;sitools.user.data&quot;);sitools.user.data.FormatGeoJson=Ext.extend(OpenLayers.Format.GeoJSON,{totalProperty:null,read:function(json,type,filter){type=(type)?type:&quot;FeatureCollection&quot;;var results=null;var obj=null;if(typeof json==&quot;string&quot;){obj=OpenLayers.Format.JSON.prototype.read.apply(this,[json,filter]);}else{obj=json;}
if(!obj){OpenLayers.Console.error(&quot;Bad JSON: &quot;+json);}else if(typeof(obj.type)!=&quot;string&quot;){OpenLayers.Console.error(&quot;Bad GeoJSON - no type: &quot;+json);}else if(this.isValidType(obj,type)){switch(type){case&quot;Geometry&quot;:try{results=this.parseGeometry(obj);}catch(err){OpenLayers.Console.error(err);}
break;case&quot;Feature&quot;:try{results=this.parseFeature(obj);results.type=&quot;Feature&quot;;}catch(err){OpenLayers.Console.error(err);}
break;case&quot;FeatureCollection&quot;:results=[];switch(obj.type){case&quot;Feature&quot;:try{results.push(this.parseFeature(obj));}catch(err){results=null;OpenLayers.Console.error(err);}
break;case&quot;FeatureCollection&quot;:for(var i=0,len=obj.features.length;i&lt;len;++i){try{results.push(this.parseFeature(obj.features[i]));}catch(err){results=null;OpenLayers.Console.error(err);}}
break;default:try{var geom=this.parseGeometry(obj);results.push(new OpenLayers.Feature.Vector(geom));}catch(err){results=null;OpenLayers.Console.error(err);}}
break;}}
return{features:results,totalResults:obj[this.totalProperty]};}});Ext.ns(&quot;sitools.user.data&quot;);sitools.user.data.ProtocolHttp=function(config){sitools.user.data.ProtocolHttp.superclass.constructor.call(this,Ext.apply({url:config.url,totalProperty:config.totalProperty,format:new sitools.user.data.FormatGeoJson({totalProperty:config.totalProperty})}));};Ext.extend(sitools.user.data.ProtocolHttp,OpenLayers.Protocol.HTTP,{handleResponse:function(resp,options){var request=resp.priv;if(options.callback){if(request.status&gt;=200&amp;&amp;request.status&lt;300){if(resp.requestType!=&quot;delete&quot;){Ext.apply(resp,this.parseFeatures(request));}
resp.code=OpenLayers.Protocol.Response.SUCCESS;}else{resp.code=OpenLayers.Protocol.Response.FAILURE;}
options.callback.call(options.scope,resp);}}});Ext.ns(&quot;sitools.user.data&quot;);sitools.user.data.ProtocolProxy=function(config){sitools.user.data.ProtocolProxy.superclass.constructor.call(this,Ext.apply({api:{create:Ext.emptyFn,destroy:Ext.emptyFn,read:Ext.emptyFn,update:Ext.emptyFn},protocol:new sitools.user.data.ProtocolHttp({url:config.url,totalProperty:config.totalProperty,format:new OpenLayers.Format.GeoJSON()})}));};Ext.extend(sitools.user.data.ProtocolProxy,GeoExt.data.ProtocolProxy,{});Ext.namespace('Ext.ux.grid.filter');Ext.ux.grid.filter.Filter=Ext.extend(Ext.util.Observable,{active:false,dataIndex:null,menu:null,updateBuffer:500,constructor:function(config){Ext.apply(this,config);this.addEvents('activate','deactivate','serialize','update');Ext.ux.grid.filter.Filter.superclass.constructor.call(this);this.menu=new Ext.menu.Menu();this.init(config);if(config&amp;&amp;config.value){this.setValue(config.value);this.setActive(config.active!==false,true);delete config.value;}},destroy:function(){if(this.menu){this.menu.destroy();}
this.purgeListeners();},init:Ext.emptyFn,getValue:Ext.emptyFn,setValue:Ext.emptyFn,isActivatable:function(){return true;},getSerialArgs:Ext.emptyFn,validateRecord:function(){return true;},serialize:function(){var args=this.getSerialArgs();this.fireEvent('serialize',args,this);return args;},fireUpdate:function(){if(this.active){this.fireEvent('update',this);}
this.setActive(this.isActivatable());},setActive:function(active,suppressEvent){if(this.active!=active){this.active=active;if(suppressEvent!==true){this.fireEvent(active?'activate':'deactivate',this);}}}});Ext.ux.grid.filter.StringFilter=Ext.extend(Ext.ux.grid.filter.Filter,{iconCls:'ux-gridfilter-text-icon',emptyText:'Enter Filter Text...',selectOnFocus:true,width:125,init:function(config){Ext.applyIf(config,{enableKeyEvents:true,iconCls:this.iconCls,listeners:{scope:this,keyup:this.onInputKeyUp}});this.inputItem=new Ext.form.TextField(config);this.menu.add(this.inputItem);this.updateTask=new Ext.util.DelayedTask(this.fireUpdate,this);},getValue:function(){return this.inputItem.getValue();},setValue:function(value){this.inputItem.setValue(value);this.fireEvent('update',this);},isActivatable:function(){return this.inputItem.getValue().length&gt;0;},getSerialArgs:function(){return{type:'string',value:this.getValue()};},validateRecord:function(record){var val=record.get(this.dataIndex);if(typeof val!='string'){return(this.getValue().length===0);}
return val.toLowerCase().indexOf(this.getValue().toLowerCase())&gt;-1;},onInputKeyUp:function(field,e){var k=e.getKey();if(k==e.RETURN&amp;&amp;field.isValid()){e.stopEvent();this.menu.hide(true);return;}
this.updateTask.delay(this.updateBuffer);}});Ext.override(Ext.ux.grid.filter.StringFilter,{getSerialArgs:function(){return{type:'string',value:this.getValue(),comparison:'LIKE'};}});Ext.ux.grid.filter.DateFilter=Ext.extend(Ext.ux.grid.filter.Filter,{afterText:'After',beforeText:'Before',compareMap:{before:'lt',after:'gt',on:'eq'},dateFormat:SITOOLS_DATE_FORMAT,menuItems:['before','after','-','on'],menuItemCfgs:{selectOnFocus:true,width:125},onText:'On',pickerOpts:{showTime:true},init:function(config){var menuCfg,i,len,item,cfg,Cls;menuCfg=Ext.apply(this.pickerOpts,{minDate:this.minDate,maxDate:this.maxDate,format:this.dateFormat,listeners:{scope:this,select:this.onMenuSelect}});this.fields={};for(i=0,len=this.menuItems.length;i&lt;len;i++){item=this.menuItems[i];if(item!=='-'){cfg={itemId:'range-'+item,text:this[item+'Text'],menu:new Ext.menu.DateMenu(Ext.apply(menuCfg,{itemId:item})),listeners:{scope:this,checkchange:this.onCheckChange}};Cls=Ext.menu.CheckItem;item=this.fields[item]=new Cls(cfg);}
this.menu.add(item);}},onCheckChange:function(){this.setActive(this.isActivatable());this.fireEvent('update',this);},onInputKeyUp:function(field,e){var k=e.getKey();if(k==e.RETURN&amp;&amp;field.isValid()){e.stopEvent();this.menu.hide(true);return;}},onMenuSelect:function(menuItem,value,picker){var fields=this.fields,field=this.fields[menuItem.itemId];field.setChecked(true);if(field==fields.on){fields.before.setChecked(false,true);fields.after.setChecked(false,true);}else{fields.on.setChecked(false,true);if(field==fields.after&amp;&amp;fields.before.menu.picker.value&lt;value){fields.before.setChecked(false,true);}else if(field==fields.before&amp;&amp;fields.after.menu.picker.value&gt;value){fields.after.setChecked(false,true);}}
this.fireEvent('update',this);},getValue:function(){var key,result={};for(key in this.fields){if(this.fields[key].checked){result[key]=this.fields[key].menu.picker.getValue();}}
return result;},setValue:function(value,preserve){var key;for(key in this.fields){if(value[key]){this.fields[key].menu.picker.setValue(value[key]);this.fields[key].setChecked(true);}else if(!preserve){this.fields[key].setChecked(false);}}
this.fireEvent('update',this);},isActivatable:function(){var key;for(key in this.fields){if(this.fields[key].checked){return true;}}
return false;},getSerialArgs:function(){var args=[];for(var key in this.fields){if(this.fields[key].checked){args.push({type:'date',comparison:this.compareMap[key],value:this.getFieldValue(key).format(this.dateFormat)});}}
return args;},getFieldValue:function(item){return this.fields[item].menu.picker.getValue();},getPicker:function(item){return this.fields[item].menu.picker;},validateRecord:function(record){var key,pickerValue,val=record.get(this.dataIndex);if(!Ext.isDate(val)){return false;}
val=val.clearTime(true).getTime();for(key in this.fields){if(this.fields[key].checked){pickerValue=this.getFieldValue(key).clearTime(true).getTime();if(key=='before'&amp;&amp;pickerValue&lt;=val){return false;}
if(key=='after'&amp;&amp;pickerValue&gt;=val){return false;}
if(key=='on'&amp;&amp;pickerValue!=val){return false;}}}
return true;}});Ext.ux.grid.filter.ListFilter=Ext.extend(Ext.ux.grid.filter.Filter,{phpMode:false,init:function(config){this.dt=new Ext.util.DelayedTask(this.fireUpdate,this);if(this.menu){this.menu.destroy();}
this.menu=new Ext.ux.menu.ListMenu(config);this.menu.on('checkchange',this.onCheckChange,this);},getValue:function(){return this.menu.getSelected();},setValue:function(value){this.menu.setSelected(value);this.fireEvent('update',this);},isActivatable:function(){return this.getValue().length&gt;0;},getSerialArgs:function(){var args={type:'list',value:this.phpMode?this.getValue().join(','):this.getValue()};return args;},onCheckChange:function(){this.dt.delay(this.updateBuffer);},validateRecord:function(record){return this.getValue().indexOf(record.get(this.dataIndex))&gt;-1;}});Ext.ux.grid.filter.NumericFilter=Ext.extend(Ext.ux.grid.filter.Filter,{fieldCls:Ext.form.NumberField,iconCls:{gte:'ux-rangemenu-gte',lte:'ux-rangemenu-lte',eq:'ux-rangemenu-eq',gt:'ux-rangemenu-gt',lt:'ux-rangemenu-lt'},menuItemCfgs:{emptyText:'Enter Filter Text...',selectOnFocus:true,width:125,decimalPrecision:20},menuItems:['lte','gte','-','eq','-','lt','gt'],init:function(config){if(this.menu){this.menu.destroy();}
this.menu=new Ext.ux.menu.RangeMenu(Ext.apply(config,{fieldCfg:this.fieldCfg||{},fieldCls:this.fieldCls,fields:this.fields||{},iconCls:this.iconCls,menuItemCfgs:this.menuItemCfgs,menuItems:this.menuItems,updateBuffer:this.updateBuffer}));this.menu.on('update',this.fireUpdate,this);},getValue:function(){return this.menu.getValue();},setValue:function(value){this.menu.setValue(value);},isActivatable:function(){var values=this.getValue();for(key in values){if(values[key]!==undefined){return true;}}
return false;},getSerialArgs:function(){var key,args=[],values=this.menu.getValue();for(key in values){args.push({type:'numeric',comparison:key,value:values[key]});}
return args;},validateRecord:function(record){var val=record.get(this.dataIndex),values=this.getValue();if(values.eq!==undefined&amp;&amp;val!=values.eq){return false;}
if(values.lt!==undefined&amp;&amp;val&gt;=values.lt){return false;}
if(values.gt!==undefined&amp;&amp;val&lt;=values.gt){return false;}
return true;}});Ext.ux.grid.filter.BooleanFilter=Ext.extend(Ext.ux.grid.filter.Filter,{defaultValue:false,yesText:&quot;yes&quot;,noText:&quot;no&quot;,comparison:'eq',init:function(config){this.yesText=i18n.get('label.true');this.noText=i18n.get('label.false');var gId=Ext.id();this.options=[new Ext.menu.CheckItem({text:this.yesText,group:gId,checked:this.defaultValue===true}),new Ext.menu.CheckItem({text:this.noText,group:gId,checked:this.defaultValue===false})];this.menu.add(this.options[0],this.options[1]);for(var i=0;i&lt;this.options.length;i++){this.options[i].on('click',this.fireUpdate,this);this.options[i].on('checkchange',this.fireUpdate,this);}},getValue:function(){return this.options[0].checked;},setValue:function(value){this.options[value?0:1].setChecked(true);},getSerialArgs:function(){var args={type:'boolean',comparison:this.comparison,value:this.getValue()};return args;},validateRecord:function(record){return record.get(this.dataIndex)==this.getValue();}});Ext.ns('Ext.ux.menu');Ext.ux.menu.RangeMenu=Ext.extend(Ext.menu.Menu,{constructor:function(config){Ext.ux.menu.RangeMenu.superclass.constructor.call(this,config);this.addEvents('update');this.updateTask=new Ext.util.DelayedTask(this.fireUpdate,this);var i,len,item,cfg,Cls;for(i=0,len=this.menuItems.length;i&lt;len;i++){item=this.menuItems[i];if(item!=='-'){cfg={itemId:'range-'+item,enableKeyEvents:true,iconCls:this.iconCls[item]||'no-icon',listeners:{scope:this,keyup:this.onInputKeyUp}};Ext.apply(cfg,Ext.applyIf(this.fields[item]||{},this.fieldCfg[item]),this.menuItemCfgs);Cls=cfg.fieldCls||this.fieldCls;item=this.fields[item]=new Cls(cfg);}
this.add(item);}},fireUpdate:function(){this.fireEvent('update',this);},getValue:function(){var result={},key,field;for(key in this.fields){field=this.fields[key];if(field.isValid()&amp;&amp;String(field.getValue()).length&gt;0){result[key]=field.getValue();}}
return result;},setValue:function(data){var key;for(key in this.fields){this.fields[key].setValue(data[key]!==undefined?data[key]:'');}
this.fireEvent('update',this);},onInputKeyUp:function(field,e){var k=e.getKey();if(k==e.RETURN&amp;&amp;field.isValid()){e.stopEvent();this.hide(true);return;}
if(field==this.fields.eq){if(this.fields.gt){this.fields.gt.setValue(null);}
if(this.fields.lt){this.fields.lt.setValue(null);}}
else{this.fields.eq.setValue(null);}
this.updateTask.delay(this.updateBuffer);}});Ext.namespace('Ext.ux.menu');Ext.ux.menu.ListMenu=Ext.extend(Ext.menu.Menu,{labelField:'text',loadingText:'Loading...',loadOnShow:true,single:false,constructor:function(cfg){this.selected=[];this.addEvents('checkchange');Ext.ux.menu.ListMenu.superclass.constructor.call(this,cfg=cfg||{});if(!cfg.store&amp;&amp;cfg.options){var options=[];for(var i=0,len=cfg.options.length;i&lt;len;i++){var value=cfg.options[i];switch(Ext.type(value)){case'array':options.push(value);break;case'object':options.push([value.id,value[this.labelField]]);break;case'string':options.push([value,value]);break;}}
this.store=new Ext.data.Store({reader:new Ext.data.ArrayReader({id:0},['id',this.labelField]),data:options,listeners:{'load':this.onLoad,scope:this}});this.loaded=true;}else{this.add({text:this.loadingText,iconCls:'loading-indicator'});this.store.on('load',this.onLoad,this);}},destroy:function(){if(this.store){this.store.destroy();}
Ext.ux.menu.ListMenu.superclass.destroy.call(this);},show:function(){var lastArgs=null;return function(){if(arguments.length===0){Ext.ux.menu.ListMenu.superclass.show.apply(this,lastArgs);}else{lastArgs=arguments;if(this.loadOnShow&amp;&amp;!this.loaded){this.store.load();}
Ext.ux.menu.ListMenu.superclass.show.apply(this,arguments);}};}(),onLoad:function(store,records){var visible=this.isVisible();this.hide(false);this.removeAll(true);var gid=this.single?Ext.id():null;for(var i=0,len=records.length;i&lt;len;i++){var item=new Ext.menu.CheckItem({text:records[i].get(this.labelField),group:gid,checked:this.selected.indexOf(records[i].id)&gt;-1,hideOnClick:false});item.itemId=records[i].id;item.on('checkchange',this.checkChange,this);this.add(item);}
this.loaded=true;if(visible){this.show();}
this.fireEvent('load',this,records);},getSelected:function(){return this.selected;},setSelected:function(value){value=this.selected=[].concat(value);if(this.loaded){this.items.each(function(item){item.setChecked(false,true);for(var i=0,len=value.length;i&lt;len;i++){if(item.itemId==value[i]){item.setChecked(true,true);}}},this);}},checkChange:function(item,checked){var value=[];this.items.each(function(item){if(item.checked){value.push(item.itemId);}},this);this.selected=value;this.fireEvent('checkchange',item,checked);}});Ext.namespace('Ext.ux.grid');Ext.ux.grid.GridFilters=Ext.extend(Ext.util.Observable,{autoReload:true,filterCls:'ux-filtered-column',local:false,menuFilterText:'Filters',paramPrefix:'filter',showMenu:true,stateId:undefined,updateBuffer:500,constructor:function(config){config=config||{};this.deferredUpdate=new Ext.util.DelayedTask(this.reload,this);this.filters=new Ext.util.MixedCollection();this.filters.getKey=function(o){return o?o.dataIndex:null;};this.addFilters(config.filters);delete config.filters;Ext.apply(this,config);},init:function(grid){if(grid instanceof Ext.grid.GridPanel){this.grid=grid;this.bindStore(this.grid.getStore(),true);this.grid.filters=this;this.grid.addEvents({'filterupdate':true});grid.on({scope:this,beforestaterestore:this.applyState,beforestatesave:this.saveState,beforedestroy:this.destroy,reconfigure:this.onReconfigure});if(grid.rendered){this.onRender();}else{grid.on({scope:this,single:true,render:this.onRender});}}else if(grid instanceof Ext.PagingToolbar){this.toolbar=grid;}},applyState:function(grid,state){var key,filter;this.applyingState=true;this.clearFilters();if(state.filters){for(key in state.filters){filter=this.filters.get(key);if(filter){filter.setValue(state.filters[key]);filter.setActive(true);}}}
this.deferredUpdate.cancel();if(this.local){this.reload();}
delete this.applyingState;},saveState:function(grid,state){var filters={};this.filters.each(function(filter){if(filter.active){filters[filter.dataIndex]=filter.getValue();}});return(state.filters=filters);},onRender:function(){this.grid.getView().on('refresh',this.onRefresh,this);this.createMenu();},destroy:function(){this.removeAll();this.purgeListeners();if(this.filterMenu){Ext.menu.MenuMgr.unregister(this.filterMenu);this.filterMenu.destroy();this.filterMenu=this.menu.menu=null;}},removeAll:function(){if(this.filters){Ext.destroy.apply(Ext,this.filters.items);this.filters.clear();}},bindStore:function(store,initial){if(!initial&amp;&amp;this.store){if(this.local){store.un('load',this.onLoad,this);}else{store.un('beforeload',this.onBeforeLoad,this);}}
if(store){if(this.local){store.on('load',this.onLoad,this);}else{store.on('beforeload',this.onBeforeLoad,this);}}
this.store=store;},onReconfigure:function(){this.bindStore(this.grid.getStore());this.store.clearFilter();this.removeAll();this.addFilters(this.grid.getColumnModel());this.updateColumnHeadings();},createMenu:function(){var view=this.grid.getView(),hmenu=view.hmenu;if(this.showMenu&amp;&amp;hmenu){this.sep=hmenu.addSeparator();this.filterMenu=new Ext.menu.Menu({id:this.grid.id+'-filters-menu'});this.menu=hmenu.add({checked:false,itemId:'filters',text:this.menuFilterText,menu:this.filterMenu});this.menu.on({scope:this,checkchange:this.onCheckChange,beforecheckchange:this.onBeforeCheck});hmenu.on('beforeshow',this.onMenu,this);}
this.updateColumnHeadings();},getMenuFilter:function(){var view=this.grid.getView();if(!view||view.hdCtxIndex===undefined){return null;}
return this.filters.get(view.cm.config[view.hdCtxIndex].dataIndex);},onMenu:function(filterMenu){var filter=this.getMenuFilter();if(filter){this.menu.menu=filter.menu;this.menu.setChecked(filter.active,false);this.menu.setDisabled(filter.disabled===true);}
this.menu.setVisible(filter!==undefined);this.sep.setVisible(filter!==undefined);},onCheckChange:function(item,value){this.getMenuFilter().setActive(value);},onBeforeCheck:function(check,value){return!value||this.getMenuFilter().isActivatable();},onStateChange:function(event,filter){if(event==='serialize'){return;}
if(filter==this.getMenuFilter()){this.menu.setChecked(filter.active,false);}
if((this.autoReload||this.local)&amp;&amp;!this.applyingState){this.deferredUpdate.delay(this.updateBuffer);}
this.updateColumnHeadings();if(!this.applyingState){this.grid.saveState();}
this.grid.fireEvent('filterupdate',this,filter);},onBeforeLoad:function(store,options){options.params=options.params||{};this.cleanParams(options.params);var params=this.buildQuery(this.getFilterData());Ext.apply(options.params,params);store.storeOptions(options);},onLoad:function(store,options){store.filterBy(this.getRecordFilter());},onRefresh:function(){this.updateColumnHeadings();},updateColumnHeadings:function(){var view=this.grid.getView(),i,len,filter;if(view.mainHd){for(i=0,len=view.cm.config.length;i&lt;len;i++){filter=this.getFilter(view.cm.config[i].dataIndex);Ext.fly(view.getHeaderCell(i))[filter&amp;&amp;filter.active?'addClass':'removeClass'](this.filterCls);}}},reload:function(){if(this.local){this.grid.store.clearFilter(true);this.grid.store.filterBy(this.getRecordFilter());}else{var start,store=this.grid.store;this.deferredUpdate.cancel();if(this.toolbar){start=store.paramNames.start;if(store.lastOptions&amp;&amp;store.lastOptions.params&amp;&amp;store.lastOptions.params[start]){store.lastOptions.params[start]=0;}}
store.isNewFilter=true;store.reload();}},getRecordFilter:function(){var f=[],len,i;this.filters.each(function(filter){if(filter.active){f.push(filter);}});len=f.length;return function(record){for(i=0;i&lt;len;i++){if(!f[i].validateRecord(record)){return false;}}
return true;};},addFilter:function(config){var Cls=this.getFilterClass(config.type),filter=config.menu?config:(new Cls(config));this.filters.add(filter);Ext.util.Observable.capture(filter,this.onStateChange,this);return filter;},addFilters:function(filters){if(filters){var i,len,filter,cm=false,dI;if(filters instanceof Ext.grid.ColumnModel){filters=filters.config;cm=true;}
for(i=0,len=filters.length;i&lt;len;i++){filter=false;if(cm){dI=filters[i].dataIndex;cA=filters[i].columnAlias;filter=filters[i].filter||filters[i].filterable;if(filter){filter=(filter===true)?{}:filter;Ext.apply(filter,{dataIndex:dI,columnAlias:cA});filter.type=filter.type||this.store.fields.get(dI).type.type;}}else{filter=filters[i];}
if(filter){this.addFilter(filter);}}}},getFilter:function(dataIndex){return this.filters.get(dataIndex);},clearFilters:function(){this.filters.each(function(filter){filter.setActive(false);});},getFilterData:function(){var filters=[],i,len;this.filters.each(function(f){if(f.active){var d=[].concat(f.serialize());for(i=0,len=d.length;i&lt;len;i++){filters.push({field:f.dataIndex,data:d[i]});}}});return filters;},buildQuery:function(filters){var p={},i,f,root,dataPrefix,key,tmp,len=filters.length;if(!this.encode){for(i=0;i&lt;len;i++){f=filters[i];root=[this.paramPrefix,'[',i,']'].join('');p[root+'[field]']=f.field;dataPrefix=root+'[data]';for(key in f.data){p[[dataPrefix,'[',key,']'].join('')]=f.data[key];}}}else{tmp=[];for(i=0;i&lt;len;i++){f=filters[i];tmp.push(Ext.apply({},{field:f.field},f.data));}
if(tmp.length&gt;0){p[this.paramPrefix]=Ext.util.JSON.encode(tmp);}}
return p;},cleanParams:function(p){if(this.encode){delete p[this.paramPrefix];}else{var regex,key;regex=new RegExp('^'+this.paramPrefix+'\[[0-9]+\]');for(key in p){if(regex.test(key)){delete p[key];}}}},getFilterClass:function(type){switch(type){case'auto':case'string':type='string';break;case'int':case'float':type='numeric';break;case'date':case'dateAsString':type='date'
break;}
return Ext.ux.grid.filter[type.substr(0,1).toUpperCase()+type.substr(1)+'Filter'];}});Ext.preg('gridfilters',Ext.ux.grid.GridFilters);Ext.ux.grid.GridFiltersSpe=Ext.extend(Ext.ux.grid.GridFilters,{getFilterData:function(){var filters=[],i,len;this.filters.each(function(f){if(f.active){var d=[].concat(f.serialize());for(i=0,len=d.length;i&lt;len;i++){filters.push({columnAlias:f.columnAlias,data:d[i]});}}});return filters;},buildQuery:function(filters){var p={},i,f,root,dataPrefix,key,tmp,len=filters.length;if(!this.encode){for(i=0;i&lt;len;i++){f=filters[i];root=[this.paramPrefix,'[',i,']'].join('');p[root+'[columnAlias]']=f.columnAlias;dataPrefix=root+'[data]';for(key in f.data){p[[dataPrefix,'[',key,']'].join('')]=f.data[key];}}}else{tmp=[];for(i=0;i&lt;len;i++){f=filters[i];tmp.push(Ext.apply({},{columnAlias:f.columnAlias},f.data));}
if(tmp.length&gt;0){p[this.paramPrefix]=Ext.util.JSON.encode(tmp);}}
return p;}});Ext.preg('gridfiltersspe',Ext.ux.grid.GridFiltersSpe);Ext.namespace('Ext.ux.grid.livegrid');Ext.ux.grid.livegrid.GridPanel=Ext.extend(Ext.grid.GridPanel,{initComponent:function(){if(this.cls){this.cls+=' ext-ux-livegrid';}else{this.cls='ext-ux-livegrid';}
Ext.ux.grid.livegrid.GridPanel.superclass.initComponent.call(this);},onRender:function(ct,position){Ext.ux.grid.livegrid.GridPanel.superclass.onRender.call(this,ct,position);var ds=this.getStore();if(ds._autoLoad===true){delete ds._autoLoad;ds.load();}},walkCells:function(row,col,step,fn,scope){var ds=this.store;var _oF=ds.getCount;ds.getCount=ds.getTotalCount;var ret=Ext.ux.grid.livegrid.GridPanel.superclass.walkCells.call(this,row,col,step,fn,scope);ds.getCount=_oF;return ret;}});Ext.namespace('Ext.ux.grid.livegrid');Ext.ux.grid.livegrid.GridView=function(config){this.addEvents({'beforebuffer':true,'buffer':true,'bufferfailure':true,'cursormove':true,'abortrequest':true});this.horizontalScrollOffset=17;this._checkEmptyBody=true;Ext.apply(this,config);this.templates={};this.templates.master=new Ext.Template('&lt;div class=&quot;x-grid3&quot; hidefocus=&quot;true&quot;&gt;&lt;div class=&quot;liveScroller&quot;&gt;&lt;div&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;/div&gt;','&lt;div class=&quot;x-grid3-viewport&quot;&quot;&gt;','&lt;div class=&quot;x-grid3-header&quot;&gt;&lt;div class=&quot;x-grid3-header-inner&quot;&gt;&lt;div class=&quot;x-grid3-header-offset&quot; style=&quot;{ostyle}&quot;&gt;{header}&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;x-clear&quot;&gt;&lt;/div&gt;&lt;/div&gt;','&lt;div class=&quot;x-grid3-scroller&quot; style=&quot;overflow-y:hidden !important;&quot;&gt;&lt;div class=&quot;x-grid3-body&quot; style=&quot;{bstyle}&quot;&gt;{body}&lt;/div&gt;&lt;a href=&quot;#&quot; class=&quot;x-grid3-focus&quot; tabIndex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/div&gt;',&quot;&lt;/div&gt;&quot;,'&lt;div class=&quot;x-grid3-resize-marker&quot;&gt;&amp;#160;&lt;/div&gt;','&lt;div class=&quot;x-grid3-resize-proxy&quot;&gt;&amp;#160;&lt;/div&gt;',&quot;&lt;/div&gt;&quot;);this._gridViewSuperclass=Ext.ux.grid.livegrid.GridView.superclass;this._gridViewSuperclass.constructor.call(this);};Ext.extend(Ext.ux.grid.livegrid.GridView,Ext.ux.sitoolsGridView,{hdHeight:0,rowClipped:0,liveScroller:null,liveScrollerInsets:null,rowHeight:-1,visibleRows:1,lastIndex:-1,lastRowIndex:0,lastScrollPos:0,rowIndex:0,isBuffering:false,requestQueue:-1,loadMask:false,loadMaskDisplayed:false,isPrebuffering:false,_loadMaskAnchor:null,_displayWarningTooManyRows:true,reset:function(forceReload){if(forceReload===false){this.ds.modified=[];this.rowIndex=0;this.lastScrollPos=0;this.lastRowIndex=0;this.lastIndex=0;this.adjustVisibleRows();this.adjustScrollerPos(-this.liveScroller.dom.scrollTop,true);this.showLoadMask(false);var _ofn=this.processRows;this.processRows=Ext.emptyFn;this.refresh(true);this.processRows=_ofn;this.processRows(0);this.fireEvent('cursormove',this,0,Math.min(this.ds.totalLength,this.visibleRows-this.rowClipped),this.ds.totalLength);return false;}else{var params={colModel:Ext.util.JSON.encode(extColModelToSrv(this.cm))};var sInfo=this.ds.sortInfo;if(sInfo){Ext.apply(params,{dir:sInfo.direction,sort:sInfo.field});}
return this.ds.load({params:params});}},render:function(){if(this.autoFill){var ct=this.grid.ownerCt;if(ct&amp;&amp;ct.getLayout()){ct.on('afterlayout',function(){this.fitColumns(true,true);this.updateHeaders();this.updateHeaderSortState();},this,{single:true});}}else if(this.forceFit){this.fitColumns(true,false);}else if(this.grid.autoExpandColumn){this.autoExpand(true);}
this.grid.getGridEl().dom.innerHTML=this.renderUI();this.afterRenderUI();},renderUI:function(){var g=this.grid;var dEnabled=g.enableDragDrop||g.enableDrag;g.enableDragDrop=false;g.enableDrag=false;var m=this._gridViewSuperclass.renderUI.call(this);g=this.grid;g.enableDragDrop=dEnabled;g.enableDrag=dEnabled;if(dEnabled){this.dragZone=new Ext.ux.grid.livegrid.DragZone(g,{ddGroup:g.ddGroup||'GridDD'});}
return m;},afterRenderUI:function()
{this._gridViewSuperclass.afterRenderUI.call(this);if(this.loadMask){this._loadMaskAnchor=Ext.get(this.mainBody.dom.parentNode.parentNode);Ext.apply(this.loadMask,{msgCls:'x-mask-loading'});this._loadMaskAnchor.mask(this.loadMask.msg,this.loadMask.msgCls);var dom=this._loadMaskAnchor.dom;var data=Ext.Element.data;data(dom,'mask').addClass('ext-ux-livegrid');data(dom,'mask').setDisplayed(false);data(dom,'maskMsg').setDisplayed(false);}},init:function(grid){this._gridViewSuperclass.init.call(this,grid);grid.on('expand',this._onExpand,this);},initData:function(ds,cm){if(this.ds){this.ds.un('bulkremove',this.onBulkRemove,this);this.ds.un('beforeload',this.onBeforeLoad,this);}
if(ds){ds.on('bulkremove',this.onBulkRemove,this);ds.on('beforeload',this.onBeforeLoad,this);}
this._gridViewSuperclass.initData.call(this,ds,cm);},renderBody:function(){var markup=this.renderRows(0,this.visibleRows-1);return this.templates.body.apply({rows:markup});},doRender:function(cs,rs,ds,startRow,colCount,stripe){return this._gridViewSuperclass.doRender.call(this,cs,rs,ds,startRow+this.ds.bufferRange[0],colCount,stripe);},initElements:function(){var E=Ext.Element;var el=this.grid.getGridEl().dom.firstChild;var cs=el.childNodes;this.el=new E(el);this.mainWrap=new E(cs[1]);this.liveScroller=new E(cs[0]);var f=this.liveScroller.dom.firstChild;this.liveScrollerInsets=[f];var divSuivante=f.nextSibling;while(!Ext.isEmpty(divSuivante)){this.liveScrollerInsets.push(divSuivante);divSuivante=divSuivante.nextSibling;}
this.liveScroller.on('scroll',this.onLiveScroll,this,{buffer:this.scrollDelay});var thd=this.mainWrap.dom.firstChild;this.mainHd=new E(thd);this.hdHeight=thd.offsetHeight;this.innerHd=this.mainHd.dom.firstChild;this.scroller=new E(this.mainWrap.dom.childNodes[1]);if(this.forceFit){this.scroller.setStyle('overflow-x','hidden');}
this.mainBody=new E(this.scroller.dom.firstChild);this.mainBody.on('mousewheel',this.handleWheel,this);this.focusEl=new E(this.scroller.dom.childNodes[1]);this.focusEl.swallowEvent(&quot;click&quot;,true);this.resizeMarker=new E(cs[2]);this.resizeProxy=new E(cs[3]);},layout:function(){if(!this.mainBody){return;}
var g=this.grid;var c=g.getGridEl(),cm=this.cm,expandCol=g.autoExpandColumn,gv=this;var csize=c.getSize(true);var vw=csize.width;if(!g.hideHeaders&amp;&amp;vw&lt;20||csize.height&lt;20){return;}
if(g.autoHeight){this.scroller.dom.style.overflow='visible';if(Ext.isWebKit){this.scroller.dom.style.position='static';}}else{this.el.setSize(csize.width,csize.height);var hdHeight=this.mainHd.getHeight();var vh=csize.height-(hdHeight);this.scroller.setSize(vw,vh);if(this.innerHd){this.innerHd.style.width=(vw)+'px';}}
this.liveScroller.dom.style.top=this.hdHeight+&quot;px&quot;;if(this.forceFit){if(this.lastViewWidth!=vw){this.fitColumns(false,false);this.lastViewWidth=vw;}}else{this.autoExpand();}
this.adjustVisibleRows();this.adjustBufferInset();this.onLayout(vw,vh);},removeRow:function(row){Ext.removeNode(this.getRow(row));},removeRows:function(firstRow,lastRow){var bd=this.mainBody.dom;for(var rowIndex=firstRow;rowIndex&lt;=lastRow;rowIndex++){Ext.removeNode(bd.childNodes[firstRow]);}},_onExpand:function(panel){this.adjustVisibleRows();this.adjustBufferInset();this.adjustScrollerPos(this.rowHeight*this.rowIndex,true);},onColumnMove:function(cm,oldIndex,newIndex){this.indexMap=null;this.replaceLiveRows(this.rowIndex,true);this.updateHeaders();this.updateHeaderSortState();this.afterMove(newIndex);this.grid.fireEvent('columnmove',oldIndex,newIndex);},onColumnWidthUpdated:function(col,w,tw){this.adjustVisibleRows();this.adjustBufferInset();},onAllColumnWidthsUpdated:function(ws,tw){this.adjustVisibleRows();this.adjustBufferInset();},onRowSelect:function(row){if(row&lt;this.rowIndex||row&gt;this.rowIndex+this.visibleRows){return;}
this.addRowClass(row,this.selectedRowClass);},onRowDeselect:function(row){if(row&lt;this.rowIndex||row&gt;this.rowIndex+this.visibleRows){return;}
this.removeRowClass(row,this.selectedRowClass);},onClear:function(){this.reset(false);},onBulkRemove:function(store,removedData){var record=null;var index=0;var viewIndex=0;var len=removedData.length;var removedInView=false;var removedAfterView=false;var scrollerAdjust=0;if(len===0){return;}
var tmpRowIndex=this.rowIndex;var removedBefore=0;var removedAfter=0;var removedIn=0;for(var i=0;i&lt;len;i++){record=removedData[i][0];index=removedData[i][1];viewIndex=(index!=Number.MIN_VALUE&amp;&amp;index!=Number.MAX_VALUE)?index+this.ds.bufferRange[0]:index;if(viewIndex&lt;this.rowIndex){removedBefore++;}else if(viewIndex&gt;=this.rowIndex&amp;&amp;viewIndex&lt;=this.rowIndex+(this.visibleRows-1)){removedIn++;}else if(viewIndex&gt;=this.rowIndex+this.visibleRows){removedAfter++;}
this.fireEvent(&quot;beforerowremoved&quot;,this,viewIndex,record);this.fireEvent(&quot;rowremoved&quot;,this,viewIndex,record);}
var totalLength=this.ds.totalLength;this.rowIndex=Math.max(0,Math.min(this.rowIndex-removedBefore,totalLength-(this.visibleRows-1)));this.lastRowIndex=this.rowIndex;this.adjustScrollerPos(-(removedBefore*this.rowHeight),true);this.updateLiveRows(this.rowIndex,true);this.adjustBufferInset();this.processRows(0,undefined,false);},onRemove:function(ds,record,index){this.onBulkRemove(ds,[[record,index]]);},onAdd:function(ds,records,index){if(this._checkEmptyBody){if(this.mainBody.dom.innerHTML=='&amp;nbsp;'){this.mainBody.dom.innerHTML='';}
this._checkEmptyBody=false;}
var recordLen=records.length;if(index==Number.MAX_VALUE||index==Number.MIN_VALUE){this.fireEvent(&quot;beforerowsinserted&quot;,this,index,index);if(index==Number.MIN_VALUE){this.rowIndex=this.rowIndex+recordLen;this.lastRowIndex=this.rowIndex;this.adjustBufferInset();this.adjustScrollerPos(this.rowHeight*recordLen,true);this.fireEvent(&quot;rowsinserted&quot;,this,index,index,recordLen);this.processRows(0,undefined,false);this.fireEvent('cursormove',this,this.rowIndex,Math.min(this.ds.totalLength,this.visibleRows-this.rowClipped),this.ds.totalLength);return;}
this.adjustBufferInset();this.fireEvent(&quot;rowsinserted&quot;,this,index,index,recordLen);return;}
var start=index+this.ds.bufferRange[0];var end=start+(recordLen-1);var len=this.getRows().length;var firstRow=0;var lastRow=0;if(start&gt;this.rowIndex+(this.visibleRows-1)){this.fireEvent(&quot;beforerowsinserted&quot;,this,start,end);this.fireEvent(&quot;rowsinserted&quot;,this,start,end,recordLen);this.adjustVisibleRows();this.adjustBufferInset();}
else if(start&gt;=this.rowIndex&amp;&amp;start&lt;=this.rowIndex+(this.visibleRows-1)){firstRow=index;lastRow=index+(recordLen-1);this.lastRowIndex=this.rowIndex;this.rowIndex=(start&gt;this.rowIndex)?this.rowIndex:start;this.insertRows(ds,firstRow,lastRow);if(this.lastRowIndex!=this.rowIndex){this.fireEvent('cursormove',this,this.rowIndex,Math.min(this.ds.totalLength,this.visibleRows-this.rowClipped),this.ds.totalLength);}
this.adjustVisibleRows();this.adjustBufferInset();}
else if(start&lt;this.rowIndex){this.fireEvent(&quot;beforerowsinserted&quot;,this,start,end);this.rowIndex=this.rowIndex+recordLen;this.lastRowIndex=this.rowIndex;this.adjustVisibleRows();this.adjustBufferInset();this.adjustScrollerPos(this.rowHeight*recordLen,true);this.fireEvent(&quot;rowsinserted&quot;,this,start,end,recordLen);this.processRows(0,undefined,true);this.fireEvent('cursormove',this,this.rowIndex,Math.min(this.ds.totalLength,this.visibleRows-this.rowClipped),this.ds.totalLength);}},onBeforeLoad:function(store,options){var proxy=store.proxy;if(proxy.activeRequest&amp;&amp;proxy.activeRequest[Ext.data.Api.actions.read]){proxy.getConnection().abort(proxy.activeRequest[Ext.data.Api.actions.read]);}
this.fireEvent('abortrequest',store,options);this.isBuffering=false;this.isPreBuffering=false;options.params=options.params||{};var apply=Ext.apply;apply(options,{scope:this,callback:function(){this.reset(false);},suspendLoadEvent:false});apply(options.params,{start:0,limit:this.ds.bufferSize});return true;},onLoad:function(o1,o2,options){this.adjustBufferInset();},onDataChange:function(store){this.updateHeaderSortState();},liveBufferUpdate:function(records,options,success){if(success===true){this.adjustBufferInset();this.fireEvent('buffer',this,this.ds,this.rowIndex,Math.min(this.ds.totalLength,this.visibleRows-this.rowClipped),this.ds.totalLength,options);this.grid.selModel.replaceSelections(records);this.isBuffering=false;this.isPrebuffering=false;this.showLoadMask(false);if(this.requestQueue&gt;=0){var offset=this.requestQueue;this.requestQueue=-1;this.updateLiveRows(offset);return;}
if(this.isInRange(this.rowIndex)){this.replaceLiveRows(this.rowIndex,options.forceRepaint);}else{this.updateLiveRows(this.rowIndex);}
return;}else{this.fireEvent('bufferfailure',this,this.ds,options);}
this.requestQueue=-1;this.isBuffering=false;this.isPrebuffering=false;this.showLoadMask(false);},handleWheel:function(e){if(this.rowHeight==-1){e.stopEvent();return;}
var d=e.getWheelDelta();this.adjustScrollerPos(-(d*this.rowHeight));e.stopEvent();},onLiveScroll:function(){var scrollTop=this.liveScroller.dom.scrollTop;var cursor=Math.floor((scrollTop)/this.rowHeight);this.rowIndex=cursor;if(cursor==this.lastRowIndex){return;}
this.updateLiveRows(cursor);this.lastScrollPos=this.liveScroller.dom.scrollTop;},refreshRow:function(record){var ds=this.ds,index;if(typeof record=='number'){index=record;record=ds.getAt(index);}else{index=ds.indexOf(record);}
var viewIndex=index+this.ds.bufferRange[0];if(viewIndex&lt;this.rowIndex||viewIndex&gt;=this.rowIndex+this.visibleRows){this.fireEvent(&quot;rowupdated&quot;,this,viewIndex,record);return;}
this.insertRows(ds,index,index,true);this.fireEvent(&quot;rowupdated&quot;,this,viewIndex,record);},processRows:function(startRow,skipStripe,paintSelections){if(!this.ds||this.ds.getCount()&lt;1){return;}
skipStripe=skipStripe||!this.grid.stripeRows;var cursor=this.rowIndex;var rows=this.getRows();var index=0;var row=null;for(var idx=0,len=rows.length;idx&lt;len;idx++){row=rows[idx];row.rowIndex=index=cursor+idx;row.className=row.className.replace(this.rowClsRe,' ');if(!skipStripe&amp;&amp;(index+1)%2===0){row.className+=' x-grid3-row-alt';}
if(paintSelections!==false){if(this.grid.selModel.isSelected(this.ds.getAt(index))===true){this.addRowClass(index,this.selectedRowClass);}else{this.removeRowClass(index,this.selectedRowClass);}
this.fly(row).removeClass(&quot;x-grid3-row-over&quot;);}}
if(cursor===0){Ext.fly(rows[0]).addClass(this.firstRowCls);}else if(cursor+rows.length==this.ds.totalLength){Ext.fly(rows[rows.length-1]).addClass(this.lastRowCls);}},insertRows:function(dm,firstRow,lastRow,isUpdate){var viewIndexFirst=firstRow+this.ds.bufferRange[0];var viewIndexLast=lastRow+this.ds.bufferRange[0];if(!isUpdate){this.fireEvent(&quot;beforerowsinserted&quot;,this,viewIndexFirst,viewIndexLast);}
if(isUpdate!==true&amp;&amp;(this.getRows().length+(lastRow-firstRow))&gt;=this.visibleRows){this.removeRows((this.visibleRows-1)-(lastRow-firstRow),this.visibleRows-1);}else if(isUpdate){this.removeRows(viewIndexFirst-this.rowIndex,viewIndexLast-this.rowIndex);}
var lastRenderRow=(firstRow==lastRow)?lastRow:Math.min(lastRow,(this.rowIndex-this.ds.bufferRange[0])+(this.visibleRows-1));var html=this.renderRows(firstRow,lastRenderRow);var before=this.getRow(viewIndexFirst);if(before){Ext.DomHelper.insertHtml('beforeBegin',before,html);}else{Ext.DomHelper.insertHtml('beforeEnd',this.mainBody.dom,html);}
if(isUpdate===true){var rows=this.getRows();var cursor=this.rowIndex;for(var i=0,max_i=rows.length;i&lt;max_i;i++){rows[i].rowIndex=cursor+i;}}
if(!isUpdate){this.fireEvent(&quot;rowsinserted&quot;,this,viewIndexFirst,viewIndexLast,(viewIndexLast-viewIndexFirst)+1);this.processRows(0,undefined,true);}},getRow:function(row){if(row-this.rowIndex&lt;0){return null;}
return this.getRows()[row-this.rowIndex];},getCell:function(row,col){var arow=this.getRow(row);return arow?arow.getElementsByTagName('td')[col]:null;},focusCell:function(row,col,hscroll){var xy=this.ensureVisible(row,col,hscroll);if(!xy){return;}
this.focusEl.setXY(xy);if(Ext.isGecko){this.focusEl.focus();}else{this.focusEl.focus.defer(1,this.focusEl);}},ensureVisible:function(row,col,hscroll){if(typeof row!=&quot;number&quot;){row=row.rowIndex;}
if(row&lt;0||row&gt;=this.ds.totalLength){return;}
col=(col!==undefined?col:0);var rowInd=row-this.rowIndex;if(this.rowClipped&amp;&amp;row==this.rowIndex+this.visibleRows-1){this.adjustScrollerPos(this.rowHeight);}else if(row&gt;=this.rowIndex+this.visibleRows){this.adjustScrollerPos(((row-(this.rowIndex+this.visibleRows))+1)*this.rowHeight);}else if(row&lt;=this.rowIndex){this.adjustScrollerPos((rowInd)*this.rowHeight);}
var rowEl=this.getRow(row),cellEl;if(!rowEl){return;}
if(!(hscroll===false&amp;&amp;col===0)){while(this.cm.isHidden(col)){col++;}
cellEl=this.getCell(row,col);}
var c=this.scroller.dom;if(hscroll!==false){var cleft=parseInt(cellEl.offsetLeft,10);var cright=cleft+cellEl.offsetWidth;var sleft=parseInt(c.scrollLeft,10);var sright=sleft+c.clientWidth;if(cleft&lt;sleft){c.scrollLeft=cleft;}else if(cright&gt;sright){c.scrollLeft=cright-c.clientWidth;}}
return cellEl?Ext.fly(cellEl).getXY():[c.scrollLeft+this.el.getX(),Ext.fly(rowEl).getY()];},isRecordRendered:function(record){var ind=this.ds.indexOf(record);if(ind&gt;=this.rowIndex&amp;&amp;ind&lt;this.rowIndex+this.visibleRows){return true;}
return false;},isInRange:function(rowIndex){var lastRowIndex=Math.min(this.ds.totalLength-1,rowIndex+(this.visibleRows-1));return(rowIndex&gt;=this.ds.bufferRange[0])&amp;&amp;(lastRowIndex&lt;=this.ds.bufferRange[1]);},getPredictedBufferIndex:function(index,inRange,down){if(!inRange){if(index+this.ds.bufferSize&gt;=this.ds.totalLength){return this.ds.totalLength-this.ds.bufferSize;}
return Math.max(0,(index+this.visibleRows)-Math.round(this.ds.bufferSize/2));}
if(!down){return Math.max(0,(index-this.ds.bufferSize)+this.visibleRows);}
if(down){return Math.max(0,Math.min(index,this.ds.totalLength-this.ds.bufferSize));}},updateLiveRows:function(index,forceRepaint,forceReload){var inRange=this.isInRange(index);if(this.isBuffering){if(this.isPrebuffering){if(inRange){this.replaceLiveRows(index,forceRepaint);}else{this.showLoadMask(true);}}
this.fireEvent('cursormove',this,index,Math.min(this.ds.totalLength,this.visibleRows-this.rowClipped),this.ds.totalLength);this.requestQueue=index;return;}
var lastIndex=this.lastIndex;this.lastIndex=index;inRange=this.isInRange(index);var down=false;if(inRange&amp;&amp;forceReload!==true){this.replaceLiveRows(index,forceRepaint);this.fireEvent('cursormove',this,index,Math.min(this.ds.totalLength,this.visibleRows-this.rowClipped),this.ds.totalLength);if(index&gt;lastIndex){down=true;var totalCount=this.ds.totalLength;if(index+this.visibleRows+this.nearLimit&lt;=this.ds.bufferRange[1]){return;}
if(this.ds.bufferRange[1]+1&gt;=totalCount){return;}}else if(index&lt;lastIndex){down=false;if(this.ds.bufferRange[0]&lt;=0){return;}
if(index-this.nearLimit&gt;this.ds.bufferRange[0]){return;}}else{return;}
this.isPrebuffering=true;}
this.isBuffering=true;var bufferOffset=this.getPredictedBufferIndex(index,inRange,down);if(!inRange){this.showLoadMask(true);}
this.ds.suspendEvents();var sInfo=this.ds.sortInfo;var params={};if(this.ds.lastOptions){Ext.apply(params,this.ds.lastOptions.params);}
params.start=bufferOffset;params.limit=this.ds.bufferSize;params.nocount=true;if(sInfo){params.dir=sInfo.direction;params.sort=sInfo.field;}
var opts={forceRepaint:forceRepaint,callback:this.liveBufferUpdate,scope:this,params:params,suspendLoadEvent:true};this.fireEvent('beforebuffer',this,this.ds,index,Math.min(this.ds.totalLength,this.visibleRows-this.rowClipped),this.ds.totalLength,opts);this.ds.load(opts);this.ds.resumeEvents();},showLoadMask:function(show){if(!this.loadMask||show==this.loadMaskDisplayed){return;}
var dom=this._loadMaskAnchor.dom;var data=Ext.Element.data;var mask=data(dom,'mask');var maskMsg=data(dom,'maskMsg');if(show){mask.setDisplayed(true);maskMsg.setDisplayed(true);maskMsg.center(this._loadMaskAnchor);if(Ext.isIE&amp;&amp;!(Ext.isIE7&amp;&amp;Ext.isStrict)&amp;&amp;this._loadMaskAnchor.getStyle('height')=='auto'){mask.setSize(undefined,this._loadMaskAnchor.getHeight());}}else{mask.setDisplayed(false);maskMsg.setDisplayed(false);}
this.loadMaskDisplayed=show;},replaceLiveRows:function(cursor,forceReplace,processRows){var spill=cursor-this.lastRowIndex;if(spill===0&amp;&amp;forceReplace!==true){return;}
var append=spill&gt;0;spill=Math.abs(spill);var bufferRange=this.ds.bufferRange;var cursorBuffer=cursor-bufferRange[0];var lpIndex=Math.min(cursorBuffer+this.visibleRows-1,bufferRange[1]-bufferRange[0]);if(spill&gt;=this.visibleRows||spill===0){this.mainBody.update(this.renderRows(cursorBuffer,lpIndex));}else{if(append){this.removeRows(0,spill-1);if(cursorBuffer+this.visibleRows-spill&lt;=bufferRange[1]-bufferRange[0]){var html=this.renderRows(cursorBuffer+this.visibleRows-spill,lpIndex);Ext.DomHelper.insertHtml('beforeEnd',this.mainBody.dom,html);}}else{this.removeRows(this.visibleRows-spill,this.visibleRows-1);html=this.renderRows(cursorBuffer,cursorBuffer+spill-1);Ext.DomHelper.insertHtml('beforeBegin',this.mainBody.dom.firstChild,html);}}
if(processRows!==false){this.processRows(0,undefined,true);}
this.lastRowIndex=cursor;},adjustBufferInset:function(){var liveScrollerDom=this.liveScroller.dom;var g=this.grid,ds=g.store;var c=g.getGridEl();var elWidth=c.getSize().width;var hiddenRows=(ds.totalLength==this.visibleRows-this.rowClipped)?0:Math.max(0,ds.totalLength-(this.visibleRows-this.rowClipped));if(hiddenRows===0){this.scroller.setWidth(elWidth);liveScrollerDom.style.display='none';return;}else{this.scroller.setWidth(elWidth-this.getScrollOffset());liveScrollerDom.style.display='';}
var scrollbar=this.cm.getTotalWidth()+this.getScrollOffset()&gt;elWidth;var contHeight=liveScrollerDom.parentNode.offsetHeight+((ds.totalLength&gt;0&amp;&amp;scrollbar)?-this.horizontalScrollOffset:0)-this.hdHeight;liveScrollerDom.style.height=Math.max(contHeight,this.horizontalScrollOffset*2)+&quot;px&quot;;this.liveScroller.dom.style.width=(this.getScrollOffset()+2)+&quot;px&quot;;if(this.rowHeight==-1){return;}
var cm=this.cm;var vw=elWidth-this.getScrollOffset();var hso=0,hh=0;if(cm.getTotalWidth()&gt;vw){hso=this.horizontalScrollOffset;}
hh=this.mainHd.getHeight();var h=(hiddenRows===0?0:ds.totalLength*this.rowHeight+hso+hh);if(h&gt;35791380){h=35000000;var nbRecords=Math.floor(h/this.rowHeight);if(this._displayWarningTooManyRows){Ext.Msg.alert(i18n.get('label.warning'),String.format(i18n.get(&quot;label.tooManyRecords&quot;),nbRecords,this.visibleRows+hiddenRows));this._displayWarningTooManyRows=false;}}
var oh=h;var len=this.liveScrollerInsets.length;if(h===0){h=0;}else{h=Math.round(h/len);}
for(var i=0;i&lt;len;i++){if(i==len-1&amp;&amp;h!==0){h=oh-(h*i);}
this.liveScrollerInsets[i].style.height=h+&quot;px&quot;;}},adjustVisibleRows:function(){if(this.rowHeight==-1){if(this.getRows()[0]){this.rowHeight=this.getRows()[0].offsetHeight;if(this.rowHeight&lt;=0){this.rowHeight=-1;return;}}else{return;}}
var g=this.grid,ds=g.store;var c=g.getGridEl();var cm=this.cm;var size=c.getSize();var width=size.width;var vh=size.height;var vw=width-this.getScrollOffset();if(cm.getTotalWidth()&gt;vw){vh-=this.horizontalScrollOffset;}
vh-=this.mainHd.getHeight();var totalLength=ds.totalLength||0;var visibleRows=Math.max(1,Math.floor(vh/this.rowHeight));this.rowClipped=0;if(totalLength&gt;visibleRows&amp;&amp;this.rowHeight/3&lt;(vh-(visibleRows*this.rowHeight))){visibleRows=Math.min(visibleRows+1,totalLength);this.rowClipped=1;}
if(this.visibleRows==visibleRows){return;}
this.visibleRows=visibleRows;if(this.isBuffering&amp;&amp;!this.isPrebuffering){return;}
if(this.rowIndex+(visibleRows-this.rowClipped)&gt;totalLength){this.rowIndex=Math.max(0,totalLength-(visibleRows-this.rowClipped));this.lastRowIndex=this.rowIndex;}
this.updateLiveRows(this.rowIndex,true);},adjustScrollerPos:function(pixels,suspendEvent){if(pixels===0){return;}
var liveScroller=this.liveScroller;var scrollDom=liveScroller.dom;if(suspendEvent===true){liveScroller.un('scroll',this.onLiveScroll,this);}
this.lastScrollPos=scrollDom.scrollTop;scrollDom.scrollTop+=pixels;if(suspendEvent===true){scrollDom.scrollTop=scrollDom.scrollTop;liveScroller.on('scroll',this.onLiveScroll,this,{buffer:this.scrollDelay});}}});Ext.namespace('Ext.ux.grid.livegrid');Ext.ux.grid.livegrid.JsonReader=function(meta,recordType){Ext.ux.grid.livegrid.JsonReader.superclass.constructor.call(this,meta,recordType);};Ext.extend(Ext.ux.grid.livegrid.JsonReader,Ext.data.JsonReader,{buildExtractors:function(){if(this.ef){return;}
var s=this.meta;if(s.versionProperty){this.getVersion=this.createAccessor(s.versionProperty);}
Ext.ux.grid.livegrid.JsonReader.superclass.buildExtractors.call(this);},readRecords:function(o){if(!this.__readRecords){this.__readRecords=Ext.ux.grid.livegrid.JsonReader.superclass.readRecords;}
var intercept=this.__readRecords.call(this,o);if(this.meta.versionProperty){var v=this.getVersion(o);intercept.version=(v===undefined||v===&quot;&quot;)?null:v;}
if(Ext.isEmpty(o.total)){intercept.totalRecords=this.totalRecordsSitools;}else{this.totalRecordsSitools=o.total;}
return intercept;}});Ext.namespace('Ext.ux.grid.livegrid');Ext.ux.grid.livegrid.RowSelectionModel=function(config){this.addEvents({'selectiondirty':true,'handleMouseDown':true});Ext.apply(this,config);this.pendingSelections={};Ext.ux.grid.livegrid.RowSelectionModel.superclass.constructor.call(this);};Ext.extend(Ext.ux.grid.livegrid.RowSelectionModel,Ext.grid.RowSelectionModel,{initEvents:function(){Ext.ux.grid.livegrid.RowSelectionModel.superclass.initEvents.call(this);this.grid.view.on('rowsinserted',this.onAdd,this);this.grid.store.on('selectionsload',this.onSelectionsLoad,this);},handleMouseDown:function(g,rowIndex,e){if(e.button!==0||this.isLocked()){return;}
var view=this.grid.getView();if(e.shiftKey&amp;&amp;!this.singleSelect&amp;&amp;this.last!==false){var last=this.last;this.selectRange(last,rowIndex,e.ctrlKey);this.last=last;this.fireEvent('handleMouseDown',this);}else{var isSelected=this.isSelected(rowIndex);if(e.ctrlKey&amp;&amp;isSelected){this.deselectRow(rowIndex);this.fireEvent('handleMouseDown',this);}else if(!isSelected||this.getCount()&gt;1){this.selectRow(rowIndex,e.ctrlKey||e.shiftKey);this.fireEvent('handleMouseDown',this);}}},onRemove:function(v,index,r){var ranges=this.getPendingSelections();var rangesLength=ranges.length;var selectionChanged=false;if(index==Number.MIN_VALUE||index==Number.MAX_VALUE){if(r){if(this.isIdSelected(r.id)&amp;&amp;index==Number.MIN_VALUE){this.shiftSelections(this.grid.store.bufferRange[1],-1);}
this.selections.remove(r);selectionChanged=true;}
if(index==Number.MIN_VALUE){this.clearPendingSelections(0,this.grid.store.bufferRange[0]);}else{this.clearPendingSelections(this.grid.store.bufferRange[1]);}
if(rangesLength!==0){this.fireEvent('selectiondirty',this,index,1);}}else{selectionChanged=this.isIdSelected(r.id);if(!selectionChanged){return;}
this.selections.remove(r);if(rangesLength!==0){var startRange=ranges[0];var endRange=ranges[rangesLength-1];if(index&lt;=endRange||index&lt;=startRange){this.shiftSelections(index,-1);this.fireEvent('selectiondirty',this,index,1);}}}
if(selectionChanged){this.fireEvent('selectionchange',this);}},onAdd:function(store,index,endIndex,recordLength){var ranges=this.getPendingSelections();var rangesLength=ranges.length;if((index==Number.MIN_VALUE||index==Number.MAX_VALUE)){if(index==Number.MIN_VALUE){this.clearPendingSelections(0,this.grid.store.bufferRange[0]);this.shiftSelections(this.grid.store.bufferRange[1],recordLength);}else{this.clearPendingSelections(this.grid.store.bufferRange[1]);}
if(rangesLength!==0){this.fireEvent('selectiondirty',this,index,r);}
return;}
var startRange=ranges[0];var endRange=ranges[rangesLength-1];var viewIndex=index;if(viewIndex&lt;=endRange||viewIndex&lt;=startRange){this.fireEvent('selectiondirty',this,viewIndex,recordLength);this.shiftSelections(viewIndex,recordLength);}},shiftSelections:function(startRow,length){var index=0;var newIndex=0;var newRequests={};var ds=this.grid.store;var storeIndex=startRow-ds.bufferRange[0];var newStoreIndex=0;var totalLength=this.grid.store.totalLength;var rec=null;var ranges=this.getPendingSelections();var rangesLength=ranges.length;if(rangesLength===0){return;}
for(var i=0;i&lt;rangesLength;i++){index=ranges[i];if(index&lt;startRow){continue;}
newIndex=index+length;newStoreIndex=storeIndex+length;if(newIndex&gt;=totalLength){break;}
rec=ds.getAt(newStoreIndex);if(rec){this.selections.add(rec);}else{newRequests[newIndex]=true;}
this.allSelections[newIndex]=true;}
this.pendingSelections=newRequests;},onSelectionsLoad:function(store,records,ranges){this.replaceSelections(records);},hasNext:function(){return this.last!==false&amp;&amp;(this.last+1)&lt;this.grid.store.getTotalCount();},getCount:function(){return this.selections.length+this.getPendingSelections().length;},isSelected:function(index){if(typeof index==&quot;number&quot;){var orgInd=index;index=this.grid.store.getAt(orgInd);if(!index){var ind=this.getPendingSelections().indexOf(orgInd);if(ind!=-1){return true;}
return false;}}
var r=index;return(r&amp;&amp;this.selections.key(r.id)?true:false);},deselectRecord:function(record,preventViewNotify){if(this.locked){return;}
var isSelected=this.selections.key(record.id);if(!isSelected){return;}
var store=this.grid.store;var index=store.indexOfId(record.id);if(index==-1){index=store.findInsertIndex(record);if(index!=Number.MIN_VALUE&amp;&amp;index!=Number.MAX_VALUE){index+=store.bufferRange[0];}}else{delete this.pendingSelections[index];}
if(this.last==index){this.last=false;}
if(this.lastActive==index){this.lastActive=false;}
delete this.allSelections[index];this.selections.remove(record);if(!preventViewNotify){this.grid.getView().onRowDeselect(index);}
this.fireEvent(&quot;rowdeselect&quot;,this,index,record);this.fireEvent(&quot;selectionchange&quot;,this);},deselectRow:function(index,preventViewNotify){if(this.locked){return;}
if(this.last==index){this.last=false;}
if(this.lastActive==index){this.lastActive=false;}
var r=this.grid.store.getAt(index);delete this.allSelections[index];delete this.pendingSelections[index];if(r){this.selections.remove(r);}
if(!preventViewNotify){this.grid.getView().onRowDeselect(index);}
this.fireEvent(&quot;rowdeselect&quot;,this,index,r);this.fireEvent(&quot;selectionchange&quot;,this);},selectRow:function(index,keepExisting,preventViewNotify){if(this.locked||index&lt;0||index&gt;=this.grid.store.getTotalCount()){return;}
var r=this.grid.store.getAt(index);if(this.fireEvent(&quot;beforerowselect&quot;,this,index,keepExisting,r)!==false){if(!keepExisting||this.singleSelect){this.clearSelections();}
if(r){this.selections.add(r);delete this.pendingSelections[index];}else{this.pendingSelections[index]=true;}
this.allSelections[index]=true;this.last=this.lastActive=index;if(!preventViewNotify){this.grid.getView().onRowSelect(index);}
this.fireEvent(&quot;rowselect&quot;,this,index,r);this.fireEvent(&quot;selectionchange&quot;,this);}},clearPendingSelections:function(startIndex,endIndex){if(endIndex===undefined){endIndex=Number.MAX_VALUE;}
var newSelections={};var ranges=this.getPendingSelections();var rangesLength=ranges.length;var index=0;for(var i=0;i&lt;rangesLength;i++){index=ranges[i];if(index&lt;=endIndex&amp;&amp;index&gt;=startIndex){continue;}
newSelections[index]=true;}
this.pendingSelections=newSelections;},replaceSelections:function(records){if(!records||records.length===0){return;}
var ds=this.grid.store;var rec=null;var assigned=[];var ranges=this.getPendingSelections();var rangesLength=ranges.length;var selections=this.selections;var index=0;for(var i=0;i&lt;rangesLength;i++){index=ranges[i];rec=ds.getAt(index);if(rec){selections.add(rec);assigned.push(rec.id);delete this.pendingSelections[index];}}
var id=null;var len=null;for(i=0,len=records.length;i&lt;len;i++){rec=records[i];id=rec.id;if(assigned.indexOf(id)==-1&amp;&amp;selections.containsKey(id)){selections.add(rec);}}},getPendingSelections:function(asRange){var index=1;var ranges=[];var currentRange=0;var tmpArray=[];for(var i in this.pendingSelections){tmpArray.push(parseInt(i));}
tmpArray.sort(function(o1,o2){if(o1&gt;o2){return 1;}else if(o1&lt;o2){return-1;}else{return 0;}});if(!asRange){return tmpArray;}
var max_i=tmpArray.length;if(max_i===0){return[];}
ranges[currentRange]=[tmpArray[0],tmpArray[0]];for(var i=0,max_i=max_i-1;i&lt;max_i;i++){if(tmpArray[i+1]-tmpArray[i]==1){ranges[currentRange][1]=tmpArray[i+1];}else{currentRange++;ranges[currentRange]=[tmpArray[i+1],tmpArray[i+1]];}}
return ranges;},getAllSelections:function(asRange){var index=1;var ranges=[];var currentRange=0;var tmpArray=[];for(var i in this.allSelections){tmpArray.push(parseInt(i));}
tmpArray.sort(function(o1,o2){if(o1&gt;o2){return 1;}else if(o1&lt;o2){return-1;}else{return 0;}});if(!asRange){return tmpArray;}
var max_i=tmpArray.length;if(max_i===0){return[];}
ranges[currentRange]=[tmpArray[0],tmpArray[0]];for(var i=0,max_i=max_i-1;i&lt;max_i;i++){if(tmpArray[i+1]-tmpArray[i]==1){ranges[currentRange][1]=tmpArray[i+1];}else{currentRange++;ranges[currentRange]=[tmpArray[i+1],tmpArray[i+1]];}}
return ranges;},clearSelections:function(fast){if(this.locked){return;}
if(fast!==true){var ds=this.grid.store;var s=this.selections;var ind=-1;s.each(function(r){ind=ds.indexOfId(r.id);if(ind!=-1){this.deselectRow(ind+ds.bufferRange[0]);}},this);s.clear();this.pendingSelections={};}else{this.selections.clear();this.pendingSelections={};}
this.allSelections={};this.last=false;},selectRange:function(startRow,endRow,keepExisting){if(this.locked){return;}
if(!keepExisting){this.clearSelections();}
if(startRow&lt;=endRow){for(var i=startRow;i&lt;=endRow;i++){this.selectRow(i,true);}}else{for(var i=startRow;i&gt;=endRow;i--){this.selectRow(i,true);}}}});Ext.namespace('Ext.ux.grid.livegrid');Ext.ux.grid.livegrid.Store=function(config){config=config||{};config.remoteSort=true;this._autoLoad=config.autoLoad?true:false;config.autoLoad=false;this.addEvents('bulkremove','versionchange','beforeselectionsload','selectionsload');Ext.ux.grid.livegrid.Store.superclass.constructor.call(this,config);this.totalLength=0;this.bufferRange=[-1,-1];this.on('clear',function(){this.bufferRange=[-1,-1];},this);if(this.url&amp;&amp;!this.selectionsProxy){this.selectionsProxy=new Ext.data.HttpProxy({url:this.url});}};Ext.extend(Ext.ux.grid.livegrid.Store,Ext.data.Store,{version:null,insert:function(index,records){records=[].concat(records);index=index&gt;=this.bufferSize?Number.MAX_VALUE:index;if(index==Number.MIN_VALUE||index==Number.MAX_VALUE){var l=records.length;if(index==Number.MIN_VALUE){this.bufferRange[0]+=l;this.bufferRange[1]+=l;}
this.totalLength+=l;this.fireEvent(&quot;add&quot;,this,records,index);return;}
var split=false;var insertRecords=records;if(records.length+index&gt;=this.bufferSize){split=true;insertRecords=records.splice(0,this.bufferSize-index);}
this.totalLength+=insertRecords.length;if(this.bufferRange[0]&lt;=-1){this.bufferRange[0]=0;}
if(this.bufferRange[1]&lt;(this.bufferSize-1)){this.bufferRange[1]=Math.min(this.bufferRange[1]+insertRecords.length,this.bufferSize-1);}
for(var i=0,len=insertRecords.length;i&lt;len;i++){this.data.insert(index,insertRecords[i]);insertRecords[i].join(this);}
while(this.getCount()&gt;this.bufferSize){this.data.remove(this.data.last());}
this.fireEvent(&quot;add&quot;,this,insertRecords,index);if(split===true){this.fireEvent(&quot;add&quot;,this,records,Number.MAX_VALUE);}},remove:function(record,suspendEvent){var index=this._getIndex(record);if(index&lt;0){this.totalLength-=1;if(this.pruneModifiedRecords){this.modified.remove(record);}
this.bufferRange[0]=Math.max(-1,this.bufferRange[0]-1);this.bufferRange[1]=Math.max(-1,this.bufferRange[1]-1);if(suspendEvent!==true){this.fireEvent(&quot;remove&quot;,this,record,index);}
return index;}
this.bufferRange[1]=Math.max(-1,this.bufferRange[1]-1);this.data.removeAt(index);if(this.pruneModifiedRecords){this.modified.remove(record);}
this.totalLength-=1;if(suspendEvent!==true){this.fireEvent(&quot;remove&quot;,this,record,index);}
return index;},_getIndex:function(record){var index=this.indexOfId(record.id);if(index&lt;0){index=this.findInsertIndex(record);}
return index;},bulkRemove:function(records){var rec=null;var recs=[];var ind=0;var len=records.length;var orgIndexes=[];for(var i=0;i&lt;len;i++){rec=records[i];orgIndexes[rec.id]=this._getIndex(rec);}
for(var i=0;i&lt;len;i++){rec=records[i];this.remove(rec,true);recs.push([rec,orgIndexes[rec.id]]);}
this.fireEvent(&quot;bulkremove&quot;,this,recs);},removeAll:function(){this.totalLength=0;this.bufferRange=[-1,-1];this.data.clear();if(this.pruneModifiedRecords){this.modified=[];}
this.fireEvent(&quot;clear&quot;,this);},loadRanges:function(ranges){var max_i=ranges.length;if(max_i&gt;0&amp;&amp;!this.selectionsProxy.activeRequest[Ext.data.Api.actions.read]&amp;&amp;this.fireEvent(&quot;beforeselectionsload&quot;,this,ranges)!==false){var lParams=this.lastOptions.params;var params={};params.ranges=Ext.encode(ranges);if(lParams){if(lParams.sort){params.sort=lParams.sort;}
if(lParams.dir){params.dir=lParams.dir;}}
var options={};for(var i in this.lastOptions){options.i=this.lastOptions.i;}
options.ranges=params.ranges;this.selectionsProxy.doRequest(Ext.data.Api.actions.read,null,options,this.reader,this.selectionsLoaded,this,options);}},loadSelections:function(ranges){if(ranges.length===0){return;}
this.loadRanges(ranges);},selectionsLoaded:function(o,options,success){if(this.checkVersionChange(o,options,success)!==false){var r=o.records;for(var i=0,len=r.length;i&lt;len;i++){r[i].join(this);}
this.fireEvent(&quot;selectionsload&quot;,this,o.records,Ext.decode(options.ranges));}else{this.fireEvent(&quot;selectionsload&quot;,this,[],Ext.decode(options.ranges));}},checkVersionChange:function(o,options,success){if(o&amp;&amp;success!==false){if(o.version!==undefined){var old=this.version;this.version=o.version;if(this.version!==old){return this.fireEvent('versionchange',this,old,this.version);}}}},findInsertIndex:function(record){this.remoteSort=false;var index=Ext.ux.grid.livegrid.Store.superclass.findInsertIndex.call(this,record);this.remoteSort=true;if(this.bufferRange[0]&lt;=0&amp;&amp;index===0){return index;}else if(this.bufferRange[0]&gt;0&amp;&amp;index===0){return Number.MIN_VALUE;}else if(index&gt;=this.bufferSize){return Number.MAX_VALUE;}
return index;},sortData:function(f,direction){direction=direction||'ASC';var st=this.fields.get(f).sortType;var fn=function(r1,r2){var v1=st(r1.data[f]),v2=st(r2.data[f]);return v1&gt;v2?1:(v1&lt;v2?-1:0);};this.data.sort(direction,fn);},onMetaChange:function(meta,rtype,o){this.version=null;Ext.ux.grid.livegrid.Store.superclass.onMetaChange.call(this,meta,rtype,o);},loadRecords:function(o,options,success){this.checkVersionChange(o,options,success);if(!o){this.bufferRange=[-1,-1];}else{this.bufferRange=[options.params.start,Math.max(0,Math.min((options.params.start+options.params.limit)-1,o.totalRecords-1))];}
if(options.suspendLoadEvent===true){this.suspendEvents();}
Ext.ux.grid.livegrid.Store.superclass.loadRecords.call(this,o,options,success);if(options.suspendLoadEvent===true){this.resumeEvents();}},getAt:function(index){if(this.bufferRange[0]==-1){return undefined;}
var modelIndex=index-this.bufferRange[0];return this.data.itemAt(modelIndex);},clearFilter:function(){},isFiltered:function(){},collect:function(){},createFilterFn:function(){},sum:function(){},filter:function(){},filterBy:function(){},query:function(){},queryBy:function(){},find:function(){},findBy:function(){}});Ext.namespace('Ext.ux.grid.livegrid');Ext.ux.grid.livegrid.Toolbar=Ext.extend(Ext.Toolbar,{displayMsg:&quot;&quot;,emptyMsg:'No data to display',refreshText:&quot;Refresh&quot;,initComponent:function(){this.displayMsg=i18n.get('paging.display');Ext.ux.grid.livegrid.Toolbar.superclass.initComponent.call(this);if(this.grid){this.view=this.grid.getView();}
var me=this;this.view.init=this.view.init.createSequence(function(){me.bind(this);},this.view);},updateInfo:function(rowIndex,visibleRows,totalCount){if(this.displayEl){var msg=totalCount===0?this.emptyMsg:String.format(this.displayMsg,rowIndex+1,Math.min(rowIndex+1+visibleRows,totalCount),totalCount);this.displayEl.update(msg);}},unbind:function(view){var st;var vw;if(view instanceof Ext.grid.GridView){vw=view;}else{vw=view.getView();}
st=view.ds;st.un('loadexception',this.enableLoading,this);st.un('beforeload',this.disableLoading,this);st.un('load',this.enableLoading,this);vw.un('rowremoved',this.onRowRemoved,this);vw.un('rowsinserted',this.onRowsInserted,this);vw.un('beforebuffer',this.beforeBuffer,this);vw.un('cursormove',this.onCursorMove,this);vw.un('buffer',this.onBuffer,this);vw.un('bufferfailure',this.enableLoading,this);this.view=undefined;},bind:function(view){this.view=view;var st=view.ds;st.on('loadexception',this.enableLoading,this);st.on('beforeload',this.disableLoading,this);st.on('load',this.enableLoading,this);view.on('rowremoved',this.onRowRemoved,this);view.on('rowsinserted',this.onRowsInserted,this);view.on('beforebuffer',this.beforeBuffer,this);view.on('cursormove',this.onCursorMove,this);view.on('buffer',this.onBuffer,this);view.on('bufferfailure',this.enableLoading,this);},enableLoading:function(){this.loading.setDisabled(false);},disableLoading:function(){this.loading.setDisabled(true);},onCursorMove:function(view,rowIndex,visibleRows,totalCount){this.updateInfo(rowIndex,visibleRows,totalCount);},onRowsInserted:function(view,start,end){this.updateInfo(view.rowIndex,Math.min(view.ds.totalLength,view.visibleRows-view.rowClipped),view.ds.totalLength);},onRowRemoved:function(view,index,record){this.updateInfo(view.rowIndex,Math.min(view.ds.totalLength,view.visibleRows-view.rowClipped),view.ds.totalLength);},beforeBuffer:function(view,store,rowIndex,visibleRows,totalCount,options){this.loading.disable();this.updateInfo(rowIndex,visibleRows,totalCount);},onBuffer:function(view,store,rowIndex,visibleRows,totalCount){this.loading.enable();this.updateInfo(rowIndex,visibleRows,totalCount);var plotComp=Ext.getCmp(&quot;plot&quot;+this.ownerCt.datasetId);if(plotComp){var rightPanel=plotComp.findById('plot-right-panel');var success=rightPanel.fireEvent('buffer',store,rowIndex,visibleRows,totalCount);}},onClick:function(type){switch(type){case'refresh':if(this.view.reset(true)){this.loading.disable();}else{this.loading.enable();}
break;}},onRender:function(ct,position){Ext.PagingToolbar.superclass.onRender.call(this,ct,position);this.loading=new Ext.Toolbar.Button({tooltip:this.refreshText,iconCls:&quot;x-tbar-loading&quot;,handler:this.onClick.createDelegate(this,[&quot;refresh&quot;])});this.addButton(this.loading);this.addSeparator();if(this.displayInfo){this.displayEl=Ext.fly(this.el.dom).createChild({cls:'x-paging-info'});}}});Ext.namespace('Ext.ux.grid.livegrid');Ext.ux.grid.livegrid.DragZone=function(grid,config){Ext.ux.grid.livegrid.DragZone.superclass.constructor.call(this,grid,config);this.view.ds.on('beforeselectionsload',this._onBeforeSelectionsLoad,this);this.view.ds.on('selectionsload',this._onSelectionsLoad,this);};Ext.extend(Ext.ux.grid.livegrid.DragZone,Ext.grid.GridDragZone,{isDropValid:true,onInitDrag:function(e){this.view.ds.loadSelections(this.grid.selModel.getPendingSelections(true));Ext.ux.grid.livegrid.DragZone.superclass.onInitDrag.call(this,e);},_onBeforeSelectionsLoad:function(){this.isDropValid=false;Ext.fly(this.proxy.el.dom.firstChild).addClass('ext-ux-livegrid-drop-waiting');},_onSelectionsLoad:function(){this.isDropValid=true;this.ddel.innerHTML=this.grid.getDragDropText();Ext.fly(this.proxy.el.dom.firstChild).removeClass('ext-ux-livegrid-drop-waiting');}});Ext.namespace('Ext.ux.grid.livegrid');Ext.ux.grid.livegrid.EditorGridPanel=Ext.extend(Ext.grid.EditorGridPanel,{initEvents:function(){Ext.ux.grid.livegrid.EditorGridPanel.superclass.initEvents.call(this);this.view.on(&quot;cursormove&quot;,this.stopEditing,this,[true]);},startEditing:function(row,col){this.stopEditing();if(this.colModel.isCellEditable(col,row)){this.view.ensureVisible(row,col,true);if(!this.store.getAt(row)){return;}}
return Ext.ux.grid.livegrid.EditorGridPanel.superclass.startEditing.call(this,row,col);},walkCells:function(row,col,step,fn,scope){return Ext.ux.grid.livegrid.GridPanel.prototype.walkCells.call(this,row,col,step,fn,scope);},onRender:function(ct,position){return Ext.ux.grid.livegrid.GridPanel.prototype.onRender.call(this,ct,position);},initComponent:function(){if(this.cls){this.cls+=' ext-ux-livegrid';}else{this.cls='ext-ux-livegrid';}
return Ext.ux.grid.livegrid.EditorGridPanel.superclass.initComponent.call(this);}});Ext.namespace('sitools.user.component.dataviews');sitools.user.component.dataviews.dataviewUtils={getFormParamsFromRecsSelected:function(recSelected){var rec=recSelected[0],result={};var primaryKeyName=&quot;&quot;;Ext.each(rec.fields.items,function(field){if(field.primaryKey){primaryKeyName=field.name;}});if(Ext.isEmpty(primaryKeyName)){Ext.Msg.alert(i18n.get('label.error'),i18n.get('label.noPrimaryKey'));return;}
var primaryKeyValues=[];Ext.each(recSelected,function(record){primaryKeyValues.push(encodeURIComponent(record.get(primaryKeyName)));});result[&quot;p[0]&quot;]=&quot;LISTBOXMULTIPLE|&quot;+primaryKeyName+&quot;|&quot;+primaryKeyValues.join(&quot;|&quot;);return result;},getRendererLiveGrid:function(item,dataviewConfig){var renderer;if(!Ext.isEmpty(item.columnRenderer)){renderer=function(value,metadata,record,rowIndex,colIndex,store){if(!Ext.isEmpty(value)){if(!Ext.isEmpty(item.columnRenderer.toolTip)){metadata.attr='ext:qtip=&quot;'+item.columnRenderer.toolTip+'&quot;';}
var imageStyle=&quot;max-width:&quot;+(item.width-10)+&quot;px;&quot;;if(!Ext.isEmpty(dataviewConfig)&amp;&amp;!Ext.isEmpty(dataviewConfig.lineHeight)){imageStyle+=&quot;max-height: &quot;+(dataviewConfig.lineHeight-10)+&quot;px;&quot;;}
var html=sitools.user.component.dataviews.dataviewUtils.getRendererHTML(item,imageStyle);var str;if(!Ext.isEmpty(html)){if(item.columnRenderer.behavior==ColumnRendererEnum.IMAGE_FROM_SQL){var imageUrl=record.get(item.columnRenderer.columnAlias);str=String.format(html,value,imageUrl);}else{str=String.format(html,value);}}
return str;}else{return value;}};}else{renderer=function(value){var valueFormat=value;if(sql2ext.get(item.sqlColumnType)=='dateAsString'){valueFormat=sitools.user.component.dataviews.dataviewUtils.formatDate(value,item);}
if(sql2ext.get(item.sqlColumnType)=='boolean'){valueFormat=value?i18n.get('label.true'):i18n.get('label.false');}
return valueFormat;};}
return renderer;},getRendererDataView:function(col,style,dataviewConfig){var tplString=&quot;&quot;,value,behavior,label,valueDisplayed;var columnRenderer=col.columnRenderer;if(!Ext.isEmpty(columnRenderer)){behavior=columnRenderer.behavior;var html=sitools.user.component.dataviews.dataviewUtils.getRendererHTML(col,dataviewConfig);switch(behavior){case ColumnRendererEnum.URL_LOCAL:case ColumnRendererEnum.URL_EXT_NEW_TAB:case ColumnRendererEnum.URL_EXT_DESKTOP:case ColumnRendererEnum.DATASET_ICON_LINK:if(!Ext.isEmpty(columnRenderer.linkText)){tplString+=String.format(&quot;&lt;tpl if=\&quot;this.isNotEmpty({0})\&quot;&gt;&quot;,col.columnAlias);value=String.format(html,&quot;{&quot;+col.columnAlias+&quot;}&quot;);tplString+=String.format('&lt;span class=&quot;dataview_columnValue&quot;&gt;&lt;div class=x-view-entete style=&quot;{2}&quot;&gt;{0} &lt;/div&gt; {1}&lt;/span&gt;',col.header,value,style);tplString+=&quot;&lt;/tpl&gt;&quot;;tplString+=String.format(&quot;&lt;tpl if=\&quot;this.isEmpty({0})\&quot;&gt;&quot;,col.columnAlias);value=&quot;&quot;;tplString+=String.format('&lt;span class=&quot;dataview_columnValue&quot;&gt;&lt;div class=x-view-entete style=&quot;{2}&quot;&gt;{0} &lt;/div&gt; {1}&lt;/span&gt;',col.header,value,style);tplString+=&quot;&lt;/tpl&gt;&quot;;}else if(!Ext.isEmpty(columnRenderer.image)){tplString+=String.format(&quot;&lt;tpl if=\&quot;this.isNotEmpty({0})\&quot;&gt;&quot;,col.columnAlias);tplString+=String.format('&lt;li  class=&quot;img-link&quot; ext:qtip=&quot;{0}&quot;&gt;',col.header);tplString+=String.format(html,&quot;{&quot;+col.columnAlias+&quot;}&quot;);tplString+='&lt;/li&gt;&lt;/tpl&gt;';}
break;case ColumnRendererEnum.IMAGE_THUMB_FROM_IMAGE:tplString+=String.format(&quot;&lt;tpl if=\&quot;this.isNotEmpty({0})\&quot;&gt;&quot;,col.columnAlias);tplString+=String.format('&lt;li  class=&quot;img-link&quot; ext:qtip=&quot;{0}&quot;&gt;',col.header);tplString+=String.format(html,&quot;{&quot;+col.columnAlias+&quot;}&quot;);tplString+='&lt;/li&gt;&lt;/tpl&gt;';break;case ColumnRendererEnum.IMAGE_FROM_SQL:var imageUrl=&quot;&quot;;if(!Ext.isEmpty(columnRenderer.url)){imageUrl=columnRenderer.url;}else if(!Ext.isEmpty(columnRenderer.columnAlias)){imageUrl=&quot;{&quot;+columnRenderer.columnAlias+&quot;}&quot;;}
tplString+=String.format(&quot;&lt;tpl if=\&quot;this.isNotEmpty({0})\&quot;&gt;&quot;,col.columnAlias);tplString+=String.format('&lt;li  class=&quot;img-link&quot; ext:qtip=&quot;{0}&quot;&gt;',col.header,imageUrl);tplString+=String.format(html,&quot;{&quot;+col.columnAlias+&quot;}&quot;,imageUrl);tplString+='&lt;/li&gt;&lt;/tpl&gt;';break;default:tplString+=String.format(&quot;&lt;tpl if=\&quot;this.isNotEmpty({0})\&quot;&gt;&quot;,col.columnAlias);value=String.format(html,&quot;{&quot;+col.columnAlias+&quot;}&quot;);tplString+=String.format('&lt;span class=&quot;dataview_columnValue&quot;&gt;&lt;div class=x-view-entete style=&quot;{2}&quot;&gt;{0} &lt;/div&gt; {1}&lt;/span&gt;',col.header,value,style);tplString+=&quot;&lt;/tpl&gt;&quot;;tplString+=String.format(&quot;&lt;tpl if=\&quot;this.isEmpty({0})\&quot;&gt;&quot;,col.columnAlias);value=&quot;&quot;;tplString+=String.format('&lt;span class=&quot;dataview_columnValue&quot;&gt;&lt;div class=x-view-entete style=&quot;{2}&quot;&gt;{0} &lt;/div&gt; {1}&lt;/span&gt;',col.header,value,style);tplString+=&quot;&lt;/tpl&gt;&quot;;break;}}else{if(sql2ext.get(col.sqlColumnType)=='dateAsString'){tplString+=String.format('&lt;span class=&quot;dataview_columnValue&quot;&gt;&lt;div class=x-view-entete style=&quot;{2}&quot;&gt;{0} &lt;/div&gt; &lt;tpl if=\&quot;this.isValidDate({1})\&quot;&gt;{[Date.parseDate(values.{1}, SITOOLS_DATE_FORMAT).format(&quot;{3}&quot;)]}&lt;/tpl&gt;&lt;/span&gt;',col.header,col.columnAlias,style,Ext.isEmpty(col.format)?SITOOLS_DEFAULT_IHM_DATE_FORMAT:col.format);}
else{tplString+=String.format('&lt;span class=&quot;dataview_columnValue&quot;&gt;&lt;div class=x-view-entete style=&quot;{2}&quot;&gt;{0} &lt;/div&gt; {{1}}&lt;/span&gt;',col.header,col.columnAlias,style);}}
return tplString;},getRendererHTML:function(item,imageStyle){var renderer,valueDisplayed,imageUrl;var html;if(!Ext.isEmpty(item.columnRenderer)&amp;&amp;!Ext.isEmpty(item.columnRenderer.behavior)){var columnRenderer=item.columnRenderer;switch(columnRenderer.behavior){case ColumnRendererEnum.URL_LOCAL:valueDisplayed=&quot;&quot;;if(!Ext.isEmpty(columnRenderer.linkText)){valueDisplayed=columnRenderer.linkText;}else if(!Ext.isEmpty(columnRenderer.image)){valueDisplayed=&quot;&lt;img src=\&quot;&quot;+columnRenderer.image.url+&quot;\&quot; class='sitools-display-image' style ='&quot;+imageStyle+&quot;' &gt;&lt;/img&gt;&quot;;}
html=&quot;&lt;a href='#' onClick='sitools.user.component.dataviews.dataviewUtils.downloadData(\&quot;{0}\&quot;);'&gt;&quot;+valueDisplayed+&quot;&lt;/a&gt;&quot;;break;case ColumnRendererEnum.URL_EXT_NEW_TAB:valueDisplayed=&quot;&quot;;if(!Ext.isEmpty(columnRenderer.linkText)){valueDisplayed=columnRenderer.linkText;}else if(!Ext.isEmpty(columnRenderer.image)){valueDisplayed=&quot;&lt;img  src=\&quot;&quot;+columnRenderer.image.url+&quot;\&quot; class='sitools-display-image' style ='&quot;+imageStyle+&quot;' &gt;&lt;/img&gt;&quot;;}
html=&quot;&lt;a href='#' onClick='window.open(\&quot;{0}\&quot;);'&gt;&quot;+valueDisplayed+&quot;&lt;/a&gt;&quot;;break;case ColumnRendererEnum.URL_EXT_DESKTOP:valueDisplayed=&quot;&quot;;if(!Ext.isEmpty(columnRenderer.linkText)){valueDisplayed=columnRenderer.linkText;}else if(!Ext.isEmpty(columnRenderer.image)){valueDisplayed=&quot;&lt;img src=\&quot;&quot;+columnRenderer.image.url+&quot;\&quot; class='sitools-display-image' style ='&quot;+imageStyle+&quot;' &gt;&lt;/img&gt;&quot;;}
html=&quot;&lt;a href='#' onClick='sitools.user.component.dataviews.dataviewUtils.showDisplayableUrl(\&quot;{0}\&quot;, &quot;+columnRenderer.displayable+&quot;);'&gt;&quot;+valueDisplayed+&quot;&lt;/a&gt;&quot;;break;case ColumnRendererEnum.IMAGE_NO_THUMB:html=&quot;&lt;a href='#' onClick='sitools.user.component.dataviews.dataviewUtils.showPreview(\&quot;{0}\&quot;,\&quot;&quot;+columnRenderer.linkText+&quot;\&quot;);'&gt;&quot;+columnRenderer.linkText+&quot;&lt;/a&gt;&quot;;break;case ColumnRendererEnum.IMAGE_THUMB_FROM_IMAGE:html=&quot;&lt;a href='#' onClick='sitools.user.component.dataviews.dataviewUtils.showPreview(\&quot;{0}\&quot;,\&quot;&quot;+item.header+&quot;\&quot;);'&gt;&lt;img class='sitools-display-image' src='{0}' style ='&quot;+imageStyle+&quot;'&gt;&lt;/img&gt;&lt;/a&gt;&quot;;break;case ColumnRendererEnum.IMAGE_FROM_SQL:html=&quot;&lt;div style='text-align:center;'&gt;&lt;a href='#' onClick='sitools.user.component.dataviews.dataviewUtils.showPreview(\&quot;{0}\&quot;,\&quot;&quot;+item.header+&quot;\&quot;);'&gt;&lt;img class='sitools-display-image' src='{1}' style ='&quot;+imageStyle+&quot;'&gt;&lt;/a&gt;&lt;/div&gt;&quot;;break;case ColumnRendererEnum.DATASET_LINK:html=&quot;&lt;a href='#' onClick='sitools.user.component.dataviews.dataviewUtils.showDetailsData(\&quot;{0}\&quot;,&quot;+&quot;\&quot;&quot;+columnRenderer.columnAlias+&quot;\&quot;, \&quot;&quot;
+columnRenderer.datasetLinkUrl+&quot;\&quot;);'&gt;{0}&lt;/a&gt;&quot;;break;case ColumnRendererEnum.DATASET_ICON_LINK:if(!Ext.isEmpty(columnRenderer.image)){imageUrl=columnRenderer.image.url;}
html=&quot;&lt;a href='#' onClick='sitools.user.component.dataviews.dataviewUtils.showDetailsData(\&quot;{0}\&quot;, \&quot;&quot;+columnRenderer.columnAlias+&quot;\&quot;, \&quot;&quot;
+columnRenderer.datasetLinkUrl+&quot;\&quot;);'&gt;&lt;img style ='&quot;+imageStyle+&quot;' class='sitools-display-image' src='&quot;+imageUrl+&quot;'&gt;&lt;/a&gt;&quot;;break;default:html=&quot;{0}&quot;;break;}}
return html;},getRendererViewDataDetails:function(item){},formatDate:function(value,item){var valueFormat;var result=Date.parseDate(value,SITOOLS_DATE_FORMAT,true);if(Ext.isEmpty(result)){valueFormat=&quot;&quot;;}
else{if(Ext.isEmpty(item.format)){valueFormat=result.format(SITOOLS_DEFAULT_IHM_DATE_FORMAT);}
else{try{valueFormat=result.format(item.format);}
catch(err){valueFormat=&quot;unable to format Date&quot;;}}}
return valueFormat;},downloadData:function(value){Ext.Ajax.request({url:value,method:'HEAD',scope:this,success:function(ret){try{var headerFile=ret.getResponseHeader(&quot;Content-Type&quot;).split(&quot;;&quot;)[0].split(&quot;/&quot;)[0];if(headerFile==&quot;text&quot;){Ext.Ajax.request({url:value,method:'GET',scope:this,success:function(ret){var windowConfig={id:&quot;winPreferenceDetailId&quot;,title:value,iconCls:&quot;version&quot;};var jsObj=Ext.Panel;var componentCfg={layout:'fit',autoScroll:true,html:ret.responseText};SitoolsDesk.addDesktopWindow(windowConfig,componentCfg,jsObj);}});}else if(headerFile==&quot;image&quot;){sitools.user.component.dataviews.dataviewUtils.showPreview(value,item.header);}else{sitools.user.component.dataviews.dataviewUtils.downloadFile(value);}}catch(err){Ext.Msg.alert(i18n.get('label.error'),err);}},failure:function(ret){return null;}});},showDisplayableUrl:function(value,isDisplayable,customConfig){if(isDisplayable){if(customConfig){var windowConfig=customConfig;}
else{var windowConfig={title:value,id:value,iconCls:&quot;version&quot;};}
var jsObj=Ext.ux.ManagedIFrame.Panel;var componentCfg={defaults:{padding:10},layout:'fit',region:'center',defaultSrc:value};SitoolsDesk.addDesktopWindow(windowConfig,componentCfg,jsObj);}else{sitools.user.component.dataviews.dataviewUtils.downloadFile(value);}},downloadFile:function(url){if(Ext.getCmp(&quot;mifToDownload&quot;)){Ext.getCmp(&quot;mifToDownload&quot;).destroy();}
var mifToDownload=new Ext.ux.ManagedIFrame.Panel({layout:'fit',id:&quot;mifToDownload&quot;,region:'center',defaultSrc:url,renderTo:Ext.getBody(),cls:'x-hidden'});},showDetailsData:function(value,columnAlias,datasetUrl){var desktop=getDesktop();Ext.Ajax.request({scope:this,method:'GET',url:datasetUrl,success:function(response,opts){try{var json=Ext.decode(response.responseText);if(!json.success){Ext.Msg.alert(i18n.get('label.error'),json.message);return;}
var formParams=[&quot;RADIO|&quot;+columnAlias+&quot;|&quot;+value];var dataset=json.dataset;var jsObj=eval(dataset.datasetView.jsObject);var componentCfg={dataUrl:dataset.sitoolsAttachementForUsers,datasetId:dataset.id,datasetCm:dataset.columnModel,formParams:formParams,datasetName:dataset.name,dictionaryMappings:dataset.dictionaryMappings,datasetViewConfig:dataset.datasetViewConfig,preferencesPath:&quot;/&quot;+dataset.name,preferencesFileName:&quot;datasetView&quot;};var windowConfig={id:&quot;wind&quot;+dataset.id+columnAlias+value,title:i18n.get('label.dataTitle')+&quot; : &quot;+dataset.name,datasetName:dataset.name,type:&quot;data&quot;,saveToolbar:true,iconCls:&quot;dataDetail&quot;};SitoolsDesk.addDesktopWindow(windowConfig,componentCfg,jsObj);}catch(err){}}});},showPreview:function(value,title){var previewWin=new sitools.widget.WindowImageViewer({title:title,src:value,hideAction:'close',resizeImage:false});previewWin.show();previewWin.toFront();},isNoClientAccess:function(column){return!Ext.isEmpty(column.columnRenderer)&amp;&amp;ColumnRendererEnum.NO_CLIENT_ACCESS==column.columnRenderer.behavior;},getFilters:function(listeColonnes,activeFilters){var filters=[];var i=0;if(!Ext.isEmpty(listeColonnes)){Ext.each(listeColonnes,function(item,index,totalItems){if(item.filter){var boolActiveFilter=false,activeFilterValue=&quot;&quot;,activeComparison=&quot;&quot;;Ext.each(activeFilters,function(activeFilter){if(item.columnAlias==activeFilter.columnAlias){boolActiveFilter=true;if(activeFilter.data.type=='numeric'){if(!Ext.isObject(activeFilterValue)){activeFilterValue={};}
activeFilterValue[activeFilter.data.comparison]=activeFilter.data.value;}else if(activeFilter.data.type=='date'){var date=new Date();var tmp=activeFilter.data.value.split('-');date.setFullYear(tmp[0],tmp[1]-1,tmp[2]);if(!Ext.isObject(activeFilterValue)){activeFilterValue={};}
if(activeFilter.data.comparison=='eq'){activeFilterValue.on=date;}
if(activeFilter.data.comparison=='gt'){activeFilterValue.after=date;}
if(activeFilter.data.comparison=='lt'){activeFilterValue.before=date;}}else{activeFilterValue=activeFilter.data.value;}}});var filter={type:sql2ext.get(item.sqlColumnType),active:boolActiveFilter,dataIndex:item.columnAlias,columnAlias:item.columnAlias,value:activeFilterValue};filters.push(filter);}
i++;},this);}
return filters;}};Ext.namespace('sitools.user.component.dataviews');sitools.user.component.dataviews.storeUtils={getFields:function(listeColonnes){var fields=[];var i=0;if(!Ext.isEmpty(listeColonnes)){Ext.each(listeColonnes,function(item,index,totalItems){fields[i]=new Ext.data.Field({name:item.columnAlias,primaryKey:item.primaryKey,type:sql2ext.get(item.sqlColumnType)});if(sql2ext.get(item.sqlColumnType)==='boolean'){Ext.apply(fields[i],{convert:function(value,record){if(value==&quot;f&quot;||value==&quot;false&quot;||value===0){return 0;}
if(value==&quot;t&quot;||value==&quot;true&quot;||value==1){return 1;}
return value;}});}
i++;},this);}
return fields;},getPrimaryKey:function(listeColonnes){var i=0,primaryKey=&quot;&quot;;if(!Ext.isEmpty(listeColonnes)){Ext.each(listeColonnes,function(item,index,totalItems){if(!Ext.isEmpty(item.primaryKey)){if(item.primaryKey){primaryKey=item.columnAlias;}}},this);}
return primaryKey;},getFormParams:function(){return this.formParams;},paramValueToApi:function(paramValue){var stringParam=paramValue.type+&quot;|&quot;+paramValue.code+&quot;|&quot;+paramValue.value;if(!Ext.isEmpty(paramValue.userDimension)&amp;&amp;!Ext.isEmpty(paramValue.userUnit)){stringParam+=&quot;|&quot;+paramValue.userDimension+&quot;|&quot;+paramValue.userUnit.unitName;}
return stringParam;}};Ext.namespace('sitools.user.component.dataviews.livegrid');Ext.override(Ext.ux.grid.livegrid.Store,{multiSort:function(sorters,direction){this.hasMultiSort=true;direction=direction||&quot;ASC&quot;;if(this.multiSortInfo&amp;&amp;direction==this.multiSortInfo.direction){direction=direction.toggle(&quot;ASC&quot;,&quot;DESC&quot;);}
this.multiSortInfo={sorters:sorters,direction:direction};if(this.remoteSort){this.load(this.lastOptions);}else{this.applySort();this.fireEvent('datachanged',this);}},getSortState:function(){return this.hasMultiSort?this.multiSortInfo:this.sortInfo;},load:function(options){options=Ext.apply({},options);this.storeOptions(options);if((this.sortInfo||this.multiSortInfo)&amp;&amp;this.remoteSort){var pn=this.paramNames;options.params=Ext.apply({},options.params);this.isInSort=true;var root=pn.sort;if(this.hasMultiSort){options.params[pn.sort]=Ext.encode({&quot;ordersList&quot;:this.multiSortInfo.sorters});}else{options.params[pn.sort]=Ext.encode({&quot;ordersList&quot;:[this.sortInfo]});}}
try{return this.execute('read',null,options);}catch(e){this.handleException(e);return false;}}});sitools.user.component.dataviews.livegrid.StoreLiveGrid=function(config){this.storeUtils=sitools.user.component.dataviews.storeUtils;if(Ext.isEmpty(config)){return false;}
var colModel;if(!Ext.isEmpty(config.userPreference)&amp;&amp;config.userPreference.datasetView==&quot;Ext.ux.livegrid&quot;&amp;&amp;!Ext.isEmpty(config.userPreference.colModel)){colModel=Ext.applyIf(config.userPreference.colModel,config.datasetCm);}
else{colModel=config.datasetCm;}
var cm=getColumnModel(colModel);var map=this.storeUtils.getFields(config.datasetCm);var primaryKey=this.storeUtils.getPrimaryKey(config.datasetCm);var bufferedReaderSimple=new Ext.ux.grid.livegrid.JsonReader({idProperty:primaryKey,root:'data',versionProperty:'version',totalProperty:'total'},map);var params;if(this.userPreference){colModel=extColModelToSrv(cm);params={colModel:Ext.util.JSON.encode(colModel)};}else{params={};}
var i=0;this.formParams={};if(!Ext.isEmpty(config.formParams)){Ext.each(config.formParams,function(param){this.formParams[&quot;p[&quot;+i+&quot;]&quot;]=param;i+=1;},this);Ext.apply(params,this.formParams);}
i=0;if(!Ext.isEmpty(config.formMultiDsParams)){Ext.each(config.formMultiDsParams,function(param){this.formParams[&quot;c[&quot;+i+&quot;]&quot;]=param;i+=1;},this);Ext.apply(params,this.formParams);}
Ext.apply(config,{autoLoad:true,bufferSize:DEFAULT_LIVEGRID_BUFFER_SIZE,restful:true,reader:bufferedReaderSimple,storeUtils:sitools.user.component.dataviews.storeUtils,url:config.urlRecords,dataUrl:config.sitoolsAttachementForUsers,baseParams:params,listeners:{scope:this,exception:function(dp,type,action,options,response,arg){this.removeAll();Ext.Msg.show({title:i18n.get('label.error'),msg:response.responseText,buttons:Ext.Msg.OK,width:400});this.fireEvent(&quot;load&quot;,this,[]);}}});sitools.user.component.dataviews.livegrid.StoreLiveGrid.superclass.constructor.call(this,config);};Ext.extend(sitools.user.component.dataviews.livegrid.StoreLiveGrid,Ext.ux.grid.livegrid.Store,{getFormParams:function(){return this.storeUtils.getFormParams();}});Ext.namespace('sitools.user.component.dataviews');sitools.user.component.dataviews.ctxMenu=Ext.extend(Ext.menu.Menu,{dataUrl:null,grid:null,datasetName:null,datasetId:null,origin:null,event:null,urlDetail:null,constructor:function(config){this.dataUrl=config.dataUrl;this.grid=config.grid;this.datasetId=config.datasetId;this.datasetName=config.datasetName;this.origin=config.origin;this.event=config.event;this.urlDetail=config.urlDetail;this.config=config;if(this.origin==&quot;sitools.user.modules.projectServices&quot;){this.selections=this.grid.getSelectionModel().getSelected();}
sitools.user.component.dataviews.ctxMenu.superclass.constructor.call(this,config);if(!this.resourceStore){this.resourceStore=new Ext.data.JsonStore({root:&quot;data&quot;,fields:[{name:&quot;parameters&quot;},{name:&quot;name&quot;,type:&quot;string&quot;},{name:&quot;description&quot;,type:&quot;string&quot;},{name:&quot;dataSetSelection&quot;,type:&quot;string&quot;},{name:&quot;behavior&quot;,type:&quot;string&quot;}],url:this.dataUrl+&quot;/services&quot;,listeners:{load:function(store,records,options){Ext.each(records,function(rec){if(rec.get(&quot;dataSetSelection&quot;)===&quot;NONE&quot;){store.remove(rec);}},this);}}});}
this.resourceStore.on('beforeload',this.onBeforeLoad,this);this.resourceStore.on('load',this.onLoad,this);this.on('show',this.onMenuLoad,this);},onMenuLoad:function(){this.resourceStore.load();},onBeforeLoad:function(){this.resourceStore.baseParams=this.baseParams;this.updateMenuItems(false);},onLoad:function(store,records){this.updateMenuItems(true,records);},updateMenuItems:function(loadedState,records){this.selections=this.grid.getSelections();this.removeAll();this.el.sync();this.menuResources=new Ext.menu.Menu();this.resourcePresent=false;if(loadedState){this.resourceStore.each(function(resRec){var resource=resRec.data;this.resourcePresent=true;var parameters=resource.parameters;var url,runTypeUserInput,icon,methods;parameters.each(function(param){switch(param.name){case&quot;methods&quot;:methods=param.value;break;case&quot;runTypeUserInput&quot;:runTypeUserInput=param.value;break;case&quot;url&quot;:url=this.dataUrl+param.value;break;case&quot;image&quot;:icon=param.value;break;}},this);this.menuResources.add({text:resource.name,cls:'x-btn-text-icon',icon:icon,listeners:{scope:this,click:function(){this.resourceClick(resource,url,methods,runTypeUserInput,parameters);}}});},this);}else{this.menuResources.add('&lt;span class=&quot;loading-indicator&quot;&gt;'+this.loadingText+'&lt;/span&gt;');}
this.add({text:i18n.get('label.addSelection'),listeners:{scope:this,click:function(button,e){e.stopEvent();this.orderAction=&quot;add&quot;;this._onOrder();}},icon:loadUrl.get('APP_URL')+&quot;/common/res/images/icons/add_selection.png&quot;});this.add({text:i18n.get('label.export.all.CSV'),listeners:{scope:this,click:function(){this._onExportCsv();}},icon:loadUrl.get('APP_URL')+&quot;/common/res/images/icons/csv.png&quot;});if(this.origin===&quot;Ext.ux.livegrid&quot;||this.origin===&quot;sitools.user.component.dataviews.tplView.TplView&quot;){this.add({text:i18n.get('label.downloadFile'),listeners:{scope:this,click:function(){this.orderAction=&quot;download&quot;;this._onOrder();}},icon:loadUrl.get('APP_URL')+&quot;/common/res/images/icons/add_request.png&quot;});}
this.add({text:i18n.get('label.details'),listeners:{scope:this,click:function(menuItem,e){e.stopEvent();e.stopPropagation();this._onDetails();}},icon:loadUrl.get('APP_URL')+&quot;/common/res/images/icons/toolbar_details.png&quot;});if(this.resourcePresent){this.add({text:i18n.get('label.resources'),menu:this.menuResources,icon:loadUrl.get('APP_URL')+&quot;/common/res/images/icons/tree_datasets_resource.png&quot;});}},_onOrder:function(){if(this.orderAction===&quot;add&quot;&amp;&amp;Ext.isEmpty(this.selections)){Ext.Msg.alert(i18n.get('label.warning'),i18n.get('warning.noselection'));return;}
if(this.origin===&quot;Ext.ux.livegrid&quot;){if(this.grid.selModel.getPendingSelections().length&gt;0){Ext.Msg.alert(i18n.get('label.warning'),i18n.get(&quot;livegrid.selection.invalide.txt&quot;));return;}}
var title=&quot;&quot;;if(this.orderAction===&quot;add&quot;){title=i18n.get('label.addSelection');}else{title=i18n.get('label.addRequest');}
var winProperty=new Ext.Window({title:title,width:300,modal:true,items:[{xtype:'form',labelWidth:75,items:[{xtype:'textfield',fieldLabel:i18n.get('label.name'),name:'orderName',anchor:'100%'}],buttons:[{text:i18n.get('label.ok'),scope:this,handler:function(){var orderName=winProperty.findByType('form')[0].getForm().getFieldValues().orderName;if(this.orderAction===&quot;add&quot;){this._addSelection(this.selections,this.grid,this.datasetId,orderName);}else{this._onDownload(this.datasetId,this.grid,orderName);}
winProperty.close();}},{text:i18n.get('label.cancel'),handler:function(){winProperty.close();}}]}]});winProperty.show();},_addSelection:function(selections,grid,datasetId,orderName){var primaryKey=&quot;&quot;;var rec=selections[0];Ext.each(rec.fields.items,function(field){if(field.primaryKey){primaryKey=field.name;}},rec);if(Ext.isEmpty(primaryKey)||Ext.isEmpty(rec.get(primaryKey))){Ext.Msg.alert(i18n.get('label.warning'),i18n.get('warning.noPrimaryKey'));return;}
var putObject={};putObject.orderRecord={};putObject.orderRecord.records=[];var colModel=extColModelToStorage(grid.getColumnModel());Ext.each(selections,function(rec){var data={};Ext.each(colModel,function(column){if(!column.hidden||column.primaryKey){data[column.columnAlias]=rec.get(column.columnAlias);}});putObject.orderRecord.records.push(data);});putObject.orderRecord.colModel=colModel;putObject.orderRecord.datasetId=datasetId;putObject.orderRecord.projectId=projectId;putObject.orderRecord.dataUrl=this.dataUrl;putObject.orderRecord.datasetName=this.datasetName;userStorage.set(orderName+&quot;.json&quot;,&quot;/&quot;+DEFAULT_ORDER_FOLDER+&quot;/records&quot;,putObject);},_onExportCsv:function(){var csvUrl=this.selections;var pathUrl=window.location.protocol+&quot;//&quot;+window.location.host+this.dataUrl+&quot;/records&quot;;var request=&quot;&quot;;try{request=this.grid.getRequestParam();}
catch(err){Ext.Msg.alert(i18n.get('label.error'),String.format(i18n.get('label.notImplementedService'),err));return false;}
pathUrl+=&quot;?media=csv&quot;+request+&quot;&amp;limit=&quot;+this.grid.store.totalLength;window.open(pathUrl);},_onDownload:function(datasetId,grid,orderName){var putObject={};putObject.orderRequest={};putObject.orderRequest.datasetId=datasetId;putObject.orderRequest.datasetUrl=grid.dataUrl;var filters=grid.getFilters();if(!Ext.isEmpty(filters)){putObject.orderRequest.filters=filters.getFilterData(filters);}
var storeSort=grid.getStore().getSortState();if(!Ext.isEmpty(storeSort)){putObject.orderRequest.sort=storeSort;}
var filtersCfg=grid.getStore().filtersCfg;if(!Ext.isEmpty(filtersCfg)){putObject.orderRequest.filtersCfg=filtersCfg;}
var colModel=Ext.util.JSON.encode(extColModelToStorage(grid.getColumnModel()));putObject.orderRequest.colModel=colModel;putObject.orderRequest.datasetId=datasetId;putObject.orderRequest.projectId=projectId;putObject.orderRequest.formParams=grid.getStore().getFormParams();userStorage.set(orderName+&quot;.json&quot;,&quot;/&quot;+DEFAULT_ORDER_FOLDER+&quot;/request&quot;,putObject);},_onDetails:function(){var rec=this.grid.getSelections()[0];if(Ext.isEmpty(rec)){Ext.Msg.alert(i18n.get('label.warning'),i18n.get('warning.noselection'));return;}
var componentCfg={baseUrl:this.urlDetail+&quot;/records/&quot;,grid:this.grid,fromWhere:this.origin,datasetId:this.datasetId,selections:this.grid.getSelections(),datasetName:this.datasetName,datasetUrl:this.urlDetail,preferencesPath:&quot;/&quot;+this.datasetName,preferencesFileName:&quot;dataDetails&quot;};var jsObj=sitools.user.component.viewDataDetail;var windowConfig={id:&quot;dataDetail&quot;+this.datasetId,title:i18n.get('label.viewDataDetail')+&quot; : &quot;+this.datasetName,iconCls:&quot;dataDetail&quot;,datasetName:this.datasetName,saveToolbar:true,type:&quot;dataDetail&quot;,toolbarItems:[{iconCls:'arrow-back',handler:function(){this.ownerCt.ownerCt.items.items[0].goPrevious();}},{iconCls:'arrow-next',handler:function(){this.ownerCt.ownerCt.items.items[0].goNext();}}]};SitoolsDesk.addDesktopWindow(windowConfig,componentCfg,jsObj,true);},getNbRowsSelected:function(){if(this.grid.getNbRowsSelected()){return this.grid.getNbRowsSelected();}
else{return null;}},getNbGridRecords:function(){return this.grid.getStore().totalLength;},setGrid:function(cmp){this.grid=cmp;},setSelections:function(selections){this.selections=selections;},resourceClick:function(resource,url,methods,runType,parameters){this.checkResourceParameters(resource,url,methods,runType,parameters);},handleResourceClick:function(resource,url,methods,runType,parameters){var showParameterBox=false;var params=[];Ext.each(parameters,function(parameter){if(parameter.type===&quot;PARAMETER_USER_INPUT&quot;&amp;&amp;parameter.userUpdatable){showParameterBox=true;}
params[parameter.name]=parameter.value;});if(methods.split(&quot;|&quot;)&amp;&amp;methods.split(&quot;|&quot;).length&gt;1){showParameterBox=true;}
var resourceWindow;if(showParameterBox&amp;&amp;this.origin!==&quot;sitools.user.modules.projectServices&quot;){var windowConfig={title:i18n.get(&quot;label.resourceReqParam&quot;),iconCls:&quot;datasetRessource&quot;};var jsObj=sitools.user.component.dataviews.resourcePluginParamsPanel;var componentCfg={resource:resource,url:url,methods:methods,runType:runType,parameters:parameters,contextMenu:this,withSelection:(this.getNbRowsSelected()!==0)};SitoolsDesk.addDesktopWindow(windowConfig,componentCfg,jsObj);}
else if(showParameterBox){var windowConfig={title:i18n.get(&quot;label.resourceReqParam&quot;),iconCls:&quot;datasetRessource&quot;};var jsObj=sitools.user.component.dataviews.resourcePluginParamsPanel;var componentCfg={resource:resource,url:url,methods:methods,runType:runType,parameters:parameters,contextMenu:this,withSelection:false};SitoolsDesk.addDesktopWindow(windowConfig,componentCfg,jsObj);}
else{this.onResourceCallClick(resource,url,methods,runType,null,params);}},onResourceCallClick:function(resource,url,method,userSyncChoice,limit,userParameters){if((method===&quot;POST&quot;||method===&quot;PUT&quot;||method===&quot;DELETE&quot;)&amp;&amp;userSyncChoice===&quot;TASK_RUN_SYNC&quot;){Ext.Msg.alert(i18n.get('label.error'),String.format(i18n.get(&quot;error.invalidMethodOrSyncRessourceCall&quot;),method,userSyncChoice));return;}
var request=&quot;&quot;;if(this.origin!==&quot;sitools.user.modules.projectServices&quot;){try{request=this.grid.getRequestParam();}
catch(err){Ext.Msg.alert(i18n.get('label.error'),String.format(i18n.get('label.notImplementedService'),err));return false;}}
url+=&quot;?1=1&quot;+request;if(!Ext.isEmpty(limit)){url+=&quot;&amp;limit=&quot;+limit;}
if(!Ext.isEmpty(userParameters)){Ext.iterate(userParameters,function(key,value){url+=&quot;&amp;&quot;+key+&quot;=&quot;+value;});}
if(method===&quot;GET&quot;){switch(resource.behavior){case&quot;DISPLAY_IN_NEW_TAB&quot;:window.open(url);Ext.getBody().unmask();break;case&quot;DISPLAY_IN_DESKTOP&quot;:var windowConfig={title:i18n.get('downloadedResource'),iconCls:&quot;datasetRessource&quot;};var jsObj=Ext.ux.ManagedIFrame.Panel;var componentCfg={layout:'fit',defaultSrc:url,autoScroll:true};Ext.Ajax.request({method:&quot;HEAD&quot;,url:url,success:function(ret){var headerFile=&quot;&quot;;try{headerFile=ret.getResponseHeader(&quot;Content-Type&quot;).split(&quot;;&quot;)[0].split(&quot;/&quot;)[0];}
catch(err){headerFile=&quot;&quot;;}
var contentDisp=ret.getResponseHeader(&quot;Content-Disposition&quot;);if(headerFile===&quot;text&quot;&amp;&amp;Ext.isEmpty(contentDisp)){SitoolsDesk.addDesktopWindow(windowConfig,componentCfg,jsObj);}
else{var iFrame=Ext.getCmp(&quot;tempMifDownload&quot;);if(Ext.isEmpty(iFrame)){iFrame=new Ext.ux.ManagedIFrame.Panel({layout:'fit',defaultSrc:url,autoScroll:true,renderTo:Ext.getBody(),id:&quot;tempMifDownload&quot;});}
else{iFrame.setSrc(url);}}},failure:alertFailure});break;case&quot;DOWNLOAD&quot;:var iFrame=Ext.getCmp(&quot;tempMifDownload&quot;);if(Ext.isEmpty(iFrame)){iFrame=new Ext.ux.ManagedIFrame.Panel({layout:'fit',defaultSrc:url,autoScroll:true,renderTo:Ext.getBody(),id:&quot;tempMifDownload&quot;});}
else{iFrame.setSrc(url);}
break;}
return;}else{this._executeRequestForResource(url,method);}},_executeRequestForResource:function(url,method,postObject){var config={method:method,url:url,scope:this,success:function(response,opts){var json=Ext.decode(response.responseText);if(!json.success){Ext.Msg.show({title:i18n.get('label.error'),msg:json.message,width:300,buttons:Ext.MessageBox.OK});return;}
var task=json.TaskModel;if(!Ext.isEmpty(task.urlResult)){window.open(task.urlResult);}else{var componentCfg={task:task};var jsObj=sitools.user.component.dataviews.goToTaskPanel;var windowConfig={title:i18n.get('label.info'),saveToolbar:false,iconCls:&quot;datasetRessource&quot;};SitoolsDesk.addDesktopWindow(windowConfig,componentCfg,jsObj,true);}},failure:function(response,opts){Ext.Msg.show({title:i18n.get('label.error'),msg:response.responseText,width:300,buttons:Ext.MessageBox.OK});},callback:function(){if(Ext.getBody().isMasked()){Ext.getBody().unmask();}}};if(!Ext.isEmpty(postObject)){Ext.apply(config,postObject);}
Ext.Ajax.request(config);},checkResourceParameters:function(resource,url,methods,runType,parameters){var ok=true;var maxThreshold=this.getParameterFromName(parameters,&quot;too_many_selected_threshold&quot;);var nbRows;if(!Ext.isEmpty(maxThreshold)){var maxThresholdTextParam,maxTresholdText;nbRows=(Ext.isEmpty(this.getNbRowsSelected())||this.getNbRowsSelected()===0)?this.getNbGridRecords():this.getNbRowsSelected();if(!Ext.isEmpty(maxThreshold.value)&amp;&amp;parseInt(maxThreshold.value)!==-1&amp;&amp;nbRows&gt;parseInt(maxThreshold.value)){maxThresholdTextParam=this.getParameterFromName(parameters,&quot;too_many_selected_threshold_text&quot;);maxTresholdText=i18n.get(&quot;label.defaultMaxThresholdText&quot;);if(!Ext.isEmpty(maxThresholdTextParam)){maxTresholdText=maxThresholdTextParam.value;}
Ext.Msg.alert(i18n.get(&quot;label.error&quot;),maxTresholdText);return;}}
var warningThreshold=this.getParameterFromName(parameters,&quot;max_warning_threshold&quot;);if(!Ext.isEmpty(warningThreshold)){nbRows=(Ext.isEmpty(this.getNbRowsSelected())||this.getNbRowsSelected()===0)?this.getNbGridRecords():this.getNbRowsSelected();if(!Ext.isEmpty(warningThreshold.value)&amp;&amp;parseInt(warningThreshold.value)!==-1&amp;&amp;nbRows&gt;parseInt(warningThreshold.value)){var warningThresholdTextParam=this.getParameterFromName(parameters,&quot;max_warning_threshold_text&quot;);var warningTresholdText=i18n.get(&quot;label.defaultWarningThresholdText&quot;);if(!Ext.isEmpty(warningThresholdTextParam)){warningTresholdText=warningThresholdTextParam.value;}
Ext.Msg.show({title:i18n.get('label.warning'),buttons:Ext.Msg.YESNO,msg:warningTresholdText,scope:this,fn:function(btn,text){if(btn==='yes'){this.handleResourceClick(resource,url,methods,runType,parameters);}}});return;}}
this.handleResourceClick(resource,url,methods,runType,parameters);},getParameterFromName:function(parameters,name){var paramOut=null;for(var index=0;index&lt;parameters.length&amp;&amp;paramOut===null;index++){if(parameters[index].name===name){paramOut=parameters[index];}}
return paramOut;}});Ext.namespace('sitools.user.component.dataviews.cartoView');sitools.user.component.dataviews.cartoView.featureSelectionModel=function(config){sitools.user.component.dataviews.cartoView.featureSelectionModel.superclass.constructor.call(this,config);this.addEvents('gridFeatureSelected');};Ext.extend(sitools.user.component.dataviews.cartoView.featureSelectionModel,GeoExt.grid.FeatureSelectionModel,{handleMouseDown:function(g,rowIndex,e){sitools.user.component.dataviews.cartoView.featureSelectionModel.superclass.handleMouseDown.call(this,g,rowIndex,e);this.fireEvent(&quot;gridFeatureSelected&quot;,g,rowIndex,e);}});Ext.ns(&quot;sitools.user.component.dataviews.cartoView&quot;);sitools.user.component.dataviews.cartoView.mapPanel=function(config){this.map=new OpenLayers.Map();var layer;var dataviewConfig=sitoolsUtils.arrayProperties2Object(config.datasetViewConfig);var layersDef=Ext.decode(dataviewConfig.layers),mapLayers=[],baseLayer;var colModel=config.datasetCm;var cm=getColumnModel(colModel,config.dictionaryMappings,dataviewConfig);Ext.each(layersDef,function(layerDef){layer=new OpenLayers.Layer.WMS(layerDef.layerName,layerDef.url,{layers:layerDef.layerName,format:&quot;image/png&quot;},{isBaseLayer:layerDef.baseLayer?true:false,opacity:layerDef.baseLayer?1:0.5});this.map.addLayer(layer);},this);this.featureLayer=new OpenLayers.Layer.Vector(config.datasetName);var selectCtrl=new OpenLayers.Control.SelectFeature(this.featureLayer,{id:&quot;selectCtrl&quot;,onSelect:function(feature){console.log(feature);}});this.map.addControl(new OpenLayers.Control.LayerSwitcher());this.map.addControl(new OpenLayers.Control.MousePosition());this.featureLayer.events.on({featureselected:function(e){var feature=e.feature;var selectCtrl=this.map.getControlsByClass(&quot;OpenLayers.Control.SelectFeature&quot;);if(!Ext.isEmpty(selectCtrl)){selectCtrl=selectCtrl[0];}},scope:this});this.map.addLayers([this.featureLayer]);sitools.user.component.dataviews.cartoView.mapPanel.superclass.constructor.call(Ext.apply(this,{title:&quot;Map&quot;,region:&quot;center&quot;,map:this.map,center:new OpenLayers.LonLat(5,45),zoom:6}));};Ext.extend(sitools.user.component.dataviews.cartoView.mapPanel,GeoExt.MapPanel,{getFeaturesLayer:function(){return this.featureLayer;},getMap:function(){return this.map;}});Ext.namespace('sitools.user.component.dataviews.tplView');sitools.user.component.dataviews.tplView.dataViewPagingToolbar=Ext.extend(Ext.PagingToolbar,{doLoad:function(start){var lastOptions=this.store.lastOptions||{};var o=lastOptions.params,pn=this.getParams();o[pn.start]=start;o[pn.limit]=this.pageSize;if(this.fireEvent('beforechange',this,o)!==false){this.store.load({params:o});}
var plotComp=Ext.getCmp(&quot;plot&quot;+this.ownerCt.datasetId);if(plotComp){var rightPanel=plotComp.findById('plot-right-panel');var success=rightPanel.fireEvent('buffer',this.store);}}});Ext.namespace('sitools.user.component.dataviews.tplView');sitools.user.component.dataviews.tplView.StoreTplView=Ext.extend(sitools.user.component.dataviews.livegrid.StoreLiveGrid,{paramPrefix:&quot;filter&quot;,getAt:function(index){return this.data.itemAt(index);},buildQuery:function(filters){if(Ext.isEmpty(filters)){return;}
var p={},i,f,root,dataPrefix,key,tmp,len=filters.length;for(i=0;i&lt;len;i++){f=filters[i];root=[this.paramPrefix,'[',i,']'].join('');p[root+'[columnAlias]']=f.columnAlias;dataPrefix=root+'[data]';for(key in f.data){p[[dataPrefix,'[',key,']'].join('')]=f.data[key];}}
return p;}});Ext.namespace('sitools.user.component.dataviews.cartoView');sitools.user.component.dataviews.cartoView.featureStore=function(config){this.storeUtils=sitools.user.component.dataviews.storeUtils;if(Ext.isEmpty(config)){return false;}
var params;if(this.userPreference){colModel=extColModelToSrv(config.datasetCm);params={colModel:Ext.util.JSON.encode(colModel)};}else{params={};}
var i=0;this.formParams={};if(!Ext.isEmpty(config.formParams)){Ext.each(config.formParams,function(param){this.formParams[&quot;p[&quot;+i+&quot;]&quot;]=param;i+=1;},this);Ext.apply(params,this.formParams);}
i=0;if(!Ext.isEmpty(config.formMultiDsParams)){Ext.each(config.formMultiDsParams,function(param){this.formParams[&quot;c[&quot;+i+&quot;]&quot;]=param;i+=1;},this);Ext.apply(params,this.formParams);}
var reader=config.reader||new sitools.user.data.featureReader({totalProperty:&quot;totalResults&quot;},config.fields);Ext.apply(config,{bufferSize:DEFAULT_LIVEGRID_BUFFER_SIZE,restful:true,reader:reader,totalProperty:&quot;totalResults&quot;,storeUtils:sitools.user.component.dataviews.storeUtils,url:config.urlRecords,dataUrl:config.urlRecords,baseParams:params});sitools.user.component.dataviews.cartoView.featureStore.superclass.constructor.call(this,config);this.load({params:{start:0,limit:DEFAULT_LIVEGRID_BUFFER_SIZE}});};Ext.extend(sitools.user.component.dataviews.cartoView.featureStore,GeoExt.data.FeatureStore,{getFormParams:function(){return this.storeUtils.getFormParams();},loadRecords:function(o,options,success){this.bufferRange=[-1,-1];if(o&amp;&amp;options&amp;&amp;options.params){this.bufferRange=[options.params.start,Math.max(0,Math.min((options.params.start+options.params.limit)-1,o.totalRecords-1))];}
sitools.user.component.dataviews.cartoView.featureStore.superclass.loadRecords.call(this,o,options,success);},load:function(options){sitools.user.component.dataviews.cartoView.featureStore.superclass.load.call(this,options);},singleSort:function(fieldName,dir){var field=this.fields.get(fieldName);if(!field){return false;}
var name=field.name,sortInfo=this.sortInfo||null,sortToggle=this.sortToggle?this.sortToggle[name]:null;if(!dir){if(sortInfo&amp;&amp;sortInfo.field==name){dir=(this.sortToggle[name]||'ASC').toggle('ASC','DESC');}else{dir=field.sortDir;}}
this.sortToggle[name]=dir;this.sortInfo={field:name,direction:dir};this.hasMultiSort=false;if(this.remoteSort){this.load(this.lastOptions);}else{this.applySort();this.fireEvent('datachanged',this);}
return true;},});Ext.namespace('sitools.user.component.dataviews');sitools.user.component.dataviews.resourcePluginParamsPanel=Ext.extend(Ext.Panel,{width:&quot;450&quot;,showMethod:false,defaultMethod:&quot;&quot;,showRunType:false,initComponent:function(){var methodsArray=this.methods.split(&quot;|&quot;);this.showMethod=methodsArray.length&gt;1;this.defaultMethod=methodsArray[0];this.methodsStore=new Ext.data.ArrayStore({fields:[&quot;method&quot;],idIndex:0});Ext.each(methodsArray,function(item,index){this.methodsStore.add(new Ext.data.Record({method:item}));},this);var formCommonParametersFields=[];var comboMethod=new Ext.form.ComboBox({xtype:'combo',mode:'local',triggerAction:'all',editable:false,name:'method',fieldLabel:i18n.get('label.method'),width:100,store:this.methodsStore,valueField:'method',displayField:'method',anchor:&quot;100%&quot;,value:this.defaultMethod,forceSelection:true});this.items=[];if(this.showMethod){formCommonParametersFields.push(comboMethod);this.formParams=new Ext.form.FormPanel({padding:5,items:[{xtype:'fieldset',title:i18n.get(&quot;label.commonParameters&quot;),items:formCommonParametersFields}]});this.items.push(this.formParams);}
var userInputParams=[];Ext.each(this.resource.parameters,function(value,index){if(value.type==&quot;PARAMETER_USER_INPUT&quot;&amp;&amp;value.userUpdatable){var item=this.buildFormItemFromParam(value);userInputParams.push(item);if(value.name==&quot;runTypeUserInput&quot;){this.showRunType=true;}}},this);if(!Ext.isEmpty(userInputParams)){this.formParamsUserInput=new Ext.form.FormPanel({padding:5,labelWidth:150,items:{xtype:'fieldset',title:i18n.get(&quot;label.specificParameter&quot;),items:userInputParams}});this.items.push(this.formParamsUserInput);}
this.buttons=[{text:i18n.get('label.submit'),scope:this,handler:this.onCall},{text:i18n.get('label.cancel'),scope:this,handler:function(){this.ownerCt.close();}}];sitools.user.component.dataviews.resourcePluginParamsPanel.superclass.initComponent.call(this);},onCall:function(){var method;if(this.showMethod){var form=this.formParams.getForm();method=form.findField(&quot;method&quot;).getValue();}
else{method=this.defaultMethod;}
var runTypeUserInput;if(this.showRunType){runTypeUserInput=this.formParamsUserInput.getForm().findField(&quot;runTypeUserInput&quot;).getValue();}
else{runTypeUserInput=this.runType;}
var limit;var userParameters={};if(!Ext.isEmpty(this.formParamsUserInput)){var formParams=this.formParamsUserInput.getForm();Ext.iterate(formParams.getValues(),function(key,value){userParameters[key]=value;});}
this.contextMenu.onResourceCallClick(this.resource,this.url,method,runTypeUserInput,limit,userParameters);this.ownerCt.close();},buildFormItemFromParam:function(value,userInputParams){var valueType=value.valueType;var item={};if(valueType.indexOf(&quot;xs:boolean&quot;)!=-1){valueType=&quot;xs:enum[true,false]&quot;;}
if(valueType.indexOf(&quot;xs:enum&quot;)!=-1){var enumeration=valueType.split(&quot;[&quot;);enumeration=enumeration[1].split(&quot;]&quot;);enumeration=enumeration[0].split(&quot;,&quot;);var multiple=false;if(valueType.indexOf(&quot;xs:enum-multiple&quot;)&gt;=0||valueType.indexOf(&quot;xs:enum-editable-multiple&quot;)&gt;=0){multiple=true;}
var storeItems=[];for(var i=0;i&lt;enumeration.length;i++){var tmp=enumeration[i].trim();storeItems.push([tmp,tmp]);}
var store=new Ext.data.ArrayStore({fields:['value','text'],data:storeItems,valueField:'value',displayField:'text'});if(multiple){item={store:store,name:value.name,xtype:&quot;multiselect&quot;,values:value.value,delimiter:'|',fieldLabel:value.name,width:235,tooltip:value.description};}
else{item={store:store,name:value.name,xtype:&quot;combo&quot;,value:value.value,valueField:&quot;value&quot;,displayField:&quot;text&quot;,mode:'local',fieldLabel:value.name,triggerAction:'all',selectOnFocus:true,editable:false,anchor:&quot;100%&quot;,tooltip:value.description};}}
else{item={name:value.name,xtype:'textfield',value:value.value,fieldLabel:value.name,anchor:&quot;100%&quot;,tooltip:value.description};}
return item;},showMeInFixedNav:function(me,config){Ext.apply(config.windowSettings,{width:config.windowSettings.winWidth||DEFAULT_WIN_WIDTH,height:config.windowSettings.winHeight||DEFAULT_WIN_HEIGHT});SitoolsDesk.openModalWindow(me,config);},showMeInDesktopNav:function(me,config){Ext.apply(config.windowSettings,{width:config.windowSettings.winWidth||DEFAULT_WIN_WIDTH,height:config.windowSettings.winHeight||DEFAULT_WIN_HEIGHT});SitoolsDesk.openModalWindow(me,config);}});Ext.namespace('sitools.user.component.dataviews');sitools.user.component.dataviews.goToTaskPanel=Ext.extend(Ext.Panel,{width:&quot;500&quot;,buttonAlign:'left',layout:'fit',initComponent:function(){this.mainPanel=this.createNewFormComponent(this.task);this.buttons=[&quot;-&gt;&quot;,{text:i18n.get('label.goToTask'),scope:this,handler:this.goToTask},{text:i18n.get('label.close'),scope:this,handler:function(){this.ownerCt.close();}}];this.items=[this.mainPanel];sitools.user.component.dataviews.goToTaskPanel.superclass.initComponent.call(this);},refreshTask:function(){var url=this.task.statusUrl;Ext.Ajax.request({url:url,method:&quot;GET&quot;,scope:this,success:function(ret){var data=Ext.decode(ret.responseText);if(!data.success){Ext.Msg.alert(i18n.get('label.warning'),data.message);return false;}
this.task=data.TaskModel;this.mainPanel=this.createNewFormComponent(this.task);this.removeAll();this.add(this.mainPanel);this.doLayout();},failure:alertFailure});},createNewFormComponent:function(task){var html=String.format(i18n.get(&quot;label.taskLaunched&quot;),task.status);html+=String.format(&quot;&lt;a href='#'&gt;{0}&lt;/a&gt;&lt;br&gt;&quot;,i18n.get(&quot;label.detail&quot;));if(!Ext.isEmpty(task.urlResult)){html+=&quot;&lt;br&gt;&quot;+String.format(i18n.get(&quot;label.taskResult&quot;),task.urlResult);html+=String.format(&quot;&lt;a href='#'&gt;{0}&lt;/a&gt;&lt;br&gt;&quot;,i18n.get(&quot;label.result&quot;));}
else{html+=&quot;&lt;br&gt;&quot;+i18n.get(&quot;label.refreshTaskWindow&quot;);html+=String.format(&quot;&lt;a href='#'&gt;{0}&lt;/a&gt;&lt;br&gt;&quot;,i18n.get(&quot;label.refresh&quot;));}
var panel=new Ext.Panel({padding:5,layout:&quot;fit&quot;,html:html,listeners:{scope:this,afterrender:function(panel){panel.getEl().child('a').on(&quot;click&quot;,function(){this.showTaskDetail(task);},this);var resultOrRefreshLink=panel.getEl().child('a').next('a');if(!Ext.isEmpty(task.urlResult)){resultOrRefreshLink.on(&quot;click&quot;,function(){this.showTaskResults(task);},this);}
else{resultOrRefreshLink.on(&quot;click&quot;,function(){this.refreshTask();},this);}}}});return panel;},goToTask:function(){this.ownerCt.close();var jsObj=sitools.user.component.entete.userProfile.tasks;var windowConfig={title:i18n.get('label.Tasks'),saveToolbar:false,iconCls:&quot;tasks&quot;};SitoolsDesk.addDesktopWindow(windowConfig,{},jsObj,true);},_showOrderDetails:function(url){Ext.Ajax.request({url:url,method:'GET',scope:this,success:function(ret){var data=Ext.decode(ret.responseText);if(!data.success){Ext.Msg.alert(i18n.get('label.warning'),data.message);return false;}
var rec=new Ext.data.Record(data.order);var jsObj=sitools.user.modules.userSpaceDependencies.orderProp;var componentCfg={action:'detail',orderRec:rec};var title=i18n.get('label.details')+&quot; : &quot;;title+=rec.data.userId;title+=&quot; &quot;+i18n.get('label.the');title+=&quot; &quot;+rec.data.dateOrder;var windowConfig={id:&quot;showDataDetailId&quot;,title:title,specificType:&quot;dataDetail&quot;,iconCls:&quot;dataDetail&quot;};SitoolsDesk.addDesktopWindow(windowConfig,componentCfg,jsObj);},failure:alertFailure});},_showDatasetDetails:function(url){var urlDataset=url.substring(0,url.indexOf(&quot;/records&quot;));Ext.Ajax.request({url:urlDataset,method:'GET',scope:this,success:function(ret){var data=Ext.decode(ret.responseText);if(!data.success){Ext.Msg.alert(i18n.get('label.warning'),data.message);return false;}
var dataset=new Ext.data.Record(data.dataset).data;var windowConfig={title:i18n.get('label.dataTitle')+&quot; : &quot;+dataset.name,datasetName:dataset.name,datasetDescription:dataset.description,type:&quot;data&quot;,saveToolbar:true,toolbarItems:[],iconCls:&quot;dataDetail&quot;};var javascriptObject=eval(dataset.datasetView.jsObject);Ext.apply(windowConfig,{id:&quot;data&quot;+dataset.datasetId});var componentCfg={dataUrl:dataset.sitoolsAttachementForUsers,datasetId:dataset.id,datasetCm:dataset.columnModel,datasetName:dataset.name,dictionaryMappings:dataset.dictionaryMappings,datasetViewConfig:dataset.datasetViewConfig,preferencesPath:&quot;/&quot;+dataset.name,preferencesFileName:&quot;datasetView&quot;};SitoolsDesk.addDesktopWindow(windowConfig,componentCfg,javascriptObject);},failure:alertFailure});},showTaskDetail:function(task){var jsObj=sitools.user.component.entete.userProfile.tasksDetails;var componentCfg={sva:task};var windowConfig={id:&quot;taskStatusDetails&quot;,title:i18n.get(&quot;label.taskDetails&quot;)+&quot;:&quot;+task.id,iconCls:&quot;dataDetail&quot;};SitoolsDesk.addDesktopWindow(windowConfig,componentCfg,jsObj);},showTaskResults:function(task){var orderUrl=loadUrl.get('APP_URL')+loadUrl.get('APP_ORDERS_USER_URL');if(task.urlResult.indexOf(orderUrl)!=-1){this._showOrderDetails(task.urlResult);}else if(task.urlResult.indexOf(&quot;/records&quot;)!=-1){this._showDatasetDetails(task.urlResult);}
else{window.open(task.urlResult);}},showMeInFixedNav:function(me,config){Ext.apply(config.windowSettings,{width:config.windowSettings.winWidth||DEFAULT_WIN_WIDTH,height:config.windowSettings.winHeight||DEFAULT_WIN_HEIGHT});SitoolsDesk.openModalWindow(me,config);},showMeInDesktopNav:function(me,config){Ext.apply(config.windowSettings,{width:config.windowSettings.winWidth||DEFAULT_WIN_WIDTH,height:config.windowSettings.winHeight||DEFAULT_WIN_HEIGHT});SitoolsDesk.openModalWindow(me,config);}});Ext.namespace('sitools.user.component');sitools.user.component.columnsDefinition=function(config){Ext.apply(this,config);this.dictionaryMappings=config.dictionaryMappings[0];var fields=[{name:'columnAlias',type:'string'},{name:'unit',type:'string'}];var columns=[{header:i18n.get('label.columnAlias'),dataIndex:'columnAlias',width:100,sortable:true},{header:i18n.get('label.unit'),dataIndex:'unit',width:100,sortable:true}];if(!Ext.isEmpty(this.dictionaryMappings)&amp;&amp;!Ext.isEmpty(this.dictionaryMappings.mapping)&amp;&amp;!Ext.isEmpty(this.dictionaryMappings.mapping[0])){var conceptAsTemplate=this.dictionaryMappings.mapping[0].concept;columns.push({header:i18n.get(&quot;headers.name&quot;),dataIndex:'name',width:100});columns.push({header:i18n.get(&quot;headers.description&quot;),dataIndex:'description',width:120});fields.push({name:'name',type:'string'});fields.push({name:'description',type:'string'});for(var i=0;i&lt;conceptAsTemplate.properties.length;i++){var property=conceptAsTemplate.properties[i];columns.push({header:property.name,dataIndex:property.name,width:80});fields.push({name:property.name,type:'string'});}}
var reader=new Ext.data.JsonReader({fields:fields,idProperty:'columnAlias'});this.grid=new Ext.grid.GridPanel({store:new Ext.data.GroupingStore({idProperty:'id',fields:fields,autoload:false,groupField:false,reader:reader,sortInfo:{field:'columnAlias',direction:'ASC'},remoteSort:false}),cm:new Ext.grid.ColumnModel({columns:columns}),view:new Ext.grid.GroupingView({groupTextTpl:'{text} ({[values.rs.length]} {[values.rs.length &gt; 1 ? &quot;Items&quot; : &quot;Item&quot;]})',autoFill:true,forceFit:true}),layout:'fit'});this.layout=&quot;fit&quot;;this.items=[this.grid];sitools.user.component.columnsDefinition.superclass.constructor.call(this);};Ext.extend(sitools.user.component.columnsDefinition,Ext.Panel,{componentType:&quot;defi&quot;,_getSettings:function(){var colModel=[];return{colModel:extColModelToJsonColModel(this.grid.getColumnModel().config),datasetName:this.datasetName,preferencesPath:this.preferencesPath,preferencesFileName:this.preferencesFileName};},onRender:function(){sitools.user.component.columnsDefinition.superclass.onRender.apply(this,arguments);var store=this.grid.getStore();var concepts,record;Ext.each(this.datasetCm,function(column){concepts=this.getConcepts(column);if(!Ext.isEmpty(concepts)){Ext.each(concepts,function(concept){var rec={columnAlias:column.columnAlias,unit:column.unit&amp;&amp;column.unit.label};rec=Ext.apply(rec,{id:concept.id,name:concept.name,description:concept.description});for(var j=0;j&lt;concept.properties.length;j++){var property=concept.properties[j];rec[property.name]=property.value;}
record=new Ext.data.Record(rec);store.add(record);});}else{var rec={columnAlias:column.columnAlias};record=new Ext.data.Record(rec);store.add(record);}},this);},getConcepts:function(column){if(Ext.isEmpty(this.dictionaryMappings)){return;}
var mapping=this.dictionaryMappings.mapping;var concepts=[],map;for(var i=0;i&lt;mapping.length;i++){map=mapping[i];if(column.columnAlias==map.columnAlias){concepts.push(map.concept);}}
return concepts;},toggleGroup:function(){var store=this.grid.getStore();if(store.groupField===false){store.groupBy(&quot;columnAlias&quot;);var indexColumnAlias=this.grid.getColumnModel().findColumnIndex(&quot;columnAlias&quot;);this.grid.getColumnModel().setHidden(indexColumnAlias,true);this.grid.getView().enableGrouping=true;this.grid.getView().refresh();}else{store.clearGrouping();this.grid.getColumnModel().setHidden(0,false);}},showMeInFixedNav:function(me,config){Ext.apply(config.windowSettings,{width:400,height:400});SitoolsDesk.openModalWindow(me,config);}});Ext.reg('sitools.user.component.columnsDefinition',sitools.user.component.columnsDefinition);Ext.namespace('sitools.user.component');sitools.user.component.DatasetOverview=function(config){this.DEFAULT_HEIGHT=600;this.DEFAULT_WIDTH=800;this.DEFAULT_WIDTH_FORMS_PANEL=400;this.DEFAULT_HEIGHT_SEMANTIC_PANEL=200;this.DEFAULT_WIDTH_EAST_PANEL=200;Ext.apply(this,config);this.formsTabPanel=new Ext.TabPanel({items:[]});this.formsContainerPanel=new Ext.Panel({title:&quot;forms&quot;,layout:&quot;fit&quot;,region:&quot;west&quot;,collapsible:true,split:true,width:this.DEFAULT_WIDTH_FORMS_PANEL,items:[this.formsTabPanel]});this.semanticPanel=new Ext.Panel({title:i18n.get('label.semantic'),layout:&quot;fit&quot;,region:&quot;south&quot;,html:&quot; &quot;,collapsible:true,split:true,hidden:true,height:this.DEFAULT_HEIGHT_SEMANTIC_PANEL});this.descriptionPanel=new Ext.Panel({title:i18n.get('label.description'),autoScroll:true,layout:&quot;fit&quot;,region:&quot;center&quot;,html:&quot; &quot;});this.mainPanel=new Ext.Panel({layout:&quot;fit&quot;,region:&quot;center&quot;,border:false,items:[{layout:&quot;border&quot;,items:[this.descriptionPanel,this.semanticPanel]}]});this.eastPanel=new Ext.Panel({layout:&quot;fit&quot;,region:&quot;east&quot;,hidden:true,collapsible:true,split:true,items:[],width:this.DEFAULT_WIDTH_EAST_PANEL});sitools.user.component.DatasetOverview.superclass.constructor.call(this,{layout:&quot;border&quot;,items:[this.formsContainerPanel,this.mainPanel,this.eastPanel],listeners:{scope:this,beforerender:function(){this.loadDataset();return true;},datasetLoaded:function(){this.loadForms();},formsLoaded:function(){this.loadSemantic();},semanticLoaded:function(){this.loadDescription();},descriptionLoaded:function(){return;}}});};Ext.extend(sitools.user.component.DatasetOverview,Ext.Panel,{componentType:&quot;datasetOverview&quot;,_getSettings:function(){var colModel={};if(this.dataview){colModel=extColModelToJsonColModel(this.dataview.colModel.config);}
else{colModel=extColModelToJsonColModel(this.dataset.columnModel);}
return{sitoolsAttachementForUsers:this.sitoolsAttachementForUsers,preferencesPath:this.preferencesPath,preferencesFileName:this.preferencesFileName,formsPanelWidth:50,formsPanelCollapsed:true,formsActivePanel:1,datasetName:this.dataset.name,colModel:colModel,datasetView:&quot;datasetOverview&quot;,datasetUrl:this.sitoolsAttachementForUsers,dictionaryMappings:this.dataset.dictionaryMappings};},loadDataset:function(){Ext.Ajax.request({method:&quot;GET&quot;,scope:this,url:this.sitoolsAttachementForUsers,success:function(response){var json=Ext.decode(response.responseText);if(!json.success){Ext.Msg.alert(i18n.get('label.error'),i18n.get('warning.datasetRequestError'));return false;}else{this.dataset=json.dataset;this.fireEvent(&quot;datasetLoaded&quot;);}},failure:alertFailure});},loadForms:function(){Ext.Ajax.request({method:&quot;GET&quot;,scope:this,url:this.dataset.sitoolsAttachementForUsers+'/forms',success:function(response){var json=Ext.decode(response.responseText);var eventToFire='formsLoaded';if(!json.success){Ext.Msg.alert(i18n.get('label.error'),i18n.get('warning.datasetRequestError'));return false;}else{this.forms=json.data;if(!Ext.isEmpty(this.forms)){var eventToFire='semanticLoaded';Ext.each(this.forms,function(form){var panel=new sitools.user.component.forms.mainContainer({title:form.name,dataUrl:this.dataset.sitoolsAttachementForUsers,dataset:this.dataset,formId:form.id,id:form.id,formName:form.name,formParameters:form.parameters,formWidth:form.width,formHeight:form.height,formCss:form.css,preferencesPath:&quot;/&quot;+this.dataset.name+&quot;/forms&quot;,preferencesFileName:form.name,searchAction:this.searchAction,scope:this});this.formsTabPanel.add(panel);},this);this.formsTabPanel.doLayout();if(this.formId){this.formsTabPanel.setActiveTab(this.formId);}
else{this.formsTabPanel.setActiveTab(0);}}
else{this.semanticPanel.show();var jsObj=eval(this.dataset.datasetView.jsObject);var componentCfg={dataUrl:this.dataset.sitoolsAttachementForUsers,datasetId:this.dataset.id,datasetCm:this.dataset.columnModel,datasetName:this.dataset.name,dictionaryMappings:this.dataset.dictionaryMappings,datasetViewConfig:this.dataset.datasetViewConfig,preferencesPath:&quot;/&quot;+this.dataset.name,preferencesFileName:&quot;datasetView&quot;};this.dataview=new jsObj(componentCfg);this.formsContainerPanel.removeAll();this.formsContainerPanel.hide();this.eastPanel.setVisible(true);this.eastPanel.add(this.mainPanel.items.items);this.mainPanel.removeAll();this.mainPanel.add(this.dataview);this.doLayout();}
this.mainPanel.doLayout();this.fireEvent(eventToFire);}},failure:alertFailure});},loadSemantic:function(){var panel=new sitools.user.component.columnsDefinition({datasetId:this.dataset.id,datasetCm:this.dataset.columnModel,datasetName:this.dataset.name,dictionaryMappings:this.dataset.dictionaryMappings});this.semanticPanel.removeAll();this.semanticPanel.add(panel);this.semanticPanel.doLayout();this.fireEvent('semanticLoaded');},loadDescription:function(){var contentTarget=this.descriptionPanel.getContentTarget();if(!Ext.isEmpty(this.dataset.descriptionHTML)){contentTarget.update(Ext.DomHelper.markup(this.dataset.descriptionHTML));}
this.fireEvent(&quot;descriptionLoaded&quot;);},searchAction:function(formParams,dataset,scope){var jsObj=eval(dataset.datasetView.jsObject);var componentCfg={dataUrl:dataset.sitoolsAttachementForUsers,datasetId:dataset.id,datasetCm:dataset.columnModel,datasetName:dataset.name,formParams:formParams,dictionaryMappings:dataset.dictionaryMappings,datasetViewConfig:dataset.datasetViewConfig,preferencesPath:&quot;/&quot;+dataset.name,preferencesFileName:&quot;datasetView&quot;,userPreference:{datasetName:this.dataset.name,colModel:extColModelToJsonColModel(this.dataset.columnModel),datasetView:&quot;datasetOverview&quot;,datasetUrl:this.sitoolsAttachementForUsers,dictionaryMappings:this.dataset.dictionaryMappings}};scope.dataview=new jsObj(componentCfg);scope.mainPanel.removeAll();scope.mainPanel.add(scope.dataview);scope.doLayout();}});Ext.reg('sitools.user.component.DatasetOverview',sitools.user.component.DatasetOverview);Ext.namespace('sitools.user.component.entete.userProfile');sitools.user.component.entete.userProfile.tasksDetails=Ext.extend(Ext.FormPanel,{labelWidth:120,frame:true,autoScroll:true,initComponent:function(){var itemsForm=[];Ext.iterate(this.sva,function(key,value){if(value!=undefined&amp;&amp;value!=&quot;&quot;){itemsForm.push({xtype:'textfield',name:key,fieldLabel:i18n.get('label.'+key),disabled:true,disabledClass:'x-item-disabled-custom',labelStyle:'font-weight:bold;',anchor:'100%',value:value});}});this.items=itemsForm;sitools.user.component.entete.userProfile.tasksDetails.superclass.initComponent.call(this);},showMeInFixedNav:function(me,config){Ext.apply(config.windowSettings,{width:config.windowSettings.winWidth||DEFAULT_WIN_WIDTH,height:config.windowSettings.winHeight||DEFAULT_WIN_HEIGHT});SitoolsDesk.openModalWindow(me,config);},showMeInDesktopNav:function(me,config){Ext.apply(config.windowSettings,{width:config.windowSettings.winWidth||DEFAULT_WIN_WIDTH,height:config.windowSettings.winHeight||DEFAULT_WIN_HEIGHT});SitoolsDesk.openModalWindow(me,config);}});Ext.namespace('sitools.user.component.entete.userProfile');sitools.user.component.entete.userProfile.diskSpace=Ext.extend(Ext.tree.TreePanel,{autoScroll:true,initComponent:function(){this.AppUserStorage=loadUrl.get('APP_USERSTORAGE_USER_URL').replace('{identifier}',userLogin)+&quot;/files&quot;;this.tbar=new Ext.ux.StatusBar({statusAlign:'right'});this.buttons=[{text:i18n.get('label.refreshResource'),scope:this,handler:this._onRefresh},{text:i18n.get('label.deleteResource'),scope:this,handler:this._onDelete},{text:i18n.get('label.close'),scope:this,handler:function(){this.ownerCt.destroy();}}];sitools.user.component.entete.userProfile.diskSpace.superclass.initComponent.call(Ext.apply(this,{expanded:true,useArrows:true,autoScroll:true,layout:'fit',animate:true,enableDD:false,containerScroll:true,loader:new Ext.tree.TreeLoader(),rootVisible:true,root:{text:userLogin,children:[],nodeType:'async',url:loadUrl.get('APP_URL')+this.AppUserStorage+&quot;/&quot;},listeners:{scope:this,beforeload:function(node){return node.isRoot||Ext.isDefined(node.attributes.children);},beforeexpandnode:function(node){node.removeAll();Ext.Ajax.request({url:node.attributes.url,method:'GET',scope:this,success:function(ret){try{var Json=Ext.decode(ret.responseText);Ext.each(Json,function(child){var text=child.text;if(child.leaf){text+=&quot;&lt;span style='font-style:italic'&gt; (&quot;+Ext.util.Format.fileSize(child.size)+&quot;)&lt;/span&gt;&quot;;}
node.appendChild({cls:child.cls,text:text,url:child.url,leaf:child.leaf,children:[],checked:child.checked});});return true;}catch(err){Ext.Msg.alert(i18n.get('warning'),err);return false;}},failure:function(ret){return null;}});return true;},click:function(n){if(n.attributes.leaf){var url=n.attributes.url;viewFileContent(url,n.attributes.text);}}}}));},onRender:function(){sitools.user.component.entete.userProfile.diskSpace.superclass.onRender.apply(this,arguments);this.setUserStorageSize();},setUserStorageSize:function(){Ext.Ajax.request({method:&quot;GET&quot;,scope:this,url:loadUrl.get('APP_URL')+loadUrl.get('APP_USERSTORAGE_USER_URL').replace(&quot;{identifier}&quot;,userLogin)+&quot;/status&quot;,success:function(ret){var json=Ext.decode(ret.responseText);if(!json.success){return;}
var storage=json.userstorage.storage;var totalSpace=storage.quota;var usedSpace=storage.busyUserSpace;var pourcentage=usedSpace/totalSpace*100;var cls=null;if(pourcentage&gt;=90&amp;&amp;pourcentage&lt;100){cls=&quot;x-status-warning&quot;;}
else if(pourcentage&gt;100){cls=&quot;x-status-error&quot;;}
var str=String.format(i18n.get('label.diskSpaceLong'),Ext.util.Format.round(pourcentage,0),Ext.util.Format.fileSize(totalSpace));this.getTopToolbar().setText(str);this.getTopToolbar().setIcon(cls);this.doLayout();}});},_onRefresh:function(){this.getRootNode().collapse();this.setUserStorageSize();},_onDelete:function(){var selNodes=this.getChecked();if(selNodes.length===0){return;}
Ext.each(selNodes,function(node){Ext.Ajax.request({method:'DELETE',url:node.attributes.url+&quot;?recursive=true&quot;,scope:this,success:function(response,opts){var notify=new Ext.ux.Notification({iconCls:'x-icon-information',title:i18n.get('label.information'),html:i18n.get('label.resourceDeleted'),autoDestroy:true,hideDelay:1000});notify.show(document);node.destroy();},failure:alertFailure},this);});}});Ext.namespace('sitools.user.component.entete.userProfile');sitools.user.component.entete.userProfile.tasks=Ext.extend(Ext.grid.GridPanel,{border:false,sm:new Ext.grid.RowSelectionModel(),layout:{type:'vbox',align:'stretch'},height:430,pageSize:10,initComponent:function(){this.url=loadUrl.get('APP_URL')+loadUrl.get('APP_USERRESOURCE_ROOT_URL')+'/'+userLogin+'/tasks';this.store=new Ext.data.JsonStore({root:'data',restful:true,url:this.url,remoteSort:true,idProperty:'id',fields:[{name:'id',type:'string'},{name:'status',type:'string'},{name:'modelId',type:'string'},{name:'customStatus',type:'string'},{name:'timestamp',type:'string'},{name:'statusUrl',type:'string'},{name:'urlResult',type:'string'},{name:'userId',type:'string'},{name:'startDate',type:'string'},{name:'endDate',type:'string'},{name:'runType',type:'string'},{name:'modelName',type:'string'}]});this.cm=new Ext.grid.ColumnModel({defaults:{sortable:false},columns:[{header:i18n.get('label.taskId'),dataIndex:'id',width:220,hidden:true},{header:i18n.get('label.startDate'),dataIndex:'startDate',width:170},{header:i18n.get('label.endDate'),dataIndex:'endDate',width:170},{header:i18n.get('label.status'),dataIndex:'status',width:180},{header:i18n.get('label.customStatus'),dataIndex:'customStatus',width:100}]});this.bbar={xtype:'paging',pageSize:this.pageSize,store:this.store,displayInfo:true,displayMsg:i18n.get('paging.display'),emptyMsg:i18n.get('paging.empty')};this.tbar={xtype:'toolbar',defaults:{scope:this},items:[{text:i18n.get('label.delete'),icon:loadUrl.get('APP_URL')+'/common/res/images/icons/toolbar_delete.png',handler:this._onDelete,xtype:'s-menuButton'},{text:i18n.get('label.clean'),icon:loadUrl.get('APP_URL')+'/common/res/images/icons/toolbar_clean.png',handler:this._onClean,xtype:'s-menuButton'},{text:i18n.get('label.viewResult'),icon:loadUrl.get('APP_URL')+'/common/res/images/icons/view_result.png',handler:this._onViewResult,xtype:'s-menuButton'},{text:i18n.get('label.viewStatusDetails'),icon:loadUrl.get('APP_URL')+'/common/res/images/icons/toolbar_details.png',handler:this._onViewStatusDetails,xtype:'s-menuButton'},{text:i18n.get('label.setFinish'),icon:loadUrl.get('APP_URL')+'/common/res/images/icons/set_finish.png',handler:this._onFinish,xtype:'s-menuButton'}]};sitools.user.component.entete.userProfile.tasks.superclass.initComponent.call(Ext.apply(this,{viewConfig:{forceFit:true}}));},onRender:function(){sitools.user.component.entete.userProfile.tasks.superclass.onRender.apply(this,arguments);this.store.load({params:{start:0,limit:this.pageSize}});},_onDelete:function(){var rec=this.getSelectionModel().getSelected();if(!rec){return false;}
var tot=Ext.Msg.show({title:i18n.get('label.delete'),buttons:Ext.Msg.YESNO,msg:i18n.get('tasks.delete'),scope:this,fn:function(btn,text){if(btn=='yes'){this.doDelete(rec);}}});},doDelete:function(rec){Ext.Ajax.request({url:this.url+&quot;/&quot;+rec.data.id,method:'DELETE',scope:this,success:function(ret){if(showResponse(ret)){this.store.reload();}},failure:alertFailure});},_onViewResult:function(){var rec=this.getSelectionModel().getSelected();if(!rec){return false;}
if(!Ext.isEmpty(rec.data.urlResult)){var orderUrl=loadUrl.get('APP_URL')+loadUrl.get('APP_ORDERS_USER_URL');if(rec.data.urlResult.indexOf(orderUrl)!=-1){this._showOrderDetails(rec.data.urlResult);}else{var pathUrl=window.location.protocol+&quot;//&quot;+window.location.host;if(rec.data.urlResult.indexOf(&quot;http://&quot;)!=-1){window.open(rec.data.urlResult);}else{window.open(pathUrl+rec.data.urlResult);}}}},_onFinish:function(){var rec=this.getSelectionModel().getSelected();if(!rec){return false;}
Ext.Ajax.request({url:this.url+&quot;/&quot;+rec.data.id+&quot;?action=finish&quot;,method:'PUT',scope:this,success:function(ret){if(showResponse(ret)){this.store.reload();}},failure:alertFailure});},_onClean:function(){var tot=Ext.Msg.show({title:i18n.get('label.delete'),buttons:Ext.Msg.YESNO,msg:i18n.get('tasks.delete.all'),scope:this,fn:function(btn,text){if(btn=='yes'){this._doClean();}}});},_doClean:function(){Ext.Ajax.request({url:this.url,method:'DELETE',scope:this,success:function(ret){if(showResponse(ret)){this.store.reload();}},failure:alertFailure});},_onViewStatusDetails:function(){var rec=this.getSelectionModel().getSelected();if(!rec){return Ext.Msg.alert(i18n.get('label.warning'),i18n.get('warning.noselection'));}
var jsObj=sitools.user.component.entete.userProfile.tasksDetails;var componentCfg={sva:rec.data};var windowConfig={id:&quot;taskStatusDetails&quot;,title:i18n.get(&quot;label.taskDetails&quot;)+&quot;:&quot;+rec.data.id,iconCls:&quot;dataDetail&quot;};SitoolsDesk.addDesktopWindow(windowConfig,componentCfg,jsObj);},_showOrderDetails:function(url){Ext.Ajax.request({url:url,method:'GET',scope:this,success:function(ret){var data=Ext.decode(ret.responseText);if(!data.success){Ext.Msg.alert(i18n.get('label.warning'),data.message);return false;}
var rec=new Ext.data.Record(data.order);var jsObj=sitools.user.modules.userSpaceDependencies.orderProp;var componentCfg={action:'detail',orderRec:rec};var title=i18n.get('label.details')+&quot; : &quot;;title+=rec.data.userId;title+=&quot; &quot;+i18n.get('label.the');title+=&quot; &quot;+rec.data.dateOrder;var windowConfig={id:&quot;showDataDetailId&quot;,title:title,specificType:&quot;dataDetail&quot;,iconCls:&quot;dataDetail&quot;};SitoolsDesk.addDesktopWindow(windowConfig,componentCfg,jsObj);},failure:alertFailure});}});Ext.namespace('sitools.user.component.entete.viewTextPanel');sitools.user.component.entete.userProfile.viewTextPanel=Ext.extend(Ext.Panel,{layout:'fit',autoScroll:true,initComponent:function(){if(this.formatJson){try{if(Ext.isFunction(JSON.parse)&amp;&amp;Ext.isFunction(JSON.stringify)){var obj=JSON.parse(this.text);this.html=JSON.stringify(obj,null,4);this.style=&quot;white-space: pre&quot;;}}catch(err){this.html=this.text;}}
else{this.html=this.text;}
sitools.user.component.entete.userProfile.viewTextPanel.superclass.initComponent.call(this);},showMeInFixedNav:function(me,config){Ext.apply(config.windowSettings,{width:config.windowSettings.winWidth||DEFAULT_WIN_WIDTH,height:config.windowSettings.winHeight||DEFAULT_WIN_HEIGHT});SitoolsDesk.openModalWindow(me,config);},showMeInDesktopNav:function(me,config){Ext.apply(config.windowSettings,{width:config.windowSettings.winWidth||DEFAULT_WIN_WIDTH,height:config.windowSettings.winHeight||DEFAULT_WIN_HEIGHT});SitoolsDesk.openModalWindow(me,config);}});Ext.namespace('sitools.user.component');sitools.user.component.help=Ext.extend(Ext.Panel,{activeNode:null,initComponent:function(){this.url=loadUrl.get('APP_URL')+&quot;/client-user/res/help/fr/Client-userUG.html&quot;;this.layout=&quot;border&quot;;var htmlReaderCfg={defaults:{padding:10},layout:'fit',region:'center'};if(!Ext.isEmpty(this.cfgCmp)&amp;&amp;!Ext.isEmpty(this.cfgCmp.activeNode)){this.activeNode=this.cfgCmp.activeNode;}else{htmlReaderCfg.defaultSrc=this.url;}
this.tree=new Ext.tree.TreePanel({region:'west',animate:true,width:200,rootVisible:false,useArrows:true,autoScroll:true,split:true,collapsible:true,collapsed:false,title:&quot;menu&quot;,root:{nodeType:'async',text:&quot;rootHelp&quot;},loader:new Ext.tree.TreeLoader({requestMethod:'GET',url:loadUrl.get('APP_URL')+&quot;/client-user/tmp/help.json&quot;,listeners:{scope:this,load:function(){if(!Ext.isEmpty(this.activeNode)){var node=this.tree.getNodeById(this.activeNode);if(!Ext.isEmpty(node)){this.tree.selectPath(node.getPath());this.treeAction(node);}else{Ext.Msg.alert(i18n.get('label.warning'),i18n.get('msg.nodeundefined'));}}}}}),listeners:{scope:this,click:function(node,e){this.treeAction(node);}}});this.htmlReader=new Ext.ux.ManagedIFrame.Panel(htmlReaderCfg);this.items=[this.tree,this.htmlReader];sitools.user.component.help.superclass.initComponent.call(this);},onRender:function(){sitools.user.component.help.superclass.onRender.apply(this,arguments);this.tree.getRootNode().expand(true);},treeAction:function(node){var nodeAnchor=node.attributes.nodeAnchor;if(!Ext.isDefined(nodeAnchor)){Ext.Msg.alert(i18n.get('label.warning'),i18n.get('msg.nodeundefined'));return;}
this.htmlReader.setSrc(this.url+&quot;#&quot;+nodeAnchor);}});Ext.reg('sitools.user.component.help',sitools.user.component.help);Ext.namespace('sitools.user.component.entete');sitools.user.component.entete.Entete=Ext.extend(Ext.Panel,{heightNormalMode:0,heightMaximizeDesktopMode:0,initComponent:function(){this.navBarModule=new sitools.user.component.entete.NavBar({modules:this.modules,observer:this});this.navToolbarButtons=new sitools.user.component.entete.NavBarButtons({observer:this,width:'162px'});this.NavBarsPanel=new Ext.Panel({border:false,layout:'hbox',height:35,flex:1,listeners:{scope:this,maximizeDesktop:this.onMaximizeDesktopNavbar,minimizeDesktop:this.onMinimizeDesktopNavbar},items:[this.navBarModule,this.navToolbarButtons]});this.entetePanel=new Ext.Panel({html:this.htmlContent,border:false,layout:&quot;fit&quot;,flex:1,listeners:{scope:this,desktopReady:this.showUserContainer}});sitools.user.component.entete.Entete.superclass.initComponent.call(Ext.apply(this,{items:[this.entetePanel,this.NavBarsPanel],border:false,layout:&quot;vbox&quot;,layoutConfig:{align:&quot;stretch&quot;},listeners:{scope:this,afterRender:function(me){var enteteEl=SitoolsDesk.getEnteteEl();me.setHeight(enteteEl.getHeight());me.doLayout();me.heightNormalMode=enteteEl.getHeight();me.heightMaximizeDesktopMode=this.NavBarsPanel.getHeight();},maximizeDesktop:this.onMaximizeDesktop,minimizeDesktop:this.onMinimizeDesktop,windowResize:function(me){this.userContainer.hide();},desktopReady:function(me){this.entetePanel.fireEvent(&quot;desktopReady&quot;,this.navToolbarButtons);}}}));},onMaximizeDesktop:function(){this.entetePanel.hide();this.container.setHeight(this.heightMaximizeDesktopMode);this.setHeight(this.heightMaximizeDesktopMode);this.NavBarsPanel.fireEvent(&quot;maximizeDesktop&quot;);if(this.userContainer){this.userContainer.fireEvent(&quot;maximizeDesktop&quot;,this.userContainer,this.navToolbarButtons);}
this.doLayout();},onMinimizeDesktop:function(){this.entetePanel.setVisible(true);this.container.dom.style.height=&quot;&quot;;this.setHeight(this.heightNormalMode);this.NavBarsPanel.fireEvent(&quot;minimizeDesktop&quot;);if(this.userContainer){this.userContainer.fireEvent(&quot;minimizeDesktop&quot;,this.userContainer,this.navToolbarButtons);}
this.doLayout();},showUserContainer:function(navBar){var tpl,textToDisplay=i18n.get(&quot;label.welcome&quot;),userContainerHeight,userContainerWidth;if(projectGlobal.user){textToDisplay+=&quot; &quot;+projectGlobal.user.firstName+&quot; &quot;+projectGlobal.user.lastName;userContainerHeight=30;userContainerWidth=250;}
else{textToDisplay+=&quot; &quot;+i18n.get('label.guest')+&quot;&lt;br&gt;&quot;+i18n.get(&quot;label.clickToConnect&quot;);userContainerHeight=50;userContainerWidth=250;}
if(SitoolsDesk.desktopMaximizeMode){tpl=new Ext.XTemplate(&quot;&lt;div style='left:{width - 60}px;' class='sitools-userContainer-arrow-border-up'&gt;&lt;/div&gt;&quot;,&quot;&lt;div style='left:{width - 60}px;' class='sitools-userContainer-arrow-up'&gt;&lt;/div&gt;&quot;,&quot;&lt;div&gt;&lt;img class='sitools-userContainer-icon' src='/sitools/cots/extjs/resources/images/default/window/icon-info.gif'&gt;{text}&lt;/div&gt;&quot;);}
else{tpl=new Ext.XTemplate(&quot;&lt;div&gt;&lt;img class='sitools-userContainer-icon' src='/sitools/cots/extjs/resources/images/default/window/icon-info.gif'&gt;{text}&lt;/div&gt;&quot;,&quot;&lt;div style='left:{width - 60}px;' class='sitools-userContainer-arrow-border-down'&gt;&lt;/div&gt;&quot;,&quot;&lt;div style='left:{width - 60}px;' class='sitools-userContainer-arrow-down'&gt;&lt;/div&gt;&quot;);}
this.userContainer=new Ext.BoxComponent({data:{text:textToDisplay,height:userContainerHeight,width:userContainerWidth},cls:&quot;sitools-userContainer&quot;,width:userContainerWidth,height:userContainerHeight,renderTo:SitoolsDesk.getEnteteEl(),tpl:tpl,listeners:{scope:this,afterRender:function(me){var el=Ext.get(me.id);el.on(&quot;click&quot;,function(e,t,o){this.getEl().fadeOut({easing:'easeOut',duration:1,endOpacity:0,useDisplay:false});},me);},maximizeDesktop:function(me,navBar){if(me.isVisible()){me.destroy();}},minimizeDesktop:function(me,navBar){if(me.isVisible()){me.destroy();}}}});var enteteEl=SitoolsDesk.getEnteteEl();var userContEl=this.userContainer.getEl();var x,y;x=Ext.getBody().getWidth()-this.userContainer.getWidth();y=this.calcUserContainerYPos(navBar);this.userContainer.setPosition([x,y]);userContEl.highlight(&quot;948B8B&quot;,{attr:'background-color',duration:1});userContEl.fadeOut({easing:'easeOut',duration:1,endOpacity:0,useDisplay:false});},calcUserContainerYPos:function(navBar){var enteteEl=SitoolsDesk.getEnteteEl();var userContEl=this.userContainer.getEl();var y;if(SitoolsDesk.desktopMaximizeMode){y=navBar.getHeight();}
else{y=enteteEl.getHeight()-navBar.getHeight()-this.userContainer.getHeight();if(!Ext.isEmpty(userContEl.getMargins())){y-=userContEl.getMargins().bottom;y-=userContEl.getMargins().top;}}
return y;},getNavbarButtons:function(){return this.navToolbarButtons;},getNavbarModules:function(){return this.navBarModule;},onMaximizeDesktopNavbar:function(){this.navBarModule.fireEvent(&quot;maximizeDesktop&quot;);this.navToolbarButtons.fireEvent(&quot;maximizeDesktop&quot;);},onMinimizeDesktopNavbar:function(){this.navBarModule.fireEvent(&quot;minimizeDesktop&quot;);this.navToolbarButtons.fireEvent(&quot;minimizeDesktop&quot;);}});Ext.reg('sitools.user.component.entete.Entete',sitools.user.component.entete.Entete);Ext.namespace('sitools.user.component.entete');sitools.user.component.entete.NavBar=Ext.extend(Ext.Toolbar,{initComponent:function(){var items=[];var categories=this.categorizeModules();var homeButton=new Ext.Button({handler:function(){projectGlobal.getPreferences(function(){SitoolsDesk.removeActivePanel();SitoolsDesk.removeAllWindows();SitoolsDesk.loadPreferences();});},scale:&quot;medium&quot;,icon:&quot;/sitools/common/res/images/icons/button-home.png&quot;,iconCls:'navBarButtons-icon',tooltip:{html:i18n.get(&quot;label.homeButton&quot;),anchor:'bottom',trackMouse:false},template:new Ext.Template('&lt;table cellspacing=&quot;0&quot; class=&quot;x-btn {3}&quot; style=&quot;padding-left:5px;&quot;&gt;&lt;tbody&gt;&lt;tr&gt;','&lt;td&gt;&lt;i&gt;&amp;#160;&lt;/i&gt;&lt;/td&gt;','&lt;td&gt;&lt;em class=&quot;{5} unselectable=&quot;on&quot;&gt;','&lt;button type=&quot;{1}&quot; style=&quot;height:28px; width:28px;&quot;&gt;{0}&lt;/button&gt;','&lt;/em&gt;&lt;/td&gt;','&lt;td&gt;&lt;i&gt;&amp;#160;&lt;/i&gt;&lt;/td&gt;',&quot;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&quot;)});items.push(homeButton);items.push('|');Ext.each(categories,function(category){var modules=category.modules;if(Ext.isEmpty(category.category)){var module=modules[0];var xtype=module.xtype;try{if(Ext.isEmpty(module.divIdToDisplay)){var handler=null;var item={text:i18n.get(module.label),iconCls:module.icon,scope:module,tooltip:{html:i18n.get(module.description),anchor:'bottom',trackMouse:false},cls:&quot;x-navBar-items&quot;,clickEvent:'mousedown',template:new Ext.Template('&lt;table cellspacing=&quot;0&quot; class=&quot;x-btn {3}&quot;&gt;&lt;tbody&gt;&lt;tr&gt;','&lt;td class=&quot;ux-taskbutton-left&quot;&gt;&lt;i&gt;&amp;#160;&lt;/i&gt;&lt;/td&gt;','&lt;td class=&quot;ux-taskbutton-center&quot;&gt;&lt;em class=&quot;{5} unselectable=&quot;on&quot;&gt;','&lt;button class=&quot;x-btn-text {2}&quot; type=&quot;{1}&quot; style=&quot;height:28px;&quot;&gt;{0}&lt;/button&gt;','&lt;/em&gt;&lt;/td&gt;','&lt;td class=&quot;ux-taskbutton-right&quot;&gt;&lt;i&gt;&amp;#160;&lt;/i&gt;&lt;/td&gt;',&quot;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&quot;)};var xtype=module.xtype;var func=xtype+&quot;.openModule&quot;;if(!Ext.isEmpty(xtype)&amp;&amp;Ext.isFunction(eval(func))){handler=eval(func);}
else{handler=module.openModule}
Ext.apply(item,{handler:handler});items.push(item);items.push('|');}}
catch(err){var tmp=null;}}
else{var menuItems=[];Ext.each(category.modules,function(moduleInCategory){try{if(Ext.isEmpty(moduleInCategory)){return;}
if(Ext.isEmpty(moduleInCategory.divIdToDisplay)){var item={text:i18n.get(moduleInCategory.label),iconCls:moduleInCategory.icon,scope:this};var xtype=moduleInCategory.xtype;if(Ext.isEmpty(xtype)){return;}
var Func=eval(xtype+&quot;.getStaticParameters&quot;);if(Ext.isFunction(Func)){var staticParameters=Func();if(staticParameters&amp;&amp;staticParameters.showAsMenu){Ext.apply(item,{menu:{xtype:moduleInCategory.xtype,cls:&quot;sitools-navbar-menu&quot;}});}
else{Ext.apply(item,{handler:moduleInCategory.openModule});}}
func=xtype+&quot;.openModule&quot;;if(Ext.isFunction(eval(func))){handler=eval(func);}
else{handler=moduleInCategory.openModule}
Ext.apply(item,{handler:handler});menuItems.push(item);}}
catch(err){var tmp=null;}});if(!Ext.isEmpty(menuItems)){var menu=new Ext.menu.Menu({items:menuItems,cls:&quot;sitools-navbar-menu&quot;});items.push({text:category.category,menu:menu,icon:&quot;/sitools/common/res/images/icons/white_arrow.gif&quot;,iconAlign:&quot;left&quot;,clickEvent:'mousedown',cls:&quot;x-navBar-items&quot;,template:new Ext.Template('&lt;table cellspacing=&quot;0&quot; class=&quot;x-btn {3}&quot;&gt;&lt;tbody&gt;&lt;tr&gt;','&lt;td class=&quot;ux-taskbutton-center&quot;&gt;&lt;em class=&quot;{2} unselectable=&quot;on&quot;&gt;','&lt;button class=&quot;x-btn-text {2}&quot; type=&quot;{1}&quot; style=&quot;height:28px;&quot;&gt;{0}&lt;/button&gt;','&lt;/em&gt;&lt;/td&gt;',&quot;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&quot;)});items.push('|');}}});sitools.user.component.entete.NavBar.superclass.initComponent.call(Ext.apply(this,{id:&quot;navBarId&quot;,enableOverflow:true,defaults:{overCls:&quot;x-navBar-items-over&quot;,ctCls:&quot;x-navBar-items-ct&quot;},items:items,cls:&quot;x-navBar&quot;,overCls:&quot;x-navBar-over&quot;,ctCls:&quot;x-navBar-ct&quot;,flex:1,listeners:{scope:this,afterRender:function(me){this.observer.fireEvent(&quot;navBarRendered&quot;,me);}},border:false}));},categorizeModules:function(){function getCategoryIndex(category,categoryList){var idx=-1;for(var i=0;i&lt;categoryList.length;i++){if(categoryList[i].category===category){return i;}}
return idx;}
var categoryModules=[];Ext.each(this.modules,function(module){if(Ext.isEmpty(module.categoryModule)){categoryModules.push({modules:[module]});}
else{var idx=getCategoryIndex(module.categoryModule,categoryModules);if(idx&gt;=0){categoryModules[idx].modules.push(module);}
else{categoryModules.push({category:module.categoryModule,modules:[module]});}}});return categoryModules;}});Ext.reg('sitools.user.component.entete.NavBar',sitools.user.component.entete.NavBar);Ext.namespace('sitools.user.component.entete');sitools.user.component.entete.NavBarButtons=Ext.extend(Ext.Toolbar,{profileButtonId:&quot;profileButtonId&quot;,initComponent:function(){var itemsButtons=[];if(!Ext.isEmpty(userLogin)){this.width='204px';}
this.profilButton=new Ext.Button({scope:this,handler:this.showProfil,iconCls:'navBarButtons-icon',cls:'navBarTransition',icon:&quot;/sitools/common/res/images/icons/navBarButtons/user-icon.png&quot;,tooltip:{html:i18n.get('label.profil'),anchor:'bottom',trackMouse:false},id:this.profileButtonId});itemsButtons.push(this.profilButton);this.versionButton=new Ext.Button({iconCls:'navBarButtons-icon',id:&quot;versionBtnId&quot;,icon:&quot;/sitools/common/res/images/icons/navBarButtons/version-icon.png&quot;,handler:function(){showVersion();},tooltip:{html:i18n.get('label.version'),anchor:'bottom',trackMouse:false}});itemsButtons.push(this.versionButton);if(!Ext.isEmpty(userLogin)){this.saveButton=new Ext.Button({scope:this,iconCls:'navBarButtons-icon',handler:this.saveAction,icon:&quot;/sitools/common/res/images/icons/navBarButtons/save-icon.png&quot;,tooltip:{html:i18n.get('label.save'),anchor:'bottom',trackMouse:false},id:&quot;saveBtnId&quot;});itemsButtons.push(this.saveButton);}
this.helpButton=new Ext.Button({iconCls:'navBarButtons-icon',scope:this,icon:&quot;/sitools/common/res/images/icons/navBarButtons/help-icon.png&quot;,handler:SitoolsDesk.showHelp,tooltip:{html:i18n.get('label.help'),anchor:'bottom',trackMouse:false}});itemsButtons.push(this.helpButton);this.maximizeButton=new Ext.Button({iconCls:'navBarButtons-icon',handler:function(){if(SitoolsDesk.desktopMaximizeMode){SitoolsDesk.getDesktop().minimize();}
else{SitoolsDesk.getDesktop().maximize();}},icon:SitoolsDesk.desktopMaximizeMode?&quot;/sitools/common/res/images/icons/navBarButtons/mini-icon.png&quot;:&quot;/sitools/common/res/images/icons/navBarButtons/maxi-icon.png&quot;,tooltip:{id:'tooltipId',html:SitoolsDesk.desktopMaximizeMode?i18n.get('label.maximize'):i18n.get('label.minimize'),anchor:'bottom',trackMouse:false,listeners:{show:function(tooltip){if(SitoolsDesk.desktopMaximizeMode){tooltip.update(i18n.get('label.minimize'));}
else{tooltip.update(i18n.get('label.maximize'));}}}}});itemsButtons.push(this.maximizeButton);sitools.user.component.entete.NavBarButtons.superclass.initComponent.call(Ext.apply(this,{id:'navBarButtonsId',enableOverflow:true,defaults:{overCls:&quot;x-navBar-items-over&quot;,ctCls:&quot;x-navBar-items-ct&quot;},items:itemsButtons,cls:&quot;x-navBar-buttons&quot;,overCls:&quot;x-navBar-over&quot;,ctCls:&quot;x-navBar-ct&quot;,width:this.width,listeners:{scope:this,maximizeDesktop:this.onMaximizeDesktop,minimizeDesktop:this.onMinimizeDesktop},border:false}));},onMaximizeDesktop:function(){this.maximizeButton.setIcon(&quot;/sitools/common/res/images/icons/navBarButtons/mini-icon.png&quot;);SitoolsDesk.desktopMaximizeMode=true;this.maximizeButton.tooltip.html=i18n.get('label.minimize');},onMinimizeDesktop:function(){this.maximizeButton.setIcon(&quot;/sitools/common/res/images/icons/navBarButtons/maxi-icon.png&quot;);SitoolsDesk.desktopMaximizeMode=false;this.maximizeButton.tooltip.html=i18n.get('label.maximize');},getMaximizeButton:function(){return this.maximizeButton;},showProfil:function(b,e){var win=new sitools.user.component.entete.UserProfile({buttonId:this.profileButtonId});win.show();},saveAction:function(btn,event){if(!Ext.isEmpty(userLogin)&amp;&amp;projectGlobal&amp;&amp;projectGlobal.isAdmin){var ctxMenu=new Ext.menu.Menu({items:['&lt;b class=&quot;menu-title&quot;&gt;'+i18n.get('label.chooseSaveType')+'&lt;/b&gt;','-',{text:i18n.get(&quot;label.myself&quot;),handler:function(){SitoolsDesk.app.saveWindowSettings();}},{text:i18n.get(&quot;label.publicUser&quot;),handler:function(){SitoolsDesk.app.saveWindowSettings(true);}},{text:i18n.get('label.deletePublicPref'),handler:function(){publicStorage.remove();}}]});ctxMenu.showAt([event.getXY()[0],SitoolsDesk.getEnteteEl().getHeight()]);}
else{SitoolsDesk.app.saveWindowSettings();}}});Ext.reg('sitools.user.component.entete.NavBarButtons',sitools.user.component.entete.NavBarButtons);Ext.namespace('sitools.user.component.entete');sitools.user.component.entete.UserProfile=Ext.extend(Ext.Window,{initComponent:function(){this.header=false;this.user=projectGlobal.user||{firstName:&quot;public&quot;,identifier:&quot;public&quot;,email:&quot;&amp;nbsp;&quot;};this.userPublic=this.user.identifier===&quot;public&quot;;var userLanguage=SitoolsDesk.app.language,userLargeIcon;Ext.each(projectGlobal.languages,function(language){if(userLanguage===language.localName){userLargeIcon=language.largeIcon;}});var freeDisk=0;var totalDisk=0;var userTasksRunning=0;var userTotalTasks=0;var data=[{identifier:&quot;language&quot;,name:i18n.get(&quot;label.langues&quot;),url:userLargeIcon,action:&quot;changeLanguage&quot;}];this.height=this.user.identifier===&quot;public&quot;?140:220;this.width=400;if(this.user.identifier!==&quot;public&quot;){data.push({identifier:&quot;editProfile&quot;,name:i18n.get(&quot;label.editProfile&quot;),url:'/sitools/common/res/images/icons/menu/regcrud.png',action:&quot;editProfile&quot;,comment:&quot;&quot;},{identifier:&quot;userDiskSpace&quot;,name:i18n.get('label.userDiskSpace'),url:'/sitools/common/res/images/icons/menu/dataAccess.png',action:&quot;showDisk&quot;,comment:String.format(i18n.get(&quot;label.userDiskUse&quot;),freeDisk,totalDisk)},{identifier:&quot;tasks&quot;,name:i18n.get(&quot;label.Tasks&quot;),url:&quot;/sitools/common/res/images/icons/menu/applications2.png&quot;,action:&quot;showTasks&quot;,comment:String.format(i18n.get(&quot;label.taskRunning&quot;),userTasksRunning,userTotalTasks)});}
var store=new Ext.data.JsonStore({fields:['name','url','action','comment','identifier'],data:data});var tpl=new Ext.XTemplate('&lt;tpl for=&quot;.&quot;&gt;','&lt;div class=&quot;userButtons&quot; id=&quot;{identifier}&quot;&gt;','&lt;div class=&quot;userButtons-thumb&quot;&gt;&lt;img src=&quot;{url}&quot; title=&quot;{name}&quot;&gt;&lt;/div&gt;','&lt;span class=&quot;userButtons-name&quot;&gt;{name}&lt;/span&gt;','&lt;span class=&quot;userButtons-comment&quot;&gt;{comment}&lt;/span&gt;&lt;/div&gt;','&lt;/tpl&gt;','&lt;div class=&quot;x-clear&quot;&gt;&lt;/div&gt;');var buttonsDataView=new Ext.DataView({store:store,cls:&quot;userButtonsDataview&quot;,tpl:tpl,autoHeight:true,width:this.userPublic?100:400,multiSelect:true,overClass:'x-view-over',emptyText:'No images to display',itemSelector:'div.userButtons',listeners:{scope:this,click:this.actionItemClick,afterRender:function(){this.fillDiskInformations();this.fillTaskInformations();}}});var userInfoStore=new Ext.data.JsonStore({fields:['firstName','lastName','image','email','identifier'],data:[Ext.apply(this.user,{&quot;image&quot;:&quot;/sitools/common/res/images/icons/menu/usersGroups.png&quot;})]});var logout=new Ext.Button({scope:this,text:i18n.get('label.logout'),handler:function(){utils_logout();}});var login=new Ext.Button({scope:this,cls:&quot;userProfileBtn&quot;,text:i18n.get('label.login'),handler:function(){var tmp=new sitools.userProfile.Login({closable:true,url:loadUrl.get('APP_URL')+'/login',register:loadUrl.get('APP_URL')+'/inscriptions/user',reset:loadUrl.get('APP_URL')+'/resetPassword'}).show();}});var register=new Ext.Button({scope:this,cls:&quot;userProfileBtn&quot;,text:i18n.get('label.register'),handler:function(){var register=new sitools.widget.Register({closable:true,url:&quot;/sitools/inscriptions/user&quot;,login:&quot;/sitools/login&quot;});register.show();}});var closeBtn=new Ext.Button({scope:this,icon:&quot;/sitools/common/res/images/icons/close-icon.png&quot;,handler:function(){this.destroy();},x:this.width-30,y:this.height*-1+1,style:{&quot;position&quot;:&quot;relative&quot;,&quot;height&quot;:16,&quot;width&quot;:16,&quot;z-index&quot;:200}});var displayInfo=new Ext.DataView({flex:1,logoutBtn:logout,loginBtn:login,closeBtn:closeBtn,registerBtn:register,cls:&quot;x-panel-body&quot;,tpl:new Ext.XTemplate('&lt;tpl for=&quot;.&quot;&gt;','&lt;div class=&quot;userProfileItem&quot; id=&quot;{identifier}&quot;&gt;','&lt;div class=&quot;userProfile userProfileItem-thumb&quot;&gt;&lt;img style=&quot;height:60px;&quot; src=&quot;{image}&quot; title=&quot;{name}&quot;&gt;&lt;/div&gt;','&lt;div class=&quot;userProfile&quot;&gt;&lt;span class=&quot;userProfileName&quot;&gt;{firstName} {lastName}&lt;/span&gt;','&lt;span class=&quot;userProfileEmail&quot;&gt;{email}&lt;/span&gt;','&lt;div id=&quot;logBtn&quot;&gt;&lt;/div&gt;','&lt;/div&gt;','&lt;/tpl&gt;','&lt;div class=&quot;x-clear&quot;&gt;&lt;/div&gt;'),store:userInfoStore,listeners:{scope:this,afterRender:function(me){if(this.user.identifier!==&quot;public&quot;){me.logoutBtn.render(&quot;logBtn&quot;);}
else{me.loginBtn.render(&quot;logBtn&quot;);me.registerBtn.render(&quot;logBtn&quot;);}
me.closeBtn.render(this.id);}}});sitools.user.component.entete.UserProfile.superclass.initComponent.call(Ext.apply(this,{id:&quot;userProfileWindow&quot;,header:false,stateful:false,shadow:false,layout:this.user.identifier===&quot;public&quot;?'hbox':'vbox',layoutConfig:{align:&quot;stretch&quot;},border:false,hideBorders:true,closable:false,x:Ext.getBody().getWidth()-400,y:SitoolsDesk.getEnteteEl().getHeight(),resizable:false,bodyBorder:false,listeners:{scope:this,beforeRender:function(){Ext.getBody().on(&quot;click&quot;,this.interceptOnClick,this);},beforeDestroy:function(me){Ext.getBody().un(&quot;click&quot;,this.interceptOnClick,this);Ext.getCmp(this.buttonId).enable();}},items:[displayInfo,{xtype:&quot;panel&quot;,items:[buttonsDataView]}]}));},interceptOnClick:function(evt,target){if(Ext.DomQuery.select(&quot;table[id=&quot;+this.buttonId+&quot;] button[id=&quot;+target.id+&quot;]&quot;).length===1){Ext.getCmp(this.buttonId).disable();return;}
if(this.isDescendant(Ext.DomQuery.select(&quot;div[id=userProfileWindow]&quot;)[0],target)){if(evt.shiftKey&amp;&amp;evt.ctrlKey){breakout().getBackToDesktop();}
return;}
this.destroy();},actionItemClick:function(dataView,index,node,e){try{var data=dataView.getSelectedRecords()[0].data;eval(&quot;this.&quot;+data.action).call(this,dataView,index,node,e);}
catch(err){return;}},isDescendant:function(parent,child){var node=child.parentNode;while(node!==null){if(node===parent){return true;}
node=node.parentNode;}
return false;},changeLanguage:function(dataView,index,node,e){var menuLangues=new Ext.menu.Menu({plain:true});Ext.each(projectGlobal.languages,function(language){menuLangues.add({text:language.displayName,scope:this,handler:function(){var callback=function(){Ext.util.Cookies.set('language',language.localName);window.location.reload();};var date=new Date();Ext.util.Cookies.set('language',language.localName,date.add(Date.MINUTE,20));var userPreferences={};userPreferences.language=language.localName;if(!Ext.isEmpty(userLogin)){userStorage.set(loadUrl.get('APP_PORTAL_URL'),&quot;/&quot;+DEFAULT_PREFERENCES_FOLDER+loadUrl.get('APP_PORTAL_URL'),userPreferences,callback);}else{window.location.reload();}},icon:language.image});},this);menuLangues.showAt([Ext.get(node.id).getLeft(),Ext.get(node.id).getBottom()]);},editProfile:function(dataView,index,node,e){if(this.user.identifier===&quot;public&quot;){return;}
var componentCfg={identifier:this.user.identifier,url:'/sitools/editProfile/'+this.user.identifier,handler:function(user){projectGlobal.user=user;}};var jsObj=sitools.userProfile.editProfile;var windowConfig={title:i18n.get('label.editProfile'),saveToolbar:false,iconCls:&quot;editProfile&quot;};SitoolsDesk.addDesktopWindow(windowConfig,componentCfg,jsObj,true);this.destroy();},showTasks:function(){var jsObj=sitools.user.component.entete.userProfile.tasks;var windowConfig={title:i18n.get('label.Tasks'),saveToolbar:false,iconCls:'tasks'};SitoolsDesk.addDesktopWindow(windowConfig,{},jsObj,true);this.destroy();},showDisk:function(){var jsObj=sitools.user.component.entete.userProfile.diskSpace;var windowConfig={title:i18n.get('label.userSpace'),saveToolbar:false,iconCls:&quot;diskSpace&quot;};SitoolsDesk.addDesktopWindow(windowConfig,{},jsObj,true);this.destroy();},fillDiskInformations:function(){var el=Ext.DomQuery.select(&quot;div[id='userDiskSpace'] span[class='userButtons-comment']&quot;)[0];if(Ext.isEmpty(el)){return;}
Ext.Ajax.request({method:&quot;GET&quot;,url:loadUrl.get('APP_URL')+loadUrl.get('APP_USERSTORAGE_USER_URL').replace(&quot;{identifier}&quot;,this.user.identifier)+&quot;/status&quot;,success:function(ret){var json=Ext.decode(ret.responseText);if(!json.success){return;}
var storage=json.userstorage.storage;var totalSpace=storage.quota;var usedSpace=storage.busyUserSpace;var pourcentage=usedSpace/totalSpace*100;var cls=null;if(pourcentage&gt;=90&amp;&amp;pourcentage&lt;100){Ext.get(&quot;userDiskSpace&quot;).addClass(&quot;sitools-userProfile-warning-icon&quot;);cls=&quot;sitools-userProfile-warning-text&quot;;}
else if(pourcentage&gt;100){Ext.get(&quot;userDiskSpace&quot;).addClass(&quot;sitools-userProfile-error-icon&quot;);cls=&quot;sitools-userProfile-error-text&quot;;}
var str=&quot;&quot;;if(!Ext.isEmpty(cls)){str+=&quot;&lt;span class='&quot;+cls+&quot;'&gt;&quot;;}
str+=String.format(i18n.get('label.diskSpace'),Ext.util.Format.round(pourcentage,0),Ext.util.Format.fileSize(totalSpace));if(!Ext.isEmpty(cls)){str+=&quot;&lt;/span&gt;&quot;;}
el.update(str);}});},fillTaskInformations:function(){var el=Ext.DomQuery.select(&quot;div[id='tasks'] span[class='userButtons-comment']&quot;)[0];if(Ext.isEmpty(el)){return;}
Ext.Ajax.request({method:&quot;GET&quot;,url:loadUrl.get('APP_URL')+loadUrl.get('APP_USERRESOURCE_ROOT_URL')+&quot;/&quot;+this.user.identifier+&quot;/tasks&quot;,success:function(ret){var json=Ext.decode(ret.responseText);if(!json.success){return;}
var runningTasks=0,totalTasks=0;Ext.each(json.data,function(task){if(task.status===&quot;TASK_STATUS_RUNNING&quot;||task.status===&quot;TASK_STATUS_PENDING&quot;){runningTasks++;}
totalTasks++;});if(runningTasks&gt;0){el.update(String.format(i18n.get('label.taskRunning'),runningTasks));}else{el.update(&quot;&quot;);}}});}});Ext.namespace('sitools.user.component.bottom');sitools.user.component.bottom.Bottom=Ext.extend(Ext.Panel,{heightNormalMode:0,heightMaximizeDesktopMode:0,forceLayout:true,layout:&quot;hbox&quot;,border:false,layoutConfig:{align:'stretch',pack:'start'},bodyCssClass:'sitools_footer',initComponent:function(){this.defaultBottom=Ext.get('x-bottom').dom.children.length===0;if(this.defaultBottom){this.renderTo='x-bottom';this.panelLeft=new Ext.Panel({border:false,flex:0.5,html:&quot;&lt;img id='sitools_logo' src='&quot;+loadUrl.get(&quot;APP_URL&quot;)+&quot;/res/images/logo_01_petiteTaille.png' alt='sitools_logo'/&gt;&quot;,bodyCssClass:'no-background',listeners:{scope:this,afterRender:function(){Ext.get(&quot;sitools_logo&quot;).on('load',function(){Ext.get(&quot;sitools_logo&quot;).alignTo(this.panelLeft.getEl(),&quot;c-c&quot;);},this);}}});this.panelMiddle=new Ext.Panel({border:false,flex:1,bodyCssClass:'no-background',items:[{xtype:&quot;panel&quot;,html:&quot;&lt;span style='color:white'&gt;&quot;+i18n.get(&quot;label.build_by_sitools2&quot;)+&quot;&lt;/span&gt;&quot;,id:'sitools_build_by',cls:&quot;sitools_footer_build_by&quot;,bodyCssClass:'no-background'}]});this.linkStore=new Ext.data.Store({fields:['name','url']});var linkDataview=new Ext.DataView({store:this.linkStore,tpl:new Ext.XTemplate('&lt;div class=&quot;sitools_footer_right&quot; id=&quot;sitools_footer_right&quot;&gt;','&lt;tpl for=&quot;.&quot;&gt;','&lt;a rel=&quot;contents&quot; href=&quot;#&quot; onclick=&quot;sitools.user.component.bottom.Bottom.showFooterLink(\'{url}\',\'{name}\');&quot;&gt;','{[this.getLabel(values.name)]}','&lt;/a&gt;','&lt;tpl if=&quot;(xindex &lt; xcount)&quot;&gt;',' | ','&lt;/tpl&gt;','&lt;/tpl&gt;','&lt;/div&gt;',{compiled:true,disableFormats:true,getLabel:function(labelName){return i18n.get(labelName);}})});this.panelRight=new Ext.Panel({border:false,flex:0.5,bodyCssClass:'no-background',items:[linkDataview]});this.items=[this.panelLeft,this.panelMiddle,this.panelRight];}
else{var el=Ext.get('x-bottom').createChild({tag:'div'});this.renderTo=el;}
sitools.user.component.bottom.Bottom.superclass.initComponent.call(Ext.apply(this,{listeners:{scope:this,afterRender:function(me){if(!this.defaultBottom){me.setHeight(0);}
else{var bottomEl=SitoolsDesk.getBottomEl();me.fillLinks();me.setHeight(bottomEl.getHeight());me.heightNormalMode=bottomEl.getHeight();me.doLayout();Ext.get(&quot;sitools_build_by&quot;).alignTo(this.panelMiddle.getEl(),&quot;bl-bl&quot;);var fr=Ext.get(&quot;sitools_footer_right&quot;);if(Ext.isDefined(fr)&amp;&amp;!Ext.isEmpty(fr)){fr.alignTo(this.panelRight.getEl(),&quot;c-c&quot;);}}},resize:function(me){if(!this.defaultBottom){me.setHeight(0);}
else{me.setSize(SitoolsDesk.getBottomEl().getSize());me.doLayout();Ext.get(&quot;sitools_logo&quot;).alignTo(this.panelLeft.getEl(),&quot;c-c&quot;);Ext.get(&quot;sitools_build_by&quot;).alignTo(this.panelMiddle.getEl(),&quot;bl-bl&quot;);var fr=Ext.get(&quot;sitools_footer_right&quot;);if(Ext.isDefined(fr)&amp;&amp;!Ext.isEmpty(fr)){fr.alignTo(this.panelRight.getEl(),&quot;c-c&quot;);}}},maximizeDesktop:this.onMaximizeDesktop,minimizeDesktop:this.onMinimizeDesktop}}));},onMaximizeDesktop:function(){this.container.setHeight(0);this.hide();this.doLayout();},onMinimizeDesktop:function(){this.container.dom.style.height=&quot;&quot;;this.setVisible(true);this.doLayout();},fillLinks:function(){var projectLinks=projectGlobal.links;Ext.each(projectLinks,function(value){this.linkStore.add(new Ext.data.Record(value));},this);}});sitools.user.component.bottom.Bottom.showFooterLink=function(url,linkName){var windowConfig={title:i18n.get(linkName),id:linkName,iconCls:&quot;version&quot;};var jsObj=Ext.ux.ManagedIFrame.Panel;var componentCfg={defaults:{padding:10},layout:'fit',region:'center',defaultSrc:url};SitoolsDesk.addDesktopWindow(windowConfig,componentCfg,jsObj);};Ext.reg('sitools.user.component.bottom.Bottom',sitools.user.component.bottom.Bottom);Ext.namespace('sitools.user.component.forms');sitools.user.component.forms.resultsProjectForm=Ext.extend(Ext.grid.GridPanel,{initComponent:function(){var params={};params.datasetsList=this.datasets.join(&quot;|&quot;);var i=0;if(!Ext.isEmpty(this.formMultiDsParams)){Ext.each(this.formMultiDsParams,function(param){params[&quot;c[&quot;+i+&quot;]&quot;]=param;i+=1;},this);}
var task=new Ext.util.DelayedTask(function(){return;});var store=new Ext.data.JsonStore({url:this.urlTask,baseParams:params,restful:true,root:'TaskModel.properties',fields:[{name:&quot;id&quot;,type:&quot;string&quot;},{name:&quot;name&quot;,type:&quot;string&quot;},{name:&quot;description&quot;,type:&quot;string&quot;},{name:&quot;image&quot;},{name:&quot;nbRecord&quot;},{name:&quot;url&quot;,type:&quot;string&quot;},{name:&quot;status&quot;,type:&quot;string&quot;},{name:&quot;errorMessage&quot;,type:&quot;string&quot;}],autoLoad:true,listeners:{scope:this,load:function(store,recs,options){task.cancel();if(store.reader.jsonData.TaskModel.status==&quot;TASK_STATUS_RUNNING&quot;||store.reader.jsonData.TaskModel.status==&quot;TASK_STATUS_PENDING&quot;){this.getBottomToolbar().setStatus({text:i18n.get('label.loading'),iconCls:'x-status-busy'});task.delay(MULTIDS_TIME_DELAY,function(){store.load();});}
else{Ext.Ajax.request({scope:this,url:this.urlTask,method:&quot;DELETE&quot;,success:function(ret){var callerCmp=Ext.getCmp(this.callerId);callerCmp.fireEvent(&quot;multiDsSearchDone&quot;);},failure:alertFailure});if(store.reader.jsonData.TaskModel.status==&quot;TASK_STATUS_FAILURE&quot;){this.getBottomToolbar().setStatus({text:store.reader.jsonData.TaskModel.customStatus,iconCls:'x-status-error'});}
else{this.getBottomToolbar().setStatus({text:i18n.get(&quot;label.requestDone&quot;),iconCls:'x-status-valid'});}}
store.each(function(record){var error=record.get(&quot;errorMessage&quot;);if(!Ext.isEmpty(error)){var index=store.indexOf(record);var htmlLineEl=this.getView().getRow(index);var el=Ext.get(htmlLineEl);var cls=&quot;x-form-invalid-tip&quot;;var ttConfig={html:error,dismissDelay:0,target:el,cls:cls};var ttip=new Ext.ToolTip(ttConfig);}},this);}}});var cm=new Ext.grid.ColumnModel({columns:[{width:25,dataIndex:'image',header:&quot;&quot;,renderer:function(value){return!Ext.isEmpty(value)&amp;&amp;!Ext.isEmpty(value.url)?String.format(&quot;&lt;img src='{0}' width=20 height=20&gt;&quot;,value.url):&quot;&quot;;}},{width:100,dataIndex:'name',header:i18n.get('label.name')},{width:100,dataIndex:'nbRecord',header:i18n.get('label.nbRecords')},{width:150,dataIndex:'description',header:i18n.get('label.description'),renderer:function(value,metaData,record,rowIndex,colIndex,store){metaData.attr=&quot;ext:qtip='&quot;+value+&quot;'&quot;;return value;}},{xtype:'actioncolumn',header:i18n.get('label.showData'),width:100,items:[{getClass:function(value,meta,rec){if(rec.get('status')==&quot;REQUEST_ERROR&quot;){return&quot;multids-error&quot;;}},icon:loadUrl.get('APP_URL')+'/common/res/images/icons/tree_datasets.png',tooltip:i18n.get('label.showData'),scope:this,handler:SitoolsDesk.navProfile.multiDataset.showDataset}]},{xtype:'actioncolumn',header:i18n.get('label.showDefinition'),width:100,items:[{icon:loadUrl.get('APP_URL')+'/common/res/images/icons/tree_dictionary.png',tooltip:i18n.get('label.showDefinition'),scope:this,handler:function(grid,rowIndex,colIndex){var rec=grid.getStore().getAt(rowIndex);if(Ext.isEmpty(rec)){return;}
sitools.user.clickDatasetIcone(rec.get(&quot;url&quot;),&quot;defi&quot;,{formMultiDsParams:this.formMultiDsParams});}}]}]});var bbar=new Ext.ux.StatusBar({text:i18n.get('label.ready'),iconCls:'x-status-valid'});Ext.apply(this,{cm:cm,store:store,layout:&quot;fit&quot;,bbar:bbar,listeners:{scope:this,viewready:function(grid){var callerCmp=Ext.getCmp(this.callerId);callerCmp.fireEvent(&quot;multiDsSeachDone&quot;);}},viewConfig:{forceFit:true,getRowClass:function(rec){if(rec.get('status')==&quot;REQUEST_ERROR&quot;){return&quot;red-row&quot;;}
if(rec.get('status')==&quot;UNAUTHORIZED&quot;){return&quot;orange-row&quot;;}}}});sitools.user.component.forms.resultsProjectForm.superclass.initComponent.call(this);}});Ext.reg('sitools.user.component.forms.resultsProjectForm',sitools.user.component.forms.resultsProjectForm);Ext.namespace('sitools.user.component.forms');sitools.user.component.forms.overviewResultsProjectForm=Ext.extend(Ext.Panel,{initComponent:function(){var results=new sitools.user.component.forms.resultsProjectForm(this);Ext.apply(results,{region:&quot;center&quot;});var description=i18n.get('label.descriptionMultiDS');this.southPanel=new Ext.TabPanel({title:i18n.get('label.results'),region:&quot;south&quot;,height:300,split:true,autoScroll:false,collapsible:false,collapsed:true});Ext.apply(this,{layout:&quot;border&quot;,items:[results,this.southPanel]});if(description!==&quot;label.descriptionMultiDS&quot;){this.items.unshift({xtype:'panel',height:100,html:description,padding:&quot;10px&quot;,region:&quot;north&quot;,collapsible:true,split:true,autoScroll:true,title:i18n.get('label.description')});}
sitools.user.component.forms.overviewResultsProjectForm.superclass.initComponent.call(this);}});Ext.reg('sitools.user.component.forms.overviewResultsProjectForm',sitools.user.component.forms.overviewResultsProjectForm);Ext.namespace('sitools.user.component.forms');sitools.user.component.forms.projectForm=Ext.extend(Ext.Panel,{initComponent:function(){var config=this;this.componentType=&quot;formProject&quot;;this.componentList=new sitools.user.component.formComponentsPanel({width:config.formWidth,height:config.formHeight,css:config.formCss,formId:config.formId});if(!Ext.isEmpty(config.formParameters)){this.componentList.loadParameters(config.formParameters,config.dataUrl,&quot;project&quot;);}
var displayComponentPanel=new Ext.Panel({title:i18n.get('label.formConcepts'),region:&quot;center&quot;,flex:2,autoScroll:true,items:[this.componentList],layout:&quot;absolute&quot;,listeners:{scope:this,resize:function(){if(!Ext.isEmpty(this.componentList.getEl())){var cmpChildSize=this.componentList.getSize();var size=this.body.getSize();var xpos=0,ypos=0;if(size.height&gt;cmpChildSize.height){ypos=(size.height-cmpChildSize.height)/2;}
if(size.width&gt;cmpChildSize.width){xpos=(size.width-cmpChildSize.width)/2;}
this.componentList.setPosition(xpos,ypos);}}}});this.propertyPanel=new Ext.form.FormPanel({title:i18n.get(&quot;label.defineProperties&quot;),padding:10,labelWidth:100,flex:2,autoScroll:true,defaults:{labelSeparator:&quot;&quot;},buttons:[{text:i18n.get('label.refreshDatasets'),scope:this,handler:this.propertySearch}]});if(!Ext.isEmpty(this.properties)){Ext.each(this.properties,function(prop){var field=this.buildPropertyField(prop);this.propertyPanel.add(field);},this);}
var storeDatasets=new Ext.data.JsonStore({restful:true,fields:[{name:&quot;id&quot;,type:&quot;string&quot;},{name:&quot;name&quot;,type:&quot;string&quot;},{name:&quot;visible&quot;,type:&quot;boolean&quot;}],url:projectGlobal.sitoolsAttachementForUsers+this.urlServicePropertiesSearch,root:&quot;collection.dataSets&quot;,listeners:{load:function(store,recs){Ext.each(recs,function(rec){rec.set(&quot;visible&quot;,true);});}},autoLoad:true});var visible=new Ext.grid.CheckColumn({header:i18n.get('headers.visible'),dataIndex:'visible',width:55});var cmDatasets=new Ext.grid.ColumnModel({columns:[{header:i18n.get('headers.name'),dataIndex:'name',width:120},visible]});var smDatasets=new Ext.grid.RowSelectionModel({singleSelect:true});this.datasetPanel=new Ext.grid.EditorGridPanel({title:i18n.get('label.defineDatasets'),store:storeDatasets,cm:cmDatasets,sm:smDatasets,flex:1,autoScroll:true,viewConfig:{forceFit:true},plugins:[visible]});var firstPanel=new Ext.Panel({height:300,items:[this.propertyPanel,this.datasetPanel],layout:&quot;hbox&quot;,collapsedTitle:i18n.get('label.advancedSearch'),region:&quot;north&quot;,collapsible:true,collapsed:true,flex:2,layoutConfig:{align:&quot;stretch&quot;}});this.searchButton=new Ext.Button({text:i18n.get('label.search'),scope:this,handler:function(button){this.onSearch(button);}});Ext.apply(this,{height:config.formHeight,layout:&quot;border&quot;,layoutConfig:{align:&quot;stretch&quot;},items:[firstPanel,displayComponentPanel],buttons:[this.searchButton],listeners:{scope:this,propertyChanged:function(){var properties=this.propertyPanel.items.items;var params={};var j=0;var k={};for(var i=0;i&lt;properties.length;i++){var prop=properties[i];if(!Ext.isEmpty(prop.getAPIValue())){params[&quot;k[&quot;+j+&quot;]&quot;]=prop.getAPIValue();j++;}}
this.datasetPanel.getStore().load({params:params});},multiDsSearchDone:function(){this.searchButton.setDisabled(false);}}});sitools.user.component.forms.projectForm.superclass.initComponent.call(this);},onSearch:function(button){button.setDisabled(true);var containers=this.find(&quot;stype&quot;,'sitoolsFormContainer');var formMultiDsParams=[];var glue=&quot;&quot;;var i=0;var datasets=[];this.datasetPanel.getStore().each(function(rec){if(rec.get(&quot;visible&quot;)){datasets.push(rec.get('id'));}});if(datasets.length&lt;=0){Ext.Msg.alert(i18n.get('label.error'),i18n.get('label.atLeastOneDataset'));button.setDisabled(false);return;}
if(!Ext.isEmpty(this.nbDatasetsMax)&amp;&amp;datasets.length&gt;this.nbDatasetsMax){Ext.Msg.alert(i18n.get('label.error'),String.format(i18n.get('label.toManyDatasetsAllowed'),this.nbDatasetsMax));button.setDisabled(false);return;}
Ext.each(containers,function(container){if(Ext.isFunction(container.getParameterValue)){var param=container.getParameterValue();if(!Ext.isEmpty(param)){formMultiDsParams.push(this.paramValueToApi(param));}}},this);var urlService=projectGlobal.sitoolsAttachementForUsers+this.urlServiceDatasetSearch;var params={};params.datasetsList=datasets.join(&quot;|&quot;);i=0;if(!Ext.isEmpty(formMultiDsParams)){Ext.each(formMultiDsParams,function(param){params[&quot;c[&quot;+i+&quot;]&quot;]=param;i+=1;},this);}
Ext.Ajax.request({method:&quot;POST&quot;,params:params,jsonData:{},scope:this,url:urlService,success:function(response){try{var json=Ext.decode(response.responseText);if(!json.success){Ext.Msg.alert(i18n.get('label.error'),json.message);return;}
var jsObj=SitoolsDesk.navProfile.multiDataset.getObjectResults();var componentCfg={urlTask:json.TaskModel.statusUrl,formId:this.formId,formMultiDsParams:formMultiDsParams,datasets:datasets,formName:this.formName,callerId:this.id};var windowConfig={id:&quot;windMultiDsResultForm&quot;+this.formId,title:i18n.get('label.MultiDsResultForm')+&quot; : &quot;+this.formName,saveToolbar:false,iconCls:&quot;dataviews&quot;};SitoolsDesk.addDesktopWindow(windowConfig,componentCfg,jsObj);}
catch(err){Ext.Msg.alert(i18n.get('label.error'),err);return;}},failure:alertFailure});var desktop=getDesktop();var win=desktop.getWindow(&quot;windMultiDsResultForm&quot;+this.formId);if(win){win.close();}},_getSettings:function(){return{objectName:&quot;projectForm&quot;,formId:this.formId,formName:this.formName,formParameters:this.formParameters,formWidth:this.formWidth,formHeight:this.formHeight,formCss:this.formCss,properties:this.properties,urlServicePropertiesSearch:this.urlServicePropertiesSearch,urlServiceDatasetSearch:this.urlServiceDatasetSearch,componentType:this.componentType,dictionaryName:this.dictionaryName,preferencesPath:this.preferencesPath,preferencesFileName:this.preferencesFileName};},paramValueToApi:function(paramValue){var stringParam=paramValue.type+&quot;|&quot;+this.dictionaryName+&quot;,&quot;+paramValue.code+&quot;|&quot;+paramValue.value;if(!Ext.isEmpty(paramValue.userDimension)&amp;&amp;!Ext.isEmpty(paramValue.userUnit)){stringParam+=&quot;|&quot;+paramValue.userDimension+&quot;|&quot;+paramValue.userUnit.unitName;}
return stringParam;},getSearchButton:function(){return this.searchButton;},buildPropertyField:function(prop){var field;switch(prop.type){case&quot;TEXTFIELD&quot;:field={xtype:&quot;textfield&quot;,name:prop.name,anchor:'98%',enableKeyEvents:true,fieldLabel:prop.name,getAPIValue:function(){if(Ext.isEmpty(this.getValue())){return null;}
return String.format(&quot;{0}|{1}|{2}&quot;,prop.type,prop.name,this.getValue());}};break;case&quot;NUMBER_FIELD&quot;:field={xtype:&quot;numberfield&quot;,name:prop.name,anchor:'98%',enableKeyEvents:true,fieldLabel:prop.name,getAPIValue:function(){if(Ext.isEmpty(this.getValue())){return null;}
return String.format(&quot;{0}|{1}|{2}&quot;,prop.type,prop.name,this.getValue());}};break;case&quot;NUMERIC_BETWEEN&quot;:field={xtype:'compositefield',defaults:{flex:1},msgTarget:'under',anchor:'98%',items:[{xtype:'numberfield',name:prop.name+&quot;deb&quot;,enableKeyEvents:true},{xtype:'numberfield',name:prop.name+&quot;fin&quot;}],fieldLabel:prop.name,getAPIValue:function(){var deb=this.items.itemAt(0).getValue();var fin=this.items.itemAt(1).getValue();if(Ext.isEmpty(deb)||Ext.isEmpty(fin)){return null;}
return String.format(&quot;{0}|{1}|{2}|{3}&quot;,prop.type,prop.name,deb,fin);}};break;case&quot;DATE_BETWEEN&quot;:field={xtype:'compositefield',defaults:{flex:1},msgTarget:'under',anchor:'98%',items:[{xtype:'datefield',name:prop.name+&quot;deb&quot;,enableKeyEvents:true,format:SITOOLS_DEFAULT_IHM_DATE_FORMAT,showTime:true},{xtype:'datefield',name:prop.name+&quot;fin&quot;,format:SITOOLS_DEFAULT_IHM_DATE_FORMAT,showTime:true}],fieldLabel:prop.name,getAPIValue:function(){var deb,fin;try{deb=this.items.itemAt(0).getValue().format(SITOOLS_DATE_FORMAT);fin=this.items.itemAt(1).getValue().format(SITOOLS_DATE_FORMAT);}
catch(err){return null;}
if(Ext.isEmpty(deb)||Ext.isEmpty(fin)){return null;}
return String.format(&quot;{0}|{1}|{2}|{3}&quot;,prop.type,prop.name,deb,fin);}};break;}
return field;},propertySearch:function(){var properties=this.propertyPanel.items.items;var params={};var j=0;var k={};for(var i=0;i&lt;properties.length;i++){var prop=properties[i];if(!Ext.isEmpty(prop.getAPIValue())){params[&quot;k[&quot;+j+&quot;]&quot;]=prop.getAPIValue();j++;}}
this.datasetPanel.getStore().load({params:params});this.datasetPanel.getView().refresh();}});Ext.namespace('sitools.user.component');sitools.user.component.formComponentsPanel=Ext.extend(Ext.Panel,{initComponent:function(){Ext.apply(this,{id:&quot;panelResultForm&quot;+this.formId,bodyCssClass:this.css,height:this.height,width:this.width,border:false,bodyBorder:false,layout:&quot;absolute&quot;,labelWidth:100,padding:10,items:[],parameters:[]});this.addEvents('componentChanged');this.on('componentChanged',function(formContainer,componentChanged){var childrens=formContainer.find(&quot;parentParam&quot;,componentChanged.parameterId);Ext.each(childrens,function(children){if(children.valueSelection=='D'){var store=children.find(&quot;stype&quot;,&quot;sitoolsFormItem&quot;)[0].store;var baseParams=store.baseParams;if(!Ext.isEmpty(componentChanged.getSelectedValue())){var filter=componentChanged.getParameterValue();baseParams[&quot;p[0]&quot;]=this.paramToAPI(filter);}
else{baseParams[&quot;p[0]&quot;]=null;}
store.baseParams=baseParams;children.setSelectedValue(null);store.reload({callback:function(){formContainer.fireEvent('componentChanged',formContainer,children);}});}},this);});this.listeners={scope:this,afterrender:function(){try{var cmpChildSize=this.getSize();var size=this.ownerCt.ownerCt.body.getSize();var xpos=0,ypos=0;if(size.height&gt;cmpChildSize.height){ypos=(size.height-cmpChildSize.height)/2;}
if(size.width&gt;cmpChildSize.width){xpos=(size.width-cmpChildSize.width)/2;}
this.setPosition(xpos,ypos);}
catch(err){return;}}};sitools.user.component.formComponentsPanel.superclass.initComponent.apply(this,arguments);},loadParameters:function(parameters,dataUrl,context){Ext.each(parameters,function(parameter){var y=Ext.isEmpty(parameter.ypos)?y+50:parameter.ypos;var x=Ext.isEmpty(parameter.xpos)?x:parameter.xpos;var containerItems=[sitools.common.forms.formParameterToComponent(parameter,dataUrl,this.formId,this.datasetCm,context).component];var container=new Ext.Container({width:parameter.width,height:parameter.height,x:x,y:y,bodyCssClass:&quot;noborder&quot;,cls:parameter.css,items:containerItems});this.add(container);},this);},paramToAPI:function(paramValue){var stringParam=paramValue.type+&quot;|&quot;+paramValue.code+&quot;|&quot;+paramValue.value;if(!Ext.isEmpty(paramValue.userDimension)&amp;&amp;!Ext.isEmpty(paramValue.userUnit)){stringParam+=&quot;|&quot;+paramValue.userDimension+&quot;|&quot;+paramValue.userUnit.unitName;}
return stringParam;}});Ext.reg('sitools.user.component.formComponentsPanel',sitools.user.component.formComponentsPanel);Ext.namespace('sitools.user.component.forms');sitools.user.component.forms.mainContainer=function(config){Ext.apply(this,config);this.componentType=&quot;form&quot;;this.componentList=new sitools.user.component.formComponentsPanel({width:config.formWidth,height:config.formHeight,css:config.formCss,formId:config.formId});if(Ext.isEmpty(config.dataset)){Ext.Ajax.request({url:config.dataUrl,method:&quot;GET&quot;,scope:this,success:function(ret){if(showResponse(ret)){var json=Ext.decode(ret.responseText);this.componentList.datasetCm=json.dataset.columnModel;this.componentList.loadParameters(config.formParameters,config.dataUrl,&quot;dataset&quot;);this.datasetId=json.dataset.id;this.datasetName=json.dataset.name;this.datasetCm=json.dataset.columnModel;this.datasetView=json.dataset.datasetView;this.dictionaryMappings=json.dataset.dictionaryMappings;}}});}
else{this.componentList.datasetCm=config.dataset.columnModel;this.componentList.loadParameters(config.formParameters,config.dataUrl,&quot;dataset&quot;);this.datasetId=config.dataset.id;this.datasetName=config.dataset.name;this.datasetCm=config.dataset.columnModel;this.datasetView=config.dataset.datasetView;this.dictionaryMappings=config.dataset.dictionaryMappings;}
sitools.user.component.forms.mainContainer.superclass.constructor.call(this,Ext.apply({height:config.formHeight,width:config.formWidth,autoScroll:true,bodyBorder:false,border:false,items:[this.componentList],layout:&quot;absolute&quot;,buttons:[{text:i18n.get('label.search'),scope:this,handler:function(){this.onSearch(config);}}],listeners:{scope:this,resize:function(){if(!Ext.isEmpty(this.componentList.getEl())){var cmpChildSize=this.componentList.getSize();var size=this.body.getSize();var xpos=0,ypos=0;if(size.height&gt;cmpChildSize.height){ypos=(size.height-cmpChildSize.height)/2;}
if(size.width&gt;cmpChildSize.width){xpos=(size.width-cmpChildSize.width)/2;}
this.componentList.setPosition(xpos,ypos);}}}}));};Ext.extend(sitools.user.component.forms.mainContainer,Ext.Panel,{onSearch:function(config){Ext.Ajax.request({url:config.dataUrl,method:&quot;GET&quot;,scope:this,success:function(ret){var Json=Ext.decode(ret.responseText);if(!Json.success){Ext.Msg.alert(i18n.get('label.warning'),Json.message);return;}else{var dataset=Json.dataset;this.doSearch(config,dataset);}},failure:alertFailure});},doSearch:function(config,dataset){var containers=this.find(&quot;stype&quot;,'sitoolsFormContainer');var formParams=[];var glue=&quot;&quot;;var i=0;Ext.each(containers,function(container){if(Ext.isFunction(container.getParameterValue)){var param=container.getParameterValue();if(!Ext.isEmpty(param)){formParams.push(this.paramValueToApi(param));}}},this);var desktop=getDesktop();var win=desktop.getWindow(&quot;windResultForm&quot;+config.formId);if(win){win.close();}
if(Ext.isFunction(this.searchAction)){this.searchAction(formParams,dataset,this.scope);}
else{this.defaultSearchAction(formParams,dataset);}},defaultSearchAction:function(formParams,dataset){var jsObj=eval(dataset.datasetView.jsObject);var componentCfg={dataUrl:dataset.sitoolsAttachementForUsers,datasetId:dataset.id,datasetCm:dataset.columnModel,datasetName:dataset.name,formParams:formParams,dictionaryMappings:dataset.dictionaryMappings,datasetViewConfig:dataset.datasetViewConfig,preferencesPath:&quot;/&quot;+dataset.name,preferencesFileName:&quot;datasetView&quot;};var windowConfig={title:i18n.get('label.dataTitle')+&quot; : &quot;+dataset.name,datasetName:dataset.name,type:&quot;data&quot;,saveToolbar:true,iconCls:&quot;dataviews&quot;};SitoolsDesk.addDesktopWindow(windowConfig,componentCfg,jsObj);},_getSettings:function(){return{objectName:&quot;forms&quot;,dataUrl:this.dataUrl,dataset:this.dataset,formId:this.formId,formName:this.formName,formParameters:this.formParameters,formWidth:this.formWidth,formHeight:this.formHeight,formCss:this.formCss,datasetView:this.datasetView,dictionaryMappings:this.dictionaryMappings,preferencesPath:this.preferencesPath,preferencesFileName:this.preferencesFileName};},paramValueToApi:function(paramValue){var stringParam=paramValue.type+&quot;|&quot;+paramValue.code+&quot;|&quot;+paramValue.value;if(!Ext.isEmpty(paramValue.userDimension)&amp;&amp;!Ext.isEmpty(paramValue.userUnit)){stringParam+=&quot;|&quot;+paramValue.userDimension+&quot;|&quot;+paramValue.userUnit.unitName;}
return stringParam;}});Ext.namespace('sitools.user.component');sitools.user.component.datasetOpensearch=function(config){Ext.apply(this,config);var uri=config.dataUrl+&quot;/opensearch/search&quot;;var uriSuggest=config.dataUrl+&quot;/opensearch/suggest&quot;;function _clickOnSearch(){var searchQuery=formPanel.getForm().getValues().searchQuery;result.updateStore(uri+&quot;?q=&quot;+searchQuery);}
var search;var ds=new Ext.data.JsonStore({url:uriSuggest,restful:true,root:'data',fields:[{name:'field',type:'string'},{name:'name',type:'string'},{name:'nb',type:'string'}]});var resultTpl=new Ext.XTemplate('&lt;tpl for=&quot;.&quot;&gt;&lt;div class=&quot;search-item&quot;&gt;','&lt;h3&gt;{name}&lt;span&gt; ({field} / {nb} results ) &lt;/span&gt;&lt;/h3&gt;','&lt;/div&gt;&lt;/tpl&gt;');search=new Ext.form.ComboBox({store:ds,displayField:'name',typeAhead:false,loadingText:i18n.get(&quot;label.searching&quot;),hideTrigger:true,name:'searchQuery',anchor:&quot;90%&quot;,tpl:resultTpl,itemSelector:'div.search-item',minChars:2,queryParam:'q',enableKeyEvents:true,scope:this,listeners:{scope:this,beforequery:function(queryEvent){if(queryEvent.query.indexOf(&quot; &quot;)==-1){return true;}else{return false;}},specialkey:function(field,e){if(e.getKey()==e.ENTER){_clickOnSearch();}},beforeselect:function(self,record,index){var tabName=record.data.name.split(':');if(tabName.length&gt;1){record.data.name=tabName[1];}
record.data.name=record.data.field+&quot;:&quot;+record.data.name;return true;}}});var link=new Ext.Button({icon:loadUrl.get('APP_URL')+'/common/res/images/icons/help.png',scope:this,handler:function(){var helpModule=SitoolsDesk.app.findModule(&quot;helpWindow&quot;);if(!Ext.isEmpty(helpModule.getWindow())){helpModule.getWindow().close();}
helpModule.openModule({activeNode:&quot;Recherche_OpenSearch&quot;});},width:20});var field=new Ext.form.CompositeField({fieldLabel:i18n.get(&quot;label.search&quot;),anchor:'100%',defaults:{flex:1},items:[search,link]});var items=field;var buttonForm=[{text:i18n.get(&quot;label.search&quot;),scope:this,handler:_clickOnSearch}];var formPanel=new Ext.FormPanel({labelWidth:75,height:75,frame:true,defaultType:'textfield',items:items,buttons:buttonForm});var result=new sitools.user.component.openSearchResultFeed({input:search,dataUrl:config.dataUrl,pagging:true,datasetName:config.datasetName,datasetId:config.datasetId,exceptionHttpHandler:function(proxy,type,action,options,response,args){if((response.status==403)&amp;&amp;!Ext.isEmpty(Ext.util.Cookies.get('hashCode'))){Ext.MessageBox.minWidth=360;Ext.MessageBox.alert(i18n.get('label.session.expired'),response.responseText);return false;}
return true;}});sitools.user.component.datasetOpensearch.superclass.constructor.call(this,Ext.apply({items:[formPanel,result],layout:'vbox',datasetName:config.datasetName,layoutConfig:{align:'stretch',pack:'start'}},config));};Ext.extend(sitools.user.component.datasetOpensearch,Ext.Panel,{componentType:&quot;openSearch&quot;,_getSettings:function(){return{objectName:&quot;datasetOpenSearch&quot;,datasetName:this.datasetName,preferencesPath:this.preferencesPath,preferencesFileName:this.preferencesFileName};}});Ext.reg('sitools.user.component.datasetOpensearch',sitools.user.component.datasetOpensearch);Ext.namespace('sitools.user.component');sitools.user.component.openSearchResultFeed=function(config){this.pageSize=10;var urlParam=config.urlFeed;this.input=config.input;this.uriRecords=config.dataUrl+&quot;/records&quot;;var pagging=config.pagging;var url=(urlParam===undefined)?&quot;/tmp&quot;:urlParam;var exceptionHttpHandler=(Ext.isEmpty(config.exceptionHttpHandler))?onRequestFeedException:config.exceptionHttpHandler;this.httpProxy=new Ext.data.HttpProxy({url:url,restful:true,listeners:{scope:this,exception:exceptionHttpHandler}});this.xmlReader=new sitools.component.users.datasets.XmlReader({record:'item',totalProperty:'opensearch:totalResults'},['title','link','guid','pubDate','description']);this.store=new Ext.data.Store({proxy:this.httpProxy,reader:this.xmlReader,autoLoad:config.autoLoad,paramNames:{start:'start',limit:'rows'},listeners:{scope:this,load:function(self,records,index){if(!pagging&amp;&amp;!Ext.isEmpty(this.displayNbResults)){this.displayNbResults.setText('Total number of results : '+this.store.getTotalCount());}
return true;},exception:function(proxy,type,action,options,response,arg){var data=Ext.decode(response.responseText);if(!data.success){this.input.markInvalid(i18n.get(data.message));this.store.removeAll();}
return true;}}});this.store.setDefaultSort('pubDate',&quot;DESC&quot;);var columns=[{id:'title',header:&quot;Title&quot;,dataIndex:'title',sortable:true,renderer:this.formatTitle},{id:'last',header:&quot;Date&quot;,dataIndex:'pubDate',renderer:this.formatDate,sortable:true}];if(pagging){this.bbar={xtype:'paging',pageSize:this.pageSize,store:this.store,displayInfo:true,displayMsg:i18n.get('paging.display'),emptyMsg:i18n.get('paging.empty'),totalProperty:'totalCount'};}else{this.displayNbResults=new Ext.form.Label({text:'Total number of results : '});this.bbar={items:['-&gt;',this.displayNbResults]};}
function clickOnRow(self,rowIndex,e){e.stopEvent();var rec=self.store.getAt(rowIndex);var guid=rec.get(&quot;guid&quot;);if(Ext.isEmpty(guid)){Ext.Msg.alert(i18n.get('label.warning'),i18n.get('warning.noGuidFieldDefined')+&quot;&lt;br/&gt;&quot;+i18n.get('warning.noPrimaryKeyDefinedOSNotice'));return;}
if(Ext.isEmpty(window)||Ext.isEmpty(window.SitoolsDesk)){var component=new sitools.user.component.simpleViewDataDetail({fromWhere:&quot;openSearch&quot;,urlDataDetail:guid});var win=new Ext.Window({stateful:false,title:i18n.get('label.viewDataDetail'),width:400,height:600,shim:false,animCollapse:false,constrainHeader:true,layout:'fit'});win.add(component);win.show();}else{var componentCfg={grid:this,fromWhere:&quot;openSearch&quot;,datasetId:config.datasetId,datasetUrl:config.dataUrl,datasetName:config.datasetName,preferencesPath:&quot;/&quot;+config.datasetName,preferencesFileName:&quot;dataDetails&quot;};var jsObj=sitools.user.component.viewDataDetail;var windowConfig={id:&quot;dataDetail&quot;+config.datasetId,title:i18n.get('label.viewDataDetail')+&quot; : &quot;+config.datasetName,datasetName:config.datasetName,iconCls:&quot;openSearch&quot;,saveToolbar:true,type:&quot;dataDetail&quot;,toolbarItems:[{icon:loadUrl.get('APP_URL')+&quot;/common/res/images/icons/simple-arrow-left.png&quot;,handler:function(){this.ownerCt.ownerCt.items.items[0].goPrevious();}},{icon:loadUrl.get('APP_URL')+&quot;/common/res/images/icons/simple-arrow-right.png&quot;,handler:function(){this.ownerCt.ownerCt.items.items[0].goNext();}}]};SitoolsDesk.addDesktopWindow(windowConfig,componentCfg,jsObj,true);}}
sitools.user.component.openSearchResultFeed.superclass.constructor.call(this,{columns:columns,layout:'fit',flex:1,store:this.store,loadMask:{msg:i18n.get(&quot;label.loadingFeed&quot;)},sm:new Ext.grid.RowSelectionModel({singleSelect:true}),autoExpandColumn:'title',viewConfig:{forceFit:true,enableRowBody:true,showPreview:true,getRowClass:this.applyRowClass},listeners:{rowdblclick:clickOnRow}});this.updateStore=function(url){this.httpProxy.setUrl(url,true);this.store.load();};};Ext.extend(sitools.user.component.openSearchResultFeed,Ext.grid.GridPanel,{componentType:&quot;feeds&quot;,applyRowClass:function(record,rowIndex,p,ds){if(this.showPreview){var xf=Ext.util.Format;p.body='&lt;p class=sous-titre-flux&gt;'+xf.ellipsis(xf.stripTags(record.data.description),200)+'&lt;/p&gt;';return'x-grid3-row-expanded';}
return'x-grid3-row-collapsed';},formatDate:function(date){if(!date){return'';}
var now=new Date();var d=now.clearTime(true);if(date instanceof Date){var notime=date.clearTime(true).getTime();if(notime==d.getTime()){return'Today '+date.dateFormat('g:i a');}
d=d.add('d',-6);if(d.getTime()&lt;=notime){return date.dateFormat('D g:i a');}
return date.dateFormat('n/j g:i a');}
else{return date;}},formatTitle:function(value,p,record){var link=record.data.link;var xf=Ext.util.Format;var res=&quot;&quot;;if(link!==undefined&amp;&amp;link!==&quot;&quot;){res=String.format('&lt;div class=&quot;topic&quot;&gt;&lt;a href=&quot;{0}&quot; title=&quot;{1}&quot;&gt;&lt;span class=&quot;rss_feed_title&quot;&gt;{2}&lt;/span&gt;&lt;/a&gt;&lt;/div&gt;',link,value,xf.ellipsis(xf.stripTags(value),30));}else{res=String.format('&lt;div class=&quot;topic&quot;&gt;&lt;span class=&quot;rss_feed_title&quot;&gt;{0}&lt;/span&gt;&lt;/div&gt;',xf.ellipsis(xf.stripTags(value),30));}
return res;}});Ext.reg('sitools.user.component.openSearchResultFeed',sitools.user.component.openSearchResultFeed);Ext.namespace('sitools.user.component');sitools.user.component.viewDataDetail=Ext.extend(Ext.Panel,{datasetColumnModel:null,initComponent:function(){var rec;switch(this.fromWhere){case&quot;openSearch&quot;:this.grid=this.grid;this.recSelected=this.grid.getSelectionModel().getSelected();this.url=this.recSelected.data.guid;break;case&quot;dataView&quot;:break;case&quot;plot&quot;:break;default:this.recSelected=this.selections[0];if(Ext.isEmpty(this.recSelected)){Ext.Msg.alert(i18n.get('label.error'),i18n.get('label.noSelection'));return;}
var primaryKeyValue=&quot;&quot;,primaryKeyName=&quot;&quot;;Ext.each(this.recSelected.fields.items,function(field){if(field.primaryKey){this.primaryKeyName=field.name;}},this);this.primaryKeyValue=this.recSelected.get(this.primaryKeyName);this.primaryKeyValue=encodeURIComponent(this.primaryKeyValue);this.url=this.baseUrl+this.primaryKeyValue;break;}
this.layout=&quot;border&quot;;this.linkStore=new Ext.data.Store({fields:['name','value','image','behavior','columnRenderer']});var linkDataview=new Ext.DataView({store:this.linkStore,tpl:new Ext.XTemplate('&lt;ul&gt;','&lt;tpl for=&quot;.&quot;&gt;','&lt;li id=&quot;{name}&quot; class=&quot;img-link&quot;','&lt;tpl if=&quot;this.hasToolTip(toolTip)&quot;&gt;','ext:qtip=&quot;{toolTip}&quot;&gt;','&lt;/tpl&gt;','&lt;tpl if=&quot;this.hasToolTip(toolTip) == false&quot;&gt;','ext:qtip=&quot;{name}&quot;&gt;','&lt;/tpl&gt;','&lt;img src=&quot;{image}&quot; /&gt;','&lt;/li&gt;','&lt;/tpl&gt;','&lt;/ul&gt;',{compiled:true,disableFormats:true,hasToolTip:function(toolTip){return!Ext.isEmpty(toolTip);}}),cls:'linkImageDataView',itemSelector:'li.img-link',overClass:'nodes-hover',selectedClass:'',singleSelect:true,multiSelect:false,autoScroll:true,listeners:{scope:this,click:this.handleClickOnLink}});this.formPanel=new Ext.FormPanel({labelAlign:&quot;top&quot;,anchor:&quot;100%&quot;,defaults:{labelStyle:'font-weight:bold;'},padding:10});this.linkPanel=new Ext.Panel({title:i18n.get(&quot;label.complementaryInformation&quot;),items:[linkDataview],anchor:&quot;100%&quot;});this.formPanelImg=new Ext.FormPanel({frame:true,autoScroll:true,region:&quot;east&quot;,hideLabels:true,split:(this.fromWhere!='dataView'),collapsible:(this.fromWhere!='dataView'),collapsed:(this.fromWhere!='dataView'),flex:1,title:(this.fromWhere=='dataView')?i18n.get(&quot;label.formImagePanelTitle&quot;):null});var centerPanelItems;if(this.fromWhere=='dataView'){centerPanelItems=[this.formPanel,this.formPanelImg,this.linkPanel];}
else{centerPanelItems=[this.formPanel,this.linkPanel];}
this.centerPanel=new Ext.Panel({autoScroll:true,frame:true,region:&quot;center&quot;,split:true,layout:{type:'anchor'},items:centerPanelItems});this.getCmDefAndbuildForm();this.componentType='dataDetail';if(this.fromWhere=='dataView'){this.items=[this.centerPanel];}
else{this.items=[this.centerPanel,this.formPanelImg];}
this.listeners={scope:this,afterrender:function(panel){panel.getEl().on(&quot;contextmenu&quot;,function(e,t,o){e.stopPropagation();},this);}};sitools.user.component.viewDataDetail.superclass.initComponent.call(this);},afterRender:function(){this._loadMaskAnchor=Ext.get(this.body.dom);sitools.user.component.viewDataDetail.superclass.afterRender.apply(this,arguments);},_getSettings:function(){return{objectName:&quot;viewDataDetail&quot;,preferencesPath:this.preferencesPath,preferencesFileName:this.preferencesFileName};},goNext:function(){if(Ext.isEmpty(this.grid)){return;}
var rec,rowSelect;switch(this.fromWhere){case&quot;openSearch&quot;:rowSelect=this.grid.getSelectionModel();if(!rowSelect.selectNext()){return;}
rec=rowSelect.getSelected();this.url=rec.data.guid;break;case&quot;sitools.user.component.dataviews.tplView.TplView&quot;:var index=this.grid.getStore().indexOf(this.recSelected);var nextRec=this.grid.getStore().getAt(index+1);if(Ext.isEmpty(nextRec)){return;}
this.primaryKeyValue=nextRec.get(this.primaryKeyName);this.primaryKeyValue=encodeURIComponent(this.primaryKeyValue);this.url=this.baseUrl+this.primaryKeyValue;this.recSelected=nextRec;this.grid.select(nextRec);break;default:rowSelect=this.grid.getSelectionModel();if(!rowSelect.selectNext()){return;}
rec=rowSelect.getSelected();this.primaryKeyValue=rec.get(this.primaryKeyName);this.primaryKeyValue=encodeURIComponent(this.primaryKeyValue);this.url=this.baseUrl+this.primaryKeyValue;break;}
this.getCmDefAndbuildForm();},goPrevious:function(){if(Ext.isEmpty(this.grid)){return;}
var rec,rowSelect;switch(this.fromWhere){case&quot;openSearch&quot;:rowSelect=this.grid.getSelectionModel();if(!rowSelect.selectPrevious()){return;}
rec=rowSelect.getSelected();this.url=rec.data.guid;break;case&quot;sitools.user.component.dataviews.tplView.TplView&quot;:var index=this.grid.getStore().indexOf(this.recSelected);var nextRec=this.grid.getStore().getAt(index-1);if(Ext.isEmpty(nextRec)){return;}
this.primaryKeyValue=nextRec.get(this.primaryKeyName);this.primaryKeyValue=encodeURIComponent(this.primaryKeyValue);this.url=this.baseUrl+this.primaryKeyValue;this.recSelected=nextRec;this.grid.select(nextRec);break;default:rowSelect=this.grid.getSelectionModel();if(!rowSelect.selectPrevious()){return;}
rec=rowSelect.getSelected();this.primaryKeyValue=rec.get(this.primaryKeyName);this.primaryKeyValue=encodeURIComponent(this.primaryKeyValue);this.url=this.baseUrl+this.primaryKeyValue;break;}
this.getCmDefAndbuildForm();},getCmDefAndbuildForm:function(){if(Ext.isEmpty(this.datasetColumnModel)){Ext.Ajax.request({url:this.datasetUrl,method:'GET',scope:this,success:function(ret){try{var Json=Ext.decode(ret.responseText);if(!Json.success){throw Json.message;}
this.datasetColumnModel=Json.dataset.columnModel;this.buildForm();}
catch(err){Ext.Msg.alert(i18n.get('label.error'),err);}},failure:alertFailure});}
else{this.buildForm();}},buildForm:function(){if(!Ext.isEmpty(this._loadMaskAnchor)){this._loadMaskAnchor.mask(i18n.get('label.waitMessage'),&quot;x-mask-loading&quot;);}
if(!Ext.isEmpty(this.url)){this.linkStore.removeAll();Ext.Ajax.request({url:this.url,method:'GET',scope:this,success:function(ret){var data=Ext.decode(ret.responseText);var itemsForm=[];var itemsFormImg=[];if(!data.success){Ext.Msg.alert(i18n.get('label.information'),&quot;Server error&quot;);return false;}
var record=data.record;var id=record.id;var attributes=record.attributeValues;if(attributes!==undefined){var i;for(i=0;i&lt;attributes.length;i++){var name=attributes[i].name;var column=this.findColumn(name);var value=attributes[i].value;var valueFormat=value;if(sql2ext.get(column.sqlColumnType)=='dateAsString'){valueFormat=sitools.user.component.dataviews.dataviewUtils.formatDate(value,column);}
if(sql2ext.get(column.sqlColumnType)=='boolean'){valueFormat=value?i18n.get('label.true'):i18n.get('label.false');}
var item=new Ext.BoxComponent({fieldLabel:column.header,labelSeparator:&quot;&quot;,html:(Ext.isEmpty(valueFormat)||!Ext.isFunction(valueFormat.toString))?valueFormat:valueFormat.toString()});if(Ext.isEmpty(column)||Ext.isEmpty(column.columnRenderer)){itemsForm.push(item);}
else{var columnRenderer=column.columnRenderer;var behavior=&quot;&quot;;if(!Ext.isEmpty(column.columnRenderer)){behavior=column.columnRenderer.behavior;var html=sitools.user.component.dataviews.dataviewUtils.getRendererHTML(column,{});switch(behavior){case ColumnRendererEnum.URL_LOCAL:case ColumnRendererEnum.URL_EXT_NEW_TAB:case ColumnRendererEnum.URL_EXT_DESKTOP:case ColumnRendererEnum.DATASET_ICON_LINK:if(!Ext.isEmpty(value)){if(!Ext.isEmpty(columnRenderer.linkText)){item=new Ext.BoxComponent({fieldLabel:column.header,labelSeparator:&quot;&quot;,html:String.format(html,value)});itemsForm.push(item);}else if(!Ext.isEmpty(columnRenderer.image)){var rec={name:name,value:value,image:columnRenderer.image.url,behavior:behavior,columnRenderer:columnRenderer,toolTip:columnRenderer.toolTip};rec=new Ext.data.Record(rec);this.linkStore.add(rec);}}
break;case ColumnRendererEnum.IMAGE_FROM_SQL:case ColumnRendererEnum.IMAGE_THUMB_FROM_IMAGE:if(!Ext.isEmpty(value)){var tooltip=&quot;&quot;;var imageUrl=&quot;&quot;;if(Ext.isEmpty(columnRenderer.toolTip)){tooltip=columnRenderer.toolTip;}
else{tooltip=col.header;}
if(!Ext.isEmpty(columnRenderer.url)){imageUrl=columnRenderer.url;}else if(!Ext.isEmpty(columnRenderer.columnAlias)){imageUrl=this.findRecordValue(record,columnRenderer.columnAlias);}
item=new Ext.BoxComponent({html:String.format(html,value,imageUrl),tooltip:tooltip,cls:&quot;x-form-item&quot;});}
itemsFormImg.push(item);break;case ColumnRendererEnum.NO_CLIENT_ACCESS:break;default:item=new Ext.BoxComponent({fieldLabel:column.header,labelSeparator:&quot;&quot;,html:String.format(html,value)});itemsForm.push(item);break;}}}}
this.formPanel.removeAll();this.formPanelImg.removeAll();this.formPanel.add(itemsForm);this.formPanel.doLayout();if(this.linkStore.getCount()===0){this.linkPanel.setVisible(false);}else{this.linkPanel.setVisible(true);this.linkPanel.doLayout();}
if(itemsFormImg.length===0){this.formPanelImg.setVisible(false);}else{this.formPanelImg.add(itemsFormImg);this.formPanelImg.setVisible(true);this.linkPanel.doLayout();}
this.doLayout();if(this._loadMaskAnchor&amp;&amp;this._loadMaskAnchor.isMasked()){this._loadMaskAnchor.unmask();}}},failure:function(){alertFailure();if(this._loadMaskAnchor&amp;&amp;this._loadMaskAnchor.isMasked()){this._loadMaskAnchor.unmask();}}});}},findColumn:function(columnAlias){var result=null;Ext.each(this.datasetColumnModel,function(column){if(column.columnAlias==columnAlias){result=column;return;}},this);return result;},findRecordValue:function(record,columnAlias){var result=null;Ext.each(record.attributeValues,function(attr){if(attr.name==columnAlias){result=attr.value;return;}},this);return result;},handleClickOnLink:function(dataView,index,node,e){var data=dataView.getRecord(node).data;var behavior=data.behavior;switch(behavior){case ColumnRendererEnum.URL_LOCAL:sitools.user.component.dataviews.dataviewUtils.downloadData(data.value);break;case ColumnRendererEnum.URL_EXT_NEW_TAB:window.open(data.value);break;case ColumnRendererEnum.URL_EXT_DESKTOP:sitools.user.component.dataviews.dataviewUtils.showDisplayableUrl(data.value,data.columnRenderer.displayable);break;case ColumnRendererEnum.DATASET_ICON_LINK:sitools.user.component.dataviews.dataviewUtils.showDetailsData(data.value,data.columnRenderer.columnAlias,data.columnRenderer.datasetLinkUrl);break;default:break;}},showMeInFixedNav:function(me,config){Ext.apply(config.windowSettings,{width:config.windowSettings.winWidth||DEFAULT_WIN_WIDTH,height:config.windowSettings.winHeight||DEFAULT_WIN_HEIGHT});SitoolsDesk.openModalWindow(me,config);},showMeInDesktopNav:function(me,config){Ext.apply(config.windowSettings,{width:config.windowSettings.winWidth||DEFAULT_WIN_WIDTH,height:config.windowSettings.winHeight||DEFAULT_WIN_HEIGHT});SitoolsDesk.openModalWindow(me,config);}});Ext.namespace('sitools.user.component');sitools.user.component.simpleViewDataDetail=Ext.extend(Ext.Panel,{initComponent:function(){this.url=this.urlDataDetail;var urlSplited=this.url.split('/');this.url=&quot;&quot;;for(var i=0;i&lt;urlSplited.length;i++){if(i&lt;urlSplited.length-1){this.url+=urlSplited[i]+&quot;/&quot;;}else{this.url+=encodeURIComponent(urlSplited[i]);}}
this.layout=&quot;fit&quot;;this.autoScroll=true;this.formPanel=new Ext.FormPanel({frame:true,autoScroll:true,labelWidth:150,labelAlign:&quot;top&quot;});var itemsForm=[];Ext.Ajax.request({url:this.url,method:'GET',scope:this,success:function(ret){var data=Ext.decode(ret.responseText);if(!data.success){Ext.Msg.alert(i18n.get('label.information'),&quot;Server error&quot;);return false;}
var record=data.record;var id=record.id;var attributes=record.attributeValues;if(attributes!==undefined){var i;for(i=0;i&lt;attributes.length;i++){var name=attributes[i].name;var value=attributes[i].value;var item;if(value!==null&amp;&amp;value.length&gt;100){item=new Ext.form.TextArea({fieldLabel:name,value:value,anchor:&quot;90%&quot;,readOnly:true});}else{item=new Ext.form.TextField({fieldLabel:name,value:value,anchor:&quot;90%&quot;,readOnly:true});}
itemsForm.push(item);}
this.formPanel.add(itemsForm);this.formPanel.doLayout();}},failure:alertFailure});this.componentType='detail';this.items=[this.formPanel];sitools.user.component.simpleViewDataDetail.superclass.initComponent.call(this);},_getSettings:function(){return{};}});Ext.namespace(&quot;sitools.component.users.datasets&quot;);sitools.component.users.datasets.DomQuery=function(){var cache={},simpleCache={},valueCache={},nonSpace=/\S/,trimRe=/^\s+|\s+$/g,tplRe=/\{(\d+)\}/g,modeRe=/^(\s?[\/&gt;+~]\s?|\s|$)/,tagTokenRe=/^(#)?((?:opensearch:)?[\w-\*]+)/,nthRe=/(\d*)n\+?(\d*)/,nthRe2=/\D/,isIE=window.ActiveXObject?true:false,key=30803;eval(&quot;var batch = 30803;&quot;);function child(parent,index){var i=0,n=parent.firstChild;while(n){if(n.nodeType==1){if(++i==index){return n;}}
n=n.nextSibling;}
return null;}
function next(n){while((n=n.nextSibling)&amp;&amp;n.nodeType!=1);return n;}
function prev(n){while((n=n.previousSibling)&amp;&amp;n.nodeType!=1);return n;}
function children(parent){var n=parent.firstChild,nodeIndex=-1,nextNode;while(n){nextNode=n.nextSibling;if(n.nodeType==3&amp;&amp;!nonSpace.test(n.nodeValue)){parent.removeChild(n);}else{n.nodeIndex=++nodeIndex;}
n=nextNode;}
return this;}
function byClassName(nodeSet,cls){if(!cls){return nodeSet;}
var result=[],ri=-1;for(var i=0,ci;ci=nodeSet[i];i++){if((' '+ci.className+' ').indexOf(cls)!=-1){result[++ri]=ci;}}
return result;};function attrValue(n,attr){if(!n.tagName&amp;&amp;typeof n.length!=&quot;undefined&quot;){n=n[0];}
if(!n){return null;}
if(attr==&quot;for&quot;){return n.htmlFor;}
if(attr==&quot;class&quot;||attr==&quot;className&quot;){return n.className;}
return n.getAttribute(attr)||n[attr];};function getNodes(ns,mode,tagName){var result=[],ri=-1,cs;if(!ns){return result;}
tagName=tagName||&quot;*&quot;;if(typeof ns.getElementsByTagName!=&quot;undefined&quot;){ns=[ns];}
if(!mode){for(var i=0,ni;ni=ns[i];i++){cs=ni.getElementsByTagName(tagName);for(var j=0,ci;ci=cs[j];j++){result[++ri]=ci;}}}else if(mode==&quot;/&quot;||mode==&quot;&gt;&quot;){var utag=tagName.toUpperCase();for(var i=0,ni,cn;ni=ns[i];i++){cn=ni.childNodes;for(var j=0,cj;cj=cn[j];j++){if(cj.nodeName==utag||cj.nodeName==tagName||tagName=='*'){result[++ri]=cj;}}}}else if(mode==&quot;+&quot;){var utag=tagName.toUpperCase();for(var i=0,n;n=ns[i];i++){while((n=n.nextSibling)&amp;&amp;n.nodeType!=1);if(n&amp;&amp;(n.nodeName==utag||n.nodeName==tagName||tagName=='*')){result[++ri]=n;}}}else if(mode==&quot;~&quot;){var utag=tagName.toUpperCase();for(var i=0,n;n=ns[i];i++){while((n=n.nextSibling)){if(n.nodeName==utag||n.nodeName==tagName||tagName=='*'){result[++ri]=n;}}}}
return result;}
function concat(a,b){if(b.slice){return a.concat(b);}
for(var i=0,l=b.length;i&lt;l;i++){a[a.length]=b[i];}
return a;}
function byTag(cs,tagName){if(cs.tagName||cs==document){cs=[cs];}
if(!tagName){return cs;}
var result=[],ri=-1;tagName=tagName.toLowerCase();for(var i=0,ci;ci=cs[i];i++){if(ci.nodeType==1&amp;&amp;ci.tagName.toLowerCase()==tagName){result[++ri]=ci;}}
return result;}
function byId(cs,id){if(cs.tagName||cs==document){cs=[cs];}
if(!id){return cs;}
var result=[],ri=-1;for(var i=0,ci;ci=cs[i];i++){if(ci&amp;&amp;ci.id==id){result[++ri]=ci;return result;}}
return result;}
function byAttribute(cs,attr,value,op,custom){var result=[],ri=-1,useGetStyle=custom==&quot;{&quot;,fn=sitools.component.users.datasets.DomQuery.operators[op],a,xml,hasXml;for(var i=0,ci;ci=cs[i];i++){if(ci.nodeType!=1){continue;}
if(!hasXml){xml=sitools.component.users.datasets.DomQuery.isXml(ci);hasXml=true;}
if(!xml){if(useGetStyle){a=sitools.component.users.datasets.DomQuery.getStyle(ci,attr);}else if(attr==&quot;class&quot;||attr==&quot;className&quot;){a=ci.className;}else if(attr==&quot;for&quot;){a=ci.htmlFor;}else if(attr==&quot;href&quot;){a=ci.getAttribute(&quot;href&quot;,2);}else{a=ci.getAttribute(attr);}}else{a=ci.getAttribute(attr);}
if((fn&amp;&amp;fn(a,value))||(!fn&amp;&amp;a)){result[++ri]=ci;}}
return result;}
function byPseudo(cs,name,value){return sitools.component.users.datasets.DomQuery.pseudos[name](cs,value);}
function nodupIEXml(cs){var d=++key,r;cs[0].setAttribute(&quot;_nodup&quot;,d);r=[cs[0]];for(var i=1,len=cs.length;i&lt;len;i++){var c=cs[i];if(!c.getAttribute(&quot;_nodup&quot;)!=d){c.setAttribute(&quot;_nodup&quot;,d);r[r.length]=c;}}
for(var i=0,len=cs.length;i&lt;len;i++){cs[i].removeAttribute(&quot;_nodup&quot;);}
return r;}
function nodup(cs){if(!cs){return[];}
var len=cs.length,c,i,r=cs,cj,ri=-1;if(!len||typeof cs.nodeType!=&quot;undefined&quot;||len==1){return cs;}
if(isIE&amp;&amp;typeof cs[0].selectSingleNode!=&quot;undefined&quot;){return nodupIEXml(cs);}
var d=++key;cs[0]._nodup=d;for(i=1;c=cs[i];i++){if(c._nodup!=d){c._nodup=d;}else{r=[];for(var j=0;j&lt;i;j++){r[++ri]=cs[j];}
for(j=i+1;cj=cs[j];j++){if(cj._nodup!=d){cj._nodup=d;r[++ri]=cj;}}
return r;}}
return r;}
function quickDiffIEXml(c1,c2){var d=++key,r=[];for(var i=0,len=c1.length;i&lt;len;i++){c1[i].setAttribute(&quot;_qdiff&quot;,d);}
for(var i=0,len=c2.length;i&lt;len;i++){if(c2[i].getAttribute(&quot;_qdiff&quot;)!=d){r[r.length]=c2[i];}}
for(var i=0,len=c1.length;i&lt;len;i++){c1[i].removeAttribute(&quot;_qdiff&quot;);}
return r;}
function quickDiff(c1,c2){var len1=c1.length,d=++key,r=[];if(!len1){return c2;}
if(isIE&amp;&amp;typeof c1[0].selectSingleNode!=&quot;undefined&quot;){return quickDiffIEXml(c1,c2);}
for(var i=0;i&lt;len1;i++){c1[i]._qdiff=d;}
for(var i=0,len=c2.length;i&lt;len;i++){if(c2[i]._qdiff!=d){r[r.length]=c2[i];}}
return r;}
function quickId(ns,mode,root,id){if(ns==root){var d=root.ownerDocument||root;return d.getElementById(id);}
ns=getNodes(ns,mode,&quot;*&quot;);return byId(ns,id);}
return{getStyle:function(el,name){return Ext.fly(el).getStyle(name);},compile:function(path,type){type=type||&quot;select&quot;;var fn=[&quot;var f = function(root){\n var mode; ++batch; var n = root || document;\n&quot;],mode,lastPath,matchers=sitools.component.users.datasets.DomQuery.matchers,matchersLn=matchers.length,modeMatch,lmode=path.match(modeRe);if(lmode&amp;&amp;lmode[1]){fn[fn.length]='mode=&quot;'+lmode[1].replace(trimRe,&quot;&quot;)+'&quot;;';path=path.replace(lmode[1],&quot;&quot;);}
while(path.substr(0,1)==&quot;/&quot;){path=path.substr(1);}
while(path&amp;&amp;lastPath!=path){lastPath=path;var tokenMatch=path.match(tagTokenRe);if(type==&quot;select&quot;){if(tokenMatch){if(tokenMatch[1]==&quot;#&quot;){fn[fn.length]='n = quickId(n, mode, root, &quot;'+tokenMatch[2]+'&quot;);';}else{fn[fn.length]='n = getNodes(n, mode, &quot;'+tokenMatch[2]+'&quot;);';}
path=path.replace(tokenMatch[0],&quot;&quot;);}else if(path.substr(0,1)!='@'){fn[fn.length]='n = getNodes(n, mode, &quot;*&quot;);';}}else{if(tokenMatch){if(tokenMatch[1]==&quot;#&quot;){fn[fn.length]='n = byId(n, &quot;'+tokenMatch[2]+'&quot;);';}else{fn[fn.length]='n = byTag(n, &quot;'+tokenMatch[2]+'&quot;);';}
path=path.replace(tokenMatch[0],&quot;&quot;);}}
while(!(modeMatch=path.match(modeRe))){var matched=false;for(var j=0;j&lt;matchersLn;j++){var t=matchers[j];var m=path.match(t.re);if(m){fn[fn.length]=t.select.replace(tplRe,function(x,i){return m[i];});path=path.replace(m[0],&quot;&quot;);matched=true;break;}}
if(!matched){throw'Error parsing selector, parsing failed at &quot;'+path+'&quot;';}}
if(modeMatch[1]){fn[fn.length]='mode=&quot;'+modeMatch[1].replace(trimRe,&quot;&quot;)+'&quot;;';path=path.replace(modeMatch[1],&quot;&quot;);}}
fn[fn.length]=&quot;return nodup(n);\n}&quot;;eval(fn.join(&quot;&quot;));return f;},jsSelect:function(path,root,type){path=path||&quot;&quot;;root=root||document;if(typeof root==&quot;string&quot;){root=document.getElementById(root);}
var paths=path.split(&quot;,&quot;),results=[];for(var i=0,len=paths.length;i&lt;len;i++){var subPath=paths[i].replace(trimRe,&quot;&quot;);if(!cache[subPath]){cache[subPath]=sitools.component.users.datasets.DomQuery.compile(subPath);if(!cache[subPath]){throw subPath+&quot; is not a valid selector&quot;;}}
var result=cache[subPath](root);if(result&amp;&amp;result!=document){results=results.concat(result);}}
if(paths.length&gt;1){return nodup(results);}
return results;},isXml:function(el){var docEl=(el?el.ownerDocument||el:0).documentElement;return docEl?docEl.nodeName!==&quot;HTML&quot;:false;},select:document.querySelectorAll?function(path,root,type){root=root||document;if(!sitools.component.users.datasets.DomQuery.isXml(root)){try{var cs=root.querySelectorAll(path);return Ext.toArray(cs);}catch(ex){}}
return sitools.component.users.datasets.DomQuery.jsSelect.call(this,path,root,type);}:function(path,root,type){return sitools.component.users.datasets.DomQuery.jsSelect.call(this,path,root,type);},selectNode:function(path,root){return sitools.component.users.datasets.DomQuery.select(path,root)[0];},selectValue:function(path,root,defaultValue){path=path.replace(trimRe,&quot;&quot;);if(!valueCache[path]){valueCache[path]=sitools.component.users.datasets.DomQuery.compile(path,&quot;select&quot;);}
var n=valueCache[path](root),v;n=n[0]?n[0]:n;if(typeof n.normalize=='function')
n.normalize();v=(n&amp;&amp;n.firstChild?n.firstChild.nodeValue:null);return((v===null||v===undefined||v==='')?defaultValue:v);},selectNumber:function(path,root,defaultValue){var v=sitools.component.users.datasets.DomQuery.selectValue(path,root,defaultValue||0);return parseFloat(v);},is:function(el,ss){if(typeof el==&quot;string&quot;){el=document.getElementById(el);}
var isArray=Ext.isArray(el),result=sitools.component.users.datasets.DomQuery.filter(isArray?el:[el],ss);return isArray?(result.length==el.length):(result.length&gt;0);},filter:function(els,ss,nonMatches){ss=ss.replace(trimRe,&quot;&quot;);if(!simpleCache[ss]){simpleCache[ss]=sitools.component.users.datasets.DomQuery.compile(ss,&quot;simple&quot;);}
var result=simpleCache[ss](els);return nonMatches?quickDiff(result,els):result;},matchers:[{re:/^\.([\w-]+)/,select:'n = byClassName(n, &quot; {1} &quot;);'},{re:/^\:([\w-]+)(?:\(((?:[^\s&gt;\/]*|.*?))\))?/,select:'n = byPseudo(n, &quot;{1}&quot;, &quot;{2}&quot;);'},{re:/^(?:([\[\{])(?:@)?([\w-]+)\s?(?:(=|.=)\s?['&quot;]?(.*?)[&quot;']?)?[\]\}])/,select:'n = byAttribute(n, &quot;{2}&quot;, &quot;{4}&quot;, &quot;{3}&quot;, &quot;{1}&quot;);'},{re:/^#([\w-]+)/,select:'n = byId(n, &quot;{1}&quot;);'},{re:/^@([\w-]+)/,select:'return {firstChild:{nodeValue:attrValue(n, &quot;{1}&quot;)}};'}],operators:{&quot;=&quot;:function(a,v){return a==v;},&quot;!=&quot;:function(a,v){return a!=v;},&quot;^=&quot;:function(a,v){return a&amp;&amp;a.substr(0,v.length)==v;},&quot;$=&quot;:function(a,v){return a&amp;&amp;a.substr(a.length-v.length)==v;},&quot;*=&quot;:function(a,v){return a&amp;&amp;a.indexOf(v)!==-1;},&quot;%=&quot;:function(a,v){return(a%v)==0;},&quot;|=&quot;:function(a,v){return a&amp;&amp;(a==v||a.substr(0,v.length+1)==v+'-');},&quot;~=&quot;:function(a,v){return a&amp;&amp;(' '+a+' ').indexOf(' '+v+' ')!=-1;}},pseudos:{&quot;first-child&quot;:function(c){var r=[],ri=-1,n;for(var i=0,ci;ci=n=c[i];i++){while((n=n.previousSibling)&amp;&amp;n.nodeType!=1);if(!n){r[++ri]=ci;}}
return r;},&quot;last-child&quot;:function(c){var r=[],ri=-1,n;for(var i=0,ci;ci=n=c[i];i++){while((n=n.nextSibling)&amp;&amp;n.nodeType!=1);if(!n){r[++ri]=ci;}}
return r;},&quot;nth-child&quot;:function(c,a){var r=[],ri=-1,m=nthRe.exec(a==&quot;even&quot;&amp;&amp;&quot;2n&quot;||a==&quot;odd&quot;&amp;&amp;&quot;2n+1&quot;||!nthRe2.test(a)&amp;&amp;&quot;n+&quot;+a||a),f=(m[1]||1)-0,l=m[2]-0;for(var i=0,n;n=c[i];i++){var pn=n.parentNode;if(batch!=pn._batch){var j=0;for(var cn=pn.firstChild;cn;cn=cn.nextSibling){if(cn.nodeType==1){cn.nodeIndex=++j;}}
pn._batch=batch;}
if(f==1){if(l==0||n.nodeIndex==l){r[++ri]=n;}}else if((n.nodeIndex+l)%f==0){r[++ri]=n;}}
return r;},&quot;only-child&quot;:function(c){var r=[],ri=-1;;for(var i=0,ci;ci=c[i];i++){if(!prev(ci)&amp;&amp;!next(ci)){r[++ri]=ci;}}
return r;},&quot;empty&quot;:function(c){var r=[],ri=-1;for(var i=0,ci;ci=c[i];i++){var cns=ci.childNodes,j=0,cn,empty=true;while(cn=cns[j]){++j;if(cn.nodeType==1||cn.nodeType==3){empty=false;break;}}
if(empty){r[++ri]=ci;}}
return r;},&quot;contains&quot;:function(c,v){var r=[],ri=-1;for(var i=0,ci;ci=c[i];i++){if((ci.textContent||ci.innerText||'').indexOf(v)!=-1){r[++ri]=ci;}}
return r;},&quot;nodeValue&quot;:function(c,v){var r=[],ri=-1;for(var i=0,ci;ci=c[i];i++){if(ci.firstChild&amp;&amp;ci.firstChild.nodeValue==v){r[++ri]=ci;}}
return r;},&quot;checked&quot;:function(c){var r=[],ri=-1;for(var i=0,ci;ci=c[i];i++){if(ci.checked==true){r[++ri]=ci;}}
return r;},&quot;not&quot;:function(c,ss){return sitools.component.users.datasets.DomQuery.filter(c,ss,true);},&quot;any&quot;:function(c,selectors){var ss=selectors.split('|'),r=[],ri=-1,s;for(var i=0,ci;ci=c[i];i++){for(var j=0;s=ss[j];j++){if(sitools.component.users.datasets.DomQuery.is(ci,s)){r[++ri]=ci;break;}}}
return r;},&quot;odd&quot;:function(c){return this[&quot;nth-child&quot;](c,&quot;odd&quot;);},&quot;even&quot;:function(c){return this[&quot;nth-child&quot;](c,&quot;even&quot;);},&quot;nth&quot;:function(c,a){return c[a-1]||[];},&quot;first&quot;:function(c){return c[0]||[];},&quot;last&quot;:function(c){return c[c.length-1]||[];},&quot;has&quot;:function(c,ss){var s=sitools.component.users.datasets.DomQuery.select,r=[],ri=-1;for(var i=0,ci;ci=c[i];i++){if(s(ss,ci).length&gt;0){r[++ri]=ci;}}
return r;},&quot;next&quot;:function(c,ss){var is=sitools.component.users.datasets.DomQuery.is,r=[],ri=-1;for(var i=0,ci;ci=c[i];i++){var n=next(ci);if(n&amp;&amp;is(n,ss)){r[++ri]=ci;}}
return r;},&quot;prev&quot;:function(c,ss){var is=sitools.component.users.datasets.DomQuery.is,r=[],ri=-1;for(var i=0,ci;ci=c[i];i++){var n=prev(ci);if(n&amp;&amp;is(n,ss)){r[++ri]=ci;}}
return r;}}};}();Ext.query=sitools.component.users.datasets.DomQuery.select;Ext.namespace('sitools.component.users.datasets');sitools.component.users.datasets.XmlReader=function(meta,recordType){meta=meta||{};Ext.applyIf(meta,{idProperty:meta.idProperty||meta.idPath||meta.id,successProperty:meta.successProperty||meta.success});sitools.component.users.datasets.XmlReader.superclass.constructor.call(this,meta,recordType||meta.fields);};Ext.extend(sitools.component.users.datasets.XmlReader,Ext.data.XmlReader,{createAccessor:function(){var q=sitools.component.users.datasets.DomQuery;return function(key){if(Ext.isFunction(key)){return key;}
switch(key){case this.meta.totalProperty:return function(root,def){return q.selectNumber(key,root,def);};break;case this.meta.successProperty:return function(root,def){var sv=q.selectValue(key,root,true);var success=sv!==false&amp;&amp;sv!=='false';return success;};break;default:return function(root,def){return q.selectValue(key,root,def);};break;}};}()});(function(){var base64EncodeChars=&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;;var base64DecodeChars=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1];function base64encode(str){var out,i,len;var c1,c2,c3;len=str.length;i=0;out=&quot;&quot;;while(i&lt;len){c1=str.charCodeAt(i++)&amp;0xff;if(i==len)
{out+=base64EncodeChars.charAt(c1&gt;&gt;2);out+=base64EncodeChars.charAt((c1&amp;0x3)&lt;&lt;4);out+=&quot;==&quot;;break;}
c2=str.charCodeAt(i++);if(i==len)
{out+=base64EncodeChars.charAt(c1&gt;&gt;2);out+=base64EncodeChars.charAt(((c1&amp;0x3)&lt;&lt;4)|((c2&amp;0xF0)&gt;&gt;4));out+=base64EncodeChars.charAt((c2&amp;0xF)&lt;&lt;2);out+=&quot;=&quot;;break;}
c3=str.charCodeAt(i++);out+=base64EncodeChars.charAt(c1&gt;&gt;2);out+=base64EncodeChars.charAt(((c1&amp;0x3)&lt;&lt;4)|((c2&amp;0xF0)&gt;&gt;4));out+=base64EncodeChars.charAt(((c2&amp;0xF)&lt;&lt;2)|((c3&amp;0xC0)&gt;&gt;6));out+=base64EncodeChars.charAt(c3&amp;0x3F);}
return out;}
function base64decode(str){var c1,c2,c3,c4;var i,len,out;len=str.length;i=0;out=&quot;&quot;;while(i&lt;len){do{c1=base64DecodeChars[str.charCodeAt(i++)&amp;0xff];}while(i&lt;len&amp;&amp;c1==-1);if(c1==-1)
break;do{c2=base64DecodeChars[str.charCodeAt(i++)&amp;0xff];}while(i&lt;len&amp;&amp;c2==-1);if(c2==-1)
break;out+=String.fromCharCode((c1&lt;&lt;2)|((c2&amp;0x30)&gt;&gt;4));do{c3=str.charCodeAt(i++)&amp;0xff;if(c3==61)
return out;c3=base64DecodeChars[c3];}while(i&lt;len&amp;&amp;c3==-1);if(c3==-1)
break;out+=String.fromCharCode(((c2&amp;0XF)&lt;&lt;4)|((c3&amp;0x3C)&gt;&gt;2));do{c4=str.charCodeAt(i++)&amp;0xff;if(c4==61)
return out;c4=base64DecodeChars[c4];}while(i&lt;len&amp;&amp;c4==-1);if(c4==-1)
break;out+=String.fromCharCode(((c3&amp;0x03)&lt;&lt;6)|c4);}
return out;}
if(!window.btoa)window.btoa=base64encode;if(!window.atob)window.atob=base64decode;})();var Canvas2Image=(function(){var oCanvas=document.createElement(&quot;canvas&quot;);if(!oCanvas.getContext){return{saveAsBMP:function(){},saveAsPNG:function(){},saveAsJPEG:function(){}};}
var bHasImageData=!!(oCanvas.getContext(&quot;2d&quot;).getImageData);var bHasDataURL=!!(oCanvas.toDataURL);var bHasBase64=!!(window.btoa);var strDownloadMime=&quot;image/octet-stream&quot;;var readCanvasData=function(oCanvas){var iWidth=parseInt(oCanvas.width);var iHeight=parseInt(oCanvas.height);return oCanvas.getContext(&quot;2d&quot;).getImageData(0,0,iWidth,iHeight);};var encodeData=function(data){var strData=&quot;&quot;;if(typeof data==&quot;string&quot;){strData=data;}else{var aData=data;for(var i=0;i&lt;aData.length;i++){strData+=String.fromCharCode(aData[i]);}}
return btoa(strData);};var createBMP=function(oData){var aHeader=[];var iWidth=oData.width;var iHeight=oData.height;aHeader.push(0x42);aHeader.push(0x4D);var iFileSize=iWidth*iHeight*3+54;aHeader.push(iFileSize%256);iFileSize=Math.floor(iFileSize/256);aHeader.push(iFileSize%256);iFileSize=Math.floor(iFileSize/256);aHeader.push(iFileSize%256);iFileSize=Math.floor(iFileSize/256);aHeader.push(iFileSize%256);aHeader.push(0);aHeader.push(0);aHeader.push(0);aHeader.push(0);aHeader.push(54);aHeader.push(0);aHeader.push(0);aHeader.push(0);var aInfoHeader=[];aInfoHeader.push(40);aInfoHeader.push(0);aInfoHeader.push(0);aInfoHeader.push(0);var iImageWidth=iWidth;aInfoHeader.push(iImageWidth%256);iImageWidth=Math.floor(iImageWidth/256);aInfoHeader.push(iImageWidth%256);iImageWidth=Math.floor(iImageWidth/256);aInfoHeader.push(iImageWidth%256);iImageWidth=Math.floor(iImageWidth/256);aInfoHeader.push(iImageWidth%256);var iImageHeight=iHeight;aInfoHeader.push(iImageHeight%256);iImageHeight=Math.floor(iImageHeight/256);aInfoHeader.push(iImageHeight%256);iImageHeight=Math.floor(iImageHeight/256);aInfoHeader.push(iImageHeight%256);iImageHeight=Math.floor(iImageHeight/256);aInfoHeader.push(iImageHeight%256);aInfoHeader.push(1);aInfoHeader.push(0);aInfoHeader.push(24);aInfoHeader.push(0);aInfoHeader.push(0);aInfoHeader.push(0);aInfoHeader.push(0);aInfoHeader.push(0);var iDataSize=iWidth*iHeight*3;aInfoHeader.push(iDataSize%256);iDataSize=Math.floor(iDataSize/256);aInfoHeader.push(iDataSize%256);iDataSize=Math.floor(iDataSize/256);aInfoHeader.push(iDataSize%256);iDataSize=Math.floor(iDataSize/256);aInfoHeader.push(iDataSize%256);for(var i=0;i&lt;16;i++){aInfoHeader.push(0);}
var iPadding=(4-((iWidth*3)%4))%4;var aImgData=oData.data;var strPixelData=&quot;&quot;;var y=iHeight;do{var iOffsetY=iWidth*(y-1)*4;var strPixelRow=&quot;&quot;;for(var x=0;x&lt;iWidth;x++){var iOffsetX=4*x;strPixelRow+=String.fromCharCode(aImgData[iOffsetY+iOffsetX+2]);strPixelRow+=String.fromCharCode(aImgData[iOffsetY+iOffsetX+1]);strPixelRow+=String.fromCharCode(aImgData[iOffsetY+iOffsetX]);}
for(var c=0;c&lt;iPadding;c++){strPixelRow+=String.fromCharCode(0);}
strPixelData+=strPixelRow;}while(--y);return encodeData(aHeader.concat(aInfoHeader))+encodeData(strPixelData);};var saveFile=function(strData,fileName){if(!window.open(strData)){document.location.href=strData;}};var makeDataURI=function(strData,strMime){return&quot;data:&quot;+strMime+&quot;;base64,&quot;+strData;};var makeImageObject=function(strSource){var oImgElement=document.createElement(&quot;img&quot;);oImgElement.src=strSource;return oImgElement;};var scaleCanvas=function(oCanvas,iWidth,iHeight){if(iWidth&amp;&amp;iHeight){var oSaveCanvas=document.createElement(&quot;canvas&quot;);oSaveCanvas.width=iWidth;oSaveCanvas.height=iHeight;oSaveCanvas.style.width=iWidth+&quot;px&quot;;oSaveCanvas.style.height=iHeight+&quot;px&quot;;var oSaveCtx=oSaveCanvas.getContext(&quot;2d&quot;);oSaveCtx.drawImage(oCanvas,0,0,oCanvas.width,oCanvas.height,0,0,iWidth,iWidth);return oSaveCanvas;}
return oCanvas;};return{saveAsPNG:function(oCanvas,fileName,bReturnImg,iWidth,iHeight){if(!bHasDataURL){return false;}
var oScaledCanvas=scaleCanvas(oCanvas,iWidth,iHeight);var strData=oScaledCanvas.toDataURL(&quot;image/png&quot;);if(bReturnImg){return makeImageObject(strData);}else{oScaledCanvas.toBlob(function(blob){saveAs(blob,fileName+&quot;.png&quot;);},&quot;image/png&quot;);}
return true;},saveAsJPEG:function(oCanvas,bReturnImg,iWidth,iHeight){if(!bHasDataURL){return false;}
var oScaledCanvas=scaleCanvas(oCanvas,iWidth,iHeight);var strMime=&quot;image/jpeg&quot;;var strData=oScaledCanvas.toDataURL(strMime);if(strData.indexOf(strMime)!=5){return false;}
if(bReturnImg){return makeImageObject(strData);}else{saveFile(strData.replace(strMime,strDownloadMime));}
return true;},saveAsBMP:function(oCanvas,bReturnImg,iWidth,iHeight){if(!(bHasImageData&amp;&amp;bHasBase64)){return false;}
var oScaledCanvas=scaleCanvas(oCanvas,iWidth,iHeight);var oData=readCanvasData(oScaledCanvas);var strImgData=createBMP(oData);if(bReturnImg){return makeImageObject(makeDataURI(strImgData,&quot;image/bmp&quot;));}else{saveFile(makeDataURI(strImgData,strDownloadMime));}
return true;}};})();var CanvasText={letters:{'\n':{width:-1,points:[]},' ':{width:10,points:[]},'!':{width:10,points:[[5,21],[5,7],null,[5,2],[4,1],[5,0],[6,1],[5,2]]},'&quot;':{width:16,points:[[4,21],[4,14],null,[12,21],[12,14]]},'#':{width:21,points:[[11,25],[4,-7],null,[17,25],[10,-7],null,[4,12],[18,12],null,[3,6],[17,6]]},'$':{width:20,points:[[8,25],[8,-4],null,[12,25],[12,-4],null,[17,18],[15,20],[12,21],[8,21],[5,20],[3,18],[3,16],[4,14],[5,13],[7,12],[13,10],[15,9],[16,8],[17,6],[17,3],[15,1],[12,0],[8,0],[5,1],[3,3]]},'%':{width:24,points:[[21,21],[3,0],null,[8,21],[10,19],[10,17],[9,15],[7,14],[5,14],[3,16],[3,18],[4,20],[6,21],[8,21],null,[17,7],[15,6],[14,4],[14,2],[16,0],[18,0],[20,1],[21,3],[21,5],[19,7],[17,7]]},'&amp;':{width:26,points:[[23,12],[23,13],[22,14],[21,14],[20,13],[19,11],[17,6],[15,3],[13,1],[11,0],[7,0],[5,1],[4,2],[3,4],[3,6],[4,8],[5,9],[12,13],[13,14],[14,16],[14,18],[13,20],[11,21],[9,20],[8,18],[8,16],[9,13],[11,10],[16,3],[18,1],[20,0],[22,0],[23,1],[23,2]]},'\'':{width:10,points:[[5,19],[4,20],[5,21],[6,20],[6,18],[5,16],[4,15]]},'(':{width:14,points:[[11,25],[9,23],[7,20],[5,16],[4,11],[4,7],[5,2],[7,-2],[9,-5],[11,-7]]},')':{width:14,points:[[3,25],[5,23],[7,20],[9,16],[10,11],[10,7],[9,2],[7,-2],[5,-5],[3,-7]]},'*':{width:16,points:[[8,21],[8,9],null,[3,18],[13,12],null,[13,18],[3,12]]},'+':{width:26,points:[[13,18],[13,0],null,[4,9],[22,9]]},',':{width:10,points:[[6,1],[5,0],[4,1],[5,2],[6,1],[6,-1],[5,-3],[4,-4]]},'-':{width:26,points:[[4,9],[22,9]]},'.':{width:10,points:[[5,2],[4,1],[5,0],[6,1],[5,2]]},'/':{width:22,points:[[20,25],[2,-7]]},'0':{width:20,points:[[9,21],[6,20],[4,17],[3,12],[3,9],[4,4],[6,1],[9,0],[11,0],[14,1],[16,4],[17,9],[17,12],[16,17],[14,20],[11,21],[9,21]]},'1':{width:20,points:[[6,17],[8,18],[11,21],[11,0]]},'2':{width:20,points:[[4,16],[4,17],[5,19],[6,20],[8,21],[12,21],[14,20],[15,19],[16,17],[16,15],[15,13],[13,10],[3,0],[17,0]]},'3':{width:20,points:[[5,21],[16,21],[10,13],[13,13],[15,12],[16,11],[17,8],[17,6],[16,3],[14,1],[11,0],[8,0],[5,1],[4,2],[3,4]]},'4':{width:20,points:[[13,21],[3,7],[18,7],null,[13,21],[13,0]]},'5':{width:20,points:[[15,21],[5,21],[4,12],[5,13],[8,14],[11,14],[14,13],[16,11],[17,8],[17,6],[16,3],[14,1],[11,0],[8,0],[5,1],[4,2],[3,4]]},'6':{width:20,points:[[16,18],[15,20],[12,21],[10,21],[7,20],[5,17],[4,12],[4,7],[5,3],[7,1],[10,0],[11,0],[14,1],[16,3],[17,6],[17,7],[16,10],[14,12],[11,13],[10,13],[7,12],[5,10],[4,7]]},'7':{width:20,points:[[17,21],[7,0],null,[3,21],[17,21]]},'8':{width:20,points:[[8,21],[5,20],[4,18],[4,16],[5,14],[7,13],[11,12],[14,11],[16,9],[17,7],[17,4],[16,2],[15,1],[12,0],[8,0],[5,1],[4,2],[3,4],[3,7],[4,9],[6,11],[9,12],[13,13],[15,14],[16,16],[16,18],[15,20],[12,21],[8,21]]},'9':{width:20,points:[[16,14],[15,11],[13,9],[10,8],[9,8],[6,9],[4,11],[3,14],[3,15],[4,18],[6,20],[9,21],[10,21],[13,20],[15,18],[16,14],[16,9],[15,4],[13,1],[10,0],[8,0],[5,1],[4,3]]},':':{width:10,points:[[5,14],[4,13],[5,12],[6,13],[5,14],null,[5,2],[4,1],[5,0],[6,1],[5,2]]},';':{width:10,points:[[5,14],[4,13],[5,12],[6,13],[5,14],null,[6,1],[5,0],[4,1],[5,2],[6,1],[6,-1],[5,-3],[4,-4]]},'&lt;':{width:24,points:[[20,18],[4,9],[20,0]]},'=':{width:26,points:[[4,12],[22,12],null,[4,6],[22,6]]},'&gt;':{width:24,points:[[4,18],[20,9],[4,0]]},'?':{width:18,points:[[3,16],[3,17],[4,19],[5,20],[7,21],[11,21],[13,20],[14,19],[15,17],[15,15],[14,13],[13,12],[9,10],[9,7],null,[9,2],[8,1],[9,0],[10,1],[9,2]]},'@':{width:27,points:[[18,13],[17,15],[15,16],[12,16],[10,15],[9,14],[8,11],[8,8],[9,6],[11,5],[14,5],[16,6],[17,8],null,[12,16],[10,14],[9,11],[9,8],[10,6],[11,5],null,[18,16],[17,8],[17,6],[19,5],[21,5],[23,7],[24,10],[24,12],[23,15],[22,17],[20,19],[18,20],[15,21],[12,21],[9,20],[7,19],[5,17],[4,15],[3,12],[3,9],[4,6],[5,4],[7,2],[9,1],[12,0],[15,0],[18,1],[20,2],[21,3],null,[19,16],[18,8],[18,6],[19,5]]},'A':{width:18,points:[[9,21],[1,0],null,[9,21],[17,0],null,[4,7],[14,7]]},'B':{width:21,points:[[4,21],[4,0],null,[4,21],[13,21],[16,20],[17,19],[18,17],[18,15],[17,13],[16,12],[13,11],null,[4,11],[13,11],[16,10],[17,9],[18,7],[18,4],[17,2],[16,1],[13,0],[4,0]]},'C':{width:21,points:[[18,16],[17,18],[15,20],[13,21],[9,21],[7,20],[5,18],[4,16],[3,13],[3,8],[4,5],[5,3],[7,1],[9,0],[13,0],[15,1],[17,3],[18,5]]},'D':{width:21,points:[[4,21],[4,0],null,[4,21],[11,21],[14,20],[16,18],[17,16],[18,13],[18,8],[17,5],[16,3],[14,1],[11,0],[4,0]]},'E':{width:19,points:[[4,21],[4,0],null,[4,21],[17,21],null,[4,11],[12,11],null,[4,0],[17,0]]},'F':{width:18,points:[[4,21],[4,0],null,[4,21],[17,21],null,[4,11],[12,11]]},'G':{width:21,points:[[18,16],[17,18],[15,20],[13,21],[9,21],[7,20],[5,18],[4,16],[3,13],[3,8],[4,5],[5,3],[7,1],[9,0],[13,0],[15,1],[17,3],[18,5],[18,8],null,[13,8],[18,8]]},'H':{width:22,points:[[4,21],[4,0],null,[18,21],[18,0],null,[4,11],[18,11]]},'I':{width:8,points:[[4,21],[4,0]]},'J':{width:16,points:[[12,21],[12,5],[11,2],[10,1],[8,0],[6,0],[4,1],[3,2],[2,5],[2,7]]},'K':{width:21,points:[[4,21],[4,0],null,[18,21],[4,7],null,[9,12],[18,0]]},'L':{width:17,points:[[4,21],[4,0],null,[4,0],[16,0]]},'M':{width:24,points:[[4,21],[4,0],null,[4,21],[12,0],null,[20,21],[12,0],null,[20,21],[20,0]]},'N':{width:22,points:[[4,21],[4,0],null,[4,21],[18,0],null,[18,21],[18,0]]},'O':{width:22,points:[[9,21],[7,20],[5,18],[4,16],[3,13],[3,8],[4,5],[5,3],[7,1],[9,0],[13,0],[15,1],[17,3],[18,5],[19,8],[19,13],[18,16],[17,18],[15,20],[13,21],[9,21]]},'P':{width:21,points:[[4,21],[4,0],null,[4,21],[13,21],[16,20],[17,19],[18,17],[18,14],[17,12],[16,11],[13,10],[4,10]]},'Q':{width:22,points:[[9,21],[7,20],[5,18],[4,16],[3,13],[3,8],[4,5],[5,3],[7,1],[9,0],[13,0],[15,1],[17,3],[18,5],[19,8],[19,13],[18,16],[17,18],[15,20],[13,21],[9,21],null,[12,4],[18,-2]]},'R':{width:21,points:[[4,21],[4,0],null,[4,21],[13,21],[16,20],[17,19],[18,17],[18,15],[17,13],[16,12],[13,11],[4,11],null,[11,11],[18,0]]},'S':{width:20,points:[[17,18],[15,20],[12,21],[8,21],[5,20],[3,18],[3,16],[4,14],[5,13],[7,12],[13,10],[15,9],[16,8],[17,6],[17,3],[15,1],[12,0],[8,0],[5,1],[3,3]]},'T':{width:16,points:[[8,21],[8,0],null,[1,21],[15,21]]},'U':{width:22,points:[[4,21],[4,6],[5,3],[7,1],[10,0],[12,0],[15,1],[17,3],[18,6],[18,21]]},'V':{width:18,points:[[1,21],[9,0],null,[17,21],[9,0]]},'W':{width:24,points:[[2,21],[7,0],null,[12,21],[7,0],null,[12,21],[17,0],null,[22,21],[17,0]]},'X':{width:20,points:[[3,21],[17,0],null,[17,21],[3,0]]},'Y':{width:18,points:[[1,21],[9,11],[9,0],null,[17,21],[9,11]]},'Z':{width:20,points:[[17,21],[3,0],null,[3,21],[17,21],null,[3,0],[17,0]]},'[':{width:14,points:[[4,25],[4,-7],null,[5,25],[5,-7],null,[4,25],[11,25],null,[4,-7],[11,-7]]},'\\':{width:14,points:[[0,21],[14,-3]]},']':{width:14,points:[[9,25],[9,-7],null,[10,25],[10,-7],null,[3,25],[10,25],null,[3,-7],[10,-7]]},'^':{width:14,points:[[3,10],[8,18],[13,10]]},'_':{width:16,points:[[0,-2],[16,-2]]},'`':{width:10,points:[[6,21],[5,20],[4,18],[4,16],[5,15],[6,16],[5,17]]},'a':{width:19,points:[[15,14],[15,0],null,[15,11],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},'b':{width:19,points:[[4,21],[4,0],null,[4,11],[6,13],[8,14],[11,14],[13,13],[15,11],[16,8],[16,6],[15,3],[13,1],[11,0],[8,0],[6,1],[4,3]]},'c':{width:18,points:[[15,11],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},'d':{width:19,points:[[15,21],[15,0],null,[15,11],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},'e':{width:18,points:[[3,8],[15,8],[15,10],[14,12],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},'f':{width:12,points:[[10,21],[8,21],[6,20],[5,17],[5,0],null,[2,14],[9,14]]},'g':{width:19,points:[[15,14],[15,-2],[14,-5],[13,-6],[11,-7],[8,-7],[6,-6],null,[15,11],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},'h':{width:19,points:[[4,21],[4,0],null,[4,10],[7,13],[9,14],[12,14],[14,13],[15,10],[15,0]]},'i':{width:8,points:[[3,21],[4,20],[5,21],[4,22],[3,21],null,[4,14],[4,0]]},'j':{width:10,points:[[5,21],[6,20],[7,21],[6,22],[5,21],null,[6,14],[6,-3],[5,-6],[3,-7],[1,-7]]},'k':{width:17,points:[[4,21],[4,0],null,[14,14],[4,4],null,[8,8],[15,0]]},'l':{width:8,points:[[4,21],[4,0]]},'m':{width:30,points:[[4,14],[4,0],null,[4,10],[7,13],[9,14],[12,14],[14,13],[15,10],[15,0],null,[15,10],[18,13],[20,14],[23,14],[25,13],[26,10],[26,0]]},'n':{width:19,points:[[4,14],[4,0],null,[4,10],[7,13],[9,14],[12,14],[14,13],[15,10],[15,0]]},'o':{width:19,points:[[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3],[16,6],[16,8],[15,11],[13,13],[11,14],[8,14]]},'p':{width:19,points:[[4,14],[4,-7],null,[4,11],[6,13],[8,14],[11,14],[13,13],[15,11],[16,8],[16,6],[15,3],[13,1],[11,0],[8,0],[6,1],[4,3]]},'q':{width:19,points:[[15,14],[15,-7],null,[15,11],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},'r':{width:13,points:[[4,14],[4,0],null,[4,8],[5,11],[7,13],[9,14],[12,14]]},'s':{width:17,points:[[14,11],[13,13],[10,14],[7,14],[4,13],[3,11],[4,9],[6,8],[11,7],[13,6],[14,4],[14,3],[13,1],[10,0],[7,0],[4,1],[3,3]]},'t':{width:12,points:[[5,21],[5,4],[6,1],[8,0],[10,0],null,[2,14],[9,14]]},'u':{width:19,points:[[4,14],[4,4],[5,1],[7,0],[10,0],[12,1],[15,4],null,[15,14],[15,0]]},'v':{width:16,points:[[2,14],[8,0],null,[14,14],[8,0]]},'w':{width:22,points:[[3,14],[7,0],null,[11,14],[7,0],null,[11,14],[15,0],null,[19,14],[15,0]]},'x':{width:17,points:[[3,14],[14,0],null,[14,14],[3,0]]},'y':{width:16,points:[[2,14],[8,0],null,[14,14],[8,0],[6,-4],[4,-6],[2,-7],[1,-7]]},'z':{width:17,points:[[14,14],[3,0],null,[3,14],[14,14],null,[3,0],[14,0]]},'{':{width:14,points:[[9,25],[7,24],[6,23],[5,21],[5,19],[6,17],[7,16],[8,14],[8,12],[6,10],null,[7,24],[6,22],[6,20],[7,18],[8,17],[9,15],[9,13],[8,11],[4,9],[8,7],[9,5],[9,3],[8,1],[7,0],[6,-2],[6,-4],[7,-6],null,[6,8],[8,6],[8,4],[7,2],[6,1],[5,-1],[5,-3],[6,-5],[7,-6],[9,-7]]},'|':{width:8,points:[[4,25],[4,-7]]},'}':{width:14,points:[[5,25],[7,24],[8,23],[9,21],[9,19],[8,17],[7,16],[6,14],[6,12],[8,10],null,[7,24],[8,22],[8,20],[7,18],[6,17],[5,15],[5,13],[6,11],[10,9],[6,7],[5,5],[5,3],[6,1],[7,0],[8,-2],[8,-4],[7,-6],null,[8,8],[6,6],[6,4],[7,2],[8,1],[9,-1],[9,-3],[8,-5],[7,-6],[5,-7]]},'~':{width:24,points:[[3,6],[3,8],[4,11],[6,12],[8,12],[10,11],[14,8],[16,7],[18,7],[20,8],[21,10],null,[3,8],[4,10],[6,11],[8,11],[10,10],[14,7],[16,6],[18,6],[20,7],[21,10],[21,12]]},'':{diacritic:'',letter:'e'},'':{diacritic:'`',letter:'e'},'':{diacritic:'^',letter:'e'},'':{diacritic:'',letter:'e'},'':{diacritic:'`',letter:'a'},'':{diacritic:'',letter:'c'},'':{diacritic:'~',letter:'n'},'':{diacritic:'^',letter:'o'},'':{diacritic:'',letter:'E'},'':{diacritic:'`',letter:'E'},'':{diacritic:'^',letter:'E'},'':{diacritic:'',letter:'E'},'':{diacritic:'`',letter:'A'},'':{diacritic:'',letter:'C'},'':{diacritic:'~',letter:'N'},'':{diacritic:'^',letter:'O'}},specialchars:{'pi':{width:19,points:[[6,14],[6,0],null,[14,14],[14,0],null,[2,13],[6,16],[13,13],[17,16]]}},diacritics:{'':{entity:'cedil',points:[[6,-4],[4,-6],[2,-7],[1,-7]]},'':{entity:'acute',points:[[8,19],[13,22]]},'`':{entity:'grave',points:[[7,22],[12,19]]},'^':{entity:'circ',points:[[5.5,19],[9.5,23],[12.5,19]]},'':{entity:'trema',points:[[5,21],[6,20],[7,21],[6,22],[5,21],null,[12,21],[13,20],[14,21],[13,22],[12,21]]},'~':{entity:'tilde',points:[[4,18],[7,22],[10,18],[13,22]]}},style:{size:8,font:null,color:'#000000',weight:1,halign:'l',valign:'b',adjustAlign:false,angle:0,tracking:1,boundingBoxColor:'#ff0000',originPointColor:'#000000'},debug:false,_bufferLexemes:{},letter:function(ch){return CanvasText.letters[ch];},parseLexemes:function(str){if(CanvasText._bufferLexemes[str])
return CanvasText._bufferLexemes[str];var i,c,matches=str.match(/&amp;[A-Za-z]{2,5};|\s|./g);var result=[],chars=[];for(i=0;i&lt;matches.length;i++){c=matches[i];if(c.length==1)
chars.push(c);else{var entity=c.substring(1,c.length-1);if(CanvasText.specialchars[entity])
chars.push(entity);else
chars=chars.concat(c.toArray());}}
for(i=0;i&lt;chars.length;i++){c=chars[i];if(c=CanvasText.letters[c]||CanvasText.specialchars[c])
result.push(c);}
return CanvasText._bufferLexemes[str]=result.compact();},ascent:function(style){style=style||{};return(style.size||CanvasText.style.size);},descent:function(style){style=style||{};return 7.0*(style.size||CanvasText.style.size)/25.0;},measure:function(str,style){if(!str)return;style=style||{};var i,width,lexemes=CanvasText.parseLexemes(str),total=0;for(i=lexemes.length-1;i&gt;-1;--i){c=lexemes[i];width=(c.diacritic)?CanvasText.letter(c.letter).width:c.width;total+=width*(style.tracking||CanvasText.style.tracking)*(style.size||CanvasText.style.size)/25.0;}
return total;},getDimensions:function(str,style){var width=CanvasText.measure(str,style),height=style.size||CanvasText.style.size,angle=style.angle||CanvasText.style.angle;if(style.angle==0)return{width:width,height:height};return{width:Math.abs(Math.cos(angle)*width)+Math.abs(Math.sin(angle)*height),height:Math.abs(Math.sin(angle)*width)+Math.abs(Math.cos(angle)*height)};},getBestAlign:function(angle,style){angle+=CanvasText.getAngleFromAlign(style.halign,style.valign);var a={h:'c',v:'m'};if(Math.round(Math.cos(angle)*1000)/1000!=0)
a.h=(Math.cos(angle)&gt;0?'r':'l');if(Math.round(Math.sin(angle)*1000)/1000!=0)
a.v=(Math.sin(angle)&gt;0?'t':'b');return a;},getAngleFromAlign:function(halign,valign){var pi=Math.PI,table={'rm':0,'rt':pi/4,'ct':pi/2,'lt':3*(pi/4),'lm':pi,'lb':-3*(pi/4),'cb':-pi/2,'rb':-pi/4,'cm':0};return table[halign+valign];},drawPoints:function(ctx,points,x,y,mag,offset){var i,a,penUp=true,needStroke=0;offset=offset||{x:0,y:0};ctx.beginPath();for(i=0;i&lt;points.length;i++){a=points[i];if(!a){penUp=true;continue;}
if(penUp){ctx.moveTo(x+a[0]*mag+offset.x,y-a[1]*mag+offset.y);penUp=false;}
else{ctx.lineTo(x+a[0]*mag+offset.x,y-a[1]*mag+offset.y);}}
ctx.stroke();},draw:function(ctx,str,xOrig,yOrig,style){if(!str)return;style=style||CanvasText.style;style.halign=style.halign||CanvasText.style.halign;style.valign=style.valign||CanvasText.style.valign;style.angle=style.angle||CanvasText.style.angle;style.size=style.size||CanvasText.style.size;style.adjustAlign=style.adjustAlign||CanvasText.style.adjustAlign;var i,c,total=0,mag=style.size/25.0,x=0,y=0,lexemes=CanvasText.parseLexemes(str);var offset={x:0,y:0},measure=CanvasText.measure(str,style),align;if(style.adjustAlign){align=CanvasText.getBestAlign(style.angle,style);style.halign=align.h;style.valign=align.v;}
switch(style.halign){case'l':break;case'c':offset.x=-measure/2;break;case'r':offset.x=-measure;break;}
switch(style.valign){case'b':break;case'm':offset.y=style.size/2;break;case't':offset.y=style.size;break;}
ctx.save();ctx.translate(xOrig,yOrig);ctx.rotate(style.angle);ctx.lineCap=&quot;round&quot;;ctx.lineWidth=2.0*mag*(style.weight||CanvasText.style.weight);ctx.strokeStyle=style.color||CanvasText.style.color;for(i=0;i&lt;lexemes.length;i++){c=lexemes[i];if(c.width==-1){x=0;y=style.size*1.4;continue;}
var points=c.points,width=c.width;if(c.diacritic){var dia=CanvasText.diacritics[c.diacritic];var charactere=CanvasText.letter(c.letter);CanvasText.drawPoints(ctx,dia.points,x,y-(c.letter.toUpperCase()==c.letter?3:0),mag,offset);points=charactere.points;width=charactere.width;}
CanvasText.drawPoints(ctx,points,x,y,mag,offset);if(CanvasText.debug){ctx.save();ctx.lineJoin=&quot;miter&quot;;ctx.lineWidth=0.5;ctx.strokeStyle=(style.boundingBoxColor||CanvasText.style.boundingBoxColor);ctx.strokeRect(x+offset.x,y+offset.y,width*mag,-style.size);ctx.fillStyle=(style.originPointColor||CanvasText.style.originPointColor);ctx.beginPath();ctx.arc(0,0,1.5,0,Math.PI*2,true);ctx.fill();ctx.restore();}
x+=width*mag*(style.tracking||CanvasText.style.tracking);}
ctx.restore();return total;},enable:function(ctx){ctx.drawText=function(text,x,y,style){return CanvasText.draw(ctx,text,x,y,style);};ctx.measureText=function(text,style){return CanvasText.measure(text,style);};ctx.getTextBounds=function(text,style){return CanvasText.getDimensions(text,style);};ctx.fontAscent=function(style){return CanvasText.ascent(style);};ctx.fontDescent=function(style){return CanvasText.descent(style);};}};var Flotr={version:'0.2.0-alpha',author:'Bas Wenneker',website:'http://www.solutoire.com',_registeredTypes:{'lines':'drawSeriesLines','points':'drawSeriesPoints','bars':'drawSeriesBars','candles':'drawSeriesCandles','pie':'drawSeriesPie'},register:function(type,functionName){Flotr._registeredTypes[type]=functionName+'';},draw:function(el,data,options,_GraphKlass_){_GraphKlass_=_GraphKlass_||Flotr.Graph;return new _GraphKlass_(el,data,options);},getSeries:function(data){return data.collect(function(serie){var i,serie=(serie.data)?Object.clone(serie):{'data':serie};for(i=serie.data.length-1;i&gt;-1;--i){serie.data[i][1]=(serie.data[i][1]===null?null:parseFloat(serie.data[i][1]));}
return serie;});},merge:function(src,dest){var result=dest||{};for(var i in src){result[i]=(src[i]!=null&amp;&amp;typeof(src[i])=='object'&amp;&amp;!(src[i].constructor==Array||src[i].constructor==RegExp)&amp;&amp;!Object.isElement(src[i]))?Flotr.merge(src[i],dest[i]):result[i]=src[i];}
return result;},getTickSize:function(noTicks,min,max,decimals){var delta=(max-min)/noTicks;var magn=Flotr.getMagnitude(delta);var norm=delta/magn;var tickSize=10;if(norm&lt;1.5)
tickSize=1;else if(norm&lt;2.25)
tickSize=2;else if(norm&lt;3)
tickSize=((decimals==0)?2:2.5);else if(norm&lt;7.5)
tickSize=5;return tickSize*magn;},defaultTickFormatter:function(val){return val+'';},defaultTrackFormatter:function(obj){return'('+obj.x+', '+obj.y+')';},defaultPieLabelFormatter:function(slice){return(slice.fraction*100).toFixed(2)+'%';},getMagnitude:function(x){return Math.pow(10,Math.floor(Math.log(x)/Math.LN10));},toPixel:function(val){return Math.floor(val)+0.5;},toRad:function(angle){return-angle*(Math.PI/180);},parseColor:function(str){if(str instanceof Flotr.Color)
return str;var result,Color=Flotr.Color;if((result=/rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/.exec(str)))
return new Color(parseInt(result[1]),parseInt(result[2]),parseInt(result[3]));if((result=/rgba\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]+(?:\.[0-9]+)?)\s*\)/.exec(str)))
return new Color(parseInt(result[1]),parseInt(result[2]),parseInt(result[3]),parseFloat(result[4]));if((result=/rgb\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*\)/.exec(str)))
return new Color(parseFloat(result[1])*2.55,parseFloat(result[2])*2.55,parseFloat(result[3])*2.55);if((result=/rgba\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\s*\)/.exec(str)))
return new Color(parseFloat(result[1])*2.55,parseFloat(result[2])*2.55,parseFloat(result[3])*2.55,parseFloat(result[4]));if((result=/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/.exec(str)))
return new Color(parseInt(result[1],16),parseInt(result[2],16),parseInt(result[3],16));if((result=/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/.exec(str)))
return new Color(parseInt(result[1]+result[1],16),parseInt(result[2]+result[2],16),parseInt(result[3]+result[3],16));var name=str.strip().toLowerCase();if(name=='transparent'){return new Color(255,255,255,0);}
return((result=Color.lookupColors[name]))?new Color(result[0],result[1],result[2]):false;},extractColor:function(element){var color;do{color=element.getStyle('background-color').toLowerCase();if(!(color==''||color=='transparent'))
break;element=element.up(0);}while(!element.nodeName.match(/^body$/i));return(color=='rgba(0, 0, 0, 0)')?'transparent':color;}};Flotr.Graph=Class.create({initialize:function(el,data,options){this.el=$(el);if(!this.el)
throw'The target container doesn\'t exist';this.data=data;this.series=Flotr.getSeries(data);this.setOptions(options);this.lastMousePos={pageX:null,pageY:null};this.selection={first:{x:-1,y:-1},second:{x:-1,y:-1}};this.prevSelection=null;this.selectionInterval=null;this.ignoreClick=false;this.prevHit=null;this.constructCanvas();this.initEvents();this.findDataRanges();this.calculateTicks(this.axes.x);this.calculateTicks(this.axes.x2);this.calculateTicks(this.axes.y);this.calculateTicks(this.axes.y2);this.calculateSpacing();this.draw();this.insertLegend();if(this.options.spreadsheet.show)
this.constructTabs();},setOptions:function(opts){var options={colors:['#00A8F0','#C0D800','#CB4B4B','#4DA74D','#9440ED'],title:null,subtitle:null,legend:{show:true,noColumns:1,labelFormatter:Prototype.K,labelBoxBorderColor:'#CCCCCC',labelBoxWidth:14,labelBoxHeight:10,labelBoxMargin:5,container:null,position:'nw',margin:5,backgroundColor:null,backgroundOpacity:0.85},xaxis:{ticks:null,showLabels:true,labelsAngle:0,title:null,titleAngle:0,noTicks:5,tickFormatter:Flotr.defaultTickFormatter,tickDecimals:null,min:null,max:null,autoscaleMargin:0,color:null},x2axis:{},yaxis:{ticks:null,showLabels:true,labelsAngle:0,title:null,titleAngle:90,noTicks:5,tickFormatter:Flotr.defaultTickFormatter,tickDecimals:null,min:null,max:null,autoscaleMargin:0,color:null},y2axis:{titleAngle:270},points:{show:false,radius:3,lineWidth:2,fill:true,fillColor:'#FFFFFF',fillOpacity:0.4},lines:{show:false,lineWidth:2,fill:false,fillColor:null,fillOpacity:0.4},bars:{show:false,lineWidth:2,barWidth:1,fill:true,fillColor:null,fillOpacity:0.4,horizontal:false,stacked:false},candles:{show:false,lineWidth:1,wickLineWidth:1,candleWidth:0.6,fill:true,upFillColor:'#00A8F0',downFillColor:'#CB4B4B',fillOpacity:0.5,barcharts:false},pie:{show:false,lineWidth:1,fill:true,fillColor:null,fillOpacity:0.6,explode:6,sizeRatio:0.6,startAngle:Math.PI/4,labelFormatter:Flotr.defaultPieLabelFormatter,pie3D:false,pie3DviewAngle:(Math.PI/2*0.8),pie3DspliceThickness:20},grid:{color:'#545454',backgroundColor:null,tickColor:'#DDDDDD',labelMargin:3,verticalLines:true,horizontalLines:true,outlineWidth:2},selection:{mode:null,color:'#B6D9FF',fps:20},mouse:{track:false,position:'se',relative:false,trackFormatter:Flotr.defaultTrackFormatter,margin:5,lineColor:'#FF3F19',trackDecimals:1,sensibility:2,radius:3},shadowSize:4,defaultType:'lines',HtmlText:true,fontSize:7.5,spreadsheet:{show:false,tabGraphLabel:'Graph',tabDataLabel:'Data',toolbarDownload:'Download CSV',toolbarSelectAll:'Select all'}};options.x2axis=Object.extend(Object.clone(options.xaxis),options.x2axis);options.y2axis=Object.extend(Object.clone(options.yaxis),options.y2axis);this.options=Flotr.merge((opts||{}),options);this.axes={x:{options:this.options.xaxis,n:1},x2:{options:this.options.x2axis,n:2},y:{options:this.options.yaxis,n:1},y2:{options:this.options.y2axis,n:2}};var assignedColors=[],colors=[],ln=this.series.length,neededColors=this.series.length,oc=this.options.colors,usedColors=[],variation=0,c,i,j,s,tooClose;for(i=neededColors-1;i&gt;-1;--i){c=this.series[i].color;if(c!=null){--neededColors;if(Object.isNumber(c))
assignedColors.push(c);else
usedColors.push(Flotr.parseColor(c));}}
for(i=assignedColors.length-1;i&gt;-1;--i)
neededColors=Math.max(neededColors,assignedColors[i]+1);for(i=0;colors.length&lt;neededColors;){c=(oc.length==i)?new Flotr.Color(100,100,100):Flotr.parseColor(oc[i]);var sign=variation%2==1?-1:1;var factor=1+sign*Math.ceil(variation/2)*0.2;c.scale(factor,factor,factor);colors.push(c);if(++i&gt;=oc.length){i=0;++variation;}}
for(i=0,j=0;i&lt;ln;++i){s=this.series[i];if(s.color==null){s.color=colors[j++].toString();}else if(Object.isNumber(s.color)){s.color=colors[s.color].toString();}
if(!s.xaxis)
s.xaxis=this.axes.x;if(s.xaxis==1)
s.xaxis=this.axes.x;else if(s.xaxis==2)
s.xaxis=this.axes.x2;if(!s.yaxis)
s.yaxis=this.axes.y;if(s.yaxis==1)
s.yaxis=this.axes.y;else if(s.yaxis==2)
s.yaxis=this.axes.y2;s.lines=Object.extend(Object.clone(this.options.lines),s.lines);s.points=Object.extend(Object.clone(this.options.points),s.points);s.bars=Object.extend(Object.clone(this.options.bars),s.bars);s.candles=Object.extend(Object.clone(this.options.candles),s.candles);s.pie=Object.extend(Object.clone(this.options.pie),s.pie);s.mouse=Object.extend(Object.clone(this.options.mouse),s.mouse);if(s.shadowSize==null)
s.shadowSize=this.options.shadowSize;}},constructCanvas:function(){var el=this.el,size,c,oc;this.canvas=el.select('.flotr-canvas')[0];this.overlay=el.select('.flotr-overlay')[0];el.childElements().invoke('remove');el.setStyle({position:'relative',cursor:'default'});this.canvasWidth=el.getWidth();this.canvasHeight=el.getHeight();size={'width':this.canvasWidth,'height':this.canvasHeight};if(this.canvasWidth&lt;=0||this.canvasHeight&lt;=0){throw'Invalid dimensions for plot, width = '+this.canvasWidth+', height = '+this.canvasHeight;}
if(!this.canvas){c=this.canvas=new Element('canvas',size);c.className='flotr-canvas';c=c.writeAttribute('style','position:absolute;left:0px;top:0px;');}else{c=this.canvas.writeAttribute(size);}
el.insert(c);if(Prototype.Browser.IE){c=window.G_vmlCanvasManager.initElement(c);}
this.ctx=c.getContext('2d');if(!this.overlay){oc=this.overlay=new Element('canvas',size);oc.className='flotr-overlay';oc=oc.writeAttribute('style','position:absolute;left:0px;top:0px;');}else{oc=this.overlay.writeAttribute(size);}
el.insert(oc);if(Prototype.Browser.IE){oc=window.G_vmlCanvasManager.initElement(oc);}
this.octx=oc.getContext('2d');if(window.CanvasText){CanvasText.enable(this.ctx);CanvasText.enable(this.octx);this.textEnabled=true;}
this.ctx.globalAlpha=1.0;this.ctx.fillStyle='#FFFFFF';this.ctx.fillRect(0,0,this.canvasWidth,this.canvasHeight);},getTextDimensions:function(text,canvasStyle,HtmlStyle,className){if(!text)
return{width:0,height:0};if(!this.options.HtmlText&amp;&amp;this.textEnabled){var bounds=this.ctx.getTextBounds(text,canvasStyle);return{width:bounds.width+2,height:bounds.height+6};}else{var dummyDiv=this.el.insert('&lt;div style=&quot;position:absolute;top:-10000px;'+HtmlStyle+'&quot; class=&quot;'+className+' flotr-dummy-div&quot;&gt;'+text+'&lt;/div&gt;').select(&quot;.flotr-dummy-div&quot;)[0];dim=dummyDiv.getDimensions();dummyDiv.remove();return dim;}},loadDataGrid:function(){if(this.seriesData)
return this.seriesData;var s=this.series;var dg=[];for(i=0;i&lt;s.length;++i){s[i].data.each(function(v){var x=v[0],y=v[1];if(r=dg.find(function(row){return row[0]==x;})){r[i+1]=y;}else{var newRow=[];newRow[0]=x;newRow[i+1]=y;dg.push(newRow);}});}
dg=dg.sortBy(function(v){return v[0];});return this.seriesData=dg;},showTab:function(tabName,onComplete){var elementsClassNames='canvas, .flotr-labels, .flotr-legend, .flotr-legend-bg, .flotr-title, .flotr-subtitle';switch(tabName){case'graph':this.datagrid.up().hide();this.el.select(elementsClassNames).invoke('show');this.tabs.data.removeClassName('selected');this.tabs.graph.addClassName('selected');break;case'data':this.constructDataGrid();this.datagrid.up().show();this.el.select(elementsClassNames).invoke('hide');this.tabs.data.addClassName('selected');this.tabs.graph.removeClassName('selected');break;}},constructTabs:function(){var tabsContainer=new Element('div',{className:'flotr-tabs-group',style:'position:absolute;left:0px;top:'+this.canvasHeight+'px;width:'+this.canvasWidth+'px;'});this.el.insert({bottom:tabsContainer});this.tabs={graph:new Element('div',{className:'flotr-tab selected',style:'float:left;'}).update(this.options.spreadsheet.tabGraphLabel),data:new Element('div',{className:'flotr-tab',style:'float:left;'}).update(this.options.spreadsheet.tabDataLabel)};tabsContainer.insert(this.tabs.graph).insert(this.tabs.data);this.el.setStyle({height:this.canvasHeight+this.tabs.data.getHeight()+2+'px'});this.tabs.graph.observe('click',(function(){this.showTab('graph');}).bind(this));this.tabs.data.observe('click',(function(){this.showTab('data');}).bind(this));},constructDataGrid:function(){if(this.datagrid)
return this.datagrid;var i,j,s=this.series,datagrid=this.loadDataGrid();var t=this.datagrid=new Element('table',{className:'flotr-datagrid',style:'height:100px;'});var colgroup=['&lt;colgroup&gt;&lt;col /&gt;'];var html=['&lt;tr class=&quot;first-row&quot;&gt;'];html.push('&lt;th&gt;&amp;nbsp;&lt;/th&gt;');for(i=0;i&lt;s.length;++i){html.push('&lt;th scope=&quot;col&quot;&gt;'+(s[i].label||String.fromCharCode(65+i))+'&lt;/th&gt;');colgroup.push('&lt;col /&gt;');}
html.push('&lt;/tr&gt;');for(j=0;j&lt;datagrid.length;++j){html.push('&lt;tr&gt;');for(i=0;i&lt;s.length+1;++i){var tag='td';var content=(datagrid[j][i]!=null?Math.round(datagrid[j][i]*100000)/100000:'');if(i==0){tag='th';var label;if(this.options.xaxis.ticks){var tick=this.options.xaxis.ticks.find(function(x){return x[0]==datagrid[j][i];});if(tick)
label=tick[1];}else{label=this.options.xaxis.tickFormatter(content);}
if(label)
content=label;}
html.push('&lt;'+tag+(tag=='th'?' scope=&quot;row&quot;':'')+'&gt;'+content+'&lt;/'+tag+'&gt;');}
html.push('&lt;/tr&gt;');}
colgroup.push('&lt;/colgroup&gt;');t.update(colgroup.join('')+html.join(''));if(!Prototype.Browser.IE){t.select('td').each(function(td){td.observe('mouseover',function(e){td=e.element();var siblings=td.previousSiblings();t.select('th[scope=col]')[siblings.length-1].addClassName('hover');t.select('colgroup col')[siblings.length].addClassName('hover');});td.observe('mouseout',function(){t.select('colgroup col.hover, th.hover').each(function(e){e.removeClassName('hover');});});});}
var toolbar=new Element('div',{className:'flotr-datagrid-toolbar'}).insert(new Element('button',{type:'button',className:'flotr-datagrid-toolbar-button'}).update(this.options.spreadsheet.toolbarDownload).observe('click',this.downloadCSV.bind(this))).insert(new Element('button',{type:'button',className:'flotr-datagrid-toolbar-button'}).update(this.options.spreadsheet.toolbarSelectAll).observe('click',this.selectAllData.bind(this)));var container=new Element('div',{className:'flotr-datagrid-container',style:'left:0px;top:0px;width:'+this.canvasWidth+'px;height:'+this.canvasHeight+'px;overflow:auto;'});container.insert(toolbar);t.wrap(container.hide());this.el.insert(container);return t;},selectAllData:function(){if(this.tabs){var selection,range,doc,win,node=this.constructDataGrid();this.showTab('data');(function(){if((doc=node.ownerDocument)&amp;&amp;(win=doc.defaultView)&amp;&amp;win.getSelection&amp;&amp;doc.createRange&amp;&amp;(selection=window.getSelection())&amp;&amp;selection.removeAllRanges){range=doc.createRange();range.selectNode(node);selection.removeAllRanges();selection.addRange(range);}else if(document.body&amp;&amp;document.body.createTextRange&amp;&amp;(range=document.body.createTextRange())){range.moveToElementText(node);range.select();}}).defer();return true;}else
return false;},downloadCSV:function(){var i,csv='&quot;x&quot;',series=this.series,dg=this.loadDataGrid();for(i=0;i&lt;series.length;++i){csv+='%09&quot;'+(series[i].label||String.fromCharCode(65+i))+'&quot;';}
csv+=&quot;%0D%0A&quot;;for(i=0;i&lt;dg.length;++i){if(this.options.xaxis.ticks){var tick=this.options.xaxis.ticks.find(function(x){return x[0]==dg[i][0];});if(tick)
dg[i][0]=tick[1];}else{dg[i][0]=this.options.xaxis.tickFormatter(dg[i][0]);}
csv+=dg[i].join('%09')+&quot;%0D%0A&quot;;}
if(Prototype.Browser.IE){csv=csv.gsub('%09','\t').gsub('%0A','\n').gsub('%0D','\r');window.open().document.write(csv);}else{window.open('data:text/csv,'+csv);}},initEvents:function(){this.overlay.stopObserving();this.overlay.observe('mousedown',this.mouseDownHandler.bind(this));this.overlay.observe('mousemove',this.mouseMoveHandler.bind(this));this.overlay.observe('click',this.clickHandler.bind(this));},findDataRanges:function(){var s=this.series,a=this.axes;a.x.datamin=0;a.x.datamax=0;a.x2.datamin=0;a.x2.datamax=0;a.y.datamin=0;a.y.datamax=0;a.y2.datamin=0;a.y2.datamax=0;if(s.length&gt;0){var i,j,h,x,y,data,xaxis,yaxis;for(i=0;i&lt;s.length;++i){data=s[i].data,xaxis=s[i].xaxis,yaxis=s[i].yaxis;if(data.length&gt;0&amp;&amp;!s[i].hide){if(!xaxis.used)
xaxis.datamin=xaxis.datamax=data[0][0];if(!yaxis.used)
yaxis.datamin=yaxis.datamax=data[0][1];xaxis.used=true;yaxis.used=true;for(h=data.length-1;h&gt;-1;--h){x=data[h][0];if(x&lt;xaxis.datamin)
xaxis.datamin=x;else if(x&gt;xaxis.datamax)
xaxis.datamax=x;for(j=1;j&lt;2;j++){y=data[h][j];if(y&lt;yaxis.datamin)
yaxis.datamin=y;else if(y&gt;yaxis.datamax)
yaxis.datamax=y;}}}}}
this.findXAxesValues();this.calculateRange(a.x);this.extendXRangeIfNeededByBar(a.x);if(a.x2.used){this.calculateRange(a.x2);this.extendXRangeIfNeededByBar(a.x2);}
this.calculateRange(a.y);this.extendYRangeIfNeededByBar(a.y);if(a.y2.used){this.calculateRange(a.y2);this.extendYRangeIfNeededByBar(a.y2);}},calculateRange:function(axis){var o=axis.options,min=o.min!=null?o.min:axis.datamin,max=o.max!=null?o.max:axis.datamax,margin;if(max-min==0.0){var widen=(max==0.0)?1.0:0.01;min-=widen;max+=widen;}
axis.tickSize=Flotr.getTickSize(o.noTicks,min,max,o.tickDecimals);if(o.min==null){margin=o.autoscaleMargin;if(margin!=0){min-=axis.tickSize*margin;if(min&lt;0&amp;&amp;axis.datamin&gt;=0)
min=0;min=axis.tickSize*Math.floor(min/axis.tickSize);}}
if(o.max==null){margin=o.autoscaleMargin;if(margin!=0){max+=axis.tickSize*margin;if(max&gt;0&amp;&amp;axis.datamax&lt;=0)
max=0;max=axis.tickSize*Math.ceil(max/axis.tickSize);}}
axis.min=min;axis.max=max;},extendXRangeIfNeededByBar:function(axis){if(axis.options.max==null){var newmax=axis.max,i,s,b,c,stackedSums=[],lastSerie=null;for(i=0;i&lt;this.series.length;++i){s=this.series[i];b=s.bars;c=s.candles;if(s.axis==axis&amp;&amp;(b.show||c.show)){if(!b.horizontal&amp;&amp;(b.barWidth+axis.datamax&gt;newmax)||(c.candleWidth+axis.datamax&gt;newmax)){newmax=axis.max+s.bars.barWidth;}
if(b.stacked&amp;&amp;b.horizontal){for(j=0;j&lt;s.data.length;j++){if(s.bars.show&amp;&amp;s.bars.stacked){var x=s.data[j][0];stackedSums[x]=(stackedSums[x]||0)+s.data[j][1];lastSerie=s;}}
for(j=0;j&lt;stackedSums.length;j++){newmax=Math.max(stackedSums[j],newmax);}}}}
axis.lastSerie=lastSerie;axis.max=newmax;}},extendYRangeIfNeededByBar:function(axis){if(axis.options.max==null){var newmax=axis.max,i,s,b,c,stackedSums=[],lastSerie=null;for(i=0;i&lt;this.series.length;++i){s=this.series[i];b=s.bars;c=s.candles;if(s.yaxis==axis&amp;&amp;b.show&amp;&amp;!s.hide){if(b.horizontal&amp;&amp;(b.barWidth+axis.datamax&gt;newmax)||(c.candleWidth+axis.datamax&gt;newmax)){newmax=axis.max+b.barWidth;}
if(b.stacked&amp;&amp;!b.horizontal){for(j=0;j&lt;s.data.length;j++){if(s.bars.show&amp;&amp;s.bars.stacked){var x=s.data[j][0];stackedSums[x]=(stackedSums[x]||0)+s.data[j][1];lastSerie=s;}}
for(j=0;j&lt;stackedSums.length;j++){newmax=Math.max(stackedSums[j],newmax);}}}}
axis.lastSerie=lastSerie;axis.max=newmax;}},findXAxesValues:function(){for(i=this.series.length-1;i&gt;-1;--i){s=this.series[i];s.xaxis.values=s.xaxis.values||[];for(j=s.data.length-1;j&gt;-1;--j){s.xaxis.values[s.data[j][0]]={};}}},calculateTicks:function(axis){var o=axis.options,i,v;axis.ticks=[];if(o.ticks){var ticks=o.ticks,t,label;if(Object.isFunction(ticks)){ticks=ticks({min:axis.min,max:axis.max});}
for(i=0;i&lt;ticks.length;++i){t=ticks[i];if(typeof(t)=='object'){v=t[0];label=(t.length&gt;1)?t[1]:o.tickFormatter(v);}else{v=t;label=o.tickFormatter(v);}
axis.ticks[i]={v:v,label:label};}}else{var start=axis.tickSize*Math.ceil(axis.min/axis.tickSize),decimals;for(i=0;start+i*axis.tickSize&lt;=axis.max;++i){v=start+i*axis.tickSize;decimals=o.tickDecimals;if(decimals==null)
decimals=1-Math.floor(Math.log(axis.tickSize)/Math.LN10);if(decimals&lt;0)
decimals=0;v=v.toFixed(decimals);axis.ticks.push({v:v,label:o.tickFormatter(v)});}}},calculateSpacing:function(){var a=this.axes,options=this.options,series=this.series,margin=options.grid.labelMargin,x=a.x,x2=a.x2,y=a.y,y2=a.y2,maxOutset=2,i,j,l,dim;[x,x2,y,y2].each(function(axis){var maxLabel='';if(axis.options.showLabels){for(i=0;i&lt;axis.ticks.length;++i){l=axis.ticks[i].label.length;if(l&gt;maxLabel.length){maxLabel=axis.ticks[i].label;}}}
axis.maxLabel=this.getTextDimensions(maxLabel,{size:options.fontSize,angle:Flotr.toRad(axis.options.labelsAngle)},'font-size:smaller;','flotr-grid-label');axis.titleSize=this.getTextDimensions(axis.options.title,{size:options.fontSize*1.2,angle:Flotr.toRad(axis.options.titleAngle)},'font-weight:bold;','flotr-axis-title');},this);dim=this.getTextDimensions(options.title,{size:options.fontSize*1.5},'font-size:1em;font-weight:bold;','flotr-title');this.titleHeight=dim.height;dim=this.getTextDimensions(options.subtitle,{size:options.fontSize},'font-size:smaller;','flotr-subtitle');this.subtitleHeight=dim.height;if(options.show){maxOutset=Math.max(maxOutset,options.points.radius+options.points.lineWidth/2);}
for(j=0;j&lt;options.length;++j){if(series[j].points.show){maxOutset=Math.max(maxOutset,series[j].points.radius+series[j].points.lineWidth/2);}}
var p=this.plotOffset={left:0,right:0,top:0,bottom:0};p.left=p.right=p.top=p.bottom=maxOutset;p.bottom+=(x.options.showLabels?(x.maxLabel.height+margin):0)+(x.options.title?(x.titleSize.height+margin):0);p.top+=(x2.options.showLabels?(x2.maxLabel.height+margin):0)+(x2.options.title?(x2.titleSize.height+margin):0)
+this.subtitleHeight+this.titleHeight;p.left+=(y.options.showLabels?(y.maxLabel.width+margin):0)+(y.options.title?(y.titleSize.width+margin):0);p.right+=(y2.options.showLabels?(y2.maxLabel.width+margin):0)+(y2.options.title?(y2.titleSize.width+margin):0);p.top=Math.floor(p.top);this.plotWidth=this.canvasWidth-p.left-p.right;this.plotHeight=this.canvasHeight-p.bottom-p.top;x.scale=this.plotWidth/(x.max-x.min);x2.scale=this.plotWidth/(x2.max-x2.min);y.scale=this.plotHeight/(y.max-y.min);y2.scale=this.plotHeight/(y2.max-y2.min);},draw:function(){this.drawGrid();this.drawLabels();this.drawTitles();if(this.series.length){this.el.fire('flotr:beforedraw',[this.series,this]);for(var i=0;i&lt;this.series.length;i++){if(!this.series[i].hide)
this.drawSeries(this.series[i]);}}
this.el.fire('flotr:afterdraw',[this.series,this]);},tHoz:function(x,axis){axis=axis||this.axes.x;return(x-axis.min)*axis.scale;},tVert:function(y,axis){axis=axis||this.axes.y;return this.plotHeight-(y-axis.min)*axis.scale;},drawGrid:function(){var v,o=this.options,ctx=this.ctx;if(o.grid.verticalLines||o.grid.horizontalLines){this.el.fire('flotr:beforegrid',[this.axes.x,this.axes.y,o,this]);}
ctx.save();ctx.translate(this.plotOffset.left,this.plotOffset.top);if(o.grid.backgroundColor!=null){ctx.fillStyle=o.grid.backgroundColor;ctx.fillRect(0,0,this.plotWidth,this.plotHeight);}
ctx.lineWidth=1;ctx.strokeStyle=o.grid.tickColor;ctx.beginPath();if(o.grid.verticalLines){for(var i=0;i&lt;this.axes.x.ticks.length;++i){v=this.axes.x.ticks[i].v;if((v==this.axes.x.min||v==this.axes.x.max)&amp;&amp;o.grid.outlineWidth!=0)
continue;ctx.moveTo(Math.floor(this.tHoz(v))+ctx.lineWidth/2,0);ctx.lineTo(Math.floor(this.tHoz(v))+ctx.lineWidth/2,this.plotHeight);}}
if(o.grid.horizontalLines){for(var j=0;j&lt;this.axes.y.ticks.length;++j){v=this.axes.y.ticks[j].v;if((v==this.axes.y.min||v==this.axes.y.max)&amp;&amp;o.grid.outlineWidth!=0)
continue;ctx.moveTo(0,Math.floor(this.tVert(v))+ctx.lineWidth/2);ctx.lineTo(this.plotWidth,Math.floor(this.tVert(v))+ctx.lineWidth/2);}}
ctx.stroke();if(o.grid.outlineWidth!=0){ctx.lineWidth=o.grid.outlineWidth;ctx.strokeStyle=o.grid.color;ctx.lineJoin='round';ctx.strokeRect(0,0,this.plotWidth,this.plotHeight);}
ctx.restore();if(o.grid.verticalLines||o.grid.horizontalLines){this.el.fire('flotr:aftergrid',[this.axes.x,this.axes.y,o,this]);}},drawLabels:function(){var noLabels=0,axis,xBoxWidth,i,html,tick,options=this.options,ctx=this.ctx,a=this.axes;for(i=0;i&lt;a.x.ticks.length;++i){if(a.x.ticks[i].label){++noLabels;}}
xBoxWidth=this.plotWidth/noLabels;if(!options.HtmlText&amp;&amp;this.textEnabled){var style={size:options.fontSize,adjustAlign:true};axis=a.x;style.color=axis.options.color||options.grid.color;for(i=0;i&lt;axis.ticks.length&amp;&amp;axis.options.showLabels&amp;&amp;axis.used;++i){tick=axis.ticks[i];if(!tick.label||tick.label.length==0)
continue;style.angle=Flotr.toRad(axis.options.labelsAngle);style.halign='c';style.valign='t';ctx.drawText(tick.label,this.plotOffset.left+this.tHoz(tick.v,axis),this.plotOffset.top+this.plotHeight
+options.grid.labelMargin,style);}
axis=a.x2;style.color=axis.options.color||options.grid.color;for(i=0;i&lt;axis.ticks.length&amp;&amp;axis.options.showLabels&amp;&amp;axis.used;++i){tick=axis.ticks[i];if(!tick.label||tick.label.length==0)
continue;style.angle=Flotr.toRad(axis.options.labelsAngle);style.halign='c';style.valign='b';ctx.drawText(tick.label,this.plotOffset.left+this.tHoz(tick.v,axis),this.plotOffset.top+options.grid.labelMargin,style);}
axis=a.y;style.color=axis.options.color||options.grid.color;for(i=0;i&lt;axis.ticks.length&amp;&amp;axis.options.showLabels&amp;&amp;axis.used;++i){tick=axis.ticks[i];if(!tick.label||tick.label.length==0)
continue;style.angle=Flotr.toRad(axis.options.labelsAngle);style.halign='r';style.valign='m';ctx.drawText(tick.label,this.plotOffset.left-options.grid.labelMargin,this.plotOffset.top+this.tVert(tick.v,axis),style);}
axis=a.y2;style.color=axis.options.color||options.grid.color;for(i=0;i&lt;axis.ticks.length&amp;&amp;axis.options.showLabels&amp;&amp;axis.used;++i){tick=axis.ticks[i];if(!tick.label||tick.label.length==0)
continue;style.angle=Flotr.toRad(axis.options.labelsAngle);style.halign='l';style.valign='m';ctx.drawText(tick.label,this.plotOffset.left+this.plotWidth+options.grid.labelMargin,this.plotOffset.top
+this.tVert(tick.v,axis),style);ctx.save();ctx.strokeStyle=style.color;ctx.beginPath();ctx.moveTo(this.plotOffset.left+this.plotWidth-8,this.plotOffset.top+this.tVert(tick.v,axis));ctx.lineTo(this.plotOffset.left+this.plotWidth,this.plotOffset.top+this.tVert(tick.v,axis));ctx.stroke();ctx.restore();}}else if(a.x.options.showLabels||a.x2.options.showLabels||a.y.options.showLabels||a.y2.options.showLabels){html=['&lt;div style=&quot;font-size:smaller;color:'+options.grid.color+';&quot; class=&quot;flotr-labels&quot;&gt;'];axis=a.x;if(axis.options.showLabels){for(i=0;i&lt;axis.ticks.length;++i){tick=axis.ticks[i];if(!tick.label||tick.label.length==0)
continue;html.push('&lt;div style=&quot;position:absolute;top:'+(this.plotOffset.top+this.plotHeight+options.grid.labelMargin)
+'px;left:'+(this.plotOffset.left+this.tHoz(tick.v,axis)-xBoxWidth/2)+'px;width:'+xBoxWidth
+'px;text-align:center;'+(axis.options.color?('color:'+axis.options.color+';'):'')
+'&quot; class=&quot;flotr-grid-label&quot;&gt;'+tick.label+'&lt;/div&gt;');}}
axis=a.x2;if(axis.options.showLabels&amp;&amp;axis.used){for(i=0;i&lt;axis.ticks.length;++i){tick=axis.ticks[i];if(!tick.label||tick.label.length==0)
continue;html.push('&lt;div style=&quot;position:absolute;top:'+(this.plotOffset.top-options.grid.labelMargin-axis.maxLabel.height)
+'px;left:'+(this.plotOffset.left+this.tHoz(tick.v,axis)-xBoxWidth/2)+'px;width:'+xBoxWidth
+'px;text-align:center;'+(axis.options.color?('color:'+axis.options.color+';'):'')
+'&quot; class=&quot;flotr-grid-label&quot;&gt;'+tick.label+'&lt;/div&gt;');}}
axis=a.y;if(axis.options.showLabels){for(i=0;i&lt;axis.ticks.length;++i){tick=axis.ticks[i];if(!tick.label||tick.label.length==0)
continue;html.push('&lt;div style=&quot;position:absolute;top:'+(this.plotOffset.top+this.tVert(tick.v,axis)-axis.maxLabel.height/2)
+'px;left:0;width:'+(this.plotOffset.left-options.grid.labelMargin)+'px;text-align:right;'
+(axis.options.color?('color:'+axis.options.color+';'):'')+'&quot; class=&quot;flotr-grid-label&quot;&gt;'+tick.label
+'&lt;/div&gt;');}}
axis=a.y2;if(axis.options.showLabels&amp;&amp;axis.used){ctx.save();ctx.strokeStyle=axis.options.color||options.grid.color;ctx.beginPath();for(i=0;i&lt;axis.ticks.length;++i){tick=axis.ticks[i];if(!tick.label||tick.label.length==0)
continue;html.push('&lt;div style=&quot;position:absolute;top:'+(this.plotOffset.top+this.tVert(tick.v,axis)-axis.maxLabel.height/2)
+'px;right:0;width:'+(this.plotOffset.right-options.grid.labelMargin)+'px;text-align:left;'
+(axis.options.color?('color:'+axis.options.color+';'):'')+'&quot; class=&quot;flotr-grid-label&quot;&gt;'+tick.label
+'&lt;/div&gt;');ctx.moveTo(this.plotOffset.left+this.plotWidth-8,this.plotOffset.top+this.tVert(tick.v,axis));ctx.lineTo(this.plotOffset.left+this.plotWidth,this.plotOffset.top+this.tVert(tick.v,axis));}
ctx.stroke();ctx.restore();}
html.push('&lt;/div&gt;');this.el.insert(html.join(''));}},drawTitles:function(){var html,options=this.options,margin=options.grid.labelMargin,ctx=this.ctx,a=this.axes;if(!options.HtmlText&amp;&amp;this.textEnabled){var style={size:options.fontSize,color:options.grid.color,halign:'c'};if(options.subtitle){ctx.drawText(options.subtitle,this.plotOffset.left+this.plotWidth/2,this.titleHeight+this.subtitleHeight-2,style);}
style.weight=1.5;style.size*=1.5;if(options.title){ctx.drawText(options.title,this.plotOffset.left+this.plotWidth/2,this.titleHeight-2,style);}
style.weight=1.8;style.size*=0.8;style.adjustAlign=true;if(a.x.options.title&amp;&amp;a.x.used){style.halign='c';style.valign='t';style.angle=Flotr.toRad(a.x.options.titleAngle);ctx.drawText(a.x.options.title,this.plotOffset.left+this.plotWidth/2,this.plotOffset.top+a.x.maxLabel.height+this.plotHeight
+2*margin,style);}
if(a.x2.options.title&amp;&amp;a.x2.used){style.halign='c';style.valign='b';style.angle=Flotr.toRad(a.x2.options.titleAngle);ctx.drawText(a.x2.options.title,this.plotOffset.left+this.plotWidth/2,this.plotOffset.top-a.x2.maxLabel.height-2*margin,style);}
if(a.y.options.title&amp;&amp;a.y.used){style.halign='r';style.valign='m';style.angle=Flotr.toRad(a.y.options.titleAngle);ctx.drawText(a.y.options.title,this.plotOffset.left-a.y.maxLabel.width-2*margin,this.plotOffset.top+this.plotHeight/2,style);}
if(a.y2.options.title&amp;&amp;a.y2.used){style.halign='l';style.valign='m';style.angle=Flotr.toRad(a.y2.options.titleAngle);ctx.drawText(a.y2.options.title,this.plotOffset.left+this.plotWidth+a.y2.maxLabel.width+2*margin,this.plotOffset.top
+this.plotHeight/2,style);}}else{html=['&lt;div style=&quot;color:'+options.grid.color+';&quot; class=&quot;flotr-titles&quot;&gt;'];if(options.title){html.push('&lt;div style=&quot;position:absolute;top:0;left:'+this.plotOffset.left
+'px;font-size:1em;font-weight:bold;text-align:center;width:'+this.plotWidth+'px;&quot; class=&quot;flotr-title&quot;&gt;'+options.title
+'&lt;/div&gt;');}
if(options.subtitle){html.push('&lt;div style=&quot;position:absolute;top:'+this.titleHeight+'px;left:'+this.plotOffset.left
+'px;font-size:smaller;text-align:center;width:'+this.plotWidth+'px;&quot; class=&quot;flotr-subtitle&quot;&gt;'+options.subtitle
+'&lt;/div&gt;');}
html.push('&lt;/div&gt;');html.push('&lt;div class=&quot;flotr-axis-title&quot; style=&quot;font-weight:bold;&quot;&gt;');if(a.x.options.title&amp;&amp;a.x.used){html.push('&lt;div style=&quot;position:absolute;top:'
+(this.plotOffset.top+this.plotHeight+options.grid.labelMargin+a.x.titleSize.height)+'px;left:'+this.plotOffset.left
+'px;width:'+this.plotWidth+'px;text-align:center;&quot; class=&quot;flotr-axis-title&quot;&gt;'+a.x.options.title+'&lt;/div&gt;');}
if(a.x2.options.title&amp;&amp;a.x2.used){html.push('&lt;div style=&quot;position:absolute;top:0;left:'+this.plotOffset.left+'px;width:'+this.plotWidth
+'px;text-align:center;&quot; class=&quot;flotr-axis-title&quot;&gt;'+a.x2.options.title+'&lt;/div&gt;');}
if(a.y.options.title&amp;&amp;a.y.used){html.push('&lt;div style=&quot;position:absolute;top:'+(this.plotOffset.top+this.plotHeight/2-a.y.titleSize.height/2)
+'px;left:0;text-align:right;&quot; class=&quot;flotr-axis-title&quot;&gt;'+a.y.options.title+'&lt;/div&gt;');}
if(a.y2.options.title&amp;&amp;a.y2.used){html.push('&lt;div style=&quot;position:absolute;top:'+(this.plotOffset.top+this.plotHeight/2-a.y.titleSize.height/2)
+'px;right:0;text-align:right;&quot; class=&quot;flotr-axis-title&quot;&gt;'+a.y2.options.title+'&lt;/div&gt;');}
html.push('&lt;/div&gt;');this.el.insert(html.join(''));}},drawSeries:function(series){series=series||this.series;var drawn=false;for(var type in Flotr._registeredTypes){if(series[type]&amp;&amp;series[type].show){this[Flotr._registeredTypes[type]](series);drawn=true;}}
if(!drawn){this[Flotr._registeredTypes[this.options.defaultType]](series);}},plotLine:function(series,offset){var ctx=this.ctx,xa=series.xaxis,ya=series.yaxis,tHoz=this.tHoz.bind(this),tVert=this.tVert.bind(this),data=series.data;if(data.length&lt;2)
return;var prevx=tHoz(data[0][0],xa),prevy=tVert(data[0][1],ya)+offset;ctx.beginPath();ctx.moveTo(prevx,prevy);for(var i=0;i&lt;data.length-1;++i){var x1=data[i][0],y1=data[i][1],x2=data[i+1][0],y2=data[i+1][1];if(y1===null||y2===null)
continue;if(y1&lt;=y2&amp;&amp;y1&lt;ya.min){if(y2&lt;ya.min)
continue;x1=(ya.min-y1)/(y2-y1)*(x2-x1)+x1;y1=ya.min;}else if(y2&lt;=y1&amp;&amp;y2&lt;ya.min){if(y1&lt;ya.min)
continue;x2=(ya.min-y1)/(y2-y1)*(x2-x1)+x1;y2=ya.min;}
if(y1&gt;=y2&amp;&amp;y1&gt;ya.max){if(y2&gt;ya.max)
continue;x1=(ya.max-y1)/(y2-y1)*(x2-x1)+x1;y1=ya.max;}else if(y2&gt;=y1&amp;&amp;y2&gt;ya.max){if(y1&gt;ya.max)
continue;x2=(ya.max-y1)/(y2-y1)*(x2-x1)+x1;y2=ya.max;}
if(x1&lt;=x2&amp;&amp;x1&lt;xa.min){if(x2&lt;xa.min)
continue;y1=(xa.min-x1)/(x2-x1)*(y2-y1)+y1;x1=xa.min;}else if(x2&lt;=x1&amp;&amp;x2&lt;xa.min){if(x1&lt;xa.min)
continue;y2=(xa.min-x1)/(x2-x1)*(y2-y1)+y1;x2=xa.min;}
if(x1&gt;=x2&amp;&amp;x1&gt;xa.max){if(x2&gt;xa.max)
continue;y1=(xa.max-x1)/(x2-x1)*(y2-y1)+y1;x1=xa.max;}else if(x2&gt;=x1&amp;&amp;x2&gt;xa.max){if(x1&gt;xa.max)
continue;y2=(xa.max-x1)/(x2-x1)*(y2-y1)+y1;x2=xa.max;}
if(prevx!=tHoz(x1,xa)||prevy!=tVert(y1,ya)+offset)
ctx.moveTo(tHoz(x1,xa),tVert(y1,ya)+offset);prevx=tHoz(x2,xa);prevy=tVert(y2,ya)+offset;ctx.lineTo(prevx,prevy);}
ctx.stroke();},plotLineArea:function(series,offset){var data=series.data;if(data.length&lt;2)
return;var top,lastX=0,ctx=this.ctx,xa=series.xaxis,ya=series.yaxis,tHoz=this.tHoz.bind(this),tVert=this.tVert.bind(this),bottom=Math.min(Math.max(0,ya.min),ya.max),first=true;ctx.beginPath();for(var i=0;i&lt;data.length-1;++i){var x1=data[i][0],y1=data[i][1],x2=data[i+1][0],y2=data[i+1][1];if(x1&lt;=x2&amp;&amp;x1&lt;xa.min){if(x2&lt;xa.min)
continue;y1=(xa.min-x1)/(x2-x1)*(y2-y1)+y1;x1=xa.min;}else if(x2&lt;=x1&amp;&amp;x2&lt;xa.min){if(x1&lt;xa.min)
continue;y2=(xa.min-x1)/(x2-x1)*(y2-y1)+y1;x2=xa.min;}
if(x1&gt;=x2&amp;&amp;x1&gt;xa.max){if(x2&gt;xa.max)
continue;y1=(xa.max-x1)/(x2-x1)*(y2-y1)+y1;x1=xa.max;}else if(x2&gt;=x1&amp;&amp;x2&gt;xa.max){if(x1&gt;xa.max)
continue;y2=(xa.max-x1)/(x2-x1)*(y2-y1)+y1;x2=xa.max;}
if(first){ctx.moveTo(tHoz(x1,xa),tVert(bottom,ya)+offset);first=false;}
if(y1&gt;=ya.max&amp;&amp;y2&gt;=ya.max){ctx.lineTo(tHoz(x1,xa),tVert(ya.max,ya)+offset);ctx.lineTo(tHoz(x2,xa),tVert(ya.max,ya)+offset);continue;}else if(y1&lt;=ya.min&amp;&amp;y2&lt;=ya.min){ctx.lineTo(tHoz(x1,xa),tVert(ya.min,ya)+offset);ctx.lineTo(tHoz(x2,xa),tVert(ya.min,ya)+offset);continue;}
var x1old=x1,x2old=x2;if(y1&lt;=y2&amp;&amp;y1&lt;ya.min&amp;&amp;y2&gt;=ya.min){x1=(ya.min-y1)/(y2-y1)*(x2-x1)+x1;y1=ya.min;}else if(y2&lt;=y1&amp;&amp;y2&lt;ya.min&amp;&amp;y1&gt;=ya.min){x2=(ya.min-y1)/(y2-y1)*(x2-x1)+x1;y2=ya.min;}
if(y1&gt;=y2&amp;&amp;y1&gt;ya.max&amp;&amp;y2&lt;=ya.max){x1=(ya.max-y1)/(y2-y1)*(x2-x1)+x1;y1=ya.max;}else if(y2&gt;=y1&amp;&amp;y2&gt;ya.max&amp;&amp;y1&lt;=ya.max){x2=(ya.max-y1)/(y2-y1)*(x2-x1)+x1;y2=ya.max;}
if(x1!=x1old){top=(y1&lt;=ya.min)?top=ya.min:ya.max;ctx.lineTo(tHoz(x1old,xa),tVert(top,ya)+offset);ctx.lineTo(tHoz(x1,xa),tVert(top,ya)+offset);}
ctx.lineTo(tHoz(x1,xa),tVert(y1,ya)+offset);ctx.lineTo(tHoz(x2,xa),tVert(y2,ya)+offset);if(x2!=x2old){top=(y2&lt;=ya.min)?ya.min:ya.max;ctx.lineTo(tHoz(x2old,xa),tVert(top,ya)+offset);ctx.lineTo(tHoz(x2,xa),tVert(top,ya)+offset);}
lastX=Math.max(x2,x2old);}
ctx.lineTo(tHoz(lastX,xa),tVert(bottom,ya)+offset);ctx.closePath();ctx.fill();},drawSeriesLines:function(series){series=series||this.series;var ctx=this.ctx;ctx.save();ctx.translate(this.plotOffset.left,this.plotOffset.top);ctx.lineJoin='round';var lw=series.lines.lineWidth;var sw=series.shadowSize;if(sw&gt;0){ctx.lineWidth=sw/2;var offset=lw/2+ctx.lineWidth/2;ctx.strokeStyle=&quot;rgba(0,0,0,0.1)&quot;;this.plotLine(series,offset+sw/2);ctx.strokeStyle=&quot;rgba(0,0,0,0.2)&quot;;this.plotLine(series,offset);if(series.lines.fill){ctx.fillStyle=&quot;rgba(0,0,0,0.05)&quot;;this.plotLineArea(series,offset+sw/2);}}
ctx.lineWidth=lw;ctx.strokeStyle=series.color;if(series.lines.fill){ctx.fillStyle=series.lines.fillColor!=null?series.lines.fillColor:Flotr.parseColor(series.color).scale(null,null,null,series.lines.fillOpacity).toString();this.plotLineArea(series,0);}
this.plotLine(series,0);ctx.restore();},drawSeriesPoints:function(series){var ctx=this.ctx;ctx.save();ctx.translate(this.plotOffset.left,this.plotOffset.top);var lw=series.lines.lineWidth;var sw=series.shadowSize;if(sw&gt;0){ctx.lineWidth=sw/2;ctx.strokeStyle='rgba(0,0,0,0.1)';this.plotPointShadows(series,sw/2+ctx.lineWidth/2,series.points.radius);ctx.strokeStyle='rgba(0,0,0,0.2)';this.plotPointShadows(series,ctx.lineWidth/2,series.points.radius);}
ctx.lineWidth=series.points.lineWidth;ctx.strokeStyle=series.color;ctx.fillStyle=series.points.fillColor!=null?series.points.fillColor:series.color;this.plotPoints(series,series.points.radius,series.points.fill);ctx.restore();},plotPoints:function(series,radius,fill){var xa=series.xaxis,ya=series.yaxis,ctx=this.ctx,i,data=series.data;for(i=data.length-1;i&gt;-1;--i){var x=data[i][0],y=data[i][1];if(x&lt;xa.min||x&gt;xa.max||y&lt;ya.min||y&gt;ya.max)
continue;ctx.beginPath();ctx.arc(this.tHoz(x,xa),this.tVert(y,ya),radius,0,2*Math.PI,true);if(fill)
ctx.fill();ctx.stroke();}},plotPointShadows:function(series,offset,radius){var xa=series.xaxis,ya=series.yaxis,ctx=this.ctx,i,data=series.data;for(i=data.length-1;i&gt;-1;--i){var x=data[i][0],y=data[i][1];if(x&lt;xa.min||x&gt;xa.max||y&lt;ya.min||y&gt;ya.max)
continue;ctx.beginPath();ctx.arc(this.tHoz(x,xa),this.tVert(y,ya)+offset,radius,0,Math.PI,false);ctx.stroke();}},drawSeriesBars:function(series){var ctx=this.ctx,bw=series.bars.barWidth,lw=Math.min(series.bars.lineWidth,bw);ctx.save();ctx.translate(this.plotOffset.left,this.plotOffset.top);ctx.lineJoin='miter';ctx.lineWidth=lw;ctx.strokeStyle=series.color;this.plotBarsShadows(series,bw,0,series.bars.fill);if(series.bars.fill){ctx.fillStyle=series.bars.fillColor!=null?series.bars.fillColor:Flotr.parseColor(series.color).scale(null,null,null,series.bars.fillOpacity).toString();}
this.plotBars(series,bw,0,series.bars.fill);ctx.restore();},plotBars:function(series,barWidth,offset,fill){var data=series.data;if(data.length&lt;1)
return;var xa=series.xaxis,ya=series.yaxis,ctx=this.ctx,tHoz=this.tHoz.bind(this),tVert=this.tVert.bind(this);for(var i=0;i&lt;data.length;i++){var x=data[i][0],y=data[i][1];var drawLeft=true,drawTop=true,drawRight=true;var stackOffset=0;if(series.bars.stacked){xa.values.each(function(o,v){if(v==x){stackOffset=o.stack||0;o.stack=stackOffset+y;}});}
if(series.bars.horizontal)
var left=stackOffset,right=x+stackOffset,bottom=y,top=y+barWidth;else
var left=x,right=x+barWidth,bottom=stackOffset,top=y+stackOffset;if(right&lt;xa.min||left&gt;xa.max||top&lt;ya.min||bottom&gt;ya.max)
continue;if(left&lt;xa.min){left=xa.min;drawLeft=false;}
if(right&gt;xa.max){right=xa.max;if(xa.lastSerie!=series&amp;&amp;series.bars.horizontal)
drawTop=false;}
if(bottom&lt;ya.min)
bottom=ya.min;if(top&gt;ya.max){top=ya.max;if(ya.lastSerie!=series&amp;&amp;!series.bars.horizontal)
drawTop=false;}
if(fill){ctx.beginPath();ctx.moveTo(tHoz(left,xa),tVert(bottom,ya)+offset);ctx.lineTo(tHoz(left,xa),tVert(top,ya)+offset);ctx.lineTo(tHoz(right,xa),tVert(top,ya)+offset);ctx.lineTo(tHoz(right,xa),tVert(bottom,ya)+offset);ctx.fill();}
if(series.bars.lineWidth!=0&amp;&amp;(drawLeft||drawRight||drawTop)){ctx.beginPath();ctx.moveTo(tHoz(left,xa),tVert(bottom,ya)+offset);ctx[drawLeft?'lineTo':'moveTo'](tHoz(left,xa),tVert(top,ya)+offset);ctx[drawTop?'lineTo':'moveTo'](tHoz(right,xa),tVert(top,ya)+offset);ctx[drawRight?'lineTo':'moveTo'](tHoz(right,xa),tVert(bottom,ya)+offset);ctx.stroke();}}},plotBarsShadows:function(series,barWidth,offset){var data=series.data;if(data.length&lt;1)
return;var xa=series.xaxis,ya=series.yaxis,ctx=this.ctx,tHoz=this.tHoz.bind(this),tVert=this.tVert.bind(this),sw=this.options.shadowSize;for(var i=0;i&lt;data.length;i++){var x=data[i][0],y=data[i][1];var stackOffset=0;if(series.bars.stacked){xa.values.each(function(o,v){if(v==x){stackOffset=o.stackShadow||0;o.stackShadow=stackOffset+y;}});}
if(series.bars.horizontal)
var left=stackOffset,right=x+stackOffset,bottom=y,top=y+barWidth;else
var left=x,right=x+barWidth,bottom=stackOffset,top=y+stackOffset;if(right&lt;xa.min||left&gt;xa.max||top&lt;ya.min||bottom&gt;ya.max)
continue;if(left&lt;xa.min)
left=xa.min;if(right&gt;xa.max)
right=xa.max;if(bottom&lt;ya.min)
bottom=ya.min;if(top&gt;ya.max)
top=ya.max;var width=tHoz(right,xa)-tHoz(left,xa)-((tHoz(right,xa)+sw&lt;=this.plotWidth)?0:sw);var height=Math.max(0,tVert(bottom,ya)-tVert(top,ya)-((tVert(bottom,ya)+sw&lt;=this.plotHeight)?0:sw));ctx.fillStyle='rgba(0,0,0,0.05)';ctx.fillRect(Math.min(tHoz(left,xa)+sw,this.plotWidth),Math.min(tVert(top,ya)+sw,this.plotWidth),width,height);}},drawSeriesCandles:function(series){var ctx=this.ctx,bw=series.candles.candleWidth;ctx.save();ctx.translate(this.plotOffset.left,this.plotOffset.top);ctx.lineJoin='miter';ctx.lineWidth=series.candles.lineWidth;this.plotCandlesShadows(series,bw/2);this.plotCandles(series,bw/2);ctx.restore();},plotCandles:function(series,offset){var data=series.data;if(data.length&lt;1)
return;var xa=series.xaxis,ya=series.yaxis,ctx=this.ctx,tHoz=this.tHoz.bind(this),tVert=this.tVert.bind(this);for(var i=0;i&lt;data.length;i++){var d=data[i],x=d[0],open=d[1],high=d[2],low=d[3],close=d[4];var left=x,right=x+series.candles.candleWidth,bottom=Math.max(ya.min,low),top=Math.min(ya.max,high),bottom2=Math.max(ya.min,Math.min(open,close)),top2=Math.min(ya.max,Math.max(open,close));if(right&lt;xa.min||left&gt;xa.max||top&lt;ya.min||bottom&gt;ya.max)
continue;var color=series.candles[open&gt;close?'downFillColor':'upFillColor'];if(series.candles.fill&amp;&amp;!series.candles.barcharts){ctx.fillStyle=Flotr.parseColor(color).scale(null,null,null,series.candles.fillOpacity).toString();ctx.fillRect(tHoz(left,xa),tVert(top2,ya)+offset,tHoz(right,xa)-tHoz(left,xa),tVert(bottom2,ya)-tVert(top2,ya));}
if(series.candles.lineWidth||series.candles.wickLineWidth){var x,y,pixelOffset=(series.candles.wickLineWidth%2)/2;x=Math.floor(tHoz((left+right)/2),xa)+pixelOffset;ctx.save();ctx.strokeStyle=color;ctx.lineWidth=series.candles.wickLineWidth;ctx.lineCap='butt';if(series.candles.barcharts){ctx.beginPath();ctx.moveTo(x,Math.floor(tVert(top,ya)+offset));ctx.lineTo(x,Math.floor(tVert(bottom,ya)+offset));y=Math.floor(tVert(open,ya)+offset)+0.5;ctx.moveTo(Math.floor(tHoz(left,xa))+pixelOffset,y);ctx.lineTo(x,y);y=Math.floor(tVert(close,ya)+offset)+0.5;ctx.moveTo(Math.floor(tHoz(right,xa))+pixelOffset,y);ctx.lineTo(x,y);}else{ctx.strokeRect(tHoz(left,xa),tVert(top2,ya)+offset,tHoz(right,xa)-tHoz(left,xa),tVert(bottom2,ya)-tVert(top2,ya));ctx.beginPath();ctx.moveTo(x,Math.floor(tVert(top2,ya)+offset));ctx.lineTo(x,Math.floor(tVert(top,ya)+offset));ctx.moveTo(x,Math.floor(tVert(bottom2,ya)+offset));ctx.lineTo(x,Math.floor(tVert(bottom,ya)+offset));}
ctx.stroke();ctx.restore();}}},plotCandlesShadows:function(series,offset){var data=series.data;if(data.length&lt;1||series.candles.barcharts)
return;var xa=series.xaxis,ya=series.yaxis,tHoz=this.tHoz.bind(this),tVert=this.tVert.bind(this),sw=this.options.shadowSize;for(var i=0;i&lt;data.length;i++){var d=data[i],x=d[0],open=d[1],high=d[2],low=d[3],close=d[4];var left=x,right=x+series.candles.candleWidth,bottom=Math.max(ya.min,Math.min(open,close)),top=Math.min(ya.max,Math.max(open,close));if(right&lt;xa.min||left&gt;xa.max||top&lt;ya.min||bottom&gt;ya.max)
continue;var width=tHoz(right,xa)-tHoz(left,xa)-((tHoz(right,xa)+sw&lt;=this.plotWidth)?0:sw);var height=Math.max(0,tVert(bottom,ya)-tVert(top,ya)-((tVert(bottom,ya)+sw&lt;=this.plotHeight)?0:sw));this.ctx.fillStyle='rgba(0,0,0,0.05)';this.ctx.fillRect(Math.min(tHoz(left,xa)+sw,this.plotWidth),Math.min(tVert(top,ya)+sw,this.plotWidth),width,height);}},drawSeriesPie:function(series){if(!this.options.pie.drawn){var ctx=this.ctx,options=this.options,lw=series.pie.lineWidth,sw=series.shadowSize,data=series.data,radius=(Math.min(this.canvasWidth,this.canvasHeight)*series.pie.sizeRatio)/2,html=[];var vScale=1;var plotTickness=Math.sin(series.pie.viewAngle)*series.pie.spliceThickness/vScale;var style={size:options.fontSize*1.2,color:options.grid.color,weight:1.5};var center={x:(this.canvasWidth+this.plotOffset.left)/2,y:(this.canvasHeight-this.plotOffset.bottom)/2};var portions=this.series.collect(function(hash,index){if(hash.pie.show)
return{name:(hash.label||hash.data[0][1]),value:[index,hash.data[0][1]],explode:hash.pie.explode};});var sum=portions.pluck('value').pluck(1).inject(0,function(acc,n){return acc+n;});var fraction=0.0,angle=series.pie.startAngle,value=0.0;var slices=portions.collect(function(slice){angle+=fraction;value=parseFloat(slice.value[1]);fraction=value/sum;return{name:slice.name,fraction:fraction,x:slice.value[0],y:value,explode:slice.explode,startAngle:2*angle*Math.PI,endAngle:2*(angle+fraction)*Math.PI};});ctx.save();if(sw&gt;0){slices.each(function(slice){var bisection=(slice.startAngle+slice.endAngle)/2;var xOffset=center.x+Math.cos(bisection)*slice.explode+sw;var yOffset=center.y+Math.sin(bisection)*slice.explode+sw;this.plotSlice(xOffset,yOffset,radius,slice.startAngle,slice.endAngle,false,vScale);ctx.fillStyle='rgba(0,0,0,0.1)';ctx.fill();},this);}
if(options.HtmlText){html=['&lt;div style=&quot;color:'+this.options.grid.color+'&quot; class=&quot;flotr-labels&quot;&gt;'];}
slices.each(function(slice,index){var bisection=(slice.startAngle+slice.endAngle)/2;var color=options.colors[index];var xOffset=center.x+Math.cos(bisection)*slice.explode;var yOffset=center.y+Math.sin(bisection)*slice.explode;this.plotSlice(xOffset,yOffset,radius,slice.startAngle,slice.endAngle,false,vScale);if(series.pie.fill){ctx.fillStyle=Flotr.parseColor(color).scale(null,null,null,series.pie.fillOpacity).toString();ctx.fill();}
ctx.lineWidth=lw;ctx.strokeStyle=color;ctx.stroke();var label=options.pie.labelFormatter(slice);var textAlignRight=(Math.cos(bisection)&lt;0);var distX=xOffset+Math.cos(bisection)*(series.pie.explode+radius);var distY=yOffset+Math.sin(bisection)*(series.pie.explode+radius);if(slice.fraction&amp;&amp;label){if(options.HtmlText){var divStyle='position:absolute;top:'+(distY-5)+'px;';if(textAlignRight){divStyle+='right:'+(this.canvasWidth-distX)+'px;text-align:right;';}else{divStyle+='left:'+distX+'px;text-align:left;';}
html.push('&lt;div style=&quot;'+divStyle+'&quot; class=&quot;flotr-grid-label&quot;&gt;'+label+'&lt;/div&gt;');}else{style.halign=textAlignRight?'r':'l';ctx.drawText(label,distX,distY+style.size/2,style);}}},this);if(options.HtmlText){html.push('&lt;/div&gt;');this.el.insert(html.join(''));}
ctx.restore();options.pie.drawn=true;}},plotSlice:function(x,y,radius,startAngle,endAngle,fill,vScale){var ctx=this.ctx;vScale=vScale||1;ctx.save();ctx.scale(1,vScale);ctx.beginPath();ctx.moveTo(x,y);ctx.arc(x,y,radius,startAngle,endAngle,fill);ctx.lineTo(x,y);ctx.closePath();ctx.restore();},plotPie:function(){},insertLegend:function(){if(!this.options.legend.show)
return;var series=this.series,plotOffset=this.plotOffset,options=this.options,fragments=[],rowStarted=false,ctx=this.ctx,i;var noLegendItems=series.findAll(function(s){return(s.label&amp;&amp;!s.hide);}).size();if(noLegendItems){if(!options.HtmlText&amp;&amp;this.textEnabled){var style={size:options.fontSize*1.1,color:options.grid.color};var p=options.legend.position,m=options.legend.margin,lbw=options.legend.labelBoxWidth,lbh=options.legend.labelBoxHeight,lbm=options.legend.labelBoxMargin,offsetX=plotOffset.left
+m,offsetY=plotOffset.top+m;var labelMaxWidth=0;for(i=series.length-1;i&gt;-1;--i){if(!series[i].label||series[i].hide)
continue;var label=options.legend.labelFormatter(series[i].label);labelMaxWidth=Math.max(labelMaxWidth,ctx.measureText(label,style));}
var legendWidth=Math.round(lbw+lbm*3+labelMaxWidth),legendHeight=Math.round(noLegendItems*(lbm+lbh)+lbm);if(p.charAt(0)=='s')
offsetY=plotOffset.top+this.plotHeight-(m+legendHeight);if(p.charAt(1)=='e')
offsetX=plotOffset.left+this.plotWidth-(m+legendWidth);var color=Flotr.parseColor(options.legend.backgroundColor||'rgb(240,240,240)').scale(null,null,null,options.legend.backgroundOpacity||0.1).toString();ctx.fillStyle=color;ctx.fillRect(offsetX,offsetY,legendWidth,legendHeight);ctx.strokeStyle=options.legend.labelBoxBorderColor;ctx.strokeRect(Flotr.toPixel(offsetX),Flotr.toPixel(offsetY),legendWidth,legendHeight);var x=offsetX+lbm;var y=offsetY+lbm;for(i=0;i&lt;series.length;i++){if(!series[i].label||series[i].hide)
continue;var label=options.legend.labelFormatter(series[i].label);ctx.fillStyle=series[i].color;ctx.fillRect(x,y,lbw-1,lbh-1);ctx.strokeStyle=options.legend.labelBoxBorderColor;ctx.lineWidth=1;ctx.strokeRect(Math.ceil(x)-1.5,Math.ceil(y)-1.5,lbw+2,lbh+2);ctx.drawText(label,x+lbw+lbm,y+(lbh+style.size-ctx.fontDescent(style))/2,style);y+=lbh+lbm;}}else{for(i=0;i&lt;series.length;++i){if(!series[i].label||series[i].hide)
continue;if(i%options.legend.noColumns==0){fragments.push(rowStarted?'&lt;/tr&gt;&lt;tr&gt;':'&lt;tr&gt;');rowStarted=true;}
var label=options.legend.labelFormatter(series[i].label);fragments.push('&lt;td class=&quot;flotr-legend-color-box&quot;&gt;&lt;div style=&quot;border:1px solid '+options.legend.labelBoxBorderColor
+';padding:1px&quot;&gt;&lt;div style=&quot;width:'+options.legend.labelBoxWidth+'px;height:'+options.legend.labelBoxHeight
+'px;background-color:'+series[i].color+'&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;'+'&lt;td class=&quot;flotr-legend-label&quot;&gt;'+label+'&lt;/td&gt;');}
if(rowStarted)
fragments.push('&lt;/tr&gt;');if(fragments.length&gt;0){var table='&lt;table style=&quot;font-size:smaller;color:'+options.grid.color+'&quot;&gt;'+fragments.join(&quot;&quot;)+'&lt;/table&gt;';if(options.legend.container!=null){$(options.legend.container).update(table);}else{var pos='';var p=options.legend.position,m=options.legend.margin;if(p.charAt(0)=='n')
pos+='top:'+(m+plotOffset.top)+'px;';else if(p.charAt(0)=='s')
pos+='bottom:'+(m+plotOffset.bottom)+'px;';if(p.charAt(1)=='e')
pos+='right:'+(m+plotOffset.right)+'px;';else if(p.charAt(1)=='w')
pos+='left:'+(m+plotOffset.left)+'px;';var div=this.el.insert('&lt;div class=&quot;flotr-legend&quot; style=&quot;position:absolute;z-index:2;'+pos+'&quot;&gt;'+table+'&lt;/div&gt;').select('div.flotr-legend').first();if(options.legend.backgroundOpacity!=0.0){var c=options.legend.backgroundColor;if(c==null){var tmp=(options.grid.backgroundColor!=null)?options.grid.backgroundColor:Flotr.extractColor(div);c=Flotr.parseColor(tmp).adjust(null,null,null,1).toString();}
this.el.insert('&lt;div class=&quot;flotr-legend-bg&quot; style=&quot;position:absolute;width:'+div.getWidth()+'px;height:'+div.getHeight()
+'px;'+pos+'background-color:'+c+';&quot;&gt; &lt;/div&gt;').select('div.flotr-legend-bg').first().setStyle({'opacity':options.legend.backgroundOpacity});}}}}}},getEventPosition:function(event){var offset=this.overlay.cumulativeOffset(),rx=(event.pageX-offset.left-this.plotOffset.left),ry=(event.pageY-offset.top-this.plotOffset.top),ax=0,ay=0;if(event.pageX==null&amp;&amp;event.clientX!=null){var de=document.documentElement,b=document.body;ax=event.clientX+(de&amp;&amp;de.scrollLeft||b.scrollLeft||0);ay=event.clientY+(de&amp;&amp;de.scrollTop||b.scrollTop||0);}else{ax=event.pageX;ay=event.pageY;}
return{x:this.axes.x.min+rx/this.axes.x.scale,x2:this.axes.x2.min+rx/this.axes.x2.scale,y:this.axes.y.max-ry/this.axes.y.scale,y2:this.axes.y2.max-ry/this.axes.y2.scale,relX:rx,relY:ry,absX:ax,absY:ay};},clickHandler:function(event){if(this.ignoreClick){this.ignoreClick=false;return;}
this.el.fire('flotr:click',[this.getEventPosition(event),this]);},mouseMoveHandler:function(event){var pos=this.getEventPosition(event);this.lastMousePos.pageX=pos.absX;this.lastMousePos.pageY=pos.absY;if(this.selectionInterval==null&amp;&amp;(this.options.mouse.track||this.series.any(function(s){return s.mouse&amp;&amp;s.mouse.track;}))){this.hit(pos);}
this.el.fire('flotr:mousemove',[event,pos,this]);},mouseDownHandler:function(event){if(event.isRightClick()){event.stop();var overlay=this.overlay;overlay.hide();function cancelContextMenu(){overlay.show();$(document).stopObserving('mousemove',cancelContextMenu);}
$(document).observe('mousemove',cancelContextMenu);return;}
if(!this.options.selection.mode||!event.isLeftClick())
return;this.setSelectionPos(this.selection.first,event);if(this.selectionInterval!=null){clearInterval(this.selectionInterval);}
this.lastMousePos.pageX=null;this.selectionInterval=setInterval(this.updateSelection.bind(this),1000/this.options.selection.fps);this.mouseUpHandler=this.mouseUpHandler.bind(this);$(document).observe('mouseup',this.mouseUpHandler);},fireSelectEvent:function(){var a=this.axes,selection=this.selection,x1=(selection.first.x&lt;=selection.second.x)?selection.first.x:selection.second.x,x2=(selection.first.x&lt;=selection.second.x)?selection.second.x:selection.first.x,y1=(selection.first.y&gt;=selection.second.y)?selection.first.y:selection.second.y,y2=(selection.first.y&gt;=selection.second.y)?selection.second.y:selection.first.y;x1=a.x.min+x1/a.x.scale;x2=a.x.min+x2/a.x.scale;y1=a.y.max-y1/a.y.scale;y2=a.y.max-y2/a.y.scale;this.el.fire('flotr:select',[{x1:x1,y1:y1,x2:x2,y2:y2},this]);},mouseUpHandler:function(event){$(document).stopObserving('mouseup',this.mouseUpHandler);event.stop();if(this.selectionInterval!=null){clearInterval(this.selectionInterval);this.selectionInterval=null;}
this.setSelectionPos(this.selection.second,event);this.clearSelection();if(this.selectionIsSane()){this.drawSelection();this.fireSelectEvent();this.ignoreClick=true;}},setSelectionPos:function(pos,event){var options=this.options,offset=$(this.overlay).cumulativeOffset();if(options.selection.mode.indexOf('x')==-1){pos.x=(pos==this.selection.first)?0:this.plotWidth;}else{pos.x=event.pageX-offset.left-this.plotOffset.left;pos.x=Math.min(Math.max(0,pos.x),this.plotWidth);}
if(options.selection.mode.indexOf('y')==-1){pos.y=(pos==this.selection.first)?0:this.plotHeight;}else{pos.y=event.pageY-offset.top-this.plotOffset.top;pos.y=Math.min(Math.max(0,pos.y),this.plotHeight);}},updateSelection:function(){if(this.lastMousePos.pageX==null)
return;this.setSelectionPos(this.selection.second,this.lastMousePos);this.clearSelection();if(this.selectionIsSane())
this.drawSelection();},clearSelection:function(){if(this.prevSelection==null)
return;var prevSelection=this.prevSelection,octx=this.octx,plotOffset=this.plotOffset,x=Math.min(prevSelection.first.x,prevSelection.second.x),y=Math.min(prevSelection.first.y,prevSelection.second.y),w=Math.abs(prevSelection.second.x
-prevSelection.first.x),h=Math.abs(prevSelection.second.y-prevSelection.first.y);octx.clearRect(x+plotOffset.left-octx.lineWidth,y+plotOffset.top-octx.lineWidth,w+octx.lineWidth*2,h+octx.lineWidth*2);this.prevSelection=null;},setSelection:function(area){var options=this.options,xa=this.axes.x,ya=this.axes.y,vertScale=yaxis.scale,hozScale=xaxis.scale,selX=options.selection.mode.indexOf('x')!=-1,selY=options.selection.mode.indexOf('y')!=-1;this.clearSelection();this.selection.first.y=selX?0:(ya.max-area.y1)*vertScale;this.selection.second.y=selX?this.plotHeight:(ya.max-area.y2)*vertScale;this.selection.first.x=selY?0:(area.x1-xa.min)*hozScale;this.selection.second.x=selY?this.plotWidth:(area.x2-xa.min)*hozScale;this.drawSelection();this.fireSelectEvent();},drawSelection:function(){var prevSelection=this.prevSelection,selection=this.selection,octx=this.octx,options=this.options,plotOffset=this.plotOffset;if(prevSelection!=null&amp;&amp;selection.first.x==prevSelection.first.x&amp;&amp;selection.first.y==prevSelection.first.y&amp;&amp;selection.second.x==prevSelection.second.x&amp;&amp;selection.second.y==prevSelection.second.y)
return;octx.strokeStyle=Flotr.parseColor(options.selection.color).scale(null,null,null,0.8).toString();octx.lineWidth=1;octx.lineJoin='round';octx.fillStyle=Flotr.parseColor(options.selection.color).scale(null,null,null,0.4).toString();this.prevSelection={first:{x:selection.first.x,y:selection.first.y},second:{x:selection.second.x,y:selection.second.y}};var x=Math.min(selection.first.x,selection.second.x),y=Math.min(selection.first.y,selection.second.y),w=Math.abs(selection.second.x
-selection.first.x),h=Math.abs(selection.second.y-selection.first.y);octx.fillRect(x+plotOffset.left,y+plotOffset.top,w,h);octx.strokeRect(x+plotOffset.left,y+plotOffset.top,w,h);},selectionIsSane:function(){var selection=this.selection;return Math.abs(selection.second.x-selection.first.x)&gt;=5&amp;&amp;Math.abs(selection.second.y-selection.first.y)&gt;=5;},clearHit:function(){if(this.prevHit){var options=this.options,plotOffset=this.plotOffset,prevHit=this.prevHit;this.octx.clearRect(this.tHoz(prevHit.x)+plotOffset.left-options.points.radius*2,this.tVert(prevHit.y)+plotOffset.top
-options.points.radius*2,options.points.radius*3+options.points.lineWidth*3,options.points.radius*3
+options.points.lineWidth*3);this.prevHit=null;}},hit:function(mouse){var series=this.series,options=this.options,prevHit=this.prevHit,plotOffset=this.plotOffset,octx=this.octx,data,xsens,ysens,i,n={dist:Number.MAX_VALUE,x:null,y:null,relX:mouse.relX,relY:mouse.relY,absX:mouse.absX,absY:mouse.absY,mouse:null,serie:null,primaryKey:null,pointTag:null};for(i=0;i&lt;series.length;i++){s=series[i];if(!s.mouse.track)
continue;data=s.data;xsens=(s.xaxis.scale*s.mouse.sensibility);ysens=(s.yaxis.scale*s.mouse.sensibility);for(var j=0,xpow,ypow;j&lt;data.length;j++){if(data[j][1]===null)
continue;xpow=Math.pow(s.xaxis.scale*(data[j][0]-mouse.x),2);ypow=Math.pow(s.yaxis.scale*(data[j][1]-mouse.y),2);if(xpow&lt;xsens&amp;&amp;ypow&lt;ysens&amp;&amp;Math.sqrt(xpow+ypow)&lt;n.dist){n.dist=Math.sqrt(xpow+ypow);n.x=data[j][0];n.y=data[j][1];n.primaryKey=data[j][2];n.pointTag=data[j][3];n.mouse=s.mouse;n.serie=s;}}}
if(n.mouse&amp;&amp;n.mouse.track&amp;&amp;!prevHit||(prevHit&amp;&amp;(n.x!=prevHit.x||n.y!=prevHit.y))){var mt=this.mouseTrack||this.el.select(&quot;.flotr-mouse-value&quot;)[0],pos='',p=options.mouse.position,m=options.mouse.margin,elStyle='opacity:0.7;background-color:#000;color:#fff;display:none;position:absolute;padding:2px 8px;-moz-border-radius:4px;border-radius:4px;white-space:nowrap;';if(!options.mouse.relative){if(p.charAt(0)=='n')
pos+='top:'+(m+plotOffset.top)+'px;';else if(p.charAt(0)=='s')
pos+='bottom:'+(m+plotOffset.bottom)+'px;';if(p.charAt(1)=='e')
pos+='right:'+(m+plotOffset.right)+'px;';else if(p.charAt(1)=='w')
pos+='left:'+(m+plotOffset.left)+'px;';}else{if(p.charAt(0)=='n')
pos+='bottom:'+(m-plotOffset.top-this.tVert(n.y)+this.canvasHeight)+'px;';else if(p.charAt(0)=='s')
pos+='top:'+(m+plotOffset.top+this.tVert(n.y))+'px;';if(p.charAt(1)=='e')
pos+='left:'+(m+plotOffset.left+this.tHoz(n.x))+'px;';else if(p.charAt(1)=='w')
pos+='right:'+(m-plotOffset.left-this.tHoz(n.x)+this.canvasWidth)+'px;';}
elStyle+=pos;if(!mt){this.el.insert('&lt;div class=&quot;flotr-mouse-value&quot; style=&quot;'+elStyle+'&quot;&gt;&lt;/div&gt;');mt=this.mouseTrack=this.el.select('.flotr-mouse-value').first();}else{this.mouseTrack=mt.setStyle(elStyle);}
if(n.x!==null&amp;&amp;n.y!==null){mt.show();this.clearHit();if(n.mouse.lineColor!=null){octx.save();octx.translate(plotOffset.left,plotOffset.top);octx.lineWidth=options.points.lineWidth;octx.strokeStyle=n.mouse.lineColor;octx.fillStyle='#ffffff';octx.beginPath();octx.arc(this.tHoz(n.x),this.tVert(n.y),options.mouse.radius,0,2*Math.PI,true);octx.fill();octx.stroke();octx.restore();}
this.prevHit=n;var decimals=n.mouse.trackDecimals;if(decimals==null||decimals&lt;0)
decimals=0;mt.innerHTML=n.pointTag;mt.fire('flotr:hit',[n,this]);}else if(prevHit){mt.hide();this.clearHit();}}},saveImage:function(type,fileName,width,height,replaceCanvas){var image=null;switch(type){case'jpeg':case'jpg':image=Canvas2Image.saveAsJPEG(this.canvas,replaceCanvas,width,height);break;default:case'png':image=Canvas2Image.saveAsPNG(this.canvas,fileName,replaceCanvas,width,height);break;case'bmp':image=Canvas2Image.saveAsBMP(this.canvas,replaceCanvas,width,height);break;}
if(Object.isElement(image)&amp;&amp;replaceCanvas){this.restoreCanvas();this.canvas.hide();this.overlay.hide();this.el.insert(image.setStyle({position:'absolute'}));}},restoreCanvas:function(){this.canvas.show();this.overlay.show();this.el.select('img').invoke('remove');}});Flotr.Color=Class.create({initialize:function(r,g,b,a){this.rgba=['r','g','b','a'];var x=4;while(-1&lt;--x){this[this.rgba[x]]=arguments[x]||((x==3)?1.0:0);}
this.normalize();},adjust:function(rd,gd,bd,ad){var x=4;while(-1&lt;--x){if(arguments[x]!=null)
this[this.rgba[x]]+=arguments[x];}
return this.normalize();},clone:function(){return new Flotr.Color(this.r,this.b,this.g,this.a);},limit:function(val,minVal,maxVal){return Math.max(Math.min(val,maxVal),minVal);},normalize:function(){var limit=this.limit;this.r=limit(parseInt(this.r),0,255);this.g=limit(parseInt(this.g),0,255);this.b=limit(parseInt(this.b),0,255);this.a=limit(this.a,0,1);return this;},scale:function(rf,gf,bf,af){var x=4;while(-1&lt;--x){if(arguments[x]!=null)
this[this.rgba[x]]*=arguments[x];}
return this.normalize();},distance:function(color){if(!color)
return;color=new Flotr.parseColor(color);var dist=0;var x=3;while(-1&lt;--x){dist+=Math.abs(this[this.rgba[x]]-color[this.rgba[x]]);}
return dist;},toString:function(){return(this.a&gt;=1.0)?'rgb('+[this.r,this.g,this.b].join(',')+')':'rgba('+[this.r,this.g,this.b,this.a].join(',')+')';}});Flotr.Color.lookupColors={aqua:[0,255,255],azure:[240,255,255],beige:[245,245,220],black:[0,0,0],blue:[0,0,255],brown:[165,42,42],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgrey:[169,169,169],darkgreen:[0,100,0],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkviolet:[148,0,211],fuchsia:[255,0,255],gold:[255,215,0],green:[0,128,0],indigo:[75,0,130],khaki:[240,230,140],lightblue:[173,216,230],lightcyan:[224,255,255],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightyellow:[255,255,224],lime:[0,255,0],magenta:[255,0,255],maroon:[128,0,0],navy:[0,0,128],olive:[128,128,0],orange:[255,165,0],pink:[255,192,203],purple:[128,0,128],violet:[128,0,128],red:[255,0,0],silver:[192,192,192],white:[255,255,255],yellow:[255,255,0]};Flotr.Date={format:function(d,format){if(!d)
return;var leftPad=function(n){n=n.toString();return n.length==1?&quot;0&quot;+n:n;};var r=[];var escape=false;for(var i=0;i&lt;format.length;++i){var c=format.charAt(i);if(escape){switch(c){case'h':c=d.getUTCHours().toString();break;case'H':c=leftPad(d.getUTCHours());break;case'M':c=leftPad(d.getUTCMinutes());break;case'S':c=leftPad(d.getUTCSeconds());break;case'd':c=d.getUTCDate().toString();break;case'm':c=(d.getUTCMonth()+1).toString();break;case'y':c=d.getUTCFullYear().toString();break;case'b':c=Flotr.Date.monthNames[d.getUTCMonth()];break;}
r.push(c);escape=false;}else{if(c==&quot;%&quot;)
escape=true;else
r.push(c);}}
return r.join(&quot;&quot;);},timeUnits:{&quot;second&quot;:1000,&quot;minute&quot;:60*1000,&quot;hour&quot;:60*60*1000,&quot;day&quot;:24*60*60*1000,&quot;month&quot;:30*24*60*60*1000,&quot;year&quot;:365.2425*24*60*60*1000},spec:[[1,&quot;second&quot;],[2,&quot;second&quot;],[5,&quot;second&quot;],[10,&quot;second&quot;],[30,&quot;second&quot;],[1,&quot;minute&quot;],[2,&quot;minute&quot;],[5,&quot;minute&quot;],[10,&quot;minute&quot;],[30,&quot;minute&quot;],[1,&quot;hour&quot;],[2,&quot;hour&quot;],[4,&quot;hour&quot;],[8,&quot;hour&quot;],[12,&quot;hour&quot;],[1,&quot;day&quot;],[2,&quot;day&quot;],[3,&quot;day&quot;],[0.25,&quot;month&quot;],[0.5,&quot;month&quot;],[1,&quot;month&quot;],[2,&quot;month&quot;],[3,&quot;month&quot;],[6,&quot;month&quot;],[1,&quot;year&quot;]],monthNames:[&quot;Jan&quot;,&quot;Feb&quot;,&quot;Mar&quot;,&quot;Apr&quot;,&quot;May&quot;,&quot;Jun&quot;,&quot;Jul&quot;,&quot;Aug&quot;,&quot;Sep&quot;,&quot;Oct&quot;,&quot;Nov&quot;,&quot;Dec&quot;]};Ext.namespace('sitools.user.component');sitools.user.component.dataPlotter=function(config){Ext.apply(this,config);this.dataUrl=config.dataUrl;this.datasetName=config.datasetName;this.datasetId=config.datasetId;this.hasPlotted=false;function getNumericFields(arrayFields){var numericFields=[];var store=new Ext.data.JsonStore({fields:[{name:&quot;columnAlias&quot;,type:&quot;string&quot;},{name:&quot;sqlColumnType&quot;,type:&quot;string&quot;}]});Ext.each(arrayFields,function(field){if(!Ext.isEmpty(field.sqlColumnType)){var extType=sql2ext.get(field.sqlColumnType);if(extType.match(/^(numeric)+[48]?$/gi)!==null&amp;&amp;!field.hidden){store.add(new Ext.data.Record(field));}
if(extType.match(/dateAsString/gi)!==null&amp;&amp;!field.hidden){store.add(new Ext.data.Record(field));}}},this);return store;}
function getVisibleFields(arrayFields){var visibleFields=[];Ext.each(arrayFields,function(field){if(!field.hidden){visibleFields.push(field.columnAlias);}},this);return visibleFields;}
this.bufferRange=300;var dataUrl=config.dataUrl;this.columnModel=config.columnModel;var initialFields=getNumericFields(this.columnModel);var pointTagFields=getVisibleFields(this.columnModel);this.isSelection=!Ext.isEmpty(config.selections);this.titleX=new Ext.form.Field({fieldLabel:i18n.get('label.plot.form.xlabel'),anchor:&quot;95%&quot;,name:&quot;titleX&quot;,listeners:{scope:this,change:this.handlePlotLayout}});this.xFormat=null;this.titleY=new Ext.form.Field({fieldLabel:i18n.get('label.plot.form.ylabel'),anchor:&quot;95%&quot;,name:&quot;titleY&quot;,listeners:{scope:this,change:this.handlePlotLayout}});this.yFormat=null;this.comboX=new Ext.form.ComboBox({store:initialFields,anchor:&quot;95%&quot;,name:&quot;comboX&quot;,allowBlank:false,emptyText:i18n.get('label.plot.select.xaxis'),fieldLabel:i18n.get('label.plot.select.xcolumn'),selectOnFocus:true,triggerAction:'all',valueField:&quot;columnAlias&quot;,displayField:&quot;columnAlias&quot;,editable:false,mode:'local',listeners:{scope:this,select:function(combo,record,index){this.titleX.setValue(combo.getValue());var extType=sql2ext.get(record.get(&quot;sqlColumnType&quot;));if(extType.match(/dateAsString/gi)!==null){if(Ext.isEmpty(this.xFormat)){this.xFormat=new Ext.form.Field({fieldLabel:i18n.get('label.plot.form.xFormat'),anchor:&quot;95%&quot;,name:&quot;xFormat&quot;,value:config.userPreference&amp;&amp;config.userPreference.xFormat?config.userPreference.xFormat:SITOOLS_DEFAULT_IHM_DATE_FORMAT,listeners:{scope:this,change:this.handlePlotLayout}});this.fieldSetX.insert(1,this.xFormat);}}
else{this.fieldSetX.remove(this.xFormat);this.xFormat=null;}
this.fieldSetX.doLayout();},expand:function(combo){combo.store.clearFilter(true);if(this.comboY.getValue()!==''&amp;&amp;this.comboY.getValue()!==null){combo.store.filterBy(function(record,id){return record.get('field1')!==this.comboY.getValue();},this);}}}});this.comboY=new Ext.form.ComboBox({store:initialFields,name:&quot;comboY&quot;,allowBlank:false,anchor:&quot;95%&quot;,emptyText:i18n.get('label.plot.select.yaxis'),fieldLabel:i18n.get('label.plot.select.ycolumn'),selectOnFocus:true,editable:false,valueField:&quot;columnAlias&quot;,displayField:&quot;columnAlias&quot;,triggerAction:'all',mode:'local',listeners:{scope:this,select:function(combo,record,index){this.titleY.setValue(combo.getValue());var extType=sql2ext.get(record.get(&quot;sqlColumnType&quot;));if(extType.match(/dateAsString/gi)!==null){if(Ext.isEmpty(this.yFormat)){this.yFormat=new Ext.form.Field({fieldLabel:i18n.get('label.plot.form.yFormat'),anchor:&quot;95%&quot;,name:&quot;yFormat&quot;,value:config.userPreference&amp;&amp;config.userPreference.yFormat?config.userPreference.yFormat:SITOOLS_DEFAULT_IHM_DATE_FORMAT,listeners:{scope:this,change:this.handlePlotLayout}});this.fieldSetY.insert(1,this.yFormat);}}
else{this.fieldSetY.remove(this.yFormat);this.yFormat=null;}
this.fieldSetY.doLayout();},expand:function(combo){combo.store.clearFilter(true);if(this.comboX.getValue()!==''&amp;&amp;this.comboX.getValue()!==null){combo.store.filterBy(function(record,id){return record.get('field1')!==this.comboX.getValue();},this);}}}});this.titlePlot=new Ext.form.Field({anchor:&quot;95%&quot;,fieldLabel:i18n.get('label.plot.form.title'),name:&quot;titlePlot&quot;,listeners:{scope:this,change:this.handlePlotLayout}});var numberRecords=new Ext.form.NumberField({anchor:&quot;95%&quot;,fieldLabel:i18n.get('label.plot.form.nbRecords'),name:&quot;nbRecords&quot;,value:DEFAULT_LIVEGRID_BUFFER_SIZE,disabled:this.isSelection,allowBlank:false});this.checkLine=new Ext.form.Checkbox({fieldLabel:i18n.get('label.plot.form.drawline'),name:&quot;checkLine&quot;,scope:this,listeners:{scope:this,check:this.handlePlotLayout}});this.comboTag=new Ext.form.ComboBox({store:pointTagFields,name:&quot;this.comboTag&quot;,anchor:&quot;95%&quot;,allowBlank:true,emptyText:i18n.get('label.plot.select.tag'),fieldLabel:i18n.get('label.plot.select.tagcolumn'),selectOnFocus:true,triggerAction:'all',mode:'local',scope:this,listeners:{scope:this,select:this.handlePlotLayout}});this.comboXColor=new sitools.widget.colorField({fieldLabel:i18n.get('label.plot.label.color'),anchor:&quot;95%&quot;,name:&quot;comboXColor&quot;,value:&quot;#000000&quot;,listeners:{scope:this,select:this.handlePlotLayout}});this.comboYColor=new sitools.widget.colorField({fieldLabel:i18n.get('label.plot.label.color'),anchor:&quot;95%&quot;,name:&quot;comboYColor&quot;,value:&quot;#000000&quot;,listeners:{scope:this,select:this.handlePlotLayout}});this.fieldSetX=new Ext.form.FieldSet({title:i18n.get('title.plot.xAxis'),items:[this.comboX,this.titleX,this.comboXColor],collapsible:true});this.fieldSetY=new Ext.form.FieldSet({title:i18n.get('title.plot.yAxis'),items:[this.comboY,this.titleY,this.comboYColor],collapsible:true});var urlRecords=config.dataUrl+'/records';if(this.isSelection){urlRecords+=&quot;?1=1&amp;&quot;+config.selections;}
var sitoolsAttachementForUsers=config.dataUrl;this.storeData=new sitools.user.component.dataviews.tplView.StoreTplView({datasetCm:this.columnModel,urlRecords:urlRecords,sitoolsAttachementForUsers:sitoolsAttachementForUsers,userPreference:config.userPreference,formParams:(!this.isSelection?config.formParams:undefined),formMultiDsParams:(!this.isSelection?config.formMultiDsParams:undefined),mainView:this,datasetId:config.datasetId,isFirstCountDone:false,autoLoad:false,filters:config.filters});this.storeData.addListener(&quot;load&quot;,function(store,records,options){this.displayPlot(records);},this);this.storeData.on(&quot;beforeload&quot;,function(store,options){var noCount;if(!store.isFirstCountDone){options.params.nocount=false;}else{options.params.nocount=true;}
if(!this.isSelection&amp;&amp;!Ext.isEmpty(store.filters)){var params=store.buildQuery(store.filters.getFilterData());Ext.apply(options.params,params);}
this.storeData.storeOptions(options);},this);this.drawPlotButton=new Ext.Button({text:i18n.get('label.plot.draw'),disabled:true,listeners:{scope:this,click:function(button,e){var form=this.leftPanel.getForm();var pageSize=form.findField(&quot;nbRecords&quot;).getValue();if(pageSize&gt;WARNING_NB_RECORDS_PLOT){Ext.Msg.show({title:i18n.get(&quot;label.warning&quot;),msg:String.format(i18n.get(&quot;label.plot.toManyRecordsAsked&quot;),pageSize,WARNING_NB_RECORDS_PLOT),buttons:Ext.Msg.YESNO,icon:Ext.MessageBox.WARNING,scope:this,fn:function(buttonId){if(buttonId==='yes'){this.loadPlot(pageSize);}}});}else{this.loadPlot(pageSize);}}}});var bbar;if(this.isSelection){bbar=new Ext.Toolbar({hidden:true,items:['-&gt;',{id:'plot-tb-text',xtype:'tbtext'}]});}else{bbar=new Ext.PagingToolbar({hidden:true,store:this.storeData,displayInfo:true,pageSize:DEFAULT_LIVEGRID_BUFFER_SIZE,items:[]});}
this.rightPanel=new Ext.Panel({id:'plot-right-panel',title:i18n.get('title.plot.panel'),region:'center',margins:'2 2 2 1',scope:this,listeners:{scope:this,bodyresize:function(window,width,height){if(this.isVisible()&amp;&amp;this.hasPlotted){if(!Ext.isEmpty(this.storeData.data)){this.displayPlot(this.storeData.data.items);}}},afterRender:function(){this.loadMask=new Ext.LoadMask(this.rightPanel.getEl(),{msg:i18n.get(&quot;label.plot.waitForPlot&quot;),store:this.storeData});}},bbar:bbar});this.leftPanel=new Ext.FormPanel({title:i18n.get('title.plot.form'),region:'west',split:true,width:300,autoScroll:true,collapsible:true,margins:'2 1 2 2',cmargins:'2 2 2 2',padding:'5',monitorValid:true,items:[this.titlePlot,numberRecords,this.checkLine,this.comboTag,this.fieldSetX,this.fieldSetY],buttons:[this.drawPlotButton],listeners:{scope:this,clientvalidation:function(panel,valid){if(valid&amp;&amp;(this.comboX.getValue()!==this.comboY.getValue())){this.drawPlotButton.setDisabled(false);}else{this.drawPlotButton.setDisabled(true);}}}});sitools.user.component.dataPlotter.superclass.constructor.call(this,Ext.apply({id:'plot-panel',datasetName:config.datasetName,layout:'border',items:[this.leftPanel,this.rightPanel]},config));};Ext.extend(sitools.user.component.dataPlotter,Ext.Panel,{_getSettings:function(){return{datasetName:this.datasetName,leftPanelValues:this.leftPanel.getForm().getValues(),preferencesPath:this.preferencesPath,preferencesFileName:this.preferencesFileName};},afterRender:function(){sitools.user.component.dataPlotter.superclass.afterRender.call(this);this.el.on(&quot;contextmenu&quot;,function(e,t,o){e.stopEvent();if(this.hasPlotted){var ctxMenu=new Ext.menu.Menu({items:[{text:i18n.get('label.plot.savePng'),scope:this,handler:function(){this.plot.saveImage(&quot;png&quot;,&quot;plotImage&quot;);}}]});ctxMenu.showAt(e.getXY());}},this);if(Ext.isEmpty(this.userPreference)){return;}
var record,idx;this.leftPanel.getForm().loadRecord(new Ext.data.Record(this.userPreference.leftPanelValues));var comboX=this.leftPanel.find(&quot;name&quot;,&quot;comboX&quot;)[0];if(!Ext.isEmpty(this.comboX.getValue())){idx=this.comboX.getStore().find(&quot;columnAlias&quot;,this.userPreference.comboX);record=this.comboX.getStore().getAt(idx);if(record){this.comboX.fireEvent(&quot;select&quot;,this.comboX,record,idx);}}
var comboY=this.leftPanel.find(&quot;name&quot;,&quot;comboY&quot;)[0];if(!Ext.isEmpty(this.comboY.getValue())){idx=this.comboY.getStore().find(&quot;columnAlias&quot;,this.userPreference.comboY);record=this.comboY.getStore().getAt(idx);if(record){this.comboY.fireEvent(&quot;select&quot;,this.comboY,record,idx);}}
this.leftPanel.getForm().loadRecord(new Ext.data.Record(this.userPreference));},displayPlot:function(records){this.storeData.isFirstCountDone=true;var plotConfig=this.getPlotConfig(this.columnModel,records);this.plot=Flotr.draw($(this.rightPanel.body.id),[plotConfig.data],plotConfig.config);$(this.rightPanel.body.id).stopObserving('flotr:click');$(this.rightPanel.body.id).observe('flotr:click',this.showDataDetail.bindAsEventListener(this));$(this.rightPanel.body.id).stopObserving('flotr:select');$(this.rightPanel.body.id).observe('flotr:select',function(evt){var area=evt.memo[0];var options=plotConfig.config;options.xaxis.min=area.x1;options.xaxis.max=area.x2;options.yaxis.min=area.y1;options.yaxis.max=area.y2;this.plot=Flotr.draw($(this.id),[plotConfig.data],options);});this.hasPlotted=true;if(this.isSelection){this.rightPanel.getBottomToolbar().findById('plot-tb-text').setText(String.format(i18n.get(&quot;label.plot.displayNbRecords&quot;),records.length));}
this.rightPanel.getBottomToolbar().setVisible(true);this.doLayout();},loadPlot:function(pageSize){var form=this.leftPanel.getForm();if(!this.isSelection){this.rightPanel.getBottomToolbar().pageSize=pageSize;}
this.storeData.load({params:{start:0,limit:pageSize}});},createData:function(columnModel,storeItems){var outData=[];Ext.each(storeItems,function(item){var tag=this.comboTag.getValue()!==''?item.get(this.comboTag.getValue()):null;var colXType=sql2ext.get(this.getColumn(columnModel,this.comboX.getValue()).sqlColumnType);var colYType=sql2ext.get(this.getColumn(columnModel,this.comboY.getValue()).sqlColumnType);var xValue,yValue;switch(colXType){case&quot;dateAsString&quot;:xValue=Date.parseDate(item.get(this.comboX.getValue()),SITOOLS_DATE_FORMAT,true);if(!Ext.isEmpty(xValue)){xValue=xValue.getTime();}
break;case&quot;numeric&quot;:xValue=parseFloat(item.get(this.comboX.getValue()));break;default:xValue=item.get(this.comboX.getValue());break;}
switch(colYType){case&quot;dateAsString&quot;:var value=item.get(this.comboY.getValue());yValue=Date.parseDate(value,SITOOLS_DATE_FORMAT,true);if(!Ext.isEmpty(yValue)){yValue=yValue.getTime();}
break;case&quot;numeric&quot;:yValue=parseFloat(item.get(this.comboY.getValue()));break;default:yValue=item.get(this.comboY.getValue());break;}
outData.push([xValue,yValue,item.id,tag?tag:item.id]);},this);return outData;},getColumn:function(columnModel,columnAlias){var result;for(var i=0;i&lt;columnModel.length;i++){if(columnModel[i].columnAlias==columnAlias){result=columnModel[i];}}
return result;},getPlotConfig:function(columnModel,newdata){var d1=this.createData(columnModel,newdata);var yAxisFormat=&quot;Normal&quot;;var colY=this.getColumn(columnModel,this.comboY.getValue());var colYType=sql2ext.get(colY.sqlColumnType);var xAxisFormat=&quot;Normal&quot;;var colX=this.getColumn(columnModel,this.comboX.getValue());var colXType=sql2ext.get(colX.sqlColumnType);var colXFormater=function(value){if(colXType==&quot;dateAsString&quot;){var dt=new Date();dt.setTime(value);return dt.format(this.xFormat?this.xFormat.getValue():SITOOLS_DEFAULT_IHM_DATE_FORMAT);}
return value;};var colYFormater=function(value){if(colYType==&quot;dateAsString&quot;){var dt=new Date();dt.setTime(value);return dt.format(this.yFormat?this.yFormat.getValue():SITOOLS_DEFAULT_IHM_DATE_FORMAT);}
return value;}
var plotConfig={HtmlText:false,colors:['#00A8F0','#C0D800','#cb4b4b','#4da74d','#9440ed'],title:this.titlePlot.getValue(),legend:{show:true,noColumns:1,labelFormatter:null,labelBoxBorderColor:'#ccc',container:null,position:'ne',margin:5,backgroundColor:'#CCCCCC',backgroundOpacity:1.0},xaxis:{ticks:null,noTicks:5,color:this.comboXColor.getValue()?this.comboXColor.getValue():&quot;#000000&quot;,tickFormatter:colXFormater.bind(this),tickDecimals:null,min:null,max:null,autoscaleMargin:0,title:this.titleX.getValue(),mode:colXType==&quot;dateAsString&quot;?&quot;time&quot;:&quot;Normal&quot;,labelsAngle:colXType==&quot;dateAsString&quot;?45:0,timeFormat:this.xFormat?this.xFormat.getValue():SITOOLS_DATE_FORMAT},yaxis:{ticks:null,color:this.comboYColor.getValue()?this.comboYColor.getValue():&quot;#000000&quot;,noTicks:5,tickDecimals:null,tickFormatter:colYFormater.bind(this),min:null,max:null,autoscaleMargin:0,title:this.titleY.getValue(),mode:colYType==&quot;dateAsString&quot;?&quot;time&quot;:&quot;Normal&quot;,labelsAngle:0,timeFormat:SITOOLS_DATE_FORMAT},y2axis:{title:' '},points:{show:true,radius:3,lineWidth:2,fill:true,fillColor:'#ffffff'},lines:{show:this.checkLine.getValue(),lineWidth:0.1,fill:false,fillColor:null},grid:{color:'#545454',backgroundColor:'#FFFFFF',tickColor:'#dddddd',labelMargin:3},selection:{mode:'xy',color:'#B6D9FF',fps:10},spreadsheet:{show:false},mouse:{track:true,position:'se',margin:2,color:'#ff3f19',trackDecimals:1,sensibility:10*1000000000,radius:3},shadowSize:4};var out={data:d1,config:plotConfig};return out;},showDataDetail:function(evt){var idx=encodeURIComponent(evt.memo[1].prevHit.primaryKey);var jsObj=sitools.user.component.viewDataDetail;var componentCfg={datasetUrl:this.dataUrl,baseUrl:this.dataUrl+'/records',datasetId:this.datasetId,fromWhere:&quot;plot&quot;,url:this.dataUrl+'/records/'+idx,preferencesPath:&quot;/&quot;+this.datasetName,preferencesFileName:&quot;dataDetails&quot;};var windowConfig={id:&quot;simpleDataDetail&quot;+this.datasetId,title:i18n.get('label.viewDataDetail')+&quot; : &quot;+evt.memo[1].prevHit.primaryKey,datasetName:this.datasetName,saveToolbar:false,type:&quot;simpleDataDetail&quot;,iconCls:&quot;dataDetail&quot;};SitoolsDesk.addDesktopWindow(windowConfig,componentCfg,jsObj,true);},handlePlotLayout:function(){if(this.hasPlotted){this.displayPlot(this.storeData.data.items);}}});Ext.reg('sitools.user.component.dataPlotter',sitools.user.component.dataPlotter);Ext.ns('sitools.widget');sitools.widget.WindowImageViewer=Ext.extend(Ext.Window,{resizeImage:false,maximizable:true,modal:true,minHeight:0,minWidth:0,initComponent:function(){if(!this.resizeImage){this.panel=new Ext.Panel({bodyCfg:{tag:'img',src:this.src},listeners:{scope:this,render:function(){this.panel.body.on('load',this.onImageLoad,this,{single:true});}}});this.items=[this.panel];this.autoScroll=true;}else{this.bodyCfg={tag:'img',src:this.src};}
this.constrain=true;sitools.widget.WindowImageViewer.superclass.initComponent.apply(this,arguments);},onRender:function(){sitools.widget.WindowImageViewer.superclass.onRender.apply(this,arguments);if(this.resizeImage){this.body.on('load',this.onImageLoad,this,{single:true});}},onImageLoad:function(){var imgTag=Ext.DomQuery.select(&quot;div[id='&quot;+this.id+&quot;'] img&quot;)[0];var hi=this.body.dom.offsetHeight;var wi=this.body.dom.offsetWidth;var hiImg=imgTag.offsetHeight;var wiImg=imgTag.offsetWidth;if(!this.resizeImage){this.panel.setSize(wiImg,hiImg);}
var desktop=getDesktop();var ww=desktop.getWinWidth();var hw=desktop.getWinHeight();var reduce=false;if(hi&gt;hw){wi=wi*hw/hi;hi=hw;reduce=true;}
if(wi&gt;ww){hi=hi*ww/wi;wi=ww;reduce=true;}
if(reduce){hi*=0.9;wi*=0.9;}
this.setSize(wi+this.getFrameWidth(),hi+this.getFrameHeight());this.center();},setSrc:function(src){var panel;if(resizeImage){panel=this;}else{panel=this.panel;}
panel.body.on('load',this.onImageLoad,this,{single:true});panel.body.dom.style.width=panel.body.dom.style.width='auto';panel.body.dom.src=src;},initEvents:function(){sitools.widget.WindowImageViewer.superclass.initEvents.apply(this,arguments);if(this.resizer&amp;&amp;this.resizeImage){this.resizer.preserveRatio=true;}}});sitools.widget.PanelImageViewer=Ext.extend(Ext.Panel,{initComponent:function(){this.bodyCfg={tag:'img',src:this.src};sitools.widget.PanelImageViewer.superclass.initComponent.apply(this,arguments);},onRender:function(){sitools.widget.PanelImageViewer.superclass.onRender.apply(this,arguments);this.body.on('load',this.onImageLoad,this,{single:true});},onImageLoad:function(){var h=this.getFrameHeight(),w=this.getFrameWidth();this.setSize(this.body.dom.offsetWidth+w,this.body.dom.offsetHeight+h);if(Ext.isIE){this.center();}},setSrc:function(src){this.body.on('load',this.onImageLoad,this,{single:true});this.body.dom.style.width=this.body.dom.style.width='auto';this.body.dom.src=src;},initEvents:function(){sitools.widget.PanelImageViewer.superclass.initEvents.apply(this,arguments);if(this.resizer){this.resizer.preserveRatio=true;}},showMeInFixedNav:function(me,config){me.show();},showMeInDesktopNav:function(me,config){me.show();}});Ext.namespace('sitools.component.version');sitools.component.version.sitoolsVersion=Ext.extend(Ext.Panel,{layout:'fit',version:null,initComponent:function(){this.versionUrl=loadUrl.get('APP_URL')+'/version';var title=new Ext.form.Label({html:'&lt;h2&gt;SITools2&lt;/h2'});var logo=new Ext.form.Label({html:'&lt;img src='+loadUrl.get('APP_URL')+'/res/images/logo_02_tailleMoyenne.png&gt;'});var credits=new Ext.form.Label({html:'&lt;p&gt;Copyright 2010, 2011, 2012 CNES&lt;/p&gt;'});var website=new Ext.form.Label({html:'&lt;a href=&quot;http://www.sitools2.sourceforge.net&quot;&gt;sitools2.sourceforge.net&lt;/&gt;'});this.versionLabel=new Ext.form.Label({});var panelVersion=new Ext.Panel({title:i18n.get(&quot;label.version&quot;),layout:'fit',padding:10});var panelLicence=new Ext.ux.ManagedIFrame.Panel({title:i18n.get(&quot;label.licence&quot;),layout:'fit',defaultSrc:loadUrl.get('APP_URL')+&quot;/res/licences/gpl-3.0.txt&quot;});panelVersion.add([logo,title,this.versionLabel,credits,website]);this.tabs=new Ext.TabPanel({activeTab:0,items:[panelVersion,panelLicence]});this.items=[this.tabs];this.listeners={scope:this,resize:function(window){var size=window.body.getSize();this.tabs.setSize(size);}};sitools.component.version.sitoolsVersion.superclass.initComponent.call(this);},afterRender:function(){sitools.component.version.sitoolsVersion.superclass.afterRender.apply(this,arguments);Ext.Ajax.request({url:this.versionUrl,method:'GET',scope:this,success:function(ret){var json=Ext.decode(ret.responseText);if(!json.success){Ext.Msg.alert(i18n.get('label.warning'),json.message);return false;}
this.version=json.version;this.versionLabel.setText(&quot;&lt;h3&gt;Version : &quot;+this.version+&quot;&lt;/h3&gt;&quot;,false);},failure:alertFailure});var size=this.ownerCt.body.getSize();this.tabs.setSize(size);}});function showVersion(){var versionHelp=Ext.getCmp('winVersionId');if(!versionHelp){var panelHelp=new sitools.component.version.sitoolsVersion();versionHelp=new Ext.Window({title:i18n.get('label.version'),id:'winVersionId',items:[panelHelp],modal:false,width:700,height:480,resizable:false,modal:true,buttons:[{text:i18n.get('label.close'),handler:function(){this.ownerCt.ownerCt.close();}}]});versionHelp.show();}else{versionHelp.show();}}
Ext.ux.Spinner=Ext.extend(Ext.util.Observable,{incrementValue:1,alternateIncrementValue:5,triggerClass:'x-form-spinner-trigger',splitterClass:'x-form-spinner-splitter',alternateKey:Ext.EventObject.shiftKey,defaultValue:0,accelerate:false,constructor:function(config){Ext.ux.Spinner.superclass.constructor.call(this,config);Ext.apply(this,config);this.mimicing=false;},init:function(field){this.field=field;field.afterMethod('onRender',this.doRender,this);field.afterMethod('onEnable',this.doEnable,this);field.afterMethod('onDisable',this.doDisable,this);field.afterMethod('afterRender',this.doAfterRender,this);field.afterMethod('onResize',this.doResize,this);field.afterMethod('onFocus',this.doFocus,this);field.beforeMethod('onDestroy',this.doDestroy,this);},doRender:function(ct,position){var el=this.el=this.field.getEl();var f=this.field;if(!f.wrap){f.wrap=this.wrap=el.wrap({cls:&quot;x-form-field-wrap&quot;});}
else{this.wrap=f.wrap.addClass('x-form-field-wrap');}
this.trigger=this.wrap.createChild({tag:&quot;img&quot;,src:Ext.BLANK_IMAGE_URL,cls:&quot;x-form-trigger &quot;+this.triggerClass});if(!f.width){this.wrap.setWidth(el.getWidth()+this.trigger.getWidth());}
this.splitter=this.wrap.createChild({tag:'div',cls:this.splitterClass,style:'width:13px; height:2px;'});this.splitter.setRight((Ext.isIE)?1:2).setTop(10).show();this.proxy=this.trigger.createProxy('',this.splitter,true);this.proxy.addClass(&quot;x-form-spinner-proxy&quot;);this.proxy.setStyle('left','0px');this.proxy.setSize(14,1);this.proxy.hide();this.dd=new Ext.dd.DDProxy(this.splitter.dom.id,&quot;SpinnerDrag&quot;,{dragElId:this.proxy.id});this.initTrigger();this.initSpinner();},doAfterRender:function(){var y;if(Ext.isIE&amp;&amp;this.el.getY()!=(y=this.trigger.getY())){this.el.position();this.el.setY(y);}},doEnable:function(){if(this.wrap){this.wrap.removeClass(this.field.disabledClass);}},doDisable:function(){if(this.wrap){this.wrap.addClass(this.field.disabledClass);this.el.removeClass(this.field.disabledClass);}},doResize:function(w,h){if(typeof w=='number'){this.el.setWidth(w-this.trigger.getWidth());}
this.wrap.setWidth(this.el.getWidth()+this.trigger.getWidth());},doFocus:function(){if(!this.mimicing){this.wrap.addClass('x-trigger-wrap-focus');this.mimicing=true;Ext.get(Ext.isIE?document.body:document).on(&quot;mousedown&quot;,this.mimicBlur,this,{delay:10});this.el.on('keydown',this.checkTab,this);}},checkTab:function(e){if(e.getKey()==e.TAB){this.triggerBlur();}},mimicBlur:function(e){if(!this.wrap.contains(e.target)&amp;&amp;this.field.validateBlur(e)){this.triggerBlur();}},triggerBlur:function(){this.mimicing=false;Ext.get(Ext.isIE?document.body:document).un(&quot;mousedown&quot;,this.mimicBlur,this);this.el.un(&quot;keydown&quot;,this.checkTab,this);this.field.beforeBlur();this.wrap.removeClass('x-trigger-wrap-focus');this.field.onBlur.call(this.field);},initTrigger:function(){this.trigger.addClassOnOver('x-form-trigger-over');this.trigger.addClassOnClick('x-form-trigger-click');},initSpinner:function(){this.field.addEvents({'spin':true,'spinup':true,'spindown':true});this.keyNav=new Ext.KeyNav(this.el,{&quot;up&quot;:function(e){e.preventDefault();this.onSpinUp();},&quot;down&quot;:function(e){e.preventDefault();this.onSpinDown();},&quot;pageUp&quot;:function(e){e.preventDefault();this.onSpinUpAlternate();},&quot;pageDown&quot;:function(e){e.preventDefault();this.onSpinDownAlternate();},scope:this});this.repeater=new Ext.util.ClickRepeater(this.trigger,{accelerate:this.accelerate});this.field.mon(this.repeater,&quot;click&quot;,this.onTriggerClick,this,{preventDefault:true});this.field.mon(this.trigger,{mouseover:this.onMouseOver,mouseout:this.onMouseOut,mousemove:this.onMouseMove,mousedown:this.onMouseDown,mouseup:this.onMouseUp,scope:this,preventDefault:true});this.field.mon(this.wrap,&quot;mousewheel&quot;,this.handleMouseWheel,this);this.dd.setXConstraint(0,0,10)
this.dd.setYConstraint(1500,1500,10);this.dd.endDrag=this.endDrag.createDelegate(this);this.dd.startDrag=this.startDrag.createDelegate(this);this.dd.onDrag=this.onDrag.createDelegate(this);},onMouseOver:function(){if(this.disabled){return;}
var middle=this.getMiddle();this.tmpHoverClass=(Ext.EventObject.getPageY()&lt;middle)?'x-form-spinner-overup':'x-form-spinner-overdown';this.trigger.addClass(this.tmpHoverClass);},onMouseOut:function(){this.trigger.removeClass(this.tmpHoverClass);},onMouseMove:function(){if(this.disabled){return;}
var middle=this.getMiddle();if(((Ext.EventObject.getPageY()&gt;middle)&amp;&amp;this.tmpHoverClass==&quot;x-form-spinner-overup&quot;)||((Ext.EventObject.getPageY()&lt;middle)&amp;&amp;this.tmpHoverClass==&quot;x-form-spinner-overdown&quot;)){}},onMouseDown:function(){if(this.disabled){return;}
var middle=this.getMiddle();this.tmpClickClass=(Ext.EventObject.getPageY()&lt;middle)?'x-form-spinner-clickup':'x-form-spinner-clickdown';this.trigger.addClass(this.tmpClickClass);},onMouseUp:function(){this.trigger.removeClass(this.tmpClickClass);},onTriggerClick:function(){if(this.disabled||this.el.dom.readOnly){return;}
var middle=this.getMiddle();var ud=(Ext.EventObject.getPageY()&lt;middle)?'Up':'Down';this['onSpin'+ud]();},getMiddle:function(){var t=this.trigger.getTop();var h=this.trigger.getHeight();var middle=t+(h/2);return middle;},isSpinnable:function(){if(this.disabled||this.el.dom.readOnly){Ext.EventObject.preventDefault();return false;}
return true;},handleMouseWheel:function(e){if(this.wrap.hasClass('x-trigger-wrap-focus')==false){return;}
var delta=e.getWheelDelta();if(delta&gt;0){this.onSpinUp();e.stopEvent();}
else
if(delta&lt;0){this.onSpinDown();e.stopEvent();}},startDrag:function(){this.proxy.show();this._previousY=Ext.fly(this.dd.getDragEl()).getTop();},endDrag:function(){this.proxy.hide();},onDrag:function(){if(this.disabled){return;}
var y=Ext.fly(this.dd.getDragEl()).getTop();var ud='';if(this._previousY&gt;y){ud='Up';}
if(this._previousY&lt;y){ud='Down';}
if(ud!=''){this['onSpin'+ud]();}
this._previousY=y;},onSpinUp:function(){if(this.isSpinnable()==false){return;}
if(Ext.EventObject.shiftKey==true){this.onSpinUpAlternate();return;}
else{this.spin(false,false);}
this.field.fireEvent(&quot;spin&quot;,this);this.field.fireEvent(&quot;spinup&quot;,this);},onSpinDown:function(){if(this.isSpinnable()==false){return;}
if(Ext.EventObject.shiftKey==true){this.onSpinDownAlternate();return;}
else{this.spin(true,false);}
this.field.fireEvent(&quot;spin&quot;,this);this.field.fireEvent(&quot;spindown&quot;,this);},onSpinUpAlternate:function(){if(this.isSpinnable()==false){return;}
this.spin(false,true);this.field.fireEvent(&quot;spin&quot;,this);this.field.fireEvent(&quot;spinup&quot;,this);},onSpinDownAlternate:function(){if(this.isSpinnable()==false){return;}
this.spin(true,true);this.field.fireEvent(&quot;spin&quot;,this);this.field.fireEvent(&quot;spindown&quot;,this);},spin:function(down,alternate){var v=parseFloat(this.field.getValue());var incr=(alternate==true)?this.alternateIncrementValue:this.incrementValue;(down==true)?v-=incr:v+=incr;v=(isNaN(v))?this.defaultValue:v;v=this.fixBoundries(v);this.field.setRawValue(v);},fixBoundries:function(value){var v=value;if(this.field.minValue!=undefined&amp;&amp;v&lt;this.field.minValue){v=this.field.minValue;}
if(this.field.maxValue!=undefined&amp;&amp;v&gt;this.field.maxValue){v=this.field.maxValue;}
return this.fixPrecision(v);},fixPrecision:function(value){var nan=isNaN(value);if(!this.field.allowDecimals||this.field.decimalPrecision==-1||nan||!value){return nan?'':value;}
return parseFloat(parseFloat(value).toFixed(this.field.decimalPrecision));},doDestroy:function(){if(this.trigger){this.trigger.remove();}
if(this.wrap){this.wrap.remove();delete this.field.wrap;}
if(this.splitter){this.splitter.remove();}
if(this.dd){this.dd.unreg();this.dd=null;}
if(this.proxy){this.proxy.remove();}
if(this.repeater){this.repeater.purgeListeners();}}});Ext.form.Spinner=Ext.ux.Spinner;Ext.ns('Ext.ux.form');Ext.ux.form.SpinnerField=Ext.extend(Ext.form.NumberField,{actionMode:'wrap',deferHeight:true,autoSize:Ext.emptyFn,onBlur:Ext.emptyFn,adjustSize:Ext.BoxComponent.prototype.adjustSize,constructor:function(config){var spinnerConfig=Ext.copyTo({},config,'incrementValue,alternateIncrementValue,accelerate,defaultValue,triggerClass,splitterClass');var spl=this.spinner=new Ext.ux.Spinner(spinnerConfig);var plugins=config.plugins?(Ext.isArray(config.plugins)?config.plugins.push(spl):[config.plugins,spl]):spl;Ext.ux.form.SpinnerField.superclass.constructor.call(this,Ext.apply(config,{plugins:plugins}));},getResizeEl:function(){return this.wrap;},getPositionEl:function(){return this.wrap;},alignErrorIcon:function(){if(this.wrap){this.errorIcon.alignTo(this.wrap,'tl-tr',[2,0]);}},validateBlur:function(){return true;}});Ext.reg('spinnerfield',Ext.ux.form.SpinnerField);Ext.form.SpinnerField=Ext.ux.form.SpinnerField;Ext.SitoolsDatePicker=Ext.extend(Ext.BoxComponent,{todayText:'Today',okText:'&amp;#160;OK&amp;#160;',cancelText:'Cancel',todayTip:'{0} (Spacebar)',minText:'This date is before the minimum date',maxText:'This date is after the maximum date',format:'m/d/y',disabledDaysText:'Disabled',disabledDatesText:'Disabled',monthNames:Date.monthNames,dayNames:Date.dayNames,nextText:'Next Month (Control+Right)',prevText:'Previous Month (Control+Left)',monthYearText:'Choose a month (Control+Up/Down to move years)',startDay:0,showToday:true,showTime:false,focusOnSelect:true,initHour:12,initComponent:function(){Ext.SitoolsDatePicker.superclass.initComponent.call(this);this.value=this.value?this.value.clearTime(true):new Date().clearTime();this.hourValue=this.value?this.value.getHours():new Date().getHours();this.minuteValue=this.value?this.value.getMinutes():new Date().getMinutes();this.secondValue=this.value?this.value.getSeconds():new Date().getSeconds();this.addEvents('select');if(this.handler){this.on('select',this.handler,this.scope||this);}
this.initDisabledDays();},initDisabledDays:function(){if(!this.disabledDatesRE&amp;&amp;this.disabledDates){var dd=this.disabledDates,len=dd.length-1,re='(?:';Ext.each(dd,function(d,i){re+=Ext.isDate(d)?'^'+Ext.escapeRe(d.dateFormat(this.format))+'$':dd[i];if(i!=len){re+='|';}},this);this.disabledDatesRE=new RegExp(re+')');}},setDisabledDates:function(dd){if(Ext.isArray(dd)){this.disabledDates=dd;this.disabledDatesRE=null;}else{this.disabledDatesRE=dd;}
this.initDisabledDays();this.update(this.value,true);},setDisabledDays:function(dd){this.disabledDays=dd;this.update(this.value,true);},setMinDate:function(dt){this.minDate=dt;this.update(this.value,true);},setMaxDate:function(dt){this.maxDate=dt;this.update(this.value,true);},setValue:function(value){this.value=value;this.update(this.value);},getValue:function(){return this.value;},focus:function(){this.update(this.activeDate);if(this.showTime){this.updateTime(this.activeDate);}},updateTime:function(date){this.hourField.setValue(date.getHours());this.minuteField.setValue(date.getMinutes());this.secondField.setValue(date.getSeconds());},onEnable:function(initial){Ext.SitoolsDatePicker.superclass.onEnable.call(this);this.doDisabled(false);this.update(initial?this.value:this.activeDate);if(Ext.isIE){this.el.repaint();}},onDisable:function(){Ext.SitoolsDatePicker.superclass.onDisable.call(this);this.doDisabled(true);if(Ext.isIE&amp;&amp;!Ext.isIE8){Ext.each([].concat(this.textNodes,this.el.query('th span')),function(el){Ext.fly(el).repaint();});}},doDisabled:function(disabled){this.keyNav.setDisabled(disabled);this.prevRepeater.setDisabled(disabled);this.nextRepeater.setDisabled(disabled);if(this.showToday){this.todayKeyListener.setDisabled(disabled);this.todayBtn.setDisabled(disabled);}},onRender:function(container,position){var m=['&lt;table cellspacing=&quot;0&quot;&gt;','&lt;tr&gt;&lt;td class=&quot;x-date-left&quot;&gt;&lt;a href=&quot;#&quot; title=&quot;',this.prevText,'&quot;&gt;&amp;#160;&lt;/a&gt;&lt;/td&gt;&lt;td class=&quot;x-date-middle&quot; align=&quot;center&quot;&gt;&lt;/td&gt;&lt;td class=&quot;x-date-right&quot;&gt;&lt;a href=&quot;#&quot; title=&quot;',this.nextText,'&quot;&gt;&amp;#160;&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;','&lt;tr&gt;&lt;td colspan=&quot;3&quot;&gt;&lt;table class=&quot;x-date-inner&quot; cellspacing=&quot;0&quot;&gt;&lt;thead&gt;&lt;tr&gt;'],dn=this.dayNames,i;for(i=0;i&lt;7;i++){var d=this.startDay+i;if(d&gt;6){d=d-7;}
m.push('&lt;th&gt;&lt;span&gt;',dn[d].substr(0,1),'&lt;/span&gt;&lt;/th&gt;');}
m[m.length]='&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;';for(i=0;i&lt;42;i++){if(i%7===0&amp;&amp;i!==0){m[m.length]='&lt;/tr&gt;&lt;tr&gt;';}
m[m.length]='&lt;td&gt;&lt;a href=&quot;#&quot; hidefocus=&quot;on&quot; class=&quot;x-date-date&quot; tabIndex=&quot;1&quot;&gt;&lt;em&gt;&lt;span&gt;&lt;/span&gt;&lt;/em&gt;&lt;/a&gt;&lt;/td&gt;';}
m.push('&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/td&gt;&lt;/tr&gt;',this.showTime?'&lt;tr&gt;&lt;td colspan=&quot;3&quot; class=&quot;x-date-time&quot; align=&quot;center&quot;&gt;&lt;/td&gt;&lt;/tr&gt;':'',this.showToday?'&lt;tr&gt;&lt;td colspan=&quot;3&quot; class=&quot;x-date-bottom&quot; align=&quot;center&quot;&gt;&lt;/td&gt;&lt;/tr&gt;':'','&lt;/table&gt;&lt;div class=&quot;x-date-mp&quot;&gt;&lt;/div&gt;');var el=document.createElement('div');el.className='x-date-picker';el.innerHTML=m.join('');container.dom.insertBefore(el,position);this.el=Ext.get(el);this.eventEl=Ext.get(el.firstChild);this.prevRepeater=new Ext.util.ClickRepeater(this.el.child('td.x-date-left a'),{handler:this.showPrevMonth,scope:this,preventDefault:true,stopDefault:true});this.nextRepeater=new Ext.util.ClickRepeater(this.el.child('td.x-date-right a'),{handler:this.showNextMonth,scope:this,preventDefault:true,stopDefault:true});this.monthPicker=this.el.down('div.x-date-mp');this.monthPicker.enableDisplayMode('block');this.keyNav=new Ext.KeyNav(this.eventEl,{'left':function(e){if(e.ctrlKey){this.showPrevMonth();}else{this.update(this.activeDate.add('d',-1));}},'right':function(e){if(e.ctrlKey){this.showNextMonth();}else{this.update(this.activeDate.add('d',1));}},'up':function(e){if(e.ctrlKey){this.showNextYear();}else{this.update(this.activeDate.add('d',-7));}},'down':function(e){if(e.ctrlKey){this.showPrevYear();}else{this.update(this.activeDate.add('d',7));}},'pageUp':function(e){this.showNextMonth();},'pageDown':function(e){this.showPrevMonth();},'enter':function(e){e.stopPropagation();return true;},scope:this});this.cells=this.el.select('table.x-date-inner tbody td');this.textNodes=this.el.query('table.x-date-inner tbody span');this.mbtn=new Ext.Button({text:'&amp;#160;',tooltip:this.monthYearText,renderTo:this.el.child('td.x-date-middle',true)});this.mbtn.el.child('em').addClass('x-btn-arrow');if(this.showToday){this.todayKeyListener=this.eventEl.addKeyListener(Ext.EventObject.SPACE,this.selectToday,this);var today=(new Date()).dateFormat(this.format);this.todayBtn=new Ext.Button({renderTo:this.el.child('td.x-date-bottom',true),text:String.format(this.todayText,today),tooltip:String.format(this.todayTip,today),handler:this.selectToday,scope:this});}
if(this.showTime){this.hourField=new Ext.form.TextField({value:this.hourValue,width:&quot;25&quot;,listeners:{scope:this,specialkey:function(field,e){if(e.getKey()==e.TAB){if(e.shiftKey){this.secondField.focus();}
else{this.minuteField.focus();}}}},maxLength:2,maskRe:/[0-9]/,disabled:false,validationEvent:&quot;blur&quot;,validator:function(value){var intValue=parseInt(value);if(!Ext.isEmpty(intValue)&amp;&amp;intValue&lt;=23&amp;&amp;intValue&gt;=0){if(value.length==1){this.setValue(&quot;0&quot;+value);}
return true;}
else{return&quot;incorrect Value&quot;;}}});this.minuteField=new Ext.form.TextField({value:this.minuteValue,width:&quot;25&quot;,listeners:{scope:this,specialkey:function(field,e){if(e.getKey()==e.TAB){if(e.shiftKey){this.hourField.focus();}
else{this.secondField.focus();}}}},maxLength:2,maskRe:/[0-9]/,validationEvent:&quot;blur&quot;,validator:function(value){var intValue=parseInt(value);if(!Ext.isEmpty(intValue)&amp;&amp;intValue&lt;=59&amp;&amp;intValue&gt;=0){if(value.length==1){this.setValue(&quot;0&quot;+value);}
return true;}
else{return&quot;incorrect Value&quot;;}}});this.secondField=new Ext.form.TextField({value:this.minuteValue,width:&quot;25&quot;,listeners:{scope:this,specialkey:function(field,e){if(e.getKey()==e.TAB){if(e.shiftKey){this.minuteField.focus();}
else{this.hourField.focus();}}}},maxLength:2,maskRe:/[0-9]/,validationEvent:&quot;blur&quot;,validator:function(value){var intValue=parseInt(value);if(!Ext.isEmpty(intValue)&amp;&amp;intValue&lt;=59&amp;&amp;intValue&gt;=0){if(value.length==1){this.setValue(&quot;0&quot;+value);}
return true;}
else{return&quot;incorrect Value&quot;;}}});var sepLabel1=new Ext.form.DisplayField({value:&quot;:&quot;});var sepLabel2=new Ext.form.DisplayField({value:&quot;:&quot;});this.timeForm=new Ext.form.FormPanel({labelWidth:1,itemsCls:&quot;sitools-no-margin&quot;,items:[{xtype:&quot;compositefield&quot;,width:135,style:{padding:&quot;3px&quot;},items:[this.hourField,sepLabel1,this.minuteField,sepLabel2,this.secondField]}],renderTo:this.el.child('td.x-date-time',true)});}
this.mon(this.eventEl,'mousewheel',this.handleMouseWheel,this);this.mon(this.eventEl,'click',this.handleDateClick,this,{delegate:'a.x-date-date'});this.mon(this.mbtn,'click',this.showMonthPicker,this);this.onEnable(true);},createMonthPicker:function(){if(!this.monthPicker.dom.firstChild){var buf=['&lt;table border=&quot;0&quot; cellspacing=&quot;0&quot;&gt;'];for(var i=0;i&lt;6;i++){buf.push('&lt;tr&gt;&lt;td class=&quot;x-date-mp-month&quot;&gt;&lt;a href=&quot;#&quot;&gt;',Date.getShortMonthName(i),'&lt;/a&gt;&lt;/td&gt;','&lt;td class=&quot;x-date-mp-month x-date-mp-sep&quot;&gt;&lt;a href=&quot;#&quot;&gt;',Date.getShortMonthName(i+6),'&lt;/a&gt;&lt;/td&gt;',i===0?'&lt;td class=&quot;x-date-mp-ybtn&quot; align=&quot;center&quot;&gt;&lt;a class=&quot;x-date-mp-prev&quot;&gt;&lt;/a&gt;&lt;/td&gt;&lt;td class=&quot;x-date-mp-ybtn&quot; align=&quot;center&quot;&gt;&lt;a class=&quot;x-date-mp-next&quot;&gt;&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;':'&lt;td class=&quot;x-date-mp-year&quot;&gt;&lt;a href=&quot;#&quot;&gt;&lt;/a&gt;&lt;/td&gt;&lt;td class=&quot;x-date-mp-year&quot;&gt;&lt;a href=&quot;#&quot;&gt;&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;');}
buf.push('&lt;tr class=&quot;x-date-mp-btns&quot;&gt;&lt;td colspan=&quot;4&quot;&gt;&lt;button type=&quot;button&quot; class=&quot;x-date-mp-ok&quot;&gt;',this.okText,'&lt;/button&gt;&lt;button type=&quot;button&quot; class=&quot;x-date-mp-cancel&quot;&gt;',this.cancelText,'&lt;/button&gt;&lt;/td&gt;&lt;/tr&gt;','&lt;/table&gt;');this.monthPicker.update(buf.join(''));this.mon(this.monthPicker,'click',this.onMonthClick,this);this.mon(this.monthPicker,'dblclick',this.onMonthDblClick,this);this.mpMonths=this.monthPicker.select('td.x-date-mp-month');this.mpYears=this.monthPicker.select('td.x-date-mp-year');this.mpMonths.each(function(m,a,i){i+=1;if((i%2)===0){m.dom.xmonth=5+Math.round(i*0.5);}else{m.dom.xmonth=Math.round((i-1)*0.5);}});}},showMonthPicker:function(){if(!this.disabled){this.createMonthPicker();var size=this.el.getSize();this.monthPicker.setSize(size);this.monthPicker.child('table').setSize(size);this.mpSelMonth=(this.activeDate||this.value).getMonth();this.updateMPMonth(this.mpSelMonth);this.mpSelYear=(this.activeDate||this.value).getFullYear();this.updateMPYear(this.mpSelYear);this.monthPicker.slideIn('t',{duration:0.2});}},updateMPYear:function(y){this.mpyear=y;var ys=this.mpYears.elements;for(var i=1;i&lt;=10;i++){var td=ys[i-1],y2;if((i%2)===0){y2=y+Math.round(i*0.5);td.firstChild.innerHTML=y2;td.xyear=y2;}else{y2=y-(5-Math.round(i*0.5));td.firstChild.innerHTML=y2;td.xyear=y2;}
this.mpYears.item(i-1)[y2==this.mpSelYear?'addClass':'removeClass']('x-date-mp-sel');}},updateMPMonth:function(sm){this.mpMonths.each(function(m,a,i){m[m.dom.xmonth==sm?'addClass':'removeClass']('x-date-mp-sel');});},selectMPMonth:function(m){},onMonthClick:function(e,t){e.stopEvent();var el=new Ext.Element(t),pn;if(el.is('button.x-date-mp-cancel')){this.hideMonthPicker();}
else if(el.is('button.x-date-mp-ok')){var d=new Date(this.mpSelYear,this.mpSelMonth,(this.activeDate||this.value).getDate());if(d.getMonth()!=this.mpSelMonth){d=new Date(this.mpSelYear,this.mpSelMonth,1).getLastDateOfMonth();}
this.update(d);this.hideMonthPicker();}
else if((pn=el.up('td.x-date-mp-month',2))){this.mpMonths.removeClass('x-date-mp-sel');pn.addClass('x-date-mp-sel');this.mpSelMonth=pn.dom.xmonth;}
else if((pn=el.up('td.x-date-mp-year',2))){this.mpYears.removeClass('x-date-mp-sel');pn.addClass('x-date-mp-sel');this.mpSelYear=pn.dom.xyear;}
else if(el.is('a.x-date-mp-prev')){this.updateMPYear(this.mpyear-10);}
else if(el.is('a.x-date-mp-next')){this.updateMPYear(this.mpyear+10);}},onMonthDblClick:function(e,t){e.stopEvent();var el=new Ext.Element(t),pn;if((pn=el.up('td.x-date-mp-month',2))){this.update(new Date(this.mpSelYear,pn.dom.xmonth,(this.activeDate||this.value).getDate()));this.hideMonthPicker();}
else if((pn=el.up('td.x-date-mp-year',2))){this.update(new Date(pn.dom.xyear,this.mpSelMonth,(this.activeDate||this.value).getDate()));this.hideMonthPicker();}},hideMonthPicker:function(disableAnim){if(this.monthPicker){if(disableAnim===true){this.monthPicker.hide();}else{this.monthPicker.slideOut('t',{duration:0.2});}}},showPrevMonth:function(e){this.update(this.activeDate.add('mo',-1));},showNextMonth:function(e){this.update(this.activeDate.add('mo',1));},showPrevYear:function(){this.update(this.activeDate.add('y',-1));},showNextYear:function(){this.update(this.activeDate.add('y',1));},handleMouseWheel:function(e){e.stopEvent();if(!this.disabled){var delta=e.getWheelDelta();if(delta&gt;0){this.showPrevMonth();}else if(delta&lt;0){this.showNextMonth();}}},handleDateClick:function(e,t){e.stopEvent();if(!this.disabled&amp;&amp;t.dateValue&amp;&amp;!Ext.fly(t.parentNode).hasClass('x-date-disabled')){this.cancelFocus=this.focusOnSelect===false;var date=new Date(t.dateValue);if(this.showTime){date=date.add(Date.HOUR,this.hourField.getValue());date=date.add(Date.MINUTE,this.minuteField.getValue());date=date.add(Date.SECOND,this.secondField.getValue());if(!this.hourField.isValid()||!this.minuteField.isValid()||!this.secondField.isValid()){return;}}
this.setValue(date);delete this.cancelFocus;this.fireEvent('select',this,this.value);}},selectToday:function(){if(this.todayBtn&amp;&amp;!this.todayBtn.disabled){var dateNow=new Date();this.setValue(dateNow);if(this.showTime){this.hourField.setValue(dateNow.getHours());this.minuteField.setValue(dateNow.getMinutes());this.secondField.setValue(dateNow.getSeconds());}
this.fireEvent('select',this,this.value);}},update:function(date,forceRefresh){if(this.rendered){if(!Ext.isDate(date)){date=new Date();}
var vd=this.activeDate,vis=this.isVisible();var dateWithoutTime=new Date(date.getTime());dateWithoutTime.setHours(0);dateWithoutTime.setMinutes(0);dateWithoutTime.setMilliseconds(0);dateWithoutTime.setSeconds(0);this.activeDate=date;if(!forceRefresh&amp;&amp;vd&amp;&amp;this.el){var t=dateWithoutTime.getTime();if(vd.getMonth()==dateWithoutTime.getMonth()&amp;&amp;vd.getFullYear()==dateWithoutTime.getFullYear()){this.cells.removeClass('x-date-selected');this.cells.each(function(c){if(c.dom.firstChild.dateValue==t){c.addClass('x-date-selected');if(vis&amp;&amp;!this.cancelFocus){Ext.fly(c.dom.firstChild).focus(50);}
return false;}},this);return;}}
var days=date.getDaysInMonth(),firstOfMonth=date.getFirstDateOfMonth(),startingPos=firstOfMonth.getDay()-this.startDay;if(startingPos&lt;0){startingPos+=7;}
days+=startingPos;var pm=date.add('mo',-1),prevStart=pm.getDaysInMonth()-startingPos,cells=this.cells.elements,textEls=this.textNodes,d=(new Date(pm.getFullYear(),pm.getMonth(),prevStart,this.initHour));d.setHours(pm.getHours());d.setMinutes(pm.getMinutes());d.setSeconds(pm.getSeconds());today=new Date().getTime(),sel=date.clearTime(true).getTime(),min=this.minDate?this.minDate.clearTime(true):Number.NEGATIVE_INFINITY,max=this.maxDate?this.maxDate.clearTime(true):Number.POSITIVE_INFINITY,ddMatch=this.disabledDatesRE,ddText=this.disabledDatesText,ddays=this.disabledDays?this.disabledDays.join(''):false,ddaysText=this.disabledDaysText,format=this.format;if(this.showToday){var td=new Date().clearTime(),disable=(td&lt;min||td&gt;max||(ddMatch&amp;&amp;format&amp;&amp;ddMatch.test(td.dateFormat(format)))||(ddays&amp;&amp;ddays.indexOf(td.getDay())!=-1));if(!this.disabled){this.todayBtn.setDisabled(disable);this.todayKeyListener[disable?'disable':'enable']();}}
var setCellClass=function(cal,cell){cell.title='';var t=d.clearTime(true).getTime();cell.firstChild.dateValue=t;if(t==today){cell.className+=' x-date-today';cell.title=cal.todayText;}
if(t==sel){cell.className+=' x-date-selected';if(vis){Ext.fly(cell.firstChild).focus(50);}}
if(t&lt;min){cell.className=' x-date-disabled';cell.title=cal.minText;return;}
if(t&gt;max){cell.className=' x-date-disabled';cell.title=cal.maxText;return;}
if(ddays){if(ddays.indexOf(d.getDay())!=-1){cell.title=ddaysText;cell.className=' x-date-disabled';}}
if(ddMatch&amp;&amp;format){var fvalue=d.dateFormat(format);if(ddMatch.test(fvalue)){cell.title=ddText.replace('%0',fvalue);cell.className=' x-date-disabled';}}};var i=0;for(;i&lt;startingPos;i++){textEls[i].innerHTML=(++prevStart);d.setDate(d.getDate()+1);cells[i].className='x-date-prevday';setCellClass(this,cells[i]);}
for(;i&lt;days;i++){var intDay=i-startingPos+1;textEls[i].innerHTML=(intDay);d.setDate(d.getDate()+1);cells[i].className='x-date-active';setCellClass(this,cells[i]);}
var extraDays=0;for(;i&lt;42;i++){textEls[i].innerHTML=(++extraDays);d.setDate(d.getDate()+1);cells[i].className='x-date-nextday';setCellClass(this,cells[i]);}
this.mbtn.setText(this.monthNames[date.getMonth()]+' '+date.getFullYear());if(!this.internalRender){var main=this.el.dom.firstChild,w=main.offsetWidth;this.el.setWidth(w+this.el.getBorderWidth('lr'));Ext.fly(main).setWidth(w);this.internalRender=true;if(Ext.isOpera&amp;&amp;!this.secondPass){main.rows[0].cells[1].style.width=(w-(main.rows[0].cells[0].offsetWidth+main.rows[0].cells[2].offsetWidth))+'px';this.secondPass=true;this.update.defer(10,this,[date]);}}}},beforeDestroy:function(){if(this.rendered){Ext.destroy(this.keyNav,this.monthPicker,this.eventEl,this.mbtn,this.nextRepeater,this.prevRepeater,this.cells.el,this.todayBtn);delete this.textNodes;delete this.cells.elements;}}});Ext.reg('datepicker',Ext.SitoolsDatePicker);Ext.ns('Ext.ux.form');Ext.ux.form.FileUploadField=Ext.extend(Ext.form.TextField,{buttonText:'Browse...',buttonOnly:false,buttonOffset:3,readOnly:true,autoSize:Ext.emptyFn,initComponent:function(){Ext.ux.form.FileUploadField.superclass.initComponent.call(this);this.addEvents('fileselected');},onRender:function(ct,position){Ext.ux.form.FileUploadField.superclass.onRender.call(this,ct,position);this.wrap=this.el.wrap({cls:'x-form-field-wrap x-form-file-wrap'});this.el.addClass('x-form-file-text');this.el.dom.removeAttribute('name');this.createFileInput();var btnCfg=Ext.applyIf(this.buttonCfg||{},{text:this.buttonText});this.button=new Ext.Button(Ext.apply(btnCfg,{renderTo:this.wrap,cls:'x-form-file-btn'+(btnCfg.iconCls?' x-btn-icon':'')}));if(this.buttonOnly){this.el.hide();this.wrap.setWidth(this.button.getEl().getWidth());}
this.bindListeners();this.resizeEl=this.positionEl=this.wrap;},bindListeners:function(){this.fileInput.on({scope:this,mouseenter:function(){this.button.addClass(['x-btn-over','x-btn-focus'])},mouseleave:function(){this.button.removeClass(['x-btn-over','x-btn-focus','x-btn-click'])},mousedown:function(){this.button.addClass('x-btn-click')},mouseup:function(){this.button.removeClass(['x-btn-over','x-btn-focus','x-btn-click'])},change:function(){var v=this.fileInput.dom.value;this.setValue(v);this.fireEvent('fileselected',this,v);}});},createFileInput:function(){this.fileInput=this.wrap.createChild({id:this.getFileInputId(),name:this.name||this.getId(),cls:'x-form-file',tag:'input',type:'file',size:1});},reset:function(){this.fileInput.remove();this.createFileInput();this.bindListeners();Ext.ux.form.FileUploadField.superclass.reset.call(this);},getFileInputId:function(){return this.id+'-file';},onResize:function(w,h){Ext.ux.form.FileUploadField.superclass.onResize.call(this,w,h);this.wrap.setWidth(w);if(!this.buttonOnly){var w=this.wrap.getWidth()-this.button.getEl().getWidth()-this.buttonOffset;this.el.setWidth(w);}},onDestroy:function(){Ext.ux.form.FileUploadField.superclass.onDestroy.call(this);Ext.destroy(this.fileInput,this.button,this.wrap);},onDisable:function(){Ext.ux.form.FileUploadField.superclass.onDisable.call(this);this.doDisable(true);},onEnable:function(){Ext.ux.form.FileUploadField.superclass.onEnable.call(this);this.doDisable(false);},doDisable:function(disabled){this.fileInput.dom.disabled=disabled;this.button.setDisabled(disabled);},preFocus:Ext.emptyFn,alignErrorIcon:function(){this.errorIcon.alignTo(this.wrap,'tl-tr',[2,0]);}});Ext.reg('fileuploadfield',Ext.ux.form.FileUploadField);Ext.form.FileUploadField=Ext.ux.form.FileUploadField;var SitoolsDesk=new sitools.user.desktop.App();SitoolsDesk.initDesktopApplication();Ext.namespace('sitools.admin.datasets.columnRenderer');sitools.admin.datasets.columnRenderer.behaviorEnum={URL_LOCAL:&quot;localUrl&quot;,URL_EXT_NEW_TAB:&quot;extUrlNewTab&quot;,URL_EXT_DESKTOP:&quot;extUrlDesktop&quot;,IMAGE_NO_THUMB:&quot;ImgNoThumb&quot;,IMAGE_THUMB_FROM_IMAGE:&quot;ImgAutoThumb&quot;,IMAGE_FROM_SQL:&quot;ImgThumbSQL&quot;,DATASET_LINK:&quot;datasetLink&quot;,DATASET_ICON_LINK:&quot;datasetIconLink&quot;,NO_CLIENT_ACCESS:&quot;noClientAccess&quot;,getColumnRendererCategoryFromBehavior:function(behavior){var category;switch(behavior){case ColumnRendererEnum.URL_LOCAL:case ColumnRendererEnum.URL_EXT_NEW_TAB:case ColumnRendererEnum.URL_EXT_DESKTOP:category=&quot;URL&quot;;break;case ColumnRendererEnum.IMAGE_NO_THUMB:case ColumnRendererEnum.IMAGE_THUMB_FROM_IMAGE:case ColumnRendererEnum.IMAGE_FROM_SQL:category=&quot;Image&quot;;break;case ColumnRendererEnum.DATASET_LINK:case ColumnRendererEnum.DATASET_ICON_LINK:category=&quot;DataSetLink&quot;;break;case ColumnRendererEnum.NO_CLIENT_ACCESS:category=&quot;Other&quot;;break;default:category=&quot;&quot;;break;}
return category;},isDisplayingImage:function(cr){var result=false;switch(cr.behavior){case ColumnRendererEnum.IMAGE_THUMB_FROM_IMAGE:case ColumnRendererEnum.IMAGE_FROM_SQL:case ColumnRendererEnum.DATASET_ICON_LINK:result=true;break;case ColumnRendererEnum.URL_LOCAL:case ColumnRendererEnum.URL_EXT_NEW_TAB:case ColumnRendererEnum.URL_EXT_DESKTOP:if(cr.type==&quot;Image&quot;)
result=true;break;}
return result;}};var ColumnRendererEnum=sitools.admin.datasets.columnRenderer.behaviorEnum;</pre>
</body>
</html>
